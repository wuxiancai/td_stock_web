<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é¾™è™æ¦œæ¯æ—¥ç»Ÿè®¡ - ä¹è½¬åºåˆ—é€‰è‚¡åŠå››å¤©æŒè‚¡äº¤æ˜“ç³»ç»Ÿ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            text-align: center;
        }
        
        .title {
            font-size: 1.8em;
            font-weight: bold;
            color: #f39c12;
            margin-bottom: 10px;
        }
        
        .subtitle {
            color: #666;
            font-size: 0.9em;
        }
        
        .controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .btn {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9em;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        .btn-back {
            background: linear-gradient(45deg, #6c757d, #495057);
        }
        
        .date-selector {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .date-input {
            padding: 8px 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            outline: none;
        }
        
        .date-input:focus {
            border-color: #667eea;
        }
        
        .top-list-section {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        
        .stock-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            font-size: 12px;
        }
        
        .stock-table th,
        .stock-table td {
            padding: 8px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }
        
        .stock-table th {
            background: #f8f9fa;
            font-weight: bold;
            color: #333;
            cursor: pointer;
            position: relative;
            user-select: none;
            white-space: nowrap;
        }
        
        .stock-table th:hover {
            background: #e9ecef;
        }
        
        .sort-indicator {
            position: absolute;
            right: 5px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 0.8em;
            color: #666;
        }
        
        .sort-asc::after {
            content: 'â–²';
        }
        
        .sort-desc::after {
            content: 'â–¼';
        }
        
        .stock-table tr:hover {
            background: #f8f9fa;
        }
        
        .stock-name {
            font-weight: bold;
            color: #333;
            cursor: pointer;
        }
        
        .stock-name:hover {
            color: #667eea;
        }
        
        .stock-code {
            color: #666;
            font-size: 0.9em;
        }
        
        .price-positive {
            color: #e74c3c;
            font-weight: bold;
        }
        
        .price-negative {
            color: #27ae60;
            font-weight: bold;
        }
        
        .net-positive {
            color: #e74c3c;
            font-weight: bold;
        }
        
        .net-negative {
            color: #27ae60;
            font-weight: bold;
        }
        
        .empty-message {
            text-align: center;
            padding: 40px;
            color: #666;
            font-size: 1.1em;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            font-size: 1.1em;
            color: #666;
        }
        
        .stats-summary {
            display: flex;
            justify-content: space-around;
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .stat-item {
            text-align: center;
        }
        
        .stat-value {
            font-size: 1.5em;
            font-weight: bold;
            color: #f39c12;
        }
        
        .stat-label {
            font-size: 0.9em;
            color: #666;
            margin-top: 5px;
        }
        
        /* ç­›é€‰æ¡ä»¶æ ·å¼ - å•è¡Œæ˜¾ç¤º */
        .filter-section {
            background: #f8f9fa;
            border-radius: 6px;
            padding: 8px 12px;
            margin-bottom: 15px;
            border: 1px solid #e9ecef;
        }
        
        .filter-title {
            display: none;
        }
        
        .filter-grid {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 15px;
            margin-bottom: 0;
        }
        
        .filter-item {
            display: flex;
            align-items: center;
            gap: 6px;
            white-space: nowrap;
        }
        
        .filter-label {
            font-size: 12px;
            font-weight: 600;
            color: #495057;
            line-height: 1;
            margin-right: 4px;
        }
        
        .filter-range {
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .filter-input {
            padding: 3px 5px;
            border: 1px solid #ced4da;
            border-radius: 3px;
            font-size: 12px;
            outline: none;
            transition: border-color 0.2s ease;
            width: 45px;
            min-width: 45px;
            max-width: 45px;
            text-align: center;
        }
        
        .filter-input:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 1px rgba(102, 126, 234, 0.2);
        }
        
        .filter-input-full {
            width: 60px;
            max-width: 60px;
            min-width: 60px;
        }
        
        .filter-separator {
            color: #6c757d;
            font-weight: bold;
            font-size: 11px;
            margin: 0 2px;
        }
        
        .filter-actions {
            display: flex;
            gap: 8px;
            margin-left: auto;
        }
        
        .filter-btn {
            padding: 4px 12px;
            font-size: 12px;
            min-width: 60px;
            height: 28px;
        }
        
        .filter-btn-clear {
            background: linear-gradient(45deg, #6c757d, #495057);
        }
        
        .filter-btn-clear:hover {
            background: linear-gradient(45deg, #5a6268, #343a40);
        }
        
        /* æ•´ä½“å®¹å™¨å¸ƒå±€ */
        .filter-container {
            display: flex;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }

        @media (max-width: 1200px) {
            .filter-container {
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
            }
            
            .filter-grid {
                flex-wrap: wrap;
                gap: 10px;
            }
            
            .filter-actions {
                margin-left: 0;
                align-self: flex-end;
            }
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .controls {
                flex-direction: column;
                align-items: stretch;
            }
            
            .stock-table {
                font-size: 10px;
            }
            
            .stock-table th,
            .stock-table td {
                padding: 6px;
            }
            
            .filter-section {
                padding: 6px 8px;
                margin-bottom: 10px;
            }
            
            .filter-container {
                flex-direction: column;
                gap: 6px;
            }
            
            .filter-title {
                display: none;
            }
            
            .filter-grid {
                flex-direction: column;
                gap: 6px;
                width: 100%;
            }
            
            .filter-item {
                width: 100%;
                justify-content: space-between;
            }
            
            .filter-actions {
                flex-direction: row;
                justify-content: center;
                gap: 6px;
                width: 100%;
                margin-left: 0;
                align-self: center;
            }
            
            .filter-btn {
                padding: 4px 10px;
                font-size: 11px;
                min-width: 60px;
                height: 26px;
            }
            
            .filter-input {
                width: 40px;
                min-width: 40px;
                max-width: 40px;
                font-size: 11px;
                padding: 2px 4px;
            }
            
            .filter-input-full {
                width: 50px;
                max-width: 50px;
                min-width: 50px;
            }
            
            .filter-label {
                font-size: 11px;
                min-width: 80px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="title">ğŸ† é¾™è™æ¦œæ¯æ—¥ç»Ÿè®¡</div>
            <div class="subtitle">é¾™è™æ¦œæ¯æ—¥äº¤æ˜“æ˜ç»†æ•°æ®ï¼Œå±•ç¤ºå¼‚å¸¸æ³¢åŠ¨è‚¡ç¥¨çš„è¯¦ç»†äº¤æ˜“ä¿¡æ¯</div>
        </div>
        
        <div class="controls">
            <button class="btn btn-back" onclick="goBack()">â† è¿”å›é¦–é¡µ</button>
            <div class="date-selector">
                <label for="tradeDate">äº¤æ˜“æ—¥æœŸï¼š</label>
                <input type="date" id="tradeDate" class="date-input" onchange="loadTopListData()">
                <button class="btn" onclick="loadTodayData()">ä»Šæ—¥æ•°æ®</button>
            </div>
            <button class="btn" onclick="refreshData()">ğŸ”„ åˆ·æ–°æ•°æ®</button>
        </div>
        
        <div class="top-list-section">
            <div id="loadingDiv" class="loading">æ­£åœ¨åŠ è½½é¾™è™æ¦œæ•°æ®...</div>
            
            <div id="statsDiv" class="stats-summary" style="display: none;">
                <div class="stat-item">
                    <div class="stat-value" id="totalCount">0</div>
                    <div class="stat-label">ä¸Šæ¦œè‚¡ç¥¨æ•°</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="netBuyCount">0</div>
                    <div class="stat-label">å‡€ä¹°å…¥è‚¡ç¥¨</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="netSellCount">0</div>
                    <div class="stat-label">å‡€å–å‡ºè‚¡ç¥¨</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="totalAmount">0</div>
                    <div class="stat-label">æ€»æˆäº¤é¢(äº¿)</div>
                </div>
            </div>
            
            <div id="emptyDiv" class="empty-message" style="display: none;">
                <p>æš‚æ— é¾™è™æ¦œæ•°æ®</p>
                <p style="margin-top: 10px; font-size: 0.9em; color: #999;">è¯·é€‰æ‹©å…¶ä»–äº¤æ˜“æ—¥æœŸæŸ¥çœ‹æ•°æ®</p>
            </div>
            
            <!-- ç­›é€‰æ¡ä»¶åŒºåŸŸ -->
            <div id="filterSection" class="filter-section" style="display: none;">
                <div class="filter-container">
                    <div class="filter-grid">
                        <div class="filter-item">
                            <label class="filter-label">æ¶¨è·Œå¹…(%)</label>
                            <div class="filter-range">
                                <input type="number" id="pctChangeMin" class="filter-input" placeholder="æœ€å°" step="0.01">
                                <span class="filter-separator">-</span>
                                <input type="number" id="pctChangeMax" class="filter-input" placeholder="æœ€å¤§" step="0.01">
                            </div>
                        </div>
                        
                        <div class="filter-item">
                            <label class="filter-label">é‡æ¯”</label>
                            <div class="filter-range">
                                <input type="number" id="volumeRatioMin" class="filter-input" placeholder="æœ€å°" step="0.1">
                                <span class="filter-separator">-</span>
                                <input type="number" id="volumeRatioMax" class="filter-input" placeholder="æœ€å¤§" step="0.1">
                            </div>
                        </div>
                        
                        <div class="filter-item">
                            <label class="filter-label">ä¹è½¬ä¹°å…¥ - çº¢è‰²(ä¸Šæ¶¨)</label>
                            <div class="filter-range">
                                <input type="number" id="nineTurnUp" class="filter-input" placeholder="6" min="1" max="9" step="1">
                                <span class="filter-separator">-</span>
                                <input type="number" id="nineTurnUpMax" class="filter-input" placeholder="æœ€å¤§" min="1" max="9" step="1">
                            </div>
                        </div>
                        
                        <div class="filter-item">
                            <label class="filter-label">å‡€æµå…¥é¢(ä¸‡å…ƒ)</label>
                            <div class="filter-range">
                                <input type="number" id="netInflowMin" class="filter-input" placeholder="æœ€å°" step="1000">
                                <span class="filter-separator">-</span>
                                <input type="number" id="netInflowMax" class="filter-input" placeholder="æœ€å¤§" step="1000">
                            </div>
                        </div>
                        
                        <div class="filter-item">
                            <label class="filter-label">è‚¡ç¥¨ä»£ç </label>
                            <div class="filter-range">
                                <input type="text" id="stockCode" class="filter-input filter-input-full" placeholder="300" maxlength="6">
                            </div>
                        </div>
                        
                        <div class="filter-item">
                            <label class="filter-label">å½“å¤©æ¶¨å¹…(%)</label>
                            <div class="filter-range">
                                <input type="number" id="todayChangeMin" class="filter-input" placeholder="æœ€å°" step="0.01">
                                <span class="filter-separator">-</span>
                                <input type="number" id="todayChangeMax" class="filter-input" placeholder="æœ€å¤§" step="0.01">
                            </div>
                        </div>
                    </div>
                    
                    <div class="filter-actions">
                        <button class="btn filter-btn" onclick="applyFilters()">ç­›é€‰</button>
                        <button class="btn filter-btn filter-btn-clear" onclick="clearFilters()">æ¸…é™¤</button>
                    </div>
                </div>
            </div>

            <div id="topListContent" style="display: none;">
                <table class="stock-table" id="topListTable">
                    <thead>
                        <tr>
                            <th onclick="sortTable('ts_code')" data-sort="ts_code">
                                è‚¡ç¥¨ä»£ç <span class="sort-indicator"></span>
                            </th>
                            <th>è‚¡ç¥¨åç§°</th>
                            <th onclick="sortTable('close')" data-sort="close">
                                æ”¶ç›˜ä»·<span class="sort-indicator"></span>
                            </th>
                            <th onclick="sortTable('pct_change')" data-sort="pct_change">
                                æ¶¨è·Œå¹…(%)<span class="sort-indicator"></span>
                            </th>
                            <th onclick="sortTable('turnover_rate')" data-sort="turnover_rate">
                                æ¢æ‰‹ç‡(%)<span class="sort-indicator"></span>
                            </th>
                            <th onclick="sortTable('amount')" data-sort="amount">
                                æ€»æˆäº¤é¢(äº¿)<span class="sort-indicator"></span>
                            </th>
                            <th onclick="sortTable('l_sell')" data-sort="l_sell">
                                å–å‡ºé¢(äº¿)<span class="sort-indicator"></span>
                            </th>
                            <th onclick="sortTable('l_buy')" data-sort="l_buy">
                                ä¹°å…¥é¢(äº¿)<span class="sort-indicator"></span>
                            </th>
                            <th onclick="sortTable('l_amount')" data-sort="l_amount">
                                æˆäº¤é¢(äº¿)<span class="sort-indicator"></span>
                            </th>
                            <th onclick="sortTable('net_amount')" data-sort="net_amount">
                                å‡€ä¹°å…¥é¢(äº¿)<span class="sort-indicator"></span>
                            </th>
                            <th onclick="sortTable('net_rate')" data-sort="net_rate">
                                å‡€ä¹°é¢å æ¯”(%)<span class="sort-indicator"></span>
                            </th>
                            <th onclick="sortTable('amount_rate')" data-sort="amount_rate">
                                æˆäº¤é¢å æ¯”(%)<span class="sort-indicator"></span>
                            </th>
                            <th onclick="sortTable('float_values')" data-sort="float_values">
                                æµé€šå¸‚å€¼(äº¿)<span class="sort-indicator"></span>
                            </th>
                            <th onclick="sortTable('nine_turn')" data-sort="nine_turn">
                                ä¹è½¬<span class="sort-indicator"></span>
                            </th>
                            <th>ä¸Šæ¦œç†ç”±</th>
                        </tr>
                    </thead>
                    <tbody id="topListTableBody">
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    
    <script>
        let topListData = [];
        let sortState = { field: null, direction: 'desc' };
        
        function formatNumber(num, decimals = 2) {
            if (num === 0 || num === null || num === undefined) return '-';
            // æ•°æ®å·²ç»è½¬æ¢ä¸ºäº¿å…ƒï¼Œç›´æ¥æ˜¾ç¤º
            return num.toFixed(decimals);
        }
        
        function getTodayDate() {
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const day = String(today.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }
        
        function loadTodayData() {
            document.getElementById('tradeDate').value = getTodayDate();
            loadTopListData();
        }
        
        function loadTopListData() {
            const tradeDate = document.getElementById('tradeDate').value;
            if (!tradeDate) {
                alert('è¯·é€‰æ‹©äº¤æ˜“æ—¥æœŸ');
                return;
            }
            
            document.getElementById('loadingDiv').style.display = 'block';
            document.getElementById('topListContent').style.display = 'none';
            document.getElementById('emptyDiv').style.display = 'none';
            document.getElementById('statsDiv').style.display = 'none';
            
            const formattedDate = tradeDate.replace(/-/g, '');
            
            fetch(`/api/top-list?trade_date=${formattedDate}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        topListData = data.data || [];
                        displayTopListData();
                    } else {
                        showError('åŠ è½½é¾™è™æ¦œæ•°æ®å¤±è´¥: ' + (data.message || 'æœªçŸ¥é”™è¯¯'));
                    }
                })
                .catch(error => {
                    showError('åŠ è½½é¾™è™æ¦œæ•°æ®å¤±è´¥: ' + error.message);
                });
        }
        
        function displayTopListData() {
            document.getElementById('loadingDiv').style.display = 'none';
            
            if (topListData.length === 0) {
                document.getElementById('emptyDiv').style.display = 'block';
                document.getElementById('topListContent').style.display = 'none';
                document.getElementById('statsDiv').style.display = 'none';
                document.getElementById('filterSection').style.display = 'none';
                return;
            }
            
            document.getElementById('emptyDiv').style.display = 'none';
            document.getElementById('topListContent').style.display = 'block';
            document.getElementById('statsDiv').style.display = 'flex';
            document.getElementById('filterSection').style.display = 'block';
            
            // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
            updateStats();
            
            // åº”ç”¨æ’åº
            const sortedData = applySortToData(topListData);
            
            // å¡«å……è¡¨æ ¼æ•°æ®
            const tbody = document.getElementById('topListTableBody');
            tbody.innerHTML = '';
            
            sortedData.forEach(stock => {
                const row = document.createElement('tr');
                
                const changePercent = stock.pct_change || 0;
                const priceClass = changePercent >= 0 ? 'price-positive' : 'price-negative';
                const changeSign = changePercent >= 0 ? '+' : '';
                
                const netAmount = stock.net_amount || 0;
                const netClass = netAmount >= 0 ? 'net-positive' : 'net-negative';
                const netSign = netAmount >= 0 ? '+' : '';
                
                row.innerHTML = `
                    <td>
                        <div class="stock-code">${stock.ts_code}</div>
                    </td>
                    <td>
                        <div class="stock-name" onclick="viewStock('${stock.ts_code}')">${stock.name}</div>
                    </td>
                    <td class="${priceClass}">Â¥${(stock.close || 0).toFixed(2)}</td>
                    <td class="${priceClass}">${changeSign}${changePercent.toFixed(2)}%</td>
                    <td>${(stock.turnover_rate || 0).toFixed(2)}%</td>
                    <td>${formatNumber((stock.amount || 0) / 100000000)}</td>
                    <td>${formatNumber((stock.l_sell || 0) / 100000000)}</td>
                    <td>${formatNumber((stock.l_buy || 0) / 100000000)}</td>
                    <td>${formatNumber((stock.l_amount || 0) / 100000000)}</td>
                    <td class="${netClass}">${netSign}${formatNumber((netAmount) / 100000000)}</td>
                    <td class="${netClass}">${netSign}${(stock.net_rate || 0).toFixed(2)}%</td>
                    <td>${(stock.amount_rate || 0).toFixed(2)}%</td>
                    <td>${formatNumber((stock.float_values || 0) / 100000000)}</td>
                    <td>
                        ${(() => {
                            if (stock.nine_turn_up && stock.nine_turn_up > 0) {
                                return `<span style="color: red; font-weight: bold;">${stock.nine_turn_up}</span>`;
                            } else if (stock.nine_turn_down && stock.nine_turn_down > 0) {
                                return `<span style="color: green; font-weight: bold;">${stock.nine_turn_down}</span>`;
                            } else if (stock.countdown_up && stock.countdown_up > 0) {
                                return `<span style="color: red; font-weight: bold;">${stock.countdown_up}</span>`;
                            } else if (stock.countdown_down && stock.countdown_down > 0) {
                                return `<span style="color: green; font-weight: bold;">${stock.countdown_down}</span>`;
                            } else {
                                return '-';
                            }
                        })()} 
                    </td>
                    <td style="max-width: 200px; word-wrap: break-word;">${stock.reason || '-'}</td>
                `;
                
                tbody.appendChild(row);
            });
            
            // æ›´æ–°æ’åºæŒ‡ç¤ºå™¨
            updateSortIndicators();
        }
        
        function updateStats() {
            const totalCount = topListData.length;
            const netBuyCount = topListData.filter(stock => (stock.net_amount || 0) > 0).length;
            const netSellCount = topListData.filter(stock => (stock.net_amount || 0) < 0).length;
            const totalAmount = topListData.reduce((sum, stock) => sum + (stock.amount || 0), 0) / 100000000; // è½¬æ¢ä¸ºäº¿
            
            document.getElementById('totalCount').textContent = totalCount;
            document.getElementById('netBuyCount').textContent = netBuyCount;
            document.getElementById('netSellCount').textContent = netSellCount;
            document.getElementById('totalAmount').textContent = totalAmount.toFixed(2);
        }
        
        function applySortToData(data) {
            if (!sortState.field) {
                return data;
            }
            
            return [...data].sort((a, b) => {
                let aVal = a[sortState.field];
                let bVal = b[sortState.field];
                
                // å¤„ç†ç©ºå€¼
                if (aVal === null || aVal === undefined) aVal = 0;
                if (bVal === null || bVal === undefined) bVal = 0;
                
                // å¤„ç†ç‰¹æ®Šå­—æ®µ
                if (sortState.field === 'ts_code' || sortState.field === 'name') {
                    // å¯¹äºå­—ç¬¦ä¸²ç±»å‹ä½¿ç”¨localeCompare
                    if (sortState.direction === 'asc') {
                        return String(aVal).localeCompare(String(bVal));
                    } else {
                        return String(bVal).localeCompare(String(aVal));
                    }
                } else if (sortState.field === 'nine_turn') {
                    // ä¹è½¬å­—æ®µçš„æ’åºé€»è¾‘
                    aVal = a.nine_turn_up || a.nine_turn_down || a.countdown_up || a.countdown_down || 0;
                    bVal = b.nine_turn_up || b.nine_turn_down || b.countdown_up || b.countdown_down || 0;
                }
                
                if (sortState.direction === 'asc') {
                    return aVal - bVal;
                } else {
                    return bVal - aVal;
                }
            });
        }
        
        function sortTable(field) {
            let newDirection = 'desc';
            
            if (sortState.field === field) {
                newDirection = sortState.direction === 'desc' ? 'asc' : 'desc';
            }
            
            sortState = { field, direction: newDirection };
            
            // é‡æ–°æ˜¾ç¤ºæ•°æ®
            displayTopListData();
        }
        
        function updateSortIndicators() {
            // æ¸…é™¤æ‰€æœ‰æ’åºæŒ‡ç¤ºå™¨
            document.querySelectorAll('.sort-indicator').forEach(indicator => {
                indicator.className = 'sort-indicator';
            });
            
            // è®¾ç½®å½“å‰æ’åºå­—æ®µçš„æŒ‡ç¤ºå™¨
            if (sortState.field) {
                const th = document.querySelector(`th[data-sort="${sortState.field}"] .sort-indicator`);
                if (th) {
                    th.className = `sort-indicator sort-${sortState.direction}`;
                }
            }
        }
        
        function viewStock(tsCode) {
            window.open(`/stock/${tsCode}`, '_blank');
        }
        
        function goBack() {
            window.location.href = '/';
        }
        
        function refreshData() {
            loadTopListData();
        }
        
        function showError(message) {
            document.getElementById('loadingDiv').style.display = 'none';
            document.getElementById('topListContent').style.display = 'none';
            document.getElementById('statsDiv').style.display = 'none';
            document.getElementById('emptyDiv').style.display = 'block';
            document.getElementById('emptyDiv').innerHTML = `
                <p style="color: #e74c3c;">åŠ è½½å¤±è´¥</p>
                <p style="margin-top: 10px; font-size: 0.9em; color: #999;">${message}</p>
            `;
        }
        
        // ç­›é€‰åŠŸèƒ½
        let filteredData = [];
        
        function applyFilters() {
            const filters = {
                pctChangeMin: parseFloat(document.getElementById('pctChangeMin').value) || null,
                pctChangeMax: parseFloat(document.getElementById('pctChangeMax').value) || null,
                volumeRatioMin: parseFloat(document.getElementById('volumeRatioMin').value) || null,
                volumeRatioMax: parseFloat(document.getElementById('volumeRatioMax').value) || null,
                nineTurnUp: parseInt(document.getElementById('nineTurnUp').value) || null,
                nineTurnUpMax: parseInt(document.getElementById('nineTurnUpMax').value) || null,
                netInflowMin: parseFloat(document.getElementById('netInflowMin').value) || null,
                netInflowMax: parseFloat(document.getElementById('netInflowMax').value) || null,
                stockCode: document.getElementById('stockCode').value.trim() || null,
                todayChangeMin: parseFloat(document.getElementById('todayChangeMin').value) || null,
                todayChangeMax: parseFloat(document.getElementById('todayChangeMax').value) || null
            };
            
            filteredData = topListData.filter(stock => {
                // æ¶¨è·Œå¹…ç­›é€‰
                if (filters.pctChangeMin !== null && (stock.pct_change || 0) < filters.pctChangeMin) return false;
                if (filters.pctChangeMax !== null && (stock.pct_change || 0) > filters.pctChangeMax) return false;
                
                // é‡æ¯”ç­›é€‰ (æ³¨æ„ï¼šå½“å‰æ•°æ®ä¸­å¯èƒ½æ²¡æœ‰é‡æ¯”å­—æ®µï¼Œä½¿ç”¨æ¢æ‰‹ç‡ä½œä¸ºæ›¿ä»£)
                if (filters.volumeRatioMin !== null && (stock.turnover_rate || 0) < filters.volumeRatioMin) return false;
                if (filters.volumeRatioMax !== null && (stock.turnover_rate || 0) > filters.volumeRatioMax) return false;
                
                // ä¹è½¬ä¹°å…¥ç­›é€‰
                if (filters.nineTurnUp !== null || filters.nineTurnUpMax !== null) {
                    const nineTurnValue = stock.nine_turn_up || 0;
                    if (filters.nineTurnUp !== null && nineTurnValue < filters.nineTurnUp) return false;
                    if (filters.nineTurnUpMax !== null && nineTurnValue > filters.nineTurnUpMax) return false;
                    if (nineTurnValue === 0) return false; // åªæ˜¾ç¤ºæœ‰ä¹è½¬ä¹°å…¥ä¿¡å·çš„è‚¡ç¥¨
                }
                
                // å‡€æµå…¥é¢ç­›é€‰ (è½¬æ¢ä¸ºä¸‡å…ƒ)
                if (filters.netInflowMin !== null && ((stock.net_amount || 0) / 10000) < filters.netInflowMin) return false;
                if (filters.netInflowMax !== null && ((stock.net_amount || 0) / 10000) > filters.netInflowMax) return false;
                
                // è‚¡ç¥¨ä»£ç ç­›é€‰
                if (filters.stockCode !== null && !stock.ts_code.includes(filters.stockCode)) return false;
                
                // å½“å¤©æ¶¨å¹…ç­›é€‰ (ä¸æ¶¨è·Œå¹…ç›¸åŒ)
                if (filters.todayChangeMin !== null && (stock.pct_change || 0) < filters.todayChangeMin) return false;
                if (filters.todayChangeMax !== null && (stock.pct_change || 0) > filters.todayChangeMax) return false;
                
                return true;
            });
            
            // æ˜¾ç¤ºç­›é€‰åçš„æ•°æ®
            displayFilteredData();
        }
        
        function clearFilters() {
            // æ¸…ç©ºæ‰€æœ‰ç­›é€‰è¾“å…¥æ¡†
            document.getElementById('pctChangeMin').value = '';
            document.getElementById('pctChangeMax').value = '';
            document.getElementById('volumeRatioMin').value = '';
            document.getElementById('volumeRatioMax').value = '';
            document.getElementById('nineTurnUp').value = '';
            document.getElementById('nineTurnUpMax').value = '';
            document.getElementById('netInflowMin').value = '';
            document.getElementById('netInflowMax').value = '';
            document.getElementById('stockCode').value = '';
            document.getElementById('todayChangeMin').value = '';
            document.getElementById('todayChangeMax').value = '';
            
            // é‡ç½®ç­›é€‰æ•°æ®ä¸ºåŸå§‹æ•°æ®
            filteredData = [];
            displayTopListData();
        }
        
        function displayFilteredData() {
            const dataToShow = filteredData.length > 0 ? filteredData : topListData;
            
            // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
            updateStatsForData(dataToShow);
            
            // åº”ç”¨æ’åº
            const sortedData = applySortToData(dataToShow);
            
            // å¡«å……è¡¨æ ¼æ•°æ®
            const tbody = document.getElementById('topListTableBody');
            tbody.innerHTML = '';
            
            if (sortedData.length === 0) {
                const row = document.createElement('tr');
                row.innerHTML = `<td colspan="15" style="text-align: center; padding: 20px; color: #666;">æ²¡æœ‰ç¬¦åˆç­›é€‰æ¡ä»¶çš„æ•°æ®</td>`;
                tbody.appendChild(row);
                return;
            }
            
            sortedData.forEach(stock => {
                const row = document.createElement('tr');
                
                const changePercent = stock.pct_change || 0;
                const priceClass = changePercent >= 0 ? 'price-positive' : 'price-negative';
                const changeSign = changePercent >= 0 ? '+' : '';
                
                const netAmount = stock.net_amount || 0;
                const netClass = netAmount >= 0 ? 'net-positive' : 'net-negative';
                const netSign = netAmount >= 0 ? '+' : '';
                
                row.innerHTML = `
                    <td>
                        <div class="stock-code">${stock.ts_code}</div>
                    </td>
                    <td>
                        <div class="stock-name" onclick="viewStock('${stock.ts_code}')">${stock.name}</div>
                    </td>
                    <td class="${priceClass}">Â¥${(stock.close || 0).toFixed(2)}</td>
                    <td class="${priceClass}">${changeSign}${changePercent.toFixed(2)}%</td>
                    <td>${(stock.turnover_rate || 0).toFixed(2)}%</td>
                    <td>${formatNumber((stock.amount || 0) / 100000000)}</td>
                    <td>${formatNumber((stock.l_sell || 0) / 100000000)}</td>
                    <td>${formatNumber((stock.l_buy || 0) / 100000000)}</td>
                    <td>${formatNumber((stock.l_amount || 0) / 100000000)}</td>
                    <td class="${netClass}">${netSign}${formatNumber((netAmount) / 100000000)}</td>
                    <td class="${netClass}">${netSign}${(stock.net_rate || 0).toFixed(2)}%</td>
                    <td>${(stock.amount_rate || 0).toFixed(2)}%</td>
                    <td>${formatNumber((stock.float_values || 0) / 100000000)}</td>
                    <td>
                        ${(() => {
                            if (stock.nine_turn_up && stock.nine_turn_up > 0) {
                                return `<span style="color: red; font-weight: bold;">${stock.nine_turn_up}</span>`;
                            } else if (stock.nine_turn_down && stock.nine_turn_down > 0) {
                                return `<span style="color: green; font-weight: bold;">${stock.nine_turn_down}</span>`;
                            } else if (stock.countdown_up && stock.countdown_up > 0) {
                                return `<span style="color: red; font-weight: bold;">${stock.countdown_up}</span>`;
                            } else if (stock.countdown_down && stock.countdown_down > 0) {
                                return `<span style="color: green; font-weight: bold;">${stock.countdown_down}</span>`;
                            } else {
                                return '-';
                            }
                        })()} 
                    </td>
                    <td style="max-width: 200px; word-wrap: break-word;">${stock.reason || '-'}</td>
                `;
                
                tbody.appendChild(row);
            });
            
            // æ›´æ–°æ’åºæŒ‡ç¤ºå™¨
            updateSortIndicators();
        }
        
        function updateStatsForData(data) {
            const totalCount = data.length;
            const netBuyCount = data.filter(stock => (stock.net_amount || 0) > 0).length;
            const netSellCount = data.filter(stock => (stock.net_amount || 0) < 0).length;
            const totalAmount = data.reduce((sum, stock) => sum + (stock.amount || 0), 0) / 100000000; // è½¬æ¢ä¸ºäº¿
            
            document.getElementById('totalCount').textContent = totalCount;
            document.getElementById('netBuyCount').textContent = netBuyCount;
            document.getElementById('netSellCount').textContent = netSellCount;
            document.getElementById('totalAmount').textContent = totalAmount.toFixed(2);
        }

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            // è®¾ç½®é»˜è®¤æ—¥æœŸä¸ºä»Šå¤©
            document.getElementById('tradeDate').value = getTodayDate();
            // åŠ è½½ä»Šæ—¥æ•°æ®
            loadTopListData();
        });
    </script>
</body>
</html>