<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¼“å­˜ç³»ç»Ÿç›‘æ§ - TD Sequential</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            color: white;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .nav-buttons {
            text-align: center;
            margin-bottom: 30px;
        }

        .nav-btn {
            display: inline-block;
            padding: 12px 24px;
            margin: 0 10px;
            background: rgba(255,255,255,0.2);
            color: white;
            text-decoration: none;
            border-radius: 25px;
            border: 2px solid rgba(255,255,255,0.3);
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }

        .nav-btn:hover {
            background: rgba(255,255,255,0.3);
            border-color: rgba(255,255,255,0.5);
            transform: translateY(-2px);
        }

        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .card {
            background: rgba(255,255,255,0.95);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2);
        }

        .card h3 {
            color: #333;
            margin-bottom: 20px;
            font-size: 1.3rem;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }

        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-healthy {
            background: #4CAF50;
            box-shadow: 0 0 10px rgba(76,175,80,0.5);
        }

        .status-unhealthy {
            background: #f44336;
            box-shadow: 0 0 10px rgba(244,67,54,0.5);
        }

        .metric-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #eee;
        }

        .metric-item:last-child {
            border-bottom: none;
        }

        .metric-label {
            color: #666;
            font-weight: 500;
        }

        .metric-value {
            color: #333;
            font-weight: bold;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e0e0e0;
            border-radius: 4px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4CAF50, #8BC34A);
            transition: width 0.3s ease;
        }

        .error-list {
            background: #ffebee;
            border: 1px solid #ffcdd2;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
        }

        .error-item {
            color: #d32f2f;
            margin-bottom: 5px;
            font-size: 0.9rem;
        }

        .error-item:last-child {
            margin-bottom: 0;
        }

        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
            text-align: center;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5a6fd8;
            transform: translateY(-2px);
        }

        .btn-danger {
            background: #f44336;
            color: white;
        }

        .btn-danger:hover {
            background: #d32f2f;
            transform: translateY(-2px);
        }

        .btn-success {
            background: #4CAF50;
            color: white;
        }

        .btn-success:hover {
            background: #45a049;
            transform: translateY(-2px);
        }

        .market-cache {
            margin-bottom: 20px;
        }

        .market-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .market-name {
            font-size: 1.1rem;
            font-weight: bold;
            color: #333;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .loading::after {
            content: '';
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-left: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .auto-refresh {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
            justify-content: center;
        }

        .auto-refresh label {
            color: white;
            font-weight: 500;
        }

        .auto-refresh input[type="checkbox"] {
            transform: scale(1.2);
        }

        .last-update {
            text-align: center;
            color: rgba(255,255,255,0.8);
            font-size: 0.9rem;
            margin-bottom: 20px;
        }

        @media (max-width: 768px) {
            .dashboard {
                grid-template-columns: 1fr;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .action-buttons {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ”§ ç¼“å­˜ç³»ç»Ÿç›‘æ§</h1>
            <p>å®æ—¶ç›‘æ§TD Sequentialç³»ç»Ÿçš„ç¼“å­˜çŠ¶æ€å’Œæ€§èƒ½æŒ‡æ ‡</p>
        </div>

        <div class="nav-buttons">
            <a href="/" class="nav-btn">ğŸ  é¦–é¡µ</a>
            <a href="/watchlist" class="nav-btn">â­ è‡ªé€‰è‚¡</a>
            <a href="#" class="nav-btn" onclick="refreshData()">ğŸ”„ åˆ·æ–°æ•°æ®</a>
        </div>

        <div class="auto-refresh">
            <label>
                <input type="checkbox" id="autoRefresh" checked>
                è‡ªåŠ¨åˆ·æ–° (30ç§’)
            </label>
        </div>

        <div class="last-update" id="lastUpdate"></div>

        <div class="dashboard">
            <!-- ç³»ç»ŸçŠ¶æ€å¡ç‰‡ -->
            <div class="card">
                <h3>ğŸ¥ ç³»ç»Ÿå¥åº·çŠ¶æ€</h3>
                <div id="systemStatus" class="loading">åŠ è½½ä¸­...</div>
            </div>

            <!-- æ€§èƒ½æŒ‡æ ‡å¡ç‰‡ -->
            <div class="card">
                <h3>ğŸ“Š æ€§èƒ½æŒ‡æ ‡</h3>
                <div id="performanceMetrics" class="loading">åŠ è½½ä¸­...</div>
            </div>

            <!-- ç¼“å­˜ä¿¡æ¯å¡ç‰‡ -->
            <div class="card">
                <h3>ğŸ’¾ ç¼“å­˜ä¿¡æ¯</h3>
                <div id="cacheInfo" class="loading">åŠ è½½ä¸­...</div>
            </div>

            <!-- å¸‚åœºç¼“å­˜è¯¦æƒ…å¡ç‰‡ -->
            <div class="card">
                <h3>ğŸ¢ å¸‚åœºç¼“å­˜è¯¦æƒ…</h3>
                <div id="marketCaches" class="loading">åŠ è½½ä¸­...</div>
            </div>
        </div>

        <!-- æ“ä½œé¢æ¿ -->
        <div class="card">
            <h3>ğŸ› ï¸ ç¼“å­˜æ“ä½œ</h3>
            <div class="action-buttons">
                <button class="btn btn-primary" onclick="refreshData()">ğŸ”„ åˆ·æ–°ç›‘æ§æ•°æ®</button>
                <button class="btn btn-success" onclick="clearCache('sz')">ğŸ§¹ æ¸…ç†æ·±å¸‚ç¼“å­˜</button>
                <button class="btn btn-success" onclick="clearCache('sh')">ğŸ§¹ æ¸…ç†æ²ªå¸‚ç¼“å­˜</button>
                <button class="btn btn-success" onclick="clearCache('cyb')">ğŸ§¹ æ¸…ç†åˆ›ä¸šæ¿ç¼“å­˜</button>
                <button class="btn btn-danger" onclick="clearAllCache()">ğŸ—‘ï¸ æ¸…ç†å…¨éƒ¨ç¼“å­˜</button>
            </div>
        </div>
    </div>

    <script>
        let autoRefreshInterval;
        const markets = ['sz', 'sh', 'cyb'];

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            refreshData();
            setupAutoRefresh();
        });

        // è®¾ç½®è‡ªåŠ¨åˆ·æ–°
        function setupAutoRefresh() {
            const checkbox = document.getElementById('autoRefresh');
            
            function toggleAutoRefresh() {
                if (checkbox.checked) {
                    autoRefreshInterval = setInterval(refreshData, 30000); // 30ç§’
                } else {
                    if (autoRefreshInterval) {
                        clearInterval(autoRefreshInterval);
                    }
                }
            }
            
            checkbox.addEventListener('change', toggleAutoRefresh);
            toggleAutoRefresh(); // åˆå§‹è®¾ç½®
        }

        // åˆ·æ–°æ‰€æœ‰æ•°æ®
        async function refreshData() {
            updateLastUpdateTime();
            await Promise.all([
                loadSystemStatus(),
                loadPerformanceMetrics(),
                loadCacheInfo(),
                loadMarketCaches()
            ]);
        }

        // æ›´æ–°æœ€åæ›´æ–°æ—¶é—´
        function updateLastUpdateTime() {
            const now = new Date();
            document.getElementById('lastUpdate').textContent = 
                `æœ€åæ›´æ–°: ${now.toLocaleString()}`;
        }

        // åŠ è½½ç³»ç»ŸçŠ¶æ€
        async function loadSystemStatus() {
            try {
                const response = await fetch('/api/cache/status');
                const result = await response.json();
                
                if (result.success) {
                    const data = result.data;
                    const statusHtml = `
                        <div class="metric-item">
                            <span class="metric-label">
                                <span class="status-indicator ${data.is_healthy ? 'status-healthy' : 'status-unhealthy'}"></span>
                                ç³»ç»ŸçŠ¶æ€
                            </span>
                            <span class="metric-value">${data.is_healthy ? 'å¥åº·' : 'å¼‚å¸¸'}</span>
                        </div>
                        <div class="metric-item">
                            <span class="metric-label">æœ€åæ£€æŸ¥</span>
                            <span class="metric-value">${formatTime(data.last_check_time)}</span>
                        </div>
                        <div class="metric-item">
                            <span class="metric-label">å†…å­˜ç¼“å­˜å¤§å°</span>
                            <span class="metric-value">${data.memory_cache_size} é¡¹</span>
                        </div>
                        <div class="metric-item">
                            <span class="metric-label">ç¼“å­˜ç›®å½•</span>
                            <span class="metric-value">${data.cache_dir}</span>
                        </div>
                        ${data.error_messages && data.error_messages.length > 0 ? `
                            <div class="error-list">
                                <strong>é”™è¯¯ä¿¡æ¯:</strong>
                                ${data.error_messages.map(msg => `<div class="error-item">â€¢ ${msg}</div>`).join('')}
                            </div>
                        ` : ''}
                    `;
                    document.getElementById('systemStatus').innerHTML = statusHtml;
                } else {
                    throw new Error(result.error);
                }
            } catch (error) {
                document.getElementById('systemStatus').innerHTML = 
                    `<div class="error-item">åŠ è½½å¤±è´¥: ${error.message}</div>`;
            }
        }

        // åŠ è½½æ€§èƒ½æŒ‡æ ‡
        async function loadPerformanceMetrics() {
            try {
                const response = await fetch('/api/cache/status');
                const result = await response.json();
                
                if (result.success) {
                    const metrics = result.data.metrics;
                    const hitRate = (metrics.hit_rate * 100).toFixed(1);
                    
                    const metricsHtml = `
                        <div class="metric-item">
                            <span class="metric-label">ç¼“å­˜å‘½ä¸­ç‡</span>
                            <span class="metric-value">${hitRate}%</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${hitRate}%"></div>
                        </div>
                        <div class="metric-item">
                            <span class="metric-label">å‘½ä¸­æ¬¡æ•°</span>
                            <span class="metric-value">${metrics.hit_count}</span>
                        </div>
                        <div class="metric-item">
                            <span class="metric-label">æœªå‘½ä¸­æ¬¡æ•°</span>
                            <span class="metric-value">${metrics.miss_count}</span>
                        </div>
                        <div class="metric-item">
                            <span class="metric-label">é”™è¯¯æ¬¡æ•°</span>
                            <span class="metric-value">${metrics.error_count}</span>
                        </div>
                        <div class="metric-item">
                            <span class="metric-label">æ–‡ä»¶æ•°é‡</span>
                            <span class="metric-value">${metrics.file_count}</span>
                        </div>
                        <div class="metric-item">
                            <span class="metric-label">æ•°æ®å¤§å°</span>
                            <span class="metric-value">${formatBytes(metrics.data_size)}</span>
                        </div>
                    `;
                    document.getElementById('performanceMetrics').innerHTML = metricsHtml;
                } else {
                    throw new Error(result.error);
                }
            } catch (error) {
                document.getElementById('performanceMetrics').innerHTML = 
                    `<div class="error-item">åŠ è½½å¤±è´¥: ${error.message}</div>`;
            }
        }

        // åŠ è½½ç¼“å­˜ä¿¡æ¯
        async function loadCacheInfo() {
            try {
                const response = await fetch('/api/rate_limiter/status');
                const result = await response.json();
                
                if (result.status === 'success') {
                    const data = result.data;
                    const infoHtml = `
                        <div class="metric-item">
                            <span class="metric-label">APIå‰©ä½™è¯·æ±‚</span>
                            <span class="metric-value">${data.remaining_requests}/${data.max_requests_per_minute}</span>
                        </div>
                        <div class="metric-item">
                            <span class="metric-label">å·²ä½¿ç”¨è¯·æ±‚</span>
                            <span class="metric-value">${data.used_requests}</span>
                        </div>
                        <div class="metric-item">
                            <span class="metric-label">ä¸‹æ¬¡é‡ç½®</span>
                            <span class="metric-value">${data.next_reset_time ? formatTime(data.next_reset_time) : 'æ— '}</span>
                        </div>
                        <div class="metric-item">
                            <span class="metric-label">å½“å‰æ—¶é—´</span>
                            <span class="metric-value">${data.current_time_formatted}</span>
                        </div>
                    `;
                    document.getElementById('cacheInfo').innerHTML = infoHtml;
                } else {
                    throw new Error(result.message);
                }
            } catch (error) {
                document.getElementById('cacheInfo').innerHTML = 
                    `<div class="error-item">åŠ è½½å¤±è´¥: ${error.message}</div>`;
            }
        }

        // åŠ è½½å¸‚åœºç¼“å­˜è¯¦æƒ…
        async function loadMarketCaches() {
            try {
                const marketInfos = await Promise.all(
                    markets.map(async market => {
                        try {
                            const response = await fetch(`/api/cache/info/${market}`);
                            const result = await response.json();
                            return result.success ? { market, ...result.data } : { market, error: result.error };
                        } catch (error) {
                            return { market, error: error.message };
                        }
                    })
                );

                const marketNames = {
                    'sz': 'æ·±å¸‚ä¸»æ¿',
                    'sh': 'æ²ªå¸‚ä¸»æ¿', 
                    'cyb': 'åˆ›ä¸šæ¿'
                };

                const marketsHtml = marketInfos.map(info => {
                    if (info.error) {
                        return `
                            <div class="market-cache">
                                <div class="market-header">
                                    <span class="market-name">${marketNames[info.market]}</span>
                                    <span class="status-indicator status-unhealthy"></span>
                                </div>
                                <div class="error-item">é”™è¯¯: ${info.error}</div>
                            </div>
                        `;
                    }

                    return `
                        <div class="market-cache">
                            <div class="market-header">
                                <span class="market-name">${marketNames[info.market]}</span>
                                <span class="status-indicator ${info.file_exists ? 'status-healthy' : 'status-unhealthy'}"></span>
                            </div>
                            <div class="metric-item">
                                <span class="metric-label">æ–‡ä»¶å­˜åœ¨</span>
                                <span class="metric-value">${info.file_exists ? 'æ˜¯' : 'å¦'}</span>
                            </div>
                            <div class="metric-item">
                                <span class="metric-label">å†…å­˜ç¼“å­˜</span>
                                <span class="metric-value">${info.in_memory ? 'æ˜¯' : 'å¦'}</span>
                            </div>
                            ${info.file_exists ? `
                                <div class="metric-item">
                                    <span class="metric-label">æ–‡ä»¶å¤§å°</span>
                                    <span class="metric-value">${formatBytes(info.file_size)}</span>
                                </div>
                                <div class="metric-item">
                                    <span class="metric-label">æœ€åä¿®æ”¹</span>
                                    <span class="metric-value">${info.last_modified_str}</span>
                                </div>
                            ` : ''}
                        </div>
                    `;
                }).join('');

                document.getElementById('marketCaches').innerHTML = marketsHtml;
            } catch (error) {
                document.getElementById('marketCaches').innerHTML = 
                    `<div class="error-item">åŠ è½½å¤±è´¥: ${error.message}</div>`;
            }
        }

        // æ¸…ç†ç‰¹å®šå¸‚åœºç¼“å­˜
        async function clearCache(market) {
            if (!confirm(`ç¡®å®šè¦æ¸…ç†${market}å¸‚åœºçš„ç¼“å­˜å—ï¼Ÿ`)) {
                return;
            }

            try {
                const response = await fetch('/api/cache/clear', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ market })
                });

                const result = await response.json();
                
                if (result.success) {
                    alert(result.message);
                    refreshData();
                } else {
                    alert('æ¸…ç†å¤±è´¥: ' + result.error);
                }
            } catch (error) {
                alert('æ¸…ç†å¤±è´¥: ' + error.message);
            }
        }

        // æ¸…ç†å…¨éƒ¨ç¼“å­˜
        async function clearAllCache() {
            if (!confirm('ç¡®å®šè¦æ¸…ç†å…¨éƒ¨ç¼“å­˜å—ï¼Ÿè¿™å°†åˆ é™¤æ‰€æœ‰å¸‚åœºçš„ç¼“å­˜æ•°æ®ï¼')) {
                return;
            }

            try {
                const response = await fetch('/api/cache/clear', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({})
                });

                const result = await response.json();
                
                if (result.success) {
                    alert(result.message);
                    refreshData();
                } else {
                    alert('æ¸…ç†å¤±è´¥: ' + result.error);
                }
            } catch (error) {
                alert('æ¸…ç†å¤±è´¥: ' + error.message);
            }
        }

        // å·¥å…·å‡½æ•°
        function formatTime(timestamp) {
            if (!timestamp) return 'æ— ';
            return new Date(timestamp * 1000).toLocaleString();
        }

        function formatBytes(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
    </script>
</body>
</html>