<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>技术指标测试</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
</head>
<body>
    <h1>技术指标测试页面</h1>
    
    <div id="loading" style="display: none;">正在加载技术指标数据...</div>
    <div id="error" style="display: none; color: red;"></div>
    
    <div id="macdChart" style="height: 300px; border: 1px solid #ccc; margin: 10px 0;"></div>
    <div id="kdjChart" style="height: 300px; border: 1px solid #ccc; margin: 10px 0;"></div>
    <div id="rsiChart" style="height: 300px; border: 1px solid #ccc; margin: 10px 0;"></div>

    <script>
        console.log('技术指标测试页面加载');
        
        async function testIndicatorAPI() {
            try {
                console.log('开始测试技术指标API');
                document.getElementById('loading').style.display = 'block';
                
                const response = await fetch('/api/kline/indicators/000001?indicators=macd,kdj,rsi&limit=10');
                console.log('API响应状态:', response.status);
                
                const result = await response.json();
                console.log('API响应数据:', result);
                
                if (!result.success) {
                    throw new Error(result.message || result.error || '获取技术指标数据失败');
                }
                
                const klineData = result.data.kline_data;
                console.log('K线数据:', klineData);
                
                if (!klineData || klineData.length === 0) {
                    throw new Error('没有K线数据');
                }
                
                // 绘制图表
                drawTestCharts(klineData);
                
            } catch (error) {
                console.error('测试失败:', error);
                document.getElementById('error').textContent = '测试失败: ' + error.message;
                document.getElementById('error').style.display = 'block';
            } finally {
                document.getElementById('loading').style.display = 'none';
            }
        }
        
        function drawTestCharts(klineData) {
            console.log('开始绘制测试图表');
            
            const dates = klineData.map(item => {
                const dateStr = item.trade_date;
                const month = dateStr.substring(4, 6);
                const day = dateStr.substring(6, 8);
                return `${month}-${day}`;
            });
            
            // MACD图表
            const macdDif = klineData.map(item => item.macd_dif || 0);
            const macdDea = klineData.map(item => item.macd_dea || 0);
            const macdHistogram = klineData.map(item => item.macd_histogram || 0);
            
            Plotly.newPlot('macdChart', [
                {
                    x: dates,
                    y: macdDif,
                    type: 'scatter',
                    mode: 'lines',
                    name: 'DIF',
                    line: { color: '#2196F3' }
                },
                {
                    x: dates,
                    y: macdDea,
                    type: 'scatter',
                    mode: 'lines',
                    name: 'DEA',
                    line: { color: '#FF9800' }
                },
                {
                    x: dates,
                    y: macdHistogram,
                    type: 'bar',
                    name: 'MACD',
                    marker: { color: macdHistogram.map(val => val >= 0 ? '#f44336' : '#4caf50') }
                }
            ], {
                title: 'MACD指标测试',
                xaxis: { type: 'category' },
                margin: { l: 50, r: 20, t: 40, b: 40 }
            });
            
            // KDJ图表
            const kdjK = klineData.map(item => item.kdj_k || 0);
            const kdjD = klineData.map(item => item.kdj_d || 0);
            const kdjJ = klineData.map(item => item.kdj_j || 0);
            
            Plotly.newPlot('kdjChart', [
                {
                    x: dates,
                    y: kdjK,
                    type: 'scatter',
                    mode: 'lines',
                    name: 'K线',
                    line: { color: '#FF9800' }
                },
                {
                    x: dates,
                    y: kdjD,
                    type: 'scatter',
                    mode: 'lines',
                    name: 'D线',
                    line: { color: '#2196F3' }
                },
                {
                    x: dates,
                    y: kdjJ,
                    type: 'scatter',
                    mode: 'lines',
                    name: 'J线',
                    line: { color: '#f44336' }
                }
            ], {
                title: 'KDJ指标测试',
                xaxis: { type: 'category' },
                yaxis: { range: [0, 100] },
                margin: { l: 50, r: 20, t: 40, b: 40 }
            });
            
            // RSI图表
            const rsiValues = klineData.map(item => item.rsi || 50);
            
            Plotly.newPlot('rsiChart', [
                {
                    x: dates,
                    y: rsiValues,
                    type: 'scatter',
                    mode: 'lines',
                    name: 'RSI',
                    line: { color: '#9c27b0' }
                }
            ], {
                title: 'RSI指标测试',
                xaxis: { type: 'category' },
                yaxis: { range: [0, 100] },
                margin: { l: 50, r: 20, t: 40, b: 40 }
            });
            
            console.log('测试图表绘制完成');
        }
        
        // 页面加载后立即测试
        window.onload = function() {
            console.log('页面加载完成，开始测试');
            testIndicatorAPI();
        };
    </script>
</body>
</html>