<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è‚¡ç¥¨è¯¦æƒ… - ä¹è½¬åºåˆ—é€‰è‚¡ç³»ç»Ÿ</title>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        
        .back-btn {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 20px;
            cursor: pointer;
            margin-bottom: 15px;
            transition: all 0.3s ease;
        }
        
        .back-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        .stock-title {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .stock-name {
            font-size: 0.9em;
            font-weight: bold;
            color: #333;
        }
        
        .stock-code {
            font-size: 0.9em;
            color: #666;
        }
        
        .stock-price {
            font-size: 1.8em;
            font-weight: bold;
            color: #e74c3c;
        }
        
        .stock-info {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 20px;
        }
        
        .info-item {
            background: #f8f9fa;
            padding: 8px 12px;
            border-radius: 8px;
            text-align: center;
            flex: 1;
            min-width: 100px;
        }
        
        .info-label {
            font-size: 12px;
            color: #666;
            margin-bottom: 5px;
        }
        
        .info-value {
            font-size: 14px;
            font-weight: bold;
            color: #333;
        }
        
        .chart-section {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        
        .chart-title {
            font-size: 0.9em;
            font-weight: bold;
            margin-bottom: 20px;
            color: #333;
        }
        
        .kline-chart {
            width: 100%;
            height: 600px;
        }
        
        .macd-chart {
            width: 100%;
            height: 300px;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            font-size: 14px;
            color: #666;
        }
        
        .error {
            text-align: center;
            padding: 20px;
            color: #e74c3c;
            background: #ffeaea;
            border-radius: 10px;
            margin: 20px 0;
        }
        
        .price-info {
            display: flex;
            gap: 20px;
            margin-top: 10px;
            font-size: 12px;
        }
        
        .price-high {
            color: #e74c3c;
        }
        
        .price-low {
            color: #27ae60;
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .stock-title {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .stock-info {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .kline-chart {
                height: 400px;
            }
            
            .macd-chart {
                height: 200px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div id="loadingDiv" class="loading">æ­£åœ¨åŠ è½½è‚¡ç¥¨æ•°æ®...</div>
            <div id="errorDiv" class="error" style="display: none;"></div>
            
            <div id="stockInfo" style="display: none;">
                <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 20px;">
                    <button class="back-btn" onclick="history.back()">â† è¿”å›</button>
                    <div style="display: flex; flex-direction: column; gap: 10px;">
                        <div style="position: relative; display: inline-block;">
                            <select id="addToWatchlistSelect" onchange="addToWatchlistWithPriority(this.value)" style="
                                background: linear-gradient(45deg, #ffc107, #fd7e14);
                                color: #333;
                                border: none;
                                padding: 10px 20px;
                                border-radius: 20px;
                                cursor: pointer;
                                font-size: 14px;
                                font-weight: bold;
                                transition: all 0.3s ease;
                                appearance: none;
                                -webkit-appearance: none;
                                -moz-appearance: none;
                                padding-right: 30px;
                                background-image: url('data:image/svg+xml;charset=US-ASCII,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 4 5%22><path fill=%22%23333%22 d=%22M2 0L0 2h4zm0 5L0 3h4z%22/></svg>');
                                background-repeat: no-repeat;
                                background-position: right 10px center;
                                background-size: 12px;
                            ">
                                <option value="" disabled selected>â­ åŠ å…¥è‡ªé€‰è‚¡</option>
                                <option value="purple" style="background-color: #8e44ad; color: white;">ğŸŸ£ å¯ç«‹å³ä¹°å…¥</option>
                                <option value="red" style="background-color: #e74c3c; color: white;">ğŸ”´ é‡ç‚¹å…³æ³¨</option>
                                <option value="blue" style="background-color: #3498db; color: white;">ğŸ”µ è§‚å¯Ÿ2å¤©</option>
                                <option value="green" style="background-color: #27ae60; color: white;">ğŸŸ¢ è§‚å¯Ÿ3å¤©</option>
                            </select>
                        </div>
                        <button class="back-btn" id="refreshDataBtn" onclick="refreshStockData()" style="background: linear-gradient(45deg, #28a745, #20c997);">ğŸ”„ åˆ·æ–°æ•°æ®</button>
                    </div>
                </div>
                <div class="stock-title">
                    <div>
                        <div class="stock-name" id="stockName"></div>
                        <div class="stock-code" id="stockCode"></div>
                    </div>
                    <div style="display: flex; align-items: center; gap: 15px;">
                        <div class="stock-price" id="stockPrice"></div>
                        <div class="price-info">
                            <span class="price-high">90å¤©æœ€é«˜: Â¥<span id="highestPrice"></span> (<span id="highestDate"></span>)</span>
                            <span class="price-low">90å¤©æœ€ä½: Â¥<span id="lowestPrice"></span> (<span id="lowestDate"></span>) <span id="lastKlineDate" style="color: black; float: right;"></span></span>
                        </div>
                    </div>
                </div>
                
                <div class="stock-info">
                    <div class="info-item">
                        <div class="info-label">å¸‚å€¼</div>
                        <div class="info-value" id="marketCap"></div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">æˆäº¤é¢</div>
                        <div class="info-value" id="amount"></div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">æ¢æ‰‹ç‡</div>
                        <div class="info-value" id="turnoverRate"></div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">é‡æ¯”</div>
                        <div class="info-value" id="volumeRatio"></div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">å¸‚ç›ˆç‡(TTM)</div>
                        <div class="info-value" id="peTtm"></div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">å¸‚å‡€ç‡(PB)</div>
                        <div class="info-value" id="pbRatio"></div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">å½“å¤©æ¶¨å¹…</div>
                        <div class="info-value" id="changePercent"></div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">æ‰€å±è¡Œä¸š</div>
                        <div class="info-value" id="industry"></div>
                    </div>
                </div>
                
                <!-- èµ„é‡‘æµå‘ä¿¡æ¯ -->
                <div class="moneyflow-section" id="moneyflowSection" style="display: none;">
                    <h3 style="margin: 20px 0 10px 0; color: #333; font-size: 1.0em;">èµ„é‡‘æµå‘</h3>
                    <div class="stock-info">
                        <div class="info-item">
                            <div class="info-label">ä¸»åŠ›å‡€æµå…¥</div>
                            <div class="info-value" id="netAmount"></div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">å‡€æµå…¥å æ¯”</div>
                            <div class="info-value" id="netAmountRate"></div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">è¶…å¤§å•å‡€æµå…¥</div>
                            <div class="info-value" id="buyElgAmount"></div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">å¤§å•å‡€æµå…¥</div>
                            <div class="info-value" id="buyLgAmount"></div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">ä¸­å•å‡€æµå…¥</div>
                            <div class="info-value" id="buyMdAmount"></div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">å°å•å‡€æµå…¥</div>
                            <div class="info-value" id="buySmAmount"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="chart-section" id="chartSection" style="display: none;">
            <div class="chart-title">æ—¥Kçº¿å›¾ (æœ€è¿‘90å¤©) - ä¹è½¬åºåˆ—</div>
            <div id="klineChart" class="kline-chart"></div>
        </div>
        
        <div class="chart-section" id="macdSection" style="display: none;">
            <div class="chart-title">MACDæŒ‡æ ‡</div>
            <div id="macdChart" class="macd-chart"></div>
        </div>
        
        <div class="chart-section" id="kdjSection" style="display: none;">
            <div class="chart-title">KDJæŒ‡æ ‡</div>
            <div id="kdjChart" class="macd-chart"></div>
        </div>
        
        <div class="chart-section" id="rsiSection" style="display: none;">
            <div class="chart-title">RSIæŒ‡æ ‡</div>
            <div id="rsiChart" class="macd-chart"></div>
        </div>
    </div>
    
    <script>
        const stockCode = '{{ stock_code }}';
        let stockData = null;
        
        
        function formatNumber(num, decimals = 2) {
            if (num === 0 || num === null || num === undefined) return '-';
            if (num >= 100000000) {
                return (num / 100000000).toFixed(decimals) + 'äº¿';
            } else if (num >= 10000) {
                return (num / 10000).toFixed(decimals) + 'ä¸‡';
            }
            return num.toFixed(decimals);
        }
        
        function formatDate(dateStr) {
            if (!dateStr) return '';
            return dateStr.substring(0, 4) + '-' + dateStr.substring(4, 6) + '-' + dateStr.substring(6, 8);
        }
        
        function formatDateChinese(dateStr) {
            if (!dateStr) return '';
            const year = dateStr.substring(0, 4);
            const month = parseInt(dateStr.substring(4, 6));
            const day = parseInt(dateStr.substring(6, 8));
            return `${year}å¹´${month}æœˆ${day}æ—¥`;
        }
        
        // å®‰å…¨çš„æ•°å€¼è½¬æ¢å‡½æ•° - ç§»åˆ°å…¨å±€ä½œç”¨åŸŸ
        function safeParseFloat(value, defaultValue = 0) {
            if (value === null || value === undefined || value === '') {
                return defaultValue;
            }
            const parsed = parseFloat(value);
            return isNaN(parsed) ? defaultValue : parsed;
        }
        
        function loadStockData() {
            fetch(`/api/stock/${stockCode}`)
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        showError(data.error);
                        return;
                    }
                    
                    stockData = data;
                    displayStockInfo(data);
                    drawKlineChart(data);
                    drawMacdChart(data);
                    drawKdjChart(data);
                    drawRsiChart(data);
                })
                .catch(error => {
                    showError('åŠ è½½æ•°æ®å¤±è´¥: ' + error.message);
                });
        }
        
        function displayStockInfo(data) {
            document.getElementById('loadingDiv').style.display = 'none';
            document.getElementById('stockInfo').style.display = 'block';
            document.getElementById('chartSection').style.display = 'block';
            document.getElementById('macdSection').style.display = 'block';
            document.getElementById('kdjSection').style.display = 'block';
            document.getElementById('rsiSection').style.display = 'block';
            
            // åŠ¨æ€è®¾ç½®é¡µé¢æ ‡é¢˜ä¸ºè‚¡ç¥¨åç§°
            document.title = data.name + ' - ä¹è½¬åºåˆ—é€‰è‚¡ç³»ç»Ÿ';
            
            document.getElementById('stockName').textContent = data.name;
            document.getElementById('stockCode').textContent = data.ts_code;
            document.getElementById('stockPrice').textContent = 'Â¥' + data.latest_price.toFixed(2);
            
            document.getElementById('highestPrice').textContent = data.highest_price.toFixed(2);
            document.getElementById('lowestPrice').textContent = data.lowest_price.toFixed(2);
            document.getElementById('highestDate').textContent = formatDate(data.highest_date);
            document.getElementById('lowestDate').textContent = formatDate(data.lowest_date);
            
            // è·å–æœ€åä¸€æ ¹Kçº¿çš„æ—¶é—´å¹¶æ˜¾ç¤º
            if (data.kline_data && data.kline_data.length > 0) {
                const lastKlineDate = data.kline_data[data.kline_data.length - 1].trade_date;
                document.getElementById('lastKlineDate').textContent = formatDateChinese(lastKlineDate);
            }
            
            document.getElementById('marketCap').textContent = formatNumber(data.market_cap * 10000);
            document.getElementById('amount').textContent = formatNumber(data.amount * 1000);
            document.getElementById('turnoverRate').textContent = data.turnover_rate.toFixed(2) + '%';
            document.getElementById('peTtm').textContent = (data.pe_ttm && data.pe_ttm > 0) ? data.pe_ttm.toFixed(2) : '-';
            document.getElementById('volumeRatio').textContent = data.volume_ratio.toFixed(2);
            
            // æ˜¾ç¤ºå¸‚å‡€ç‡(PB)
            document.getElementById('pbRatio').textContent = (data.pb && data.pb > 0) ? data.pb.toFixed(2) : '-';
            
            // æ˜¾ç¤ºå½“å¤©æ¶¨å¹…
            const changePercent = data.pct_chg || 0;
            const changeElement = document.getElementById('changePercent');
            changeElement.textContent = (changePercent >= 0 ? '+' : '') + changePercent.toFixed(2) + '%';
            changeElement.style.color = changePercent >= 0 ? '#ff4444' : '#44aa44';
            
            document.getElementById('industry').textContent = data.industry || '-';
            
            // æ˜¾ç¤ºèµ„é‡‘æµå‘æ•°æ®ï¼ˆå¦‚æœå¯ç”¨ï¼‰
            if (data.moneyflow && data.moneyflow !== null) {
                document.getElementById('moneyflowSection').style.display = 'block';
                
                // æ ¼å¼åŒ–èµ„é‡‘æµå‘æ•°å€¼çš„å‡½æ•°
                function formatMoneyflow(value) {
                    if (value === 0 || value === null || value === undefined) return '-';
                    const absValue = Math.abs(value);
                    const sign = value >= 0 ? '+' : '-';
                    let formatted;
                    
                    if (absValue >= 10000) {
                        formatted = (absValue / 10000).toFixed(2) + 'äº¿';
                    } else {
                        formatted = absValue.toFixed(2) + 'ä¸‡';
                    }
                    
                    return sign + formatted;
                }
                
                // è®¾ç½®é¢œè‰²æ ·å¼çš„å‡½æ•°
                function setMoneyflowStyle(elementId, value) {
                    const element = document.getElementById(elementId);
                    if (value > 0) {
                        element.style.color = '#ff4444'; // çº¢è‰²è¡¨ç¤ºæµå…¥
                    } else if (value < 0) {
                        element.style.color = '#44aa44'; // ç»¿è‰²è¡¨ç¤ºæµå‡º
                    } else {
                        element.style.color = '#666'; // ç°è‰²è¡¨ç¤ºæ— å˜åŒ–
                    }
                }
                
                // æ˜¾ç¤ºä¸»åŠ›å‡€æµå…¥
                const netAmount = data.moneyflow.net_amount || 0;
                document.getElementById('netAmount').textContent = formatMoneyflow(netAmount);
                setMoneyflowStyle('netAmount', netAmount);
                
                // æ˜¾ç¤ºå‡€æµå…¥å æ¯”ï¼ˆå¦‚æœæœ‰ï¼‰
                if (data.moneyflow.net_amount_rate !== undefined) {
                    const rate = data.moneyflow.net_amount_rate || 0;
                    document.getElementById('netAmountRate').textContent = rate.toFixed(2) + '%';
                    setMoneyflowStyle('netAmountRate', rate);
                } else {
                    document.getElementById('netAmountRate').textContent = '-';
                }
                
                // æ˜¾ç¤ºè¶…å¤§å•å‡€æµå…¥
                const buyElgAmount = data.moneyflow.buy_elg_amount || 0;
                document.getElementById('buyElgAmount').textContent = formatMoneyflow(buyElgAmount);
                setMoneyflowStyle('buyElgAmount', buyElgAmount);
                
                // æ˜¾ç¤ºå¤§å•å‡€æµå…¥
                const buyLgAmount = data.moneyflow.buy_lg_amount || 0;
                document.getElementById('buyLgAmount').textContent = formatMoneyflow(buyLgAmount);
                setMoneyflowStyle('buyLgAmount', buyLgAmount);
                
                // æ˜¾ç¤ºä¸­å•å‡€æµå…¥ï¼ˆå¦‚æœæœ‰ï¼‰
                if (data.moneyflow.buy_md_amount !== undefined) {
                    const buyMdAmount = data.moneyflow.buy_md_amount || 0;
                    document.getElementById('buyMdAmount').textContent = formatMoneyflow(buyMdAmount);
                    setMoneyflowStyle('buyMdAmount', buyMdAmount);
                } else {
                    document.getElementById('buyMdAmount').textContent = '-';
                }
                
                // æ˜¾ç¤ºå°å•å‡€æµå…¥ï¼ˆå¦‚æœæœ‰ï¼‰
                if (data.moneyflow.buy_sm_amount !== undefined) {
                    const buySmAmount = data.moneyflow.buy_sm_amount || 0;
                    document.getElementById('buySmAmount').textContent = formatMoneyflow(buySmAmount);
                    setMoneyflowStyle('buySmAmount', buySmAmount);
                } else {
                    document.getElementById('buySmAmount').textContent = '-';
                }
            } else {
                // å¦‚æœæ²¡æœ‰èµ„é‡‘æµå‘æ•°æ®ï¼Œéšè—è¯¥éƒ¨åˆ†
                document.getElementById('moneyflowSection').style.display = 'none';
            }
        }
        
        function drawKlineChart(data) {
            const chart = echarts.init(document.getElementById('klineChart'));
            
            const klineData = data.kline_data.map(item => [
                safeParseFloat(item.open),
                safeParseFloat(item.close),
                safeParseFloat(item.low),
                safeParseFloat(item.high)
            ]);
            
            const dates = data.kline_data.map(item => formatDate(item.trade_date));
            const volumes = data.kline_data.map(item => safeParseFloat(item.vol));
            
            // ä¹è½¬åºåˆ—æ•°æ® - åŸæœ‰çš„1-9æ•°å­—
            const nineTurnUp = data.kline_data.map((item, index) => {
                return item.nine_turn_up > 0 ? [
                    index, // xåæ ‡ï¼šæ•°æ®ç´¢å¼•
                    safeParseFloat(item.high) + (safeParseFloat(item.high) * 0.02), // yåæ ‡ï¼šKçº¿æœ€é«˜ä»·ä¸Šæ–¹2%
                    item.nine_turn_up // æ˜¾ç¤ºçš„æ•°å€¼ï¼ˆ1-9ï¼‰
                ] : null;
            }).filter(item => item !== null);
            
            const nineTurnDown = data.kline_data.map((item, index) => {
                return item.nine_turn_down > 0 ? [
                    index, // xåæ ‡ï¼šæ•°æ®ç´¢å¼•
                    safeParseFloat(item.low) - (safeParseFloat(item.low) * 0.02), // yåæ ‡ï¼šKçº¿æœ€ä½ä»·ä¸‹æ–¹2%
                    item.nine_turn_down // æ˜¾ç¤ºçš„æ•°å€¼ï¼ˆ1-9ï¼‰
                ] : null;
            }).filter(item => item !== null);
            
            // Countdownæ•°æ® - æ–°å¢çš„10-13æ•°å­—ï¼Œä½ç½®æ›´æç«¯
            const countdownUp = data.kline_data.map((item, index) => {
                return item.countdown_up > 0 ? [
                    index, // xåæ ‡ï¼šæ•°æ®ç´¢å¼•
                    safeParseFloat(item.high) + (safeParseFloat(item.high) * 0.05), // yåæ ‡ï¼šKçº¿æœ€é«˜ä»·ä¸Šæ–¹5%ï¼ˆæ›´é«˜ä½ç½®ï¼‰
                    item.countdown_up // æ˜¾ç¤ºçš„æ•°å€¼ï¼ˆ10-13ï¼‰
                ] : null;
            }).filter(item => item !== null);
            
            const countdownDown = data.kline_data.map((item, index) => {
                return item.countdown_down > 0 ? [
                    index, // xåæ ‡ï¼šæ•°æ®ç´¢å¼•
                    safeParseFloat(item.low) - (safeParseFloat(item.low) * 0.05), // yåæ ‡ï¼šKçº¿æœ€ä½ä»·ä¸‹æ–¹5%ï¼ˆæ›´ä½ä½ç½®ï¼‰
                    item.countdown_down // æ˜¾ç¤ºçš„æ•°å€¼ï¼ˆ10-13ï¼‰
                ] : null;
            }).filter(item => item !== null);
            
            // æå–BOLLæ•°æ®ï¼Œä¿ç•™nullå€¼è®©EChartsæ­£ç¡®å¤„ç†
            const bollUpper = data.kline_data.map(item => item.boll_upper === null || item.boll_upper === undefined ? null : parseFloat(item.boll_upper));
            const bollMid = data.kline_data.map(item => item.boll_mid === null || item.boll_mid === undefined ? null : parseFloat(item.boll_mid));
            const bollLower = data.kline_data.map(item => item.boll_lower === null || item.boll_lower === undefined ? null : parseFloat(item.boll_lower));
            
            // æ‰¾åˆ°æœ€é«˜ä»·å’Œæœ€ä½ä»·çš„ä½ç½®
            let highestIndex = -1;
            let lowestIndex = -1;
            let maxHigh = -1;
            let minLow = Number.MAX_VALUE;
            
            // éå†æ‰€æœ‰æ•°æ®æ‰¾åˆ°çœŸæ­£çš„æœ€é«˜ä»·å’Œæœ€ä½ä»·ä½ç½®
            data.kline_data.forEach((item, index) => {
                const high = safeParseFloat(item.high);
                const low = safeParseFloat(item.low);
                
                if (high > maxHigh) {
                    maxHigh = high;
                    highestIndex = index;
                }
                
                if (low < minLow) {
                    minLow = low;
                    lowestIndex = index;
                }
            });
            
            console.log('æœ€é«˜ä»·ä½ç½®:', highestIndex, 'ä»·æ ¼:', maxHigh);
            console.log('æœ€ä½ä»·ä½ç½®:', lowestIndex, 'ä»·æ ¼:', minLow);
            
            const option = {
                animation: false,
                legend: {
                    bottom: 10,
                    left: 'center',
                    data: ['æ—¥K', 'æˆäº¤é‡', 'ä¹è½¬åºåˆ—', 'Countdown', 'BOLLä¸Šè½¨', 'BOLLä¸­è½¨', 'BOLLä¸‹è½¨']
                },
                tooltip: {
                    trigger: 'axis',
                    axisPointer: {
                        type: 'cross'
                    },
                    backgroundColor: 'rgba(245, 245, 245, 0.8)',
                    borderWidth: 1,
                    borderColor: '#ccc',
                    textStyle: {
                        color: '#000'
                    },
                    formatter: function (params) {
                        const dataIndex = params[0].dataIndex;
                        const klineItem = data.kline_data[dataIndex];
                        const date = params[0].axisValue;
                        
                        let html = `<div style="font-weight: bold; margin-bottom: 5px;">${date}</div>`;
                        
                        // æŸ¥æ‰¾Kçº¿æ•°æ®å‚æ•°
                        const klineParam = params.find(p => p.seriesName === 'æ—¥K');
                        if (klineParam && klineParam.data) {
                            const klineData = klineParam.data;
                            // ECharts candlestickæ•°æ®æ ¼å¼: [open, close, low, high]
                            html += `<div style="color: #333; margin-bottom: 3px;">Open: ${klineData[0].toFixed(2)}</div>`;
                            html += `<div style="color: #333; margin-bottom: 3px;">Close: ${klineData[1].toFixed(2)}</div>`;
                            html += `<div style="color: #333; margin-bottom: 3px;">Low: ${klineData[2].toFixed(2)}</div>`;
                            html += `<div style="color: #333; margin-bottom: 3px;">High: ${klineData[3].toFixed(2)}</div>`;
                        }
                        
                        // BOLLçº¿æ•°æ®
                        const bollUpperParam = params.find(p => p.seriesName === 'BOLLä¸Šè½¨');
                        const bollMidParam = params.find(p => p.seriesName === 'BOLLä¸­è½¨');
                        const bollLowerParam = params.find(p => p.seriesName === 'BOLLä¸‹è½¨');
                        
                        if (bollUpperParam && bollUpperParam.data !== null) {
                            html += `<div style="color: #1E90FF; margin-bottom: 3px;">BOLL Upper: ${bollUpperParam.data.toFixed(2)}</div>`;
                        }
                        if (bollMidParam && bollMidParam.data !== null) {
                            html += `<div style="color: #1E90FF; margin-bottom: 3px;">BOLL Mid: ${bollMidParam.data.toFixed(2)}</div>`;
                        }
                        if (bollLowerParam && bollLowerParam.data !== null) {
                            html += `<div style="color: #1E90FF; margin-bottom: 3px;">BOLL Lower: ${bollLowerParam.data.toFixed(2)}</div>`;
                        }
                        
                        // æˆäº¤é¢
                        if (klineItem && klineItem.amount) {
                            const amount = parseFloat(klineItem.amount);
                            html += `<div style="color: #666; margin-bottom: 3px;">Amount: ${formatNumber(amount * 1000)}</div>`;
                        }
                        
                        // æ¶¨è·Œå¹…
                        if (klineItem && klineItem.pct_chg !== undefined && klineItem.pct_chg !== null) {
                            const pctChg = parseFloat(klineItem.pct_chg);
                            const color = pctChg >= 0 ? '#ff4444' : '#44aa44';
                            html += `<div style="color: ${color}; margin-bottom: 3px;">Change: ${pctChg >= 0 ? '+' : ''}${pctChg.toFixed(2)}%</div>`;
                        }
                        
                        // æ¢æ‰‹ç‡ï¼ˆå¦‚æœæ˜¯æœ€æ–°ä¸€å¤©çš„æ•°æ®ï¼‰
                        if (dataIndex === data.kline_data.length - 1 && data.turnover_rate) {
                            html += `<div style="color: #666; margin-bottom: 3px;">Turnover Rate: ${data.turnover_rate.toFixed(2)}%</div>`;
                        }
                        
                        // é‡æ¯”ï¼ˆå¦‚æœæ˜¯æœ€æ–°ä¸€å¤©çš„æ•°æ®ï¼‰
                        if (dataIndex === data.kline_data.length - 1 && data.volume_ratio) {
                            html += `<div style="color: #666; margin-bottom: 3px;">Volume Ratio: ${data.volume_ratio.toFixed(2)}</div>`;
                        }
                        
                        // æˆäº¤é‡æ•°æ®
                        const volumeParam = params.find(p => p.seriesName === 'æˆäº¤é‡');
                        if (volumeParam) {
                            const vol = volumeParam.data;
                            html += `<div style="color: #888; margin-top: 5px;">Volume: ${formatNumber(vol * 100)}</div>`;
                        }
                        
                        return html;
                    }
                },
                axisPointer: {
                    link: [
                        {
                            xAxisIndex: 'all'
                        }
                    ],
                    label: {
                        backgroundColor: '#777'
                    }
                },
                toolbox: {
                    feature: {
                        dataZoom: {
                            yAxisIndex: false
                        },
                        brush: {
                            type: ['lineX', 'clear']
                        }
                    }
                },
                brush: {
                    xAxisIndex: 'all',
                    brushLink: 'all',
                    outOfBrush: {
                        colorAlpha: 0.1
                    }
                },
                grid: [
                    {
                        left: '10%',
                        right: '8%',
                        height: '50%'
                    },
                    {
                        left: '10%',
                        right: '8%',
                        top: '63%',
                        height: '16%'
                    }
                ],
                xAxis: [
                    {
                        type: 'category',
                        data: dates,
                        boundaryGap: false,
                        axisLine: { onZero: false },
                        splitLine: { show: false },
                        min: 'dataMin',
                        max: 'dataMax',
                        axisPointer: {
                            z: 100
                        }
                    },
                    {
                        type: 'category',
                        gridIndex: 1,
                        data: dates,
                        boundaryGap: false,
                        axisLine: { onZero: false },
                        axisTick: { show: false },
                        splitLine: { show: false },
                        axisLabel: { show: false },
                        min: 'dataMin',
                        max: 'dataMax'
                    }
                ],
                yAxis: [
                    {
                        scale: true,
                        splitArea: {
                            show: true
                        }
                    },
                    {
                        scale: true,
                        gridIndex: 1,
                        splitNumber: 2,
                        axisLabel: { show: false },
                        axisLine: { show: false },
                        axisTick: { show: false },
                        splitLine: { show: false }
                    }
                ],
                dataZoom: [
                    {
                        type: 'inside',
                        xAxisIndex: [0, 1],
                        start: 0,
                        end: 100
                    },
                    {
                        show: true,
                        xAxisIndex: [0, 1],
                        type: 'slider',
                        top: '85%',
                        start: 0,
                        end: 100
                    }
                ],
                series: [
                    {
                        name: 'æ—¥K',
                        type: 'candlestick',
                        data: klineData,
                        itemStyle: {
                            color: '#ef232a',
                            color0: '#14b143',
                            borderColor: '#ef232a',
                            borderColor0: '#14b143'
                        },
                        markPoint: {
                            symbol: 'circle',
                            symbolSize: 8,
                            label: {
                                show: true,
                                position: 'top',
                                formatter: function (param) {
                                    return param.value ? param.value.toFixed(2) : '';
                                },
                                color: '#000000',
                                backgroundColor: 'rgba(255,255,255,0.9)',
                                borderWidth: 1,
                                borderColor: '#cccccc',
                                borderRadius: 3,
                                padding: [2, 4],
                                fontSize: 12,
                                fontWeight: 'bold'
                            },
                            data: [
                                {
                                    name: 'æœ€é«˜ä»·',
                                    coord: [highestIndex, maxHigh],
                                    value: maxHigh,
                                    itemStyle: {
                                        color: '#ff4444'
                                    }
                                },
                                {
                                    name: 'æœ€ä½ä»·',
                                    coord: [lowestIndex, minLow],
                                    value: minLow,
                                    itemStyle: {
                                        color: '#44ff44'
                                    }
                                }
                            ].filter(item => item.coord[0] >= 0), // è¿‡æ»¤æ‰æ— æ•ˆçš„ç´¢å¼•
                            tooltip: {
                                formatter: function (param) {
                                    return param.name + '<br>Â¥' + (param.data.coord ? param.data.coord[1].toFixed(2) : '');
                                }
                            }
                        }
                    },
                    {
                        name: 'æˆäº¤é‡',
                        type: 'bar',
                        xAxisIndex: 1,
                        yAxisIndex: 1,
                        data: volumes,
                        itemStyle: {
                            color: function(params) {
                                const dataIndex = params.dataIndex;
                                if (dataIndex === 0) return '#14b143';
                                return klineData[dataIndex][1] > klineData[dataIndex][0] ? '#ef232a' : '#14b143';
                            }
                        }
                    },
                    {
                        name: 'ä¹è½¬åºåˆ—(ä¸Š)',
                        type: 'scatter',
                        data: nineTurnUp,
                        symbolSize: 0, // éšè—æ•£ç‚¹ç¬¦å·
                        itemStyle: {
                            color: 'transparent'
                        },
                        label: {
                            show: true,
                            position: 'inside',
                            color: '#ef232a', // çº¢è‰²æ•°å­—
                            fontWeight: 'bold',
                            fontSize: 14,
                            backgroundColor: 'rgba(255,255,255,0.8)',
                            borderRadius: 3,
                            padding: [2, 4],
                            formatter: function(param) {
                                return param.data[2]; // æ•°ç»„çš„ç¬¬ä¸‰ä¸ªå…ƒç´ æ˜¯æ•°å€¼ï¼ˆ1-9ï¼‰
                            }
                        }
                    },
                    {
                        name: 'ä¹è½¬åºåˆ—(ä¸‹)',
                        type: 'scatter',
                        data: nineTurnDown,
                        symbolSize: 0, // éšè—æ•£ç‚¹ç¬¦å·
                        itemStyle: {
                            color: 'transparent'
                        },
                        label: {
                            show: true,
                            position: 'inside',
                            color: '#14b143', // ç»¿è‰²æ•°å­—
                            fontWeight: 'bold',
                            fontSize: 14,
                            backgroundColor: 'rgba(255,255,255,0.8)',
                            borderRadius: 3,
                            padding: [2, 4],
                            formatter: function(param) {
                                return param.data[2]; // æ•°ç»„çš„ç¬¬ä¸‰ä¸ªå…ƒç´ æ˜¯æ•°å€¼ï¼ˆ1-9ï¼‰
                            }
                        }
                    },
                    {
                        name: 'Countdown(ä¸Š)',
                        type: 'scatter',
                        data: countdownUp,
                        symbolSize: 0, // éšè—æ•£ç‚¹ç¬¦å·
                        itemStyle: {
                            color: 'transparent'
                        },
                        label: {
                            show: true,
                            position: 'inside',
                            color: '#8A2BE2', // ç´«è‰²æ•°å­—
                            fontWeight: 'bold',
                            fontSize: 14,
                            backgroundColor: 'rgba(255,255,255,0.8)',
                            borderRadius: 3,
                            padding: [2, 4],
                            formatter: function(param) {
                                return param.data[2]; // æ•°ç»„çš„ç¬¬ä¸‰ä¸ªå…ƒç´ æ˜¯æ•°å€¼ï¼ˆ10-13ï¼‰
                            }
                        }
                    },
                    {
                        name: 'Countdown(ä¸‹)',
                        type: 'scatter',
                        data: countdownDown,
                        symbolSize: 0, // éšè—æ•£ç‚¹ç¬¦å·
                        itemStyle: {
                            color: 'transparent'
                        },
                        label: {
                            show: true,
                            position: 'inside',
                            color: '#1E90FF', // è“è‰²æ•°å­—
                            fontWeight: 'bold',
                            fontSize: 14,
                            backgroundColor: 'rgba(255,255,255,0.8)',
                            borderRadius: 3,
                            padding: [2, 4],
                            formatter: function(param) {
                                return param.data[2]; // æ•°ç»„çš„ç¬¬ä¸‰ä¸ªå…ƒç´ æ˜¯æ•°å€¼ï¼ˆ10-13ï¼‰
                            }
                        }
                    },
                    {
                        name: 'BOLLä¸Šè½¨',
                        type: 'line',
                        data: bollUpper,
                        lineStyle: {
                            color: '#1E90FF',
                            width: 1
                        },
                        symbol: 'none',
                        smooth: true
                    },
                    {
                        name: 'BOLLä¸­è½¨',
                        type: 'line',
                        data: bollMid,
                        lineStyle: {
                            color: '#1E90FF',
                            width: 1
                        },
                        symbol: 'none',
                        smooth: true
                    },
                    {
                        name: 'BOLLä¸‹è½¨',
                        type: 'line',
                        data: bollLower,
                        lineStyle: {
                            color: '#1E90FF',
                            width: 1
                        },
                        symbol: 'none',
                        smooth: true
                    }
                ]
            };
            
            chart.setOption(option);
            
            window.addEventListener('resize', function() {
                chart.resize();
            });
        }
        
        function drawMacdChart(data) {
            const chart = echarts.init(document.getElementById('macdChart'));
            
            const dates = data.kline_data.map(item => formatDate(item.trade_date));
            
            // æå–MACDæ•°æ®
            const macdDif = data.kline_data.map(item => item.macd_dif === null || item.macd_dif === undefined ? null : parseFloat(item.macd_dif));
            const macdDea = data.kline_data.map(item => item.macd_dea === null || item.macd_dea === undefined ? null : parseFloat(item.macd_dea));
            const macdHistogram = data.kline_data.map(item => item.macd_histogram === null || item.macd_histogram === undefined ? null : parseFloat(item.macd_histogram));
            
            const option = {
                animation: false,
                legend: {
                    bottom: 10,
                    left: 'center',
                    data: ['DIF', 'DEA', 'MACD']
                },
                tooltip: {
                    trigger: 'axis',
                    axisPointer: {
                        type: 'cross'
                    }
                },
                grid: {
                    left: '10%',
                    right: '8%',
                    top: '10%',
                    bottom: '15%'
                },
                xAxis: {
                    type: 'category',
                    data: dates,
                    boundaryGap: false
                },
                yAxis: {
                    scale: true,
                    splitArea: {
                        show: true
                    }
                },
                dataZoom: [
                    {
                        type: 'inside',
                        start: 0,
                        end: 100
                    },
                    {
                        show: true,
                        type: 'slider',
                        bottom: '5%',
                        start: 0,
                        end: 100
                    }
                ],
                series: [
                    {
                        name: 'DIF',
                        type: 'line',
                        data: macdDif,
                        lineStyle: {
                            color: '#FF6B6B',
                            width: 2
                        },
                        symbol: 'none',
                        smooth: true
                    },
                    {
                        name: 'DEA',
                        type: 'line',
                        data: macdDea,
                        lineStyle: {
                            color: '#4ECDC4',
                            width: 2
                        },
                        symbol: 'none',
                        smooth: true
                    },
                    {
                        name: 'MACD',
                        type: 'bar',
                        data: macdHistogram,
                        itemStyle: {
                            color: function(params) {
                                return params.value >= 0 ? '#FF6B6B' : '#4ECDC4';
                            }
                        }
                    }
                ]
            };
            
            chart.setOption(option);
            
            window.addEventListener('resize', function() {
                chart.resize();
            });
        }
        
        function drawKdjChart(data) {
            const chart = echarts.init(document.getElementById('kdjChart'));
            
            const dates = data.kline_data.map(item => formatDate(item.trade_date));
            
            // æå–KDJæ•°æ®
            const kdjK = data.kline_data.map(item => item.kdj_k === null || item.kdj_k === undefined ? null : parseFloat(item.kdj_k));
            const kdjD = data.kline_data.map(item => item.kdj_d === null || item.kdj_d === undefined ? null : parseFloat(item.kdj_d));
            const kdjJ = data.kline_data.map(item => item.kdj_j === null || item.kdj_j === undefined ? null : parseFloat(item.kdj_j));
            
            const option = {
                animation: false,
                legend: {
                    bottom: 10,
                    left: 'center',
                    data: ['K', 'D', 'J']
                },
                tooltip: {
                    trigger: 'axis',
                    axisPointer: {
                        type: 'cross'
                    }
                },
                grid: {
                    left: '10%',
                    right: '8%',
                    top: '10%',
                    bottom: '15%'
                },
                xAxis: {
                    type: 'category',
                    data: dates,
                    boundaryGap: false
                },
                yAxis: {
                    scale: true,
                    min: 0,
                    max: 100,
                    splitArea: {
                        show: true
                    },
                    axisLine: {
                        lineStyle: {
                            color: '#ccc'
                        }
                    },
                    splitLine: {
                        lineStyle: {
                            color: ['#20', '#80'],
                            type: 'dashed'
                        }
                    }
                },
                dataZoom: [
                    {
                        type: 'inside',
                        start: 0,
                        end: 100
                    },
                    {
                        show: true,
                        type: 'slider',
                        bottom: '5%',
                        start: 0,
                        end: 100
                    }
                ],
                series: [
                    {
                        name: 'K',
                        type: 'line',
                        data: kdjK,
                        lineStyle: {
                            color: '#FF6B6B',
                            width: 2
                        },
                        symbol: 'none',
                        smooth: true
                    },
                    {
                        name: 'D',
                        type: 'line',
                        data: kdjD,
                        lineStyle: {
                            color: '#4ECDC4',
                            width: 2
                        },
                        symbol: 'none',
                        smooth: true
                    },
                    {
                        name: 'J',
                        type: 'line',
                        data: kdjJ,
                        lineStyle: {
                            color: '#45B7D1',
                            width: 2
                        },
                        symbol: 'none',
                        smooth: true
                    },
                    {
                        name: 'è¶…ä¹°è¶…å–çº¿',
                        type: 'line',
                        data: [],
                        markLine: {
                            silent: true,
                            data: [
                                {
                                    yAxis: 20,
                                    lineStyle: {
                                        color: '#27ae60',
                                        type: 'solid',
                                        width: 2
                                    },
                                    label: {
                                        formatter: 'è¶…å–åŒº',
                                        position: 'insideEndTop',
                                        color: '#27ae60',
                                        fontWeight: 'bold'
                                    }
                                },
                                {
                                    yAxis: 80,
                                    lineStyle: {
                                        color: '#e74c3c',
                                        type: 'solid',
                                        width: 2
                                    },
                                    label: {
                                        formatter: 'è¶…ä¹°åŒº',
                                        position: 'insideEndBottom',
                                        color: '#e74c3c',
                                        fontWeight: 'bold'
                                    }
                                }
                            ]
                        }
                    }
                ]
            };
            
            chart.setOption(option);
            
            window.addEventListener('resize', function() {
                chart.resize();
            });
        }
        
        function drawRsiChart(data) {
            const chart = echarts.init(document.getElementById('rsiChart'));
            
            const dates = data.kline_data.map(item => formatDate(item.trade_date));
            
            // æå–RSIæ•°æ®
            const rsiData = data.kline_data.map(item => item.rsi === null || item.rsi === undefined ? null : parseFloat(item.rsi));
            
            const option = {
                animation: false,
                legend: {
                    bottom: 10,
                    left: 'center',
                    data: ['RSI']
                },
                tooltip: {
                    trigger: 'axis',
                    axisPointer: {
                        type: 'cross'
                    },
                    formatter: function(params) {
                        if (params && params.length > 0) {
                            const value = params[0].value;
                            return params[0].name + '<br/>RSI: ' + (value !== null ? value.toFixed(2) : '-');
                        }
                        return '';
                    }
                },
                grid: {
                    left: '10%',
                    right: '8%',
                    top: '10%',
                    bottom: '15%'
                },
                xAxis: {
                    type: 'category',
                    data: dates,
                    boundaryGap: false
                },
                yAxis: {
                    scale: true,
                    min: 0,
                    max: 100,
                    splitArea: {
                        show: true
                    },
                    axisLine: {
                        lineStyle: {
                            color: '#ccc'
                        }
                    },
                    splitLine: {
                        lineStyle: {
                            color: ['#30', '#70'],
                            type: 'dashed'
                        }
                    }
                },
                dataZoom: [
                    {
                        type: 'inside',
                        start: 0,
                        end: 100
                    },
                    {
                        show: true,
                        type: 'slider',
                        bottom: '5%',
                        start: 0,
                        end: 100
                    }
                ],
                series: [
                    {
                        name: 'RSI',
                        type: 'line',
                        data: rsiData,
                        lineStyle: {
                            color: '#9C27B0',
                            width: 2
                        },
                        symbol: 'none',
                        smooth: true,
                        areaStyle: {
                            color: {
                                type: 'linear',
                                x: 0,
                                y: 0,
                                x2: 0,
                                y2: 1,
                                colorStops: [
                                    {
                                        offset: 0,
                                        color: 'rgba(156, 39, 176, 0.3)'
                                    },
                                    {
                                        offset: 1,
                                        color: 'rgba(156, 39, 176, 0.1)'
                                    }
                                ]
                            }
                        },
                        markLine: {
                             silent: true,
                             data: [
                                 {
                                     yAxis: 30,
                                     lineStyle: {
                                         color: '#27ae60',
                                         type: 'dashed',
                                         width: 2
                                     },
                                     label: {
                                         formatter: 'è¶…å–åŒº 30',
                                         position: 'insideEndTop',
                                         color: '#27ae60',
                                         fontWeight: 'bold'
                                     }
                                 },
                                 {
                                     yAxis: 70,
                                     lineStyle: {
                                         color: '#e74c3c',
                                         type: 'dashed',
                                         width: 2
                                     },
                                     label: {
                                         formatter: 'è¶…ä¹°åŒº 70',
                                         position: 'insideEndBottom',
                                         color: '#e74c3c',
                                         fontWeight: 'bold'
                                     }
                                 }
                             ]
                         }
                    }
                ]
            };
            
            chart.setOption(option);
            
            window.addEventListener('resize', function() {
                chart.resize();
            });
        }
        
        function showError(message) {
            document.getElementById('loadingDiv').style.display = 'none';
            document.getElementById('errorDiv').textContent = message;
            document.getElementById('errorDiv').style.display = 'block';
        }
        
        function refreshStockData() {
            const refreshBtn = document.getElementById('refreshDataBtn');
            const originalText = refreshBtn.textContent;
            
            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            refreshBtn.textContent = 'ğŸ”„ åˆ·æ–°ä¸­...';
            refreshBtn.disabled = true;
            
            // æ˜¾ç¤ºåŠ è½½æç¤º
            document.getElementById('stockInfo').style.display = 'none';
            document.getElementById('chartSection').style.display = 'none';
            document.getElementById('macdSection').style.display = 'none';
            document.getElementById('kdjSection').style.display = 'none';
            document.getElementById('rsiSection').style.display = 'none';
            document.getElementById('loadingDiv').style.display = 'block';
            document.getElementById('loadingDiv').textContent = 'æ­£åœ¨å¼ºåˆ¶åˆ·æ–°æ•°æ®...';
            document.getElementById('errorDiv').style.display = 'none';
            
            // å¼ºåˆ¶åˆ·æ–°æ•°æ®ï¼ˆæ·»åŠ æ—¶é—´æˆ³å‚æ•°é¿å…ç¼“å­˜ï¼‰
            const timestamp = new Date().getTime();
            fetch(`/api/stock/${stockCode}?force_refresh=true&t=${timestamp}`)
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        showError(data.error);
                        return;
                    }
                    
                    stockData = data;
                    displayStockInfo(data);
                    drawKlineChart(data);
                    drawMacdChart(data);
                    drawKdjChart(data);
                    drawRsiChart(data);
                    
                    // æ•°æ®åˆ·æ–°æˆåŠŸï¼Œä¸æ˜¾ç¤ºæç¤ºæ¡†
                })
                .catch(error => {
                    showError('åˆ·æ–°æ•°æ®å¤±è´¥: ' + error.message);
                })
                .finally(() => {
                    // æ¢å¤æŒ‰é’®çŠ¶æ€
                    refreshBtn.textContent = originalText;
                    refreshBtn.disabled = false;
                });
        }
        
        function addToWatchlistWithPriority(priority) {
            if (!priority) {
                return; // å¦‚æœæ²¡æœ‰é€‰æ‹©ä¼˜å…ˆçº§ï¼Œä¸æ‰§è¡Œä»»ä½•æ“ä½œ
            }
            
            if (!stockData) {
                alert('è‚¡ç¥¨æ•°æ®å°šæœªåŠ è½½å®Œæˆï¼Œè¯·ç¨åå†è¯•');
                // é‡ç½®é€‰æ‹©å™¨
                document.getElementById('addToWatchlistSelect').selectedIndex = 0;
                return;
            }
            
            // è·å–æœ€æ–°çš„ä¹è½¬åºåˆ—æ•°æ®
            let nineTurnUp = 0;
            let nineTurnDown = 0;
            if (stockData.kline_data && stockData.kline_data.length > 0) {
                const latestData = stockData.kline_data[stockData.kline_data.length - 1];
                nineTurnUp = latestData.nine_turn_up || 0;
                nineTurnDown = latestData.nine_turn_down || 0;
            }
            
            const watchlistData = {
                ts_code: stockData.ts_code,
                name: stockData.name,
                latest_price: stockData.latest_price,
                pct_chg: stockData.pct_chg || 0,
                industry: stockData.industry || '-',
                turnover_rate: stockData.turnover_rate || 0,
                volume_ratio: stockData.volume_ratio || 0,
                pe: stockData.pe || 0,
                amount: stockData.amount || 0,
                total_mv: stockData.total_mv || 0,
                nine_turn_up: nineTurnUp,
                nine_turn_down: nineTurnDown,
                priority: priority, // æ·»åŠ ä¼˜å…ˆçº§
                add_time: new Date().toISOString()
            };
            
            fetch('/api/watchlist/add', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(watchlistData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const select = document.getElementById('addToWatchlistSelect');
                    const priorityNames = {
                        'purple': 'å¯ç«‹å³ä¹°å…¥',
                        'red': 'é‡ç‚¹å…³æ³¨',
                        'blue': 'è§‚å¯Ÿ2å¤©',
                        'green': 'è§‚å¯Ÿ3å¤©'
                    };
                    
                    // æ›´æ–°é€‰æ‹©å™¨æ˜¾ç¤ºä¸ºå·²æ·»åŠ çŠ¶æ€
                    select.innerHTML = `<option selected>âœ“ å·²åŠ å…¥ (${priorityNames[priority]})</option>`;
                    select.style.background = 'linear-gradient(45deg, #28a745, #20c997)';
                    select.disabled = true;
                } else {
                    alert(data.message || 'åŠ å…¥è‡ªé€‰è‚¡å¤±è´¥');
                    // é‡ç½®é€‰æ‹©å™¨
                    document.getElementById('addToWatchlistSelect').selectedIndex = 0;
                }
            })
            .catch(error => {
                alert('åŠ å…¥è‡ªé€‰è‚¡å¤±è´¥: ' + error.message);
                // é‡ç½®é€‰æ‹©å™¨
                document.getElementById('addToWatchlistSelect').selectedIndex = 0;
            });
        }
        
        // é¡µé¢åŠ è½½æ—¶è·å–è‚¡ç¥¨æ•°æ®
        loadStockData();
    </script>
</body>
</html>