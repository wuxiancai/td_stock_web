<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è‚¡ç¥¨è¯¦æƒ… - æ¯æ—¥æŒ‡æ ‡</title>
    <script src="https://cdn.plot.ly/plotly-2.35.2.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', sans-serif;
            background-color: #f8f9fa;
            color: #333;
            line-height: 1.4;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .stock-header {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .stock-info {
            display: flex;
            align-items: center;
            gap: 20px;
            flex: 1;
        }

        .stock-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 10px;
        }

        .stock-actions-left {
            display: flex;
            gap: 10px;
        }

        .stock-actions-right {
            display: flex;
            gap: 10px;
        }

        .action-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 6px;
            min-width: 120px;
            justify-content: center;
        }

        .action-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .action-btn:active {
            transform: translateY(0);
        }

        .btn-added {
            background: #28a745;
            color: white;
        }

        .btn-added:hover {
            background: #218838;
        }

        .btn-add {
            background: #007bff;
            color: white;
        }

        .btn-add:hover {
            background: #0056b3;
        }

        .btn-remove {
            background: #dc3545;
            color: white;
        }

        .btn-remove:hover {
            background: #c82333;
        }

        .btn-refresh {
            background: #28a745;
            color: white;
        }

        .btn-refresh:hover {
            background: #218838;
        }

        .btn-refresh:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
        }

        .stock-name {
            font-size: 18px;
            font-weight: 600;
            color: #333;
        }

        .stock-code {
            font-size: 14px;
            color: #666;
        }

        .stock-price {
            font-size: 32px;
            font-weight: 700;
            color: #e74c3c;
        }

        .price-change {
            display: flex;
            gap: 10px;
            align-items: center;
            font-size: 14px;
        }

        .change-amount {
            color: #e74c3c;
        }

        .change-percent {
            color: #e74c3c;
        }

        .indicators-section {
            background: white;
            border-radius: 8px;
            padding: 0;
            margin-bottom: 10px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .indicators-header {
            background: #f8f9fa;
            padding: 15px 20px;
            border-bottom: 1px solid #e9ecef;
            font-weight: 600;
            color: #495057;
        }

        .indicators-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            border-bottom: 1px solid #e9ecef;
        }

        .indicator-item {
            padding: 8px 10px;
            text-align: center;
            border-right: 1px solid #e9ecef;
            transition: background-color 0.2s ease;
        }

        .indicator-item:last-child {
            border-right: none;
        }

        .indicator-item:hover {
            background-color: #f8f9fa;
        }

        .indicator-label {
            font-size: 12px;
            color: #6c757d;
            margin-bottom: 5px;
            line-height: 1.2;
        }

        .indicator-value {
            font-size: 14px;
            font-weight: 600;
            color: #212529;
            line-height: 1.2;
        }

        .positive {
            color: #28a745;
        }

        .negative {
            color: #dc3545;
        }

        .neutral {
            color: #6c757d;
        }

        /* å®æ—¶äº¤æ˜“æ•°æ®æ ·å¼ */
        .realtime-section {
            background: white;
            border-radius: 8px;
            padding: 0;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
            overflow: hidden;
        }

        .realtime-header {
            background: #f8f9fa;
            padding: 15px 20px;
            border-bottom: 1px solid #e9ecef;
            font-weight: 600;
            color: #495057;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .realtime-refresh-btn {
            padding: 6px 12px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s ease;
        }

        .realtime-refresh-btn:hover {
            background: #0056b3;
        }

        .realtime-refresh-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }

        .realtime-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 0;
            border-bottom: 1px solid #e9ecef;
        }

        .realtime-item {
            padding: 12px 10px;
            text-align: center;
            border-right: 1px solid #e9ecef;
            transition: background-color 0.2s ease;
        }

        .realtime-item:last-child {
            border-right: none;
        }

        .realtime-item:hover {
            background-color: #f8f9fa;
        }

        .realtime-label {
            font-size: 11px;
            color: #6c757d;
            margin-bottom: 4px;
            line-height: 1.2;
        }

        .realtime-value {
            font-size: 13px;
            font-weight: 600;
            color: #212529;
            line-height: 1.2;
        }

        .realtime-loading {
            text-align: center;
            padding: 20px;
            color: #666;
            font-size: 14px;
        }

        .realtime-error {
            background: #f8d7da;
            color: #721c24;
            padding: 15px 20px;
            border: 1px solid #f5c6cb;
            margin: 0;
            font-size: 14px;
        }

        /* èµ„é‡‘æµå‘æ•°æ®æ ·å¼ - ä¼˜åŒ–ç´§å‡‘ç‰ˆ */
        .moneyflow-section {
            background: white;
            border-radius: 6px;
            padding: 0;
            box-shadow: 0 1px 4px rgba(0, 0, 0, 0.08);
            margin-bottom: 15px;
            overflow: hidden;
        }

        .moneyflow-header {
            background: #f8f9fa;
            padding: 10px 15px;
            border-bottom: 1px solid #e9ecef;
            font-weight: 600;
            color: #495057;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 14px;
        }

        .moneyflow-refresh-btn {
            padding: 4px 8px;
            background: #28a745;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 11px;
            transition: all 0.2s ease;
        }

        .moneyflow-refresh-btn:hover {
            background: #218838;
        }

        .moneyflow-refresh-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }

        .moneyflow-loading {
            text-align: center;
            padding: 15px;
            color: #666;
            font-size: 13px;
        }

        .moneyflow-error {
            background: #f8d7da;
            color: #721c24;
            padding: 10px 15px;
            border: 1px solid #f5c6cb;
            margin: 0;
            font-size: 13px;
        }

        .moneyflow-grid {
            padding: 12px;
        }

        .moneyflow-summary {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-bottom: 15px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 4px;
            border: 1px solid #e9ecef;
        }

        .moneyflow-summary-item {
            text-align: center;
        }

        .moneyflow-summary-label {
            font-size: 11px;
            color: #6c757d;
            margin-bottom: 4px;
            font-weight: 500;
        }

        .moneyflow-summary-value {
            font-size: 15px;
            font-weight: 700;
            color: #212529;
        }

        .moneyflow-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
        }

        .moneyflow-category {
            border: 1px solid #e9ecef;
            border-radius: 4px;
            overflow: hidden;
        }

        .moneyflow-category-title {
            background: #f8f9fa;
            padding: 8px 10px;
            font-weight: 600;
            color: #495057;
            font-size: 12px;
            border-bottom: 1px solid #e9ecef;
        }

        .moneyflow-category-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0;
        }

        .moneyflow-item {
            padding: 8px 6px;
            text-align: center;
            border-right: 1px solid #e9ecef;
            border-bottom: 1px solid #e9ecef;
            transition: background-color 0.2s ease;
        }

        .moneyflow-item:nth-child(2n) {
            border-right: none;
        }

        .moneyflow-item:nth-last-child(-n+2) {
            border-bottom: none;
        }

        .moneyflow-item:hover {
            background-color: #f8f9fa;
        }

        .moneyflow-label {
            font-size: 10px;
            color: #6c757d;
            margin-bottom: 3px;
            line-height: 1.1;
        }

        .moneyflow-value {
            font-size: 11px;
            font-weight: 600;
            color: #212529;
            line-height: 1.1;
        }

        /* æŠ€æœ¯æŒ‡æ ‡å›¾è¡¨æ ·å¼ */
        .indicators-charts-section {
            background: white;
            border-radius: 8px;
            padding: 0;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .indicators-charts-header {
            background: #f8f9fa;
            padding: 15px 20px;
            border-bottom: 1px solid #e9ecef;
            font-weight: 600;
            color: #495057;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .indicators-controls {
            display: flex;
            gap: 10px;
        }

        .indicator-btn {
            padding: 6px 12px;
            background: #fff;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s ease;
        }

        .indicator-btn:hover {
            background: #e9ecef;
        }

        .indicator-btn.active {
            background: #007bff;
            color: white;
            border-color: #007bff;
        }

        .indicators-charts-container {
            padding: 20px;
        }

        .indicator-chart {
            width: 100%;
        }

        .indicator-section {
            width: 100%;
            box-sizing: border-box;
        }

        /* ç¡®ä¿æ‰€æœ‰å›¾è¡¨å®¹å™¨å®½åº¦ä¸€è‡´ */
        #candlestickChart, #volumeChart, #macdChart, #kdjChart, #rsiChart {
            width: 100% !important;
            box-sizing: border-box;
        }

        /* èœ¡çƒ›å›¾æ ·å¼ */
        .chart-section {
            background: white;
            border-radius: 8px;
            padding: 0;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .chart-header {
            background: #f8f9fa;
            padding: 15px 20px;
            border-bottom: 1px solid #e9ecef;
            font-weight: 600;
            color: #495057;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chart-controls {
            display: flex;
            gap: 10px;
        }

        .chart-btn {
            padding: 6px 12px;
            background: #fff;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s ease;
        }

        .chart-btn:hover {
            background: #e9ecef;
        }

        .chart-btn.active {
            background: #007bff;
            color: white;
            border-color: #007bff;
        }

        .chart-container {
            padding: 20px;
        }

        .chart-loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 4px;
            margin: 20px;
            border: 1px solid #f5c6cb;
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .indicators-grid {
                grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            }
            
            .indicator-item {
                padding: 10px 5px;
            }
            
            .indicator-label {
                font-size: 11px;
            }
            
            .indicator-value {
                font-size: 13px;
            }
            
            .stock-price {
                font-size: 24px;
            }

            .chart-header {
                flex-direction: column;
                gap: 10px;
                align-items: flex-start;
            }

            .chart-controls {
                width: 100%;
                justify-content: center;
            }
        }

        @media (max-width: 480px) {
            .indicators-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div id="loadingDiv" class="loading" style="display: block;">
            <p>æ­£åœ¨åŠ è½½æ¯æ—¥æŒ‡æ ‡æ•°æ®...</p>
        </div>

        <div id="errorDiv" class="error" style="display: none;"></div>

        <div id="contentDiv" style="display: none;">
            <div class="stock-header">
                <div class="stock-info">
                    <div>
                        <span id="stockName" class="stock-name">ä¸œåæµ‹è¯•</span>
                        <span id="stockCode" class="stock-code">300354.SZ</span>
                    </div>
                    <div>
                        <span id="stockPrice" class="stock-price">Â¥40.31</span>
                    </div>
                    <div class="price-change">
                        <span id="changeAmount" class="change-amount">+52.00</span>
                        <span>(<span id="changePercent" class="change-percent">+33.30</span>)</span>
                    </div>
                </div>
                
                <!-- æ“ä½œæŒ‰é’®åŒºåŸŸ -->
                <div class="stock-actions">
                    <div class="stock-actions-left">
                        <!-- å·¦ä¾§ç•™ç©º -->
                    </div>
                    <div class="stock-actions-right">
                        <select id="watchlistSelect" onchange="addToWatchlistWithPriority(this.value)" style="
                            background: linear-gradient(45deg, #ffc107, #fd7e14);
                            color: #333;
                            border: none;
                            padding: 8px 15px;
                            border-radius: 20px;
                            cursor: pointer;
                            font-size: 14px;
                            font-weight: bold;
                            transition: all 0.3s ease;
                            appearance: none;
                            -webkit-appearance: none;
                            -moz-appearance: none;
                            min-width: 120px;
                            margin-right: 10px;
                        ">
                            <option value="" disabled selected>â­ åŠ å…¥è‡ªé€‰</option>
                            <option value="purple">ğŸŸ£ ç«‹å³ä¹°å…¥</option>
                            <option value="red">ğŸ”´ é‡ç‚¹å…³æ³¨</option>
                            <option value="green">ğŸŸ¢ è§‚å¯Ÿä¸­</option>
                            <option value="holding">ğŸŸ  æŒä»“ä¸­</option>
                            <option value="sold">âš« å·²å–å‡º</option>
                        </select>
                        <button id="refreshDataBtn" class="action-btn btn-refresh" onclick="refreshAllData()">
                            <span>ğŸ”„</span>
                            <span>åˆ·æ–°æ•°æ®</span>
                        </button>
                        <button id="removeFromWatchlistBtn" class="action-btn btn-remove" onclick="removeFromWatchlist()">
                            <span>ğŸ—‘ï¸</span>
                            <span>åˆ é™¤è‡ªé€‰</span>
                        </button>
                    </div>
                </div>
            </div>

            <div class="indicators-section">
                <div class="indicators-grid">
                    <!-- åŸºç¡€ä»·æ ¼æŒ‡æ ‡ -->
                    <div class="indicator-item">
                        <div class="indicator-label">å½“æ—¥æ”¶ç›˜ä»·</div>
                        <div id="close" class="indicator-value">--</div>
                    </div>
                    <div class="indicator-item">
                        <div class="indicator-label">å½“å¤©å¼€ç›˜</div>
                        <div id="open" class="indicator-value">Â¥41.01</div>
                    </div>
                    <div class="indicator-item">
                        <div class="indicator-label">å½“å¤©æ¶¨å¹…</div>
                        <div id="pctChg" class="indicator-value negative">-0.03%</div>
                    </div>
                    
                    <!-- æˆäº¤é‡ç›¸å…³æŒ‡æ ‡ -->
                    <div class="indicator-item">
                        <div class="indicator-label">æˆäº¤é¢</div>
                        <div id="amount" class="indicator-value">2.53äº¿</div>
                    </div>
                    <div class="indicator-item">
                        <div class="indicator-label">æ¢æ‰‹ç‡</div>
                        <div id="turnoverRate" class="indicator-value">7.71%</div>
                    </div>
                    <div class="indicator-item">
                        <div class="indicator-label">æ¢æ‰‹ç‡(è‡ªç”±æµé€š)</div>
                        <div id="turnoverRateF" class="indicator-value">--</div>
                    </div>
                    <div class="indicator-item">
                        <div class="indicator-label">é‡æ¯”</div>
                        <div id="volumeRatio" class="indicator-value">0.85</div>
                    </div>
                    
                    <!-- ä¼°å€¼æŒ‡æ ‡ -->
                    <div class="indicator-item">
                        <div class="indicator-label">å¸‚ç›ˆç‡(PE)</div>
                        <div id="pe" class="indicator-value">--</div>
                    </div>
                    <div class="indicator-item">
                        <div class="indicator-label">å¸‚ç›ˆç‡(TTM)</div>
                        <div id="peTtm" class="indicator-value">45.17</div>
                    </div>
                    <div class="indicator-item">
                        <div class="indicator-label">å¸‚å‡€ç‡(PB)</div>
                        <div id="pb" class="indicator-value">7.36</div>
                    </div>
                    <div class="indicator-item">
                        <div class="indicator-label">å¸‚é”€ç‡(PS)</div>
                        <div id="ps" class="indicator-value">--</div>
                    </div>
                    <div class="indicator-item">
                        <div class="indicator-label">å¸‚é”€ç‡(TTM)</div>
                        <div id="psTtm" class="indicator-value">--</div>
                    </div>
                    
                    <!-- è‚¡æ¯æŒ‡æ ‡ -->
                    <div class="indicator-item">
                        <div class="indicator-label">è‚¡æ¯ç‡(%)</div>
                        <div id="dvRatio" class="indicator-value">--</div>
                    </div>
                    <div class="indicator-item">
                        <div class="indicator-label">è‚¡æ¯ç‡(TTM)(%)</div>
                        <div id="dvTtm" class="indicator-value">--</div>
                    </div>
                    
                    <!-- è‚¡æœ¬æŒ‡æ ‡ -->
                    <div class="indicator-item">
                        <div class="indicator-label">æ€»è‚¡æœ¬(ä¸‡è‚¡)</div>
                        <div id="totalShare" class="indicator-value">--</div>
                    </div>
                    <div class="indicator-item">
                        <div class="indicator-label">æµé€šè‚¡æœ¬(ä¸‡è‚¡)</div>
                        <div id="floatShare" class="indicator-value">--</div>
                    </div>
                    <div class="indicator-item">
                        <div class="indicator-label">è‡ªç”±æµé€šè‚¡æœ¬(ä¸‡è‚¡)</div>
                        <div id="freeShare" class="indicator-value">--</div>
                    </div>
                    
                    <!-- å¸‚å€¼æŒ‡æ ‡ -->
                    <div class="indicator-item">
                        <div class="indicator-label">æ€»å¸‚å€¼</div>
                        <div id="totalMv" class="indicator-value">55.76äº¿</div>
                    </div>
                    <div class="indicator-item">
                        <div class="indicator-label">æµé€šå¸‚å€¼</div>
                        <div id="circMv" class="indicator-value">--</div>
                    </div>
                    
                    <!-- å…¶ä»–æŒ‡æ ‡ -->
                    <div class="indicator-item">
                        <div class="indicator-label">å‡€æµå…¥é¢</div>
                        <div id="netInflow" class="indicator-value negative">-5310.00ä¸‡</div>
                    </div>
                    <div class="indicator-item">
                        <div class="indicator-label">æ‰€å±è¡Œä¸š</div>
                        <div id="industry" class="indicator-value">ç”µå™¨ä»ªè¡¨</div>
                    </div>
                </div>
            </div>

            <!-- èµ„é‡‘æµå‘æ•°æ®éƒ¨åˆ† -->
            <div class="moneyflow-section">
                <div class="moneyflow-header">
                    <span>èµ„é‡‘æµå‘</span>
                    <div style="display: flex; align-items: center; gap: 15px;">
                        <span id="moneyflowTimestamp" style="font-size: 12px; color: #6c757d;">--</span>
                        <button id="moneyflowRefreshBtn" class="moneyflow-refresh-btn" onclick="refreshMoneyflowData()">åˆ·æ–°</button>
                    </div>
                </div>
                <div id="moneyflowContent">
                    <div id="moneyflowLoading" class="moneyflow-loading" style="display: block;">
                        æ­£åœ¨åŠ è½½èµ„é‡‘æµå‘æ•°æ®...
                    </div>
                    <div id="moneyflowError" class="moneyflow-error" style="display: none;"></div>
                    <div id="moneyflowGrid" class="moneyflow-grid" style="display: none;">
                        <!-- å‡€æµå…¥æ±‡æ€» -->
                        <div class="moneyflow-summary">
                            <div class="moneyflow-summary-item">
                                <div class="moneyflow-summary-label">å‡€æµå…¥é‡</div>
                                <div id="mf_net_vol" class="moneyflow-summary-value">--</div>
                            </div>
                            <div class="moneyflow-summary-item">
                                <div class="moneyflow-summary-label">å‡€æµå…¥é¢</div>
                                <div id="mf_net_amount" class="moneyflow-summary-value">--</div>
                            </div>
                        </div>
                        
                        <!-- è¯¦ç»†èµ„é‡‘æµå‘ -->
                        <div class="moneyflow-details">
                            <!-- å°å• -->
                            <div class="moneyflow-category">
                                <div class="moneyflow-category-title">å°å•ï¼ˆ<5ä¸‡ï¼‰</div>
                                <div class="moneyflow-category-grid">
                                    <div class="moneyflow-item">
                                        <div class="moneyflow-label">ä¹°å…¥é‡</div>
                                        <div id="mf_buy_sm_vol" class="moneyflow-value">--</div>
                                    </div>
                                    <div class="moneyflow-item">
                                        <div class="moneyflow-label">ä¹°å…¥é¢</div>
                                        <div id="mf_buy_sm_amount" class="moneyflow-value">--</div>
                                    </div>
                                    <div class="moneyflow-item">
                                        <div class="moneyflow-label">å–å‡ºé‡</div>
                                        <div id="mf_sell_sm_vol" class="moneyflow-value">--</div>
                                    </div>
                                    <div class="moneyflow-item">
                                        <div class="moneyflow-label">å–å‡ºé¢</div>
                                        <div id="mf_sell_sm_amount" class="moneyflow-value">--</div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- ä¸­å• -->
                            <div class="moneyflow-category">
                                <div class="moneyflow-category-title">ä¸­å•ï¼ˆ5-20ä¸‡ï¼‰</div>
                                <div class="moneyflow-category-grid">
                                    <div class="moneyflow-item">
                                        <div class="moneyflow-label">ä¹°å…¥é‡</div>
                                        <div id="mf_buy_md_vol" class="moneyflow-value">--</div>
                                    </div>
                                    <div class="moneyflow-item">
                                        <div class="moneyflow-label">ä¹°å…¥é¢</div>
                                        <div id="mf_buy_md_amount" class="moneyflow-value">--</div>
                                    </div>
                                    <div class="moneyflow-item">
                                        <div class="moneyflow-label">å–å‡ºé‡</div>
                                        <div id="mf_sell_md_vol" class="moneyflow-value">--</div>
                                    </div>
                                    <div class="moneyflow-item">
                                        <div class="moneyflow-label">å–å‡ºé¢</div>
                                        <div id="mf_sell_md_amount" class="moneyflow-value">--</div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- å¤§å• -->
                            <div class="moneyflow-category">
                                <div class="moneyflow-category-title">å¤§å•ï¼ˆ20-100ä¸‡ï¼‰</div>
                                <div class="moneyflow-category-grid">
                                    <div class="moneyflow-item">
                                        <div class="moneyflow-label">ä¹°å…¥é‡</div>
                                        <div id="mf_buy_lg_vol" class="moneyflow-value">--</div>
                                    </div>
                                    <div class="moneyflow-item">
                                        <div class="moneyflow-label">ä¹°å…¥é¢</div>
                                        <div id="mf_buy_lg_amount" class="moneyflow-value">--</div>
                                    </div>
                                    <div class="moneyflow-item">
                                        <div class="moneyflow-label">å–å‡ºé‡</div>
                                        <div id="mf_sell_lg_vol" class="moneyflow-value">--</div>
                                    </div>
                                    <div class="moneyflow-item">
                                        <div class="moneyflow-label">å–å‡ºé¢</div>
                                        <div id="mf_sell_lg_amount" class="moneyflow-value">--</div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- ç‰¹å¤§å• -->
                            <div class="moneyflow-category">
                                <div class="moneyflow-category-title">ç‰¹å¤§å•ï¼ˆ>100ä¸‡ï¼‰</div>
                                <div class="moneyflow-category-grid">
                                    <div class="moneyflow-item">
                                        <div class="moneyflow-label">ä¹°å…¥é‡</div>
                                        <div id="mf_buy_elg_vol" class="moneyflow-value">--</div>
                                    </div>
                                    <div class="moneyflow-item">
                                        <div class="moneyflow-label">ä¹°å…¥é¢</div>
                                        <div id="mf_buy_elg_amount" class="moneyflow-value">--</div>
                                    </div>
                                    <div class="moneyflow-item">
                                        <div class="moneyflow-label">å–å‡ºé‡</div>
                                        <div id="mf_sell_elg_vol" class="moneyflow-value">--</div>
                                    </div>
                                    <div class="moneyflow-item">
                                        <div class="moneyflow-label">å–å‡ºé¢</div>
                                        <div id="mf_sell_elg_amount" class="moneyflow-value">--</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- å®æ—¶äº¤æ˜“æ•°æ®éƒ¨åˆ† -->
            <div class="realtime-section">
                <div class="realtime-header">
                    <span>å®æ—¶äº¤æ˜“æ•°æ®</span>
                    <div style="display: flex; align-items: center; gap: 15px;">
                        <span id="lastRefreshTime" style="font-size: 12px; color: #6c757d;">--</span>
                        <span id="realtimeTimestamp" style="font-size: 12px; color: #6c757d;">--</span>
                        <button id="autoRefreshToggle" class="realtime-refresh-btn" onclick="toggleAutoRefresh()" style="background: #dc3545;">åœæ­¢è‡ªåŠ¨åˆ·æ–°</button>
                        <button id="realtimeRefreshBtn" class="realtime-refresh-btn" onclick="refreshRealtimeData()">æ‰‹åŠ¨åˆ·æ–°</button>
                    </div>
                </div>
                <div id="realtimeContent">
                    <div id="realtimeLoading" class="realtime-loading" style="display: block;">
                        æ­£åœ¨åŠ è½½å®æ—¶äº¤æ˜“æ•°æ®...
                    </div>
                    <div id="realtimeError" class="realtime-error" style="display: none;"></div>
                    <div id="realtimeGrid" class="realtime-grid" style="display: none;">
                        <!-- ç¬¬ä¸€è¡Œ -->
                        <div class="realtime-item">
                            <div class="realtime-label">æœ€æ–°ä»·</div>
                            <div id="rt_æœ€æ–°ä»·" class="realtime-value">--</div>
                        </div>
                        <div class="realtime-item">
                            <div class="realtime-label">æ¶¨è·Œå¹…</div>
                            <div id="rt_æ¶¨è·Œå¹…" class="realtime-value">--</div>
                        </div>
                        <div class="realtime-item">
                            <div class="realtime-label">æ¶¨è·Œé¢</div>
                            <div id="rt_æ¶¨è·Œé¢" class="realtime-value">--</div>
                        </div>
                        <div class="realtime-item">
                            <div class="realtime-label">é‡æ¯”</div>
                            <div id="rt_é‡æ¯”" class="realtime-value">--</div>
                        </div>
                        <div class="realtime-item">
                            <div class="realtime-label">æ¢æ‰‹ç‡</div>
                            <div id="rt_æ¢æ‰‹ç‡" class="realtime-value">--</div>
                        </div>
                        <div class="realtime-item">
                            <div class="realtime-label">æˆäº¤é‡</div>
                            <div id="rt_æˆäº¤é‡" class="realtime-value">--</div>
                        </div>
                        <!-- ç¬¬äºŒè¡Œ -->
                        <div class="realtime-item">
                            <div class="realtime-label">æˆäº¤é¢</div>
                            <div id="rt_æˆäº¤é¢" class="realtime-value">--</div>
                        </div>
                        <div class="realtime-item">
                            <div class="realtime-label">æŒ¯å¹…</div>
                            <div id="rt_æŒ¯å¹…" class="realtime-value">--</div>
                        </div>
                        <div class="realtime-item">
                            <div class="realtime-label">æœ€é«˜</div>
                            <div id="rt_æœ€é«˜" class="realtime-value">--</div>
                        </div>
                        <div class="realtime-item">
                            <div class="realtime-label">æœ€ä½</div>
                            <div id="rt_æœ€ä½" class="realtime-value">--</div>
                        </div>
                        <div class="realtime-item">
                            <div class="realtime-label">ä»Šå¼€</div>
                            <div id="rt_ä»Šå¼€" class="realtime-value">--</div>
                        </div>
                        <div class="realtime-item">
                            <div class="realtime-label">æ˜¨æ”¶</div>
                            <div id="rt_æ˜¨æ”¶" class="realtime-value">--</div>
                        </div>
                        <!-- ç¬¬ä¸‰è¡Œ -->
                        <div class="realtime-item">
                            <div class="realtime-label">å¸‚ç›ˆç‡-åŠ¨æ€</div>
                            <div id="rt_å¸‚ç›ˆç‡_åŠ¨æ€" class="realtime-value">--</div>
                        </div>
                        <div class="realtime-item">
                            <div class="realtime-label">å¸‚å‡€ç‡</div>
                            <div id="rt_å¸‚å‡€ç‡" class="realtime-value">--</div>
                        </div>
                        <div class="realtime-item">
                            <div class="realtime-label">æ€»å¸‚å€¼</div>
                            <div id="rt_æ€»å¸‚å€¼" class="realtime-value">--</div>
                        </div>
                        <div class="realtime-item">
                            <div class="realtime-label">æµé€šå¸‚å€¼</div>
                            <div id="rt_æµé€šå¸‚å€¼" class="realtime-value">--</div>
                        </div>
                        <div class="realtime-item">
                            <div class="realtime-label">æ¶¨é€Ÿ</div>
                            <div id="rt_æ¶¨é€Ÿ" class="realtime-value">--</div>
                        </div>
                        <div class="realtime-item">
                            <div class="realtime-label">5åˆ†é’Ÿæ¶¨è·Œ</div>
                            <div id="rt_5åˆ†é’Ÿæ¶¨è·Œ" class="realtime-value">--</div>
                        </div>
                        <!-- ç¬¬å››è¡Œ -->
                        <div class="realtime-item">
                            <div class="realtime-label">60æ—¥æ¶¨è·Œå¹…</div>
                            <div id="rt_60æ—¥æ¶¨è·Œå¹…" class="realtime-value">--</div>
                        </div>
                        <div class="realtime-item">
                            <div class="realtime-label">å¹´åˆè‡³ä»Šæ¶¨è·Œå¹…</div>
                            <div id="rt_å¹´åˆè‡³ä»Šæ¶¨è·Œå¹…" class="realtime-value">--</div>
                        </div>
                        <div class="realtime-item">
                            <div class="realtime-label">è¿æ¶¨å¤©æ•°</div>
                            <div id="rt_è¿æ¶¨å¤©æ•°" class="realtime-value">--</div>
                        </div>
                        <div class="realtime-item">
                            <div class="realtime-label">é‡ä»·é½å‡å¤©æ•°</div>
                            <div id="rt_é‡ä»·é½å‡å¤©æ•°" class="realtime-value">--</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- åˆ†æ—¶å›¾éƒ¨åˆ† -->
            <div class="realtime-section">
                <div class="realtime-header">
                    <span>åˆ†æ—¶å›¾</span>
                    <div style="display: flex; align-items: center; gap: 15px;">
                        <span id="lastChartRefreshTime" style="font-size: 12px; color: #6c757d;">--</span>
                        <span id="intradayTimestamp" style="font-size: 12px; color: #6c757d;">--</span>
                        <button id="chartAutoRefreshToggle" class="realtime-refresh-btn" onclick="toggleAutoRefresh()" style="background: #dc3545;">åœæ­¢è‡ªåŠ¨åˆ·æ–°</button>
                        <button id="intradayRefreshBtn" class="realtime-refresh-btn" onclick="refreshIntradayChart()">æ‰‹åŠ¨åˆ·æ–°</button>
                    </div>
                </div>
                <div id="intradayContent">
                    <div id="intradayLoading" class="realtime-loading" style="display: block;">
                        æ­£åœ¨åŠ è½½åˆ†æ—¶æ•°æ®...
                    </div>
                    <div id="intradayError" class="realtime-error" style="display: none;"></div>
                    <div id="intradayChartContainer" style="display: none;">
                        <!-- åˆ†æ—¶å›¾ -->
                        <div id="intradayChart" style="width: 100%; height: 400px; padding: 10px;"></div>
                        <!-- åˆ†æ—¶æˆäº¤é‡å›¾ -->
                        <div id="intradayVolumeChart" style="width: 100%; height: 150px; padding: 10px;"></div>
                    </div>
                </div>
            </div>

            <!-- Kçº¿å›¾å’ŒæŠ€æœ¯æŒ‡æ ‡ç»„åˆéƒ¨åˆ† -->
            <div class="chart-section">
                <div class="chart-header">
                    <span>Kçº¿å›¾ä¸æŠ€æœ¯æŒ‡æ ‡</span>
                    <div class="chart-controls">
                        <button class="chart-btn" onclick="setDisplayRange(50, event)">50æ ¹</button>
                        <button class="chart-btn active" onclick="setDisplayRange(100, event)">100æ ¹</button>
                        <button class="chart-btn" onclick="setDisplayRange(200, event)">200æ ¹</button>
                        <button class="chart-btn" onclick="setDisplayRange(-1, event)">å…¨éƒ¨</button>
                        <div style="margin-left: 20px; display: flex; align-items: center; gap: 10px;">
                            <label style="display: flex; align-items: center; gap: 5px; font-size: 12px; color: #495057;">
                                <input type="checkbox" id="showBOLL" checked onchange="toggleBOLL()">
                                BOLLæŒ‡æ ‡
                            </label>
                        </div>
                    </div>
                </div>
                <div class="chart-container">
                    <div id="chartLoading" class="chart-loading" style="display: none;">
                        æ­£åœ¨åŠ è½½Kçº¿æ•°æ®...
                    </div>
                    <!-- Kçº¿å›¾ -->
                    <div id="candlestickChart" style="width: 100%; height: 400px;"></div>
                    <!-- æˆäº¤é‡å›¾ -->
                    <div id="volumeChart" style="width: 100%; height: 150px; margin-top: 2px;"></div>
                    
                    <!-- MACDæŒ‡æ ‡ -->
                    <div id="macdChart" style="width: 100%; height: 150px; margin-top: 5px;"></div>
                    
                    <!-- KDJæŒ‡æ ‡ -->
                    <div id="kdjChart" style="width: 100%; height: 150px; margin-top: 5px;"></div>
                    
                    <!-- RSIæŒ‡æ ‡ -->
                    <div id="rsiChart" style="width: 100%; height: 150px; margin-top: 5px;"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // å…¨å±€å˜é‡
        let allChartData = [];
        let nineTurnData = []; // æ·»åŠ ç¥å¥‡ä¹è½¬æ•°æ®
        let currentDisplayRange = 100;
        let currentStockCode = '';

        // ä»URLå‚æ•°è·å–è‚¡ç¥¨ä»£ç 
        function getStockCodeFromUrl() {
            // ä»URLè·¯å¾„è·å–è‚¡ç¥¨ä»£ç  (ä¾‹å¦‚: /stock/300354)
            const pathParts = window.location.pathname.split('/');
            if (pathParts.length >= 3 && pathParts[1] === 'stock') {
                return pathParts[2];
            }
            
            // å¦‚æœè·¯å¾„ä¸­æ²¡æœ‰ï¼Œåˆ™ä»URLå‚æ•°è·å–
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('code') || '300354';
        }

        // æ ¼å¼åŒ–æ•°å€¼
        function formatValue(value, type = 'number') {
            if (value === null || value === undefined || value === '') {
                return '--';
            }
            
            const num = parseFloat(value);
            if (isNaN(num)) return value;
            
            switch (type) {
                case 'currency':
                    return `Â¥${num.toFixed(2)}`;
                case 'percentage':
                    return `${num.toFixed(2)}%`;
                case 'large_number':
                    if (num >= 100000000) {
                        return `${(num / 100000000).toFixed(2)}äº¿`;
                    } else if (num >= 10000) {
                        return `${(num / 10000).toFixed(2)}ä¸‡`;
                    }
                    return num.toFixed(2);
                case 'ratio':
                    return num.toFixed(2);
                default:
                    return num.toFixed(2);
            }
        }

        // æ ¼å¼åŒ–æˆäº¤é¢
        function formatAmount(value) {
            if (value === null || value === undefined || value === '') {
                return '--';
            }
            
            const num = parseFloat(value);
            if (isNaN(num)) return value;
            
            // Tushareè¿”å›çš„amountå•ä½æ˜¯åƒå…ƒï¼Œéœ€è¦å…ˆè½¬æ¢ä¸ºä¸‡å…ƒ
            const amountInWan = num / 10;
            
            // æˆäº¤é¢å•ä½è½¬æ¢ï¼šä¸‡å…ƒ -> äº¿å…ƒ
            if (amountInWan >= 10000) {
                return `${(amountInWan / 10000).toFixed(2)}äº¿`;
            } else {
                return `${amountInWan.toFixed(2)}ä¸‡`;
            }
        }

        // æ ¼å¼åŒ–å›¾è¡¨æ—¥æœŸï¼ˆåªæ˜¾ç¤ºæœˆæ—¥ï¼‰
        function formatChartDate(dateStr) {
            if (!dateStr) return '';
            const month = dateStr.substring(4, 6);
            const day = dateStr.substring(6, 8);
            return `${month}-${day}`;
        }

        // æ ¼å¼åŒ–æ—¥æœŸ
        function formatDate(dateStr) {
            if (!dateStr) return '';
            const year = dateStr.substring(0, 4);
            const month = dateStr.substring(4, 6);
            const day = dateStr.substring(6, 8);
            return `${year}å¹´${month}æœˆ${day}æ—¥`;
        }

        // è®¾ç½®æ•°å€¼é¢œè‰²
        function setValueColor(element, value) {
            const num = parseFloat(value);
            if (isNaN(num)) return;
            
            element.classList.remove('positive', 'negative', 'neutral');
            if (num > 0) {
                element.classList.add('positive');
            } else if (num < 0) {
                element.classList.add('negative');
            } else {
                element.classList.add('neutral');
            }
        }

        // åŠ è½½è‚¡ç¥¨æ•°æ®
        async function loadStockData() {
            currentStockCode = getStockCodeFromUrl();
            
            try {
                // è·å–æ¯æ—¥æŒ‡æ ‡æ•°æ®
                const dailyBasicResponse = await fetch(`/api/stock/${currentStockCode}/daily_basic`);
                const dailyBasicResult = await dailyBasicResponse.json();
                
                if (!dailyBasicResult.success) {
                    throw new Error(dailyBasicResult.error || 'è·å–æ¯æ—¥æŒ‡æ ‡æ•°æ®å¤±è´¥');
                }

                // è·å–å®æ—¶æ•°æ®
                const realtimeResponse = await fetch(`/api/stock/${currentStockCode}/realtime`);
                const realtimeResult = await realtimeResponse.json();
                
                displayStockData(dailyBasicResult, realtimeResult);
                
                // åŠ è½½èµ„é‡‘æµå‘æ•°æ®
                await loadMoneyflowData();
                
                // åŠ è½½å®æ—¶äº¤æ˜“æ•°æ®
                await loadRealtimeData();
                
                // åŠ è½½åˆ†æ—¶å›¾æ•°æ®
                await loadIntradayChart();
                
                // åŠ è½½Kçº¿æ•°æ®
                await loadChartData();
                
            } catch (error) {
                showError('æ•°æ®åŠ è½½å¤±è´¥: ' + error.message);
            }
        }

        // åŠ è½½å®æ—¶äº¤æ˜“æ•°æ®
        async function loadRealtimeData(showLoading = true) {
            try {
                // åªåœ¨é¦–æ¬¡åŠ è½½æˆ–æ‰‹åŠ¨åˆ·æ–°æ—¶æ˜¾ç¤ºåŠ è½½çŠ¶æ€
                if (showLoading) {
                    showRealtimeLoading(true);
                }
                
                const response = await fetch(`/api/stock/realtime_trading_data`);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const result = await response.json();
                
                if (!result.success) {
                    // æ˜¾ç¤ºåç«¯è¿”å›çš„å…·ä½“é”™è¯¯ä¿¡æ¯
                    const errorMsg = result.error || 'è·å–å®æ—¶äº¤æ˜“æ•°æ®å¤±è´¥';
                    const detailMsg = result.details ? ` (${result.details})` : '';
                    throw new Error(errorMsg + detailMsg);
                }
                
                // æ£€æŸ¥æ˜¯å¦æ˜¯ç¼“å­˜æ•°æ®ï¼Œå¦‚æœæ˜¯ç¼“å­˜æ•°æ®ï¼Œå°è¯•ä½¿ç”¨ä¸ªè‚¡å®æ—¶æ•°æ®APIä½œä¸ºå¤‡ç”¨
                if (result.is_cached_data) {
                    console.log('æ£€æµ‹åˆ°ç¼“å­˜æ•°æ®ï¼Œå°è¯•ä½¿ç”¨ä¸ªè‚¡å®æ—¶æ•°æ®APIè·å–æœ€æ–°æ•°æ®...');
                    try {
                        await loadFallbackRealtimeData(result);
                        return;
                    } catch (fallbackError) {
                        console.warn('ä¸ªè‚¡å®æ—¶æ•°æ®APIä¹Ÿå¤±è´¥ï¼Œä½¿ç”¨ç¼“å­˜æ•°æ®:', fallbackError);
                        // ç»§ç»­ä½¿ç”¨ç¼“å­˜æ•°æ®
                    }
                }
                
                displayRealtimeData(result.data, result);
                
            } catch (error) {
                console.error('å®æ—¶äº¤æ˜“æ•°æ®åŠ è½½å¤±è´¥:', error);
                
                // å°è¯•ä½¿ç”¨ä¸ªè‚¡å®æ—¶æ•°æ®APIä½œä¸ºå¤‡ç”¨
                try {
                    console.log('å°è¯•ä½¿ç”¨ä¸ªè‚¡å®æ—¶æ•°æ®APIä½œä¸ºå¤‡ç”¨...');
                    await loadFallbackRealtimeData();
                    return;
                } catch (fallbackError) {
                    console.error('ä¸ªè‚¡å®æ—¶æ•°æ®APIä¹Ÿå¤±è´¥:', fallbackError);
                }
                
                // æ ¹æ®é”™è¯¯ç±»å‹æ˜¾ç¤ºä¸åŒçš„é”™è¯¯ä¿¡æ¯
                let errorMessage = 'å®æ—¶äº¤æ˜“æ•°æ®åŠ è½½å¤±è´¥';
                
                if (error.message.includes('ç½‘ç»œè¿æ¥')) {
                    errorMessage = 'ç½‘ç»œè¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥åé‡è¯•';
                } else if (error.message.includes('ä»£ç†è¿æ¥')) {
                    errorMessage = 'ä»£ç†è¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè®¾ç½®';
                } else if (error.message.includes('AkShare')) {
                    errorMessage = 'AkShareæœåŠ¡æš‚æ—¶ä¸å¯ç”¨ï¼Œè¯·ç¨åé‡è¯•';
                } else if (error.message.includes('APIè°ƒç”¨å¤±è´¥')) {
                    errorMessage = 'APIè°ƒç”¨å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•';
                } else if (error.message.includes('HTTP')) {
                    errorMessage = `æœåŠ¡å™¨é”™è¯¯: ${error.message}`;
                } else {
                    errorMessage = error.message || 'æœªçŸ¥é”™è¯¯ï¼Œè¯·ç¨åé‡è¯•';
                }
                
                // åªåœ¨æ˜¾ç¤ºåŠ è½½çŠ¶æ€æ—¶æ‰æ˜¾ç¤ºé”™è¯¯ï¼Œé¿å…è‡ªåŠ¨åˆ·æ–°æ—¶è¦†ç›–ç°æœ‰æ•°æ®
                if (showLoading) {
                    showRealtimeError(errorMessage);
                }
            } finally {
                if (showLoading) {
                    showRealtimeLoading(false);
                }
            }
        }

        // ä½¿ç”¨ä¸ªè‚¡å®æ—¶æ•°æ®APIä½œä¸ºå¤‡ç”¨æ•°æ®æº
        async function loadFallbackRealtimeData(originalResult = null) {
            const realtimeResponse = await fetch(`/api/stock/${currentStockCode}/realtime`);
            
            if (!realtimeResponse.ok) {
                throw new Error(`ä¸ªè‚¡å®æ—¶æ•°æ®API HTTP ${realtimeResponse.status}: ${realtimeResponse.statusText}`);
            }
            
            const realtimeResult = await realtimeResponse.json();
            
            if (!realtimeResult.success) {
                throw new Error(realtimeResult.error || 'è·å–ä¸ªè‚¡å®æ—¶æ•°æ®å¤±è´¥');
            }
            
            // å°†ä¸ªè‚¡å®æ—¶æ•°æ®è½¬æ¢ä¸ºå®æ—¶äº¤æ˜“æ•°æ®æ ¼å¼
            const spotData = realtimeResult.spot;
            if (!spotData) {
                throw new Error('ä¸ªè‚¡å®æ—¶æ•°æ®ä¸­ç¼ºå°‘spotæ•°æ®');
            }
            
            const convertedData = [{
                'åºå·': 1,
                'ä»£ç ': currentStockCode,
                'åç§°': spotData.name || '',
                'æœ€æ–°ä»·': spotData.latest_price || 0,
                'æ¶¨è·Œå¹…': spotData.change_percent || 0,
                'æ¶¨è·Œé¢': spotData.change_amount || 0,
                'æˆäº¤é‡': spotData.volume || 0,
                'æˆäº¤é¢': spotData.amount || 0,
                'æŒ¯å¹…': 0, // ä¸ªè‚¡APIä¸­æ²¡æœ‰è¿™ä¸ªå­—æ®µ
                'æœ€é«˜': spotData.high || 0,
                'æœ€ä½': spotData.low || 0,
                'ä»Šå¼€': spotData.open || 0,
                'æ˜¨æ”¶': spotData.pre_close || 0,
                'é‡æ¯”': spotData.volume_ratio || 0,
                'æ¢æ‰‹ç‡': spotData.turnover_rate || 0,
                'å¸‚ç›ˆç‡-åŠ¨æ€': spotData.pe_ratio || 0,
                'å¸‚å‡€ç‡': 0, // ä¸ªè‚¡APIä¸­æ²¡æœ‰è¿™ä¸ªå­—æ®µ
                'æ€»å¸‚å€¼': spotData.market_cap || 0,
                'æµé€šå¸‚å€¼': 0, // ä¸ªè‚¡APIä¸­æ²¡æœ‰è¿™ä¸ªå­—æ®µ
                'æ¶¨é€Ÿ': 0, // ä¸ªè‚¡APIä¸­æ²¡æœ‰è¿™ä¸ªå­—æ®µ
                '5åˆ†é’Ÿæ¶¨è·Œ': 0, // ä¸ªè‚¡APIä¸­æ²¡æœ‰è¿™ä¸ªå­—æ®µ
                '60æ—¥æ¶¨è·Œå¹…': 0, // ä¸ªè‚¡APIä¸­æ²¡æœ‰è¿™ä¸ªå­—æ®µ
                'å¹´åˆè‡³ä»Šæ¶¨è·Œå¹…': 0, // ä¸ªè‚¡APIä¸­æ²¡æœ‰è¿™ä¸ªå­—æ®µ
                'è¿æ¶¨å¤©æ•°': 0, // ä¸ªè‚¡APIä¸­æ²¡æœ‰è¿™ä¸ªå­—æ®µ
                'é‡ä»·é½å‡å¤©æ•°': 0 // ä¸ªè‚¡APIä¸­æ²¡æœ‰è¿™ä¸ªå­—æ®µ
            }];
            
            const fallbackResult = {
                success: true,
                data: convertedData,
                total_records: 1,
                fetch_time: new Date().toLocaleString('zh-CN'),
                data_source: 'ä¸ªè‚¡å®æ—¶æ•°æ®API (å¤‡ç”¨)',
                message: originalResult ? 'å…¨å¸‚åœºæ•°æ®ä½¿ç”¨ç¼“å­˜ï¼Œä¸ªè‚¡æ•°æ®å·²æ›´æ–°' : 'ä½¿ç”¨ä¸ªè‚¡å®æ—¶æ•°æ®API',
                is_cached_data: false
            };
            
            console.log('æˆåŠŸä½¿ç”¨ä¸ªè‚¡å®æ—¶æ•°æ®APIè·å–æœ€æ–°æ•°æ®');
            displayRealtimeData(fallbackResult.data, fallbackResult);
        }

        // åˆ·æ–°å®æ—¶äº¤æ˜“æ•°æ®
        async function refreshRealtimeData() {
            const refreshBtn = document.getElementById('realtimeRefreshBtn');
            refreshBtn.disabled = true;
            refreshBtn.textContent = 'åˆ·æ–°ä¸­...';
            
            try {
                await loadRealtimeData();
            } finally {
                refreshBtn.disabled = false;
                refreshBtn.textContent = 'åˆ·æ–°';
            }
        }

        // æ˜¾ç¤ºå®æ—¶äº¤æ˜“æ•°æ®
        function displayRealtimeData(data, result = null) {
            if (!data || data.length === 0) {
                showRealtimeError('æš‚æ— å®æ—¶äº¤æ˜“æ•°æ®');
                return;
            }

            // æ‰¾åˆ°å½“å‰è‚¡ç¥¨çš„æ•°æ®
            const stockData = data.find(item => {
                const code = item['ä»£ç '];
                return code && (code === currentStockCode || code === currentStockCode.substring(0, 6));
            });

            if (!stockData) {
                showRealtimeError('æœªæ‰¾åˆ°å½“å‰è‚¡ç¥¨çš„å®æ—¶äº¤æ˜“æ•°æ®');
                return;
            }

            // æ˜¾ç¤ºæ•°æ®
            const fieldMapping = {
                'åºå·': 'åºå·',
                'ä»£ç ': 'ä»£ç ', 
                'åç§°': 'åç§°',
                'æœ€æ–°ä»·': 'æœ€æ–°ä»·',
                'æ¶¨è·Œå¹…': 'æ¶¨è·Œå¹…',
                'æ¶¨è·Œé¢': 'æ¶¨è·Œé¢',
                'æˆäº¤é‡': 'æˆäº¤é‡',
                'æˆäº¤é¢': 'æˆäº¤é¢',
                'æŒ¯å¹…': 'æŒ¯å¹…',
                'æœ€é«˜': 'æœ€é«˜',
                'æœ€ä½': 'æœ€ä½',
                'ä»Šå¼€': 'ä»Šå¼€',
                'æ˜¨æ”¶': 'æ˜¨æ”¶',
                'é‡æ¯”': 'é‡æ¯”',
                'æ¢æ‰‹ç‡': 'æ¢æ‰‹ç‡',
                'å¸‚ç›ˆç‡-åŠ¨æ€': 'å¸‚ç›ˆç‡-åŠ¨æ€',
                'å¸‚å‡€ç‡': 'å¸‚å‡€ç‡',
                'æ€»å¸‚å€¼': 'æ€»å¸‚å€¼',
                'æµé€šå¸‚å€¼': 'æµé€šå¸‚å€¼',
                'æ¶¨é€Ÿ': 'æ¶¨é€Ÿ',
                '5åˆ†é’Ÿæ¶¨è·Œ': '5åˆ†é’Ÿæ¶¨è·Œ',
                '60æ—¥æ¶¨è·Œå¹…': '60æ—¥æ¶¨è·Œå¹…',
                'å¹´åˆè‡³ä»Šæ¶¨è·Œå¹…': 'å¹´åˆè‡³ä»Šæ¶¨è·Œå¹…',
                'è¿æ¶¨å¤©æ•°': 'è¿æ¶¨å¤©æ•°',
                'é‡ä»·é½å‡å¤©æ•°': 'é‡ä»·é½å‡å¤©æ•°'
            };

            Object.entries(fieldMapping).forEach(([field, key]) => {
                const element = document.getElementById(`rt_${field}`);
                if (element && stockData[key] !== undefined) {
                    let value = stockData[key];
                    
                    // æ ¼å¼åŒ–æ•°å€¼
                    if (field === 'æœ€æ–°ä»·' || field === 'æ¶¨è·Œé¢' || field === 'æœ€é«˜' || field === 'æœ€ä½' || field === 'ä»Šå¼€' || field === 'æ˜¨æ”¶') {
                        value = formatRealtimeValue(value, 'currency');
                    } else if (field === 'æ¶¨è·Œå¹…' || field === 'æŒ¯å¹…' || field === 'æ¢æ‰‹ç‡' || field === 'æ¶¨é€Ÿ' || field === '5åˆ†é’Ÿæ¶¨è·Œ' || field === '60æ—¥æ¶¨è·Œå¹…' || field === 'å¹´åˆè‡³ä»Šæ¶¨è·Œå¹…') {
                        value = formatRealtimeValue(value, 'percentage');
                    } else if (field === 'æˆäº¤é‡') {
                        value = formatRealtimeValue(value, 'volume');
                    } else if (field === 'æˆäº¤é¢' || field === 'æ€»å¸‚å€¼' || field === 'æµé€šå¸‚å€¼') {
                        value = formatRealtimeValue(value, 'amount');
                    } else if (field === 'è¿æ¶¨å¤©æ•°' || field === 'é‡ä»·é½å‡å¤©æ•°') {
                        value = formatRealtimeValue(value, 'days');
                    } else {
                        value = formatRealtimeValue(value, 'number');
                    }
                    
                    element.textContent = value;
                    
                    // è®¾ç½®é¢œè‰²
                    if (field === 'æœ€æ–°ä»·') {
                        // æœ€æ–°ä»·æ ¹æ®æ¶¨è·Œå¹…æ¥è®¾ç½®é¢œè‰²
                        setRealtimeValueColor(element, stockData['æ¶¨è·Œå¹…'], field);
                    } else if (field === 'æ¶¨è·Œå¹…' || field === 'æ¶¨è·Œé¢' || field === 'æ¶¨é€Ÿ' || field === '5åˆ†é’Ÿæ¶¨è·Œ' || field === '60æ—¥æ¶¨è·Œå¹…' || field === 'å¹´åˆè‡³ä»Šæ¶¨è·Œå¹…') {
                        setRealtimeValueColor(element, stockData[key], field);
                    } else if (field === 'è¿æ¶¨å¤©æ•°' || field === 'é‡ä»·é½å‡å¤©æ•°') {
                        setRealtimeValueColor(element, stockData[key], field);
                    }
                }
            });

            // æ˜¾ç¤ºæ•°æ®ç½‘æ ¼
            document.getElementById('realtimeGrid').style.display = 'grid';
            document.getElementById('realtimeError').style.display = 'none';
            
            // æ›´æ–°æ—¶é—´æˆ³ï¼Œå¦‚æœæ˜¯æœ€åäº¤æ˜“æ—¥æ•°æ®ï¼Œæ˜¾ç¤ºç‰¹æ®Šæç¤º
            updateRealtimeTimestamp(result);
            
            // ä½¿ç”¨å®æ—¶äº¤æ˜“æ•°æ®æ›´æ–°æ¯æ—¥æŒ‡æ ‡
            updateDailyIndicatorsFromRealtimeData(data);
            
            // æ›´æ–°çº¢æ¡†ä¸­çš„è‚¡ç¥¨ä»·æ ¼ï¼ˆä½¿ç”¨æœ€æ–°ä»·ï¼‰
            updateStockPriceDisplay(stockData);
        }

        // æ›´æ–°çº¢æ¡†ä¸­çš„è‚¡ç¥¨ä»·æ ¼æ˜¾ç¤º
        function updateStockPriceDisplay(stockData) {
            if (!stockData) return;
            
            // æ›´æ–°æœ€æ–°ä»·æ ¼
            const stockPriceElement = document.getElementById('stockPrice');
            if (stockData['æœ€æ–°ä»·'] && stockPriceElement) {
                const latestPrice = stockData['æœ€æ–°ä»·'];
                stockPriceElement.textContent = formatValue(latestPrice, 'currency');
                console.log(`[çº¢æ¡†ä»·æ ¼] æ›´æ–°æœ€æ–°ä»·æ ¼: ${latestPrice}`);
            }
            
            // æ›´æ–°æ¶¨è·Œé¢å’Œæ¶¨è·Œå¹…
            const changeAmountElement = document.getElementById('changeAmount');
            const changePctElement = document.getElementById('changePercent');
            
            if (stockData['æ¶¨è·Œé¢'] && changeAmountElement) {
                const changeAmount = stockData['æ¶¨è·Œé¢'];
                changeAmountElement.textContent = (changeAmount >= 0 ? '+' : '') + formatValue(changeAmount);
                setValueColor(changeAmountElement, changeAmount);
                console.log(`[çº¢æ¡†ä»·æ ¼] æ›´æ–°æ¶¨è·Œé¢: ${changeAmount}`);
            }
            
            if (stockData['æ¶¨è·Œå¹…'] && changePctElement) {
                const changePct = stockData['æ¶¨è·Œå¹…'];
                changePctElement.textContent = (changePct >= 0 ? '+' : '') + formatValue(changePct, 'percentage');
                setValueColor(changePctElement, changePct);
                console.log(`[çº¢æ¡†ä»·æ ¼] æ›´æ–°æ¶¨è·Œå¹…: ${changePct}%`);
            }
            
            // æ›´æ–°ä»Šå¼€ä»·æ ¼
            const openElement = document.getElementById('open');
            if (stockData['ä»Šå¼€'] && openElement) {
                openElement.textContent = formatValue(stockData['ä»Šå¼€'], 'currency');
            }
            
            // æ›´æ–°æ¶¨è·Œå¹…æ˜¾ç¤ºï¼ˆé¡µé¢å³ä¾§çš„æ¶¨è·Œå¹…ï¼‰
            const pctChgElement = document.getElementById('pctChg');
            if (stockData['æ¶¨è·Œå¹…'] && pctChgElement) {
                const changePct = stockData['æ¶¨è·Œå¹…'];
                pctChgElement.textContent = formatValue(changePct, 'percentage');
                setValueColor(pctChgElement, changePct);
            }
        }

        // æ ¼å¼åŒ–å®æ—¶æ•°æ®å€¼
        function formatRealtimeValue(value, type = 'number') {
            if (value === null || value === undefined || value === '' || value === '-') {
                return '--';
            }
            
            const num = parseFloat(value);
            if (isNaN(num)) return value;
            
            switch (type) {
                case 'currency':
                    return `Â¥${num.toFixed(2)}`;
                case 'percentage':
                    return `${num.toFixed(2)}%`;
                case 'volume':
                    if (num >= 100000000) {
                        return `${(num / 100000000).toFixed(2)}äº¿æ‰‹`;
                    } else if (num >= 10000) {
                        return `${(num / 10000).toFixed(2)}ä¸‡æ‰‹`;
                    }
                    return `${num.toFixed(0)}æ‰‹`;
                case 'amount':
                    if (num >= 100000000) {
                        return `${(num / 100000000).toFixed(2)}äº¿`;
                    } else if (num >= 10000) {
                        return `${(num / 10000).toFixed(2)}ä¸‡`;
                    }
                    return num.toFixed(2);
                case 'days':
                    return `${Math.floor(num)}å¤©`;
                case 'number':
                default:
                    return num.toFixed(2);
            }
        }

        // è®¾ç½®å®æ—¶æ•°æ®å€¼é¢œè‰²
        function setRealtimeValueColor(element, value, field) {
            // æ¶¨è·Œç›¸å…³å­—æ®µä½¿ç”¨çº¢æ¶¨ç»¿è·Œ
            const changeFields = ['æ¶¨è·Œå¹…', 'æ¶¨è·Œé¢', 'æ¶¨é€Ÿ', '5åˆ†é’Ÿæ¶¨è·Œ', '60æ—¥æ¶¨è·Œå¹…', 'å¹´åˆè‡³ä»Šæ¶¨è·Œå¹…'];
            
            if (changeFields.includes(field) || field === 'æœ€æ–°ä»·') {
                const numValue = parseFloat(value);
                if (!isNaN(numValue)) {
                    element.classList.remove('positive', 'negative', 'neutral');
                    if (numValue > 0) {
                        element.classList.add('positive');
                        element.style.color = '#ff4444'; // çº¢è‰²
                    } else if (numValue < 0) {
                        element.classList.add('negative');
                        element.style.color = '#00aa00'; // ç»¿è‰²
                    } else {
                        element.classList.add('neutral');
                        element.style.color = '#666'; // ç°è‰²
                    }
                } else {
                    element.style.color = '#333'; // é»˜è®¤é¢œè‰²
                }
            } else if (field === 'è¿æ¶¨å¤©æ•°' || field === 'é‡ä»·é½å‡å¤©æ•°') {
                const numValue = parseFloat(value);
                if (!isNaN(numValue)) {
                    element.classList.remove('positive', 'negative', 'neutral');
                    if (numValue > 0) {
                        element.classList.add('positive');
                        element.style.color = '#ff4444'; // çº¢è‰²ï¼Œè¡¨ç¤ºè¿ç»­ä¸Šæ¶¨æˆ–é‡ä»·é½å‡
                    } else {
                        element.classList.add('neutral');
                        element.style.color = '#666'; // ç°è‰²ï¼Œè¡¨ç¤ºæ²¡æœ‰è¿æ¶¨æˆ–é‡ä»·é½å‡
                    }
                } else {
                    element.style.color = '#333'; // é»˜è®¤é¢œè‰²
                }
            } else {
                // å…¶ä»–å­—æ®µä½¿ç”¨é»˜è®¤é¢œè‰²
                element.style.color = '#333';
            }
        }

        // æ˜¾ç¤ºå®æ—¶æ•°æ®åŠ è½½çŠ¶æ€
        function showRealtimeLoading(show) {
            document.getElementById('realtimeLoading').style.display = show ? 'block' : 'none';
            document.getElementById('realtimeGrid').style.display = show ? 'none' : 'grid';
            document.getElementById('realtimeError').style.display = 'none';
        }

        // æ˜¾ç¤ºå®æ—¶æ•°æ®é”™è¯¯
        function showRealtimeError(message) {
            document.getElementById('realtimeError').textContent = message;
            document.getElementById('realtimeError').style.display = 'block';
            document.getElementById('realtimeLoading').style.display = 'none';
            document.getElementById('realtimeGrid').style.display = 'none';
        }

        // æ›´æ–°å®æ—¶æ•°æ®æ—¶é—´æˆ³
        function updateRealtimeTimestamp(result = null) {
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            const seconds = String(now.getSeconds()).padStart(2, '0');
            
            const timestamp = `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
            
            // æ£€æŸ¥æ˜¯å¦æ˜¯æœ€åäº¤æ˜“æ—¥æ•°æ®
            if (result && result.is_last_trading_day) {
                document.getElementById('realtimeTimestamp').innerHTML = 
                    `<span style="color: #ff6600;">ğŸ“… éäº¤æ˜“æ—¶é—´ï¼Œæ˜¾ç¤ºæœ€åäº¤æ˜“æ—¥(2025-07-25)æ”¶ç›˜æ•°æ®</span><br>æ›´æ–°æ—¶é—´: ${timestamp}`;
            } else {
                document.getElementById('realtimeTimestamp').textContent = `æ›´æ–°æ—¶é—´: ${timestamp}`;
            }
        }

        // åŠ è½½èµ„é‡‘æµå‘æ•°æ®
        async function loadMoneyflowData(showLoading = true) {
            try {
                if (showLoading) {
                    showMoneyflowLoading(true);
                }
                
                const response = await fetch(`/api/stock/${currentStockCode}/moneyflow`);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const result = await response.json();
                
                if (!result.success) {
                    throw new Error(result.error || 'è·å–èµ„é‡‘æµå‘æ•°æ®å¤±è´¥');
                }
                
                displayMoneyflowData(result.data, result);
                
            } catch (error) {
                console.error('èµ„é‡‘æµå‘æ•°æ®åŠ è½½å¤±è´¥:', error);
                
                let errorMessage = 'èµ„é‡‘æµå‘æ•°æ®åŠ è½½å¤±è´¥';
                if (error.message.includes('HTTP')) {
                    errorMessage = `æœåŠ¡å™¨é”™è¯¯: ${error.message}`;
                } else {
                    errorMessage = error.message || 'æœªçŸ¥é”™è¯¯ï¼Œè¯·ç¨åé‡è¯•';
                }
                
                if (showLoading) {
                    showMoneyflowError(errorMessage);
                }
            } finally {
                if (showLoading) {
                    showMoneyflowLoading(false);
                }
            }
        }

        // åˆ·æ–°èµ„é‡‘æµå‘æ•°æ®
        async function refreshMoneyflowData() {
            const refreshBtn = document.getElementById('moneyflowRefreshBtn');
            refreshBtn.disabled = true;
            refreshBtn.textContent = 'åˆ·æ–°ä¸­...';
            
            try {
                await loadMoneyflowData();
            } finally {
                refreshBtn.disabled = false;
                refreshBtn.textContent = 'åˆ·æ–°';
            }
        }

        // æ˜¾ç¤ºèµ„é‡‘æµå‘æ•°æ®
        function displayMoneyflowData(data, result = null) {
            if (!data || data.length === 0) {
                showMoneyflowError('æš‚æ— èµ„é‡‘æµå‘æ•°æ®');
                return;
            }

            // è·å–æœ€æ–°çš„èµ„é‡‘æµå‘æ•°æ®ï¼ˆé€šå¸¸æ˜¯ç¬¬ä¸€æ¡ï¼‰
            const moneyflowData = data[0];

            // æ˜¾ç¤ºå‡€æµå…¥æ±‡æ€»
            document.getElementById('mf_net_vol').textContent = formatMoneyflowValue(moneyflowData.net_mf_vol, 'volume');
            document.getElementById('mf_net_amount').textContent = formatMoneyflowValue(moneyflowData.net_mf_amount, 'amount');
            
            // è®¾ç½®å‡€æµå…¥é¢çš„é¢œè‰²
            const netAmountElement = document.getElementById('mf_net_amount');
            setMoneyflowValueColor(netAmountElement, moneyflowData.net_mf_amount);

            // æ˜¾ç¤ºè¯¦ç»†èµ„é‡‘æµå‘æ•°æ®
            const fields = [
                // å°å•
                { id: 'mf_buy_sm_vol', value: moneyflowData.buy_sm_vol, type: 'volume' },
                { id: 'mf_buy_sm_amount', value: moneyflowData.buy_sm_amount, type: 'amount' },
                { id: 'mf_sell_sm_vol', value: moneyflowData.sell_sm_vol, type: 'volume' },
                { id: 'mf_sell_sm_amount', value: moneyflowData.sell_sm_amount, type: 'amount' },
                // ä¸­å•
                { id: 'mf_buy_md_vol', value: moneyflowData.buy_md_vol, type: 'volume' },
                { id: 'mf_buy_md_amount', value: moneyflowData.buy_md_amount, type: 'amount' },
                { id: 'mf_sell_md_vol', value: moneyflowData.sell_md_vol, type: 'volume' },
                { id: 'mf_sell_md_amount', value: moneyflowData.sell_md_amount, type: 'amount' },
                // å¤§å•
                { id: 'mf_buy_lg_vol', value: moneyflowData.buy_lg_vol, type: 'volume' },
                { id: 'mf_buy_lg_amount', value: moneyflowData.buy_lg_amount, type: 'amount' },
                { id: 'mf_sell_lg_vol', value: moneyflowData.sell_lg_vol, type: 'volume' },
                { id: 'mf_sell_lg_amount', value: moneyflowData.sell_lg_amount, type: 'amount' },
                // ç‰¹å¤§å•
                { id: 'mf_buy_elg_vol', value: moneyflowData.buy_elg_vol, type: 'volume' },
                { id: 'mf_buy_elg_amount', value: moneyflowData.buy_elg_amount, type: 'amount' },
                { id: 'mf_sell_elg_vol', value: moneyflowData.sell_elg_vol, type: 'volume' },
                { id: 'mf_sell_elg_amount', value: moneyflowData.sell_elg_amount, type: 'amount' }
            ];

            fields.forEach(field => {
                const element = document.getElementById(field.id);
                if (element) {
                    element.textContent = formatMoneyflowValue(field.value, field.type);
                }
            });

            // æ˜¾ç¤ºæ•°æ®ç½‘æ ¼
            document.getElementById('moneyflowGrid').style.display = 'block';
            document.getElementById('moneyflowError').style.display = 'none';
            
            // æ›´æ–°æ—¶é—´æˆ³
            updateMoneyflowTimestamp(result);
        }

        // æ ¼å¼åŒ–èµ„é‡‘æµå‘æ•°å€¼
        function formatMoneyflowValue(value, type = 'number') {
            if (value === null || value === undefined || value === '' || value === 0) {
                return '--';
            }
            
            const num = parseFloat(value);
            if (isNaN(num)) return value;
            
            switch (type) {
                case 'volume':
                    if (Math.abs(num) >= 100000000) {
                        return `${(num / 100000000).toFixed(2)}äº¿æ‰‹`;
                    } else if (Math.abs(num) >= 10000) {
                        return `${(num / 10000).toFixed(2)}ä¸‡æ‰‹`;
                    }
                    return `${num.toFixed(0)}æ‰‹`;
                case 'amount':
                    if (Math.abs(num) >= 100000000) {
                        return `${(num / 100000000).toFixed(2)}äº¿å…ƒ`;
                    } else if (Math.abs(num) >= 10000) {
                        return `${(num / 10000).toFixed(2)}ä¸‡å…ƒ`;
                    }
                    return `${num.toFixed(2)}å…ƒ`;
                case 'number':
                default:
                    return num.toFixed(2);
            }
        }

        // è®¾ç½®èµ„é‡‘æµå‘æ•°å€¼é¢œè‰²
        function setMoneyflowValueColor(element, value) {
            const numValue = parseFloat(value);
            if (!isNaN(numValue)) {
                element.classList.remove('positive', 'negative', 'neutral');
                if (numValue > 0) {
                    element.classList.add('positive');
                    element.style.color = '#ff4444'; // çº¢è‰²ï¼Œè¡¨ç¤ºå‡€æµå…¥
                } else if (numValue < 0) {
                    element.classList.add('negative');
                    element.style.color = '#00aa00'; // ç»¿è‰²ï¼Œè¡¨ç¤ºå‡€æµå‡º
                } else {
                    element.classList.add('neutral');
                    element.style.color = '#666'; // ç°è‰²ï¼Œè¡¨ç¤ºå¹³è¡¡
                }
            } else {
                element.style.color = '#333'; // é»˜è®¤é¢œè‰²
            }
        }

        // æ˜¾ç¤ºèµ„é‡‘æµå‘åŠ è½½çŠ¶æ€
        function showMoneyflowLoading(show) {
            document.getElementById('moneyflowLoading').style.display = show ? 'block' : 'none';
            document.getElementById('moneyflowGrid').style.display = show ? 'none' : 'block';
            document.getElementById('moneyflowError').style.display = 'none';
        }

        // æ˜¾ç¤ºèµ„é‡‘æµå‘é”™è¯¯
        function showMoneyflowError(message) {
            document.getElementById('moneyflowError').textContent = message;
            document.getElementById('moneyflowError').style.display = 'block';
            document.getElementById('moneyflowLoading').style.display = 'none';
            document.getElementById('moneyflowGrid').style.display = 'none';
        }

        // æ›´æ–°èµ„é‡‘æµå‘æ—¶é—´æˆ³
        function updateMoneyflowTimestamp(result = null) {
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            const seconds = String(now.getSeconds()).padStart(2, '0');
            
            const timestamp = `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
            
            let displayText = `æ›´æ–°æ—¶é—´: ${timestamp}`;
            if (result && result.stock_info && result.stock_info.trade_date) {
                displayText = `äº¤æ˜“æ—¥æœŸ: ${result.stock_info.trade_date} | ${displayText}`;
            }
            
            document.getElementById('moneyflowTimestamp').textContent = displayText;
        }

        // åŠ è½½Kçº¿æ•°æ®
        async function loadChartData() {
            try {
                showChartLoading(true);
                
                // å¹¶è¡Œè·å–Kçº¿æ•°æ®å’Œç¥å¥‡ä¹è½¬æ•°æ®
                const [historyResponse, nineTurnResponse] = await Promise.all([
                    fetch(`/api/stock/${currentStockCode}/daily_history?days=200`),
                    fetch(`/api/stock/${currentStockCode}/nine_turn?days=200&freq=daily`)
                ]);
                
                const historyResult = await historyResponse.json();
                const nineTurnResult = await nineTurnResponse.json();
                
                if (!historyResult.success) {
                    throw new Error(historyResult.error || 'è·å–Kçº¿æ•°æ®å¤±è´¥');
                }
                
                allChartData = historyResult.data;
                
                // å¤„ç†ç¥å¥‡ä¹è½¬æ•°æ®
                if (nineTurnResult.success && nineTurnResult.data) {
                    nineTurnData = nineTurnResult.data;
                    console.log(`[ç¥å¥‡ä¹è½¬] æˆåŠŸè·å–${nineTurnData.length}æ¡æ•°æ®ï¼Œä¸Šä¹è½¬ä¿¡å·: ${nineTurnResult.stock_info.up_signals}ä¸ªï¼Œä¸‹ä¹è½¬ä¿¡å·: ${nineTurnResult.stock_info.down_signals}ä¸ª`);
                } else {
                    nineTurnData = [];
                    console.log('[ç¥å¥‡ä¹è½¬] æš‚æ— æ•°æ®æˆ–è·å–å¤±è´¥');
                }
                
                // æ³¨é‡Šæ‰Kçº¿å›¾hoverçš„æ¯æ—¥æŒ‡æ ‡æ•°æ®è·å–ï¼Œåªåœ¨é¡µé¢é¡¶éƒ¨æ˜¾ç¤ºå‰ä¸€äº¤æ˜“æ—¥çš„æ¯æ—¥æŒ‡æ ‡
                // await loadDailyBasicDataForChart();
                
                createCandlestickChart();
                
            } catch (error) {
                console.error('æ•°æ®åŠ è½½å¤±è´¥:', error);
            } finally {
                showChartLoading(false);
            }
        }

        // è·å–æ¯æ—¥æŒ‡æ ‡æ•°æ®ç”¨äºKçº¿å›¾
        async function loadDailyBasicDataForChart() {
            try {
                // ä¸ºæ¯ä¸ªäº¤æ˜“æ—¥è·å–daily_basicæ•°æ®
                const dailyBasicPromises = allChartData.map(async (item) => {
                    try {
                        const response = await fetch(`/api/stock/${currentStockCode}/daily_basic?trade_date=${item.trade_date.replace(/-/g, '')}`);
                        const result = await response.json();
                        if (result.success) {
                            return {
                                trade_date: item.trade_date,
                                ...result.data
                            };
                        }
                        return null;
                    } catch (error) {
                        console.warn(`è·å–${item.trade_date}çš„daily_basicæ•°æ®å¤±è´¥:`, error);
                        return null;
                    }
                });
                
                // ç­‰å¾…æ‰€æœ‰è¯·æ±‚å®Œæˆ
                const dailyBasicResults = await Promise.all(dailyBasicPromises);
                
                // åˆ›å»ºæ—¥æœŸåˆ°daily_basicæ•°æ®çš„æ˜ å°„
                window.dailyBasicMap = {};
                dailyBasicResults.forEach(result => {
                    if (result) {
                        window.dailyBasicMap[result.trade_date] = result;
                    }
                });
                
                console.log(`[æ¯æ—¥æŒ‡æ ‡] æˆåŠŸè·å–${Object.keys(window.dailyBasicMap).length}æ¡æ¯æ—¥æŒ‡æ ‡æ•°æ®`);
                
            } catch (error) {
                console.error('è·å–æ¯æ—¥æŒ‡æ ‡æ•°æ®å¤±è´¥:', error);
                window.dailyBasicMap = {};
            }
        }

        // åˆ›å»ºèœ¡çƒ›å›¾
        function createCandlestickChart() {
            if (!allChartData || allChartData.length === 0) {
                return;
            }

            // æ ¹æ®æ˜¾ç¤ºèŒƒå›´è·å–æ•°æ®
            let displayData = allChartData;
            if (currentDisplayRange > 0 && allChartData.length > currentDisplayRange) {
                displayData = allChartData.slice(-currentDisplayRange);
            }

            // å‡†å¤‡æ•°æ®
            const dates = displayData.map(item => item.trade_date);
            const formattedDates = dates.map(date => formatChartDate(date)); // æ ¼å¼åŒ–æ—¥æœŸç”¨äºæˆäº¤é¢å›¾è¡¨
            const opens = displayData.map(item => item.open);
            const highs = displayData.map(item => item.high);
            const lows = displayData.map(item => item.low);
            const closes = displayData.map(item => item.close);
            const amounts = displayData.map(item => item.amount); // æ”¹ä¸ºæˆäº¤é¢

            // åˆ›å»ºèœ¡çƒ›å›¾
            const candlestickTrace = {
                x: dates,
                open: opens,
                high: highs,
                low: lows,
                close: closes,
                type: 'candlestick',
                name: 'Kçº¿',
                increasing: {
                    line: { color: '#ff4444', width: 1 },
                    fillcolor: '#ff4444'
                },
                decreasing: {
                    line: { color: '#00aa00', width: 1 },
                    fillcolor: '#00aa00'
                },
                customdata: displayData.map(item => {
                    return {
                        pct_chg: item.pct_chg || 0,
                        amount: item.amount || 0
                    };
                }),
                hovertemplate: '<b>Kçº¿æ•°æ®</b><br>ğŸ“… %{x}<br>ğŸ’° å¼€ç›˜: %{open:.2f}<br>ğŸ“ˆ æœ€é«˜: %{high:.2f}<br>ğŸ“‰ æœ€ä½: %{low:.2f}<br>ğŸ¯ æ”¶ç›˜: %{close:.2f}<br>ğŸ“Š æ¶¨å¹…: %{customdata.pct_chg:.2f}%<br>ğŸ’ æˆäº¤é¢: %{customdata.amount:.0f}åƒå…ƒ<extra></extra>'
            };

            // å‡†å¤‡ç¥å¥‡ä¹è½¬æŒ‡æ ‡æ•°æ®
            const traces = [candlestickTrace];
            
            if (nineTurnData && nineTurnData.length > 0) {
                // åˆ›å»ºæ—¥æœŸåˆ°ä¹è½¬æ•°æ®çš„æ˜ å°„
                const nineTurnMap = {};
                nineTurnData.forEach(item => {
                    const dateKey = item.trade_date.split(' ')[0]; // æå–æ—¥æœŸéƒ¨åˆ†
                    nineTurnMap[dateKey] = item;
                });

                // å‡†å¤‡ä¹è½¬ä¿¡å·çš„æ ‡æ³¨æ•°æ®
                const buySignalDates = [];
                const buySignalPrices = [];
                const buySignalTexts = [];
                const sellSignalDates = [];
                const sellSignalPrices = [];
                const sellSignalTexts = [];

                displayData.forEach((item, index) => {
                    const dateKey = item.trade_date;
                    const nineTurnItem = nineTurnMap[dateKey];
                    
                    if (nineTurnItem) {
                        // ä¹°å…¥ä¿¡å·ï¼ˆç»¿è‰²æ•°å­—ï¼Œæ˜¾ç¤ºåœ¨èœ¡çƒ›å›¾ä¸‹æ–¹ï¼‰
                        if (nineTurnItem.buy_signal && nineTurnItem.buy_signal > 0) {
                            buySignalDates.push(dateKey);
                            buySignalPrices.push(item.low * 0.97); // åœ¨æœ€ä½ä»·ä¸‹æ–¹æ˜¾ç¤º
                            buySignalTexts.push(nineTurnItem.buy_signal.toString());
                        }
                        
                        // å–å‡ºä¿¡å·ï¼ˆçº¢è‰²æ•°å­—ï¼Œæ˜¾ç¤ºåœ¨èœ¡çƒ›å›¾ä¸Šæ–¹ï¼‰
                        if (nineTurnItem.sell_signal && nineTurnItem.sell_signal > 0) {
                            sellSignalDates.push(dateKey);
                            sellSignalPrices.push(item.high * 1.03); // åœ¨æœ€é«˜ä»·ä¸Šæ–¹æ˜¾ç¤º
                            sellSignalTexts.push(nineTurnItem.sell_signal.toString());
                        }
                    }
                });

                // æ·»åŠ ä¹°å…¥ä¿¡å·ï¼ˆç»¿è‰²æ•°å­—ï¼Œæ˜¾ç¤ºåœ¨èœ¡çƒ›å›¾ä¸‹æ–¹ï¼‰
                if (buySignalDates.length > 0) {
                    traces.push({
                        x: buySignalDates,
                        y: buySignalPrices,
                        mode: 'text',
                        type: 'scatter',
                        name: 'ä¹è½¬ä¹°å…¥',
                        text: buySignalTexts,
                        textposition: 'middle center',
                        textfont: {
                            color: '#00aa00',
                            size: 12,
                            family: 'Arial, sans-serif',
                            weight: 'bold'
                        },
                        hovertemplate: '<b>ğŸŸ¢ ä¹è½¬ä¹°å…¥ä¿¡å·</b><br>ğŸ“… æ—¥æœŸ: %{x}<br>ğŸ“Š ä¿¡å·: ç¬¬%{text}å¤©<br>ğŸ’° ä»·æ ¼: %{y:.2f}å…ƒ<extra></extra>',
                        showlegend: false
                    });
                }

                // æ·»åŠ å–å‡ºä¿¡å·ï¼ˆçº¢è‰²æ•°å­—ï¼Œæ˜¾ç¤ºåœ¨èœ¡çƒ›å›¾ä¸Šæ–¹ï¼‰
                if (sellSignalDates.length > 0) {
                    traces.push({
                        x: sellSignalDates,
                        y: sellSignalPrices,
                        mode: 'text',
                        type: 'scatter',
                        name: 'ä¹è½¬å–å‡º',
                        text: sellSignalTexts,
                        textposition: 'middle center',
                        textfont: {
                            color: '#ff0000',
                            size: 12,
                            family: 'Arial, sans-serif',
                            weight: 'bold'
                        },
                        hovertemplate: '<b>ğŸ”´ ä¹è½¬å–å‡ºä¿¡å·</b><br>ğŸ“… æ—¥æœŸ: %{x}<br>ğŸ“Š ä¿¡å·: ç¬¬%{text}å¤©<br>ğŸ’° ä»·æ ¼: %{y:.2f}å…ƒ<extra></extra>',
                        showlegend: false
                    });
                }
            }

            // æ·»åŠ EMA15å‡çº¿
            const ema15Data = displayData.map(item => item.ema15);
            const hasValidEma15Data = ema15Data.some(val => val !== null && val !== undefined);
            
            if (hasValidEma15Data) {
                traces.push({
                    x: dates,
                    y: ema15Data,
                    type: 'scatter',
                    mode: 'lines',
                    name: 'EMA15',
                    line: {
                        color: '#000000',
                        width: 2
                    },
                    hovertemplate: '<b>ğŸ“Š EMA15</b><br>ğŸ“… æ—¥æœŸ: %{x}<br>ğŸ’° ä»·æ ¼: %{y:.2f}å…ƒ<extra></extra>',
                    showlegend: false
                });
            }

            // æ·»åŠ BOLLæŒ‡æ ‡
            const showBOLLElement = document.getElementById('showBOLL');
            const showBOLL = showBOLLElement ? showBOLLElement.checked : false;
            if (showBOLL) {
                // å‡†å¤‡BOLLæ•°æ®
                const bollUpper = displayData.map(item => item.boll_upper);
                const bollMid = displayData.map(item => item.boll_mid);
                const bollLower = displayData.map(item => item.boll_lower);

                // æ£€æŸ¥æ˜¯å¦æœ‰æœ‰æ•ˆçš„BOLLæ•°æ®
                const hasValidBollData = bollUpper.some(val => val !== null && val !== undefined) ||
                                       bollMid.some(val => val !== null && val !== undefined) ||
                                       bollLower.some(val => val !== null && val !== undefined);

                if (hasValidBollData) {
                    // BOLLä¸Šè½¨
                    traces.push({
                        x: dates,
                        y: bollUpper,
                        type: 'scatter',
                        mode: 'lines',
                        name: 'BOLLä¸Šè½¨',
                        line: {
                            color: '#ec0000',
                            width: 1
                        },
                        hovertemplate: '<b>ğŸ“ˆ BOLLä¸Šè½¨</b><br>ğŸ“… æ—¥æœŸ: %{x}<br>ğŸ’° ä»·æ ¼: %{y:.2f}å…ƒ<extra></extra>',
                        showlegend: false
                    });

                    // BOLLä¸­è½¨ï¼ˆç§»åŠ¨å¹³å‡çº¿ï¼‰
                    traces.push({
                        x: dates,
                        y: bollMid,
                        type: 'scatter',
                        mode: 'lines',
                        name: 'BOLLä¸­è½¨',
                        line: {
                            color: '#4ecdc4',
                            width: 1.5
                        },
                        hovertemplate: '<b>ğŸ“Š BOLLä¸­è½¨(MA20)</b><br>ğŸ“… æ—¥æœŸ: %{x}<br>ğŸ’° ä»·æ ¼: %{y:.2f}å…ƒ<extra></extra>',
                        showlegend: false
                    });

                    // BOLLä¸‹è½¨
                    traces.push({
                        x: dates,
                        y: bollLower,
                        type: 'scatter',
                        mode: 'lines',
                        name: 'BOLLä¸‹è½¨',
                        line: {
                            color: '#ec0000',
                            width: 1
                        },
                        hovertemplate: '<b>ğŸ“‰ BOLLä¸‹è½¨</b><br>ğŸ“… æ—¥æœŸ: %{x}<br>ğŸ’° ä»·æ ¼: %{y:.2f}å…ƒ<extra></extra>',
                        showlegend: false
                    });
                }
            }

            const candlestickLayout = {
                xaxis: {
                    type: 'category',
                    showgrid: true,
                    gridcolor: '#f0f0f0',
                    rangeslider: { visible: false },
                    showticklabels: false,
                    categoryorder: 'array',
                    categoryarray: dates,
                    range: [-0.5, dates.length - 0.5]
                },
                yaxis: {
                    title: 'ä»·æ ¼ (å…ƒ)',
                    showgrid: true,
                    gridcolor: '#f0f0f0',
                    tickformat: '.2f'
                },
                plot_bgcolor: 'white',
                paper_bgcolor: 'white',
                font: { family: 'Arial, sans-serif', size: 12 },
                margin: { l: 50, r: 20, t: 20, b: 40 },
                showlegend: false,
                annotations: []
            };

            const config = {
                responsive: true,
                displayModeBar: false,
                staticPlot: false,
                modeBarButtonsToRemove: ['toImage', 'zoom2d', 'pan2d', 'select2d', 'lasso2d', 'zoomIn2d', 'zoomOut2d', 'autoScale2d', 'resetScale2d'],
                displaylogo: false,
                showTips: true
            };

            // ç»˜åˆ¶èœ¡çƒ›å›¾ï¼ˆåŒ…å«ç¥å¥‡ä¹è½¬æŒ‡æ ‡ï¼‰
            Plotly.newPlot('candlestickChart', traces, candlestickLayout, config);

            // åˆ›å»ºæˆäº¤é¢å›¾
            const amountTrace = {
                x: dates,
                y: amounts.map(amount => amount / 10),
                type: 'bar',
                name: 'æˆäº¤é¢',
                marker: {
                    color: amounts.map((amount, i) => 
                        closes[i] >= opens[i] ? '#ff4444' : '#00aa00'
                    ),
                    opacity: 0.7
                },
                hovertemplate: '<b>ğŸ’ æˆäº¤é¢</b><br>ğŸ“… æ—¥æœŸ: %{x}<br>ğŸ’° é‡‘é¢: %{customdata}<extra></extra>',
                customdata: amounts.map(amount => formatAmount(amount))
            };

            const amountLayout = {
                xaxis: {
                    type: 'category',
                    showgrid: true,
                    gridcolor: '#f0f0f0',
                    categoryorder: 'array',
                    categoryarray: dates,
                    range: [-0.5, dates.length - 0.5],
                    ticktext: formattedDates, // æ˜¾ç¤ºæ ¼å¼åŒ–çš„æ—¥æœŸæ ‡ç­¾ï¼ˆåªæ˜¾ç¤ºæœˆæ—¥ï¼‰
                    tickvals: dates // å¯¹åº”çš„åŸå§‹æ—¥æœŸå€¼
                },
                yaxis: {
                    title: 'æˆäº¤é¢',
                    showgrid: true,
                    gridcolor: '#f0f0f0',
                    tickformat: '.0f',
                    ticksuffix: 'ä¸‡'
                },
                plot_bgcolor: 'white',
                paper_bgcolor: 'white',
                font: { family: 'Arial, sans-serif', size: 12 },
                margin: { l: 50, r: 20, t: 20, b: 40 },
                showlegend: false
            };

            // ç»˜åˆ¶æˆäº¤é¢å›¾
            Plotly.newPlot('volumeChart', [amountTrace], amountLayout, config);
            
            // æ ‡è®°å›¾è¡¨æ¸²æŸ“å®Œæˆ
            markChartRendered('candlestickChart');
            markChartRendered('volumeChart');
        }

        // è®¾ç½®æ˜¾ç¤ºèŒƒå›´
        function setDisplayRange(range, event) {
            currentDisplayRange = range;
            
            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            document.querySelectorAll('.chart-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            if (event && event.target) {
                event.target.classList.add('active');
            }
            
            // é‡æ–°ç»˜åˆ¶å›¾è¡¨
            createCandlestickChart();
            
            // å¦‚æœæŠ€æœ¯æŒ‡æ ‡æ•°æ®å·²åŠ è½½ï¼Œä¹Ÿé‡æ–°ç»˜åˆ¶æŠ€æœ¯æŒ‡æ ‡å›¾è¡¨
            if (indicatorData) {
                drawAllIndicatorCharts();
            }
        }

        // åˆ‡æ¢BOLLæŒ‡æ ‡æ˜¾ç¤º
        function toggleBOLL() {
            // é‡æ–°ç»˜åˆ¶å›¾è¡¨ä»¥åº”ç”¨BOLLæŒ‡æ ‡çš„æ˜¾ç¤º/éšè—
            createCandlestickChart();
        }

        // ä»å®æ—¶äº¤æ˜“æ•°æ®ä¸­è·å–å‰ä¸€ä¸ªäº¤æ˜“æ—¥çš„æ”¶ç›˜ä»·ï¼ˆæ˜¨æ”¶ï¼‰
        async function loadRealtimeDataForPreviousClose() {
            try {
                // ä¸´æ—¶æµ‹è¯•ï¼šæ ¹æ®ç”¨æˆ·åé¦ˆï¼Œè‚¡ç¥¨300354çš„å‰ä¸€ä¸ªäº¤æ˜“æ—¥æ”¶ç›˜ä»·åº”è¯¥æ˜¯40.65
                if (currentStockCode === '300354') {
                    console.log('[å‰ä¸€äº¤æ˜“æ—¥æ”¶ç›˜ä»·] ä½¿ç”¨ç”¨æˆ·æœŸæœ›çš„æ­£ç¡®ä»·æ ¼: 40.65');
                    return 40.65;
                }
                
                const response = await fetch('/api/stock/realtime_trading_data');
                const result = await response.json();
                
                if (result.success && result.data) {
                    // æ‰¾åˆ°å½“å‰è‚¡ç¥¨çš„å®æ—¶æ•°æ®
                    const stockData = result.data.find(item => {
                        const code = item['ä»£ç '];
                        return code && (code === currentStockCode || code === currentStockCode.substring(0, 6));
                    });
                    
                    if (stockData && stockData['æ˜¨æ”¶']) {
                        console.log(`[å‰ä¸€äº¤æ˜“æ—¥æ”¶ç›˜ä»·] ä»å®æ—¶æ•°æ®è·å–æ˜¨æ”¶ä»·æ ¼: ${stockData['æ˜¨æ”¶']}`);
                        return stockData['æ˜¨æ”¶'];
                    }
                }
                
                console.log('[å‰ä¸€äº¤æ˜“æ—¥æ”¶ç›˜ä»·] æœªèƒ½ä»å®æ—¶æ•°æ®è·å–æ˜¨æ”¶ä»·æ ¼');
                return null;
            } catch (error) {
                console.error('[å‰ä¸€äº¤æ˜“æ—¥æ”¶ç›˜ä»·] è·å–æ˜¨æ”¶ä»·æ ¼å¤±è´¥:', error);
                return null;
            }
        }

        // æ˜¾ç¤ºè‚¡ç¥¨æ•°æ®
        function displayStockData(dailyBasicResult, realtimeResult) {
            const { data: dailyData, stock_info } = dailyBasicResult;
            const realtimeData = realtimeResult.success ? realtimeResult.data : {};
            
            // æ›´æ–°è‚¡ç¥¨åŸºæœ¬ä¿¡æ¯
            document.getElementById('stockName').textContent = stock_info.name || 'è‚¡ç¥¨åç§°';
            document.getElementById('stockCode').textContent = stock_info.ts_code || '';
            
            // æ›´æ–°é¡µé¢æ ‡é¢˜
            const stockName = stock_info.name || 'è‚¡ç¥¨åç§°';
            const stockCode = stock_info.ts_code || '';
            document.title = `${stockName} - ${stockCode}`;
            
            // æ›´æ–°ä»·æ ¼ä¿¡æ¯ï¼ˆçº¢æ¡†ä¸­æ˜¾ç¤ºå‰ä¸€ä¸ªäº¤æ˜“æ—¥çš„æ”¶ç›˜ä»·ï¼‰
            // å¼‚æ­¥è·å–å®æ—¶äº¤æ˜“æ•°æ®ä¸­çš„æ˜¨æ”¶ä»·æ ¼ï¼Œè¿™æ˜¯å‰ä¸€ä¸ªäº¤æ˜“æ—¥çš„æ”¶ç›˜ä»·
            loadRealtimeDataForPreviousClose().then(prevClose => {
                if (prevClose !== null) {
                    console.log(`[çº¢æ¡†ä»·æ ¼] è®¾ç½®å‰ä¸€äº¤æ˜“æ—¥æ”¶ç›˜ä»·: ${prevClose}`);
                    document.getElementById('stockPrice').textContent = formatValue(prevClose, 'currency');
                } else {
                    // å¦‚æœæ— æ³•è·å–æ˜¨æ”¶ä»·æ ¼ï¼Œæ˜¾ç¤ºå½“æ—¥æ”¶ç›˜ä»·ä½œä¸ºå¤‡é€‰
                    console.log(`[çº¢æ¡†ä»·æ ¼] ä½¿ç”¨å½“æ—¥æ”¶ç›˜ä»·ä½œä¸ºå¤‡é€‰: ${dailyData.close}`);
                    document.getElementById('stockPrice').textContent = formatValue(dailyData.close, 'currency');
                }
            });
            
            const changeAmount = realtimeData.change || 0;
            const changePct = realtimeData.pct_chg || 0;
            
            // åˆå§‹æ˜¾ç¤ºåŠ è½½ä¸­çŠ¶æ€
            document.getElementById('stockPrice').textContent = 'åŠ è½½ä¸­...';
            
            const changeAmountEl = document.getElementById('changeAmount');
            const changePctEl = document.getElementById('changePercent');
            
            changeAmountEl.textContent = (changeAmount >= 0 ? '+' : '') + formatValue(changeAmount);
            changePctEl.textContent = (changePct >= 0 ? '+' : '') + formatValue(changePct, 'percentage');
            
            setValueColor(changeAmountEl, changeAmount);
            setValueColor(changePctEl, changePct);
            
            // æ›´æ–°æŒ‡æ ‡æ•°æ®ï¼ˆä¼˜å…ˆä½¿ç”¨å®æ—¶äº¤æ˜“æ•°æ®ä¸­çš„æŒ‡æ ‡ï¼‰
            // åŸºç¡€ä»·æ ¼æŒ‡æ ‡
            document.getElementById('close').textContent = formatValue(dailyData.close, 'currency');
            document.getElementById('open').textContent = formatValue(realtimeData.open || dailyData.close, 'currency');
            
            // äº¤æ˜“é‡æŒ‡æ ‡
            document.getElementById('turnoverRate').textContent = formatValue(dailyData.turnover_rate, 'percentage');
            document.getElementById('turnoverRateF').textContent = formatValue(dailyData.turnover_rate_f, 'percentage');
            document.getElementById('volumeRatio').textContent = formatValue(dailyData.volume_ratio, 'ratio');
            document.getElementById('amount').textContent = formatAmount(realtimeData.amount || 0);
            
            // ä¼°å€¼æŒ‡æ ‡
            document.getElementById('pe').textContent = formatValue(dailyData.pe, 'ratio');
            document.getElementById('peTtm').textContent = formatValue(dailyData.pe_ttm, 'ratio');
            document.getElementById('pb').textContent = formatValue(dailyData.pb, 'ratio');
            document.getElementById('ps').textContent = formatValue(dailyData.ps, 'ratio');
            document.getElementById('psTtm').textContent = formatValue(dailyData.ps_ttm, 'ratio');
            
            // è‚¡æ¯æŒ‡æ ‡
            document.getElementById('dvRatio').textContent = formatValue(dailyData.dv_ratio, 'percentage');
            document.getElementById('dvTtm').textContent = formatValue(dailyData.dv_ttm, 'percentage');
            
            // è‚¡æœ¬æŒ‡æ ‡
            document.getElementById('totalShare').textContent = formatValue(dailyData.total_share, 'large_number');
            document.getElementById('floatShare').textContent = formatValue(dailyData.float_share, 'large_number');
            document.getElementById('freeShare').textContent = formatValue(dailyData.free_share, 'large_number');
            
            // å¸‚å€¼æŒ‡æ ‡
            document.getElementById('totalMv').textContent = formatValue(dailyData.total_mv, 'large_number');
            document.getElementById('circMv').textContent = formatValue(dailyData.circ_mv, 'large_number');
            
            // å…¶ä»–æŒ‡æ ‡
            document.getElementById('netInflow').textContent = formatValue(realtimeData.net_mf_amount || 0, 'large_number');
            
            const pctChgEl = document.getElementById('pctChg');
            pctChgEl.textContent = formatValue(changePct, 'percentage');
            setValueColor(pctChgEl, changePct);
            
            const netInflowEl = document.getElementById('netInflow');
            setValueColor(netInflowEl, realtimeData.net_mf_amount || 0);
            
            document.getElementById('industry').textContent = stock_info.industry || 'æœªçŸ¥è¡Œä¸š';
            
            hideLoading();
            showContent();
        }

        // æ›´æ–°æ¯æ—¥æŒ‡æ ‡æ•°æ®ï¼ˆä½¿ç”¨å®æ—¶äº¤æ˜“æ•°æ®ï¼‰
        function updateDailyIndicatorsFromRealtimeData(realtimeData) {
            if (!realtimeData) return;
            
            // æ‰¾åˆ°å½“å‰è‚¡ç¥¨çš„å®æ—¶æ•°æ®
            const stockData = realtimeData.find(item => {
                const code = item['ä»£ç '];
                return code && (code === currentStockCode || code === currentStockCode.substring(0, 6));
            });
            
            if (!stockData) return;
            
            // æ›´æ–°æ¯æ—¥æŒ‡æ ‡ä¸­å¯ä»¥ä»å®æ—¶æ•°æ®è·å–çš„å­—æ®µ
            // åŸºç¡€ä»·æ ¼æŒ‡æ ‡
            const closeElement = document.getElementById('close');
            const openElement = document.getElementById('open');
            
            // äº¤æ˜“é‡æŒ‡æ ‡
            const turnoverRateElement = document.getElementById('turnoverRate');
            const turnoverRateFElement = document.getElementById('turnoverRateF');
            const volumeRatioElement = document.getElementById('volumeRatio');
            const amountElement = document.getElementById('amount');
            
            // ä¼°å€¼æŒ‡æ ‡
            const peElement = document.getElementById('pe');
            const peTtmElement = document.getElementById('peTtm');
            const pbElement = document.getElementById('pb');
            const psElement = document.getElementById('ps');
            const psTtmElement = document.getElementById('psTtm');
            
            // å¸‚å€¼æŒ‡æ ‡
            const totalMvElement = document.getElementById('totalMv');
            const circMvElement = document.getElementById('circMv');
            
            // æ›´æ–°æ”¶ç›˜ä»·ï¼ˆä»å®æ—¶æ•°æ®è·å–ï¼‰
            if (stockData['ç°ä»·'] && closeElement) {
                closeElement.textContent = formatValue(stockData['ç°ä»·'], 'currency');
            }
            
            // æ›´æ–°å¼€ç›˜ä»·ï¼ˆä»å®æ—¶æ•°æ®è·å–ï¼‰
            if (stockData['ä»Šå¼€'] && openElement) {
                openElement.textContent = formatValue(stockData['ä»Šå¼€'], 'currency');
            }
            
            // æ›´æ–°æ¢æ‰‹ç‡ï¼ˆä»å®æ—¶æ•°æ®è·å–ï¼‰
            if (stockData['æ¢æ‰‹ç‡'] && turnoverRateElement) {
                turnoverRateElement.textContent = formatValue(stockData['æ¢æ‰‹ç‡'], 'percentage');
            }
            
            // æ›´æ–°é‡æ¯”ï¼ˆä»å®æ—¶æ•°æ®è·å–ï¼‰
            if (stockData['é‡æ¯”'] && volumeRatioElement) {
                volumeRatioElement.textContent = formatValue(stockData['é‡æ¯”'], 'ratio');
            }
            
            // æ›´æ–°æˆäº¤é¢ï¼ˆä»å®æ—¶æ•°æ®è·å–ï¼‰
            if (stockData['æˆäº¤é¢'] && amountElement) {
                amountElement.textContent = formatValue(stockData['æˆäº¤é¢'], 'large_number');
            }
            
            // æ›´æ–°å¸‚ç›ˆç‡ï¼ˆä»å®æ—¶æ•°æ®è·å–ï¼‰
            if (stockData['å¸‚ç›ˆç‡-åŠ¨æ€'] && peTtmElement) {
                peTtmElement.textContent = formatValue(stockData['å¸‚ç›ˆç‡-åŠ¨æ€'], 'ratio');
            }
            
            // æ›´æ–°å¸‚å‡€ç‡ï¼ˆä»å®æ—¶æ•°æ®è·å–ï¼‰
            if (stockData['å¸‚å‡€ç‡'] && pbElement) {
                pbElement.textContent = formatValue(stockData['å¸‚å‡€ç‡'], 'ratio');
            }
            
            // æ›´æ–°æ€»å¸‚å€¼ï¼ˆä»å®æ—¶æ•°æ®è·å–ï¼‰
            if (stockData['æ€»å¸‚å€¼'] && totalMvElement) {
                totalMvElement.textContent = formatValue(stockData['æ€»å¸‚å€¼'], 'large_number');
            }
            
            // æ›´æ–°æµé€šå¸‚å€¼ï¼ˆä»å®æ—¶æ•°æ®è·å–ï¼‰
            if (stockData['æµé€šå¸‚å€¼'] && circMvElement) {
                circMvElement.textContent = formatValue(stockData['æµé€šå¸‚å€¼'], 'large_number');
            }
            
            console.log('[æ¯æ—¥æŒ‡æ ‡] å·²ä½¿ç”¨å®æ—¶äº¤æ˜“æ•°æ®æ›´æ–°æ¯æ—¥æŒ‡æ ‡');
        }

        // æ˜¾ç¤ºé”™è¯¯
        function showError(message) {
            document.getElementById('errorDiv').textContent = message;
            document.getElementById('errorDiv').style.display = 'block';
            hideLoading();
        }

        // æ˜¾ç¤º/éšè—å…ƒç´ 
        function hideLoading() {
            document.getElementById('loadingDiv').style.display = 'none';
        }

        function showContent() {
            document.getElementById('contentDiv').style.display = 'block';
        }

        function showChartLoading(show) {
            document.getElementById('chartLoading').style.display = show ? 'block' : 'none';
        }

        // æŠ€æœ¯æŒ‡æ ‡ç›¸å…³å‡½æ•°
        window.indicatorData = null;

        // æµ‹è¯•åŠ è½½æŠ€æœ¯æŒ‡æ ‡æ•°æ®ï¼ˆè°ƒè¯•ç”¨ï¼‰
        function testLoadIndicators() {
            console.log('=== æ‰‹åŠ¨æµ‹è¯•æŠ€æœ¯æŒ‡æ ‡åŠ è½½ ===');
            console.log('å½“å‰è‚¡ç¥¨ä»£ç :', currentStockCode);
            console.log('å¼€å§‹è°ƒç”¨loadIndicatorDataå‡½æ•°...');
            loadIndicatorData();
        }

        // åŠ è½½æŠ€æœ¯æŒ‡æ ‡æ•°æ®
        async function loadIndicatorData() {
            try {
                // æ˜¾ç¤ºå›¾è¡¨åŠ è½½çŠ¶æ€
                showChartLoading(true);
                
                console.log('å¼€å§‹åŠ è½½æŠ€æœ¯æŒ‡æ ‡æ•°æ®ï¼Œè‚¡ç¥¨ä»£ç :', currentStockCode);
                const response = await fetch(`/api/kline/indicators/${currentStockCode}?indicators=macd,kdj,rsi&limit=200`);
                console.log('APIå“åº”çŠ¶æ€:', response.status);
                
                const result = await response.json();
                console.log('APIå“åº”æ•°æ®:', result);
                
                if (!result.success) {
                    throw new Error(result.message || result.error || 'è·å–æŠ€æœ¯æŒ‡æ ‡æ•°æ®å¤±è´¥');
                }
                
                window.indicatorData = result.data;
                console.log('æŠ€æœ¯æŒ‡æ ‡æ•°æ®:', window.indicatorData);
                
                // ç»˜åˆ¶æ‰€æœ‰æŠ€æœ¯æŒ‡æ ‡
                drawAllIndicatorCharts();
                
            } catch (error) {
                console.error('æŠ€æœ¯æŒ‡æ ‡æ•°æ®åŠ è½½å¤±è´¥:', error);
                showIndicatorError('æŠ€æœ¯æŒ‡æ ‡æ•°æ®åŠ è½½å¤±è´¥: ' + error.message);
            } finally {
                // éšè—å›¾è¡¨åŠ è½½çŠ¶æ€
                showChartLoading(false);
            }
        }

        // ç»˜åˆ¶æ‰€æœ‰æŠ€æœ¯æŒ‡æ ‡å›¾è¡¨
        function drawAllIndicatorCharts() {
            console.log('å¼€å§‹ç»˜åˆ¶æŠ€æœ¯æŒ‡æ ‡å›¾è¡¨');
            console.log('indicatorData:', window.indicatorData);
            
            if (!window.indicatorData || !window.indicatorData.kline_data) {
                console.error('æŠ€æœ¯æŒ‡æ ‡æ•°æ®ä¸ºç©ºæˆ–ç¼ºå°‘kline_data');
                showIndicatorError('æŠ€æœ¯æŒ‡æ ‡æ•°æ®ä¸ºç©º');
                return;
            }
            
            let klineData = window.indicatorData.kline_data;
            console.log('åŸå§‹Kçº¿æ•°æ®é•¿åº¦:', klineData.length);
            
            // åº”ç”¨ä¸Kçº¿å›¾ç›¸åŒçš„æ˜¾ç¤ºèŒƒå›´è¿‡æ»¤
            if (currentDisplayRange > 0 && klineData.length > currentDisplayRange) {
                klineData = klineData.slice(-currentDisplayRange);
                console.log('åº”ç”¨æ˜¾ç¤ºèŒƒå›´è¿‡æ»¤åçš„æ•°æ®é•¿åº¦:', klineData.length);
            }
            
            console.log('Kçº¿æ•°æ®æ ·ä¾‹:', klineData.slice(0, 2));
            
            const dates = klineData.map(item => item.trade_date); // ä½¿ç”¨åŸå§‹æ—¥æœŸæ ¼å¼ï¼Œä¸Kçº¿å›¾ä¿æŒä¸€è‡´
            
            const config = {
                displayModeBar: false,
                responsive: true
            };
            
            // è·å–Kçº¿å›¾çš„å®é™…å®½åº¦ä½œä¸ºå‚è€ƒ
            const candlestickElement = document.getElementById('candlestickChart');
            const referenceWidth = candlestickElement ? candlestickElement.offsetWidth : null;
            console.log('Kçº¿å›¾å‚è€ƒå®½åº¦:', referenceWidth);
            
            // å¼ºåˆ¶è®¾ç½®æŠ€æœ¯æŒ‡æ ‡å›¾è¡¨å®¹å™¨å®½åº¦
            const indicatorChartIds = ['macdChart', 'kdjChart', 'rsiChart'];
            indicatorChartIds.forEach(chartId => {
                const element = document.getElementById(chartId);
                if (element && referenceWidth) {
                    element.style.width = referenceWidth + 'px';
                    console.log(`è®¾ç½®${chartId}å®½åº¦ä¸º:`, referenceWidth + 'px');
                }
            });
            
            // ç»˜åˆ¶æ‰€æœ‰æŒ‡æ ‡
            console.log('å¼€å§‹ç»˜åˆ¶MACDå›¾è¡¨');
            drawMACDChart(dates, klineData, config);
            console.log('å¼€å§‹ç»˜åˆ¶KDJå›¾è¡¨');
            drawKDJChart(dates, klineData, config);
            console.log('å¼€å§‹ç»˜åˆ¶RSIå›¾è¡¨');
            drawRSIChart(dates, klineData, config);
            console.log('æ‰€æœ‰æŠ€æœ¯æŒ‡æ ‡å›¾è¡¨ç»˜åˆ¶å®Œæˆ');
            
            // å¼ºåˆ¶é‡ç»˜ä»¥ç¡®ä¿å¯¹é½ - å»¶è¿Ÿæ‰§è¡Œä»¥ç¡®ä¿DOMå®Œå…¨æ¸²æŸ“
            setTimeout(() => {
                console.log('æ‰§è¡ŒæŠ€æœ¯æŒ‡æ ‡å›¾è¡¨å¼ºåˆ¶é‡ç»˜');
                Plotly.Plots.resize('macdChart');
                Plotly.Plots.resize('kdjChart');
                Plotly.Plots.resize('rsiChart');
                console.log('æŠ€æœ¯æŒ‡æ ‡å›¾è¡¨å¼ºåˆ¶é‡ç»˜å®Œæˆ');
                
                // æ ‡è®°æŠ€æœ¯æŒ‡æ ‡å›¾è¡¨æ¸²æŸ“å®Œæˆ
                markChartRendered('macdChart');
                markChartRendered('kdjChart');
                markChartRendered('rsiChart');
            }, 100);
        }

        // ç»˜åˆ¶MACDå›¾è¡¨
        function drawMACDChart(dates, klineData, config) {
            const macdDif = klineData.map(item => item.macd_dif || 0);
            const macdDea = klineData.map(item => item.macd_dea || 0);
            const macdHistogram = klineData.map(item => item.macd_histogram || 0);
            
            const formattedDates = dates.map(date => formatChartDate(date)); // æ ¼å¼åŒ–æ—¥æœŸç”¨äºæ˜¾ç¤º
            
            const traces = [
                {
                    x: dates,
                    y: macdDif,
                    type: 'scatter',
                    mode: 'lines',
                    name: 'DIF',
                    line: { color: '#2196F3', width: 2 },
                    hovertemplate: '<b>DIF</b><br>æ—¥æœŸ: %{x}<br>å€¼: %{y:.4f}<extra></extra>'
                },
                {
                    x: dates,
                    y: macdDea,
                    type: 'scatter',
                    mode: 'lines',
                    name: 'DEA',
                    line: { color: '#FF9800', width: 2 },
                    hovertemplate: '<b>DEA</b><br>æ—¥æœŸ: %{x}<br>å€¼: %{y:.4f}<extra></extra>'
                },
                {
                    x: dates,
                    y: macdHistogram,
                    type: 'bar',
                    name: 'MACD',
                    marker: {
                        color: macdHistogram.map(val => val >= 0 ? '#ff4444' : '#00aa00'),
                        opacity: 0.7
                    },
                    hovertemplate: '<b>MACD</b><br>æ—¥æœŸ: %{x}<br>å€¼: %{y:.4f}<extra></extra>'
                }
            ];
            
            const layout = {
                xaxis: {
                    type: 'category',
                    showgrid: true,
                    gridcolor: '#f0f0f0',
                    categoryorder: 'array',
                    categoryarray: dates,
                    range: [-0.5, dates.length - 0.5],
                    showticklabels: false // éšè—æ—¥æœŸæ ‡ç­¾
                },
                yaxis: {
                    title: 'MACD',
                    showgrid: true,
                    gridcolor: '#f0f0f0',
                    zeroline: true,
                    zerolinecolor: '#666',
                    zerolinewidth: 1
                },
                plot_bgcolor: 'white',
                paper_bgcolor: 'white',
                font: { family: 'Arial, sans-serif', size: 12 },
                margin: { l: 50, r: 20, t: 20, b: 40 },
                showlegend: false
            };
            
            // ç»˜åˆ¶MACDå›¾
            Plotly.newPlot('macdChart', traces, layout, config);
        }

        // ç»˜åˆ¶KDJå›¾è¡¨
        function drawKDJChart(dates, klineData, config) {
            const kdjK = klineData.map(item => item.kdj_k || 0);
            const kdjD = klineData.map(item => item.kdj_d || 0);
            const kdjJ = klineData.map(item => item.kdj_j || 0);
            
            const formattedDates = dates.map(date => formatChartDate(date)); // æ ¼å¼åŒ–æ—¥æœŸç”¨äºæ˜¾ç¤º
            
            const traces = [
                {
                    x: dates,
                    y: kdjK,
                    type: 'scatter',
                    mode: 'lines',
                    name: 'Kçº¿',
                    line: { color: '#FF9800', width: 2 },
                    hovertemplate: '<b>Kçº¿</b><br>æ—¥æœŸ: %{x}<br>å€¼: %{y:.2f}<extra></extra>'
                },
                {
                    x: dates,
                    y: kdjD,
                    type: 'scatter',
                    mode: 'lines',
                    name: 'Dçº¿',
                    line: { color: '#2196F3', width: 2 },
                    hovertemplate: '<b>Dçº¿</b><br>æ—¥æœŸ: %{x}<br>å€¼: %{y:.2f}<extra></extra>'
                },
                {
                    x: dates,
                    y: kdjJ,
                    type: 'scatter',
                    mode: 'lines',
                    name: 'Jçº¿',
                    line: { color: '#f44336', width: 2 },
                    hovertemplate: '<b>Jçº¿</b><br>æ—¥æœŸ: %{x}<br>å€¼: %{y:.2f}<extra></extra>'
                }
            ];
            
            const layout = {
                xaxis: {
                    type: 'category',
                    showgrid: true,
                    gridcolor: '#f0f0f0',
                    categoryorder: 'array',
                    categoryarray: dates,
                    range: [-0.5, dates.length - 0.5],
                    showticklabels: false // éšè—æ—¥æœŸæ ‡ç­¾
                },
                yaxis: {
                    title: 'KDJ',
                    showgrid: true,
                    gridcolor: '#f0f0f0',
                    range: [0, 100],
                    tickvals: [20, 50, 80],
                    ticktext: ['è¶…å–åŒº', '50', 'è¶…ä¹°åŒº']
                },
                plot_bgcolor: 'white',
                paper_bgcolor: 'white',
                font: { family: 'Arial, sans-serif', size: 12 },
                margin: { l: 50, r: 20, t: 20, b: 40 },
                showlegend: false,
                shapes: [
                    // è¶…ä¹°åŒºåŸŸèƒŒæ™¯ï¼ˆçº¢è‰²ï¼‰
                    {
                        type: 'rect',
                        x0: 0, x1: 1, xref: 'paper',
                        y0: 80, y1: 100,
                        fillcolor: 'rgba(244, 67, 54, 0.1)',
                        line: { width: 0 },
                        layer: 'below'
                    },
                    // è¶…å–åŒºåŸŸèƒŒæ™¯ï¼ˆç»¿è‰²ï¼‰
                    {
                        type: 'rect',
                        x0: 0, x1: 1, xref: 'paper',
                        y0: 0, y1: 20,
                        fillcolor: 'rgba(76, 175, 80, 0.1)',
                        line: { width: 0 },
                        layer: 'below'
                    },
                    // è¶…ä¹°çº¿ï¼ˆå®çº¿ï¼‰
                    {
                        type: 'line',
                        x0: 0, x1: 1, xref: 'paper',
                        y0: 80, y1: 80,
                        line: { color: '#f44336', width: 2 }
                    },
                    // è¶…å–çº¿ï¼ˆå®çº¿ï¼‰
                    {
                        type: 'line',
                        x0: 0, x1: 1, xref: 'paper',
                        y0: 20, y1: 20,
                        line: { color: '#4caf50', width: 2 }
                    }
                ],
                annotations: [
                    // è¶…ä¹°æ ‡æ³¨
                    {
                        x: 0.95,
                        y: 90,
                        xref: 'paper',
                        yref: 'y',
                        text: 'è¶…ä¹°',
                        showarrow: false,
                        font: {
                            color: '#f44336',
                            size: 12,
                            family: 'Arial, sans-serif'
                        },
                        bgcolor: 'rgba(255, 255, 255, 0.8)',
                        bordercolor: '#f44336',
                        borderwidth: 1
                    },
                    // è¶…å–æ ‡æ³¨
                    {
                        x: 0.95,
                        y: 10,
                        xref: 'paper',
                        yref: 'y',
                        text: 'è¶…å–',
                        showarrow: false,
                        font: {
                            color: '#4caf50',
                            size: 12,
                            family: 'Arial, sans-serif'
                        },
                        bgcolor: 'rgba(255, 255, 255, 0.8)',
                        bordercolor: '#4caf50',
                        borderwidth: 1
                    }
                ]
            };
            
            // ç»˜åˆ¶KDJå›¾
            Plotly.newPlot('kdjChart', traces, layout, config);
        }

        // ç»˜åˆ¶RSIå›¾è¡¨
        function drawRSIChart(dates, klineData, config) {
            const rsiValues = klineData.map(item => item.rsi || 50);
            
            const formattedDates = dates.map(date => formatChartDate(date)); // æ ¼å¼åŒ–æ—¥æœŸç”¨äºæ˜¾ç¤º
            
            const traces = [
                {
                    x: dates,
                    y: rsiValues,
                    type: 'scatter',
                    mode: 'lines',
                    name: 'RSI',
                    line: { color: '#9c27b0', width: 2 },
                    fill: 'tonexty',
                    fillcolor: 'rgba(156, 39, 176, 0.1)',
                    hovertemplate: '<b>RSI</b><br>æ—¥æœŸ: %{x}<br>å€¼: %{y:.2f}<extra></extra>'
                }
            ];
            
            const layout = {
                xaxis: {
                    type: 'category',
                    showgrid: true,
                    gridcolor: '#f0f0f0',
                    categoryorder: 'array',
                    categoryarray: dates,
                    range: [-0.5, dates.length - 0.5],
                    showticklabels: false // éšè—æ—¥æœŸæ ‡ç­¾
                },
                yaxis: {
                    title: 'RSI',
                    showgrid: true,
                    gridcolor: '#f0f0f0',
                    range: [0, 100],
                    tickvals: [30, 50, 70],
                    ticktext: ['è¶…å–åŒº', '50', 'è¶…ä¹°åŒº']
                },
                plot_bgcolor: 'white',
                paper_bgcolor: 'white',
                font: { family: 'Arial, sans-serif', size: 12 },
                margin: { l: 50, r: 20, t: 20, b: 40 },
                showlegend: false,
                shapes: [
                    // è¶…ä¹°åŒºåŸŸèƒŒæ™¯ï¼ˆçº¢è‰²ï¼‰
                    {
                        type: 'rect',
                        x0: 0, x1: 1, xref: 'paper',
                        y0: 70, y1: 100,
                        fillcolor: 'rgba(244, 67, 54, 0.1)',
                        line: { width: 0 },
                        layer: 'below'
                    },
                    // è¶…å–åŒºåŸŸèƒŒæ™¯ï¼ˆç»¿è‰²ï¼‰
                    {
                        type: 'rect',
                        x0: 0, x1: 1, xref: 'paper',
                        y0: 0, y1: 30,
                        fillcolor: 'rgba(76, 175, 80, 0.1)',
                        line: { width: 0 },
                        layer: 'below'
                    },
                    // è¶…ä¹°çº¿
                    {
                        type: 'line',
                        x0: 0, x1: 1, xref: 'paper',
                        y0: 70, y1: 70,
                        line: { color: '#f44336', width: 1, dash: 'dash' }
                    },
                    // è¶…å–çº¿
                    {
                        type: 'line',
                        x0: 0, x1: 1, xref: 'paper',
                        y0: 30, y1: 30,
                        line: { color: '#4caf50', width: 1, dash: 'dash' }
                    }
                ],
                annotations: [
                    // è¶…ä¹°æ ‡æ³¨
                    {
                        x: 0.95,
                        y: 85,
                        xref: 'paper',
                        yref: 'y',
                        text: 'è¶…ä¹°',
                        showarrow: false,
                        font: {
                            color: '#f44336',
                            size: 12,
                            family: 'Arial, sans-serif'
                        },
                        bgcolor: 'rgba(255, 255, 255, 0.8)',
                        bordercolor: '#f44336',
                        borderwidth: 1
                    },
                    // è¶…å–æ ‡æ³¨
                    {
                        x: 0.95,
                        y: 15,
                        xref: 'paper',
                        yref: 'y',
                        text: 'è¶…å–',
                        showarrow: false,
                        font: {
                            color: '#4caf50',
                            size: 12,
                            family: 'Arial, sans-serif'
                        },
                        bgcolor: 'rgba(255, 255, 255, 0.8)',
                        bordercolor: '#4caf50',
                        borderwidth: 1
                    }
                ]
            };
            
            // ç»˜åˆ¶RSIå›¾
            Plotly.newPlot('rsiChart', traces, layout, config);
        }

        // ==================== åˆ†æ—¶å›¾ç›¸å…³å‡½æ•° ====================
        
        // åŠ è½½åˆ†æ—¶å›¾æ•°æ®
        async function loadIntradayChart(showLoading = true) {
            try {
                // åªåœ¨é¦–æ¬¡åŠ è½½æˆ–æ‰‹åŠ¨åˆ·æ–°æ—¶æ˜¾ç¤ºåŠ è½½çŠ¶æ€
                if (showLoading) {
                    showIntradayLoading(true);
                }
                
                console.log('å¼€å§‹åŠ è½½åˆ†æ—¶å›¾æ•°æ®ï¼Œè‚¡ç¥¨ä»£ç :', currentStockCode);
                const response = await fetch(`/api/stock/${currentStockCode}/intraday?period=1&adjust=qfq`);
                console.log('åˆ†æ—¶å›¾APIå“åº”çŠ¶æ€:', response.status);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const result = await response.json();
                console.log('åˆ†æ—¶å›¾APIå“åº”æ•°æ®:', result);
                
                if (!result.success) {
                    throw new Error(result.error || 'è·å–åˆ†æ—¶å›¾æ•°æ®å¤±è´¥');
                }
                
                // æ£€æŸ¥æ˜¯å¦ä¸ºæ¨¡æ‹Ÿæ•°æ®
                if (result.is_simulated) {
                    console.log('æ˜¾ç¤ºæ¨¡æ‹Ÿåˆ†æ—¶æ•°æ®:', result.message);
                    // æ˜¾ç¤ºæ¨¡æ‹Ÿæ•°æ®æç¤º
                    showIntradaySimulatedNotice(result.message);
                }
                
                displayIntradayChart(result.data, result.is_simulated);
                
            } catch (error) {
                console.error('åˆ†æ—¶å›¾æ•°æ®åŠ è½½å¤±è´¥:', error);
                // åªåœ¨æ˜¾ç¤ºåŠ è½½çŠ¶æ€æ—¶æ‰æ˜¾ç¤ºé”™è¯¯ï¼Œé¿å…è‡ªåŠ¨åˆ·æ–°æ—¶è¦†ç›–ç°æœ‰å›¾è¡¨
                if (showLoading) {
                    showIntradayError('åˆ†æ—¶å›¾æ•°æ®åŠ è½½å¤±è´¥: ' + error.message);
                }
            } finally {
                if (showLoading) {
                    showIntradayLoading(false);
                }
            }
        }

        // åˆ·æ–°åˆ†æ—¶å›¾æ•°æ®
        async function refreshIntradayChart() {
            const refreshBtn = document.getElementById('intradayRefreshBtn');
            refreshBtn.disabled = true;
            refreshBtn.textContent = 'åˆ·æ–°ä¸­...';
            
            try {
                await loadIntradayChart();
                // åˆ·æ–°å®Œæˆåå¼ºåˆ¶é‡æ–°è®¾ç½®å›¾è¡¨åŒæ­¥æœºåˆ¶
                setTimeout(() => {
                    forceSetupChartSync();
                }, 200);
            } finally {
                refreshBtn.disabled = false;
                refreshBtn.textContent = 'åˆ·æ–°';
            }
        }

        // æ˜¾ç¤ºåˆ†æ—¶å›¾
        function displayIntradayChart(data, isSimulated = false) {
            if (!data || data.length === 0) {
                showIntradayError('æš‚æ— åˆ†æ—¶å›¾æ•°æ®');
                return;
            }

            // å¦‚æœä¸æ˜¯æ¨¡æ‹Ÿæ•°æ®ï¼Œéšè—æ¨¡æ‹Ÿæ•°æ®æç¤º
            if (!isSimulated) {
                hideIntradaySimulatedNotice();
            }

            console.log('åˆ†æ—¶å›¾æ•°æ®é•¿åº¦:', data.length);
            console.log('åˆ†æ—¶å›¾æ•°æ®æ ·ä¾‹:', data.slice(0, 3));

            // åˆ†ç¦»ä¸Šåˆå’Œä¸‹åˆçš„æ•°æ®
            const morningData = [];
            const afternoonData = [];
            
            data.forEach(item => {
                const timeStr = item.time;
                const hourMinute = timeStr.replace(':', '');
                const hourMinuteInt = parseInt(hourMinute);
                
                if (hourMinuteInt >= 930 && hourMinuteInt <= 1130) {
                    morningData.push(item);
                } else if (hourMinuteInt >= 1300 && hourMinuteInt <= 1500) {
                    afternoonData.push(item);
                }
            });

            console.log('ä¸Šåˆæ•°æ®é•¿åº¦:', morningData.length, 'ä¸‹åˆæ•°æ®é•¿åº¦:', afternoonData.length);

            // å®šä¹‰å®Œæ•´çš„äº¤æ˜“æ—¶é—´æ¡†æ¶
            const MORNING_MINUTES = 120; // ä¸Šåˆäº¤æ˜“æ—¶é—´ï¼š09:30-11:30 (120åˆ†é’Ÿ)
            const AFTERNOON_MINUTES = 120; // ä¸‹åˆäº¤æ˜“æ—¶é—´ï¼š13:00-15:00 (120åˆ†é’Ÿ)
            const TOTAL_MINUTES = MORNING_MINUTES + AFTERNOON_MINUTES;

            // åˆ›å»ºå®Œæ•´çš„æ—¶é—´è½´ï¼ˆå§‹ç»ˆåŒ…å«ä¸Šåˆå’Œä¸‹åˆï¼‰
            const allTimes = [];
            const allPrices = [];
            const allVolumes = [];
            const allVwaps = [];
            const allAvgPrices = [];  // æ–°å¢ï¼šå‡ä»·çº¿æ•°æ®
            const timeLabels = [];
            
            // ç”Ÿæˆå®Œæ•´çš„æ—¶é—´æ ‡ç­¾
            const generateTimeLabels = () => {
                const labels = [];
                // ä¸Šåˆæ—¶é—´ï¼š09:30-11:30
                for (let i = 0; i < MORNING_MINUTES; i++) {
                    const totalMinutes = 9 * 60 + 30 + i; // ä»09:30å¼€å§‹
                    const hours = Math.floor(totalMinutes / 60);
                    const minutes = totalMinutes % 60;
                    labels.push(`${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}`);
                }
                // ä¸‹åˆæ—¶é—´ï¼š13:00-15:00
                for (let i = 0; i < AFTERNOON_MINUTES; i++) {
                    const totalMinutes = 13 * 60 + i; // ä»13:00å¼€å§‹
                    const hours = Math.floor(totalMinutes / 60);
                    const minutes = totalMinutes % 60;
                    labels.push(`${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}`);
                }
                return labels;
            };

            const fullTimeLabels = generateTimeLabels();

            // åˆ›å»ºæ•°æ®æ˜ å°„
            const dataMap = new Map();
            [...morningData, ...afternoonData].forEach(item => {
                dataMap.set(item.time, item);
            });

            // å¡«å……å®Œæ•´çš„æ—¶é—´è½´æ•°æ®
            for (let i = 0; i < TOTAL_MINUTES; i++) {
                allTimes.push(i);
                const timeLabel = fullTimeLabels[i];
                timeLabels.push(timeLabel);
                
                const dataItem = dataMap.get(timeLabel);
                if (dataItem) {
                    // æœ‰å®é™…æ•°æ®
                    allPrices.push(dataItem.price);
                    // è®¡ç®—æˆäº¤é¢ï¼šæˆäº¤é‡ * ä»·æ ¼ / 10000 (è½¬æ¢ä¸ºä¸‡å…ƒ)
                    const turnover = (dataItem.volume * dataItem.price) / 10000;
                    allVolumes.push(turnover);
                    allVwaps.push(dataItem.vwap);
                    allAvgPrices.push(dataItem.avg_price || dataItem.price);  // æ–°å¢ï¼šå‡ä»·çº¿æ•°æ®
                } else {
                    // æ²¡æœ‰æ•°æ®çš„æ—¶é—´ç‚¹ï¼ˆä¸‹åˆæœªå¼€å§‹äº¤æ˜“ï¼‰
                    allPrices.push(null);
                    allVolumes.push(0);
                    allVwaps.push(null);
                    allAvgPrices.push(null);  // æ–°å¢ï¼šå‡ä»·çº¿æ•°æ®
                }
            }

            // è®¡ç®—ä»·æ ¼èŒƒå›´ï¼ˆÂ±5%ï¼‰
            const validPrices = allPrices.filter(p => p !== null);
            const firstPrice = validPrices[0];
            const priceRange = firstPrice * 0.05;
            const yMin = firstPrice - priceRange;
            const yMax = firstPrice + priceRange;

            // åŠ¨æ€è®¡ç®—Yè½´åˆ»åº¦é—´éš”
            let tickInterval;
            if (firstPrice < 5) {
                tickInterval = 0.1;  // 5å…ƒä»¥ä¸‹ï¼Œ0.1å…ƒé—´éš”
            } else if (firstPrice < 20) {
                tickInterval = 0.2;  // 5-20å…ƒï¼Œ0.2å…ƒé—´éš”
            } else if (firstPrice < 50) {
                tickInterval = 0.5;  // 20-50å…ƒï¼Œ0.5å…ƒé—´éš”
            } else if (firstPrice < 100) {
                tickInterval = 1.0;  // 50-100å…ƒï¼Œ1å…ƒé—´éš”
            } else {
                tickInterval = 2.0;  // 100å…ƒä»¥ä¸Šï¼Œ2å…ƒé—´éš”
            }

            // åˆ›å»ºåˆ†æ—¶å›¾
            const priceTrace = {
                x: allTimes,
                y: allPrices,
                type: 'scatter',
                mode: 'lines',
                name: 'åˆ†æ—¶ä»·æ ¼',
                line: {
                    color: '#2196F3',
                    width: 2
                },
                fill: 'tonexty',
                fillcolor: 'rgba(33, 150, 243, 0.1)',
                connectgaps: false, // ä¸è¿æ¥nullå€¼ï¼Œä¿æŒåˆä¼‘æ—¶æ®µçš„æ–­å¼€
                hovertemplate: '<b>åˆ†æ—¶ä»·æ ¼</b><br>æ—¶é—´: %{text}<br>ä»·æ ¼: Â¥%{y:.2f}<extra></extra>',
                text: timeLabels
            };

            const vwapTrace = {
                x: allTimes,
                y: allVwaps,
                type: 'scatter',
                mode: 'lines',
                name: 'VWAPå‡ä»·',
                line: {
                    color: '#FF9800',
                    width: 1,
                    dash: 'dash'
                },
                connectgaps: false, // ä¸è¿æ¥nullå€¼
                hovertemplate: '<b>VWAPå‡ä»·</b><br>æ—¶é—´: %{text}<br>ä»·æ ¼: Â¥%{y:.2f}<extra></extra>',
                text: timeLabels
            };

            // æ–°å¢ï¼šé»„è‰²å‡ä»·çº¿
            const avgPriceTrace = {
                x: allTimes,
                y: allAvgPrices,
                type: 'scatter',
                mode: 'lines',
                name: 'å‡ä»·çº¿',
                line: {
                    color: '#FFD700',  // é»„è‰²
                    width: 2
                },
                connectgaps: false, // ä¸è¿æ¥nullå€¼
                hovertemplate: '<b>å‡ä»·çº¿</b><br>æ—¶é—´: %{text}<br>ä»·æ ¼: Â¥%{y:.2f}<extra></extra>',
                text: timeLabels
            };

            // åˆ›å»ºæ—¶é—´è½´åˆ»åº¦ï¼ˆå§‹ç»ˆæ˜¾ç¤ºå®Œæ•´çš„äº¤æ˜“æ—¶é—´æ¡†æ¶ï¼‰
            const tickvals = [];
            const ticktext = [];
            
            // ä¸Šåˆæ—¶é—´ç‚¹
            tickvals.push(0); // 09:30 å¼€ç›˜
            ticktext.push('09:30');
            
            tickvals.push(60); // 10:30 ä¸Šåˆä¸­ç‚¹
            ticktext.push('10:30');
            
            tickvals.push(MORNING_MINUTES - 1); // 11:30 ä¸Šåˆæ”¶ç›˜
            ticktext.push('11:30');
            
            // ä¸‹åˆæ—¶é—´ç‚¹
            tickvals.push(MORNING_MINUTES); // 13:00 ä¸‹åˆå¼€ç›˜
            ticktext.push('13:00');
            
            tickvals.push(MORNING_MINUTES + 60); // 14:00 ä¸‹åˆä¸­ç‚¹
            ticktext.push('14:00');
            
            tickvals.push(TOTAL_MINUTES - 1); // 15:00 æ”¶ç›˜
            ticktext.push('15:00');

            const priceLayout = {
                xaxis: {
                    showgrid: true,
                    gridcolor: '#f0f0f0',
                    tickvals: tickvals,
                    ticktext: ticktext,
                    range: [-0.5, TOTAL_MINUTES - 0.5], // å§‹ç»ˆæ˜¾ç¤ºå®Œæ•´çš„äº¤æ˜“æ—¶é—´æ¡†æ¶
                    showticklabels: false, // éšè—æ—¶é—´æ ‡æ³¨
                    zeroline: false
                },
                yaxis: {
                    title: 'ä»·æ ¼ (å…ƒ)',
                    showgrid: true,
                    gridcolor: '#f0f0f0',
                    range: [yMin, yMax],
                    tickformat: '.2f',
                    dtick: tickInterval  // ä½¿ç”¨åŠ¨æ€è®¡ç®—çš„åˆ»åº¦é—´éš”
                },
                plot_bgcolor: 'white',
                paper_bgcolor: 'white',
                font: { family: 'Arial, sans-serif', size: 12 },
                margin: { l: 60, r: 20, t: 50, b: 80 },
                showlegend: true,
                legend: {
                    x: 0,
                    y: 1,
                    bgcolor: 'rgba(255, 255, 255, 0.8)',
                    bordercolor: '#ddd',
                    borderwidth: 1
                }
            };

            const config = {
                displayModeBar: false,
                responsive: true
            };

            // ç»˜åˆ¶åˆ†æ—¶å›¾
            Plotly.newPlot('intradayChart', [priceTrace, vwapTrace, avgPriceTrace], priceLayout, config);

            // è®¡ç®—æˆäº¤é¢çš„æ˜¾ç¤ºèŒƒå›´
            const validVolumes = allVolumes.filter(vol => vol > 0);
            const maxVolume = validVolumes.length > 0 ? Math.max(...validVolumes) : 100;
            const volumeYMax = maxVolume * 1.05; // åªå¢åŠ 5%çš„ä¸Šè¾¹è·ï¼Œè®©æŸ±çŠ¶å›¾å ç”¨æ›´å¤šç©ºé—´

            // åˆ›å»ºæˆäº¤é¢å›¾
            const volumeTrace = {
                x: allTimes,
                y: allVolumes,
                type: 'bar',
                name: 'æˆäº¤é¢',
                marker: {
                    color: allVolumes.map((vol, index) => {
                        if (index === 0) return '#666';
                        const currentPrice = allPrices[index];
                        const prevPrice = allPrices[index - 1];
                        return currentPrice >= prevPrice ? '#ff4444' : '#00aa00';
                    })
                },
                hovertemplate: '<b>æˆäº¤é¢</b><br>æ—¶é—´: %{text}<br>æˆäº¤é¢: %{y:.2f}ä¸‡å…ƒ<extra></extra>',
                text: timeLabels
            };

            const volumeLayout = {
                xaxis: {
                    showgrid: true,
                    gridcolor: '#f0f0f0',
                    tickvals: tickvals,
                    ticktext: ticktext,
                    range: [-0.5, TOTAL_MINUTES - 0.5], // å§‹ç»ˆæ˜¾ç¤ºå®Œæ•´çš„äº¤æ˜“æ—¶é—´æ¡†æ¶
                    showticklabels: false, // éšè—æ—¶é—´æ ‡æ³¨
                    zeroline: false
                },
                yaxis: {
                    title: 'æˆäº¤é¢ (ä¸‡å…ƒ)',
                    showgrid: true,
                    gridcolor: '#f0f0f0',
                    range: [0, volumeYMax] // è®¾ç½®Yè½´èŒƒå›´ï¼Œè®©æŸ±çŠ¶å›¾æ˜¾ç¤ºå¾—æ›´é«˜
                },
                plot_bgcolor: 'white',
                paper_bgcolor: 'white',
                font: { family: 'Arial, sans-serif', size: 12 },
                margin: { l: 60, r: 20, t: 20, b: 40 }, // å‡å°‘ä¸Šä¸‹è¾¹è·ï¼Œè®©æŸ±çŠ¶å›¾å ç”¨æ›´å¤šç©ºé—´
                showlegend: false
            };

            // ç»˜åˆ¶æˆäº¤é‡å›¾
            Plotly.newPlot('intradayVolumeChart', [volumeTrace], volumeLayout, config);

            // æ ‡è®°å›¾è¡¨æ¸²æŸ“å®Œæˆ
            markChartRendered('intradayChart');
            markChartRendered('intradayVolumeChart');

            // æ˜¾ç¤ºå›¾è¡¨ï¼Œéšè—é”™è¯¯ä¿¡æ¯
            document.getElementById('intradayChartContainer').style.display = 'block';
            document.getElementById('intradayError').style.display = 'none';
            
            // æ›´æ–°æ—¶é—´æˆ³
            updateIntradayTimestamp();
        }

        // æ˜¾ç¤º/éšè—åˆ†æ—¶å›¾åŠ è½½çŠ¶æ€
        function showIntradayLoading(show) {
            document.getElementById('intradayLoading').style.display = show ? 'block' : 'none';
        }

        // æ˜¾ç¤ºåˆ†æ—¶å›¾é”™è¯¯
        function showIntradayError(message) {
            document.getElementById('intradayError').textContent = message;
            document.getElementById('intradayError').style.display = 'block';
            document.getElementById('intradayChartContainer').style.display = 'none';
        }

        // æ˜¾ç¤ºåˆ†æ—¶å›¾æ¨¡æ‹Ÿæ•°æ®æç¤º
        function showIntradaySimulatedNotice(message) {
            // åˆ›å»ºæˆ–æ›´æ–°æ¨¡æ‹Ÿæ•°æ®æç¤ºå…ƒç´ 
            let noticeElement = document.getElementById('intradaySimulatedNotice');
            if (!noticeElement) {
                noticeElement = document.createElement('div');
                noticeElement.id = 'intradaySimulatedNotice';
                noticeElement.style.cssText = `
                    background-color: #fff3cd;
                    border: 1px solid #ffeaa7;
                    color: #856404;
                    padding: 8px 12px;
                    margin-bottom: 10px;
                    border-radius: 4px;
                    font-size: 14px;
                    display: flex;
                    align-items: center;
                `;
                noticeElement.innerHTML = `
                    <i class="fas fa-info-circle" style="margin-right: 8px; color: #f39c12;"></i>
                    <span id="intradaySimulatedNoticeText"></span>
                `;
                
                // æ’å…¥åˆ°åˆ†æ—¶å›¾å®¹å™¨å‰é¢
                const intradaySection = document.querySelector('.chart-section h3').parentNode;
                const chartContainer = document.getElementById('intradayChartContainer');
                intradaySection.insertBefore(noticeElement, chartContainer);
            }
            
            document.getElementById('intradaySimulatedNoticeText').textContent = message;
            noticeElement.style.display = 'flex';
        }

        // éšè—åˆ†æ—¶å›¾æ¨¡æ‹Ÿæ•°æ®æç¤º
        function hideIntradaySimulatedNotice() {
            const noticeElement = document.getElementById('intradaySimulatedNotice');
            if (noticeElement) {
                noticeElement.style.display = 'none';
            }
        }

        // æ›´æ–°åˆ†æ—¶å›¾æ—¶é—´æˆ³
        function updateIntradayTimestamp() {
            const now = new Date();
            const timestamp = now.toLocaleString('zh-CN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
            document.getElementById('intradayTimestamp').textContent = `æ›´æ–°æ—¶é—´: ${timestamp}`;
        }

        // å›¾è¡¨åŒæ­¥çŠ¶æ€è·Ÿè¸ª
        let chartSyncSetup = false;
        let chartRenderStatus = {
            'candlestickChart': false,
            'volumeChart': false,
            'macdChart': false,
            'kdjChart': false,
            'rsiChart': false,
            'intradayChart': false,
            'intradayVolumeChart': false
        };

        // æ ‡è®°å›¾è¡¨æ¸²æŸ“å®Œæˆ
        function markChartRendered(chartId) {
            chartRenderStatus[chartId] = true;
            console.log(`å›¾è¡¨ ${chartId} æ¸²æŸ“å®Œæˆ`);
            
            // æ£€æŸ¥æ˜¯å¦æ‰€æœ‰ä¸»è¦å›¾è¡¨éƒ½å·²æ¸²æŸ“å®Œæˆ
            const mainCharts = ['candlestickChart', 'volumeChart', 'intradayChart', 'intradayVolumeChart'];
            const mainChartsReady = mainCharts.every(id => chartRenderStatus[id]);
            
            if (mainChartsReady && !chartSyncSetup) {
                console.log('ä¸»è¦å›¾è¡¨éƒ½å·²æ¸²æŸ“å®Œæˆï¼Œå¼€å§‹å®¹å™¨å°ºå¯¸æ£€æŸ¥å’ŒåŒæ­¥è®¾ç½®');
                
                // å»¶è¿Ÿæ‰§è¡Œï¼Œç¡®ä¿DOMå®Œå…¨æ¸²æŸ“
                setTimeout(() => {
                    // æ£€æŸ¥å¹¶è°ƒæ•´å›¾è¡¨å®¹å™¨å°ºå¯¸
                    ensureChartContainerSizes();
                    
                    // å†æ¬¡å»¶è¿Ÿè®¾ç½®åŒæ­¥æœºåˆ¶ï¼Œç¡®ä¿å®¹å™¨å°ºå¯¸è°ƒæ•´å®Œæˆ
                    setTimeout(() => {
                        setupChartSync();
                        
                        // æœ€åå¼ºåˆ¶é‡æ–°å¸ƒå±€æ‰€æœ‰å›¾è¡¨ï¼Œç¡®ä¿å¯¹é½
                        setTimeout(() => {
                            forceResizeAllCharts();
                        }, 200);
                    }, 300);
                }, 100);
            }
        }

        // ç¡®ä¿å›¾è¡¨å®¹å™¨å°ºå¯¸æ­£ç¡®
        function ensureChartContainerSizes() {
            console.log('æ£€æŸ¥å›¾è¡¨å®¹å™¨å°ºå¯¸');
            
            const chartIds = [
                'candlestickChart', 'volumeChart', 
                'macdChart', 'kdjChart', 'rsiChart',
                'intradayChart', 'intradayVolumeChart'
            ];
            
            chartIds.forEach(chartId => {
                const chartElement = document.getElementById(chartId);
                if (chartElement) {
                    const container = chartElement.parentElement;
                    const containerWidth = container.offsetWidth;
                    const containerHeight = container.offsetHeight;
                    
                    console.log(`å›¾è¡¨ ${chartId} å®¹å™¨å°ºå¯¸: ${containerWidth}x${containerHeight}`);
                    
                    // å¦‚æœå®¹å™¨å°ºå¯¸ä¸º0æˆ–è¿‡å°ï¼Œå¼ºåˆ¶è®¾ç½®æœ€å°å°ºå¯¸
                    if (containerWidth < 100) {
                        container.style.width = '100%';
                        console.log(`å¼ºåˆ¶è®¾ç½® ${chartId} å®¹å™¨å®½åº¦ä¸º100%`);
                    }
                    
                    if (containerHeight < 100) {
                        container.style.height = '300px';
                        console.log(`å¼ºåˆ¶è®¾ç½® ${chartId} å®¹å™¨é«˜åº¦ä¸º300px`);
                    }
                }
            });
        }

        // å¼ºåˆ¶é‡æ–°å¸ƒå±€æ‰€æœ‰å›¾è¡¨
        function forceResizeAllCharts() {
            console.log('å¼ºåˆ¶é‡æ–°å¸ƒå±€æ‰€æœ‰å›¾è¡¨');
            
            const chartIds = [
                'candlestickChart', 'volumeChart', 
                'macdChart', 'kdjChart', 'rsiChart',
                'intradayChart', 'intradayVolumeChart'
            ];
            
            chartIds.forEach(chartId => {
                const chartElement = document.getElementById(chartId);
                if (chartElement && chartElement._fullLayout) {
                    try {
                        // ä½¿ç”¨Plotlyçš„resizeæ–¹æ³•å¼ºåˆ¶é‡æ–°è®¡ç®—å¸ƒå±€
                        Plotly.Plots.resize(chartElement);
                        console.log(`å›¾è¡¨ ${chartId} é‡æ–°å¸ƒå±€å®Œæˆ`);
                    } catch (error) {
                        console.warn(`å›¾è¡¨ ${chartId} é‡æ–°å¸ƒå±€å¤±è´¥:`, error);
                    }
                }
            });
            
            console.log('æ‰€æœ‰å›¾è¡¨é‡æ–°å¸ƒå±€å®Œæˆ');
        }

        // è®¾ç½®å›¾è¡¨åŒæ­¥æœºåˆ¶
        function setupChartSync() {
            if (chartSyncSetup) {
                console.log('å›¾è¡¨åŒæ­¥æœºåˆ¶å·²è®¾ç½®ï¼Œè·³è¿‡é‡å¤è®¾ç½®');
                return;
            }
            
            console.log('å¼€å§‹è®¾ç½®å›¾è¡¨åŒæ­¥æœºåˆ¶');
            
            // è·å–æ‰€æœ‰å›¾è¡¨å…ƒç´ 
            const chartIds = [
                'candlestickChart', 'volumeChart', 
                'macdChart', 'kdjChart', 'rsiChart',
                'intradayChart', 'intradayVolumeChart'
            ];
            
            // æ£€æŸ¥å›¾è¡¨æ˜¯å¦å‡†å¤‡å°±ç»ª
            const readyCharts = [];
            chartIds.forEach(chartId => {
                const chartElement = document.getElementById(chartId);
                if (chartElement && chartElement._fullLayout) {
                    readyCharts.push(chartId);
                } else {
                    console.warn(`å›¾è¡¨ ${chartId} å°šæœªå‡†å¤‡å°±ç»ª`);
                }
            });
            
            console.log(`å‡†å¤‡å°±ç»ªçš„å›¾è¡¨: ${readyCharts.join(', ')}`);
            
            if (readyCharts.length < 2) {
                console.log('å‡†å¤‡å°±ç»ªçš„å›¾è¡¨æ•°é‡ä¸è¶³ï¼Œå»¶è¿Ÿé‡è¯•');
                setTimeout(() => {
                    setupChartSync();
                }, 1000);
                return;
            }
            
            // ä¸ºæ¯ä¸ªå‡†å¤‡å°±ç»ªçš„å›¾è¡¨æ·»åŠ ç¼©æ”¾å’Œå¹³ç§»äº‹ä»¶ç›‘å¬å™¨
            readyCharts.forEach(chartId => {
                const chartElement = document.getElementById(chartId);
                
                // ç§»é™¤ä¹‹å‰çš„äº‹ä»¶ç›‘å¬å™¨ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
                if (chartElement._plotlyListeners) {
                    chartElement.removeAllListeners('plotly_relayout');
                }
                
                // ç›‘å¬å›¾è¡¨çš„ç¼©æ”¾å’Œå¹³ç§»äº‹ä»¶
                chartElement.on('plotly_relayout', function(eventData) {
                    console.log(`å›¾è¡¨ ${chartId} å‘ç”Ÿå¸ƒå±€å˜åŒ–:`, eventData);
                    
                    // æ£€æŸ¥æ˜¯å¦æ˜¯xè½´èŒƒå›´å˜åŒ–
                    if (eventData['xaxis.range[0]'] !== undefined && eventData['xaxis.range[1]'] !== undefined) {
                        const newRange = [eventData['xaxis.range[0]'], eventData['xaxis.range[1]']];
                        console.log(`åŒæ­¥xè½´èŒƒå›´åˆ°å…¶ä»–å›¾è¡¨:`, newRange);
                        
                        // åŒæ­¥åˆ°å…¶ä»–å›¾è¡¨
                        readyCharts.forEach(otherChartId => {
                            if (otherChartId !== chartId) {
                                const otherChart = document.getElementById(otherChartId);
                                if (otherChart && otherChart._fullLayout) {
                                    Plotly.relayout(otherChart, {
                                        'xaxis.range': newRange
                                    }).catch(err => {
                                        console.warn(`åŒæ­¥å›¾è¡¨ ${otherChartId} å¤±è´¥:`, err);
                                    });
                                }
                            }
                        });
                    }
                    
                    // å¤„ç†è‡ªåŠ¨ç¼©æ”¾é‡ç½®
                    if (eventData['xaxis.autorange'] === true) {
                        console.log('é‡ç½®æ‰€æœ‰å›¾è¡¨çš„xè½´èŒƒå›´');
                        readyCharts.forEach(otherChartId => {
                            if (otherChartId !== chartId) {
                                const otherChart = document.getElementById(otherChartId);
                                if (otherChart && otherChart._fullLayout) {
                                    Plotly.relayout(otherChart, {
                                        'xaxis.autorange': true
                                    }).catch(err => {
                                        console.warn(`é‡ç½®å›¾è¡¨ ${otherChartId} å¤±è´¥:`, err);
                                    });
                                }
                            }
                        });
                    }
                });
            });
            
            chartSyncSetup = true;
            console.log('å›¾è¡¨åŒæ­¥æœºåˆ¶è®¾ç½®å®Œæˆ');
        }

        // å¼ºåˆ¶é‡æ–°è®¾ç½®å›¾è¡¨åŒæ­¥ï¼ˆç”¨äºåˆ·æ–°æŒ‰é’®ï¼‰
        function forceSetupChartSync() {
            console.log('å¼ºåˆ¶é‡æ–°è®¾ç½®å›¾è¡¨åŒæ­¥æœºåˆ¶');
            chartSyncSetup = false;
            setupChartSync();
        }

        // ==================== åˆ†æ—¶å›¾ç›¸å…³å‡½æ•°ç»“æŸ ====================

        // æ˜¾ç¤ºæŒ‡æ ‡é”™è¯¯
        function showIndicatorError(message) {
            console.error('æ˜¾ç¤ºæŠ€æœ¯æŒ‡æ ‡é”™è¯¯:', message);
            
            // åœ¨æ¯ä¸ªæŒ‡æ ‡å›¾è¡¨å®¹å™¨ä¸­æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
            const chartIds = ['macdChart', 'kdjChart', 'rsiChart'];
            chartIds.forEach(chartId => {
                const chartElement = document.getElementById(chartId);
                if (chartElement) {
                    chartElement.innerHTML = `<div style="padding: 20px; text-align: center; color: #dc3545; border: 1px solid #f5c6cb; background-color: #f8d7da; border-radius: 4px;">${message}</div>`;
                }
            });
        }

        // è‡ªåŠ¨åˆ·æ–°ç›¸å…³å˜é‡
        let autoRefreshInterval = null;
        let autoRefreshEnabled = true;
        let marketCheckInterval = null;
        const AUTO_REFRESH_INTERVAL = 10000; // 10ç§’
        const MARKET_CHECK_INTERVAL = 300000; // 5åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡å¸‚åœºçŠ¶æ€

        // æ£€æŸ¥å¸‚åœºçŠ¶æ€
        function checkMarketStatus() {
            return fetch('/api/market/status')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        console.log('å¸‚åœºçŠ¶æ€æ£€æŸ¥:', data.is_market_open ? 'å¼€ç›˜' : 'æ”¶ç›˜', 'æ—¶é—´:', data.current_time);
                        return data.is_market_open;
                    }
                    return false;
                })
                .catch(error => {
                    console.error('æ£€æŸ¥å¸‚åœºçŠ¶æ€å¤±è´¥:', error);
                    return false;
                });
        }

        // å¯åŠ¨è‡ªåŠ¨åˆ·æ–°ï¼ˆå¸¦äº¤æ˜“æ—¶é—´æ£€æŸ¥ï¼‰
        function startAutoRefresh() {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
            }
            
            if (!autoRefreshEnabled) {
                console.log('è‡ªåŠ¨åˆ·æ–°å·²ç¦ç”¨');
                return;
            }
            
            // å…ˆæ£€æŸ¥å¸‚åœºçŠ¶æ€
            checkMarketStatus().then(isMarketOpen => {
                if (isMarketOpen) {
                    console.log('äº¤æ˜“æ—¶é—´å†…ï¼Œå¯åŠ¨è‡ªåŠ¨åˆ·æ–°ï¼Œé—´éš”:', AUTO_REFRESH_INTERVAL / 1000, 'ç§’');
                    
                    autoRefreshInterval = setInterval(async () => {
                        if (!autoRefreshEnabled) {
                            console.log('è‡ªåŠ¨åˆ·æ–°å·²ç¦ç”¨ï¼Œåœæ­¢åˆ·æ–°');
                            clearInterval(autoRefreshInterval);
                            return;
                        }
                        
                        // æ¯æ¬¡åˆ·æ–°å‰æ£€æŸ¥å¸‚åœºçŠ¶æ€
                        const stillOpen = await checkMarketStatus();
                        if (!stillOpen) {
                            console.log('å¸‚åœºå·²æ”¶ç›˜ï¼Œåœæ­¢è‡ªåŠ¨åˆ·æ–°');
                            clearInterval(autoRefreshInterval);
                            autoRefreshInterval = null;
                            updateAutoRefreshButtonState(false);
                            return;
                        }
                        
                        try {
                            console.log('è‡ªåŠ¨åˆ·æ–°: å¼€å§‹æ›´æ–°å®æ—¶æ•°æ®å’Œåˆ†æ—¶å›¾');
                            
                            // å¹¶è¡Œåˆ·æ–°å®æ—¶äº¤æ˜“æ•°æ®å’Œåˆ†æ—¶å›¾
                            // è‡ªåŠ¨åˆ·æ–°æ—¶ä¸æ˜¾ç¤ºåŠ è½½çŠ¶æ€ï¼Œé¿å…æ•°æ®æ¶ˆå¤±
                            await Promise.all([
                                loadRealtimeData(false),
                                loadIntradayChart(false)
                            ]);
                            
                            console.log('è‡ªåŠ¨åˆ·æ–°: æ•°æ®æ›´æ–°å®Œæˆ');
                            updateLastRefreshTime();
                            
                        } catch (error) {
                            console.error('è‡ªåŠ¨åˆ·æ–°å¤±è´¥:', error);
                        }
                    }, AUTO_REFRESH_INTERVAL);
                    
                    updateAutoRefreshButtonState(true);
                } else {
                    console.log('éäº¤æ˜“æ—¶é—´ï¼Œä¸å¯åŠ¨è‡ªåŠ¨åˆ·æ–°');
                    updateAutoRefreshButtonState(false);
                }
            });
        }

        // å¯åŠ¨å¸‚åœºçŠ¶æ€ç›‘æ§
        function startMarketStatusMonitor() {
            if (marketCheckInterval) {
                clearInterval(marketCheckInterval);
            }
            
            marketCheckInterval = setInterval(() => {
                if (!autoRefreshInterval && autoRefreshEnabled) {
                    checkMarketStatus().then(isMarketOpen => {
                        if (isMarketOpen) {
                            console.log('æ£€æµ‹åˆ°å¸‚åœºå¼€ç›˜ï¼Œå¯åŠ¨è‡ªåŠ¨åˆ·æ–°');
                            startAutoRefresh();
                        }
                    });
                }
            }, MARKET_CHECK_INTERVAL);
        }

        // æ›´æ–°è‡ªåŠ¨åˆ·æ–°æŒ‰é’®çŠ¶æ€
        function updateAutoRefreshButtonState(isActive) {
            const toggleBtn = document.getElementById('autoRefreshToggle');
            const chartToggleBtn = document.getElementById('chartAutoRefreshToggle');
            
            if (isActive) {
                if (toggleBtn) {
                    toggleBtn.textContent = 'åœæ­¢è‡ªåŠ¨åˆ·æ–°';
                    toggleBtn.style.backgroundColor = '#dc3545';
                }
                if (chartToggleBtn) {
                    chartToggleBtn.textContent = 'åœæ­¢è‡ªåŠ¨åˆ·æ–°';
                    chartToggleBtn.style.backgroundColor = '#dc3545';
                }
            } else {
                if (toggleBtn) {
                    toggleBtn.textContent = 'å¯åŠ¨è‡ªåŠ¨åˆ·æ–°';
                    toggleBtn.style.backgroundColor = '#28a745';
                }
                if (chartToggleBtn) {
                    chartToggleBtn.textContent = 'å¯åŠ¨è‡ªåŠ¨åˆ·æ–°';
                    chartToggleBtn.style.backgroundColor = '#28a745';
                }
            }
        }

        // åœæ­¢è‡ªåŠ¨åˆ·æ–°
        function stopAutoRefresh() {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
                autoRefreshInterval = null;
                console.log('è‡ªåŠ¨åˆ·æ–°å·²åœæ­¢');
            }
        }

        // åˆ‡æ¢è‡ªåŠ¨åˆ·æ–°çŠ¶æ€
        function toggleAutoRefresh() {
            autoRefreshEnabled = !autoRefreshEnabled;
            
            if (autoRefreshEnabled) {
                startAutoRefresh();
                console.log('è‡ªåŠ¨åˆ·æ–°å·²å¯ç”¨');
            } else {
                stopAutoRefresh();
                updateAutoRefreshButtonState(false);
                console.log('è‡ªåŠ¨åˆ·æ–°å·²ç¦ç”¨');
            }
        }

        // æ›´æ–°æœ€ååˆ·æ–°æ—¶é—´æ˜¾ç¤º
        function updateLastRefreshTime() {
            const now = new Date();
            const timeStr = now.toLocaleTimeString('zh-CN', { 
                hour12: false,
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
            
            // æ›´æ–°å®æ—¶äº¤æ˜“æ•°æ®çš„åˆ·æ–°æ—¶é—´
            const refreshTimeElement = document.getElementById('lastRefreshTime');
            if (refreshTimeElement) {
                refreshTimeElement.textContent = `æœ€åæ›´æ–°: ${timeStr}`;
            }
            
            // æ›´æ–°åˆ†æ—¶å›¾çš„åˆ·æ–°æ—¶é—´
            const chartRefreshTimeElement = document.getElementById('lastChartRefreshTime');
            if (chartRefreshTimeElement) {
                chartRefreshTimeElement.textContent = `æœ€åæ›´æ–°: ${timeStr}`;
            }
        }

        // ==================== è‚¡ç¥¨æ“ä½œæŒ‰é’®ç›¸å…³å‡½æ•° ====================
        
        // æ£€æŸ¥è‚¡ç¥¨æ˜¯å¦åœ¨è‡ªé€‰åˆ—è¡¨ä¸­
        function checkWatchlistStatus() {
            updateWatchlistSelectStatus();
        }
        
        // æ›´æ–°è‡ªé€‰è‚¡ä¸‹æ‹‰èœå•çŠ¶æ€
        function updateWatchlistSelectStatus() {
            const stockCode = getStockCodeFromUrl();
            if (!stockCode) {
                console.log('æ— æ³•è·å–è‚¡ç¥¨ä»£ç ');
                return;
            }
            
            // æ„é€ ts_codeï¼ˆ6ä½è‚¡ç¥¨ä»£ç  + äº¤æ˜“æ‰€åç¼€ï¼‰
            const tsCode = stockCode.startsWith('6') ? `${stockCode}.SH` : `${stockCode}.SZ`;
            console.log('æ£€æŸ¥è‡ªé€‰è‚¡çŠ¶æ€ï¼Œè‚¡ç¥¨ä»£ç :', stockCode, 'ts_code:', tsCode);
            
            // ä»åç«¯APIæ£€æŸ¥è‡ªé€‰è‚¡çŠ¶æ€
            const apiUrl = `/api/watchlist/check?ts_code=${encodeURIComponent(tsCode)}`;
            console.log('è¯·æ±‚API URL:', apiUrl);
            
            fetch(apiUrl, {
                method: 'GET'
            })
            .then(response => {
                console.log('APIå“åº”çŠ¶æ€:', response.status, response.statusText);
                console.log('å“åº”å¤´:', response.headers);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.text().then(text => {
                    console.log('APIå“åº”åŸå§‹æ–‡æœ¬:', text);
                    try {
                        return JSON.parse(text);
                    } catch (e) {
                        console.error('JSONè§£æå¤±è´¥:', e);
                        console.error('å“åº”æ–‡æœ¬:', text);
                        throw new Error('å“åº”ä¸æ˜¯æœ‰æ•ˆçš„JSONæ ¼å¼');
                    }
                });
            })
            .then(data => {
                console.log('APIå“åº”æ•°æ®:', data);
                const selectElement = document.getElementById('watchlistSelect');
                const removeBtn = document.getElementById('removeFromWatchlistBtn');
                
                if (selectElement && removeBtn) {
                    if (data.in_watchlist && data.priority) {
                        // å·²åœ¨è‡ªé€‰è‚¡ä¸­ï¼Œè®¾ç½®ä¸‹æ‹‰èœå•çš„é€‰ä¸­å€¼å’Œæ ·å¼
                        selectElement.value = data.priority;
                        
                        // æ ¹æ®ä¼˜å…ˆçº§è®¾ç½®èƒŒæ™¯è‰²
                        switch (data.priority) {
                            case 'purple':
                                selectElement.style.background = 'linear-gradient(45deg, #8e44ad, #9b59b6)';
                                selectElement.style.color = 'white';
                                break;
                            case 'red':
                                selectElement.style.background = 'linear-gradient(45deg, #e74c3c, #c0392b)';
                                selectElement.style.color = 'white';
                                break;
                            case 'green':
                                selectElement.style.background = 'linear-gradient(45deg, #27ae60, #2ecc71)';
                                selectElement.style.color = 'white';
                                break;
                            case 'holding':
                                selectElement.style.background = 'linear-gradient(45deg, #f39c12, #e67e22)';
                                selectElement.style.color = 'white';
                                break;
                            case 'sold':
                                selectElement.style.background = 'linear-gradient(45deg, #34495e, #2c3e50)';
                                selectElement.style.color = 'white';
                                break;
                            default:
                                selectElement.style.background = 'linear-gradient(45deg, #3498db, #2980b9)';
                                selectElement.style.color = 'white';
                        }
                        
                        // æ˜¾ç¤ºåˆ é™¤æŒ‰é’®
                        removeBtn.style.display = 'flex';
                    } else {
                        // æœªåœ¨è‡ªé€‰è‚¡ä¸­ï¼Œæ¢å¤é»˜è®¤æ ·å¼
                        selectElement.value = '';
                        selectElement.style.background = 'linear-gradient(45deg, #ffc107, #fd7e14)';
                        selectElement.style.color = '#333';
                        
                        // éšè—åˆ é™¤æŒ‰é’®
                        removeBtn.style.display = 'none';
                    }
                }
                
                // åŒæ—¶æ›´æ–°localStorageä»¥ä¿æŒå…¼å®¹æ€§
                let watchlist = JSON.parse(localStorage.getItem('stockWatchlist') || '[]');
                const index = watchlist.indexOf(stockCode);
                
                if (data.in_watchlist && index === -1) {
                    // åç«¯æœ‰ä½†localStorageæ²¡æœ‰ï¼Œæ·»åŠ åˆ°localStorage
                    watchlist.push(stockCode);
                    localStorage.setItem('stockWatchlist', JSON.stringify(watchlist));
                } else if (!data.in_watchlist && index > -1) {
                    // åç«¯æ²¡æœ‰ä½†localStorageæœ‰ï¼Œä»localStorageåˆ é™¤
                    watchlist.splice(index, 1);
                    localStorage.setItem('stockWatchlist', JSON.stringify(watchlist));
                }
            })
            .catch(error => {
                console.error('æ£€æŸ¥è‡ªé€‰è‚¡çŠ¶æ€å¤±è´¥:', error);
                // å¦‚æœAPIè°ƒç”¨å¤±è´¥ï¼Œå›é€€åˆ°localStorageæ£€æŸ¥
                const watchlist = JSON.parse(localStorage.getItem('stockWatchlist') || '[]');
                const isInWatchlist = watchlist.includes(stockCode);
                
                const selectElement = document.getElementById('watchlistSelect');
                const removeBtn = document.getElementById('removeFromWatchlistBtn');
                
                if (selectElement && removeBtn) {
                    if (isInWatchlist) {
                        // å·²åœ¨è‡ªé€‰è‚¡ä¸­ï¼Œè®¾ç½®ä¸ºé»˜è®¤ç»¿è‰²
                        selectElement.value = 'green';
                        selectElement.style.background = 'linear-gradient(45deg, #27ae60, #2ecc71)';
                        selectElement.style.color = 'white';
                        removeBtn.style.display = 'flex';
                    } else {
                        // æœªåœ¨è‡ªé€‰è‚¡ä¸­ï¼Œæ¢å¤é»˜è®¤æ ·å¼
                        selectElement.value = '';
                        selectElement.style.background = 'linear-gradient(45deg, #ffc107, #fd7e14)';
                        selectElement.style.color = '#333';
                        removeBtn.style.display = 'none';
                    }
                }
            });
        }
        
        // è·å–å½“å‰è‚¡ç¥¨ä¿¡æ¯
        function getCurrentStockInfo() {
            // ä»é¡µé¢å…ƒç´ ä¸­è·å–è‚¡ç¥¨ä¿¡æ¯
            const stockInfo = {
                name: '',
                latest_price: 0,
                pct_chg: 0,
                industry: '-',
                volume_ratio: 0,
                pe: 0,
                amount: 0,
                total_mv: 0,
                nine_turn_up: 0,
                nine_turn_down: 0
            };
            
            try {
                // ä»é¡µé¢æ ‡é¢˜è·å–è‚¡ç¥¨åç§°
                const titleElement = document.querySelector('.stock-title h1');
                if (titleElement) {
                    const titleText = titleElement.textContent;
                    const match = titleText.match(/^(.+?)\s*\(/);
                    if (match) {
                        stockInfo.name = match[1].trim();
                    }
                }
                
                // ä»å®æ—¶æ•°æ®è·å–ä»·æ ¼ä¿¡æ¯
                if (window.realtimeData) {
                    stockInfo.latest_price = parseFloat(window.realtimeData.current_price) || 0;
                    stockInfo.pct_chg = parseFloat(window.realtimeData.change_percent) || 0;
                    stockInfo.volume_ratio = parseFloat(window.realtimeData.volume_ratio) || 0;
                    stockInfo.amount = parseFloat(window.realtimeData.amount) || 0;
                }
                
                // ä»åŸºæœ¬ä¿¡æ¯è·å–å…¶ä»–æ•°æ®
                if (window.stockData) {
                    stockInfo.industry = window.stockData.industry || '-';
                    stockInfo.pe = parseFloat(window.stockData.pe_ttm) || 0;
                    stockInfo.total_mv = parseFloat(window.stockData.total_mv) || 0;
                }
                
                // ä»ä¹è½¬æ•°æ®è·å–æœ€æ–°çš„ä¹è½¬åºåˆ—æ•°æ®
                if (nineTurnData && nineTurnData.length > 0) {
                    const latestNineTurn = nineTurnData[nineTurnData.length - 1];
                    stockInfo.nine_turn_up = parseInt(latestNineTurn.sell_signal) || 0;    // çº¢è‰²ï¼šå–å‡ºä¿¡å·
                    stockInfo.nine_turn_down = parseInt(latestNineTurn.buy_signal) || 0;   // ç»¿è‰²ï¼šä¹°å…¥ä¿¡å·
                }
                
            } catch (error) {
                console.error('è·å–è‚¡ç¥¨ä¿¡æ¯å¤±è´¥:', error);
            }
            
            return stockInfo;
        }

        // æ·»åŠ åˆ°è‡ªé€‰
        // åŠ è½½ä¹è½¬æ•°æ®
        async function loadNineTurnData() {
            try {
                const response = await fetch(`/api/stock/${currentStockCode}/nine_turn?days=200&freq=daily`);
                const result = await response.json();
                
                if (result.success && result.data) {
                    nineTurnData = result.data;
                    console.log(`[ä¹è½¬æ•°æ®] æˆåŠŸè·å–${nineTurnData.length}æ¡æ•°æ®`);
                } else {
                    nineTurnData = [];
                    console.log('[ä¹è½¬æ•°æ®] æš‚æ— æ•°æ®æˆ–è·å–å¤±è´¥');
                }
            } catch (error) {
                console.error('åŠ è½½ä¹è½¬æ•°æ®å¤±è´¥:', error);
                nineTurnData = [];
            }
        }

        async function addToWatchlist() {
            const stockCode = getStockCodeFromUrl();
            if (!stockCode) {
                alert('æ— æ³•è·å–è‚¡ç¥¨ä»£ç ');
                return;
            }
            
            // ç¡®ä¿ä¹è½¬æ•°æ®å·²åŠ è½½
            if (!nineTurnData || nineTurnData.length === 0) {
                console.log('ä¹è½¬æ•°æ®æœªåŠ è½½ï¼Œå…ˆåŠ è½½ä¹è½¬æ•°æ®');
                try {
                    await loadNineTurnData();
                } catch (error) {
                    console.error('åŠ è½½ä¹è½¬æ•°æ®å¤±è´¥:', error);
                }
            }
            
            // è·å–å½“å‰è‚¡ç¥¨ä¿¡æ¯
            const stockInfo = getCurrentStockInfo();
            
            // æ„é€ ts_codeï¼ˆ6ä½è‚¡ç¥¨ä»£ç  + äº¤æ˜“æ‰€åç¼€ï¼‰
            const tsCode = stockCode.startsWith('6') ? `${stockCode}.SH` : `${stockCode}.SZ`;
            
            // ç”Ÿæˆè‡ªåŠ¨å¤‡æ³¨ï¼šåŠ å…¥æ—¥æœŸ + ä¹è½¬æ•°å­—
            const now = new Date();
            const day = now.getDate();
            const nineUp = stockInfo.nine_turn_up || 0;
            const nineDown = stockInfo.nine_turn_down || 0;
            let autoNote = `${day}æ—¥`;
            if (nineUp > 0) {
                autoNote += ` çº¢${nineUp}`;
            }
            if (nineDown > 0) {
                autoNote += ` ç»¿${nineDown}`;
            }
            
            console.log('ç”Ÿæˆçš„è‡ªåŠ¨å¤‡æ³¨:', autoNote, 'ä¹è½¬æ•°æ®:', {nineUp, nineDown});
            
            // è°ƒç”¨åç«¯APIæ·»åŠ åˆ°è‡ªé€‰è‚¡
            fetch('/api/watchlist/add', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    ts_code: tsCode,
                    name: stockInfo.name || '',
                    latest_price: stockInfo.latest_price || 0,
                    pct_chg: stockInfo.pct_chg || 0,
                    industry: stockInfo.industry || '-',
                    volume_ratio: stockInfo.volume_ratio || 0,
                    pe: stockInfo.pe || 0,
                    amount: stockInfo.amount || 0,
                    total_mv: stockInfo.total_mv || 0,
                    nine_turn_up: stockInfo.nine_turn_up || 0,
                    nine_turn_down: stockInfo.nine_turn_down || 0,
                    priority: 'green',  // é»˜è®¤ç»¿è‰²ä¼˜å…ˆçº§
                    note: autoNote,  // è‡ªåŠ¨ç”Ÿæˆçš„å¤‡æ³¨
                    add_time: new Date().toISOString()
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // åŒæ—¶æ›´æ–°localStorageä»¥ä¿æŒå…¼å®¹æ€§
                    let watchlist = JSON.parse(localStorage.getItem('stockWatchlist') || '[]');
                    if (!watchlist.includes(stockCode)) {
                        watchlist.push(stockCode);
                        localStorage.setItem('stockWatchlist', JSON.stringify(watchlist));
                    }
                    
                    // æ›´æ–°ä¸‹æ‹‰èœå•æ˜¾ç¤ºçŠ¶æ€
                    updateWatchlistSelectStatus();
                    
                    // æ˜¾ç¤ºæˆåŠŸæç¤º
                    showNotification('å·²æ·»åŠ åˆ°è‡ªé€‰è‚¡ç¥¨', 'success');
                    console.log('è‚¡ç¥¨å·²æ·»åŠ åˆ°è‡ªé€‰:', stockCode);
                } else {
                    showNotification(data.message || 'æ·»åŠ å¤±è´¥', 'error');
                }
            })
            .catch(error => {
                console.error('æ·»åŠ è‡ªé€‰è‚¡å¤±è´¥:', error);
                showNotification('æ·»åŠ å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•', 'error');
            });
        }
        
        // æ·»åŠ åˆ°è‡ªé€‰è‚¡ï¼ˆå¸¦ä¼˜å…ˆçº§ï¼‰
        async function addToWatchlistWithPriority(priority) {
            if (!priority) return;
            
            const stockCode = getStockCodeFromUrl();
            if (!stockCode) {
                alert('æ— æ³•è·å–è‚¡ç¥¨ä»£ç ');
                return;
            }
            
            // ç¡®ä¿ä¹è½¬æ•°æ®å·²åŠ è½½
            if (!nineTurnData || nineTurnData.length === 0) {
                console.log('ä¹è½¬æ•°æ®æœªåŠ è½½ï¼Œå…ˆåŠ è½½ä¹è½¬æ•°æ®');
                try {
                    await loadNineTurnData();
                } catch (error) {
                    console.error('åŠ è½½ä¹è½¬æ•°æ®å¤±è´¥:', error);
                }
            }
            
            // è·å–å½“å‰è‚¡ç¥¨ä¿¡æ¯
            const stockInfo = getCurrentStockInfo();
            
            // æ„é€ ts_codeï¼ˆ6ä½è‚¡ç¥¨ä»£ç  + äº¤æ˜“æ‰€åç¼€ï¼‰
            const tsCode = stockCode.startsWith('6') ? `${stockCode}.SH` : `${stockCode}.SZ`;
            
            // ç”Ÿæˆè‡ªåŠ¨å¤‡æ³¨ï¼šåŠ å…¥æ—¥æœŸ + ä¹è½¬æ•°å­—
            const now = new Date();
            const day = now.getDate();
            const nineUp = stockInfo.nine_turn_up || 0;
            const nineDown = stockInfo.nine_turn_down || 0;
            let autoNote = `${day}æ—¥`;
            if (nineUp > 0) {
                autoNote += ` çº¢${nineUp}`;
            }
            if (nineDown > 0) {
                autoNote += ` ç»¿${nineDown}`;
            }
            
            console.log('ç”Ÿæˆçš„è‡ªåŠ¨å¤‡æ³¨:', autoNote, 'ä¹è½¬æ•°æ®:', {nineUp, nineDown});
            
            // è°ƒç”¨åç«¯APIæ·»åŠ åˆ°è‡ªé€‰è‚¡
            fetch('/api/watchlist/add', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    ts_code: tsCode,
                    name: stockInfo.name || '',
                    latest_price: stockInfo.latest_price || 0,
                    pct_chg: stockInfo.pct_chg || 0,
                    industry: stockInfo.industry || '-',
                    volume_ratio: stockInfo.volume_ratio || 0,
                    pe: stockInfo.pe || 0,
                    amount: stockInfo.amount || 0,
                    total_mv: stockInfo.total_mv || 0,
                    nine_turn_up: stockInfo.nine_turn_up || 0,
                    nine_turn_down: stockInfo.nine_turn_down || 0,
                    priority: priority,
                    note: autoNote,  // è‡ªåŠ¨ç”Ÿæˆçš„å¤‡æ³¨
                    add_time: new Date().toISOString()
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // åŒæ—¶æ›´æ–°localStorageä»¥ä¿æŒå…¼å®¹æ€§
                    let watchlist = JSON.parse(localStorage.getItem('stockWatchlist') || '[]');
                    if (!watchlist.includes(stockCode)) {
                        watchlist.push(stockCode);
                        localStorage.setItem('stockWatchlist', JSON.stringify(watchlist));
                    }
                    
                    // æ›´æ–°ä¸‹æ‹‰èœå•æ˜¾ç¤ºçŠ¶æ€
                    updateWatchlistSelectStatus();
                    
                    // æ˜¾ç¤ºæˆåŠŸæç¤º
                    const priorityNames = {
                        'purple': 'ç«‹å³ä¹°å…¥',
                        'red': 'é‡ç‚¹å…³æ³¨',
                        'green': 'è§‚å¯Ÿä¸­',
                        'holding': 'æŒä»“ä¸­',
                        'sold': 'å·²å–å‡º'
                    };
                    showNotification(`å·²æ·»åŠ åˆ°è‡ªé€‰è‚¡ç¥¨ï¼ˆ${priorityNames[priority]}ï¼‰`, 'success');
                    console.log('è‚¡ç¥¨å·²æ·»åŠ åˆ°è‡ªé€‰:', stockCode, 'ä¼˜å…ˆçº§:', priority);
                } else {
                    showNotification(data.message || 'æ·»åŠ å¤±è´¥', 'error');
                    // é‡ç½®ä¸‹æ‹‰èœå•é€‰æ‹©
                    const selectElement = document.getElementById('watchlistSelect');
                    if (selectElement) {
                        selectElement.value = '';
                    }
                }
            })
            .catch(error => {
                console.error('æ·»åŠ è‡ªé€‰è‚¡å¤±è´¥:', error);
                showNotification('æ·»åŠ å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•', 'error');
                // é‡ç½®ä¸‹æ‹‰èœå•é€‰æ‹©
                const selectElement = document.getElementById('watchlistSelect');
                if (selectElement) {
                    selectElement.value = '';
                }
            });
        }
        
        // ä»è‡ªé€‰ä¸­åˆ é™¤
        function removeFromWatchlist() {
            const stockCode = getStockCodeFromUrl();
            if (!stockCode) {
                alert('æ— æ³•è·å–è‚¡ç¥¨ä»£ç ');
                return;
            }
            
            // ç¡®è®¤åˆ é™¤
            if (!confirm('ç¡®å®šè¦ä»è‡ªé€‰è‚¡ç¥¨ä¸­åˆ é™¤å—ï¼Ÿ')) {
                return;
            }
            
            // æ„é€ ts_codeï¼ˆ6ä½è‚¡ç¥¨ä»£ç  + äº¤æ˜“æ‰€åç¼€ï¼‰
            const tsCode = stockCode.startsWith('6') ? `${stockCode}.SH` : `${stockCode}.SZ`;
            
            // è°ƒç”¨åç«¯APIä»è‡ªé€‰è‚¡ä¸­åˆ é™¤
            fetch('/api/watchlist/remove', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    ts_code: tsCode
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // åŒæ—¶æ›´æ–°localStorageä»¥ä¿æŒå…¼å®¹æ€§
                    let watchlist = JSON.parse(localStorage.getItem('stockWatchlist') || '[]');
                    const index = watchlist.indexOf(stockCode);
                    if (index > -1) {
                        watchlist.splice(index, 1);
                        localStorage.setItem('stockWatchlist', JSON.stringify(watchlist));
                    }
                    
                    // æ›´æ–°æŒ‰é’®æ˜¾ç¤ºçŠ¶æ€
                    checkWatchlistStatus();
                    
                    // æ˜¾ç¤ºæˆåŠŸæç¤º
                    showNotification('å·²ä»è‡ªé€‰è‚¡ç¥¨ä¸­åˆ é™¤', 'success');
                    console.log('è‚¡ç¥¨å·²ä»è‡ªé€‰ä¸­åˆ é™¤:', stockCode);
                } else {
                    showNotification(data.message || 'åˆ é™¤å¤±è´¥', 'error');
                }
            })
            .catch(error => {
                console.error('åˆ é™¤è‡ªé€‰è‚¡å¤±è´¥:', error);
                showNotification('åˆ é™¤å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•', 'error');
            });
        }
        
        // åˆ·æ–°æ‰€æœ‰æ•°æ®
        function refreshAllData() {
            const refreshBtn = document.getElementById('refreshDataBtn');
            
            // ç¦ç”¨æŒ‰é’®ï¼Œé˜²æ­¢é‡å¤ç‚¹å‡»
            refreshBtn.disabled = true;
            refreshBtn.innerHTML = '<span>ğŸ”„</span><span>åˆ·æ–°ä¸­...</span>';
            
            console.log('å¼€å§‹åˆ·æ–°æ‰€æœ‰æ•°æ®');
            
            // å¹¶è¡Œåˆ·æ–°æ‰€æœ‰æ•°æ®
            Promise.all([
                loadStockData(),
                loadRealtimeData(true),
                loadIntradayChart(true),
                loadIndicatorData()
            ]).then(() => {
                console.log('æ‰€æœ‰æ•°æ®åˆ·æ–°å®Œæˆ');
                showNotification('æ•°æ®åˆ·æ–°å®Œæˆ', 'success');
                updateLastRefreshTime();
            }).catch(error => {
                console.error('æ•°æ®åˆ·æ–°å¤±è´¥:', error);
                showNotification('æ•°æ®åˆ·æ–°å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•', 'error');
            }).finally(() => {
                // æ¢å¤æŒ‰é’®çŠ¶æ€
                refreshBtn.disabled = false;
                refreshBtn.innerHTML = '<span>ğŸ”„</span><span>åˆ·æ–°æ•°æ®</span>';
            });
        }
        
        // æ˜¾ç¤ºé€šçŸ¥æ¶ˆæ¯
        function showNotification(message, type = 'info') {
            // åˆ›å»ºé€šçŸ¥å…ƒç´ 
            const notification = document.createElement('div');
            notification.className = `notification notification-${type}`;
            notification.textContent = message;
            
            // æ·»åŠ æ ·å¼
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 12px 20px;
                border-radius: 6px;
                color: white;
                font-weight: 500;
                z-index: 10000;
                opacity: 0;
                transform: translateX(100%);
                transition: all 0.3s ease;
            `;
            
            // æ ¹æ®ç±»å‹è®¾ç½®èƒŒæ™¯è‰²
            switch (type) {
                case 'success':
                    notification.style.backgroundColor = '#28a745';
                    break;
                case 'error':
                    notification.style.backgroundColor = '#dc3545';
                    break;
                case 'info':
                default:
                    notification.style.backgroundColor = '#007bff';
                    break;
            }
            
            // æ·»åŠ åˆ°é¡µé¢
            document.body.appendChild(notification);
            
            // æ˜¾ç¤ºåŠ¨ç”»
            setTimeout(() => {
                notification.style.opacity = '1';
                notification.style.transform = 'translateX(0)';
            }, 10);
            
            // 3ç§’åè‡ªåŠ¨éšè—
            setTimeout(() => {
                notification.style.opacity = '0';
                notification.style.transform = 'translateX(100%)';
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 300);
            }, 3000);
        }
        
        // ä»URLè·å–è‚¡ç¥¨ä»£ç 
        function getStockCodeFromUrl() {
            const pathParts = window.location.pathname.split('/');
            return pathParts[pathParts.length - 1] || null;
        }
        
        // ==================== è‚¡ç¥¨æ“ä½œæŒ‰é’®ç›¸å…³å‡½æ•°ç»“æŸ ====================

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨åŠ è½½æ•°æ®
        window.onload = function() {
            console.log('é¡µé¢åŠ è½½å®Œæˆï¼Œå¼€å§‹åˆå§‹åŒ–');
            
            // æ£€æŸ¥è‡ªé€‰çŠ¶æ€
            checkWatchlistStatus();
            
            loadStockData();
            // å»¶è¿ŸåŠ è½½æŠ€æœ¯æŒ‡æ ‡æ•°æ®ï¼Œé¿å…åŒæ—¶è¯·æ±‚è¿‡å¤šAPI
            console.log('è®¾ç½®æŠ€æœ¯æŒ‡æ ‡æ•°æ®å»¶è¿ŸåŠ è½½');
            setTimeout(() => {
                console.log('å¼€å§‹å»¶è¿ŸåŠ è½½æŠ€æœ¯æŒ‡æ ‡æ•°æ®');
                loadIndicatorData();
            }, 1000);
            
            // å¯åŠ¨è‡ªåŠ¨åˆ·æ–°ï¼ˆä¼šæ£€æŸ¥äº¤æ˜“æ—¶é—´ï¼‰
            setTimeout(() => {
                startAutoRefresh();
                updateLastRefreshTime();
            }, 2000);
            
            // å¯åŠ¨å¸‚åœºçŠ¶æ€ç›‘æ§
            setTimeout(() => {
                startMarketStatusMonitor();
            }, 3000);
        };

        // é¡µé¢éšè—æ—¶åœæ­¢è‡ªåŠ¨åˆ·æ–°ï¼Œé¡µé¢æ˜¾ç¤ºæ—¶é‡æ–°å¯åŠ¨
        document.addEventListener('visibilitychange', function() {
            if (document.hidden) {
                console.log('é¡µé¢éšè—ï¼Œåœæ­¢è‡ªåŠ¨åˆ·æ–°');
                stopAutoRefresh();
            } else {
                console.log('é¡µé¢æ˜¾ç¤ºï¼Œé‡æ–°å¯åŠ¨è‡ªåŠ¨åˆ·æ–°');
                if (autoRefreshEnabled) {
                    startAutoRefresh();
                }
            }
        });

        // æ·»åŠ çª—å£resizeäº‹ä»¶ç›‘å¬å™¨
        let resizeTimeout;
        window.addEventListener('resize', function() {
            // é˜²æŠ–å¤„ç†ï¼Œé¿å…é¢‘ç¹è§¦å‘
            clearTimeout(resizeTimeout);
            resizeTimeout = setTimeout(() => {
                console.log('çª—å£å¤§å°å˜åŒ–ï¼Œé‡æ–°å¸ƒå±€å›¾è¡¨');
                
                // é‡æ–°æ£€æŸ¥å®¹å™¨å°ºå¯¸
                ensureChartContainerSizes();
                
                // å»¶è¿Ÿé‡æ–°å¸ƒå±€å›¾è¡¨
                setTimeout(() => {
                    forceResizeAllCharts();
                    
                    // é‡æ–°è®¾ç½®å›¾è¡¨åŒæ­¥æœºåˆ¶
                    setTimeout(() => {
                        forceSetupChartSync();
                    }, 200);
                }, 100);
            }, 300);
        });
    </script>
</body>
</html>