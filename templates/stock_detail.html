<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>股票详情 - 九转序列选股系统</title>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        
        .back-btn {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 20px;
            cursor: pointer;
            margin-bottom: 15px;
            transition: all 0.3s ease;
        }
        
        .back-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        .stock-title {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .stock-name {
            font-size: 1.4em;
            font-weight: bold;
            color: #333;
        }
        
        .stock-code {
            font-size: 0.9em;
            color: #666;
        }
        
        .stock-price {
            font-size: 1.8em;
            font-weight: bold;
            color: #e74c3c;
        }
        
        .stock-info {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 20px;
        }
        
        .info-item {
            background: #f8f9fa;
            padding: 8px 12px;
            border-radius: 8px;
            text-align: center;
            flex: 1;
            min-width: 100px;
        }
        
        .info-label {
            font-size: 12px;
            color: #666;
            margin-bottom: 5px;
        }
        
        .info-value {
            font-size: 14px;
            font-weight: bold;
            color: #333;
        }
        
        .chart-section {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        
        .chart-title {
            font-size: 1.2em;
            font-weight: bold;
            margin-bottom: 20px;
            color: #333;
        }
        
        .kline-chart {
            width: 100%;
            height: 600px;
        }
        
        .macd-chart {
            width: 100%;
            height: 300px;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            font-size: 14px;
            color: #666;
        }
        
        .error {
            text-align: center;
            padding: 20px;
            color: #e74c3c;
            background: #ffeaea;
            border-radius: 10px;
            margin: 20px 0;
        }
        
        .price-info {
            display: flex;
            gap: 20px;
            margin-top: 10px;
            font-size: 12px;
        }
        
        .price-high {
            color: #e74c3c;
        }
        
        .price-low {
            color: #27ae60;
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .stock-title {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .stock-info {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .kline-chart {
                height: 400px;
            }
            
            .macd-chart {
                height: 200px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <button class="back-btn" onclick="goBack()">← 返回首页</button>
            
            <div id="loadingDiv" class="loading">正在加载股票数据...</div>
            <div id="errorDiv" class="error" style="display: none;"></div>
            
            <div id="stockInfo" style="display: none;">
                <div class="stock-title">
                    <div>
                        <div class="stock-name" id="stockName"></div>
                        <div class="stock-code" id="stockCode"></div>
                    </div>
                    <div class="stock-price" id="stockPrice"></div>
                </div>
                
                <div class="price-info">
                    <span class="price-high">90天最高: ¥<span id="highestPrice"></span> (<span id="highestDate"></span>)</span>
                    <span class="price-low">90天最低: ¥<span id="lowestPrice"></span> (<span id="lowestDate"></span>)</span>
                </div>
                
                <div class="stock-info">
                    <div class="info-item">
                        <div class="info-label">市值</div>
                        <div class="info-value" id="marketCap"></div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">成交额</div>
                        <div class="info-value" id="amount"></div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">换手率</div>
                        <div class="info-value" id="turnoverRate"></div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">市盈率(TTM)</div>
                        <div class="info-value" id="peTtm"></div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">量比</div>
                        <div class="info-value" id="volumeRatio"></div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">所属行业</div>
                        <div class="info-value" id="industry"></div>
                    </div>
                </div>
                
                <!-- 资金流向信息 -->
                <div class="moneyflow-section" id="moneyflowSection" style="display: none;">
                    <h3 style="margin: 20px 0 10px 0; color: #333; font-size: 1.0em;">资金流向</h3>
                    <div class="stock-info">
                        <div class="info-item">
                            <div class="info-label">主力净流入</div>
                            <div class="info-value" id="netAmount"></div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">净流入占比</div>
                            <div class="info-value" id="netAmountRate"></div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">超大单净流入</div>
                            <div class="info-value" id="buyElgAmount"></div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">大单净流入</div>
                            <div class="info-value" id="buyLgAmount"></div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">中单净流入</div>
                            <div class="info-value" id="buyMdAmount"></div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">小单净流入</div>
                            <div class="info-value" id="buySmAmount"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="chart-section" id="chartSection" style="display: none;">
            <div class="chart-title">日K线图 (最近90天) - 九转序列</div>
            <div id="klineChart" class="kline-chart"></div>
        </div>
        
        <div class="chart-section" id="macdSection" style="display: none;">
            <div class="chart-title">MACD指标</div>
            <div id="macdChart" class="macd-chart"></div>
        </div>
        
        <div class="chart-section" id="kdjSection" style="display: none;">
            <div class="chart-title">KDJ指标</div>
            <div id="kdjChart" class="macd-chart"></div>
        </div>
        
        <div class="chart-section" id="rsiSection" style="display: none;">
            <div class="chart-title">RSI指标</div>
            <div id="rsiChart" class="macd-chart"></div>
        </div>
    </div>
    
    <script>
        const stockCode = '{{ stock_code }}';
        let stockData = null;
        
        function goBack() {
            window.location.href = '/';
        }
        
        function formatNumber(num, decimals = 2) {
            if (num === 0 || num === null || num === undefined) return '-';
            if (num >= 100000000) {
                return (num / 100000000).toFixed(decimals) + '亿';
            } else if (num >= 10000) {
                return (num / 10000).toFixed(decimals) + '万';
            }
            return num.toFixed(decimals);
        }
        
        function formatDate(dateStr) {
            if (!dateStr) return '';
            return dateStr.substring(0, 4) + '-' + dateStr.substring(4, 6) + '-' + dateStr.substring(6, 8);
        }
        
        // 安全的数值转换函数 - 移到全局作用域
        function safeParseFloat(value, defaultValue = 0) {
            if (value === null || value === undefined || value === '') {
                return defaultValue;
            }
            const parsed = parseFloat(value);
            return isNaN(parsed) ? defaultValue : parsed;
        }
        
        function loadStockData() {
            fetch(`/api/stock/${stockCode}`)
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        showError(data.error);
                        return;
                    }
                    
                    stockData = data;
                    displayStockInfo(data);
                    drawKlineChart(data);
                    drawMacdChart(data);
                    drawKdjChart(data);
                    drawRsiChart(data);
                })
                .catch(error => {
                    showError('加载数据失败: ' + error.message);
                });
        }
        
        function displayStockInfo(data) {
            document.getElementById('loadingDiv').style.display = 'none';
            document.getElementById('stockInfo').style.display = 'block';
            document.getElementById('chartSection').style.display = 'block';
            document.getElementById('macdSection').style.display = 'block';
            document.getElementById('kdjSection').style.display = 'block';
            document.getElementById('rsiSection').style.display = 'block';
            
            // 动态设置页面标题为股票名称
            document.title = data.name + ' - 九转序列选股系统';
            
            document.getElementById('stockName').textContent = data.name;
            document.getElementById('stockCode').textContent = data.ts_code;
            document.getElementById('stockPrice').textContent = '¥' + data.latest_price.toFixed(2);
            
            document.getElementById('highestPrice').textContent = data.highest_price.toFixed(2);
            document.getElementById('lowestPrice').textContent = data.lowest_price.toFixed(2);
            document.getElementById('highestDate').textContent = formatDate(data.highest_date);
            document.getElementById('lowestDate').textContent = formatDate(data.lowest_date);
            
            document.getElementById('marketCap').textContent = formatNumber(data.market_cap * 10000);
            document.getElementById('amount').textContent = formatNumber(data.amount * 1000);
            document.getElementById('turnoverRate').textContent = data.turnover_rate.toFixed(2) + '%';
            document.getElementById('peTtm').textContent = (data.pe_ttm && data.pe_ttm > 0) ? data.pe_ttm.toFixed(2) : '-';
            document.getElementById('volumeRatio').textContent = data.volume_ratio.toFixed(2);
            document.getElementById('industry').textContent = data.industry || '-';
            
            // 显示资金流向数据（如果可用）
            if (data.moneyflow && data.moneyflow !== null) {
                document.getElementById('moneyflowSection').style.display = 'block';
                
                // 格式化资金流向数值的函数
                function formatMoneyflow(value) {
                    if (value === 0 || value === null || value === undefined) return '-';
                    const absValue = Math.abs(value);
                    const sign = value >= 0 ? '+' : '-';
                    let formatted;
                    
                    if (absValue >= 10000) {
                        formatted = (absValue / 10000).toFixed(2) + '亿';
                    } else {
                        formatted = absValue.toFixed(2) + '万';
                    }
                    
                    return sign + formatted;
                }
                
                // 设置颜色样式的函数
                function setMoneyflowStyle(elementId, value) {
                    const element = document.getElementById(elementId);
                    if (value > 0) {
                        element.style.color = '#ff4444'; // 红色表示流入
                    } else if (value < 0) {
                        element.style.color = '#44aa44'; // 绿色表示流出
                    } else {
                        element.style.color = '#666'; // 灰色表示无变化
                    }
                }
                
                // 显示主力净流入
                const netAmount = data.moneyflow.net_amount || 0;
                document.getElementById('netAmount').textContent = formatMoneyflow(netAmount);
                setMoneyflowStyle('netAmount', netAmount);
                
                // 显示净流入占比（如果有）
                if (data.moneyflow.net_amount_rate !== undefined) {
                    const rate = data.moneyflow.net_amount_rate || 0;
                    document.getElementById('netAmountRate').textContent = rate.toFixed(2) + '%';
                    setMoneyflowStyle('netAmountRate', rate);
                } else {
                    document.getElementById('netAmountRate').textContent = '-';
                }
                
                // 显示超大单净流入
                const buyElgAmount = data.moneyflow.buy_elg_amount || 0;
                document.getElementById('buyElgAmount').textContent = formatMoneyflow(buyElgAmount);
                setMoneyflowStyle('buyElgAmount', buyElgAmount);
                
                // 显示大单净流入
                const buyLgAmount = data.moneyflow.buy_lg_amount || 0;
                document.getElementById('buyLgAmount').textContent = formatMoneyflow(buyLgAmount);
                setMoneyflowStyle('buyLgAmount', buyLgAmount);
                
                // 显示中单净流入（如果有）
                if (data.moneyflow.buy_md_amount !== undefined) {
                    const buyMdAmount = data.moneyflow.buy_md_amount || 0;
                    document.getElementById('buyMdAmount').textContent = formatMoneyflow(buyMdAmount);
                    setMoneyflowStyle('buyMdAmount', buyMdAmount);
                } else {
                    document.getElementById('buyMdAmount').textContent = '-';
                }
                
                // 显示小单净流入（如果有）
                if (data.moneyflow.buy_sm_amount !== undefined) {
                    const buySmAmount = data.moneyflow.buy_sm_amount || 0;
                    document.getElementById('buySmAmount').textContent = formatMoneyflow(buySmAmount);
                    setMoneyflowStyle('buySmAmount', buySmAmount);
                } else {
                    document.getElementById('buySmAmount').textContent = '-';
                }
            } else {
                // 如果没有资金流向数据，隐藏该部分
                document.getElementById('moneyflowSection').style.display = 'none';
            }
        }
        
        function drawKlineChart(data) {
            const chart = echarts.init(document.getElementById('klineChart'));
            
            const klineData = data.kline_data.map(item => [
                safeParseFloat(item.open),
                safeParseFloat(item.close),
                safeParseFloat(item.low),
                safeParseFloat(item.high)
            ]);
            
            const dates = data.kline_data.map(item => formatDate(item.trade_date));
            const volumes = data.kline_data.map(item => safeParseFloat(item.vol));
            
            // 九转序列数据 - 修正标注位置
            const nineTurnUp = data.kline_data.map((item, index) => {
                return item.nine_turn_up > 0 ? [
                    index, // x坐标：数据索引
                    safeParseFloat(item.high) + (safeParseFloat(item.high) * 0.02), // y坐标：K线最高价上方2%
                    item.nine_turn_up // 显示的数值
                ] : null;
            }).filter(item => item !== null);
            
            const nineTurnDown = data.kline_data.map((item, index) => {
                return item.nine_turn_down > 0 ? [
                    index, // x坐标：数据索引
                    safeParseFloat(item.low) - (safeParseFloat(item.low) * 0.02), // y坐标：K线最低价下方2%
                    item.nine_turn_down // 显示的数值
                ] : null;
            }).filter(item => item !== null);
            
            // 提取BOLL数据，保留null值让ECharts正确处理
            const bollUpper = data.kline_data.map(item => item.boll_upper === null || item.boll_upper === undefined ? null : parseFloat(item.boll_upper));
            const bollMid = data.kline_data.map(item => item.boll_mid === null || item.boll_mid === undefined ? null : parseFloat(item.boll_mid));
            const bollLower = data.kline_data.map(item => item.boll_lower === null || item.boll_lower === undefined ? null : parseFloat(item.boll_lower));
            
            // 找到最高价和最低价的位置
            let highestIndex = -1;
            let lowestIndex = -1;
            let maxHigh = -1;
            let minLow = Number.MAX_VALUE;
            
            // 遍历所有数据找到真正的最高价和最低价位置
            data.kline_data.forEach((item, index) => {
                const high = safeParseFloat(item.high);
                const low = safeParseFloat(item.low);
                
                if (high > maxHigh) {
                    maxHigh = high;
                    highestIndex = index;
                }
                
                if (low < minLow) {
                    minLow = low;
                    lowestIndex = index;
                }
            });
            
            console.log('最高价位置:', highestIndex, '价格:', maxHigh);
            console.log('最低价位置:', lowestIndex, '价格:', minLow);
            
            const option = {
                animation: false,
                legend: {
                    bottom: 10,
                    left: 'center',
                    data: ['日K', '成交量', '九转序列']
                },
                tooltip: {
                    trigger: 'axis',
                    axisPointer: {
                        type: 'cross'
                    },
                    backgroundColor: 'rgba(245, 245, 245, 0.8)',
                    borderWidth: 1,
                    borderColor: '#ccc',
                    textStyle: {
                        color: '#000'
                    }
                },
                axisPointer: {
                    link: [
                        {
                            xAxisIndex: 'all'
                        }
                    ],
                    label: {
                        backgroundColor: '#777'
                    }
                },
                toolbox: {
                    feature: {
                        dataZoom: {
                            yAxisIndex: false
                        },
                        brush: {
                            type: ['lineX', 'clear']
                        }
                    }
                },
                brush: {
                    xAxisIndex: 'all',
                    brushLink: 'all',
                    outOfBrush: {
                        colorAlpha: 0.1
                    }
                },
                grid: [
                    {
                        left: '10%',
                        right: '8%',
                        height: '50%'
                    },
                    {
                        left: '10%',
                        right: '8%',
                        top: '63%',
                        height: '16%'
                    }
                ],
                xAxis: [
                    {
                        type: 'category',
                        data: dates,
                        boundaryGap: false,
                        axisLine: { onZero: false },
                        splitLine: { show: false },
                        min: 'dataMin',
                        max: 'dataMax',
                        axisPointer: {
                            z: 100
                        }
                    },
                    {
                        type: 'category',
                        gridIndex: 1,
                        data: dates,
                        boundaryGap: false,
                        axisLine: { onZero: false },
                        axisTick: { show: false },
                        splitLine: { show: false },
                        axisLabel: { show: false },
                        min: 'dataMin',
                        max: 'dataMax'
                    }
                ],
                yAxis: [
                    {
                        scale: true,
                        splitArea: {
                            show: true
                        }
                    },
                    {
                        scale: true,
                        gridIndex: 1,
                        splitNumber: 2,
                        axisLabel: { show: false },
                        axisLine: { show: false },
                        axisTick: { show: false },
                        splitLine: { show: false }
                    }
                ],
                dataZoom: [
                    {
                        type: 'inside',
                        xAxisIndex: [0, 1],
                        start: 0,
                        end: 100
                    },
                    {
                        show: true,
                        xAxisIndex: [0, 1],
                        type: 'slider',
                        top: '85%',
                        start: 0,
                        end: 100
                    }
                ],
                series: [
                    {
                        name: '日K',
                        type: 'candlestick',
                        data: klineData,
                        itemStyle: {
                            color: '#ef232a',
                            color0: '#14b143',
                            borderColor: '#ef232a',
                            borderColor0: '#14b143'
                        },
                        markPoint: {
                            symbol: 'circle',
                            symbolSize: 8,
                            label: {
                                show: true,
                                position: 'top',
                                formatter: function (param) {
                                    return param.value ? param.value.toFixed(2) : '';
                                },
                                color: '#000000',
                                backgroundColor: 'rgba(255,255,255,0.9)',
                                borderWidth: 1,
                                borderColor: '#cccccc',
                                borderRadius: 3,
                                padding: [2, 4],
                                fontSize: 12,
                                fontWeight: 'bold'
                            },
                            data: [
                                {
                                    name: '最高价',
                                    coord: [highestIndex, maxHigh],
                                    value: maxHigh,
                                    itemStyle: {
                                        color: '#ff4444'
                                    }
                                },
                                {
                                    name: '最低价',
                                    coord: [lowestIndex, minLow],
                                    value: minLow,
                                    itemStyle: {
                                        color: '#44ff44'
                                    }
                                }
                            ].filter(item => item.coord[0] >= 0), // 过滤掉无效的索引
                            tooltip: {
                                formatter: function (param) {
                                    return param.name + '<br>¥' + (param.data.coord ? param.data.coord[1].toFixed(2) : '');
                                }
                            }
                        }
                    },
                    {
                        name: '成交量',
                        type: 'bar',
                        xAxisIndex: 1,
                        yAxisIndex: 1,
                        data: volumes,
                        itemStyle: {
                            color: function(params) {
                                const dataIndex = params.dataIndex;
                                if (dataIndex === 0) return '#14b143';
                                return klineData[dataIndex][1] > klineData[dataIndex][0] ? '#ef232a' : '#14b143';
                            }
                        }
                    },
                    {
                        name: '九转序列(上)',
                        type: 'scatter',
                        data: nineTurnUp,
                        symbolSize: 0, // 隐藏散点符号
                        itemStyle: {
                            color: 'transparent'
                        },
                        label: {
                            show: true,
                            position: 'inside',
                            color: '#ef232a', // 红色数字
                            fontWeight: 'bold',
                            fontSize: 14,
                            backgroundColor: 'rgba(255,255,255,0.8)',
                            borderRadius: 3,
                            padding: [2, 4],
                            formatter: function(param) {
                                return param.data[2]; // 数组的第三个元素是数值
                            }
                        }
                    },
                    {
                        name: '九转序列(下)',
                        type: 'scatter',
                        data: nineTurnDown,
                        symbolSize: 0, // 隐藏散点符号
                        itemStyle: {
                            color: 'transparent'
                        },
                        label: {
                            show: true,
                            position: 'inside',
                            color: '#14b143', // 绿色数字
                            fontWeight: 'bold',
                            fontSize: 14,
                            backgroundColor: 'rgba(255,255,255,0.8)',
                            borderRadius: 3,
                            padding: [2, 4],
                            formatter: function(param) {
                                return param.data[2]; // 数组的第三个元素是数值
                            }
                        }
                    },
                    {
                        name: 'BOLL上轨',
                        type: 'line',
                        data: bollUpper,
                        lineStyle: {
                            color: '#1E90FF',
                            width: 1
                        },
                        symbol: 'none',
                        smooth: true
                    },
                    {
                        name: 'BOLL中轨',
                        type: 'line',
                        data: bollMid,
                        lineStyle: {
                            color: '#1E90FF',
                            width: 1
                        },
                        symbol: 'none',
                        smooth: true
                    },
                    {
                        name: 'BOLL下轨',
                        type: 'line',
                        data: bollLower,
                        lineStyle: {
                            color: '#1E90FF',
                            width: 1
                        },
                        symbol: 'none',
                        smooth: true
                    }
                ]
            };
            
            chart.setOption(option);
            
            window.addEventListener('resize', function() {
                chart.resize();
            });
        }
        
        function drawMacdChart(data) {
            const chart = echarts.init(document.getElementById('macdChart'));
            
            const dates = data.kline_data.map(item => formatDate(item.trade_date));
            
            // 提取MACD数据
            const macdDif = data.kline_data.map(item => item.macd_dif === null || item.macd_dif === undefined ? null : parseFloat(item.macd_dif));
            const macdDea = data.kline_data.map(item => item.macd_dea === null || item.macd_dea === undefined ? null : parseFloat(item.macd_dea));
            const macdHistogram = data.kline_data.map(item => item.macd_histogram === null || item.macd_histogram === undefined ? null : parseFloat(item.macd_histogram));
            
            const option = {
                animation: false,
                legend: {
                    bottom: 10,
                    left: 'center',
                    data: ['DIF', 'DEA', 'MACD']
                },
                tooltip: {
                    trigger: 'axis',
                    axisPointer: {
                        type: 'cross'
                    }
                },
                grid: {
                    left: '10%',
                    right: '8%',
                    top: '10%',
                    bottom: '15%'
                },
                xAxis: {
                    type: 'category',
                    data: dates,
                    boundaryGap: false
                },
                yAxis: {
                    scale: true,
                    splitArea: {
                        show: true
                    }
                },
                dataZoom: [
                    {
                        type: 'inside',
                        start: 0,
                        end: 100
                    },
                    {
                        show: true,
                        type: 'slider',
                        bottom: '5%',
                        start: 0,
                        end: 100
                    }
                ],
                series: [
                    {
                        name: 'DIF',
                        type: 'line',
                        data: macdDif,
                        lineStyle: {
                            color: '#FF6B6B',
                            width: 2
                        },
                        symbol: 'none',
                        smooth: true
                    },
                    {
                        name: 'DEA',
                        type: 'line',
                        data: macdDea,
                        lineStyle: {
                            color: '#4ECDC4',
                            width: 2
                        },
                        symbol: 'none',
                        smooth: true
                    },
                    {
                        name: 'MACD',
                        type: 'bar',
                        data: macdHistogram,
                        itemStyle: {
                            color: function(params) {
                                return params.value >= 0 ? '#FF6B6B' : '#4ECDC4';
                            }
                        }
                    }
                ]
            };
            
            chart.setOption(option);
            
            window.addEventListener('resize', function() {
                chart.resize();
            });
        }
        
        function drawKdjChart(data) {
            const chart = echarts.init(document.getElementById('kdjChart'));
            
            const dates = data.kline_data.map(item => formatDate(item.trade_date));
            
            // 提取KDJ数据
            const kdjK = data.kline_data.map(item => item.kdj_k === null || item.kdj_k === undefined ? null : parseFloat(item.kdj_k));
            const kdjD = data.kline_data.map(item => item.kdj_d === null || item.kdj_d === undefined ? null : parseFloat(item.kdj_d));
            const kdjJ = data.kline_data.map(item => item.kdj_j === null || item.kdj_j === undefined ? null : parseFloat(item.kdj_j));
            
            const option = {
                animation: false,
                legend: {
                    bottom: 10,
                    left: 'center',
                    data: ['K', 'D', 'J']
                },
                tooltip: {
                    trigger: 'axis',
                    axisPointer: {
                        type: 'cross'
                    }
                },
                grid: {
                    left: '10%',
                    right: '8%',
                    top: '10%',
                    bottom: '15%'
                },
                xAxis: {
                    type: 'category',
                    data: dates,
                    boundaryGap: false
                },
                yAxis: {
                    scale: true,
                    min: 0,
                    max: 100,
                    splitArea: {
                        show: true
                    },
                    axisLine: {
                        lineStyle: {
                            color: '#ccc'
                        }
                    },
                    splitLine: {
                        lineStyle: {
                            color: ['#20', '#80'],
                            type: 'dashed'
                        }
                    }
                },
                dataZoom: [
                    {
                        type: 'inside',
                        start: 0,
                        end: 100
                    },
                    {
                        show: true,
                        type: 'slider',
                        bottom: '5%',
                        start: 0,
                        end: 100
                    }
                ],
                series: [
                    {
                        name: 'K',
                        type: 'line',
                        data: kdjK,
                        lineStyle: {
                            color: '#FF6B6B',
                            width: 2
                        },
                        symbol: 'none',
                        smooth: true
                    },
                    {
                        name: 'D',
                        type: 'line',
                        data: kdjD,
                        lineStyle: {
                            color: '#4ECDC4',
                            width: 2
                        },
                        symbol: 'none',
                        smooth: true
                    },
                    {
                        name: 'J',
                        type: 'line',
                        data: kdjJ,
                        lineStyle: {
                            color: '#45B7D1',
                            width: 2
                        },
                        symbol: 'none',
                        smooth: true
                    }
                ],
                // 添加超买超卖区域标识
                markLine: {
                    silent: true,
                    lineStyle: {
                        color: '#999',
                        type: 'dashed',
                        width: 1
                    },
                    data: [
                        {
                            yAxis: 20,
                            label: {
                                formatter: '超卖区 20',
                                position: 'insideEndTop'
                            }
                        },
                        {
                            yAxis: 80,
                            label: {
                                formatter: '超买区 80',
                                position: 'insideEndBottom'
                            }
                        }
                    ]
                }
            };
            
            chart.setOption(option);
            
            window.addEventListener('resize', function() {
                chart.resize();
            });
        }
        
        function drawRsiChart(data) {
            const chart = echarts.init(document.getElementById('rsiChart'));
            
            const dates = data.kline_data.map(item => formatDate(item.trade_date));
            
            // 提取RSI数据
            const rsiData = data.kline_data.map(item => item.rsi === null || item.rsi === undefined ? null : parseFloat(item.rsi));
            
            const option = {
                animation: false,
                legend: {
                    bottom: 10,
                    left: 'center',
                    data: ['RSI']
                },
                tooltip: {
                    trigger: 'axis',
                    axisPointer: {
                        type: 'cross'
                    },
                    formatter: function(params) {
                        if (params && params.length > 0) {
                            const value = params[0].value;
                            return params[0].name + '<br/>RSI: ' + (value !== null ? value.toFixed(2) : '-');
                        }
                        return '';
                    }
                },
                grid: {
                    left: '10%',
                    right: '8%',
                    top: '10%',
                    bottom: '15%'
                },
                xAxis: {
                    type: 'category',
                    data: dates,
                    boundaryGap: false
                },
                yAxis: {
                    scale: true,
                    min: 0,
                    max: 100,
                    splitArea: {
                        show: true
                    },
                    axisLine: {
                        lineStyle: {
                            color: '#ccc'
                        }
                    },
                    splitLine: {
                        lineStyle: {
                            color: ['#30', '#70'],
                            type: 'dashed'
                        }
                    }
                },
                dataZoom: [
                    {
                        type: 'inside',
                        start: 0,
                        end: 100
                    },
                    {
                        show: true,
                        type: 'slider',
                        bottom: '5%',
                        start: 0,
                        end: 100
                    }
                ],
                series: [
                    {
                        name: 'RSI',
                        type: 'line',
                        data: rsiData,
                        lineStyle: {
                            color: '#9C27B0',
                            width: 2
                        },
                        symbol: 'none',
                        smooth: true,
                        areaStyle: {
                            color: {
                                type: 'linear',
                                x: 0,
                                y: 0,
                                x2: 0,
                                y2: 1,
                                colorStops: [
                                    {
                                        offset: 0,
                                        color: 'rgba(156, 39, 176, 0.3)'
                                    },
                                    {
                                        offset: 1,
                                        color: 'rgba(156, 39, 176, 0.1)'
                                    }
                                ]
                            }
                        },
                        markLine: {
                             silent: true,
                             data: [
                                 {
                                     yAxis: 30,
                                     lineStyle: {
                                         color: '#27ae60',
                                         type: 'dashed',
                                         width: 2
                                     },
                                     label: {
                                         formatter: '超卖区 30',
                                         position: 'insideEndTop',
                                         color: '#27ae60',
                                         fontWeight: 'bold'
                                     }
                                 },
                                 {
                                     yAxis: 70,
                                     lineStyle: {
                                         color: '#e74c3c',
                                         type: 'dashed',
                                         width: 2
                                     },
                                     label: {
                                         formatter: '超买区 70',
                                         position: 'insideEndBottom',
                                         color: '#e74c3c',
                                         fontWeight: 'bold'
                                     }
                                 }
                             ]
                         }
                    }
                ]
            };
            
            chart.setOption(option);
            
            window.addEventListener('resize', function() {
                chart.resize();
            });
        }
        
        function showError(message) {
            document.getElementById('loadingDiv').style.display = 'none';
            document.getElementById('errorDiv').textContent = message;
            document.getElementById('errorDiv').style.display = 'block';
        }
        
        // 页面加载时获取股票数据
        loadStockData();
    </script>
</body>
</html>