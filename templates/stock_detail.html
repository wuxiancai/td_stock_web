<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>股票详情 - 每日指标</title>
    <script src="https://cdn.plot.ly/plotly-2.35.2.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', sans-serif;
            background-color: #f8f9fa;
            color: #333;
            line-height: 1.4;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .stock-header {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .stock-info {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 15px;
        }

        .stock-name {
            font-size: 18px;
            font-weight: 600;
            color: #333;
        }

        .stock-code {
            font-size: 14px;
            color: #666;
        }

        .stock-price {
            font-size: 32px;
            font-weight: 700;
            color: #e74c3c;
        }

        .price-change {
            display: flex;
            gap: 10px;
            align-items: center;
            font-size: 14px;
        }

        .change-amount {
            color: #e74c3c;
        }

        .change-percent {
            color: #e74c3c;
        }

        .trade-date {
            color: #666;
            font-size: 12px;
        }

        .indicators-section {
            background: white;
            border-radius: 8px;
            padding: 0;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .indicators-header {
            background: #f8f9fa;
            padding: 15px 20px;
            border-bottom: 1px solid #e9ecef;
            font-weight: 600;
            color: #495057;
        }

        .indicators-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            border-bottom: 1px solid #e9ecef;
        }

        .indicator-item {
            padding: 15px 10px;
            text-align: center;
            border-right: 1px solid #e9ecef;
            transition: background-color 0.2s ease;
        }

        .indicator-item:last-child {
            border-right: none;
        }

        .indicator-item:hover {
            background-color: #f8f9fa;
        }

        .indicator-label {
            font-size: 12px;
            color: #6c757d;
            margin-bottom: 5px;
            line-height: 1.2;
        }

        .indicator-value {
            font-size: 14px;
            font-weight: 600;
            color: #212529;
            line-height: 1.2;
        }

        .positive {
            color: #28a745;
        }

        .negative {
            color: #dc3545;
        }

        .neutral {
            color: #6c757d;
        }

        /* 蜡烛图样式 */
        .chart-section {
            background: white;
            border-radius: 8px;
            padding: 0;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .chart-header {
            background: #f8f9fa;
            padding: 15px 20px;
            border-bottom: 1px solid #e9ecef;
            font-weight: 600;
            color: #495057;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chart-controls {
            display: flex;
            gap: 10px;
        }

        .chart-btn {
            padding: 6px 12px;
            background: #fff;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s ease;
        }

        .chart-btn:hover {
            background: #e9ecef;
        }

        .chart-btn.active {
            background: #007bff;
            color: white;
            border-color: #007bff;
        }

        .chart-container {
            padding: 20px;
        }

        .chart-loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 4px;
            margin: 20px;
            border: 1px solid #f5c6cb;
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .indicators-grid {
                grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            }
            
            .indicator-item {
                padding: 10px 5px;
            }
            
            .indicator-label {
                font-size: 11px;
            }
            
            .indicator-value {
                font-size: 13px;
            }
            
            .stock-price {
                font-size: 24px;
            }

            .chart-header {
                flex-direction: column;
                gap: 10px;
                align-items: flex-start;
            }

            .chart-controls {
                width: 100%;
                justify-content: center;
            }
        }

        @media (max-width: 480px) {
            .indicators-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div id="loadingDiv" class="loading" style="display: block;">
            <p>正在加载每日指标数据...</p>
        </div>

        <div id="errorDiv" class="error" style="display: none;"></div>

        <div id="contentDiv" style="display: none;">
            <div class="stock-header">
                <div class="stock-info">
                    <div>
                        <span id="stockName" class="stock-name">东华测试</span>
                        <span id="stockCode" class="stock-code">300354.SZ</span>
                    </div>
                    <div>
                        <span id="stockPrice" class="stock-price">¥40.31</span>
                    </div>
                    <div class="price-change">
                        <span id="changeAmount" class="change-amount">+52.00</span>
                        <span>(<span id="changePercent" class="change-percent">+33.30</span>)</span>
                        <span id="tradeDate" class="trade-date">2025年7月25日</span>
                    </div>
                </div>
            </div>

            <div class="indicators-section">
                <div class="indicators-header">每日指标</div>
                <div class="indicators-grid">
                    <div class="indicator-item">
                        <div class="indicator-label">市值</div>
                        <div id="totalMv" class="indicator-value">55.76亿</div>
                    </div>
                    <div class="indicator-item">
                        <div class="indicator-label">成交额</div>
                        <div id="amount" class="indicator-value">2.53亿</div>
                    </div>
                    <div class="indicator-item">
                        <div class="indicator-label">净流入额</div>
                        <div id="netInflow" class="indicator-value negative">-5310.00万</div>
                    </div>
                    <div class="indicator-item">
                        <div class="indicator-label">换手率</div>
                        <div id="turnoverRate" class="indicator-value">7.71%</div>
                    </div>
                    <div class="indicator-item">
                        <div class="indicator-label">量比</div>
                        <div id="volumeRatio" class="indicator-value">0.85</div>
                    </div>
                    <div class="indicator-item">
                        <div class="indicator-label">市盈率(TTM)</div>
                        <div id="peTtm" class="indicator-value">45.17</div>
                    </div>
                    <div class="indicator-item">
                        <div class="indicator-label">市净率(PB)</div>
                        <div id="pb" class="indicator-value">7.36</div>
                    </div>
                    <div class="indicator-item">
                        <div class="indicator-label">当天开盘</div>
                        <div id="open" class="indicator-value">¥41.01</div>
                    </div>
                    <div class="indicator-item">
                        <div class="indicator-label">当天涨幅</div>
                        <div id="pctChg" class="indicator-value negative">-0.03%</div>
                    </div>
                    <div class="indicator-item">
                        <div class="indicator-label">所属行业</div>
                        <div id="industry" class="indicator-value">电器仪表</div>
                    </div>
                </div>
            </div>

            <!-- 蜡烛图部分 -->
            <div class="chart-section">
                <div class="chart-header">
                    <span>K线图</span>
                    <div class="chart-controls">
                        <button class="chart-btn" onclick="setDisplayRange(50)">50根</button>
                        <button class="chart-btn active" onclick="setDisplayRange(100)">100根</button>
                        <button class="chart-btn" onclick="setDisplayRange(200)">200根</button>
                        <button class="chart-btn" onclick="setDisplayRange(-1)">全部</button>
                    </div>
                </div>
                <div class="chart-container">
                    <div id="chartLoading" class="chart-loading" style="display: none;">
                        正在加载K线数据...
                    </div>
                    <div id="candlestickChart" style="height: 400px;"></div>
                <div id="volumeChart" style="height: 150px; margin-top: 5px;"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 全局变量
        let allChartData = [];
        let nineTurnData = []; // 添加神奇九转数据
        let currentDisplayRange = 100;
        let currentStockCode = '';

        // 从URL参数或后端传递的变量获取股票代码
        function getStockCodeFromUrl() {
            // 首先尝试从后端传递的变量获取
            const backendStockCode = '{{ stock_code }}';
            if (backendStockCode && backendStockCode !== '') {
                return backendStockCode;
            }
            
            // 如果后端没有传递，则从URL参数获取
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('code') || '300354';
        }

        // 格式化数值
        function formatValue(value, type = 'number') {
            if (value === null || value === undefined || value === '') {
                return '--';
            }
            
            const num = parseFloat(value);
            if (isNaN(num)) return value;
            
            switch (type) {
                case 'currency':
                    return `¥${num.toFixed(2)}`;
                case 'percentage':
                    return `${num.toFixed(2)}%`;
                case 'large_number':
                    if (num >= 100000000) {
                        return `${(num / 100000000).toFixed(2)}亿`;
                    } else if (num >= 10000) {
                        return `${(num / 10000).toFixed(2)}万`;
                    }
                    return num.toFixed(2);
                case 'ratio':
                    return num.toFixed(2);
                default:
                    return num.toFixed(2);
            }
        }

        // 格式化成交额
        function formatAmount(value) {
            if (value === null || value === undefined || value === '') {
                return '--';
            }
            
            const num = parseFloat(value);
            if (isNaN(num)) return value;
            
            // Tushare返回的amount单位是千元，需要先转换为万元
            const amountInWan = num / 10;
            
            // 成交额单位转换：万元 -> 亿元
            if (amountInWan >= 10000) {
                return `${(amountInWan / 10000).toFixed(2)}亿`;
            } else {
                return `${amountInWan.toFixed(2)}万`;
            }
        }

        // 格式化图表日期（只显示月日）
        function formatChartDate(dateStr) {
            if (!dateStr) return '';
            const month = dateStr.substring(4, 6);
            const day = dateStr.substring(6, 8);
            return `${month}-${day}`;
        }

        // 格式化日期
        function formatDate(dateStr) {
            if (!dateStr) return '';
            const year = dateStr.substring(0, 4);
            const month = dateStr.substring(4, 6);
            const day = dateStr.substring(6, 8);
            return `${year}年${month}月${day}日`;
        }

        // 设置数值颜色
        function setValueColor(element, value) {
            const num = parseFloat(value);
            if (isNaN(num)) return;
            
            element.classList.remove('positive', 'negative', 'neutral');
            if (num > 0) {
                element.classList.add('positive');
            } else if (num < 0) {
                element.classList.add('negative');
            } else {
                element.classList.add('neutral');
            }
        }

        // 加载股票数据
        async function loadStockData() {
            currentStockCode = getStockCodeFromUrl();
            
            try {
                // 获取每日指标数据
                const dailyBasicResponse = await fetch(`/api/stock/${currentStockCode}/daily_basic`);
                const dailyBasicResult = await dailyBasicResponse.json();
                
                if (!dailyBasicResult.success) {
                    throw new Error(dailyBasicResult.error || '获取每日指标数据失败');
                }

                // 获取实时数据
                const realtimeResponse = await fetch(`/api/stock/${currentStockCode}/realtime`);
                const realtimeResult = await realtimeResponse.json();
                
                displayStockData(dailyBasicResult, realtimeResult);
                
                // 加载K线数据
                await loadChartData();
                
            } catch (error) {
                showError('数据加载失败: ' + error.message);
            }
        }

        // 加载K线数据
        async function loadChartData() {
            try {
                showChartLoading(true);
                
                // 并行获取K线数据和神奇九转数据
                const [historyResponse, nineTurnResponse] = await Promise.all([
                    fetch(`/api/stock/${currentStockCode}/daily_history?days=200`),
                    fetch(`/api/stock/${currentStockCode}/nine_turn?days=200&freq=daily`)
                ]);
                
                const historyResult = await historyResponse.json();
                const nineTurnResult = await nineTurnResponse.json();
                
                if (!historyResult.success) {
                    throw new Error(historyResult.error || '获取K线数据失败');
                }
                
                allChartData = historyResult.data;
                
                // 处理神奇九转数据
                if (nineTurnResult.success && nineTurnResult.data) {
                    nineTurnData = nineTurnResult.data;
                    console.log(`[神奇九转] 成功获取${nineTurnData.length}条数据，上九转信号: ${nineTurnResult.stock_info.up_signals}个，下九转信号: ${nineTurnResult.stock_info.down_signals}个`);
                } else {
                    nineTurnData = [];
                    console.log('[神奇九转] 暂无数据或获取失败');
                }
                
                createCandlestickChart();
                
            } catch (error) {
                console.error('数据加载失败:', error);
            } finally {
                showChartLoading(false);
            }
        }

        // 创建蜡烛图
        function createCandlestickChart() {
            if (!allChartData || allChartData.length === 0) {
                return;
            }

            // 根据显示范围获取数据
            let displayData = allChartData;
            if (currentDisplayRange > 0 && allChartData.length > currentDisplayRange) {
                displayData = allChartData.slice(-currentDisplayRange);
            }

            // 准备数据
            const dates = displayData.map(item => item.trade_date);
            const formattedDates = dates.map(date => formatChartDate(date)); // 格式化日期用于成交额图表
            const opens = displayData.map(item => item.open);
            const highs = displayData.map(item => item.high);
            const lows = displayData.map(item => item.low);
            const closes = displayData.map(item => item.close);
            const amounts = displayData.map(item => item.amount); // 改为成交额

            // 创建蜡烛图
            const candlestickTrace = {
                x: dates,
                open: opens,
                high: highs,
                low: lows,
                close: closes,
                type: 'candlestick',
                name: 'K线',
                increasing: {
                    line: { color: '#ff4444', width: 1 },
                    fillcolor: '#ff4444'
                },
                decreasing: {
                    line: { color: '#00aa00', width: 1 },
                    fillcolor: '#00aa00'
                },
                hovertemplate: 
                    '日期: %{x}<br>' +
                    '开盘: %{open:.2f}<br>' +
                    '最高: %{high:.2f}<br>' +
                    '最低: %{low:.2f}<br>' +
                    '收盘: %{close:.2f}<br>' +
                    '<extra></extra>'
            };

            // 准备神奇九转指标数据
            const traces = [candlestickTrace];
            
            if (nineTurnData && nineTurnData.length > 0) {
                // 创建日期到九转数据的映射
                const nineTurnMap = {};
                nineTurnData.forEach(item => {
                    const dateKey = item.trade_date.split(' ')[0]; // 提取日期部分
                    nineTurnMap[dateKey] = item;
                });

                // 准备九转信号的标注数据
                const buySignalDates = [];
                const buySignalPrices = [];
                const buySignalTexts = [];
                const sellSignalDates = [];
                const sellSignalPrices = [];
                const sellSignalTexts = [];

                displayData.forEach((item, index) => {
                    const dateKey = item.trade_date;
                    const nineTurnItem = nineTurnMap[dateKey];
                    
                    if (nineTurnItem) {
                        // 买入信号（绿色数字，显示在蜡烛图下方）
                        if (nineTurnItem.buy_signal && nineTurnItem.buy_signal > 0) {
                            buySignalDates.push(dateKey);
                            buySignalPrices.push(item.low * 0.97); // 在最低价下方显示
                            buySignalTexts.push(nineTurnItem.buy_signal.toString());
                        }
                        
                        // 卖出信号（红色数字，显示在蜡烛图上方）
                        if (nineTurnItem.sell_signal && nineTurnItem.sell_signal > 0) {
                            sellSignalDates.push(dateKey);
                            sellSignalPrices.push(item.high * 1.03); // 在最高价上方显示
                            sellSignalTexts.push(nineTurnItem.sell_signal.toString());
                        }
                    }
                });

                // 添加买入信号（绿色数字，显示在蜡烛图下方）
                if (buySignalDates.length > 0) {
                    traces.push({
                        x: buySignalDates,
                        y: buySignalPrices,
                        mode: 'text',
                        type: 'scatter',
                        name: '九转买入',
                        text: buySignalTexts,
                        textposition: 'middle center',
                        textfont: {
                            color: '#00aa00',
                            size: 12,
                            family: 'Arial, sans-serif',
                            weight: 'bold'
                        },
                        hovertemplate: 
                            '日期: %{x}<br>' +
                            '九转买入信号: %{text}<br>' +
                            '价格: %{y:.2f}<br>' +
                            '<extra></extra>',
                        showlegend: false
                    });
                }

                // 添加卖出信号（红色数字，显示在蜡烛图上方）
                if (sellSignalDates.length > 0) {
                    traces.push({
                        x: sellSignalDates,
                        y: sellSignalPrices,
                        mode: 'text',
                        type: 'scatter',
                        name: '九转卖出',
                        text: sellSignalTexts,
                        textposition: 'middle center',
                        textfont: {
                            color: '#ff0000',
                            size: 12,
                            family: 'Arial, sans-serif',
                            weight: 'bold'
                        },
                        hovertemplate: 
                            '日期: %{x}<br>' +
                            '九转卖出信号: %{text}<br>' +
                            '价格: %{y:.2f}<br>' +
                            '<extra></extra>',
                        showlegend: false
                    });
                }
            }

            const candlestickLayout = {
                xaxis: {
                    type: 'category',
                    showgrid: true,
                    gridcolor: '#f0f0f0',
                    rangeslider: { visible: false },
                    showticklabels: false,
                    categoryorder: 'array',
                    categoryarray: dates,
                    range: [-0.5, dates.length - 0.5]
                },
                yaxis: {
                    title: '价格 (元)',
                    showgrid: true,
                    gridcolor: '#f0f0f0',
                    tickformat: '.2f'
                },
                plot_bgcolor: 'white',
                paper_bgcolor: 'white',
                font: { family: 'Arial, sans-serif', size: 12 },
                margin: { l: 50, r: 20, t: 20, b: 40 },
                showlegend: false,
                annotations: []
            };

            const config = {
                responsive: true,
                displayModeBar: false,
                staticPlot: false,
                modeBarButtonsToRemove: ['toImage', 'zoom2d', 'pan2d', 'select2d', 'lasso2d', 'zoomIn2d', 'zoomOut2d', 'autoScale2d', 'resetScale2d'],
                displaylogo: false,
                showTips: false
            };

            // 绘制蜡烛图（包含神奇九转指标）
            Plotly.newPlot('candlestickChart', traces, candlestickLayout, config);

            // 创建成交额图
            const amountTrace = {
                x: dates, // 使用原来的日期数据
                y: amounts.map(amount => amount / 10), // 将千元转换为万元
                type: 'bar',
                name: '成交额',
                marker: {
                    color: amounts.map((amount, i) => 
                        closes[i] >= opens[i] ? '#ff4444' : '#00aa00'
                    ),
                    opacity: 0.7
                },
                hovertemplate: 
                    '日期: %{x}<br>' +
                    '成交额: %{customdata}<br>' +
                    '<extra></extra>',
                customdata: amounts.map(amount => formatAmount(amount))
            };

            const amountLayout = {
                xaxis: {
                    type: 'category',
                    showgrid: true,
                    gridcolor: '#f0f0f0',
                    categoryorder: 'array',
                    categoryarray: dates,
                    range: [-0.5, dates.length - 0.5],
                    ticktext: formattedDates, // 显示格式化的日期标签（只显示月日）
                    tickvals: dates // 对应的原始日期值
                },
                yaxis: {
                    title: '成交额',
                    showgrid: true,
                    gridcolor: '#f0f0f0',
                    tickformat: '.0f',
                    ticksuffix: '万'
                },
                plot_bgcolor: 'white',
                paper_bgcolor: 'white',
                font: { family: 'Arial, sans-serif', size: 12 },
                margin: { l: 50, r: 20, t: 20, b: 40 },
                showlegend: false
            };

            // 绘制成交额图
            Plotly.newPlot('volumeChart', [amountTrace], amountLayout, config);
        }

        // 设置显示范围
        function setDisplayRange(range) {
            currentDisplayRange = range;
            
            // 更新按钮状态
            document.querySelectorAll('.chart-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // 重新绘制图表
            createCandlestickChart();
        }

        // 显示股票数据
        function displayStockData(dailyBasicResult, realtimeResult) {
            const { data: dailyData, stock_info } = dailyBasicResult;
            const realtimeData = realtimeResult.success ? realtimeResult.data : {};
            
            // 更新股票基本信息
            document.getElementById('stockName').textContent = stock_info.name || '股票名称';
            document.getElementById('stockCode').textContent = stock_info.ts_code || '';
            document.getElementById('tradeDate').textContent = formatDate(stock_info.trade_date);
            
            // 更新价格信息（优先使用实时数据）
            const currentPrice = realtimeData.price || dailyData.close;
            const changeAmount = realtimeData.change || 0;
            const changePct = realtimeData.pct_chg || 0;
            
            document.getElementById('stockPrice').textContent = formatValue(currentPrice, 'currency');
            
            const changeAmountEl = document.getElementById('changeAmount');
            const changePctEl = document.getElementById('changePercent');
            
            changeAmountEl.textContent = (changeAmount >= 0 ? '+' : '') + formatValue(changeAmount);
            changePctEl.textContent = (changePct >= 0 ? '+' : '') + formatValue(changePct, 'percentage');
            
            setValueColor(changeAmountEl, changeAmount);
            setValueColor(changePctEl, changePct);
            
            // 更新指标数据
            document.getElementById('totalMv').textContent = formatValue(dailyData.total_mv, 'large_number');
            document.getElementById('amount').textContent = formatAmount(realtimeData.amount || 0);
            document.getElementById('netInflow').textContent = formatValue(realtimeData.net_inflow || 0, 'large_number');
            document.getElementById('turnoverRate').textContent = formatValue(dailyData.turnover_rate, 'percentage');
            document.getElementById('volumeRatio').textContent = formatValue(dailyData.volume_ratio, 'ratio');
            document.getElementById('peTtm').textContent = formatValue(dailyData.pe_ttm, 'ratio');
            document.getElementById('pb').textContent = formatValue(dailyData.pb, 'ratio');
            document.getElementById('open').textContent = formatValue(realtimeData.open || dailyData.close, 'currency');
            
            const pctChgEl = document.getElementById('pctChg');
            pctChgEl.textContent = formatValue(changePct, 'percentage');
            setValueColor(pctChgEl, changePct);
            
            const netInflowEl = document.getElementById('netInflow');
            setValueColor(netInflowEl, realtimeData.net_inflow || 0);
            
            document.getElementById('industry').textContent = stock_info.industry || '未知行业';
            
            hideLoading();
            showContent();
        }

        // 显示错误
        function showError(message) {
            document.getElementById('errorDiv').textContent = message;
            document.getElementById('errorDiv').style.display = 'block';
            hideLoading();
        }

        // 显示/隐藏元素
        function hideLoading() {
            document.getElementById('loadingDiv').style.display = 'none';
        }

        function showContent() {
            document.getElementById('contentDiv').style.display = 'block';
        }

        function showChartLoading(show) {
            document.getElementById('chartLoading').style.display = show ? 'block' : 'none';
        }

        // 页面加载时自动加载数据
        window.onload = function() {
            loadStockData();
        };
    </script>
</body>
</html>