<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ËÇ°Á•®ËØ¶ÊÉÖ - ‰πùËΩ¨Â∫èÂàóÈÄâËÇ°Á≥ªÁªü</title>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        
        .back-btn {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 20px;
            cursor: pointer;
            margin-bottom: 15px;
            transition: all 0.3s ease;
        }
        
        .back-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        .stock-title {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .stock-name {
            font-size: 0.9em;
            font-weight: bold;
            color: #333;
        }
        
        .stock-code {
            font-size: 0.9em;
            color: #666;
        }
        
        .stock-price {
            font-size: 1.8em;
            font-weight: bold;
            color: #e74c3c;
        }
        
        .stock-info {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 20px;
        }
        
        .info-item {
            background: #f8f9fa;
            padding: 8px 12px;
            border-radius: 8px;
            text-align: center;
            flex: 1;
            min-width: 100px;
        }
        
        .info-label {
            font-size: 12px;
            color: #666;
            margin-bottom: 5px;
        }
        
        .info-value {
            font-size: 14px;
            font-weight: bold;
            color: #333;
        }
        
        .chart-section {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        
        .chart-title {
            font-size: 0.9em;
            font-weight: bold;
            margin-bottom: 20px;
            color: #333;
        }
        
        .kline-chart {
            width: 100%;
            height: 600px;
        }
        
        .macd-chart {
            width: 100%;
            height: 300px;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            font-size: 14px;
            color: #666;
        }
        
        .error {
            text-align: center;
            padding: 20px;
            color: #e74c3c;
            background: #ffeaea;
            border-radius: 10px;
            margin: 20px 0;
        }
        
        .price-info {
            display: flex;
            gap: 20px;
            margin-top: 10px;
            font-size: 12px;
        }
        
        .price-high {
            color: #e74c3c;
        }
        
        .price-low {
            color: #27ae60;
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .stock-title {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .stock-info {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .kline-chart {
                height: 400px;
            }
            
            .macd-chart {
                height: 200px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div id="loadingDiv" class="loading">Ê≠£Âú®Âä†ËΩΩËÇ°Á•®Êï∞ÊçÆ...</div>
            <div id="errorDiv" class="error" style="display: none;"></div>
            
            <div id="stockInfo" style="display: none;">
                <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 20px;">
                    <button class="back-btn" onclick="history.back()">‚Üê ËøîÂõû</button>
                    <div style="display: flex; flex-direction: column; gap: 10px;">
                        <button class="back-btn" id="addToWatchlistBtn" onclick="addToWatchlist()" style="background: linear-gradient(45deg, #ffc107, #fd7e14);">‚≠ê Âä†ÂÖ•Ëá™ÈÄâËÇ°</button>
                        <button class="back-btn" id="refreshDataBtn" onclick="refreshStockData()" style="background: linear-gradient(45deg, #28a745, #20c997);">üîÑ Âà∑Êñ∞Êï∞ÊçÆ</button>
                    </div>
                </div>
                <div class="stock-title">
                    <div>
                        <div class="stock-name" id="stockName"></div>
                        <div class="stock-code" id="stockCode"></div>
                    </div>
                    <div style="display: flex; align-items: center; gap: 15px;">
                        <div class="stock-price" id="stockPrice"></div>
                        <div class="price-info">
                            <span class="price-high">90Â§©ÊúÄÈ´ò: ¬•<span id="highestPrice"></span> (<span id="highestDate"></span>)</span>
                            <span class="price-low">90Â§©ÊúÄ‰Ωé: ¬•<span id="lowestPrice"></span> (<span id="lowestDate"></span>)</span>
                        </div>
                    </div>
                </div>
                
                <div class="stock-info">
                    <div class="info-item">
                        <div class="info-label">Â∏ÇÂÄº</div>
                        <div class="info-value" id="marketCap"></div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Êàê‰∫§È¢ù</div>
                        <div class="info-value" id="amount"></div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Êç¢ÊâãÁéá</div>
                        <div class="info-value" id="turnoverRate"></div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">ÈáèÊØî</div>
                        <div class="info-value" id="volumeRatio"></div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Â∏ÇÁõàÁéá(TTM)</div>
                        <div class="info-value" id="peTtm"></div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Â∏ÇÂáÄÁéá(PB)</div>
                        <div class="info-value" id="pbRatio"></div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">ÂΩìÂ§©Ê∂®ÂπÖ</div>
                        <div class="info-value" id="changePercent"></div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">ÊâÄÂ±ûË°å‰∏ö</div>
                        <div class="info-value" id="industry"></div>
                    </div>
                </div>
                
                <!-- ËµÑÈáëÊµÅÂêë‰ø°ÊÅØ -->
                <div class="moneyflow-section" id="moneyflowSection" style="display: none;">
                    <h3 style="margin: 20px 0 10px 0; color: #333; font-size: 1.0em;">ËµÑÈáëÊµÅÂêë</h3>
                    <div class="stock-info">
                        <div class="info-item">
                            <div class="info-label">‰∏ªÂäõÂáÄÊµÅÂÖ•</div>
                            <div class="info-value" id="netAmount"></div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">ÂáÄÊµÅÂÖ•Âç†ÊØî</div>
                            <div class="info-value" id="netAmountRate"></div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Ë∂ÖÂ§ßÂçïÂáÄÊµÅÂÖ•</div>
                            <div class="info-value" id="buyElgAmount"></div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Â§ßÂçïÂáÄÊµÅÂÖ•</div>
                            <div class="info-value" id="buyLgAmount"></div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">‰∏≠ÂçïÂáÄÊµÅÂÖ•</div>
                            <div class="info-value" id="buyMdAmount"></div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Â∞èÂçïÂáÄÊµÅÂÖ•</div>
                            <div class="info-value" id="buySmAmount"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="chart-section" id="chartSection" style="display: none;">
            <div class="chart-title">Êó•KÁ∫øÂõæ (ÊúÄËøë90Â§©) - ‰πùËΩ¨Â∫èÂàó</div>
            <div id="klineChart" class="kline-chart"></div>
        </div>
        
        <div class="chart-section" id="macdSection" style="display: none;">
            <div class="chart-title">MACDÊåáÊ†á</div>
            <div id="macdChart" class="macd-chart"></div>
        </div>
        
        <div class="chart-section" id="kdjSection" style="display: none;">
            <div class="chart-title">KDJÊåáÊ†á</div>
            <div id="kdjChart" class="macd-chart"></div>
        </div>
        
        <div class="chart-section" id="rsiSection" style="display: none;">
            <div class="chart-title">RSIÊåáÊ†á</div>
            <div id="rsiChart" class="macd-chart"></div>
        </div>
    </div>
    
    <script>
        const stockCode = '{{ stock_code }}';
        let stockData = null;
        
        
        function formatNumber(num, decimals = 2) {
            if (num === 0 || num === null || num === undefined) return '-';
            if (num >= 100000000) {
                return (num / 100000000).toFixed(decimals) + '‰∫ø';
            } else if (num >= 10000) {
                return (num / 10000).toFixed(decimals) + '‰∏á';
            }
            return num.toFixed(decimals);
        }
        
        function formatDate(dateStr) {
            if (!dateStr) return '';
            return dateStr.substring(0, 4) + '-' + dateStr.substring(4, 6) + '-' + dateStr.substring(6, 8);
        }
        
        // ÂÆâÂÖ®ÁöÑÊï∞ÂÄºËΩ¨Êç¢ÂáΩÊï∞ - ÁßªÂà∞ÂÖ®Â±Ä‰ΩúÁî®Âüü
        function safeParseFloat(value, defaultValue = 0) {
            if (value === null || value === undefined || value === '') {
                return defaultValue;
            }
            const parsed = parseFloat(value);
            return isNaN(parsed) ? defaultValue : parsed;
        }
        
        function loadStockData() {
            fetch(`/api/stock/${stockCode}`)
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        showError(data.error);
                        return;
                    }
                    
                    stockData = data;
                    displayStockInfo(data);
                    drawKlineChart(data);
                    drawMacdChart(data);
                    drawKdjChart(data);
                    drawRsiChart(data);
                })
                .catch(error => {
                    showError('Âä†ËΩΩÊï∞ÊçÆÂ§±Ë¥•: ' + error.message);
                });
        }
        
        function displayStockInfo(data) {
            document.getElementById('loadingDiv').style.display = 'none';
            document.getElementById('stockInfo').style.display = 'block';
            document.getElementById('chartSection').style.display = 'block';
            document.getElementById('macdSection').style.display = 'block';
            document.getElementById('kdjSection').style.display = 'block';
            document.getElementById('rsiSection').style.display = 'block';
            
            // Âä®ÊÄÅËÆæÁΩÆÈ°µÈù¢Ê†áÈ¢ò‰∏∫ËÇ°Á•®ÂêçÁß∞
            document.title = data.name + ' - ‰πùËΩ¨Â∫èÂàóÈÄâËÇ°Á≥ªÁªü';
            
            document.getElementById('stockName').textContent = data.name;
            document.getElementById('stockCode').textContent = data.ts_code;
            document.getElementById('stockPrice').textContent = '¬•' + data.latest_price.toFixed(2);
            
            document.getElementById('highestPrice').textContent = data.highest_price.toFixed(2);
            document.getElementById('lowestPrice').textContent = data.lowest_price.toFixed(2);
            document.getElementById('highestDate').textContent = formatDate(data.highest_date);
            document.getElementById('lowestDate').textContent = formatDate(data.lowest_date);
            
            document.getElementById('marketCap').textContent = formatNumber(data.market_cap * 10000);
            document.getElementById('amount').textContent = formatNumber(data.amount * 1000);
            document.getElementById('turnoverRate').textContent = data.turnover_rate.toFixed(2) + '%';
            document.getElementById('peTtm').textContent = (data.pe_ttm && data.pe_ttm > 0) ? data.pe_ttm.toFixed(2) : '-';
            document.getElementById('volumeRatio').textContent = data.volume_ratio.toFixed(2);
            
            // ÊòæÁ§∫Â∏ÇÂáÄÁéá(PB)
            document.getElementById('pbRatio').textContent = (data.pb && data.pb > 0) ? data.pb.toFixed(2) : '-';
            
            // ÊòæÁ§∫ÂΩìÂ§©Ê∂®ÂπÖ
            const changePercent = data.pct_chg || 0;
            const changeElement = document.getElementById('changePercent');
            changeElement.textContent = (changePercent >= 0 ? '+' : '') + changePercent.toFixed(2) + '%';
            changeElement.style.color = changePercent >= 0 ? '#ff4444' : '#44aa44';
            
            document.getElementById('industry').textContent = data.industry || '-';
            
            // ÊòæÁ§∫ËµÑÈáëÊµÅÂêëÊï∞ÊçÆÔºàÂ¶ÇÊûúÂèØÁî®Ôºâ
            if (data.moneyflow && data.moneyflow !== null) {
                document.getElementById('moneyflowSection').style.display = 'block';
                
                // Ê†ºÂºèÂåñËµÑÈáëÊµÅÂêëÊï∞ÂÄºÁöÑÂáΩÊï∞
                function formatMoneyflow(value) {
                    if (value === 0 || value === null || value === undefined) return '-';
                    const absValue = Math.abs(value);
                    const sign = value >= 0 ? '+' : '-';
                    let formatted;
                    
                    if (absValue >= 10000) {
                        formatted = (absValue / 10000).toFixed(2) + '‰∫ø';
                    } else {
                        formatted = absValue.toFixed(2) + '‰∏á';
                    }
                    
                    return sign + formatted;
                }
                
                // ËÆæÁΩÆÈ¢úËâ≤Ê†∑ÂºèÁöÑÂáΩÊï∞
                function setMoneyflowStyle(elementId, value) {
                    const element = document.getElementById(elementId);
                    if (value > 0) {
                        element.style.color = '#ff4444'; // Á∫¢Ëâ≤Ë°®Á§∫ÊµÅÂÖ•
                    } else if (value < 0) {
                        element.style.color = '#44aa44'; // ÁªøËâ≤Ë°®Á§∫ÊµÅÂá∫
                    } else {
                        element.style.color = '#666'; // ÁÅ∞Ëâ≤Ë°®Á§∫Êó†ÂèòÂåñ
                    }
                }
                
                // ÊòæÁ§∫‰∏ªÂäõÂáÄÊµÅÂÖ•
                const netAmount = data.moneyflow.net_amount || 0;
                document.getElementById('netAmount').textContent = formatMoneyflow(netAmount);
                setMoneyflowStyle('netAmount', netAmount);
                
                // ÊòæÁ§∫ÂáÄÊµÅÂÖ•Âç†ÊØîÔºàÂ¶ÇÊûúÊúâÔºâ
                if (data.moneyflow.net_amount_rate !== undefined) {
                    const rate = data.moneyflow.net_amount_rate || 0;
                    document.getElementById('netAmountRate').textContent = rate.toFixed(2) + '%';
                    setMoneyflowStyle('netAmountRate', rate);
                } else {
                    document.getElementById('netAmountRate').textContent = '-';
                }
                
                // ÊòæÁ§∫Ë∂ÖÂ§ßÂçïÂáÄÊµÅÂÖ•
                const buyElgAmount = data.moneyflow.buy_elg_amount || 0;
                document.getElementById('buyElgAmount').textContent = formatMoneyflow(buyElgAmount);
                setMoneyflowStyle('buyElgAmount', buyElgAmount);
                
                // ÊòæÁ§∫Â§ßÂçïÂáÄÊµÅÂÖ•
                const buyLgAmount = data.moneyflow.buy_lg_amount || 0;
                document.getElementById('buyLgAmount').textContent = formatMoneyflow(buyLgAmount);
                setMoneyflowStyle('buyLgAmount', buyLgAmount);
                
                // ÊòæÁ§∫‰∏≠ÂçïÂáÄÊµÅÂÖ•ÔºàÂ¶ÇÊûúÊúâÔºâ
                if (data.moneyflow.buy_md_amount !== undefined) {
                    const buyMdAmount = data.moneyflow.buy_md_amount || 0;
                    document.getElementById('buyMdAmount').textContent = formatMoneyflow(buyMdAmount);
                    setMoneyflowStyle('buyMdAmount', buyMdAmount);
                } else {
                    document.getElementById('buyMdAmount').textContent = '-';
                }
                
                // ÊòæÁ§∫Â∞èÂçïÂáÄÊµÅÂÖ•ÔºàÂ¶ÇÊûúÊúâÔºâ
                if (data.moneyflow.buy_sm_amount !== undefined) {
                    const buySmAmount = data.moneyflow.buy_sm_amount || 0;
                    document.getElementById('buySmAmount').textContent = formatMoneyflow(buySmAmount);
                    setMoneyflowStyle('buySmAmount', buySmAmount);
                } else {
                    document.getElementById('buySmAmount').textContent = '-';
                }
            } else {
                // Â¶ÇÊûúÊ≤°ÊúâËµÑÈáëÊµÅÂêëÊï∞ÊçÆÔºåÈöêËóèËØ•ÈÉ®ÂàÜ
                document.getElementById('moneyflowSection').style.display = 'none';
            }
        }
        
        function drawKlineChart(data) {
            const chart = echarts.init(document.getElementById('klineChart'));
            
            const klineData = data.kline_data.map(item => [
                safeParseFloat(item.open),
                safeParseFloat(item.close),
                safeParseFloat(item.low),
                safeParseFloat(item.high)
            ]);
            
            const dates = data.kline_data.map(item => formatDate(item.trade_date));
            const volumes = data.kline_data.map(item => safeParseFloat(item.vol));
            
            // ‰πùËΩ¨Â∫èÂàóÊï∞ÊçÆ - ÂéüÊúâÁöÑ1-9Êï∞Â≠ó
            const nineTurnUp = data.kline_data.map((item, index) => {
                return item.nine_turn_up > 0 ? [
                    index, // xÂùêÊ†áÔºöÊï∞ÊçÆÁ¥¢Âºï
                    safeParseFloat(item.high) + (safeParseFloat(item.high) * 0.02), // yÂùêÊ†áÔºöKÁ∫øÊúÄÈ´ò‰ª∑‰∏äÊñπ2%
                    item.nine_turn_up // ÊòæÁ§∫ÁöÑÊï∞ÂÄºÔºà1-9Ôºâ
                ] : null;
            }).filter(item => item !== null);
            
            const nineTurnDown = data.kline_data.map((item, index) => {
                return item.nine_turn_down > 0 ? [
                    index, // xÂùêÊ†áÔºöÊï∞ÊçÆÁ¥¢Âºï
                    safeParseFloat(item.low) - (safeParseFloat(item.low) * 0.02), // yÂùêÊ†áÔºöKÁ∫øÊúÄ‰Ωé‰ª∑‰∏ãÊñπ2%
                    item.nine_turn_down // ÊòæÁ§∫ÁöÑÊï∞ÂÄºÔºà1-9Ôºâ
                ] : null;
            }).filter(item => item !== null);
            
            // CountdownÊï∞ÊçÆ - Êñ∞Â¢ûÁöÑ10-13Êï∞Â≠óÔºå‰ΩçÁΩÆÊõ¥ÊûÅÁ´Ø
            const countdownUp = data.kline_data.map((item, index) => {
                return item.countdown_up > 0 ? [
                    index, // xÂùêÊ†áÔºöÊï∞ÊçÆÁ¥¢Âºï
                    safeParseFloat(item.high) + (safeParseFloat(item.high) * 0.05), // yÂùêÊ†áÔºöKÁ∫øÊúÄÈ´ò‰ª∑‰∏äÊñπ5%ÔºàÊõ¥È´ò‰ΩçÁΩÆÔºâ
                    item.countdown_up // ÊòæÁ§∫ÁöÑÊï∞ÂÄºÔºà10-13Ôºâ
                ] : null;
            }).filter(item => item !== null);
            
            const countdownDown = data.kline_data.map((item, index) => {
                return item.countdown_down > 0 ? [
                    index, // xÂùêÊ†áÔºöÊï∞ÊçÆÁ¥¢Âºï
                    safeParseFloat(item.low) - (safeParseFloat(item.low) * 0.05), // yÂùêÊ†áÔºöKÁ∫øÊúÄ‰Ωé‰ª∑‰∏ãÊñπ5%ÔºàÊõ¥‰Ωé‰ΩçÁΩÆÔºâ
                    item.countdown_down // ÊòæÁ§∫ÁöÑÊï∞ÂÄºÔºà10-13Ôºâ
                ] : null;
            }).filter(item => item !== null);
            
            // ÊèêÂèñBOLLÊï∞ÊçÆÔºå‰øùÁïônullÂÄºËÆ©EChartsÊ≠£Á°ÆÂ§ÑÁêÜ
            const bollUpper = data.kline_data.map(item => item.boll_upper === null || item.boll_upper === undefined ? null : parseFloat(item.boll_upper));
            const bollMid = data.kline_data.map(item => item.boll_mid === null || item.boll_mid === undefined ? null : parseFloat(item.boll_mid));
            const bollLower = data.kline_data.map(item => item.boll_lower === null || item.boll_lower === undefined ? null : parseFloat(item.boll_lower));
            
            // ÊâæÂà∞ÊúÄÈ´ò‰ª∑ÂíåÊúÄ‰Ωé‰ª∑ÁöÑ‰ΩçÁΩÆ
            let highestIndex = -1;
            let lowestIndex = -1;
            let maxHigh = -1;
            let minLow = Number.MAX_VALUE;
            
            // ÈÅçÂéÜÊâÄÊúâÊï∞ÊçÆÊâæÂà∞ÁúüÊ≠£ÁöÑÊúÄÈ´ò‰ª∑ÂíåÊúÄ‰Ωé‰ª∑‰ΩçÁΩÆ
            data.kline_data.forEach((item, index) => {
                const high = safeParseFloat(item.high);
                const low = safeParseFloat(item.low);
                
                if (high > maxHigh) {
                    maxHigh = high;
                    highestIndex = index;
                }
                
                if (low < minLow) {
                    minLow = low;
                    lowestIndex = index;
                }
            });
            
            console.log('ÊúÄÈ´ò‰ª∑‰ΩçÁΩÆ:', highestIndex, '‰ª∑Ê†º:', maxHigh);
            console.log('ÊúÄ‰Ωé‰ª∑‰ΩçÁΩÆ:', lowestIndex, '‰ª∑Ê†º:', minLow);
            
            const option = {
                animation: false,
                legend: {
                    bottom: 10,
                    left: 'center',
                    data: ['Êó•K', 'Êàê‰∫§Èáè', '‰πùËΩ¨Â∫èÂàó', 'Countdown']
                },
                tooltip: {
                    trigger: 'axis',
                    axisPointer: {
                        type: 'cross'
                    },
                    backgroundColor: 'rgba(245, 245, 245, 0.8)',
                    borderWidth: 1,
                    borderColor: '#ccc',
                    textStyle: {
                        color: '#000'
                    }
                },
                axisPointer: {
                    link: [
                        {
                            xAxisIndex: 'all'
                        }
                    ],
                    label: {
                        backgroundColor: '#777'
                    }
                },
                toolbox: {
                    feature: {
                        dataZoom: {
                            yAxisIndex: false
                        },
                        brush: {
                            type: ['lineX', 'clear']
                        }
                    }
                },
                brush: {
                    xAxisIndex: 'all',
                    brushLink: 'all',
                    outOfBrush: {
                        colorAlpha: 0.1
                    }
                },
                grid: [
                    {
                        left: '10%',
                        right: '8%',
                        height: '50%'
                    },
                    {
                        left: '10%',
                        right: '8%',
                        top: '63%',
                        height: '16%'
                    }
                ],
                xAxis: [
                    {
                        type: 'category',
                        data: dates,
                        boundaryGap: false,
                        axisLine: { onZero: false },
                        splitLine: { show: false },
                        min: 'dataMin',
                        max: 'dataMax',
                        axisPointer: {
                            z: 100
                        }
                    },
                    {
                        type: 'category',
                        gridIndex: 1,
                        data: dates,
                        boundaryGap: false,
                        axisLine: { onZero: false },
                        axisTick: { show: false },
                        splitLine: { show: false },
                        axisLabel: { show: false },
                        min: 'dataMin',
                        max: 'dataMax'
                    }
                ],
                yAxis: [
                    {
                        scale: true,
                        splitArea: {
                            show: true
                        }
                    },
                    {
                        scale: true,
                        gridIndex: 1,
                        splitNumber: 2,
                        axisLabel: { show: false },
                        axisLine: { show: false },
                        axisTick: { show: false },
                        splitLine: { show: false }
                    }
                ],
                dataZoom: [
                    {
                        type: 'inside',
                        xAxisIndex: [0, 1],
                        start: 0,
                        end: 100
                    },
                    {
                        show: true,
                        xAxisIndex: [0, 1],
                        type: 'slider',
                        top: '85%',
                        start: 0,
                        end: 100
                    }
                ],
                series: [
                    {
                        name: 'Êó•K',
                        type: 'candlestick',
                        data: klineData,
                        itemStyle: {
                            color: '#ef232a',
                            color0: '#14b143',
                            borderColor: '#ef232a',
                            borderColor0: '#14b143'
                        },
                        markPoint: {
                            symbol: 'circle',
                            symbolSize: 8,
                            label: {
                                show: true,
                                position: 'top',
                                formatter: function (param) {
                                    return param.value ? param.value.toFixed(2) : '';
                                },
                                color: '#000000',
                                backgroundColor: 'rgba(255,255,255,0.9)',
                                borderWidth: 1,
                                borderColor: '#cccccc',
                                borderRadius: 3,
                                padding: [2, 4],
                                fontSize: 12,
                                fontWeight: 'bold'
                            },
                            data: [
                                {
                                    name: 'ÊúÄÈ´ò‰ª∑',
                                    coord: [highestIndex, maxHigh],
                                    value: maxHigh,
                                    itemStyle: {
                                        color: '#ff4444'
                                    }
                                },
                                {
                                    name: 'ÊúÄ‰Ωé‰ª∑',
                                    coord: [lowestIndex, minLow],
                                    value: minLow,
                                    itemStyle: {
                                        color: '#44ff44'
                                    }
                                }
                            ].filter(item => item.coord[0] >= 0), // ËøáÊª§ÊéâÊó†ÊïàÁöÑÁ¥¢Âºï
                            tooltip: {
                                formatter: function (param) {
                                    return param.name + '<br>¬•' + (param.data.coord ? param.data.coord[1].toFixed(2) : '');
                                }
                            }
                        }
                    },
                    {
                        name: 'Êàê‰∫§Èáè',
                        type: 'bar',
                        xAxisIndex: 1,
                        yAxisIndex: 1,
                        data: volumes,
                        itemStyle: {
                            color: function(params) {
                                const dataIndex = params.dataIndex;
                                if (dataIndex === 0) return '#14b143';
                                return klineData[dataIndex][1] > klineData[dataIndex][0] ? '#ef232a' : '#14b143';
                            }
                        }
                    },
                    {
                        name: '‰πùËΩ¨Â∫èÂàó(‰∏ä)',
                        type: 'scatter',
                        data: nineTurnUp,
                        symbolSize: 0, // ÈöêËóèÊï£ÁÇπÁ¨¶Âè∑
                        itemStyle: {
                            color: 'transparent'
                        },
                        label: {
                            show: true,
                            position: 'inside',
                            color: '#ef232a', // Á∫¢Ëâ≤Êï∞Â≠ó
                            fontWeight: 'bold',
                            fontSize: 14,
                            backgroundColor: 'rgba(255,255,255,0.8)',
                            borderRadius: 3,
                            padding: [2, 4],
                            formatter: function(param) {
                                return param.data[2]; // Êï∞ÁªÑÁöÑÁ¨¨‰∏â‰∏™ÂÖÉÁ¥†ÊòØÊï∞ÂÄºÔºà1-9Ôºâ
                            }
                        }
                    },
                    {
                        name: '‰πùËΩ¨Â∫èÂàó(‰∏ã)',
                        type: 'scatter',
                        data: nineTurnDown,
                        symbolSize: 0, // ÈöêËóèÊï£ÁÇπÁ¨¶Âè∑
                        itemStyle: {
                            color: 'transparent'
                        },
                        label: {
                            show: true,
                            position: 'inside',
                            color: '#14b143', // ÁªøËâ≤Êï∞Â≠ó
                            fontWeight: 'bold',
                            fontSize: 14,
                            backgroundColor: 'rgba(255,255,255,0.8)',
                            borderRadius: 3,
                            padding: [2, 4],
                            formatter: function(param) {
                                return param.data[2]; // Êï∞ÁªÑÁöÑÁ¨¨‰∏â‰∏™ÂÖÉÁ¥†ÊòØÊï∞ÂÄºÔºà1-9Ôºâ
                            }
                        }
                    },
                    {
                        name: 'Countdown(‰∏ä)',
                        type: 'scatter',
                        data: countdownUp,
                        symbolSize: 0, // ÈöêËóèÊï£ÁÇπÁ¨¶Âè∑
                        itemStyle: {
                            color: 'transparent'
                        },
                        label: {
                            show: true,
                            position: 'inside',
                            color: '#8A2BE2', // Á¥´Ëâ≤Êï∞Â≠ó
                            fontWeight: 'bold',
                            fontSize: 14,
                            backgroundColor: 'rgba(255,255,255,0.8)',
                            borderRadius: 3,
                            padding: [2, 4],
                            formatter: function(param) {
                                return param.data[2]; // Êï∞ÁªÑÁöÑÁ¨¨‰∏â‰∏™ÂÖÉÁ¥†ÊòØÊï∞ÂÄºÔºà10-13Ôºâ
                            }
                        }
                    },
                    {
                        name: 'Countdown(‰∏ã)',
                        type: 'scatter',
                        data: countdownDown,
                        symbolSize: 0, // ÈöêËóèÊï£ÁÇπÁ¨¶Âè∑
                        itemStyle: {
                            color: 'transparent'
                        },
                        label: {
                            show: true,
                            position: 'inside',
                            color: '#1E90FF', // ËìùËâ≤Êï∞Â≠ó
                            fontWeight: 'bold',
                            fontSize: 14,
                            backgroundColor: 'rgba(255,255,255,0.8)',
                            borderRadius: 3,
                            padding: [2, 4],
                            formatter: function(param) {
                                return param.data[2]; // Êï∞ÁªÑÁöÑÁ¨¨‰∏â‰∏™ÂÖÉÁ¥†ÊòØÊï∞ÂÄºÔºà10-13Ôºâ
                            }
                        }
                    },
                    {
                        name: 'BOLL‰∏äËΩ®',
                        type: 'line',
                        data: bollUpper,
                        lineStyle: {
                            color: '#1E90FF',
                            width: 1
                        },
                        symbol: 'none',
                        smooth: true
                    },
                    {
                        name: 'BOLL‰∏≠ËΩ®',
                        type: 'line',
                        data: bollMid,
                        lineStyle: {
                            color: '#1E90FF',
                            width: 1
                        },
                        symbol: 'none',
                        smooth: true
                    },
                    {
                        name: 'BOLL‰∏ãËΩ®',
                        type: 'line',
                        data: bollLower,
                        lineStyle: {
                            color: '#1E90FF',
                            width: 1
                        },
                        symbol: 'none',
                        smooth: true
                    }
                ]
            };
            
            chart.setOption(option);
            
            window.addEventListener('resize', function() {
                chart.resize();
            });
        }
        
        function drawMacdChart(data) {
            const chart = echarts.init(document.getElementById('macdChart'));
            
            const dates = data.kline_data.map(item => formatDate(item.trade_date));
            
            // ÊèêÂèñMACDÊï∞ÊçÆ
            const macdDif = data.kline_data.map(item => item.macd_dif === null || item.macd_dif === undefined ? null : parseFloat(item.macd_dif));
            const macdDea = data.kline_data.map(item => item.macd_dea === null || item.macd_dea === undefined ? null : parseFloat(item.macd_dea));
            const macdHistogram = data.kline_data.map(item => item.macd_histogram === null || item.macd_histogram === undefined ? null : parseFloat(item.macd_histogram));
            
            const option = {
                animation: false,
                legend: {
                    bottom: 10,
                    left: 'center',
                    data: ['DIF', 'DEA', 'MACD']
                },
                tooltip: {
                    trigger: 'axis',
                    axisPointer: {
                        type: 'cross'
                    }
                },
                grid: {
                    left: '10%',
                    right: '8%',
                    top: '10%',
                    bottom: '15%'
                },
                xAxis: {
                    type: 'category',
                    data: dates,
                    boundaryGap: false
                },
                yAxis: {
                    scale: true,
                    splitArea: {
                        show: true
                    }
                },
                dataZoom: [
                    {
                        type: 'inside',
                        start: 0,
                        end: 100
                    },
                    {
                        show: true,
                        type: 'slider',
                        bottom: '5%',
                        start: 0,
                        end: 100
                    }
                ],
                series: [
                    {
                        name: 'DIF',
                        type: 'line',
                        data: macdDif,
                        lineStyle: {
                            color: '#FF6B6B',
                            width: 2
                        },
                        symbol: 'none',
                        smooth: true
                    },
                    {
                        name: 'DEA',
                        type: 'line',
                        data: macdDea,
                        lineStyle: {
                            color: '#4ECDC4',
                            width: 2
                        },
                        symbol: 'none',
                        smooth: true
                    },
                    {
                        name: 'MACD',
                        type: 'bar',
                        data: macdHistogram,
                        itemStyle: {
                            color: function(params) {
                                return params.value >= 0 ? '#FF6B6B' : '#4ECDC4';
                            }
                        }
                    }
                ]
            };
            
            chart.setOption(option);
            
            window.addEventListener('resize', function() {
                chart.resize();
            });
        }
        
        function drawKdjChart(data) {
            const chart = echarts.init(document.getElementById('kdjChart'));
            
            const dates = data.kline_data.map(item => formatDate(item.trade_date));
            
            // ÊèêÂèñKDJÊï∞ÊçÆ
            const kdjK = data.kline_data.map(item => item.kdj_k === null || item.kdj_k === undefined ? null : parseFloat(item.kdj_k));
            const kdjD = data.kline_data.map(item => item.kdj_d === null || item.kdj_d === undefined ? null : parseFloat(item.kdj_d));
            const kdjJ = data.kline_data.map(item => item.kdj_j === null || item.kdj_j === undefined ? null : parseFloat(item.kdj_j));
            
            const option = {
                animation: false,
                legend: {
                    bottom: 10,
                    left: 'center',
                    data: ['K', 'D', 'J']
                },
                tooltip: {
                    trigger: 'axis',
                    axisPointer: {
                        type: 'cross'
                    }
                },
                grid: {
                    left: '10%',
                    right: '8%',
                    top: '10%',
                    bottom: '15%'
                },
                xAxis: {
                    type: 'category',
                    data: dates,
                    boundaryGap: false
                },
                yAxis: {
                    scale: true,
                    min: 0,
                    max: 100,
                    splitArea: {
                        show: true
                    },
                    axisLine: {
                        lineStyle: {
                            color: '#ccc'
                        }
                    },
                    splitLine: {
                        lineStyle: {
                            color: ['#20', '#80'],
                            type: 'dashed'
                        }
                    }
                },
                dataZoom: [
                    {
                        type: 'inside',
                        start: 0,
                        end: 100
                    },
                    {
                        show: true,
                        type: 'slider',
                        bottom: '5%',
                        start: 0,
                        end: 100
                    }
                ],
                series: [
                    {
                        name: 'K',
                        type: 'line',
                        data: kdjK,
                        lineStyle: {
                            color: '#FF6B6B',
                            width: 2
                        },
                        symbol: 'none',
                        smooth: true
                    },
                    {
                        name: 'D',
                        type: 'line',
                        data: kdjD,
                        lineStyle: {
                            color: '#4ECDC4',
                            width: 2
                        },
                        symbol: 'none',
                        smooth: true
                    },
                    {
                        name: 'J',
                        type: 'line',
                        data: kdjJ,
                        lineStyle: {
                            color: '#45B7D1',
                            width: 2
                        },
                        symbol: 'none',
                        smooth: true
                    }
                ],
                // Ê∑ªÂä†Ë∂Ö‰π∞Ë∂ÖÂçñÂå∫ÂüüÊ†áËØÜ
                markLine: {
                    silent: true,
                    lineStyle: {
                        color: '#999',
                        type: 'dashed',
                        width: 1
                    },
                    data: [
                        {
                            yAxis: 20,
                            label: {
                                formatter: 'Ë∂ÖÂçñÂå∫ 20',
                                position: 'insideEndTop'
                            }
                        },
                        {
                            yAxis: 80,
                            label: {
                                formatter: 'Ë∂Ö‰π∞Âå∫ 80',
                                position: 'insideEndBottom'
                            }
                        }
                    ]
                }
            };
            
            chart.setOption(option);
            
            window.addEventListener('resize', function() {
                chart.resize();
            });
        }
        
        function drawRsiChart(data) {
            const chart = echarts.init(document.getElementById('rsiChart'));
            
            const dates = data.kline_data.map(item => formatDate(item.trade_date));
            
            // ÊèêÂèñRSIÊï∞ÊçÆ
            const rsiData = data.kline_data.map(item => item.rsi === null || item.rsi === undefined ? null : parseFloat(item.rsi));
            
            const option = {
                animation: false,
                legend: {
                    bottom: 10,
                    left: 'center',
                    data: ['RSI']
                },
                tooltip: {
                    trigger: 'axis',
                    axisPointer: {
                        type: 'cross'
                    },
                    formatter: function(params) {
                        if (params && params.length > 0) {
                            const value = params[0].value;
                            return params[0].name + '<br/>RSI: ' + (value !== null ? value.toFixed(2) : '-');
                        }
                        return '';
                    }
                },
                grid: {
                    left: '10%',
                    right: '8%',
                    top: '10%',
                    bottom: '15%'
                },
                xAxis: {
                    type: 'category',
                    data: dates,
                    boundaryGap: false
                },
                yAxis: {
                    scale: true,
                    min: 0,
                    max: 100,
                    splitArea: {
                        show: true
                    },
                    axisLine: {
                        lineStyle: {
                            color: '#ccc'
                        }
                    },
                    splitLine: {
                        lineStyle: {
                            color: ['#30', '#70'],
                            type: 'dashed'
                        }
                    }
                },
                dataZoom: [
                    {
                        type: 'inside',
                        start: 0,
                        end: 100
                    },
                    {
                        show: true,
                        type: 'slider',
                        bottom: '5%',
                        start: 0,
                        end: 100
                    }
                ],
                series: [
                    {
                        name: 'RSI',
                        type: 'line',
                        data: rsiData,
                        lineStyle: {
                            color: '#9C27B0',
                            width: 2
                        },
                        symbol: 'none',
                        smooth: true,
                        areaStyle: {
                            color: {
                                type: 'linear',
                                x: 0,
                                y: 0,
                                x2: 0,
                                y2: 1,
                                colorStops: [
                                    {
                                        offset: 0,
                                        color: 'rgba(156, 39, 176, 0.3)'
                                    },
                                    {
                                        offset: 1,
                                        color: 'rgba(156, 39, 176, 0.1)'
                                    }
                                ]
                            }
                        },
                        markLine: {
                             silent: true,
                             data: [
                                 {
                                     yAxis: 30,
                                     lineStyle: {
                                         color: '#27ae60',
                                         type: 'dashed',
                                         width: 2
                                     },
                                     label: {
                                         formatter: 'Ë∂ÖÂçñÂå∫ 30',
                                         position: 'insideEndTop',
                                         color: '#27ae60',
                                         fontWeight: 'bold'
                                     }
                                 },
                                 {
                                     yAxis: 70,
                                     lineStyle: {
                                         color: '#e74c3c',
                                         type: 'dashed',
                                         width: 2
                                     },
                                     label: {
                                         formatter: 'Ë∂Ö‰π∞Âå∫ 70',
                                         position: 'insideEndBottom',
                                         color: '#e74c3c',
                                         fontWeight: 'bold'
                                     }
                                 }
                             ]
                         }
                    }
                ]
            };
            
            chart.setOption(option);
            
            window.addEventListener('resize', function() {
                chart.resize();
            });
        }
        
        function showError(message) {
            document.getElementById('loadingDiv').style.display = 'none';
            document.getElementById('errorDiv').textContent = message;
            document.getElementById('errorDiv').style.display = 'block';
        }
        
        function refreshStockData() {
            const refreshBtn = document.getElementById('refreshDataBtn');
            const originalText = refreshBtn.textContent;
            
            // ÊòæÁ§∫Âä†ËΩΩÁä∂ÊÄÅ
            refreshBtn.textContent = 'üîÑ Âà∑Êñ∞‰∏≠...';
            refreshBtn.disabled = true;
            
            // ÊòæÁ§∫Âä†ËΩΩÊèêÁ§∫
            document.getElementById('stockInfo').style.display = 'none';
            document.getElementById('chartSection').style.display = 'none';
            document.getElementById('macdSection').style.display = 'none';
            document.getElementById('kdjSection').style.display = 'none';
            document.getElementById('rsiSection').style.display = 'none';
            document.getElementById('loadingDiv').style.display = 'block';
            document.getElementById('loadingDiv').textContent = 'Ê≠£Âú®Âº∫Âà∂Âà∑Êñ∞Êï∞ÊçÆ...';
            document.getElementById('errorDiv').style.display = 'none';
            
            // Âº∫Âà∂Âà∑Êñ∞Êï∞ÊçÆÔºàÊ∑ªÂä†Êó∂Èó¥Êà≥ÂèÇÊï∞ÈÅøÂÖçÁºìÂ≠òÔºâ
            const timestamp = new Date().getTime();
            fetch(`/api/stock/${stockCode}?force_refresh=true&t=${timestamp}`)
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        showError(data.error);
                        return;
                    }
                    
                    stockData = data;
                    displayStockInfo(data);
                    drawKlineChart(data);
                    drawMacdChart(data);
                    drawKdjChart(data);
                    drawRsiChart(data);
                    
                    // Êï∞ÊçÆÂà∑Êñ∞ÊàêÂäüÔºå‰∏çÊòæÁ§∫ÊèêÁ§∫Ê°Ü
                })
                .catch(error => {
                    showError('Âà∑Êñ∞Êï∞ÊçÆÂ§±Ë¥•: ' + error.message);
                })
                .finally(() => {
                    // ÊÅ¢Â§çÊåâÈíÆÁä∂ÊÄÅ
                    refreshBtn.textContent = originalText;
                    refreshBtn.disabled = false;
                });
        }
        
        function addToWatchlist() {
            if (!stockData) {
                alert('ËÇ°Á•®Êï∞ÊçÆÂ∞öÊú™Âä†ËΩΩÂÆåÊàêÔºåËØ∑Á®çÂêéÂÜçËØï');
                return;
            }
            
            // Ëé∑ÂèñÊúÄÊñ∞ÁöÑ‰πùËΩ¨Â∫èÂàóÊï∞ÊçÆ
            let nineTurnUp = 0;
            let nineTurnDown = 0;
            if (stockData.kline_data && stockData.kline_data.length > 0) {
                const latestData = stockData.kline_data[stockData.kline_data.length - 1];
                nineTurnUp = latestData.nine_turn_up || 0;
                nineTurnDown = latestData.nine_turn_down || 0;
            }
            
            const watchlistData = {
                ts_code: stockData.ts_code,
                name: stockData.name,
                latest_price: stockData.latest_price,
                pct_chg: stockData.pct_chg || 0,
                industry: stockData.industry || '-',
                 volume_ratio: stockData.volume_ratio || 0,
                 pe: stockData.pe || 0,
                 amount: stockData.amount || 0,
                 total_mv: stockData.total_mv || 0,
                 nine_turn_up: nineTurnUp,
                 nine_turn_down: nineTurnDown,
                add_time: new Date().toISOString()
            };
            
            fetch('/api/watchlist/add', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(watchlistData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const btn = document.getElementById('addToWatchlistBtn');
                    btn.textContent = '‚úì Â∑≤Âä†ÂÖ•Ëá™ÈÄâËÇ°';
                    btn.style.background = 'linear-gradient(45deg, #28a745, #20c997)';
                    btn.onclick = null;
                } else {
                    alert(data.message || 'Âä†ÂÖ•Ëá™ÈÄâËÇ°Â§±Ë¥•');
                }
            })
            .catch(error => {
                alert('Âä†ÂÖ•Ëá™ÈÄâËÇ°Â§±Ë¥•: ' + error.message);
            });
        }
        
        // È°µÈù¢Âä†ËΩΩÊó∂Ëé∑ÂèñËÇ°Á•®Êï∞ÊçÆ
        loadStockData();
    </script>
</body>
</html>