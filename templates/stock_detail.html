<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è‚¡ç¥¨è¯¦æƒ… - ä¹è½¬åºåˆ—é€‰è‚¡åŠå››å¤©æŒè‚¡äº¤æ˜“ç³»ç»Ÿ</title>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        
        .back-btn {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 20px;
            cursor: pointer;
            margin-bottom: 15px;
            transition: all 0.3s ease;
        }
        
        .back-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        .stock-title {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .stock-name {
            font-size: 0.9em;
            font-weight: bold;
            color: #333;
        }
        
        .stock-code {
            font-size: 0.9em;
            color: #666;
        }
        
        .stock-price {
            font-size: 1.8em;
            font-weight: bold;
            color: #e74c3c;
        }
        
        .stock-info {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 20px;
        }
        
        .info-item {
            background: #f8f9fa;
            padding: 8px 12px;
            border-radius: 8px;
            text-align: center;
            flex: 1;
            min-width: 100px;
        }
        
        .info-label {
            font-size: 12px;
            color: #666;
            margin-bottom: 5px;
        }
        
        .info-value {
            font-size: 14px;
            font-weight: bold;
            color: #333;
        }
        
        .chart-section {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        
        .chart-title {
            font-size: 0.9em;
            font-weight: bold;
            margin-bottom: 20px;
            color: #333;
        }
        
        .kline-chart {
            width: 100%;
            height: 600px;
        }
        
        .macd-chart {
            width: 100%;
            height: 300px;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            font-size: 14px;
            color: #666;
        }
        
        .error {
            text-align: center;
            padding: 20px;
            color: #e74c3c;
            background: #ffeaea;
            border-radius: 10px;
            margin: 20px 0;
        }
        
        .price-info {
            display: flex;
            gap: 20px;
            margin-top: 10px;
            font-size: 12px;
        }
        
        .price-high {
            color: #e74c3c;
        }
        
        .price-low {
            color: #27ae60;
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .stock-title {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .stock-info {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .kline-chart {
                height: 400px;
            }
            
            .macd-chart {
                height: 200px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div id="loadingDiv" class="loading">æ­£åœ¨åŠ è½½è‚¡ç¥¨æ•°æ®...</div>
            <div id="errorDiv" class="error" style="display: none;"></div>
            
            <div id="stockInfo" style="display: none;">
                <div style="display: flex; justify-content: flex-end; align-items: flex-start; margin-bottom: 20px;">
                    <div style="display: flex; flex-direction: row; gap: 10px; align-items: center;">
                        <div style="position: relative; display: inline-block;">
                            <select id="addToWatchlistSelect" onchange="addToWatchlistWithPriority(this.value)" style="
                                background: linear-gradient(45deg, #ffc107, #fd7e14);
                                color: #333;
                                border: none;
                                padding: 10px 20px;
                                border-radius: 20px;
                                cursor: pointer;
                                font-size: 14px;
                                font-weight: bold;
                                transition: all 0.3s ease;
                                appearance: none;
                                -webkit-appearance: none;
                                -moz-appearance: none;
                                padding-right: 30px;
                                background-image: url('data:image/svg+xml;charset=US-ASCII,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 4 5%22><path fill=%22%23333%22 d=%22M2 0L0 2h4zm0 5L0 3h4z%22/></svg>');
                                background-repeat: no-repeat;
                                background-position: right 10px center;
                                background-size: 12px;
                                min-width: 120px;
                                height: 40px;
                            ">
                                <option value="" disabled selected>â­ åŠ å…¥è‡ªé€‰è‚¡</option>
                                <option value="purple" style="background-color: #8e44ad; color: white;">ğŸŸ£ å¯ç«‹å³ä¹°å…¥</option>
                                <option value="red" style="background-color: #e74c3c; color: white;">ğŸ”´ é‡ç‚¹å…³æ³¨</option>
                                <option value="green" style="background-color: #27ae60; color: white;">ğŸŸ¢ è§‚å¯Ÿ</option>
                                <option value="holding" style="background-color: #ff9800; color: white;">ğŸŸ  æŒä»“ä¸­</option>
                                <option value="sold" style="background-color: #9e9e9e; color: white;">âš« å·²å–å‡º</option>
                            </select>
                        </div>
                        <button id="removeFromWatchlistBtn" onclick="removeFromWatchlist()" style="
                            background: linear-gradient(45deg, #dc3545, #c82333);
                            color: white;
                            border: none;
                            padding: 10px 20px;
                            border-radius: 20px;
                            cursor: pointer;
                            font-size: 14px;
                            font-weight: bold;
                            transition: all 0.3s ease;
                            display: none;
                            min-width: 120px;
                            height: 40px;
                        ">ğŸ—‘ï¸ åˆ é™¤è‡ªé€‰</button>
                        <button id="refreshDataBtn" onclick="refreshStockData()" style="
                            background: linear-gradient(45deg, #28a745, #20c997);
                            color: white;
                            border: none;
                            padding: 10px 20px;
                            border-radius: 20px;
                            cursor: pointer;
                            font-size: 14px;
                            font-weight: bold;
                            transition: all 0.3s ease;
                            min-width: 120px;
                            height: 40px;
                        ">ğŸ”„ åˆ·æ–°æ•°æ®</button>
                    </div>
                </div>
                <div class="stock-title">
                    <div>
                        <div class="stock-name" id="stockName"></div>
                        <div class="stock-code" id="stockCode"></div>
                    </div>
                    <div style="display: flex; align-items: center; gap: 15px;">
                        <div class="stock-price" id="stockPrice"></div>
                        <div class="price-info">
                            <span class="price-high">90å¤©æœ€é«˜: Â¥<span id="highestPrice"></span> (<span id="highestDate"></span>)</span>
                            <span class="price-low">90å¤©æœ€ä½: Â¥<span id="lowestPrice"></span> (<span id="lowestDate"></span>) <span id="lastKlineDate" style="color: black; float: right;"></span></span>
                        </div>
                    </div>
                </div>
                
                <div class="stock-info">
                    <div class="info-item">
                        <div class="info-label">å¸‚å€¼</div>
                        <div class="info-value" id="marketCap"></div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">æˆäº¤é¢</div>
                        <div class="info-value" id="amount"></div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">å‡€æµå…¥é¢</div>
                        <div class="info-value" id="netMfAmount"></div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">æ¢æ‰‹ç‡</div>
                        <div class="info-value" id="turnoverRate"></div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">é‡æ¯”</div>
                        <div class="info-value" id="volumeRatio"></div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">å¸‚ç›ˆç‡(TTM)</div>
                        <div class="info-value" id="peTtm"></div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">å¸‚å‡€ç‡(PB)</div>
                        <div class="info-value" id="pbRatio"></div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">å½“å¤©å¼€ç›˜ä»·</div>
                        <div class="info-value" id="openPrice">-</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">å½“å¤©æ¶¨å¹…</div>
                        <div class="info-value" id="changePercent"></div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">æ‰€å±è¡Œä¸š</div>
                        <div class="info-value" id="industry"></div>
                    </div>
                </div>
                
                <!-- èµ„é‡‘æµå‘ä¿¡æ¯ -->
                <div class="moneyflow-section" id="moneyflowSection" style="display: none;">
                    <h3 style="margin: 20px 0 10px 0; color: #333; font-size: 1.0em;">èµ„é‡‘æµå‘</h3>
                    <div class="stock-info">

                        <div class="info-item">
                            <div class="info-label">ç‰¹å¤§å•ä¹°å…¥é‡‘é¢</div>
                            <div class="info-value" id="buyElgAmount"></div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">ç‰¹å¤§å•å–å‡ºé‡‘é¢</div>
                            <div class="info-value" id="sellElgAmount"></div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">å¤§å•ä¹°å…¥é‡‘é¢</div>
                            <div class="info-value" id="buyLgAmount"></div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">å¤§å•å–å‡ºé‡‘é¢</div>
                            <div class="info-value" id="sellLgAmount"></div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">ä¸­å•ä¹°å…¥é‡‘é¢</div>
                            <div class="info-value" id="buyMdAmount"></div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">ä¸­å•å–å‡ºé‡‘é¢</div>
                            <div class="info-value" id="sellMdAmount"></div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">å°å•ä¹°å…¥é‡‘é¢</div>
                            <div class="info-value" id="buySmAmount"></div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">å°å•å–å‡ºé‡‘é¢</div>
                            <div class="info-value" id="sellSmAmount"></div>
                        </div>
                    </div>
                </div>
                
                <!-- å®æ—¶æ•°æ®ä¿¡æ¯ -->
                <div class="realtime-section" id="realtimeSection" style="display: none;">
                    <h3 style="margin: 20px 0 10px 0; color: #333; font-size: 1.0em;">å®æ—¶æ•°æ®</h3>
                    <div class="stock-info">
                        <div class="info-item">
                    <div class="info-label">å®æ—¶ä»·æ ¼ (å‰å¤æƒ)</div>
                    <div class="info-value" id="realtimePrice">-</div>
                </div>
                        <div class="info-item">
                            <div class="info-label">æ¶¨å¹…</div>
                            <div class="info-value" id="realtimeChangePercent">-</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">æˆäº¤é¢</div>
                            <div class="info-value" id="realtimeAmount">-</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">æ¢æ‰‹ç‡</div>
                            <div class="info-value" id="realtimeTurnover">-</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">é‡æ¯”</div>
                            <div class="info-value" id="realtimeVolumeRatio">-</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">å‡€æµå…¥é¢</div>
                            <div class="info-value" id="realtimeNetInflow">-</div>
                        </div>
                    </div>
                    
                    <!-- å®æ—¶åˆ†æ—¶å›¾ -->
                    <div class="chart-container" style="margin-top: 20px;">
                        <h4 style="margin: 10px 0; color: #333; font-size: 0.9em;">å®æ—¶åˆ†æ—¶å›¾ (å‰å¤æƒä»·æ ¼)</h4>
                        <div id="realtimeMinuteChart" style="width: 100%; height: 300px;"></div>
                    </div>
                    
                    <!-- å®æ—¶Kçº¿å›¾ -->
                    <div class="chart-container" style="margin-top: 20px;">
                        <h4 style="margin: 10px 0; color: #333; font-size: 0.9em;">å®æ—¶Kçº¿å›¾ (æœ€è¿‘90å¤©) - å‰å¤æƒ</h4>
                        <div id="realtimeKlineChart" style="width: 100%; height: 400px;"></div>
                    </div>
                    
                    <div style="text-align: center; margin-top: 15px; padding: 10px; background-color: #f8f9fa; border-radius: 8px;">
                        <div style="margin-bottom: 10px;">
                            <button id="autoRefreshBtn" onclick="toggleRealtimeAutoRefresh()" style="background: #27ae60; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-size: 0.9em; margin-right: 10px; min-width: 140px; height: 40px;">â–¶ï¸ å¼€å§‹è‡ªåŠ¨åˆ·æ–°</button>
                            <button onclick="loadRealtimeData()" style="background: linear-gradient(45deg, #007bff, #0056b3); color: white; border: none; padding: 10px 16px; border-radius: 6px; cursor: pointer; font-size: 0.9em; min-width: 120px; height: 40px;">ğŸ”„ æ‰‹åŠ¨åˆ·æ–°</button>
                        </div>
                        <div id="lastRefreshTime" style="font-size: 0.8em; color: #666; margin-top: 5px;">ç‚¹å‡»å¼€å§‹è‡ªåŠ¨åˆ·æ–°</div>
                        <div style="font-size: 0.75em; color: #999; margin-top: 3px;">è‡ªåŠ¨åˆ·æ–°é—´éš”: 10ç§’ (ç¬¦åˆAKShareå®˜æ–¹å»ºè®®)</div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="chart-section" id="chartSection" style="display: none;">
            <div class="chart-title">æ—¥Kçº¿å›¾ (æœ€è¿‘90å¤©) - ä¹è½¬åºåˆ— - å‰å¤æƒä»·æ ¼</div>
            <div id="klineChart" class="kline-chart"></div>
        </div>
        
        <div class="chart-section" id="macdSection" style="display: none;">
            <div class="chart-title">MACDæŒ‡æ ‡</div>
            <div id="macdChart" class="macd-chart"></div>
        </div>
        
        <div class="chart-section" id="kdjSection" style="display: none;">
            <div class="chart-title">KDJæŒ‡æ ‡ (Kçº¿-ç´«è‰², Dçº¿-è“è‰², Jçº¿-çº¢è‰²)</div>
            <div id="kdjChart" class="macd-chart"></div>
        </div>
        
        <div class="chart-section" id="rsiSection" style="display: none;">
            <div class="chart-title">RSIæŒ‡æ ‡</div>
            <div id="rsiChart" class="macd-chart"></div>
        </div>
    </div>
    
    <script>
        const stockCode = '{{ stock_code }}';
        let stockData = null;
        
        
        function formatNumber(num, decimals = 2) {
            if (num === 0 || num === null || num === undefined) return '-';
            if (num >= 100000000) {
                return (num / 100000000).toFixed(decimals) + 'äº¿';
            } else if (num >= 10000) {
                return (num / 10000).toFixed(decimals) + 'ä¸‡';
            }
            return num.toFixed(decimals);
        }
        
        function formatDate(dateStr) {
            if (!dateStr) return '';
            return dateStr.substring(0, 4) + '-' + dateStr.substring(4, 6) + '-' + dateStr.substring(6, 8);
        }
        
        function formatDateChinese(dateStr) {
            if (!dateStr) return '';
            const year = dateStr.substring(0, 4);
            const month = parseInt(dateStr.substring(4, 6));
            const day = parseInt(dateStr.substring(6, 8));
            return `${year}å¹´${month}æœˆ${day}æ—¥`;
        }
        
        // å®‰å…¨çš„æ•°å€¼è½¬æ¢å‡½æ•° - ç§»åˆ°å…¨å±€ä½œç”¨åŸŸ
        function safeParseFloat(value, defaultValue = 0) {
            // å¤„ç†nullã€undefinedã€ç©ºå­—ç¬¦ä¸²ç­‰æ— æ•ˆå€¼
            if (value === null || value === undefined || value === '') {
                return defaultValue;
            }
            
            // å¤„ç†å­—ç¬¦ä¸²ç±»å‹çš„æ•°å€¼
            if (typeof value === 'string') {
                // ç§»é™¤å¯èƒ½çš„ç©ºæ ¼å’Œç‰¹æ®Šå­—ç¬¦
                value = value.trim();
                if (value === '') {
                    return defaultValue;
                }
            }
            
            // å¦‚æœå·²ç»æ˜¯æ•°å­—ç±»å‹ä¸”æœ‰æ•ˆï¼Œç›´æ¥è¿”å›
            if (typeof value === 'number' && !isNaN(value) && isFinite(value)) {
                return value;
            }
            
            // å°è¯•è§£æä¸ºæµ®ç‚¹æ•°
            const parsed = parseFloat(value);
            
            // éªŒè¯è§£æç»“æœ
            if (isNaN(parsed) || !isFinite(parsed)) {
                // åœ¨å¼€å‘ç¯å¢ƒä¸‹è®°å½•è­¦å‘Š
                if (console && console.warn) {
                    console.warn(`safeParseFloat: æ— æ³•è§£æå€¼ "${value}", ä½¿ç”¨é»˜è®¤å€¼ ${defaultValue}`);
                }
                return defaultValue;
            }
            
            return parsed;
        }
        
        // æ•°æ®éªŒè¯å‡½æ•°
        function validateKlineItem(item) {
            if (!item || typeof item !== 'object') {
                return false;
            }
            
            const requiredFields = ['open', 'close', 'low', 'high'];
            return requiredFields.every(field => {
                const value = safeParseFloat(item[field]);
                return value > 0; // è‚¡ä»·åº”è¯¥å¤§äº0
            });
        }
        
        function loadStockData() {
            fetch(`/api/stock/${stockCode}`)
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        showError(data.error);
                        return;
                    }
                    
                    stockData = data;
                    displayStockInfo(data);
                    drawKlineChart(data);
                    drawMacdChart(data);
                    drawKdjChart(data);
                    drawRsiChart(data);
                    
                    // æ£€æŸ¥è‚¡ç¥¨æ˜¯å¦å·²åœ¨è‡ªé€‰è‚¡ä¸­
                    checkWatchlistStatus();
                })
                .catch(error => {
                    showError('åŠ è½½æ•°æ®å¤±è´¥: ' + error.message);
                });
        }
        
        function checkWatchlistStatus() {
            // ä½¿ç”¨stockData.ts_codeè€Œä¸æ˜¯stockCodeï¼Œç¡®ä¿æ ¼å¼æ­£ç¡®
            const tsCode = stockData ? stockData.ts_code : stockCode;
            fetch(`/api/watchlist/check?ts_code=${tsCode}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        updateWatchlistUI(data.in_watchlist, data.priority);
                    }
                })
                .catch(error => {
                    console.error('æ£€æŸ¥è‡ªé€‰è‚¡çŠ¶æ€å¤±è´¥:', error);
                });
        }
        
        function updateWatchlistUI(inWatchlist, priority) {
            const select = document.getElementById('addToWatchlistSelect');
            const removeBtn = document.getElementById('removeFromWatchlistBtn');
            
            if (inWatchlist) {
                // è‚¡ç¥¨å·²åœ¨è‡ªé€‰è‚¡ä¸­
                const priorityNames = {
                    'purple': 'å¯ç«‹å³ä¹°å…¥',
                    'red': 'é‡ç‚¹å…³æ³¨',
                    'green': 'è§‚å¯Ÿ',
                    'holding': 'æŒä»“ä¸­',
                    'sold': 'å·²å–å‡º'
                };
                
                select.innerHTML = `<option selected>âœ“ å·²åŠ å…¥è‡ªé€‰ (${priorityNames[priority] || 'è§‚å¯Ÿ'})</option>`;
                select.style.background = 'linear-gradient(45deg, #28a745, #20c997)';
                select.disabled = true;
                
                // æ˜¾ç¤ºåˆ é™¤æŒ‰é’®
                removeBtn.style.display = 'inline-block';
            } else {
                // è‚¡ç¥¨ä¸åœ¨è‡ªé€‰è‚¡ä¸­ï¼Œæ¢å¤åŸå§‹çŠ¶æ€
                select.innerHTML = `
                    <option value="" disabled selected>â­ åŠ å…¥è‡ªé€‰è‚¡</option>
                    <option value="purple" style="background-color: #8e44ad; color: white;">ğŸŸ£ å¯ç«‹å³ä¹°å…¥</option>
                    <option value="red" style="background-color: #e74c3c; color: white;">ğŸ”´ é‡ç‚¹å…³æ³¨</option>
                    <option value="green" style="background-color: #27ae60; color: white;">ğŸŸ¢ è§‚å¯Ÿ</option>
                    <option value="holding" style="background-color: #ff9800; color: white;">ğŸŸ  æŒä»“ä¸­</option>
                    <option value="sold" style="background-color: #9e9e9e; color: white;">âš« å·²å–å‡º</option>
                `;
                select.style.background = 'linear-gradient(45deg, #ffc107, #fd7e14)';
                select.disabled = false;
                
                // éšè—åˆ é™¤æŒ‰é’®
                removeBtn.style.display = 'none';
            }
        }
        
        function displayStockInfo(data) {
            document.getElementById('loadingDiv').style.display = 'none';
            document.getElementById('stockInfo').style.display = 'block';
            document.getElementById('chartSection').style.display = 'block';
            document.getElementById('macdSection').style.display = 'block';
            document.getElementById('kdjSection').style.display = 'block';
            document.getElementById('rsiSection').style.display = 'block';
            
            // åŠ¨æ€è®¾ç½®é¡µé¢æ ‡é¢˜ä¸ºè‚¡ç¥¨åç§°
            document.title = data.name + ' - ä¹è½¬åºåˆ—é€‰è‚¡åŠå››å¤©æŒè‚¡äº¤æ˜“ç³»ç»Ÿ';
            
            document.getElementById('stockName').textContent = data.name;
            document.getElementById('stockCode').textContent = data.ts_code;
            
            // æ˜¾ç¤ºå½“å‰ä»·æ ¼ï¼ˆä¸å®æ—¶æ•°æ®åŒºåŸŸä¿æŒä¸€è‡´ï¼‰
            document.getElementById('stockPrice').textContent = 'Â¥' + data.latest_price.toFixed(2);
            
            document.getElementById('highestPrice').textContent = data.highest_price.toFixed(2);
            document.getElementById('lowestPrice').textContent = data.lowest_price.toFixed(2);
            document.getElementById('highestDate').textContent = formatDate(data.highest_date);
            document.getElementById('lowestDate').textContent = formatDate(data.lowest_date);
            
            // è·å–æœ€åä¸€æ ¹Kçº¿çš„æ—¶é—´å¹¶æ˜¾ç¤º
            if (data.kline_data && data.kline_data.length > 0) {
                const lastKlineDate = data.kline_data[data.kline_data.length - 1].trade_date;
                document.getElementById('lastKlineDate').textContent = formatDateChinese(lastKlineDate);
            }
            
            document.getElementById('marketCap').textContent = formatNumber(data.market_cap * 10000);
            document.getElementById('amount').textContent = formatNumber(data.amount * 1000);
            
            // æ˜¾ç¤ºå‡€æµå…¥é¢
            console.log('å‡€æµå…¥é¢æ•°æ®è°ƒè¯•:', {
                net_mf_amount: data.net_mf_amount,
                type: typeof data.net_mf_amount,
                moneyflow: data.moneyflow
            });
            
            if (data.net_mf_amount !== undefined && data.net_mf_amount !== null) {
                const netMfAmount = data.net_mf_amount * 1000; // è½¬æ¢ä¸ºä¸‡å…ƒå•ä½ä»¥åŒ¹é…formatMoneyflowAmountå‡½æ•°
                const netMfElement = document.getElementById('netMfAmount');
                
                // ä½¿ç”¨ä¸ç‰¹å¤§å•ä¹°å…¥é‡‘é¢ç›¸åŒçš„æ ¼å¼åŒ–å‡½æ•°
                function formatMoneyflowAmountForNet(value) {
                    if (value === 0 || value === null || value === undefined) return '-';
                    const absValue = Math.abs(value);
                    const sign = value >= 0 ? '+' : '-';
                    let formatted;
                    
                    if (absValue >= 10000) {
                        formatted = (absValue / 10000).toFixed(2) + 'äº¿';
                    } else {
                        formatted = absValue.toFixed(2) + 'ä¸‡';
                    }
                    
                    return sign + formatted;
                }
                
                netMfElement.textContent = formatMoneyflowAmountForNet(netMfAmount);
                // æ ¹æ®æ­£è´Ÿå€¼è®¾ç½®é¢œè‰²
                if (netMfAmount > 0) {
                    netMfElement.style.color = '#ff4444'; // çº¢è‰²è¡¨ç¤ºå‡€æµå…¥
                } else if (netMfAmount < 0) {
                    netMfElement.style.color = '#44aa44'; // ç»¿è‰²è¡¨ç¤ºå‡€æµå‡º
                } else {
                    netMfElement.style.color = '#666'; // ç°è‰²è¡¨ç¤ºæ— å˜åŒ–
                }
            } else {
                document.getElementById('netMfAmount').textContent = '-';
                document.getElementById('netMfAmount').style.color = '#666';
            }
            
            document.getElementById('turnoverRate').textContent = data.turnover_rate.toFixed(2) + '%';
            document.getElementById('peTtm').textContent = (data.pe_ttm && data.pe_ttm > 0) ? data.pe_ttm.toFixed(2) : '-';
            document.getElementById('volumeRatio').textContent = data.volume_ratio.toFixed(2);
            
            // æ˜¾ç¤ºå¸‚å‡€ç‡(PB)
            document.getElementById('pbRatio').textContent = (data.pb && data.pb > 0) ? data.pb.toFixed(2) : '-';
            
            // æ˜¾ç¤ºå½“å¤©æ¶¨å¹…
            const changePercent = data.pct_chg || 0;
            const changeElement = document.getElementById('changePercent');
            changeElement.textContent = (changePercent >= 0 ? '+' : '') + changePercent.toFixed(2) + '%';
            changeElement.style.color = changePercent >= 0 ? '#ff4444' : '#44aa44';
            
            document.getElementById('industry').textContent = data.industry || '-';
            
            // æ˜¾ç¤ºèµ„é‡‘æµå‘æ•°æ®ï¼ˆå¦‚æœå¯ç”¨ï¼‰
            if (data.moneyflow && data.moneyflow !== null) {
                document.getElementById('moneyflowSection').style.display = 'block';
                
                // æ ¼å¼åŒ–èµ„é‡‘æµå‘æ•°å€¼çš„å‡½æ•°ï¼ˆä¸‡å…ƒå•ä½ï¼‰
                function formatMoneyflowAmount(value) {
                    if (value === 0 || value === null || value === undefined) return '-';
                    const absValue = Math.abs(value);
                    let formatted;
                    
                    if (absValue >= 10000) {
                        formatted = (absValue / 10000).toFixed(2) + 'äº¿';
                    } else {
                        formatted = absValue.toFixed(2) + 'ä¸‡';
                    }
                    
                    return formatted;
                }
                
                // è®¾ç½®ä¹°å…¥é‡‘é¢é¢œè‰²ï¼ˆçº¢è‰²ï¼‰
                function setBuyAmountStyle(elementId) {
                    const element = document.getElementById(elementId);
                    element.style.color = '#ff4444'; // çº¢è‰²è¡¨ç¤ºä¹°å…¥
                }
                
                // è®¾ç½®å–å‡ºé‡‘é¢é¢œè‰²ï¼ˆç»¿è‰²ï¼‰
                function setSellAmountStyle(elementId) {
                    const element = document.getElementById(elementId);
                    element.style.color = '#44aa44'; // ç»¿è‰²è¡¨ç¤ºå–å‡º
                }
                
                // è®¾ç½®å‡€æµå…¥é¢é¢œè‰²ï¼ˆæ ¹æ®æ­£è´Ÿå€¼ï¼‰
                function setNetAmountStyle(elementId, value) {
                    const element = document.getElementById(elementId);
                    if (value > 0) {
                        element.style.color = '#ff4444'; // çº¢è‰²è¡¨ç¤ºå‡€æµå…¥
                    } else if (value < 0) {
                        element.style.color = '#44aa44'; // ç»¿è‰²è¡¨ç¤ºå‡€æµå‡º
                    } else {
                        element.style.color = '#666'; // ç°è‰²è¡¨ç¤ºæ— å˜åŒ–
                    }
                }
                

                
                // æ˜¾ç¤ºç‰¹å¤§å•ä¹°å…¥é‡‘é¢
                const buyElgAmount = data.moneyflow.buy_elg_amount || 0;
                document.getElementById('buyElgAmount').textContent = formatMoneyflowAmount(buyElgAmount);
                setBuyAmountStyle('buyElgAmount');
                
                // æ˜¾ç¤ºç‰¹å¤§å•å–å‡ºé‡‘é¢
                const sellElgAmount = data.moneyflow.sell_elg_amount || 0;
                document.getElementById('sellElgAmount').textContent = formatMoneyflowAmount(sellElgAmount);
                setSellAmountStyle('sellElgAmount');
                
                // æ˜¾ç¤ºå¤§å•ä¹°å…¥é‡‘é¢
                const buyLgAmount = data.moneyflow.buy_lg_amount || 0;
                document.getElementById('buyLgAmount').textContent = formatMoneyflowAmount(buyLgAmount);
                setBuyAmountStyle('buyLgAmount');
                
                // æ˜¾ç¤ºå¤§å•å–å‡ºé‡‘é¢
                const sellLgAmount = data.moneyflow.sell_lg_amount || 0;
                document.getElementById('sellLgAmount').textContent = formatMoneyflowAmount(sellLgAmount);
                setSellAmountStyle('sellLgAmount');
                
                // æ˜¾ç¤ºä¸­å•ä¹°å…¥é‡‘é¢
                const buyMdAmount = data.moneyflow.buy_md_amount || 0;
                document.getElementById('buyMdAmount').textContent = formatMoneyflowAmount(buyMdAmount);
                setBuyAmountStyle('buyMdAmount');
                
                // æ˜¾ç¤ºä¸­å•å–å‡ºé‡‘é¢
                const sellMdAmount = data.moneyflow.sell_md_amount || 0;
                document.getElementById('sellMdAmount').textContent = formatMoneyflowAmount(sellMdAmount);
                setSellAmountStyle('sellMdAmount');
                
                // æ˜¾ç¤ºå°å•ä¹°å…¥é‡‘é¢
                const buySmAmount = data.moneyflow.buy_sm_amount || 0;
                document.getElementById('buySmAmount').textContent = formatMoneyflowAmount(buySmAmount);
                setBuyAmountStyle('buySmAmount');
                
                // æ˜¾ç¤ºå°å•å–å‡ºé‡‘é¢
                const sellSmAmount = data.moneyflow.sell_sm_amount || 0;
                document.getElementById('sellSmAmount').textContent = formatMoneyflowAmount(sellSmAmount);
                setSellAmountStyle('sellSmAmount');
            } else {
                // å¦‚æœæ²¡æœ‰èµ„é‡‘æµå‘æ•°æ®ï¼Œéšè—è¯¥éƒ¨åˆ†
                document.getElementById('moneyflowSection').style.display = 'none';
            }
            
            // åŠ è½½å®æ—¶æ•°æ®
            loadRealtimeData();
        }
        
        // å®æ—¶æ•°æ®è‡ªåŠ¨åˆ·æ–°ç›¸å…³å˜é‡
        let realtimeRefreshInterval = null;
        let isRealtimeAutoRefresh = false;
        
        // åŠ è½½å®æ—¶æ•°æ®å‡½æ•°
        function loadRealtimeData() {
            fetch(`/api/stock/${stockCode}/realtime`)
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        console.error('åŠ è½½å®æ—¶æ•°æ®å¤±è´¥:', data.error);
                        // å³ä½¿æœ‰é”™è¯¯ï¼Œä¹Ÿå°è¯•æ˜¾ç¤ºåŸºç¡€æ•°æ®
                        displayRealtimeDataFallback();
                        return;
                    }
                    
                    displayRealtimeData(data);
                    
                    // æ›´æ–°æœ€ååˆ·æ–°æ—¶é—´
                    updateLastRefreshTime();
                })
                .catch(error => {
                    console.error('åŠ è½½å®æ—¶æ•°æ®å¤±è´¥:', error);
                    // ç½‘ç»œé”™è¯¯æ—¶ä¹Ÿå°è¯•æ˜¾ç¤ºåŸºç¡€æ•°æ®
                    displayRealtimeDataFallback();
                });
        }
        
        // å¼€å§‹è‡ªåŠ¨åˆ·æ–°å®æ—¶æ•°æ®
        function startRealtimeAutoRefresh() {
            if (realtimeRefreshInterval) {
                clearInterval(realtimeRefreshInterval);
            }
            
            isRealtimeAutoRefresh = true;
            // æ ¹æ®AKShareå®˜æ–¹å»ºè®®ï¼Œè®¾ç½®10ç§’åˆ·æ–°é—´éš”ï¼Œé¿å…é¢‘ç¹è®¿é—®å¯¼è‡´çš„é”™è¯¯
            realtimeRefreshInterval = setInterval(() => {
                if (isRealtimeAutoRefresh) {
                    loadRealtimeData();
                }
            }, 10000); // 10ç§’åˆ·æ–°ä¸€æ¬¡
            
            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            updateAutoRefreshButton(true);
        }
        
        // åœæ­¢è‡ªåŠ¨åˆ·æ–°å®æ—¶æ•°æ®
        function stopRealtimeAutoRefresh() {
            if (realtimeRefreshInterval) {
                clearInterval(realtimeRefreshInterval);
                realtimeRefreshInterval = null;
            }
            
            isRealtimeAutoRefresh = false;
            
            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            updateAutoRefreshButton(false);
        }
        
        // åˆ‡æ¢è‡ªåŠ¨åˆ·æ–°çŠ¶æ€
        function toggleRealtimeAutoRefresh() {
            if (isRealtimeAutoRefresh) {
                stopRealtimeAutoRefresh();
            } else {
                startRealtimeAutoRefresh();
            }
        }
        
        // æ›´æ–°è‡ªåŠ¨åˆ·æ–°æŒ‰é’®çŠ¶æ€
        function updateAutoRefreshButton(isActive) {
            const button = document.getElementById('autoRefreshBtn');
            if (button) {
                if (isActive) {
                    button.textContent = 'â¸ï¸ åœæ­¢è‡ªåŠ¨åˆ·æ–°';
                    button.style.backgroundColor = '#e74c3c';
                } else {
                    button.textContent = 'â–¶ï¸ å¼€å§‹è‡ªåŠ¨åˆ·æ–°';
                    button.style.backgroundColor = '#27ae60';
                }
            }
        }
        
        // æ›´æ–°æœ€ååˆ·æ–°æ—¶é—´
        function updateLastRefreshTime() {
            const timeElement = document.getElementById('lastRefreshTime');
            if (timeElement) {
                const now = new Date();
                const timeStr = now.toLocaleTimeString('zh-CN', { hour12: false });
                timeElement.textContent = `æœ€åæ›´æ–°: ${timeStr}`;
            }
        }
        
        // å¤‡ç”¨å®æ—¶æ•°æ®æ˜¾ç¤ºå‡½æ•°ï¼ˆåŸºäºå·²åŠ è½½çš„è‚¡ç¥¨æ•°æ®ï¼‰
        function displayRealtimeDataFallback() {
            if (!stockData) {
                console.log('æ²¡æœ‰è‚¡ç¥¨æ•°æ®å¯ç”¨äºå¤‡ç”¨æ˜¾ç¤º');
                return;
            }
            
            console.log('ä½¿ç”¨å¤‡ç”¨æ•°æ®æ˜¾ç¤ºå®æ—¶ä¿¡æ¯');
            
            // æ˜¾ç¤ºå®æ—¶æ•°æ®éƒ¨åˆ†
            document.getElementById('realtimeSection').style.display = 'block';
            
            // ä½¿ç”¨è‚¡ç¥¨åŸºç¡€æ•°æ®å¡«å……å®æ—¶ä¿¡æ¯
            document.getElementById('realtimePrice').textContent = 'Â¥' + (stockData.latest_price || 0).toFixed(2);
            
            const changePercent = stockData.pct_chg || 0;
            const changeElement = document.getElementById('realtimeChangePercent');
            changeElement.textContent = (changePercent >= 0 ? '+' : '') + changePercent.toFixed(2) + '%';
            changeElement.style.color = changePercent >= 0 ? '#ff4444' : '#44aa44';
            
            document.getElementById('realtimeAmount').textContent = formatNumber((stockData.amount || 0) * 1000);
            document.getElementById('realtimeTurnover').textContent = (stockData.turnover_rate || 0).toFixed(2) + '%';
            document.getElementById('realtimeVolumeRatio').textContent = (stockData.volume_ratio || 0).toFixed(2);
            
            // æ˜¾ç¤ºå‡€æµå…¥é¢
            if (stockData.net_mf_amount !== undefined && stockData.net_mf_amount !== null) {
                const netInflow = stockData.net_mf_amount * 10000; // è½¬æ¢ä¸ºä¸‡å…ƒ
                const netElement = document.getElementById('realtimeNetInflow');
                netElement.textContent = formatNumber(netInflow / 10000) + 'ä¸‡';
                netElement.style.color = netInflow >= 0 ? '#ff4444' : '#00aa00';
            } else {
                document.getElementById('realtimeNetInflow').textContent = '-';
            }
            
            // æ˜¾ç¤ºKçº¿å›¾ï¼ˆåŸºäºçœŸå®å†å²æ•°æ®ï¼‰
            if (stockData.kline_data && stockData.kline_data.length > 0) {
                drawRealtimeKlineChart(stockData.kline_data);
            }
            
            // ä¸æ˜¾ç¤ºåˆ†æ—¶å›¾ï¼ˆé¿å…æ¨¡æ‹Ÿæ•°æ®ï¼‰
            showNoMinuteDataMessage();
            
            // æ›´æ–°æœ€ååˆ·æ–°æ—¶é—´
            updateLastRefreshTime();
        }
        
        // æ˜¾ç¤ºåˆ†æ—¶å›¾æ— æ•°æ®æç¤º
        function showNoMinuteDataMessage() {
            const chart = echarts.init(document.getElementById('realtimeMinuteChart'));
            
            const option = {
                title: {
                    text: 'åˆ†æ—¶å›¾æš‚æ— æ•°æ®',
                    subtext: 'åˆ†æ—¶å›¾éœ€è¦çœŸå®äº¤æ˜“æ—¶é—´çš„å®æ—¶æ•°æ®\néäº¤æ˜“æ—¶é—´æ— æ³•æ˜¾ç¤º',
                    left: 'center',
                    top: 'middle',
                    textStyle: {
                        fontSize: 16,
                        color: '#999'
                    },
                    subtextStyle: {
                        fontSize: 12,
                        color: '#ccc'
                    }
                },
                grid: {
                    show: false
                }
            };
            
            chart.setOption(option);
            
            window.addEventListener('resize', function() {
                chart.resize();
            });
        }
        
        // ç»˜åˆ¶ç®€åŒ–åˆ†æ—¶å›¾ï¼ˆåŸºäºKçº¿æ•°æ®ï¼‰
        function drawSimplifiedMinuteChart(klineData) {
            const chart = echarts.init(document.getElementById('realtimeMinuteChart'));
            
            // ä½¿ç”¨æœ€è¿‘5å¤©çš„æ”¶ç›˜ä»·ä½œä¸ºåˆ†æ—¶æ•°æ®
            const recentData = klineData.slice(-5);
            const times = recentData.map(item => {
                const date = item.trade_date || item.date;
                return date.substring(4, 6) + '-' + date.substring(6, 8);
            });
            const prices = recentData.map(item => parseFloat(item.close));
            const volumes = recentData.map(item => parseFloat(item.vol || item.volume || 0));
            
            const option = {
                animation: false,
                title: {
                    text: 'è¿‘æœŸèµ°åŠ¿ï¼ˆåŸºäºæ—¥Kçº¿æ•°æ®ï¼‰',
                    textStyle: {
                        fontSize: 12,
                        color: '#666'
                    },
                    left: 'center'
                },
                grid: [{
                    left: '10%',
                    right: '8%',
                    height: '50%'
                }, {
                    left: '10%',
                    right: '8%',
                    top: '75%',
                    height: '15%',
                    bottom: '10%'
                }],
                xAxis: [{
                    type: 'category',
                    data: fullTimeAxis,
                    scale: true,
                    boundaryGap: false,
                    axisLine: { onZero: false },
                    splitLine: { show: false },
                    splitNumber: 20,
                    min: 'dataMin',
                    max: 'dataMax'
                }, {
                    type: 'category',
                    gridIndex: 1,
                    data: fullTimeAxis,
                    scale: true,
                    boundaryGap: false,
                    axisLine: { onZero: false },
                    axisTick: { show: true },
                    splitLine: { show: false },
                    axisLabel: { 
                        show: true,
                        margin: 8,
                        textStyle: {
                            fontSize: 10
                        }
                    }
                }],
                yAxis: [{
                    scale: true,
                    splitArea: {
                        show: true
                    }
                }, {
                    scale: true,
                    gridIndex: 1,
                    splitNumber: 2,
                    axisLabel: { show: false },
                    axisLine: { show: false },
                    axisTick: { show: false },
                    splitLine: { show: false }
                }],
                dataZoom: [{
                    type: 'inside',
                    xAxisIndex: [0, 1],
                    start: 0,
                    end: 100
                }],
                series: [{
                    name: 'ä»·æ ¼èµ°åŠ¿',
                    type: 'line',
                    data: prices,
                    smooth: true,
                    lineStyle: {
                        opacity: 0.8,
                        color: '#1890ff'
                    },
                    areaStyle: {
                        color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [{
                            offset: 0,
                            color: 'rgba(24, 144, 255, 0.3)'
                        }, {
                            offset: 1,
                            color: 'rgba(24, 144, 255, 0.1)'
                        }])
                    }
                }, {
                    name: 'æˆäº¤é‡',
                    type: 'bar',
                    xAxisIndex: 1,
                    yAxisIndex: 1,
                    data: volumes,
                    itemStyle: {
                        color: '#26a69a'
                    }
                }]
            };
            
            chart.setOption(option);
            
            window.addEventListener('resize', function() {
                chart.resize();
            });
        }
        
        // æ˜¾ç¤ºå®æ—¶æ•°æ®å‡½æ•°
        function displayRealtimeData(data) {
            // æ˜¾ç¤ºå®æ—¶æ•°æ®éƒ¨åˆ†
            document.getElementById('realtimeSection').style.display = 'block';
            
            // æ˜¾ç¤ºå®æ—¶ä»·æ ¼å’Œæ¶¨è·Œå¹…
            if (data.spot) {
                const quote = data.spot;
                console.log('å®æ—¶ä»·æ ¼æ•°æ®è°ƒè¯•:', {
                    stockCode: stockCode,
                    latest_price: quote.latest_price,
                    change_percent: quote.change_percent,
                    open_price: quote.open,
                    data_source: 'å®æ—¶æ•°æ®æ¥å£'
                });
                
                // æ›´æ–°å®æ—¶æ•°æ®åŒºåŸŸçš„ä»·æ ¼
                document.getElementById('realtimePrice').textContent = 'Â¥' + (quote.latest_price || '-');
                
                // åŒæ­¥æ›´æ–°é¡µé¢é¡¶éƒ¨çš„ä»·æ ¼æ˜¾ç¤º
                if (quote.latest_price) {
                    document.getElementById('stockPrice').textContent = 'Â¥' + quote.latest_price.toFixed(2);
                }
                
                // æ˜¾ç¤ºå½“å¤©å¼€ç›˜ä»·ï¼ˆä»spotæ•°æ®è·å–çœŸå®å¼€ç›˜ä»·ï¼‰
                if (quote.open && quote.open > 0) {
                    document.getElementById('openPrice').textContent = 'Â¥' + quote.open.toFixed(2);
                    console.log('æ˜¾ç¤ºå½“å¤©çœŸå®å¼€ç›˜ä»·:', quote.open.toFixed(2));
                } else {
                    document.getElementById('openPrice').textContent = '-';
                    console.log('spotæ•°æ®ä¸­æ— å¼€ç›˜ä»·ä¿¡æ¯');
                }
                
                const changePercent = quote.change_percent || 0;
                const changeElement = document.getElementById('realtimeChangePercent');
                changeElement.textContent = (changePercent >= 0 ? '+' : '') + changePercent.toFixed(2) + '%';
                changeElement.style.color = changePercent >= 0 ? '#ff4444' : '#00aa00';
                
                document.getElementById('realtimeAmount').textContent = formatNumber((quote.amount || 0) * 1000);
                document.getElementById('realtimeTurnover').textContent = quote.turnover_rate ? quote.turnover_rate + '%' : 'æš‚æ— ';
                document.getElementById('realtimeVolumeRatio').textContent = quote.volume_ratio || 'æš‚æ— ';
            } else {
                // å½“spotæ•°æ®ä¸ºç©ºæ—¶ï¼Œå°è¯•ä»èµ„é‡‘æµå‘æ•°æ®å’ŒKçº¿æ•°æ®è·å–ä¿¡æ¯
                if (data.money_flow && data.money_flow.close_price) {
                    document.getElementById('realtimePrice').textContent = 'Â¥' + data.money_flow.close_price.toFixed(2);
                    
                    // åŒæ­¥æ›´æ–°é¡µé¢é¡¶éƒ¨çš„ä»·æ ¼æ˜¾ç¤º
                    document.getElementById('stockPrice').textContent = 'Â¥' + data.money_flow.close_price.toFixed(2);
                    
                    const changePercent = data.money_flow.change_percent || 0;
                    const changeElement = document.getElementById('realtimeChangePercent');
                    changeElement.textContent = (changePercent >= 0 ? '+' : '') + changePercent.toFixed(2) + '%';
                    changeElement.style.color = changePercent >= 0 ? '#ff4444' : '#00aa00';
                    
                    console.log('ä½¿ç”¨èµ„é‡‘æµå‘æ•°æ®æ˜¾ç¤ºåŸºæœ¬ä»·æ ¼ä¿¡æ¯');
                } else {
                    // å®Œå…¨æ— æ•°æ®æ—¶çš„æ˜¾ç¤º
                    document.getElementById('realtimePrice').textContent = 'æš‚æ— æ•°æ®';
                    document.getElementById('realtimeChangePercent').textContent = '-';
                    console.log('å®æ—¶è¡Œæƒ…æ•°æ®æš‚æ—¶æ— æ³•è·å–ï¼Œå¯èƒ½æ˜¯ç½‘ç»œé—®é¢˜æˆ–éäº¤æ˜“æ—¶é—´');
                }
                
                // å½“æ²¡æœ‰spotæ•°æ®æ—¶ï¼Œå¼€ç›˜ä»·æ˜¾ç¤ºä¸ºæš‚æ— 
                document.getElementById('openPrice').textContent = '-';
                console.log('æ— spotæ•°æ®ï¼Œå¼€ç›˜ä»·æ˜¾ç¤ºä¸ºæš‚æ— ');
                
                // å°è¯•ä»Kçº¿æ•°æ®è·å–æˆäº¤é¢
                if (data.kline_data && data.kline_data.length > 0) {
                    const latestKline = data.kline_data[data.kline_data.length - 1];
                    if (latestKline.amount) {
                        document.getElementById('realtimeAmount').textContent = formatNumber(latestKline.amount);
                    } else {
                        document.getElementById('realtimeAmount').textContent = '-';
                    }
                } else {
                    document.getElementById('realtimeAmount').textContent = '-';
                }
                
                // æ¢æ‰‹ç‡å’Œé‡æ¯”æš‚æ—¶æ— æ³•ä»ç°æœ‰æ•°æ®æºè·å–
                document.getElementById('realtimeTurnover').textContent = 'æš‚æ— ';
                document.getElementById('realtimeVolumeRatio').textContent = 'æš‚æ— ';
            }
            
            // æ˜¾ç¤ºå®æ—¶èµ„é‡‘æµå‘ï¼ˆä¼˜å…ˆä½¿ç”¨ç›´æ¥ä¼ é€’çš„å‡€æµå…¥é¢å­—æ®µï¼‰
            if (data.net_mf_amount !== undefined && data.net_mf_amount !== null) {
                const netInflow = data.net_mf_amount * 10000; // è½¬æ¢ä¸ºä¸‡å…ƒ
                const netElement = document.getElementById('realtimeNetInflow');
                netElement.textContent = formatNumber(netInflow / 10000) + 'ä¸‡';
                netElement.style.color = netInflow >= 0 ? '#ff4444' : '#44aa44';
                console.log('ä½¿ç”¨ç›´æ¥ä¼ é€’çš„å‡€æµå…¥é¢:', data.net_mf_amount, 'åƒä¸‡å…ƒ');
            } else if (data.money_flow) {
                const netInflow = data.money_flow.main_net_inflow || 0;
                const netElement = document.getElementById('realtimeNetInflow');
                // åç«¯è¿”å›çš„æ•°æ®å•ä½æ˜¯å…ƒï¼Œéœ€è¦è½¬æ¢ä¸ºä¸‡å…ƒæ˜¾ç¤º
                netElement.textContent = formatNumber(netInflow / 10000) + 'ä¸‡';
                netElement.style.color = netInflow >= 0 ? '#ff4444' : '#44aa44';
                console.log('ä½¿ç”¨money_flowä¸­çš„å‡€æµå…¥é¢:', netInflow, 'ä¸‡å…ƒ');
            } else {
                document.getElementById('realtimeNetInflow').textContent = '-';
                console.log('æ— å‡€æµå…¥é¢æ•°æ®');
            }
            
            // ç»˜åˆ¶å®æ—¶åˆ†æ—¶å›¾ï¼ˆä»…å½“æœ‰çœŸå®åˆ†æ—¶æ•°æ®æ—¶ï¼‰
            if (data.minute_data && data.minute_data.length > 0) {
                drawRealtimeMinuteChart(data.minute_data);
            } else {
                // æ²¡æœ‰çœŸå®åˆ†æ—¶æ•°æ®æ—¶ï¼Œæ˜¾ç¤ºæç¤ºä¿¡æ¯
                showNoMinuteDataMessage();
            }
            
            // ç»˜åˆ¶å®æ—¶Kçº¿å›¾
            if (data.kline_data && data.kline_data.length > 0) {
                drawRealtimeKlineChart(data.kline_data);
            }
        }
        
        // ç»˜åˆ¶å®æ—¶åˆ†æ—¶å›¾
        function drawRealtimeMinuteChart(minuteData) {
            console.log('å¼€å§‹ç»˜åˆ¶åˆ†æ—¶å›¾ï¼Œæ•°æ®:', minuteData);
            const chart = echarts.init(document.getElementById('realtimeMinuteChart'));
            
            // ç”Ÿæˆå®Œæ•´çš„äº¤æ˜“æ—¶é—´è½´ï¼ˆä¸Šåˆ9:30-11:30ï¼Œä¸‹åˆ13:00-15:00ï¼‰
            const fullTimeAxis = [];
            // ä¸Šåˆæ—¶æ®µï¼š9:30-11:30
            for (let hour = 9; hour <= 11; hour++) {
                const startMin = hour === 9 ? 30 : 0;
                const endMin = hour === 11 ? 30 : 59;
                for (let min = startMin; min <= endMin; min++) {
                    fullTimeAxis.push(`${hour.toString().padStart(2, '0')}:${min.toString().padStart(2, '0')}`);
                }
            }
            // ä¸‹åˆæ—¶æ®µï¼š13:00-15:00
            for (let hour = 13; hour <= 15; hour++) {
                const endMin = hour === 15 ? 0 : 59;
                for (let min = 0; min <= endMin; min++) {
                    fullTimeAxis.push(`${hour.toString().padStart(2, '0')}:${min.toString().padStart(2, '0')}`);
                }
            }
            
            // åˆ›å»ºæ•°æ®æ˜ å°„ï¼Œå°†å®é™…æ•°æ®æ˜ å°„åˆ°å®Œæ•´æ—¶é—´è½´
            const dataMap = new Map();
            minuteData.forEach(item => {
                const timeStr = item.time;
                let timeKey;
                // æå–æ—¶é—´éƒ¨åˆ†ï¼ˆHH:MMï¼‰
                if (timeStr.includes(' ')) {
                    timeKey = timeStr.split(' ')[1].substring(0, 5); // åªå–HH:MM
                } else {
                    timeKey = timeStr.substring(11, 16); // ä»å®Œæ•´æ—¶é—´æˆ³ä¸­æå–HH:MM
                }
                dataMap.set(timeKey, {
                    price: parseFloat(item.price),
                    volume: parseFloat(item.volume)
                });
            });
            
            // æ ¹æ®å®Œæ•´æ—¶é—´è½´ç”Ÿæˆæ•°æ®æ•°ç»„
            const prices = fullTimeAxis.map(time => {
                const data = dataMap.get(time);
                return data ? data.price : null;
            });
            
            const volumes = fullTimeAxis.map(time => {
                const data = dataMap.get(time);
                return data ? data.volume : null;
            });
            
            console.log('å®Œæ•´æ—¶é—´è½´é•¿åº¦:', fullTimeAxis.length);
            console.log('æ•°æ®æ˜ å°„å¤§å°:', dataMap.size);
            console.log('ä»·æ ¼æ•°ç»„:', prices.filter(p => p !== null).length, 'ä¸ªæœ‰æ•ˆæ•°æ®');
            console.log('æˆäº¤é‡æ•°ç»„:', volumes.filter(v => v !== null).length, 'ä¸ªæœ‰æ•ˆæ•°æ®');
            
            // è®¡ç®—åˆ†æ—¶å‡ä»·çº¿ï¼ˆç´¯è®¡æˆäº¤é‡‘é¢ Ã· ç´¯è®¡æˆäº¤é‡ï¼‰
            const avgPrices = [];
            let cumulativeAmount = 0;  // ç´¯è®¡æˆäº¤é‡‘é¢
            let cumulativeVolume = 0;  // ç´¯è®¡æˆäº¤é‡
            
            for (let i = 0; i < prices.length; i++) {
                const data = dataMap.get(fullTimeAxis[i]);
                if (data && data.price !== null && data.volume !== null && data.volume > 0) {
                    // ç´¯åŠ æˆäº¤é‡‘é¢å’Œæˆäº¤é‡
                    cumulativeAmount += data.price * data.volume;
                    cumulativeVolume += data.volume;
                    
                    // è®¡ç®—åˆ†æ—¶å‡ä»·
                    avgPrices.push(cumulativeAmount / cumulativeVolume);
                } else {
                    // å¦‚æœå½“å‰æ—¶é—´ç‚¹æ²¡æœ‰æ•°æ®ï¼Œä½¿ç”¨å‰ä¸€ä¸ªå‡ä»·å€¼
                    avgPrices.push(i > 0 ? avgPrices[i - 1] : null);
                }
            }
            
            console.log('åˆ†æ—¶å‡ä»·çº¿è®¡ç®—å®Œæˆï¼Œæœ‰æ•ˆæ•°æ®ç‚¹:', avgPrices.filter(p => p !== null).length);
            
            const option = {
                animation: false,
                backgroundColor: '#ffffff',
                grid: [{
                    left: '8%',
                    right: '5%',
                    top: '8%',
                    height: '60%',
                    borderColor: '#e6e6e6',
                    borderWidth: 1
                }, {
                    left: '8%',
                    right: '5%',
                    top: '75%',
                    height: '18%',
                    bottom: '7%',
                    borderColor: '#e6e6e6',
                    borderWidth: 1
                }],
                xAxis: [{
                    type: 'category',
                    data: fullTimeAxis,
                    scale: true,
                    boundaryGap: false,
                    axisLine: { 
                        show: true,
                        lineStyle: {
                            color: '#cccccc'
                        }
                    },
                    axisTick: {
                        show: true,
                        lineStyle: {
                            color: '#cccccc'
                        }
                    },
                    splitLine: { 
                        show: true,
                        lineStyle: {
                            color: '#f5f5f5',
                            type: 'solid',
                            width: 1
                        }
                    },
                    axisLabel: {
                        show: true,
                        interval: function(index, value) {
                            // æ˜¾ç¤ºå…³é”®æ—¶é—´ç‚¹ï¼š9:30, 10:00, 10:30, 11:00, 11:30, 13:00, 13:30, 14:00, 14:30, 15:00
                            const keyTimes = ['09:30', '10:00', '10:30', '11:00', '11:30', '13:00', '13:30', '14:00', '14:30', '15:00'];
                            return keyTimes.includes(value);
                        },
                        textStyle: {
                            color: '#666666',
                            fontSize: 11
                        }
                    },
                    splitNumber: 20,
                    min: 'dataMin',
                    max: 'dataMax'
                }, {
                    type: 'category',
                    gridIndex: 1,
                    data: fullTimeAxis,
                    scale: true,
                    boundaryGap: false,
                    axisLine: { onZero: false },
                    axisTick: { show: true },
                    splitLine: { show: false },
                    axisLabel: { 
                        show: true,
                        margin: 8,
                        textStyle: {
                            fontSize: 10
                        },
                        interval: 'auto',
                        formatter: function(value, index) {
                            // åªæ˜¾ç¤ºæ•´ç‚¹å’ŒåŠç‚¹
                            if (value.endsWith(':00') || value.endsWith(':30')) {
                                return value;
                            }
                            return '';
                        }
                    },
                    splitNumber: 20,
                    min: 'dataMin',
                    max: 'dataMax'
                }],
                yAxis: [{
                    scale: true,
                    splitArea: { 
                        show: true,
                        areaStyle: {
                            color: ['rgba(250,250,250,0.1)', 'rgba(245,245,245,0.1)']
                        }
                    },
                    axisLine: {
                        show: true,
                        lineStyle: {
                            color: '#cccccc'
                        }
                    },
                    axisTick: {
                        show: true,
                        lineStyle: {
                            color: '#cccccc'
                        }
                    },
                    splitLine: {
                        show: true,
                        lineStyle: {
                            color: '#f5f5f5',
                            type: 'solid',
                            width: 1
                        }
                    },
                    axisLabel: {
                        textStyle: {
                            color: '#666666',
                            fontSize: 11
                        },
                        formatter: function(value) {
                            return value.toFixed(2);
                        }
                    }
                }, {
                    scale: true,
                    gridIndex: 1,
                    splitNumber: 2,
                    axisLabel: { 
                        show: true,
                        textStyle: {
                            color: '#666666',
                            fontSize: 10
                        }
                    },
                    axisLine: { 
                        show: true,
                        lineStyle: {
                            color: '#cccccc'
                        }
                    },
                    axisTick: { 
                        show: true,
                        lineStyle: {
                            color: '#cccccc'
                        }
                    },
                    splitLine: { 
                        show: true,
                        lineStyle: {
                            color: '#f5f5f5',
                            type: 'solid',
                            width: 1
                        }
                    }
                 }],
                 dataZoom: [{
                    type: 'inside',
                    xAxisIndex: [0, 1],
                    start: 0,
                    end: 100
                }],
                tooltip: {
                    trigger: 'axis',
                    axisPointer: {
                        type: 'cross'
                    },
                    formatter: function(params) {
                        let result = `æ—¶é—´: ${params[0].axisValue}<br/>`;
                        params.forEach(param => {
                            if (param.seriesName === 'åˆ†æ—¶ä»·æ ¼') {
                                result += `${param.seriesName}: ${param.value.toFixed(2)}<br/>`;
                            } else if (param.seriesName === 'å‡çº¿') {
                                result += `${param.seriesName}: ${param.value ? param.value.toFixed(2) : '-'}<br/>`;
                            } else {
                                result += `${param.seriesName}: ${param.value}<br/>`;
                            }
                        });
                        return result;
                    }
                },
                series: [{
                    name: 'åˆ†æ—¶ä»·æ ¼',
                    type: 'line',
                    data: prices,
                    smooth: true,
                    lineStyle: {
                        color: '#0066cc',  // æ›´æ·±çš„è“è‰²ï¼Œç±»ä¼¼åŒèŠ±é¡º
                        width: 1
                    },
                    areaStyle: {
                        color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [{
                            offset: 0,
                            color: 'rgba(0, 102, 204, 0.15)'  // æ›´æ·¡çš„å¡«å……è‰²
                        }, {
                            offset: 1,
                            color: 'rgba(0, 102, 204, 0.05)'
                        }])
                    },
                    symbol: 'none'
                }, {
                    name: 'å‡çº¿',
                    type: 'line',
                    data: avgPrices,
                    smooth: true,
                    lineStyle: {
                        color: '#ffaa00',  // æ›´é²œæ˜çš„é»„è‰²ï¼Œç±»ä¼¼åŒèŠ±é¡º
                        width: 2  // æ›´ç²—çš„çº¿æ¡
                    },
                    symbol: 'none'
                }, {
                    name: 'æˆäº¤é‡',
                    type: 'bar',
                    xAxisIndex: 1,
                    yAxisIndex: 1,
                    data: volumes,
                    itemStyle: {
                        color: function(params) {
                            // æ ¹æ®ä»·æ ¼æ¶¨è·Œè®¾ç½®æˆäº¤é‡é¢œè‰²ï¼Œä½¿ç”¨æ›´é²œæ˜çš„é¢œè‰²
                            const index = params.dataIndex;
                            if (index === 0) return '#cccccc';
                            const currentPrice = prices[index];
                            const prevPrice = prices[index - 1];
                            return currentPrice >= prevPrice ? '#ff3333' : '#00cc66';  // æ›´é²œæ˜çš„çº¢ç»¿è‰²
                        }
                    }
                }]
            };
            
            chart.setOption(option);
        }
        
        // ç»˜åˆ¶å®æ—¶Kçº¿å›¾
        function drawRealtimeKlineChart(klineData) {
            const chart = echarts.init(document.getElementById('realtimeKlineChart'));
            
            // Kçº¿æ•°æ®é…ç½®å¸¸é‡
            const KLINE_CONFIG = {
                // ECharts candlestick æ•°æ®æ ¼å¼: [open, close, low, high]
                // æ³¨æ„ï¼šæ­¤å¤„åº”ä¸ºå‰å¤æƒä»·æ ¼æ•°æ®
                DATA_FORMAT: 'OCLH', // Open, Close, Low, High
                PRECISION: 2, // ä»·æ ¼ç²¾åº¦
                CURRENCY_SYMBOL: 'Â¥'
            };
            
            // è°ƒè¯•ï¼šæ£€æŸ¥å®æ—¶Kçº¿æ•°æ®çš„å¤æƒçŠ¶æ€
            console.log('å®æ—¶Kçº¿æ•°æ®è°ƒè¯•ä¿¡æ¯:');
            if (klineData && klineData.length > 0) {
                const firstItem = klineData[0];
                const lastItem = klineData[klineData.length - 1];
                console.log('ç¬¬ä¸€æ¡å®æ—¶Kçº¿æ•°æ®:', firstItem);
                console.log('æœ€åä¸€æ¡å®æ—¶Kçº¿æ•°æ®:', lastItem);
                console.log('æ˜¯å¦ä¸ºå¤æƒæ•°æ®:', lastItem.is_adjusted);
                console.log('å¤æƒå› å­:', lastItem.adj_factor);
            }
            
            const candlestickData = klineData.map(item => [
                safeParseFloat(item.open),    // å¼€ç›˜ä»·
                safeParseFloat(item.close),   // æ”¶ç›˜ä»·
                safeParseFloat(item.low),     // æœ€ä½ä»·
                safeParseFloat(item.high)     // æœ€é«˜ä»·
            ]);
            
            const dates = klineData.map(item => formatDate(item.trade_date || item.date));
            const volumes = klineData.map(item => safeParseFloat(item.vol || item.volume));
            
            // å–å‡ºSetupæ•°æ® - 1-9æ•°å­—ï¼Œçº¢è‰²ï¼ŒKçº¿ä¸Šæ–¹
            const nineTurnUp = klineData.map((item, index) => {
                return item.nine_turn_up > 0 ? [
                    index, // xåæ ‡ï¼šæ•°æ®ç´¢å¼•
                    safeParseFloat(item.high) + (safeParseFloat(item.high) * 0.02), // yåæ ‡ï¼šKçº¿æœ€é«˜ä»·ä¸Šæ–¹2%
                    item.nine_turn_up // æ˜¾ç¤ºçš„æ•°å€¼ï¼ˆ1-9ï¼‰
                ] : null;
            }).filter(item => item !== null);
            
            // ä¹°å…¥Setupæ•°æ® - 1-9æ•°å­—ï¼Œç»¿è‰²ï¼ŒKçº¿ä¸‹æ–¹
            const nineTurnDown = klineData.map((item, index) => {
                return item.nine_turn_down > 0 ? [
                    index, // xåæ ‡ï¼šæ•°æ®ç´¢å¼•
                    safeParseFloat(item.low) - (safeParseFloat(item.low) * 0.02), // yåæ ‡ï¼šKçº¿æœ€ä½ä»·ä¸‹æ–¹2%
                    item.nine_turn_down // æ˜¾ç¤ºçš„æ•°å€¼ï¼ˆ1-9ï¼‰
                ] : null;
            }).filter(item => item !== null);
            
            // å–å‡ºCountdownæ•°æ® - 1-13æ•°å­—ï¼Œç´«è‰²ï¼Œå–å‡ºSetupä¸Šæ–¹
            const countdownUp = klineData.map((item, index) => {
                return item.countdown_up > 0 ? [
                    index, // xåæ ‡ï¼šæ•°æ®ç´¢å¼•
                    safeParseFloat(item.high) + (safeParseFloat(item.high) * 0.05), // yåæ ‡ï¼šKçº¿æœ€é«˜ä»·ä¸Šæ–¹5%ï¼ˆå–å‡ºSetupä¸Šæ–¹ï¼‰
                    item.countdown_up // æ˜¾ç¤ºçš„æ•°å€¼ï¼ˆ1-13ï¼‰
                ] : null;
            }).filter(item => item !== null);
            
            // ä¹°å…¥Countdownæ•°æ® - 1-13æ•°å­—ï¼Œè“è‰²ï¼Œä¹°å…¥Setupä¸‹æ–¹
            const countdownDown = klineData.map((item, index) => {
                return item.countdown_down > 0 ? [
                    index, // xåæ ‡ï¼šæ•°æ®ç´¢å¼•
                    safeParseFloat(item.low) - (safeParseFloat(item.low) * 0.05), // yåæ ‡ï¼šKçº¿æœ€ä½ä»·ä¸‹æ–¹5%ï¼ˆä¹°å…¥Setupä¸‹æ–¹ï¼‰
                    item.countdown_down // æ˜¾ç¤ºçš„æ•°å€¼ï¼ˆ1-13ï¼‰
                ] : null;
            }).filter(item => item !== null);
            
            // æå–BOLLæ•°æ®ï¼Œä¿ç•™nullå€¼è®©EChartsæ­£ç¡®å¤„ç†
            const bollUpper = klineData.map(item => item.boll_upper === null || item.boll_upper === undefined ? null : parseFloat(item.boll_upper));
            const bollMid = klineData.map(item => item.boll_mid === null || item.boll_mid === undefined ? null : parseFloat(item.boll_mid));
            const bollLower = klineData.map(item => item.boll_lower === null || item.boll_lower === undefined ? null : parseFloat(item.boll_lower));
            
            // æ‰¾åˆ°æœ€é«˜ä»·å’Œæœ€ä½ä»·çš„ä½ç½®
            let highestIndex = -1;
            let lowestIndex = -1;
            let maxHigh = -1;
            let minLow = Number.MAX_VALUE;
            
            // éå†æ‰€æœ‰æ•°æ®æ‰¾åˆ°çœŸæ­£çš„æœ€é«˜ä»·å’Œæœ€ä½ä»·ä½ç½®
            klineData.forEach((item, index) => {
                const high = safeParseFloat(item.high);
                const low = safeParseFloat(item.low);
                
                if (high > maxHigh) {
                    maxHigh = high;
                    highestIndex = index;
                }
                
                if (low < minLow) {
                    minLow = low;
                    lowestIndex = index;
                }
            });
            
            const option = {
                animation: false,
                legend: {
                    bottom: 10,
                    left: 'center',
                    data: ['å®æ—¶Kçº¿', 'æˆäº¤é‡', 'å–å‡ºSetup', 'ä¹°å…¥Setup', 'å–å‡ºCountdown', 'ä¹°å…¥Countdown', 'BOLLä¸Šè½¨', 'BOLLä¸­è½¨', 'BOLLä¸‹è½¨']
                },
                tooltip: {
                    trigger: 'axis',
                    axisPointer: {
                        type: 'cross'
                    },
                    backgroundColor: 'rgba(245, 245, 245, 0.8)',
                    borderWidth: 1,
                    borderColor: '#ccc',
                    textStyle: {
                        color: '#000'
                    },
                    formatter: function (params) {
                        const dataIndex = params[0].dataIndex;
                        const klineItem = klineData[dataIndex];
                        const date = params[0].axisValue;
                        
                        let html = `<div style="font-weight: bold; margin-bottom: 5px;">${date}</div>`;
                        
                        // æŸ¥æ‰¾Kçº¿æ•°æ®å‚æ•°
                        const klineParam = params.find(p => p.seriesName === 'å®æ—¶Kçº¿');
                        if (klineParam && klineParam.data) {
                            const candlestickPrices = klineParam.data;
                            // æ£€æŸ¥æ˜¯å¦ä¸ºå‰å¤æƒæ•°æ®
                            const isAdjusted = klineItem && klineItem.is_adjusted === true;
                            const priceType = isAdjusted ? 'å‰å¤æƒ' : 'æœªé™¤æƒ';
                            const priceColor = isAdjusted ? '#2e7d32' : '#999'; // å‰å¤æƒç”¨ç»¿è‰²ï¼Œæœªé™¤æƒç”¨ç°è‰²
                            
                            // ECharts candlestickæ•°æ®æ ¼å¼: [open, close, low, high]
                            html += `<div style="color: #333; margin-bottom: 3px;">å¼€ç›˜: Â¥${candlestickPrices[0].toFixed(2)} <span style="color: ${priceColor}; font-size: 11px;">(${priceType})</span></div>`;
                            html += `<div style="color: #333; margin-bottom: 3px;">æ”¶ç›˜: Â¥${candlestickPrices[1].toFixed(2)} <span style="color: ${priceColor}; font-size: 11px;">(${priceType})</span></div>`;
                            html += `<div style="color: #333; margin-bottom: 3px;">æœ€ä½: Â¥${candlestickPrices[2].toFixed(2)} <span style="color: ${priceColor}; font-size: 11px;">(${priceType})</span></div>`;
                            html += `<div style="color: #333; margin-bottom: 3px;">æœ€é«˜: Â¥${candlestickPrices[3].toFixed(2)} <span style="color: ${priceColor}; font-size: 11px;">(${priceType})</span></div>`;
                            
                            // å¦‚æœæœ‰å¤æƒå› å­ä¿¡æ¯ï¼Œæ˜¾ç¤ºå¤æƒå› å­
                            if (klineItem && klineItem.adj_factor && klineItem.adj_factor !== 1.0) {
                                html += `<div style="color: #666; margin-top: 5px; font-size: 11px;">å¤æƒå› å­: ${klineItem.adj_factor.toFixed(4)}</div>`;
                            }
                            
                            // è°ƒè¯•ä¿¡æ¯ï¼šæ˜¾ç¤ºis_adjustedå­—æ®µçš„å€¼
                            console.log(`å®æ—¶Kçº¿æ•°æ®è°ƒè¯• - æ—¥æœŸ: ${date}, is_adjusted: ${klineItem ? klineItem.is_adjusted : 'undefined'}, adj_factor: ${klineItem ? klineItem.adj_factor : 'undefined'}`);
                        }
                        
                        // BOLLçº¿æ•°æ®
                        const bollUpperParam = params.find(p => p.seriesName === 'BOLLä¸Šè½¨');
                        const bollMidParam = params.find(p => p.seriesName === 'BOLLä¸­è½¨');
                        const bollLowerParam = params.find(p => p.seriesName === 'BOLLä¸‹è½¨');
                        
                        if (bollUpperParam && bollUpperParam.data !== null) {
                            html += `<div style="color: #1E90FF; margin-bottom: 3px;">BOLL Upper: ${bollUpperParam.data.toFixed(2)}</div>`;
                        }
                        if (bollMidParam && bollMidParam.data !== null) {
                            html += `<div style="color: #1E90FF; margin-bottom: 3px;">BOLL Mid: ${bollMidParam.data.toFixed(2)}</div>`;
                        }
                        if (bollLowerParam && bollLowerParam.data !== null) {
                            html += `<div style="color: #1E90FF; margin-bottom: 3px;">BOLL Lower: ${bollLowerParam.data.toFixed(2)}</div>`;
                        }
                        
                        // æˆäº¤é¢
                        if (klineItem && klineItem.amount) {
                            const amount = parseFloat(klineItem.amount);
                            html += `<div style="color: #666; margin-bottom: 3px;">Amount: ${formatNumber(amount * 1000)}</div>`;
                        }
                        
                        // æ¶¨è·Œå¹…
                        if (klineItem && klineItem.pct_chg !== undefined && klineItem.pct_chg !== null) {
                            const pctChg = parseFloat(klineItem.pct_chg);
                            const color = pctChg >= 0 ? '#ff4444' : '#44aa44';
                            html += `<div style="color: ${color}; margin-bottom: 3px;">Change: ${pctChg >= 0 ? '+' : ''}${pctChg.toFixed(2)}%</div>`;
                        }
                        
                        // æˆäº¤é‡æ•°æ®
                        const volumeParam = params.find(p => p.seriesName === 'æˆäº¤é‡');
                        if (volumeParam) {
                            const vol = volumeParam.data;
                            html += `<div style="color: #888; margin-top: 5px;">Volume: ${formatNumber(vol * 100)}</div>`;
                        }
                        
                        return html;
                    }
                },
                grid: [{
                    left: '10%',
                    right: '8%',
                    height: '50%'
                }, {
                    left: '10%',
                    right: '8%',
                    top: '63%',
                    height: '16%'
                }],
                xAxis: [{
                    type: 'category',
                    data: dates,
                    boundaryGap: false,
                    axisLine: { onZero: false },
                    splitLine: { show: false },
                    min: 'dataMin',
                    max: 'dataMax',
                    axisPointer: {
                        z: 100
                    }
                }, {
                    type: 'category',
                    gridIndex: 1,
                    data: dates,
                    boundaryGap: false,
                    axisLine: { onZero: false },
                    axisTick: { show: false },
                    splitLine: { show: false },
                    axisLabel: { show: false },
                    min: 'dataMin',
                    max: 'dataMax'
                }],
                yAxis: [{
                    scale: true,
                    splitArea: { show: true }
                }, {
                    scale: true,
                    gridIndex: 1,
                    splitNumber: 2,
                    axisLabel: { show: false },
                    axisLine: { show: false },
                    axisTick: { show: false },
                    splitLine: { show: false }
                }],
                dataZoom: [{
                    type: 'inside',
                    xAxisIndex: [0, 1],
                    start: 0,
                    end: 100
                }],
                series: [{
                    name: 'å®æ—¶Kçº¿',
                    type: 'candlestick',
                    data: candlestickData,
                    itemStyle: {
                        color: '#ef232a',
                        color0: '#14b143',
                        borderColor: '#ef232a',
                        borderColor0: '#14b143'
                    },
                    markPoint: {
                        symbol: 'circle',
                        symbolSize: 8,
                        label: {
                            show: true,
                            position: 'left',
                            formatter: function (param) {
                                return param.value ? param.value.toFixed(2) : '';
                            },
                            color: '#000000',
                            backgroundColor: 'rgba(255,255,255,0.9)',
                            borderWidth: 1,
                            borderColor: '#cccccc',
                            borderRadius: 3,
                            padding: [2, 4],
                            fontSize: 12,
                            fontWeight: 'bold'
                        },
                        data: [
                            {
                                name: 'æœ€é«˜ä»·',
                                coord: [highestIndex, maxHigh],
                                value: maxHigh,
                                itemStyle: {
                                    color: '#ff4444'
                                }
                            },
                            {
                                name: 'æœ€ä½ä»·',
                                coord: [lowestIndex, minLow],
                                value: minLow,
                                itemStyle: {
                                    color: '#44ff44'
                                }
                            }
                        ].filter(item => item.coord[0] >= 0), // è¿‡æ»¤æ‰æ— æ•ˆçš„ç´¢å¼•
                        tooltip: {
                            formatter: function (param) {
                                return param.name + '<br>Â¥' + (param.data.coord ? param.data.coord[1].toFixed(2) : '');
                            }
                        }
                    }
                }, {
                    name: 'æˆäº¤é‡',
                    type: 'bar',
                    xAxisIndex: 1,
                    yAxisIndex: 1,
                    data: volumes,
                    itemStyle: {
                        color: function(params) {
                            const dataIndex = params.dataIndex;
                            if (dataIndex === 0) return '#14b143';
                            return candlestickData[dataIndex][1] > candlestickData[dataIndex][0] ? '#ef232a' : '#14b143';
                        }
                    }
                }, {
                    name: 'å–å‡ºSetup',
                    type: 'scatter',
                    data: nineTurnUp,
                    symbolSize: 0, // éšè—æ•£ç‚¹ç¬¦å·
                    itemStyle: {
                        color: 'transparent'
                    },
                    label: {
                        show: true,
                        position: 'inside',
                        color: '#ef232a', // çº¢è‰²æ•°å­—
                        fontWeight: 'bold',
                        fontSize: 14,
                        backgroundColor: 'rgba(255,255,255,0.8)',
                        borderRadius: 3,
                        padding: [2, 4],
                        formatter: function(param) {
                            return param.data[2]; // æ•°ç»„çš„ç¬¬ä¸‰ä¸ªå…ƒç´ æ˜¯æ•°å€¼ï¼ˆ1-9ï¼‰
                        }
                    }
                }, {
                    name: 'ä¹°å…¥Setup',
                    type: 'scatter',
                    data: nineTurnDown,
                    symbolSize: 0, // éšè—æ•£ç‚¹ç¬¦å·
                    itemStyle: {
                        color: 'transparent'
                    },
                    label: {
                        show: true,
                        position: 'inside',
                        color: '#00aa00', // ç»¿è‰²æ•°å­—
                        fontWeight: 'bold',
                        fontSize: 14,
                        backgroundColor: 'rgba(255,255,255,0.8)',
                        borderRadius: 3,
                        padding: [2, 4],
                        formatter: function(param) {
                            return param.data[2]; // æ•°ç»„çš„ç¬¬ä¸‰ä¸ªå…ƒç´ æ˜¯æ•°å€¼ï¼ˆ1-9ï¼‰
                        }
                    }
                }, {
                    name: 'å–å‡ºCountdown',
                    type: 'scatter',
                    data: countdownUp,
                    symbolSize: 0, // éšè—æ•£ç‚¹ç¬¦å·
                    itemStyle: {
                        color: 'transparent'
                    },
                    label: {
                        show: true,
                        position: 'inside',
                        color: '#8A2BE2', // ç´«è‰²æ•°å­— - å–å‡ºä¿¡å·
                        fontWeight: 'bold',
                        fontSize: 14,
                        backgroundColor: 'rgba(255,255,255,0.8)',
                        borderRadius: 3,
                        padding: [2, 4],
                        formatter: function(param) {
                            return param.data[2]; // æ•°ç»„çš„ç¬¬ä¸‰ä¸ªå…ƒç´ æ˜¯æ•°å€¼ï¼ˆ1-13ï¼‰
                        }
                    }
                }, {
                    name: 'ä¹°å…¥Countdown',
                    type: 'scatter',
                    data: countdownDown,
                    symbolSize: 0, // éšè—æ•£ç‚¹ç¬¦å·
                    itemStyle: {
                        color: 'transparent'
                    },
                    label: {
                        show: true,
                        position: 'inside',
                        color: '#1E90FF', // è“è‰²æ•°å­— - ä¹°å…¥ä¿¡å·
                        fontWeight: 'bold',
                        fontSize: 14,
                        backgroundColor: 'rgba(255,255,255,0.8)',
                        borderRadius: 3,
                        padding: [2, 4],
                        formatter: function(param) {
                            return param.data[2]; // æ•°ç»„çš„ç¬¬ä¸‰ä¸ªå…ƒç´ æ˜¯æ•°å€¼ï¼ˆ1-13ï¼‰
                        }
                    }
                }, {
                    name: 'BOLLä¸Šè½¨',
                    type: 'line',
                    data: bollUpper,
                    lineStyle: {
                        color: '#1E90FF',
                        width: 1
                    },
                    symbol: 'none',
                    smooth: true
                }, {
                    name: 'BOLLä¸­è½¨',
                    type: 'line',
                    data: bollMid,
                    lineStyle: {
                        color: '#1E90FF',
                        width: 1
                    },
                    symbol: 'none',
                    smooth: true
                }, {
                    name: 'BOLLä¸‹è½¨',
                    type: 'line',
                    data: bollLower,
                    lineStyle: {
                        color: '#1E90FF',
                        width: 1
                    },
                    symbol: 'none',
                    smooth: true
                }]
            };
            
            chart.setOption(option);
            
            window.addEventListener('resize', function() {
                chart.resize();
            });
        }
        
        function drawKlineChart(data) {
            const chart = echarts.init(document.getElementById('klineChart'));
            
            // è°ƒè¯•ï¼šæ£€æŸ¥Kçº¿æ•°æ®çš„å¤æƒçŠ¶æ€
            console.log('Kçº¿æ•°æ®è°ƒè¯•ä¿¡æ¯:');
            if (data.kline_data && data.kline_data.length > 0) {
                const firstItem = data.kline_data[0];
                const lastItem = data.kline_data[data.kline_data.length - 1];
                console.log('ç¬¬ä¸€æ¡Kçº¿æ•°æ®:', firstItem);
                console.log('æœ€åä¸€æ¡Kçº¿æ•°æ®:', lastItem);
                console.log('æ˜¯å¦ä¸ºå¤æƒæ•°æ®:', lastItem.is_adjusted);
                console.log('å¤æƒå› å­:', lastItem.adj_factor);
            }
            
            const klineData = data.kline_data.map(item => [
                safeParseFloat(item.open),
                safeParseFloat(item.close),
                safeParseFloat(item.low),
                safeParseFloat(item.high)
            ]);
            
            const dates = data.kline_data.map(item => formatDate(item.trade_date));
            const volumes = data.kline_data.map(item => safeParseFloat(item.vol));
            
            // å–å‡ºSetupæ•°æ® - 1-9æ•°å­—ï¼Œçº¢è‰²ï¼ŒKçº¿ä¸Šæ–¹
            const nineTurnUp = data.kline_data.map((item, index) => {
                return item.nine_turn_up > 0 ? [
                    index, // xåæ ‡ï¼šæ•°æ®ç´¢å¼•
                    safeParseFloat(item.high) + (safeParseFloat(item.high) * 0.02), // yåæ ‡ï¼šKçº¿æœ€é«˜ä»·ä¸Šæ–¹2%
                    item.nine_turn_up // æ˜¾ç¤ºçš„æ•°å€¼ï¼ˆ1-9ï¼‰
                ] : null;
            }).filter(item => item !== null);
            
            // ä¹°å…¥Setupæ•°æ® - 1-9æ•°å­—ï¼Œç»¿è‰²ï¼ŒKçº¿ä¸‹æ–¹
            const nineTurnDown = data.kline_data.map((item, index) => {
                return item.nine_turn_down > 0 ? [
                    index, // xåæ ‡ï¼šæ•°æ®ç´¢å¼•
                    safeParseFloat(item.low) - (safeParseFloat(item.low) * 0.02), // yåæ ‡ï¼šKçº¿æœ€ä½ä»·ä¸‹æ–¹2%
                    item.nine_turn_down // æ˜¾ç¤ºçš„æ•°å€¼ï¼ˆ1-9ï¼‰
                ] : null;
            }).filter(item => item !== null);
            
            // å–å‡ºCountdownæ•°æ® - 1-13æ•°å­—ï¼Œç´«è‰²ï¼Œå–å‡ºSetupä¸Šæ–¹
            const countdownUp = data.kline_data.map((item, index) => {
                return item.countdown_up > 0 ? [
                    index, // xåæ ‡ï¼šæ•°æ®ç´¢å¼•
                    safeParseFloat(item.high) + (safeParseFloat(item.high) * 0.05), // yåæ ‡ï¼šKçº¿æœ€é«˜ä»·ä¸Šæ–¹5%ï¼ˆå–å‡ºSetupä¸Šæ–¹ï¼‰
                    item.countdown_up // æ˜¾ç¤ºçš„æ•°å€¼ï¼ˆ1-13ï¼‰
                ] : null;
            }).filter(item => item !== null);
            
            // ä¹°å…¥Countdownæ•°æ® - 1-13æ•°å­—ï¼Œè“è‰²ï¼Œä¹°å…¥Setupä¸‹æ–¹
            const countdownDown = data.kline_data.map((item, index) => {
                return item.countdown_down > 0 ? [
                    index, // xåæ ‡ï¼šæ•°æ®ç´¢å¼•
                    safeParseFloat(item.low) - (safeParseFloat(item.low) * 0.05), // yåæ ‡ï¼šKçº¿æœ€ä½ä»·ä¸‹æ–¹5%ï¼ˆä¹°å…¥Setupä¸‹æ–¹ï¼‰
                    item.countdown_down // æ˜¾ç¤ºçš„æ•°å€¼ï¼ˆ1-13ï¼‰
                ] : null;
            }).filter(item => item !== null);
            
            // æå–BOLLæ•°æ®ï¼Œä¿ç•™nullå€¼è®©EChartsæ­£ç¡®å¤„ç†
            const bollUpper = data.kline_data.map(item => item.boll_upper === null || item.boll_upper === undefined ? null : parseFloat(item.boll_upper));
            const bollMid = data.kline_data.map(item => item.boll_mid === null || item.boll_mid === undefined ? null : parseFloat(item.boll_mid));
            const bollLower = data.kline_data.map(item => item.boll_lower === null || item.boll_lower === undefined ? null : parseFloat(item.boll_lower));
            
            // æ‰¾åˆ°æœ€é«˜ä»·å’Œæœ€ä½ä»·çš„ä½ç½®
            let highestIndex = -1;
            let lowestIndex = -1;
            let maxHigh = -1;
            let minLow = Number.MAX_VALUE;
            
            // éå†æ‰€æœ‰æ•°æ®æ‰¾åˆ°çœŸæ­£çš„æœ€é«˜ä»·å’Œæœ€ä½ä»·ä½ç½®
            data.kline_data.forEach((item, index) => {
                const high = safeParseFloat(item.high);
                const low = safeParseFloat(item.low);
                
                if (high > maxHigh) {
                    maxHigh = high;
                    highestIndex = index;
                }
                
                if (low < minLow) {
                    minLow = low;
                    lowestIndex = index;
                }
            });
            
            console.log('æœ€é«˜ä»·ä½ç½®:', highestIndex, 'ä»·æ ¼:', maxHigh);
            console.log('æœ€ä½ä»·ä½ç½®:', lowestIndex, 'ä»·æ ¼:', minLow);
            
            const option = {
                animation: false,
                legend: {
                    bottom: 10,
                    left: 'center',
                    data: ['æ—¥K', 'æˆäº¤é‡', 'å–å‡ºSetup', 'ä¹°å…¥Setup', 'å–å‡ºCountdown', 'ä¹°å…¥Countdown', 'BOLLä¸Šè½¨', 'BOLLä¸­è½¨', 'BOLLä¸‹è½¨']
                },
                tooltip: {
                    trigger: 'axis',
                    axisPointer: {
                        type: 'cross'
                    },
                    backgroundColor: 'rgba(245, 245, 245, 0.8)',
                    borderWidth: 1,
                    borderColor: '#ccc',
                    textStyle: {
                        color: '#000'
                    },
                    formatter: function (params) {
                        const dataIndex = params[0].dataIndex;
                        const klineItem = data.kline_data[dataIndex];
                        const date = params[0].axisValue;
                        
                        let html = `<div style="font-weight: bold; margin-bottom: 5px;">${date}</div>`;
                        
                        // æŸ¥æ‰¾Kçº¿æ•°æ®å‚æ•°
                        const klineParam = params.find(p => p.seriesName === 'æ—¥K');
                        if (klineParam && klineParam.data) {
                            const candlestickPrices = klineParam.data;
                            // æ£€æŸ¥æ˜¯å¦ä¸ºå‰å¤æƒæ•°æ®
                            const isAdjusted = klineItem && klineItem.is_adjusted === true;
                            const priceType = isAdjusted ? 'å‰å¤æƒ' : 'æœªé™¤æƒ';
                            const priceColor = isAdjusted ? '#2e7d32' : '#999'; // å‰å¤æƒç”¨ç»¿è‰²ï¼Œæœªé™¤æƒç”¨ç°è‰²
                            
                            // ECharts candlestickæ•°æ®æ ¼å¼: [open, close, low, high]
                            html += `<div style="color: #333; margin-bottom: 3px;">å¼€ç›˜: Â¥${candlestickPrices[0].toFixed(2)} <span style="color: ${priceColor}; font-size: 11px;">(${priceType})</span></div>`;
                            html += `<div style="color: #333; margin-bottom: 3px;">æ”¶ç›˜: Â¥${candlestickPrices[1].toFixed(2)} <span style="color: ${priceColor}; font-size: 11px;">(${priceType})</span></div>`;
                            html += `<div style="color: #333; margin-bottom: 3px;">æœ€ä½: Â¥${candlestickPrices[2].toFixed(2)} <span style="color: ${priceColor}; font-size: 11px;">(${priceType})</span></div>`;
                            html += `<div style="color: #333; margin-bottom: 3px;">æœ€é«˜: Â¥${candlestickPrices[3].toFixed(2)} <span style="color: ${priceColor}; font-size: 11px;">(${priceType})</span></div>`;
                            
                            // å¦‚æœæœ‰å¤æƒå› å­ä¿¡æ¯ï¼Œæ˜¾ç¤ºå¤æƒå› å­
                            if (klineItem && klineItem.adj_factor && klineItem.adj_factor !== 1.0) {
                                html += `<div style="color: #666; margin-top: 5px; font-size: 11px;">å¤æƒå› å­: ${klineItem.adj_factor.toFixed(4)}</div>`;
                            }
                            
                            // è°ƒè¯•ä¿¡æ¯ï¼šæ˜¾ç¤ºis_adjustedå­—æ®µçš„å€¼
                            console.log(`Kçº¿æ•°æ®è°ƒè¯• - æ—¥æœŸ: ${date}, is_adjusted: ${klineItem ? klineItem.is_adjusted : 'undefined'}, adj_factor: ${klineItem ? klineItem.adj_factor : 'undefined'}`);
                        }
                        
                        // BOLLçº¿æ•°æ®
                        const bollUpperParam = params.find(p => p.seriesName === 'BOLLä¸Šè½¨');
                        const bollMidParam = params.find(p => p.seriesName === 'BOLLä¸­è½¨');
                        const bollLowerParam = params.find(p => p.seriesName === 'BOLLä¸‹è½¨');
                        
                        if (bollUpperParam && bollUpperParam.data !== null) {
                            html += `<div style="color: #1E90FF; margin-bottom: 3px;">BOLL Upper: ${bollUpperParam.data.toFixed(2)}</div>`;
                        }
                        if (bollMidParam && bollMidParam.data !== null) {
                            html += `<div style="color: #1E90FF; margin-bottom: 3px;">BOLL Mid: ${bollMidParam.data.toFixed(2)}</div>`;
                        }
                        if (bollLowerParam && bollLowerParam.data !== null) {
                            html += `<div style="color: #1E90FF; margin-bottom: 3px;">BOLL Lower: ${bollLowerParam.data.toFixed(2)}</div>`;
                        }
                        
                        // æˆäº¤é¢
                        if (klineItem && klineItem.amount) {
                            const amount = parseFloat(klineItem.amount);
                            html += `<div style="color: #666; margin-bottom: 3px;">Amount: ${formatNumber(amount * 1000)}</div>`;
                        }
                        
                        // æ¶¨è·Œå¹…
                        if (klineItem && klineItem.pct_chg !== undefined && klineItem.pct_chg !== null) {
                            const pctChg = parseFloat(klineItem.pct_chg);
                            const color = pctChg >= 0 ? '#ff4444' : '#44aa44';
                            html += `<div style="color: ${color}; margin-bottom: 3px;">Change: ${pctChg >= 0 ? '+' : ''}${pctChg.toFixed(2)}%</div>`;
                        }
                        
                        // æ¢æ‰‹ç‡ï¼ˆå¦‚æœæ˜¯æœ€æ–°ä¸€å¤©çš„æ•°æ®ï¼‰
                        if (dataIndex === data.kline_data.length - 1 && data.turnover_rate) {
                            html += `<div style="color: #666; margin-bottom: 3px;">Turnover Rate: ${data.turnover_rate.toFixed(2)}%</div>`;
                        }
                        
                        // é‡æ¯”ï¼ˆå¦‚æœæ˜¯æœ€æ–°ä¸€å¤©çš„æ•°æ®ï¼‰
                        if (dataIndex === data.kline_data.length - 1 && data.volume_ratio) {
                            html += `<div style="color: #666; margin-bottom: 3px;">Volume Ratio: ${data.volume_ratio.toFixed(2)}</div>`;
                        }
                        
                        // æˆäº¤é‡æ•°æ®
                        const volumeParam = params.find(p => p.seriesName === 'æˆäº¤é‡');
                        if (volumeParam) {
                            const vol = volumeParam.data;
                            html += `<div style="color: #888; margin-top: 5px;">Volume: ${formatNumber(vol * 100)}</div>`;
                        }
                        
                        return html;
                    }
                },
                axisPointer: {
                    link: [
                        {
                            xAxisIndex: 'all'
                        }
                    ],
                    label: {
                        backgroundColor: '#777'
                    }
                },
                toolbox: {
                    feature: {
                        dataZoom: {
                            yAxisIndex: false
                        },
                        brush: {
                            type: ['lineX', 'clear']
                        }
                    }
                },
                brush: {
                    xAxisIndex: 'all',
                    brushLink: 'all',
                    outOfBrush: {
                        colorAlpha: 0.1
                    }
                },
                grid: [
                    {
                        left: '10%',
                        right: '8%',
                        height: '50%'
                    },
                    {
                        left: '10%',
                        right: '8%',
                        top: '63%',
                        height: '16%'
                    }
                ],
                xAxis: [
                    {
                        type: 'category',
                        data: dates,
                        boundaryGap: false,
                        axisLine: { onZero: false },
                        splitLine: { show: false },
                        min: 'dataMin',
                        max: 'dataMax',
                        axisPointer: {
                            z: 100
                        }
                    },
                    {
                        type: 'category',
                        gridIndex: 1,
                        data: dates,
                        boundaryGap: false,
                        axisLine: { onZero: false },
                        axisTick: { show: false },
                        splitLine: { show: false },
                        axisLabel: { show: false },
                        min: 'dataMin',
                        max: 'dataMax'
                    }
                ],
                yAxis: [
                    {
                        scale: true,
                        splitArea: {
                            show: true
                        }
                    },
                    {
                        scale: true,
                        gridIndex: 1,
                        splitNumber: 2,
                        axisLabel: { show: false },
                        axisLine: { show: false },
                        axisTick: { show: false },
                        splitLine: { show: false }
                    }
                ],
                dataZoom: [
                    {
                        type: 'inside',
                        xAxisIndex: [0, 1],
                        start: 0,
                        end: 100
                    },
                    {
                        show: true,
                        xAxisIndex: [0, 1],
                        type: 'slider',
                        top: '85%',
                        start: 0,
                        end: 100
                    }
                ],
                series: [
                    {
                        name: 'æ—¥K',
                        type: 'candlestick',
                        data: klineData,
                        itemStyle: {
                            color: '#ef232a',
                            color0: '#14b143',
                            borderColor: '#ef232a',
                            borderColor0: '#14b143'
                        },
                        markPoint: {
                            symbol: 'circle',
                            symbolSize: 8,
                            label: {
                                show: true,
                                position: 'left',
                                formatter: function (param) {
                                    return param.value ? param.value.toFixed(2) : '';
                                },
                                color: '#000000',
                                backgroundColor: 'rgba(255,255,255,0.9)',
                                borderWidth: 1,
                                borderColor: '#cccccc',
                                borderRadius: 3,
                                padding: [2, 4],
                                fontSize: 12,
                                fontWeight: 'bold'
                            },
                            data: [
                                {
                                    name: 'æœ€é«˜ä»·',
                                    coord: [highestIndex, maxHigh],
                                    value: maxHigh,
                                    itemStyle: {
                                        color: '#ff4444'
                                    }
                                },
                                {
                                    name: 'æœ€ä½ä»·',
                                    coord: [lowestIndex, minLow],
                                    value: minLow,
                                    itemStyle: {
                                        color: '#44ff44'
                                    }
                                }
                            ].filter(item => item.coord[0] >= 0), // è¿‡æ»¤æ‰æ— æ•ˆçš„ç´¢å¼•
                            tooltip: {
                                formatter: function (param) {
                                    return param.name + '<br>Â¥' + (param.data.coord ? param.data.coord[1].toFixed(2) : '');
                                }
                            }
                        }
                    },
                    {
                        name: 'æˆäº¤é‡',
                        type: 'bar',
                        xAxisIndex: 1,
                        yAxisIndex: 1,
                        data: volumes,
                        itemStyle: {
                            color: function(params) {
                                const dataIndex = params.dataIndex;
                                if (dataIndex === 0) return '#14b143';
                                return klineData[dataIndex][1] > klineData[dataIndex][0] ? '#ef232a' : '#14b143';
                            }
                        }
                    },
                    {
                        name: 'å–å‡ºSetup',
                        type: 'scatter',
                        data: nineTurnUp,
                        symbolSize: 0, // éšè—æ•£ç‚¹ç¬¦å·
                        itemStyle: {
                            color: 'transparent'
                        },
                        label: {
                            show: true,
                            position: 'inside',
                            color: '#ef232a', // çº¢è‰²æ•°å­—
                            fontWeight: 'bold',
                            fontSize: 14,
                            backgroundColor: 'rgba(255,255,255,0.8)',
                            borderRadius: 3,
                            padding: [2, 4],
                            formatter: function(param) {
                                return param.data[2]; // æ•°ç»„çš„ç¬¬ä¸‰ä¸ªå…ƒç´ æ˜¯æ•°å€¼ï¼ˆ1-9ï¼‰
                            }
                        }
                    },
                    {
                        name: 'ä¹°å…¥Setup',
                        type: 'scatter',
                        data: nineTurnDown,
                        symbolSize: 0, // éšè—æ•£ç‚¹ç¬¦å·
                        itemStyle: {
                            color: 'transparent'
                        },
                        label: {
                            show: true,
                            position: 'inside',
                            color: '#00aa00', // ç»¿è‰²æ•°å­—
                            fontWeight: 'bold',
                            fontSize: 14,
                            backgroundColor: 'rgba(255,255,255,0.8)',
                            borderRadius: 3,
                            padding: [2, 4],
                            formatter: function(param) {
                                return param.data[2]; // æ•°ç»„çš„ç¬¬ä¸‰ä¸ªå…ƒç´ æ˜¯æ•°å€¼ï¼ˆ1-9ï¼‰
                            }
                        }
                    },
                    {
                        name: 'å–å‡ºCountdown',
                        type: 'scatter',
                        data: countdownUp,
                        symbolSize: 0, // éšè—æ•£ç‚¹ç¬¦å·
                        itemStyle: {
                            color: 'transparent'
                        },
                        label: {
                            show: true,
                            position: 'inside',
                            color: '#8A2BE2', // ç´«è‰²æ•°å­— - å–å‡ºä¿¡å·
                            fontWeight: 'bold',
                            fontSize: 14,
                            backgroundColor: 'rgba(255,255,255,0.8)',
                            borderRadius: 3,
                            padding: [2, 4],
                            formatter: function(param) {
                                return param.data[2]; // æ•°ç»„çš„ç¬¬ä¸‰ä¸ªå…ƒç´ æ˜¯æ•°å€¼ï¼ˆ1-13ï¼‰
                            }
                        }
                    },
                    {
                        name: 'ä¹°å…¥Countdown',
                        type: 'scatter',
                        data: countdownDown,
                        symbolSize: 0, // éšè—æ•£ç‚¹ç¬¦å·
                        itemStyle: {
                            color: 'transparent'
                        },
                        label: {
                            show: true,
                            position: 'inside',
                            color: '#1E90FF', // è“è‰²æ•°å­— - ä¹°å…¥ä¿¡å·
                            fontWeight: 'bold',
                            fontSize: 14,
                            backgroundColor: 'rgba(255,255,255,0.8)',
                            borderRadius: 3,
                            padding: [2, 4],
                            formatter: function(param) {
                                return param.data[2]; // æ•°ç»„çš„ç¬¬ä¸‰ä¸ªå…ƒç´ æ˜¯æ•°å€¼ï¼ˆ1-13ï¼‰
                            }
                        }
                    },
                    {
                        name: 'BOLLä¸Šè½¨',
                        type: 'line',
                        data: bollUpper,
                        lineStyle: {
                            color: '#1E90FF',
                            width: 1
                        },
                        symbol: 'none',
                        smooth: true
                    },
                    {
                        name: 'BOLLä¸­è½¨',
                        type: 'line',
                        data: bollMid,
                        lineStyle: {
                            color: '#1E90FF',
                            width: 1
                        },
                        symbol: 'none',
                        smooth: true
                    },
                    {
                        name: 'BOLLä¸‹è½¨',
                        type: 'line',
                        data: bollLower,
                        lineStyle: {
                            color: '#1E90FF',
                            width: 1
                        },
                        symbol: 'none',
                        smooth: true
                    }
                ]
            };
            
            chart.setOption(option);
            
            window.addEventListener('resize', function() {
                chart.resize();
            });
        }
        
        function drawMacdChart(data) {
            const chart = echarts.init(document.getElementById('macdChart'));
            
            const dates = data.kline_data.map(item => formatDate(item.trade_date));
            
            // æå–MACDæ•°æ®
            const macdDif = data.kline_data.map(item => item.macd_dif === null || item.macd_dif === undefined ? null : parseFloat(item.macd_dif));
            const macdDea = data.kline_data.map(item => item.macd_dea === null || item.macd_dea === undefined ? null : parseFloat(item.macd_dea));
            const macdHistogram = data.kline_data.map(item => item.macd_histogram === null || item.macd_histogram === undefined ? null : parseFloat(item.macd_histogram));
            
            const option = {
                animation: false,
                legend: {
                    bottom: 10,
                    left: 'center',
                    data: ['DIF', 'DEA', 'MACD']
                },
                tooltip: {
                    trigger: 'axis',
                    axisPointer: {
                        type: 'cross'
                    }
                },
                grid: {
                    left: '10%',
                    right: '8%',
                    top: '10%',
                    bottom: '15%'
                },
                xAxis: {
                    type: 'category',
                    data: dates,
                    boundaryGap: false
                },
                yAxis: {
                    scale: true,
                    splitArea: {
                        show: true
                    }
                },
                dataZoom: [
                    {
                        type: 'inside',
                        start: 0,
                        end: 100
                    },
                    {
                        show: true,
                        type: 'slider',
                        bottom: '5%',
                        start: 0,
                        end: 100
                    }
                ],
                series: [
                    {
                        name: 'DIF',
                        type: 'line',
                        data: macdDif,
                        lineStyle: {
                            color: '#FF6B6B',
                            width: 2
                        },
                        symbol: 'none',
                        smooth: true
                    },
                    {
                        name: 'DEA',
                        type: 'line',
                        data: macdDea,
                        lineStyle: {
                            color: '#4ECDC4',
                            width: 2
                        },
                        symbol: 'none',
                        smooth: true
                    },
                    {
                        name: 'MACD',
                        type: 'bar',
                        data: macdHistogram,
                        itemStyle: {
                            color: function(params) {
                                return params.value >= 0 ? '#FF6B6B' : '#4ECDC4';
                            }
                        }
                    }
                ]
            };
            
            chart.setOption(option);
            
            window.addEventListener('resize', function() {
                chart.resize();
            });
        }
        
        function drawKdjChart(data) {
            const chart = echarts.init(document.getElementById('kdjChart'));
            
            const dates = data.kline_data.map(item => formatDate(item.trade_date));
            
            // æå–KDJæ•°æ®
            const kdjK = data.kline_data.map(item => item.kdj_k === null || item.kdj_k === undefined ? null : parseFloat(item.kdj_k));
            const kdjD = data.kline_data.map(item => item.kdj_d === null || item.kdj_d === undefined ? null : parseFloat(item.kdj_d));
            const kdjJ = data.kline_data.map(item => item.kdj_j === null || item.kdj_j === undefined ? null : parseFloat(item.kdj_j));
            
            const option = {
                animation: false,
                legend: {
                    bottom: 10,
                    left: 'center',
                    data: [
                        {
                            name: 'K',
                            textStyle: {
                                color: '#9C27B0'
                            }
                        },
                        {
                            name: 'D',
                            textStyle: {
                                color: '#45B7D1'
                            }
                        },
                        {
                            name: 'J',
                            textStyle: {
                                color: '#FF6B6B'
                            }
                        }
                    ]
                },
                tooltip: {
                    trigger: 'axis',
                    axisPointer: {
                        type: 'cross'
                    }
                },
                grid: {
                    left: '10%',
                    right: '8%',
                    top: '10%',
                    bottom: '15%'
                },
                xAxis: {
                    type: 'category',
                    data: dates,
                    boundaryGap: false
                },
                yAxis: {
                    scale: true,
                    min: 0,
                    max: 100,
                    splitArea: {
                        show: true
                    },
                    axisLine: {
                        lineStyle: {
                            color: '#ccc'
                        }
                    },
                    splitLine: {
                        lineStyle: {
                            color: ['#20', '#80'],
                            type: 'dashed'
                        }
                    }
                },
                dataZoom: [
                    {
                        type: 'inside',
                        start: 0,
                        end: 100
                    },
                    {
                        show: true,
                        type: 'slider',
                        bottom: '5%',
                        start: 0,
                        end: 100
                    }
                ],
                series: [
                    {
                        name: 'K',
                        type: 'line',
                        data: kdjK,
                        lineStyle: {
                            color: '#9C27B0',
                            width: 2
                        },
                        symbol: 'none',
                        smooth: true
                    },
                    {
                        name: 'D',
                        type: 'line',
                        data: kdjD,
                        lineStyle: {
                            color: '#45B7D1',
                            width: 2
                        },
                        symbol: 'none',
                        smooth: true
                    },
                    {
                        name: 'J',
                        type: 'line',
                        data: kdjJ,
                        lineStyle: {
                            color: '#FF6B6B',
                            width: 2
                        },
                        symbol: 'none',
                        smooth: true
                    },
                    {
                        name: 'è¶…ä¹°è¶…å–çº¿',
                        type: 'line',
                        data: [],
                        markLine: {
                            silent: true,
                            data: [
                                {
                                    yAxis: 20,
                                    lineStyle: {
                                        color: '#27ae60',
                                        type: 'solid',
                                        width: 2
                                    },
                                    label: {
                                        formatter: 'è¶…å–åŒº',
                                        position: 'insideEndTop',
                                        color: '#27ae60',
                                        fontWeight: 'bold'
                                    }
                                },
                                {
                                    yAxis: 80,
                                    lineStyle: {
                                        color: '#e74c3c',
                                        type: 'solid',
                                        width: 2
                                    },
                                    label: {
                                        formatter: 'è¶…ä¹°åŒº',
                                        position: 'insideEndBottom',
                                        color: '#e74c3c',
                                        fontWeight: 'bold'
                                    }
                                }
                            ]
                        }
                    }
                ]
            };
            
            chart.setOption(option);
            
            window.addEventListener('resize', function() {
                chart.resize();
            });
        }
        
        function drawRsiChart(data) {
            const chart = echarts.init(document.getElementById('rsiChart'));
            
            const dates = data.kline_data.map(item => formatDate(item.trade_date));
            
            // æå–RSIæ•°æ®
            const rsiData = data.kline_data.map(item => item.rsi === null || item.rsi === undefined ? null : parseFloat(item.rsi));
            
            const option = {
                animation: false,
                legend: {
                    bottom: 10,
                    left: 'center',
                    data: ['RSI']
                },
                tooltip: {
                    trigger: 'axis',
                    axisPointer: {
                        type: 'cross'
                    },
                    formatter: function(params) {
                        if (params && params.length > 0) {
                            const value = params[0].value;
                            return params[0].name + '<br/>RSI: ' + (value !== null ? value.toFixed(2) : '-');
                        }
                        return '';
                    }
                },
                grid: {
                    left: '10%',
                    right: '8%',
                    top: '10%',
                    bottom: '15%'
                },
                xAxis: {
                    type: 'category',
                    data: dates,
                    boundaryGap: false
                },
                yAxis: {
                    scale: true,
                    min: 0,
                    max: 100,
                    splitArea: {
                        show: true
                    },
                    axisLine: {
                        lineStyle: {
                            color: '#ccc'
                        }
                    },
                    splitLine: {
                        lineStyle: {
                            color: ['#30', '#70'],
                            type: 'dashed'
                        }
                    }
                },
                dataZoom: [
                    {
                        type: 'inside',
                        start: 0,
                        end: 100
                    },
                    {
                        show: true,
                        type: 'slider',
                        bottom: '5%',
                        start: 0,
                        end: 100
                    }
                ],
                series: [
                    {
                        name: 'RSI',
                        type: 'line',
                        data: rsiData,
                        lineStyle: {
                            color: '#9C27B0',
                            width: 2
                        },
                        symbol: 'none',
                        smooth: true,
                        areaStyle: {
                            color: {
                                type: 'linear',
                                x: 0,
                                y: 0,
                                x2: 0,
                                y2: 1,
                                colorStops: [
                                    {
                                        offset: 0,
                                        color: 'rgba(156, 39, 176, 0.3)'
                                    },
                                    {
                                        offset: 1,
                                        color: 'rgba(156, 39, 176, 0.1)'
                                    }
                                ]
                            }
                        },
                        markLine: {
                             silent: true,
                             data: [
                                 {
                                     yAxis: 30,
                                     lineStyle: {
                                         color: '#27ae60',
                                         type: 'dashed',
                                         width: 2
                                     },
                                     label: {
                                         formatter: 'è¶…å–åŒº 30',
                                         position: 'insideEndTop',
                                         color: '#27ae60',
                                         fontWeight: 'bold'
                                     }
                                 },
                                 {
                                     yAxis: 70,
                                     lineStyle: {
                                         color: '#e74c3c',
                                         type: 'dashed',
                                         width: 2
                                     },
                                     label: {
                                         formatter: 'è¶…ä¹°åŒº 70',
                                         position: 'insideEndBottom',
                                         color: '#e74c3c',
                                         fontWeight: 'bold'
                                     }
                                 }
                             ]
                         }
                    }
                ]
            };
            
            chart.setOption(option);
            
            window.addEventListener('resize', function() {
                chart.resize();
            });
        }
        
        function showError(message) {
            document.getElementById('loadingDiv').style.display = 'none';
            document.getElementById('errorDiv').textContent = message;
            document.getElementById('errorDiv').style.display = 'block';
        }
        
        function refreshStockData() {
            const refreshBtn = document.getElementById('refreshDataBtn');
            const originalText = refreshBtn.textContent;
            
            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            refreshBtn.textContent = 'ğŸ”„ åˆ·æ–°ä¸­...';
            refreshBtn.disabled = true;
            
            // æ˜¾ç¤ºåŠ è½½æç¤º
            document.getElementById('stockInfo').style.display = 'none';
            document.getElementById('chartSection').style.display = 'none';
            document.getElementById('macdSection').style.display = 'none';
            document.getElementById('kdjSection').style.display = 'none';
            document.getElementById('rsiSection').style.display = 'none';
            document.getElementById('loadingDiv').style.display = 'block';
            document.getElementById('loadingDiv').textContent = 'æ­£åœ¨å¼ºåˆ¶åˆ·æ–°æ•°æ®...';
            document.getElementById('errorDiv').style.display = 'none';
            
            // å¼ºåˆ¶åˆ·æ–°æ•°æ®ï¼ˆæ·»åŠ æ—¶é—´æˆ³å‚æ•°é¿å…ç¼“å­˜ï¼‰
            const timestamp = new Date().getTime();
            fetch(`/api/stock/${stockCode}?force_refresh=true&t=${timestamp}`)
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        showError(data.error);
                        return;
                    }
                    
                    stockData = data;
                    displayStockInfo(data);
                    drawKlineChart(data);
                    drawMacdChart(data);
                    drawKdjChart(data);
                    drawRsiChart(data);
                    
                    // æ•°æ®åˆ·æ–°æˆåŠŸï¼Œä¸æ˜¾ç¤ºæç¤ºæ¡†
                })
                .catch(error => {
                    showError('åˆ·æ–°æ•°æ®å¤±è´¥: ' + error.message);
                })
                .finally(() => {
                    // æ¢å¤æŒ‰é’®çŠ¶æ€
                    refreshBtn.textContent = originalText;
                    refreshBtn.disabled = false;
                });
        }
        
        function addToWatchlistWithPriority(priority) {
            if (!priority) {
                return; // å¦‚æœæ²¡æœ‰é€‰æ‹©ä¼˜å…ˆçº§ï¼Œä¸æ‰§è¡Œä»»ä½•æ“ä½œ
            }
            
            if (!stockData) {
                alert('è‚¡ç¥¨æ•°æ®å°šæœªåŠ è½½å®Œæˆï¼Œè¯·ç¨åå†è¯•');
                // é‡ç½®é€‰æ‹©å™¨
                document.getElementById('addToWatchlistSelect').selectedIndex = 0;
                return;
            }
            
            // è·å–æœ€æ–°çš„ä¹è½¬åºåˆ—æ•°æ®
            let nineTurnUp = 0;
            let nineTurnDown = 0;
            if (stockData.kline_data && stockData.kline_data.length > 0) {
                const latestData = stockData.kline_data[stockData.kline_data.length - 1];
                nineTurnUp = latestData.nine_turn_up || 0;
                nineTurnDown = latestData.nine_turn_down || 0;
            }
            
            // ç”Ÿæˆè‡ªåŠ¨å¤‡æ³¨ï¼šæ—¥æœŸ + ä¹è½¬æ•°æ®å’Œé¢œè‰²
            const today = new Date();
            const dateStr = `${today.getDate()}å·`;
            let nineTurnNote = '';
            
            if (nineTurnUp > 0) {
                nineTurnNote = `çº¢è‰²${nineTurnUp}`;
            } else if (nineTurnDown > 0) {
                nineTurnNote = `ç»¿è‰²${nineTurnDown}`;
            } else {
                nineTurnNote = 'æ— ä¹è½¬ä¿¡å·';
            }
            
            const autoNote = `${dateStr}åŠ å…¥ï¼Œ${nineTurnNote}`;
            
            const watchlistData = {
                ts_code: stockData.ts_code,
                name: stockData.name,
                latest_price: stockData.latest_price,
                pct_chg: stockData.pct_chg || 0,
                industry: stockData.industry || '-',
                turnover_rate: stockData.turnover_rate || 0,
                volume_ratio: stockData.volume_ratio || 0,
                pe: stockData.pe || 0,
                amount: stockData.amount || 0,
                total_mv: stockData.total_mv || 0,
                nine_turn_up: nineTurnUp,
                nine_turn_down: nineTurnDown,
                priority: priority, // æ·»åŠ ä¼˜å…ˆçº§
                note: autoNote, // è‡ªåŠ¨ç”Ÿæˆçš„å¤‡æ³¨
                add_time: new Date().toISOString()
            };
            
            fetch('/api/watchlist/add', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(watchlistData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // æ›´æ–°UIçŠ¶æ€ä¸ºå·²æ·»åŠ 
                    updateWatchlistUI(true, priority);
                    
                    // æˆåŠŸåŠ å…¥è‡ªé€‰è‚¡ï¼Œæ— éœ€æç¤º
                } else {
                    alert(data.message || 'åŠ å…¥è‡ªé€‰è‚¡å¤±è´¥');
                    // é‡ç½®é€‰æ‹©å™¨
                    document.getElementById('addToWatchlistSelect').selectedIndex = 0;
                }
            })
            .catch(error => {
                alert('åŠ å…¥è‡ªé€‰è‚¡å¤±è´¥: ' + error.message);
                // é‡ç½®é€‰æ‹©å™¨
                document.getElementById('addToWatchlistSelect').selectedIndex = 0;
            });
        }
        
        function removeFromWatchlist() {
            if (!stockData) {
                alert('è‚¡ç¥¨æ•°æ®å°šæœªåŠ è½½å®Œæˆï¼Œè¯·ç¨åå†è¯•');
                return;
            }
            
            
            fetch('/api/watchlist/remove', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    ts_code: stockData.ts_code
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // æ›´æ–°UIçŠ¶æ€ä¸ºæœªæ·»åŠ 
                    updateWatchlistUI(false);
                    
                    // æˆåŠŸåˆ é™¤è‡ªé€‰è‚¡ï¼Œæ— éœ€æç¤º
                } else {
                    alert(data.message || 'åˆ é™¤å¤±è´¥');
                }
            })
            .catch(error => {
                alert('åˆ é™¤å¤±è´¥: ' + error.message);
            });
        }
        
        // é¡µé¢åŠ è½½æ—¶è·å–è‚¡ç¥¨æ•°æ®
        loadStockData();
        
        // é¡µé¢åŠ è½½å®Œæˆåï¼Œå»¶è¿Ÿå¯åŠ¨å®æ—¶æ•°æ®è‡ªåŠ¨åˆ·æ–°
        setTimeout(() => {
            if (typeof startRealtimeAutoRefresh === 'function') {
                startRealtimeAutoRefresh();
            }
        }, 2000); // å»¶è¿Ÿ2ç§’å¯åŠ¨ï¼Œç¡®ä¿é¡µé¢å®Œå…¨åŠ è½½
    </script>
</body>
</html>