<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ËÇ°Á•®ËØ¶ÊÉÖ - ÊØèÊó•ÊåáÊ†á</title>
    <script src="https://cdn.plot.ly/plotly-2.35.2.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', sans-serif;
            background-color: #f8f9fa;
            color: #333;
            line-height: 1.4;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .stock-header {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .stock-info {
            display: flex;
            align-items: center;
            gap: 20px;
            flex: 1;
        }

        .stock-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 10px;
        }

        .stock-actions-left {
            display: flex;
            gap: 10px;
        }

        .stock-actions-right {
            display: flex;
            gap: 10px;
        }

        .action-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 6px;
            min-width: 120px;
            justify-content: center;
        }

        .action-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .action-btn:active {
            transform: translateY(0);
        }

        .btn-added {
            background: #28a745;
            color: white;
        }

        .btn-added:hover {
            background: #218838;
        }

        .btn-add {
            background: #007bff;
            color: white;
        }

        .btn-add:hover {
            background: #0056b3;
        }

        .btn-remove {
            background: #dc3545;
            color: white;
        }

        .btn-remove:hover {
            background: #c82333;
        }

        .btn-refresh {
            background: #28a745;
            color: white;
        }

        .btn-refresh:hover {
            background: #218838;
        }

        .btn-refresh:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
        }

        .stock-name {
            font-size: 18px;
            font-weight: 600;
            color: #333;
        }

        .stock-code {
            font-size: 14px;
            color: #666;
        }

        .stock-price {
            font-size: 32px;
            font-weight: 700;
            color: #e74c3c;
        }

        .price-change {
            display: flex;
            gap: 10px;
            align-items: center;
            font-size: 14px;
        }

        .change-amount {
            color: #e74c3c;
        }

        .change-percent {
            color: #e74c3c;
        }

        .indicators-section {
            background: white;
            border-radius: 8px;
            padding: 0;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .indicators-header {
            background: #f8f9fa;
            padding: 15px 20px;
            border-bottom: 1px solid #e9ecef;
            font-weight: 600;
            color: #495057;
        }

        .indicators-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            border-bottom: 1px solid #e9ecef;
        }

        .indicator-item {
            padding: 15px 10px;
            text-align: center;
            border-right: 1px solid #e9ecef;
            transition: background-color 0.2s ease;
        }

        .indicator-item:last-child {
            border-right: none;
        }

        .indicator-item:hover {
            background-color: #f8f9fa;
        }

        .indicator-label {
            font-size: 12px;
            color: #6c757d;
            margin-bottom: 5px;
            line-height: 1.2;
        }

        .indicator-value {
            font-size: 14px;
            font-weight: 600;
            color: #212529;
            line-height: 1.2;
        }

        .positive {
            color: #28a745;
        }

        .negative {
            color: #dc3545;
        }

        .neutral {
            color: #6c757d;
        }

        /* ÂÆûÊó∂‰∫§ÊòìÊï∞ÊçÆÊ†∑Âºè */
        .realtime-section {
            background: white;
            border-radius: 8px;
            padding: 0;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
            overflow: hidden;
        }

        .realtime-header {
            background: #f8f9fa;
            padding: 15px 20px;
            border-bottom: 1px solid #e9ecef;
            font-weight: 600;
            color: #495057;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .realtime-refresh-btn {
            padding: 6px 12px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s ease;
        }

        .realtime-refresh-btn:hover {
            background: #0056b3;
        }

        .realtime-refresh-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }

        .realtime-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 0;
            border-bottom: 1px solid #e9ecef;
        }

        .realtime-item {
            padding: 12px 10px;
            text-align: center;
            border-right: 1px solid #e9ecef;
            transition: background-color 0.2s ease;
        }

        .realtime-item:last-child {
            border-right: none;
        }

        .realtime-item:hover {
            background-color: #f8f9fa;
        }

        .realtime-label {
            font-size: 11px;
            color: #6c757d;
            margin-bottom: 4px;
            line-height: 1.2;
        }

        .realtime-value {
            font-size: 13px;
            font-weight: 600;
            color: #212529;
            line-height: 1.2;
        }

        .realtime-loading {
            text-align: center;
            padding: 20px;
            color: #666;
            font-size: 14px;
        }

        .realtime-error {
            background: #f8d7da;
            color: #721c24;
            padding: 15px 20px;
            border: 1px solid #f5c6cb;
            margin: 0;
            font-size: 14px;
        }

        /* ËµÑÈáëÊµÅÂêëÊï∞ÊçÆÊ†∑Âºè - ‰ºòÂåñÁ¥ßÂáëÁâà */
        .moneyflow-section {
            background: white;
            border-radius: 6px;
            padding: 0;
            box-shadow: 0 1px 4px rgba(0, 0, 0, 0.08);
            margin-bottom: 15px;
            overflow: hidden;
        }

        .moneyflow-header {
            background: #f8f9fa;
            padding: 10px 15px;
            border-bottom: 1px solid #e9ecef;
            font-weight: 600;
            color: #495057;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 14px;
        }

        .moneyflow-refresh-btn {
            padding: 4px 8px;
            background: #28a745;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 11px;
            transition: all 0.2s ease;
        }

        .moneyflow-refresh-btn:hover {
            background: #218838;
        }

        .moneyflow-refresh-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }

        .moneyflow-loading {
            text-align: center;
            padding: 15px;
            color: #666;
            font-size: 13px;
        }

        .moneyflow-error {
            background: #f8d7da;
            color: #721c24;
            padding: 10px 15px;
            border: 1px solid #f5c6cb;
            margin: 0;
            font-size: 13px;
        }

        .moneyflow-grid {
            padding: 12px;
        }

        .moneyflow-summary {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-bottom: 15px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 4px;
            border: 1px solid #e9ecef;
        }

        .moneyflow-summary-item {
            text-align: center;
        }

        .moneyflow-summary-label {
            font-size: 11px;
            color: #6c757d;
            margin-bottom: 4px;
            font-weight: 500;
        }

        .moneyflow-summary-value {
            font-size: 15px;
            font-weight: 700;
            color: #212529;
        }

        .moneyflow-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
        }

        .moneyflow-category {
            border: 1px solid #e9ecef;
            border-radius: 4px;
            overflow: hidden;
        }

        .moneyflow-category-title {
            background: #f8f9fa;
            padding: 8px 10px;
            font-weight: 600;
            color: #495057;
            font-size: 12px;
            border-bottom: 1px solid #e9ecef;
        }

        .moneyflow-category-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0;
        }

        .moneyflow-item {
            padding: 8px 6px;
            text-align: center;
            border-right: 1px solid #e9ecef;
            border-bottom: 1px solid #e9ecef;
            transition: background-color 0.2s ease;
        }

        .moneyflow-item:nth-child(2n) {
            border-right: none;
        }

        .moneyflow-item:nth-last-child(-n+2) {
            border-bottom: none;
        }

        .moneyflow-item:hover {
            background-color: #f8f9fa;
        }

        .moneyflow-label {
            font-size: 10px;
            color: #6c757d;
            margin-bottom: 3px;
            line-height: 1.1;
        }

        .moneyflow-value {
            font-size: 11px;
            font-weight: 600;
            color: #212529;
            line-height: 1.1;
        }

        /* ÊäÄÊúØÊåáÊ†áÂõæË°®Ê†∑Âºè */
        .indicators-charts-section {
            background: white;
            border-radius: 8px;
            padding: 0;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .indicators-charts-header {
            background: #f8f9fa;
            padding: 15px 20px;
            border-bottom: 1px solid #e9ecef;
            font-weight: 600;
            color: #495057;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .indicators-controls {
            display: flex;
            gap: 10px;
        }

        .indicator-btn {
            padding: 6px 12px;
            background: #fff;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s ease;
        }

        .indicator-btn:hover {
            background: #e9ecef;
        }

        .indicator-btn.active {
            background: #007bff;
            color: white;
            border-color: #007bff;
        }

        .indicators-charts-container {
            padding: 20px;
        }

        .indicator-chart {
            width: 100%;
        }

        .indicator-section {
            width: 100%;
            box-sizing: border-box;
        }

        /* Á°Æ‰øùÊâÄÊúâÂõæË°®ÂÆπÂô®ÂÆΩÂ∫¶‰∏ÄËá¥ */
        #candlestickChart, #volumeChart, #macdChart, #kdjChart, #rsiChart {
            width: 100% !important;
            box-sizing: border-box;
        }

        /* Ëú°ÁÉõÂõæÊ†∑Âºè */
        .chart-section {
            background: white;
            border-radius: 8px;
            padding: 0;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .chart-header {
            background: #f8f9fa;
            padding: 15px 20px;
            border-bottom: 1px solid #e9ecef;
            font-weight: 600;
            color: #495057;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chart-controls {
            display: flex;
            gap: 10px;
        }

        .chart-btn {
            padding: 6px 12px;
            background: #fff;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s ease;
        }

        .chart-btn:hover {
            background: #e9ecef;
        }

        .chart-btn.active {
            background: #007bff;
            color: white;
            border-color: #007bff;
        }

        .chart-container {
            padding: 20px;
        }

        .chart-loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 4px;
            margin: 20px;
            border: 1px solid #f5c6cb;
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .indicators-grid {
                grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            }
            
            .indicator-item {
                padding: 10px 5px;
            }
            
            .indicator-label {
                font-size: 11px;
            }
            
            .indicator-value {
                font-size: 13px;
            }
            
            .stock-price {
                font-size: 24px;
            }

            .chart-header {
                flex-direction: column;
                gap: 10px;
                align-items: flex-start;
            }

            .chart-controls {
                width: 100%;
                justify-content: center;
            }
        }

        @media (max-width: 480px) {
            .indicators-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div id="loadingDiv" class="loading" style="display: block;">
            <p>Ê≠£Âú®Âä†ËΩΩÊØèÊó•ÊåáÊ†áÊï∞ÊçÆ...</p>
        </div>

        <div id="errorDiv" class="error" style="display: none;"></div>

        <div id="contentDiv" style="display: none;">
            <div class="stock-header">
                <div class="stock-info">
                    <div>
                        <span id="stockName" class="stock-name">‰∏úÂçéÊµãËØï</span>
                        <span id="stockCode" class="stock-code">300354.SZ</span>
                    </div>
                    <div>
                        <span id="stockPrice" class="stock-price">¬•40.31</span>
                    </div>
                    <div class="price-change">
                        <span id="changeAmount" class="change-amount">+52.00</span>
                        <span>(<span id="changePercent" class="change-percent">+33.30</span>)</span>
                    </div>
                </div>
                
                <!-- Êìç‰ΩúÊåâÈíÆÂå∫Âüü -->
                <div class="stock-actions">
                    <div class="stock-actions-left">
                        <!-- Â∑¶‰æßÁïôÁ©∫ -->
                    </div>
                    <div class="stock-actions-right">
                        <button id="addToWatchlistBtn" class="action-btn btn-add" onclick="addToWatchlist()">
                            <span>+</span>
                            <span>Âä†ÂÖ•Ëá™ÈÄâ</span>
                        </button>
                        <button id="refreshDataBtn" class="action-btn btn-refresh" onclick="refreshAllData()">
                            <span>üîÑ</span>
                            <span>Âà∑Êñ∞Êï∞ÊçÆ</span>
                        </button>
                        <button id="removeFromWatchlistBtn" class="action-btn btn-remove" onclick="removeFromWatchlist()">
                            <span>üóëÔ∏è</span>
                            <span>Âà†Èô§Ëá™ÈÄâ</span>
                        </button>
                    </div>
                </div>
            </div>

            <div class="indicators-section">
                <div class="indicators-header">ÊØèÊó•ÊåáÊ†á</div>
                <div class="indicators-grid">
                    <div class="indicator-item">
                        <div class="indicator-label">Â∏ÇÂÄº</div>
                        <div id="totalMv" class="indicator-value">55.76‰∫ø</div>
                    </div>
                    <div class="indicator-item">
                        <div class="indicator-label">Êàê‰∫§È¢ù</div>
                        <div id="amount" class="indicator-value">2.53‰∫ø</div>
                    </div>
                    <div class="indicator-item">
                        <div class="indicator-label">ÂáÄÊµÅÂÖ•È¢ù</div>
                        <div id="netInflow" class="indicator-value negative">-5310.00‰∏á</div>
                    </div>
                    <div class="indicator-item">
                        <div class="indicator-label">Êç¢ÊâãÁéá</div>
                        <div id="turnoverRate" class="indicator-value">7.71%</div>
                    </div>
                    <div class="indicator-item">
                        <div class="indicator-label">ÈáèÊØî</div>
                        <div id="volumeRatio" class="indicator-value">0.85</div>
                    </div>
                    <div class="indicator-item">
                        <div class="indicator-label">Â∏ÇÁõàÁéá(TTM)</div>
                        <div id="peTtm" class="indicator-value">45.17</div>
                    </div>
                    <div class="indicator-item">
                        <div class="indicator-label">Â∏ÇÂáÄÁéá(PB)</div>
                        <div id="pb" class="indicator-value">7.36</div>
                    </div>
                    <div class="indicator-item">
                        <div class="indicator-label">ÂΩìÂ§©ÂºÄÁõò</div>
                        <div id="open" class="indicator-value">¬•41.01</div>
                    </div>
                    <div class="indicator-item">
                        <div class="indicator-label">ÂΩìÂ§©Ê∂®ÂπÖ</div>
                        <div id="pctChg" class="indicator-value negative">-0.03%</div>
                    </div>
                    <div class="indicator-item">
                        <div class="indicator-label">ÊâÄÂ±ûË°å‰∏ö</div>
                        <div id="industry" class="indicator-value">ÁîµÂô®‰ª™Ë°®</div>
                    </div>
                </div>
            </div>

            <!-- ËµÑÈáëÊµÅÂêëÊï∞ÊçÆÈÉ®ÂàÜ -->
            <div class="moneyflow-section">
                <div class="moneyflow-header">
                    <span>ËµÑÈáëÊµÅÂêë</span>
                    <div style="display: flex; align-items: center; gap: 15px;">
                        <span id="moneyflowTimestamp" style="font-size: 12px; color: #6c757d;">--</span>
                        <button id="moneyflowRefreshBtn" class="moneyflow-refresh-btn" onclick="refreshMoneyflowData()">Âà∑Êñ∞</button>
                    </div>
                </div>
                <div id="moneyflowContent">
                    <div id="moneyflowLoading" class="moneyflow-loading" style="display: block;">
                        Ê≠£Âú®Âä†ËΩΩËµÑÈáëÊµÅÂêëÊï∞ÊçÆ...
                    </div>
                    <div id="moneyflowError" class="moneyflow-error" style="display: none;"></div>
                    <div id="moneyflowGrid" class="moneyflow-grid" style="display: none;">
                        <!-- ÂáÄÊµÅÂÖ•Ê±áÊÄª -->
                        <div class="moneyflow-summary">
                            <div class="moneyflow-summary-item">
                                <div class="moneyflow-summary-label">ÂáÄÊµÅÂÖ•Èáè</div>
                                <div id="mf_net_vol" class="moneyflow-summary-value">--</div>
                            </div>
                            <div class="moneyflow-summary-item">
                                <div class="moneyflow-summary-label">ÂáÄÊµÅÂÖ•È¢ù</div>
                                <div id="mf_net_amount" class="moneyflow-summary-value">--</div>
                            </div>
                        </div>
                        
                        <!-- ËØ¶ÁªÜËµÑÈáëÊµÅÂêë -->
                        <div class="moneyflow-details">
                            <!-- Â∞èÂçï -->
                            <div class="moneyflow-category">
                                <div class="moneyflow-category-title">Â∞èÂçïÔºà<5‰∏áÔºâ</div>
                                <div class="moneyflow-category-grid">
                                    <div class="moneyflow-item">
                                        <div class="moneyflow-label">‰π∞ÂÖ•Èáè</div>
                                        <div id="mf_buy_sm_vol" class="moneyflow-value">--</div>
                                    </div>
                                    <div class="moneyflow-item">
                                        <div class="moneyflow-label">‰π∞ÂÖ•È¢ù</div>
                                        <div id="mf_buy_sm_amount" class="moneyflow-value">--</div>
                                    </div>
                                    <div class="moneyflow-item">
                                        <div class="moneyflow-label">ÂçñÂá∫Èáè</div>
                                        <div id="mf_sell_sm_vol" class="moneyflow-value">--</div>
                                    </div>
                                    <div class="moneyflow-item">
                                        <div class="moneyflow-label">ÂçñÂá∫È¢ù</div>
                                        <div id="mf_sell_sm_amount" class="moneyflow-value">--</div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- ‰∏≠Âçï -->
                            <div class="moneyflow-category">
                                <div class="moneyflow-category-title">‰∏≠ÂçïÔºà5-20‰∏áÔºâ</div>
                                <div class="moneyflow-category-grid">
                                    <div class="moneyflow-item">
                                        <div class="moneyflow-label">‰π∞ÂÖ•Èáè</div>
                                        <div id="mf_buy_md_vol" class="moneyflow-value">--</div>
                                    </div>
                                    <div class="moneyflow-item">
                                        <div class="moneyflow-label">‰π∞ÂÖ•È¢ù</div>
                                        <div id="mf_buy_md_amount" class="moneyflow-value">--</div>
                                    </div>
                                    <div class="moneyflow-item">
                                        <div class="moneyflow-label">ÂçñÂá∫Èáè</div>
                                        <div id="mf_sell_md_vol" class="moneyflow-value">--</div>
                                    </div>
                                    <div class="moneyflow-item">
                                        <div class="moneyflow-label">ÂçñÂá∫È¢ù</div>
                                        <div id="mf_sell_md_amount" class="moneyflow-value">--</div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Â§ßÂçï -->
                            <div class="moneyflow-category">
                                <div class="moneyflow-category-title">Â§ßÂçïÔºà20-100‰∏áÔºâ</div>
                                <div class="moneyflow-category-grid">
                                    <div class="moneyflow-item">
                                        <div class="moneyflow-label">‰π∞ÂÖ•Èáè</div>
                                        <div id="mf_buy_lg_vol" class="moneyflow-value">--</div>
                                    </div>
                                    <div class="moneyflow-item">
                                        <div class="moneyflow-label">‰π∞ÂÖ•È¢ù</div>
                                        <div id="mf_buy_lg_amount" class="moneyflow-value">--</div>
                                    </div>
                                    <div class="moneyflow-item">
                                        <div class="moneyflow-label">ÂçñÂá∫Èáè</div>
                                        <div id="mf_sell_lg_vol" class="moneyflow-value">--</div>
                                    </div>
                                    <div class="moneyflow-item">
                                        <div class="moneyflow-label">ÂçñÂá∫È¢ù</div>
                                        <div id="mf_sell_lg_amount" class="moneyflow-value">--</div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- ÁâπÂ§ßÂçï -->
                            <div class="moneyflow-category">
                                <div class="moneyflow-category-title">ÁâπÂ§ßÂçïÔºà>100‰∏áÔºâ</div>
                                <div class="moneyflow-category-grid">
                                    <div class="moneyflow-item">
                                        <div class="moneyflow-label">‰π∞ÂÖ•Èáè</div>
                                        <div id="mf_buy_elg_vol" class="moneyflow-value">--</div>
                                    </div>
                                    <div class="moneyflow-item">
                                        <div class="moneyflow-label">‰π∞ÂÖ•È¢ù</div>
                                        <div id="mf_buy_elg_amount" class="moneyflow-value">--</div>
                                    </div>
                                    <div class="moneyflow-item">
                                        <div class="moneyflow-label">ÂçñÂá∫Èáè</div>
                                        <div id="mf_sell_elg_vol" class="moneyflow-value">--</div>
                                    </div>
                                    <div class="moneyflow-item">
                                        <div class="moneyflow-label">ÂçñÂá∫È¢ù</div>
                                        <div id="mf_sell_elg_amount" class="moneyflow-value">--</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ÂÆûÊó∂‰∫§ÊòìÊï∞ÊçÆÈÉ®ÂàÜ -->
            <div class="realtime-section">
                <div class="realtime-header">
                    <span>ÂÆûÊó∂‰∫§ÊòìÊï∞ÊçÆ</span>
                    <div style="display: flex; align-items: center; gap: 15px;">
                        <span id="lastRefreshTime" style="font-size: 12px; color: #6c757d;">--</span>
                        <span id="realtimeTimestamp" style="font-size: 12px; color: #6c757d;">--</span>
                        <button id="autoRefreshToggle" class="realtime-refresh-btn" onclick="toggleAutoRefresh()" style="background: #dc3545;">ÂÅúÊ≠¢Ëá™Âä®Âà∑Êñ∞</button>
                        <button id="realtimeRefreshBtn" class="realtime-refresh-btn" onclick="refreshRealtimeData()">ÊâãÂä®Âà∑Êñ∞</button>
                    </div>
                </div>
                <div id="realtimeContent">
                    <div id="realtimeLoading" class="realtime-loading" style="display: block;">
                        Ê≠£Âú®Âä†ËΩΩÂÆûÊó∂‰∫§ÊòìÊï∞ÊçÆ...
                    </div>
                    <div id="realtimeError" class="realtime-error" style="display: none;"></div>
                    <div id="realtimeGrid" class="realtime-grid" style="display: none;">
                        <!-- Á¨¨‰∏ÄË°å -->
                        <div class="realtime-item">
                            <div class="realtime-label">ÊúÄÊñ∞‰ª∑</div>
                            <div id="rt_ÊúÄÊñ∞‰ª∑" class="realtime-value">--</div>
                        </div>
                        <div class="realtime-item">
                            <div class="realtime-label">Ê∂®Ë∑åÂπÖ</div>
                            <div id="rt_Ê∂®Ë∑åÂπÖ" class="realtime-value">--</div>
                        </div>
                        <div class="realtime-item">
                            <div class="realtime-label">Ê∂®Ë∑åÈ¢ù</div>
                            <div id="rt_Ê∂®Ë∑åÈ¢ù" class="realtime-value">--</div>
                        </div>
                        <div class="realtime-item">
                            <div class="realtime-label">ÈáèÊØî</div>
                            <div id="rt_ÈáèÊØî" class="realtime-value">--</div>
                        </div>
                        <div class="realtime-item">
                            <div class="realtime-label">Êç¢ÊâãÁéá</div>
                            <div id="rt_Êç¢ÊâãÁéá" class="realtime-value">--</div>
                        </div>
                        <div class="realtime-item">
                            <div class="realtime-label">Êàê‰∫§Èáè</div>
                            <div id="rt_Êàê‰∫§Èáè" class="realtime-value">--</div>
                        </div>
                        <!-- Á¨¨‰∫åË°å -->
                        <div class="realtime-item">
                            <div class="realtime-label">Êàê‰∫§È¢ù</div>
                            <div id="rt_Êàê‰∫§È¢ù" class="realtime-value">--</div>
                        </div>
                        <div class="realtime-item">
                            <div class="realtime-label">ÊåØÂπÖ</div>
                            <div id="rt_ÊåØÂπÖ" class="realtime-value">--</div>
                        </div>
                        <div class="realtime-item">
                            <div class="realtime-label">ÊúÄÈ´ò</div>
                            <div id="rt_ÊúÄÈ´ò" class="realtime-value">--</div>
                        </div>
                        <div class="realtime-item">
                            <div class="realtime-label">ÊúÄ‰Ωé</div>
                            <div id="rt_ÊúÄ‰Ωé" class="realtime-value">--</div>
                        </div>
                        <div class="realtime-item">
                            <div class="realtime-label">‰ªäÂºÄ</div>
                            <div id="rt_‰ªäÂºÄ" class="realtime-value">--</div>
                        </div>
                        <div class="realtime-item">
                            <div class="realtime-label">Êò®Êî∂</div>
                            <div id="rt_Êò®Êî∂" class="realtime-value">--</div>
                        </div>
                        <!-- Á¨¨‰∏âË°å -->
                        <div class="realtime-item">
                            <div class="realtime-label">Â∏ÇÁõàÁéá-Âä®ÊÄÅ</div>
                            <div id="rt_Â∏ÇÁõàÁéá_Âä®ÊÄÅ" class="realtime-value">--</div>
                        </div>
                        <div class="realtime-item">
                            <div class="realtime-label">Â∏ÇÂáÄÁéá</div>
                            <div id="rt_Â∏ÇÂáÄÁéá" class="realtime-value">--</div>
                        </div>
                        <div class="realtime-item">
                            <div class="realtime-label">ÊÄªÂ∏ÇÂÄº</div>
                            <div id="rt_ÊÄªÂ∏ÇÂÄº" class="realtime-value">--</div>
                        </div>
                        <div class="realtime-item">
                            <div class="realtime-label">ÊµÅÈÄöÂ∏ÇÂÄº</div>
                            <div id="rt_ÊµÅÈÄöÂ∏ÇÂÄº" class="realtime-value">--</div>
                        </div>
                        <div class="realtime-item">
                            <div class="realtime-label">Ê∂®ÈÄü</div>
                            <div id="rt_Ê∂®ÈÄü" class="realtime-value">--</div>
                        </div>
                        <div class="realtime-item">
                            <div class="realtime-label">5ÂàÜÈíüÊ∂®Ë∑å</div>
                            <div id="rt_5ÂàÜÈíüÊ∂®Ë∑å" class="realtime-value">--</div>
                        </div>
                        <!-- Á¨¨ÂõõË°å -->
                        <div class="realtime-item">
                            <div class="realtime-label">60Êó•Ê∂®Ë∑åÂπÖ</div>
                            <div id="rt_60Êó•Ê∂®Ë∑åÂπÖ" class="realtime-value">--</div>
                        </div>
                        <div class="realtime-item">
                            <div class="realtime-label">Âπ¥ÂàùËá≥‰ªäÊ∂®Ë∑åÂπÖ</div>
                            <div id="rt_Âπ¥ÂàùËá≥‰ªäÊ∂®Ë∑åÂπÖ" class="realtime-value">--</div>
                        </div>
                        <div class="realtime-item">
                            <div class="realtime-label">ËøûÊ∂®Â§©Êï∞</div>
                            <div id="rt_ËøûÊ∂®Â§©Êï∞" class="realtime-value">--</div>
                        </div>
                        <div class="realtime-item">
                            <div class="realtime-label">Èáè‰ª∑ÈΩêÂçáÂ§©Êï∞</div>
                            <div id="rt_Èáè‰ª∑ÈΩêÂçáÂ§©Êï∞" class="realtime-value">--</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ÂàÜÊó∂ÂõæÈÉ®ÂàÜ -->
            <div class="realtime-section">
                <div class="realtime-header">
                    <span>ÂàÜÊó∂Âõæ</span>
                    <div style="display: flex; align-items: center; gap: 15px;">
                        <span id="lastChartRefreshTime" style="font-size: 12px; color: #6c757d;">--</span>
                        <span id="intradayTimestamp" style="font-size: 12px; color: #6c757d;">--</span>
                        <button id="chartAutoRefreshToggle" class="realtime-refresh-btn" onclick="toggleAutoRefresh()" style="background: #dc3545;">ÂÅúÊ≠¢Ëá™Âä®Âà∑Êñ∞</button>
                        <button id="intradayRefreshBtn" class="realtime-refresh-btn" onclick="refreshIntradayChart()">ÊâãÂä®Âà∑Êñ∞</button>
                    </div>
                </div>
                <div id="intradayContent">
                    <div id="intradayLoading" class="realtime-loading" style="display: block;">
                        Ê≠£Âú®Âä†ËΩΩÂàÜÊó∂Êï∞ÊçÆ...
                    </div>
                    <div id="intradayError" class="realtime-error" style="display: none;"></div>
                    <div id="intradayChartContainer" style="display: none;">
                        <!-- ÂàÜÊó∂Âõæ -->
                        <div id="intradayChart" style="width: 100%; height: 400px; padding: 10px;"></div>
                        <!-- ÂàÜÊó∂Êàê‰∫§ÈáèÂõæ -->
                        <div id="intradayVolumeChart" style="width: 100%; height: 150px; padding: 10px;"></div>
                    </div>
                </div>
            </div>

            <!-- KÁ∫øÂõæÂíåÊäÄÊúØÊåáÊ†áÁªÑÂêàÈÉ®ÂàÜ -->
            <div class="chart-section">
                <div class="chart-header">
                    <span>KÁ∫øÂõæ‰∏éÊäÄÊúØÊåáÊ†á</span>
                    <div class="chart-controls">
                        <button class="chart-btn" onclick="setDisplayRange(50, event)">50Ê†π</button>
                        <button class="chart-btn active" onclick="setDisplayRange(100, event)">100Ê†π</button>
                        <button class="chart-btn" onclick="setDisplayRange(200, event)">200Ê†π</button>
                        <button class="chart-btn" onclick="setDisplayRange(-1, event)">ÂÖ®ÈÉ®</button>
                        <div style="margin-left: 20px; display: flex; align-items: center; gap: 10px;">
                            <label style="display: flex; align-items: center; gap: 5px; font-size: 12px; color: #495057;">
                                <input type="checkbox" id="showBOLL" checked onchange="toggleBOLL()">
                                BOLLÊåáÊ†á
                            </label>
                        </div>
                    </div>
                </div>
                <div class="chart-container">
                    <div id="chartLoading" class="chart-loading" style="display: none;">
                        Ê≠£Âú®Âä†ËΩΩKÁ∫øÊï∞ÊçÆ...
                    </div>
                    <!-- KÁ∫øÂõæ -->
                    <div id="candlestickChart" style="width: 100%; height: 400px;"></div>
                    <!-- Êàê‰∫§ÈáèÂõæ -->
                    <div id="volumeChart" style="width: 100%; height: 150px; margin-top: 2px;"></div>
                    
                    <!-- MACDÊåáÊ†á -->
                    <div id="macdChart" style="width: 100%; height: 150px; margin-top: 5px;"></div>
                    
                    <!-- KDJÊåáÊ†á -->
                    <div id="kdjChart" style="width: 100%; height: 150px; margin-top: 5px;"></div>
                    
                    <!-- RSIÊåáÊ†á -->
                    <div id="rsiChart" style="width: 100%; height: 150px; margin-top: 5px;"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ÂÖ®Â±ÄÂèòÈáè
        let allChartData = [];
        let nineTurnData = []; // Ê∑ªÂä†Á•ûÂ•á‰πùËΩ¨Êï∞ÊçÆ
        let currentDisplayRange = 100;
        let currentStockCode = '';

        // ‰ªéURLÂèÇÊï∞Ëé∑ÂèñËÇ°Á•®‰ª£Á†Å
        function getStockCodeFromUrl() {
            // ‰ªéURLË∑ØÂæÑËé∑ÂèñËÇ°Á•®‰ª£Á†Å (‰æãÂ¶Ç: /stock/300354)
            const pathParts = window.location.pathname.split('/');
            if (pathParts.length >= 3 && pathParts[1] === 'stock') {
                return pathParts[2];
            }
            
            // Â¶ÇÊûúË∑ØÂæÑ‰∏≠Ê≤°ÊúâÔºåÂàô‰ªéURLÂèÇÊï∞Ëé∑Âèñ
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('code') || '300354';
        }

        // Ê†ºÂºèÂåñÊï∞ÂÄº
        function formatValue(value, type = 'number') {
            if (value === null || value === undefined || value === '') {
                return '--';
            }
            
            const num = parseFloat(value);
            if (isNaN(num)) return value;
            
            switch (type) {
                case 'currency':
                    return `¬•${num.toFixed(2)}`;
                case 'percentage':
                    return `${num.toFixed(2)}%`;
                case 'large_number':
                    if (num >= 100000000) {
                        return `${(num / 100000000).toFixed(2)}‰∫ø`;
                    } else if (num >= 10000) {
                        return `${(num / 10000).toFixed(2)}‰∏á`;
                    }
                    return num.toFixed(2);
                case 'ratio':
                    return num.toFixed(2);
                default:
                    return num.toFixed(2);
            }
        }

        // Ê†ºÂºèÂåñÊàê‰∫§È¢ù
        function formatAmount(value) {
            if (value === null || value === undefined || value === '') {
                return '--';
            }
            
            const num = parseFloat(value);
            if (isNaN(num)) return value;
            
            // TushareËøîÂõûÁöÑamountÂçï‰ΩçÊòØÂçÉÂÖÉÔºåÈúÄË¶ÅÂÖàËΩ¨Êç¢‰∏∫‰∏áÂÖÉ
            const amountInWan = num / 10;
            
            // Êàê‰∫§È¢ùÂçï‰ΩçËΩ¨Êç¢Ôºö‰∏áÂÖÉ -> ‰∫øÂÖÉ
            if (amountInWan >= 10000) {
                return `${(amountInWan / 10000).toFixed(2)}‰∫ø`;
            } else {
                return `${amountInWan.toFixed(2)}‰∏á`;
            }
        }

        // Ê†ºÂºèÂåñÂõæË°®Êó•ÊúüÔºàÂè™ÊòæÁ§∫ÊúàÊó•Ôºâ
        function formatChartDate(dateStr) {
            if (!dateStr) return '';
            const month = dateStr.substring(4, 6);
            const day = dateStr.substring(6, 8);
            return `${month}-${day}`;
        }

        // Ê†ºÂºèÂåñÊó•Êúü
        function formatDate(dateStr) {
            if (!dateStr) return '';
            const year = dateStr.substring(0, 4);
            const month = dateStr.substring(4, 6);
            const day = dateStr.substring(6, 8);
            return `${year}Âπ¥${month}Êúà${day}Êó•`;
        }

        // ËÆæÁΩÆÊï∞ÂÄºÈ¢úËâ≤
        function setValueColor(element, value) {
            const num = parseFloat(value);
            if (isNaN(num)) return;
            
            element.classList.remove('positive', 'negative', 'neutral');
            if (num > 0) {
                element.classList.add('positive');
            } else if (num < 0) {
                element.classList.add('negative');
            } else {
                element.classList.add('neutral');
            }
        }

        // Âä†ËΩΩËÇ°Á•®Êï∞ÊçÆ
        async function loadStockData() {
            currentStockCode = getStockCodeFromUrl();
            
            try {
                // Ëé∑ÂèñÊØèÊó•ÊåáÊ†áÊï∞ÊçÆ
                const dailyBasicResponse = await fetch(`/api/stock/${currentStockCode}/daily_basic`);
                const dailyBasicResult = await dailyBasicResponse.json();
                
                if (!dailyBasicResult.success) {
                    throw new Error(dailyBasicResult.error || 'Ëé∑ÂèñÊØèÊó•ÊåáÊ†áÊï∞ÊçÆÂ§±Ë¥•');
                }

                // Ëé∑ÂèñÂÆûÊó∂Êï∞ÊçÆ
                const realtimeResponse = await fetch(`/api/stock/${currentStockCode}/realtime`);
                const realtimeResult = await realtimeResponse.json();
                
                displayStockData(dailyBasicResult, realtimeResult);
                
                // Âä†ËΩΩËµÑÈáëÊµÅÂêëÊï∞ÊçÆ
                await loadMoneyflowData();
                
                // Âä†ËΩΩÂÆûÊó∂‰∫§ÊòìÊï∞ÊçÆ
                await loadRealtimeData();
                
                // Âä†ËΩΩÂàÜÊó∂ÂõæÊï∞ÊçÆ
                await loadIntradayChart();
                
                // Âä†ËΩΩKÁ∫øÊï∞ÊçÆ
                await loadChartData();
                
            } catch (error) {
                showError('Êï∞ÊçÆÂä†ËΩΩÂ§±Ë¥•: ' + error.message);
            }
        }

        // Âä†ËΩΩÂÆûÊó∂‰∫§ÊòìÊï∞ÊçÆ
        async function loadRealtimeData(showLoading = true) {
            try {
                // Âè™Âú®È¶ñÊ¨°Âä†ËΩΩÊàñÊâãÂä®Âà∑Êñ∞Êó∂ÊòæÁ§∫Âä†ËΩΩÁä∂ÊÄÅ
                if (showLoading) {
                    showRealtimeLoading(true);
                }
                
                const response = await fetch(`/api/stock/realtime_trading_data`);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const result = await response.json();
                
                if (!result.success) {
                    // ÊòæÁ§∫ÂêéÁ´ØËøîÂõûÁöÑÂÖ∑‰ΩìÈîôËØØ‰ø°ÊÅØ
                    const errorMsg = result.error || 'Ëé∑ÂèñÂÆûÊó∂‰∫§ÊòìÊï∞ÊçÆÂ§±Ë¥•';
                    const detailMsg = result.details ? ` (${result.details})` : '';
                    throw new Error(errorMsg + detailMsg);
                }
                
                // Ê£ÄÊü•ÊòØÂê¶ÊòØÁºìÂ≠òÊï∞ÊçÆÔºåÂ¶ÇÊûúÊòØÁºìÂ≠òÊï∞ÊçÆÔºåÂ∞ùËØï‰ΩøÁî®‰∏™ËÇ°ÂÆûÊó∂Êï∞ÊçÆAPI‰Ωú‰∏∫Â§áÁî®
                if (result.is_cached_data) {
                    console.log('Ê£ÄÊµãÂà∞ÁºìÂ≠òÊï∞ÊçÆÔºåÂ∞ùËØï‰ΩøÁî®‰∏™ËÇ°ÂÆûÊó∂Êï∞ÊçÆAPIËé∑ÂèñÊúÄÊñ∞Êï∞ÊçÆ...');
                    try {
                        await loadFallbackRealtimeData(result);
                        return;
                    } catch (fallbackError) {
                        console.warn('‰∏™ËÇ°ÂÆûÊó∂Êï∞ÊçÆAPI‰πüÂ§±Ë¥•Ôºå‰ΩøÁî®ÁºìÂ≠òÊï∞ÊçÆ:', fallbackError);
                        // ÁªßÁª≠‰ΩøÁî®ÁºìÂ≠òÊï∞ÊçÆ
                    }
                }
                
                displayRealtimeData(result.data, result);
                
            } catch (error) {
                console.error('ÂÆûÊó∂‰∫§ÊòìÊï∞ÊçÆÂä†ËΩΩÂ§±Ë¥•:', error);
                
                // Â∞ùËØï‰ΩøÁî®‰∏™ËÇ°ÂÆûÊó∂Êï∞ÊçÆAPI‰Ωú‰∏∫Â§áÁî®
                try {
                    console.log('Â∞ùËØï‰ΩøÁî®‰∏™ËÇ°ÂÆûÊó∂Êï∞ÊçÆAPI‰Ωú‰∏∫Â§áÁî®...');
                    await loadFallbackRealtimeData();
                    return;
                } catch (fallbackError) {
                    console.error('‰∏™ËÇ°ÂÆûÊó∂Êï∞ÊçÆAPI‰πüÂ§±Ë¥•:', fallbackError);
                }
                
                // Ê†πÊçÆÈîôËØØÁ±ªÂûãÊòæÁ§∫‰∏çÂêåÁöÑÈîôËØØ‰ø°ÊÅØ
                let errorMessage = 'ÂÆûÊó∂‰∫§ÊòìÊï∞ÊçÆÂä†ËΩΩÂ§±Ë¥•';
                
                if (error.message.includes('ÁΩëÁªúËøûÊé•')) {
                    errorMessage = 'ÁΩëÁªúËøûÊé•Â§±Ë¥•ÔºåËØ∑Ê£ÄÊü•ÁΩëÁªúËøûÊé•ÂêéÈáçËØï';
                } else if (error.message.includes('‰ª£ÁêÜËøûÊé•')) {
                    errorMessage = '‰ª£ÁêÜËøûÊé•Â§±Ë¥•ÔºåËØ∑Ê£ÄÊü•ÁΩëÁªúËÆæÁΩÆ';
                } else if (error.message.includes('AkShare')) {
                    errorMessage = 'AkShareÊúçÂä°ÊöÇÊó∂‰∏çÂèØÁî®ÔºåËØ∑Á®çÂêéÈáçËØï';
                } else if (error.message.includes('APIË∞ÉÁî®Â§±Ë¥•')) {
                    errorMessage = 'APIË∞ÉÁî®Â§±Ë¥•ÔºåËØ∑Á®çÂêéÈáçËØï';
                } else if (error.message.includes('HTTP')) {
                    errorMessage = `ÊúçÂä°Âô®ÈîôËØØ: ${error.message}`;
                } else {
                    errorMessage = error.message || 'Êú™Áü•ÈîôËØØÔºåËØ∑Á®çÂêéÈáçËØï';
                }
                
                // Âè™Âú®ÊòæÁ§∫Âä†ËΩΩÁä∂ÊÄÅÊó∂ÊâçÊòæÁ§∫ÈîôËØØÔºåÈÅøÂÖçËá™Âä®Âà∑Êñ∞Êó∂Ë¶ÜÁõñÁé∞ÊúâÊï∞ÊçÆ
                if (showLoading) {
                    showRealtimeError(errorMessage);
                }
            } finally {
                if (showLoading) {
                    showRealtimeLoading(false);
                }
            }
        }

        // ‰ΩøÁî®‰∏™ËÇ°ÂÆûÊó∂Êï∞ÊçÆAPI‰Ωú‰∏∫Â§áÁî®Êï∞ÊçÆÊ∫ê
        async function loadFallbackRealtimeData(originalResult = null) {
            const realtimeResponse = await fetch(`/api/stock/${currentStockCode}/realtime`);
            
            if (!realtimeResponse.ok) {
                throw new Error(`‰∏™ËÇ°ÂÆûÊó∂Êï∞ÊçÆAPI HTTP ${realtimeResponse.status}: ${realtimeResponse.statusText}`);
            }
            
            const realtimeResult = await realtimeResponse.json();
            
            if (!realtimeResult.success) {
                throw new Error(realtimeResult.error || 'Ëé∑Âèñ‰∏™ËÇ°ÂÆûÊó∂Êï∞ÊçÆÂ§±Ë¥•');
            }
            
            // Â∞Ü‰∏™ËÇ°ÂÆûÊó∂Êï∞ÊçÆËΩ¨Êç¢‰∏∫ÂÆûÊó∂‰∫§ÊòìÊï∞ÊçÆÊ†ºÂºè
            const spotData = realtimeResult.spot;
            if (!spotData) {
                throw new Error('‰∏™ËÇ°ÂÆûÊó∂Êï∞ÊçÆ‰∏≠Áº∫Â∞ëspotÊï∞ÊçÆ');
            }
            
            const convertedData = [{
                'Â∫èÂè∑': 1,
                '‰ª£Á†Å': currentStockCode,
                'ÂêçÁß∞': spotData.name || '',
                'ÊúÄÊñ∞‰ª∑': spotData.latest_price || 0,
                'Ê∂®Ë∑åÂπÖ': spotData.change_percent || 0,
                'Ê∂®Ë∑åÈ¢ù': spotData.change_amount || 0,
                'Êàê‰∫§Èáè': spotData.volume || 0,
                'Êàê‰∫§È¢ù': spotData.amount || 0,
                'ÊåØÂπÖ': 0, // ‰∏™ËÇ°API‰∏≠Ê≤°ÊúâËøô‰∏™Â≠óÊÆµ
                'ÊúÄÈ´ò': spotData.high || 0,
                'ÊúÄ‰Ωé': spotData.low || 0,
                '‰ªäÂºÄ': spotData.open || 0,
                'Êò®Êî∂': spotData.pre_close || 0,
                'ÈáèÊØî': spotData.volume_ratio || 0,
                'Êç¢ÊâãÁéá': spotData.turnover_rate || 0,
                'Â∏ÇÁõàÁéá-Âä®ÊÄÅ': spotData.pe_ratio || 0,
                'Â∏ÇÂáÄÁéá': 0, // ‰∏™ËÇ°API‰∏≠Ê≤°ÊúâËøô‰∏™Â≠óÊÆµ
                'ÊÄªÂ∏ÇÂÄº': spotData.market_cap || 0,
                'ÊµÅÈÄöÂ∏ÇÂÄº': 0, // ‰∏™ËÇ°API‰∏≠Ê≤°ÊúâËøô‰∏™Â≠óÊÆµ
                'Ê∂®ÈÄü': 0, // ‰∏™ËÇ°API‰∏≠Ê≤°ÊúâËøô‰∏™Â≠óÊÆµ
                '5ÂàÜÈíüÊ∂®Ë∑å': 0, // ‰∏™ËÇ°API‰∏≠Ê≤°ÊúâËøô‰∏™Â≠óÊÆµ
                '60Êó•Ê∂®Ë∑åÂπÖ': 0, // ‰∏™ËÇ°API‰∏≠Ê≤°ÊúâËøô‰∏™Â≠óÊÆµ
                'Âπ¥ÂàùËá≥‰ªäÊ∂®Ë∑åÂπÖ': 0, // ‰∏™ËÇ°API‰∏≠Ê≤°ÊúâËøô‰∏™Â≠óÊÆµ
                'ËøûÊ∂®Â§©Êï∞': 0, // ‰∏™ËÇ°API‰∏≠Ê≤°ÊúâËøô‰∏™Â≠óÊÆµ
                'Èáè‰ª∑ÈΩêÂçáÂ§©Êï∞': 0 // ‰∏™ËÇ°API‰∏≠Ê≤°ÊúâËøô‰∏™Â≠óÊÆµ
            }];
            
            const fallbackResult = {
                success: true,
                data: convertedData,
                total_records: 1,
                fetch_time: new Date().toLocaleString('zh-CN'),
                data_source: '‰∏™ËÇ°ÂÆûÊó∂Êï∞ÊçÆAPI (Â§áÁî®)',
                message: originalResult ? 'ÂÖ®Â∏ÇÂú∫Êï∞ÊçÆ‰ΩøÁî®ÁºìÂ≠òÔºå‰∏™ËÇ°Êï∞ÊçÆÂ∑≤Êõ¥Êñ∞' : '‰ΩøÁî®‰∏™ËÇ°ÂÆûÊó∂Êï∞ÊçÆAPI',
                is_cached_data: false
            };
            
            console.log('ÊàêÂäü‰ΩøÁî®‰∏™ËÇ°ÂÆûÊó∂Êï∞ÊçÆAPIËé∑ÂèñÊúÄÊñ∞Êï∞ÊçÆ');
            displayRealtimeData(fallbackResult.data, fallbackResult);
        }

        // Âà∑Êñ∞ÂÆûÊó∂‰∫§ÊòìÊï∞ÊçÆ
        async function refreshRealtimeData() {
            const refreshBtn = document.getElementById('realtimeRefreshBtn');
            refreshBtn.disabled = true;
            refreshBtn.textContent = 'Âà∑Êñ∞‰∏≠...';
            
            try {
                await loadRealtimeData();
            } finally {
                refreshBtn.disabled = false;
                refreshBtn.textContent = 'Âà∑Êñ∞';
            }
        }

        // ÊòæÁ§∫ÂÆûÊó∂‰∫§ÊòìÊï∞ÊçÆ
        function displayRealtimeData(data, result = null) {
            if (!data || data.length === 0) {
                showRealtimeError('ÊöÇÊó†ÂÆûÊó∂‰∫§ÊòìÊï∞ÊçÆ');
                return;
            }

            // ÊâæÂà∞ÂΩìÂâçËÇ°Á•®ÁöÑÊï∞ÊçÆ
            const stockData = data.find(item => {
                const code = item['‰ª£Á†Å'];
                return code && (code === currentStockCode || code === currentStockCode.substring(0, 6));
            });

            if (!stockData) {
                showRealtimeError('Êú™ÊâæÂà∞ÂΩìÂâçËÇ°Á•®ÁöÑÂÆûÊó∂‰∫§ÊòìÊï∞ÊçÆ');
                return;
            }

            // ÊòæÁ§∫Êï∞ÊçÆ
            const fieldMapping = {
                'Â∫èÂè∑': 'Â∫èÂè∑',
                '‰ª£Á†Å': '‰ª£Á†Å', 
                'ÂêçÁß∞': 'ÂêçÁß∞',
                'ÊúÄÊñ∞‰ª∑': 'ÊúÄÊñ∞‰ª∑',
                'Ê∂®Ë∑åÂπÖ': 'Ê∂®Ë∑åÂπÖ',
                'Ê∂®Ë∑åÈ¢ù': 'Ê∂®Ë∑åÈ¢ù',
                'Êàê‰∫§Èáè': 'Êàê‰∫§Èáè',
                'Êàê‰∫§È¢ù': 'Êàê‰∫§È¢ù',
                'ÊåØÂπÖ': 'ÊåØÂπÖ',
                'ÊúÄÈ´ò': 'ÊúÄÈ´ò',
                'ÊúÄ‰Ωé': 'ÊúÄ‰Ωé',
                '‰ªäÂºÄ': '‰ªäÂºÄ',
                'Êò®Êî∂': 'Êò®Êî∂',
                'ÈáèÊØî': 'ÈáèÊØî',
                'Êç¢ÊâãÁéá': 'Êç¢ÊâãÁéá',
                'Â∏ÇÁõàÁéá-Âä®ÊÄÅ': 'Â∏ÇÁõàÁéá-Âä®ÊÄÅ',
                'Â∏ÇÂáÄÁéá': 'Â∏ÇÂáÄÁéá',
                'ÊÄªÂ∏ÇÂÄº': 'ÊÄªÂ∏ÇÂÄº',
                'ÊµÅÈÄöÂ∏ÇÂÄº': 'ÊµÅÈÄöÂ∏ÇÂÄº',
                'Ê∂®ÈÄü': 'Ê∂®ÈÄü',
                '5ÂàÜÈíüÊ∂®Ë∑å': '5ÂàÜÈíüÊ∂®Ë∑å',
                '60Êó•Ê∂®Ë∑åÂπÖ': '60Êó•Ê∂®Ë∑åÂπÖ',
                'Âπ¥ÂàùËá≥‰ªäÊ∂®Ë∑åÂπÖ': 'Âπ¥ÂàùËá≥‰ªäÊ∂®Ë∑åÂπÖ',
                'ËøûÊ∂®Â§©Êï∞': 'ËøûÊ∂®Â§©Êï∞',
                'Èáè‰ª∑ÈΩêÂçáÂ§©Êï∞': 'Èáè‰ª∑ÈΩêÂçáÂ§©Êï∞'
            };

            Object.entries(fieldMapping).forEach(([field, key]) => {
                const element = document.getElementById(`rt_${field}`);
                if (element && stockData[key] !== undefined) {
                    let value = stockData[key];
                    
                    // Ê†ºÂºèÂåñÊï∞ÂÄº
                    if (field === 'ÊúÄÊñ∞‰ª∑' || field === 'Ê∂®Ë∑åÈ¢ù' || field === 'ÊúÄÈ´ò' || field === 'ÊúÄ‰Ωé' || field === '‰ªäÂºÄ' || field === 'Êò®Êî∂') {
                        value = formatRealtimeValue(value, 'currency');
                    } else if (field === 'Ê∂®Ë∑åÂπÖ' || field === 'ÊåØÂπÖ' || field === 'Êç¢ÊâãÁéá' || field === 'Ê∂®ÈÄü' || field === '5ÂàÜÈíüÊ∂®Ë∑å' || field === '60Êó•Ê∂®Ë∑åÂπÖ' || field === 'Âπ¥ÂàùËá≥‰ªäÊ∂®Ë∑åÂπÖ') {
                        value = formatRealtimeValue(value, 'percentage');
                    } else if (field === 'Êàê‰∫§Èáè') {
                        value = formatRealtimeValue(value, 'volume');
                    } else if (field === 'Êàê‰∫§È¢ù' || field === 'ÊÄªÂ∏ÇÂÄº' || field === 'ÊµÅÈÄöÂ∏ÇÂÄº') {
                        value = formatRealtimeValue(value, 'amount');
                    } else if (field === 'ËøûÊ∂®Â§©Êï∞' || field === 'Èáè‰ª∑ÈΩêÂçáÂ§©Êï∞') {
                        value = formatRealtimeValue(value, 'days');
                    } else {
                        value = formatRealtimeValue(value, 'number');
                    }
                    
                    element.textContent = value;
                    
                    // ËÆæÁΩÆÈ¢úËâ≤
                    if (field === 'ÊúÄÊñ∞‰ª∑') {
                        // ÊúÄÊñ∞‰ª∑Ê†πÊçÆÊ∂®Ë∑åÂπÖÊù•ËÆæÁΩÆÈ¢úËâ≤
                        setRealtimeValueColor(element, stockData['Ê∂®Ë∑åÂπÖ'], field);
                    } else if (field === 'Ê∂®Ë∑åÂπÖ' || field === 'Ê∂®Ë∑åÈ¢ù' || field === 'Ê∂®ÈÄü' || field === '5ÂàÜÈíüÊ∂®Ë∑å' || field === '60Êó•Ê∂®Ë∑åÂπÖ' || field === 'Âπ¥ÂàùËá≥‰ªäÊ∂®Ë∑åÂπÖ') {
                        setRealtimeValueColor(element, stockData[key], field);
                    } else if (field === 'ËøûÊ∂®Â§©Êï∞' || field === 'Èáè‰ª∑ÈΩêÂçáÂ§©Êï∞') {
                        setRealtimeValueColor(element, stockData[key], field);
                    }
                }
            });

            // ÊòæÁ§∫Êï∞ÊçÆÁΩëÊ†º
            document.getElementById('realtimeGrid').style.display = 'grid';
            document.getElementById('realtimeError').style.display = 'none';
            
            // Êõ¥Êñ∞Êó∂Èó¥Êà≥ÔºåÂ¶ÇÊûúÊòØÊúÄÂêé‰∫§ÊòìÊó•Êï∞ÊçÆÔºåÊòæÁ§∫ÁâπÊÆäÊèêÁ§∫
            updateRealtimeTimestamp(result);
            
            // ‰ΩøÁî®ÂÆûÊó∂‰∫§ÊòìÊï∞ÊçÆÊõ¥Êñ∞ÊØèÊó•ÊåáÊ†á
            updateDailyIndicatorsFromRealtimeData(data);
            
            // Êõ¥Êñ∞Á∫¢Ê°Ü‰∏≠ÁöÑËÇ°Á•®‰ª∑Ê†ºÔºà‰ΩøÁî®ÊúÄÊñ∞‰ª∑Ôºâ
            updateStockPriceDisplay(stockData);
        }

        // Êõ¥Êñ∞Á∫¢Ê°Ü‰∏≠ÁöÑËÇ°Á•®‰ª∑Ê†ºÊòæÁ§∫
        function updateStockPriceDisplay(stockData) {
            if (!stockData) return;
            
            // Êõ¥Êñ∞ÊúÄÊñ∞‰ª∑Ê†º
            const stockPriceElement = document.getElementById('stockPrice');
            if (stockData['ÊúÄÊñ∞‰ª∑'] && stockPriceElement) {
                const latestPrice = stockData['ÊúÄÊñ∞‰ª∑'];
                stockPriceElement.textContent = formatValue(latestPrice, 'currency');
                console.log(`[Á∫¢Ê°Ü‰ª∑Ê†º] Êõ¥Êñ∞ÊúÄÊñ∞‰ª∑Ê†º: ${latestPrice}`);
            }
            
            // Êõ¥Êñ∞Ê∂®Ë∑åÈ¢ùÂíåÊ∂®Ë∑åÂπÖ
            const changeAmountElement = document.getElementById('changeAmount');
            const changePctElement = document.getElementById('changePercent');
            
            if (stockData['Ê∂®Ë∑åÈ¢ù'] && changeAmountElement) {
                const changeAmount = stockData['Ê∂®Ë∑åÈ¢ù'];
                changeAmountElement.textContent = (changeAmount >= 0 ? '+' : '') + formatValue(changeAmount);
                setValueColor(changeAmountElement, changeAmount);
                console.log(`[Á∫¢Ê°Ü‰ª∑Ê†º] Êõ¥Êñ∞Ê∂®Ë∑åÈ¢ù: ${changeAmount}`);
            }
            
            if (stockData['Ê∂®Ë∑åÂπÖ'] && changePctElement) {
                const changePct = stockData['Ê∂®Ë∑åÂπÖ'];
                changePctElement.textContent = (changePct >= 0 ? '+' : '') + formatValue(changePct, 'percentage');
                setValueColor(changePctElement, changePct);
                console.log(`[Á∫¢Ê°Ü‰ª∑Ê†º] Êõ¥Êñ∞Ê∂®Ë∑åÂπÖ: ${changePct}%`);
            }
            
            // Êõ¥Êñ∞‰ªäÂºÄ‰ª∑Ê†º
            const openElement = document.getElementById('open');
            if (stockData['‰ªäÂºÄ'] && openElement) {
                openElement.textContent = formatValue(stockData['‰ªäÂºÄ'], 'currency');
            }
            
            // Êõ¥Êñ∞Ê∂®Ë∑åÂπÖÊòæÁ§∫ÔºàÈ°µÈù¢Âè≥‰æßÁöÑÊ∂®Ë∑åÂπÖÔºâ
            const pctChgElement = document.getElementById('pctChg');
            if (stockData['Ê∂®Ë∑åÂπÖ'] && pctChgElement) {
                const changePct = stockData['Ê∂®Ë∑åÂπÖ'];
                pctChgElement.textContent = formatValue(changePct, 'percentage');
                setValueColor(pctChgElement, changePct);
            }
        }

        // Ê†ºÂºèÂåñÂÆûÊó∂Êï∞ÊçÆÂÄº
        function formatRealtimeValue(value, type = 'number') {
            if (value === null || value === undefined || value === '' || value === '-') {
                return '--';
            }
            
            const num = parseFloat(value);
            if (isNaN(num)) return value;
            
            switch (type) {
                case 'currency':
                    return `¬•${num.toFixed(2)}`;
                case 'percentage':
                    return `${num.toFixed(2)}%`;
                case 'volume':
                    if (num >= 100000000) {
                        return `${(num / 100000000).toFixed(2)}‰∫øÊâã`;
                    } else if (num >= 10000) {
                        return `${(num / 10000).toFixed(2)}‰∏áÊâã`;
                    }
                    return `${num.toFixed(0)}Êâã`;
                case 'amount':
                    if (num >= 100000000) {
                        return `${(num / 100000000).toFixed(2)}‰∫ø`;
                    } else if (num >= 10000) {
                        return `${(num / 10000).toFixed(2)}‰∏á`;
                    }
                    return num.toFixed(2);
                case 'days':
                    return `${Math.floor(num)}Â§©`;
                case 'number':
                default:
                    return num.toFixed(2);
            }
        }

        // ËÆæÁΩÆÂÆûÊó∂Êï∞ÊçÆÂÄºÈ¢úËâ≤
        function setRealtimeValueColor(element, value, field) {
            // Ê∂®Ë∑åÁõ∏ÂÖ≥Â≠óÊÆµ‰ΩøÁî®Á∫¢Ê∂®ÁªøË∑å
            const changeFields = ['Ê∂®Ë∑åÂπÖ', 'Ê∂®Ë∑åÈ¢ù', 'Ê∂®ÈÄü', '5ÂàÜÈíüÊ∂®Ë∑å', '60Êó•Ê∂®Ë∑åÂπÖ', 'Âπ¥ÂàùËá≥‰ªäÊ∂®Ë∑åÂπÖ'];
            
            if (changeFields.includes(field) || field === 'ÊúÄÊñ∞‰ª∑') {
                const numValue = parseFloat(value);
                if (!isNaN(numValue)) {
                    element.classList.remove('positive', 'negative', 'neutral');
                    if (numValue > 0) {
                        element.classList.add('positive');
                        element.style.color = '#ff4444'; // Á∫¢Ëâ≤
                    } else if (numValue < 0) {
                        element.classList.add('negative');
                        element.style.color = '#00aa00'; // ÁªøËâ≤
                    } else {
                        element.classList.add('neutral');
                        element.style.color = '#666'; // ÁÅ∞Ëâ≤
                    }
                } else {
                    element.style.color = '#333'; // ÈªòËÆ§È¢úËâ≤
                }
            } else if (field === 'ËøûÊ∂®Â§©Êï∞' || field === 'Èáè‰ª∑ÈΩêÂçáÂ§©Êï∞') {
                const numValue = parseFloat(value);
                if (!isNaN(numValue)) {
                    element.classList.remove('positive', 'negative', 'neutral');
                    if (numValue > 0) {
                        element.classList.add('positive');
                        element.style.color = '#ff4444'; // Á∫¢Ëâ≤ÔºåË°®Á§∫ËøûÁª≠‰∏äÊ∂®ÊàñÈáè‰ª∑ÈΩêÂçá
                    } else {
                        element.classList.add('neutral');
                        element.style.color = '#666'; // ÁÅ∞Ëâ≤ÔºåË°®Á§∫Ê≤°ÊúâËøûÊ∂®ÊàñÈáè‰ª∑ÈΩêÂçá
                    }
                } else {
                    element.style.color = '#333'; // ÈªòËÆ§È¢úËâ≤
                }
            } else {
                // ÂÖ∂‰ªñÂ≠óÊÆµ‰ΩøÁî®ÈªòËÆ§È¢úËâ≤
                element.style.color = '#333';
            }
        }

        // ÊòæÁ§∫ÂÆûÊó∂Êï∞ÊçÆÂä†ËΩΩÁä∂ÊÄÅ
        function showRealtimeLoading(show) {
            document.getElementById('realtimeLoading').style.display = show ? 'block' : 'none';
            document.getElementById('realtimeGrid').style.display = show ? 'none' : 'grid';
            document.getElementById('realtimeError').style.display = 'none';
        }

        // ÊòæÁ§∫ÂÆûÊó∂Êï∞ÊçÆÈîôËØØ
        function showRealtimeError(message) {
            document.getElementById('realtimeError').textContent = message;
            document.getElementById('realtimeError').style.display = 'block';
            document.getElementById('realtimeLoading').style.display = 'none';
            document.getElementById('realtimeGrid').style.display = 'none';
        }

        // Êõ¥Êñ∞ÂÆûÊó∂Êï∞ÊçÆÊó∂Èó¥Êà≥
        function updateRealtimeTimestamp(result = null) {
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            const seconds = String(now.getSeconds()).padStart(2, '0');
            
            const timestamp = `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
            
            // Ê£ÄÊü•ÊòØÂê¶ÊòØÊúÄÂêé‰∫§ÊòìÊó•Êï∞ÊçÆ
            if (result && result.is_last_trading_day) {
                document.getElementById('realtimeTimestamp').innerHTML = 
                    `<span style="color: #ff6600;">üìÖ Èùû‰∫§ÊòìÊó∂Èó¥ÔºåÊòæÁ§∫ÊúÄÂêé‰∫§ÊòìÊó•(2025-07-25)Êî∂ÁõòÊï∞ÊçÆ</span><br>Êõ¥Êñ∞Êó∂Èó¥: ${timestamp}`;
            } else {
                document.getElementById('realtimeTimestamp').textContent = `Êõ¥Êñ∞Êó∂Èó¥: ${timestamp}`;
            }
        }

        // Âä†ËΩΩËµÑÈáëÊµÅÂêëÊï∞ÊçÆ
        async function loadMoneyflowData(showLoading = true) {
            try {
                if (showLoading) {
                    showMoneyflowLoading(true);
                }
                
                const response = await fetch(`/api/stock/${currentStockCode}/moneyflow`);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const result = await response.json();
                
                if (!result.success) {
                    throw new Error(result.error || 'Ëé∑ÂèñËµÑÈáëÊµÅÂêëÊï∞ÊçÆÂ§±Ë¥•');
                }
                
                displayMoneyflowData(result.data, result);
                
            } catch (error) {
                console.error('ËµÑÈáëÊµÅÂêëÊï∞ÊçÆÂä†ËΩΩÂ§±Ë¥•:', error);
                
                let errorMessage = 'ËµÑÈáëÊµÅÂêëÊï∞ÊçÆÂä†ËΩΩÂ§±Ë¥•';
                if (error.message.includes('HTTP')) {
                    errorMessage = `ÊúçÂä°Âô®ÈîôËØØ: ${error.message}`;
                } else {
                    errorMessage = error.message || 'Êú™Áü•ÈîôËØØÔºåËØ∑Á®çÂêéÈáçËØï';
                }
                
                if (showLoading) {
                    showMoneyflowError(errorMessage);
                }
            } finally {
                if (showLoading) {
                    showMoneyflowLoading(false);
                }
            }
        }

        // Âà∑Êñ∞ËµÑÈáëÊµÅÂêëÊï∞ÊçÆ
        async function refreshMoneyflowData() {
            const refreshBtn = document.getElementById('moneyflowRefreshBtn');
            refreshBtn.disabled = true;
            refreshBtn.textContent = 'Âà∑Êñ∞‰∏≠...';
            
            try {
                await loadMoneyflowData();
            } finally {
                refreshBtn.disabled = false;
                refreshBtn.textContent = 'Âà∑Êñ∞';
            }
        }

        // ÊòæÁ§∫ËµÑÈáëÊµÅÂêëÊï∞ÊçÆ
        function displayMoneyflowData(data, result = null) {
            if (!data || data.length === 0) {
                showMoneyflowError('ÊöÇÊó†ËµÑÈáëÊµÅÂêëÊï∞ÊçÆ');
                return;
            }

            // Ëé∑ÂèñÊúÄÊñ∞ÁöÑËµÑÈáëÊµÅÂêëÊï∞ÊçÆÔºàÈÄöÂ∏∏ÊòØÁ¨¨‰∏ÄÊù°Ôºâ
            const moneyflowData = data[0];

            // ÊòæÁ§∫ÂáÄÊµÅÂÖ•Ê±áÊÄª
            document.getElementById('mf_net_vol').textContent = formatMoneyflowValue(moneyflowData.net_mf_vol, 'volume');
            document.getElementById('mf_net_amount').textContent = formatMoneyflowValue(moneyflowData.net_mf_amount, 'amount');
            
            // ËÆæÁΩÆÂáÄÊµÅÂÖ•È¢ùÁöÑÈ¢úËâ≤
            const netAmountElement = document.getElementById('mf_net_amount');
            setMoneyflowValueColor(netAmountElement, moneyflowData.net_mf_amount);

            // ÊòæÁ§∫ËØ¶ÁªÜËµÑÈáëÊµÅÂêëÊï∞ÊçÆ
            const fields = [
                // Â∞èÂçï
                { id: 'mf_buy_sm_vol', value: moneyflowData.buy_sm_vol, type: 'volume' },
                { id: 'mf_buy_sm_amount', value: moneyflowData.buy_sm_amount, type: 'amount' },
                { id: 'mf_sell_sm_vol', value: moneyflowData.sell_sm_vol, type: 'volume' },
                { id: 'mf_sell_sm_amount', value: moneyflowData.sell_sm_amount, type: 'amount' },
                // ‰∏≠Âçï
                { id: 'mf_buy_md_vol', value: moneyflowData.buy_md_vol, type: 'volume' },
                { id: 'mf_buy_md_amount', value: moneyflowData.buy_md_amount, type: 'amount' },
                { id: 'mf_sell_md_vol', value: moneyflowData.sell_md_vol, type: 'volume' },
                { id: 'mf_sell_md_amount', value: moneyflowData.sell_md_amount, type: 'amount' },
                // Â§ßÂçï
                { id: 'mf_buy_lg_vol', value: moneyflowData.buy_lg_vol, type: 'volume' },
                { id: 'mf_buy_lg_amount', value: moneyflowData.buy_lg_amount, type: 'amount' },
                { id: 'mf_sell_lg_vol', value: moneyflowData.sell_lg_vol, type: 'volume' },
                { id: 'mf_sell_lg_amount', value: moneyflowData.sell_lg_amount, type: 'amount' },
                // ÁâπÂ§ßÂçï
                { id: 'mf_buy_elg_vol', value: moneyflowData.buy_elg_vol, type: 'volume' },
                { id: 'mf_buy_elg_amount', value: moneyflowData.buy_elg_amount, type: 'amount' },
                { id: 'mf_sell_elg_vol', value: moneyflowData.sell_elg_vol, type: 'volume' },
                { id: 'mf_sell_elg_amount', value: moneyflowData.sell_elg_amount, type: 'amount' }
            ];

            fields.forEach(field => {
                const element = document.getElementById(field.id);
                if (element) {
                    element.textContent = formatMoneyflowValue(field.value, field.type);
                }
            });

            // ÊòæÁ§∫Êï∞ÊçÆÁΩëÊ†º
            document.getElementById('moneyflowGrid').style.display = 'block';
            document.getElementById('moneyflowError').style.display = 'none';
            
            // Êõ¥Êñ∞Êó∂Èó¥Êà≥
            updateMoneyflowTimestamp(result);
        }

        // Ê†ºÂºèÂåñËµÑÈáëÊµÅÂêëÊï∞ÂÄº
        function formatMoneyflowValue(value, type = 'number') {
            if (value === null || value === undefined || value === '' || value === 0) {
                return '--';
            }
            
            const num = parseFloat(value);
            if (isNaN(num)) return value;
            
            switch (type) {
                case 'volume':
                    if (Math.abs(num) >= 100000000) {
                        return `${(num / 100000000).toFixed(2)}‰∫øÊâã`;
                    } else if (Math.abs(num) >= 10000) {
                        return `${(num / 10000).toFixed(2)}‰∏áÊâã`;
                    }
                    return `${num.toFixed(0)}Êâã`;
                case 'amount':
                    if (Math.abs(num) >= 100000000) {
                        return `${(num / 100000000).toFixed(2)}‰∫øÂÖÉ`;
                    } else if (Math.abs(num) >= 10000) {
                        return `${(num / 10000).toFixed(2)}‰∏áÂÖÉ`;
                    }
                    return `${num.toFixed(2)}ÂÖÉ`;
                case 'number':
                default:
                    return num.toFixed(2);
            }
        }

        // ËÆæÁΩÆËµÑÈáëÊµÅÂêëÊï∞ÂÄºÈ¢úËâ≤
        function setMoneyflowValueColor(element, value) {
            const numValue = parseFloat(value);
            if (!isNaN(numValue)) {
                element.classList.remove('positive', 'negative', 'neutral');
                if (numValue > 0) {
                    element.classList.add('positive');
                    element.style.color = '#ff4444'; // Á∫¢Ëâ≤ÔºåË°®Á§∫ÂáÄÊµÅÂÖ•
                } else if (numValue < 0) {
                    element.classList.add('negative');
                    element.style.color = '#00aa00'; // ÁªøËâ≤ÔºåË°®Á§∫ÂáÄÊµÅÂá∫
                } else {
                    element.classList.add('neutral');
                    element.style.color = '#666'; // ÁÅ∞Ëâ≤ÔºåË°®Á§∫Âπ≥Ë°°
                }
            } else {
                element.style.color = '#333'; // ÈªòËÆ§È¢úËâ≤
            }
        }

        // ÊòæÁ§∫ËµÑÈáëÊµÅÂêëÂä†ËΩΩÁä∂ÊÄÅ
        function showMoneyflowLoading(show) {
            document.getElementById('moneyflowLoading').style.display = show ? 'block' : 'none';
            document.getElementById('moneyflowGrid').style.display = show ? 'none' : 'block';
            document.getElementById('moneyflowError').style.display = 'none';
        }

        // ÊòæÁ§∫ËµÑÈáëÊµÅÂêëÈîôËØØ
        function showMoneyflowError(message) {
            document.getElementById('moneyflowError').textContent = message;
            document.getElementById('moneyflowError').style.display = 'block';
            document.getElementById('moneyflowLoading').style.display = 'none';
            document.getElementById('moneyflowGrid').style.display = 'none';
        }

        // Êõ¥Êñ∞ËµÑÈáëÊµÅÂêëÊó∂Èó¥Êà≥
        function updateMoneyflowTimestamp(result = null) {
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            const seconds = String(now.getSeconds()).padStart(2, '0');
            
            const timestamp = `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
            
            let displayText = `Êõ¥Êñ∞Êó∂Èó¥: ${timestamp}`;
            if (result && result.stock_info && result.stock_info.trade_date) {
                displayText = `‰∫§ÊòìÊó•Êúü: ${result.stock_info.trade_date} | ${displayText}`;
            }
            
            document.getElementById('moneyflowTimestamp').textContent = displayText;
        }

        // Âä†ËΩΩKÁ∫øÊï∞ÊçÆ
        async function loadChartData() {
            try {
                showChartLoading(true);
                
                // Âπ∂Ë°åËé∑ÂèñKÁ∫øÊï∞ÊçÆÂíåÁ•ûÂ•á‰πùËΩ¨Êï∞ÊçÆ
                const [historyResponse, nineTurnResponse] = await Promise.all([
                    fetch(`/api/stock/${currentStockCode}/daily_history?days=200`),
                    fetch(`/api/stock/${currentStockCode}/nine_turn?days=200&freq=daily`)
                ]);
                
                const historyResult = await historyResponse.json();
                const nineTurnResult = await nineTurnResponse.json();
                
                if (!historyResult.success) {
                    throw new Error(historyResult.error || 'Ëé∑ÂèñKÁ∫øÊï∞ÊçÆÂ§±Ë¥•');
                }
                
                allChartData = historyResult.data;
                
                // Â§ÑÁêÜÁ•ûÂ•á‰πùËΩ¨Êï∞ÊçÆ
                if (nineTurnResult.success && nineTurnResult.data) {
                    nineTurnData = nineTurnResult.data;
                    console.log(`[Á•ûÂ•á‰πùËΩ¨] ÊàêÂäüËé∑Âèñ${nineTurnData.length}Êù°Êï∞ÊçÆÔºå‰∏ä‰πùËΩ¨‰ø°Âè∑: ${nineTurnResult.stock_info.up_signals}‰∏™Ôºå‰∏ã‰πùËΩ¨‰ø°Âè∑: ${nineTurnResult.stock_info.down_signals}‰∏™`);
                } else {
                    nineTurnData = [];
                    console.log('[Á•ûÂ•á‰πùËΩ¨] ÊöÇÊó†Êï∞ÊçÆÊàñËé∑ÂèñÂ§±Ë¥•');
                }
                
                // Ê≥®ÈáäÊéâKÁ∫øÂõæhoverÁöÑÊØèÊó•ÊåáÊ†áÊï∞ÊçÆËé∑ÂèñÔºåÂè™Âú®È°µÈù¢È°∂ÈÉ®ÊòæÁ§∫Ââç‰∏Ä‰∫§ÊòìÊó•ÁöÑÊØèÊó•ÊåáÊ†á
                // await loadDailyBasicDataForChart();
                
                createCandlestickChart();
                
            } catch (error) {
                console.error('Êï∞ÊçÆÂä†ËΩΩÂ§±Ë¥•:', error);
            } finally {
                showChartLoading(false);
            }
        }

        // Ëé∑ÂèñÊØèÊó•ÊåáÊ†áÊï∞ÊçÆÁî®‰∫éKÁ∫øÂõæ
        async function loadDailyBasicDataForChart() {
            try {
                // ‰∏∫ÊØè‰∏™‰∫§ÊòìÊó•Ëé∑Âèñdaily_basicÊï∞ÊçÆ
                const dailyBasicPromises = allChartData.map(async (item) => {
                    try {
                        const response = await fetch(`/api/stock/${currentStockCode}/daily_basic?trade_date=${item.trade_date.replace(/-/g, '')}`);
                        const result = await response.json();
                        if (result.success) {
                            return {
                                trade_date: item.trade_date,
                                ...result.data
                            };
                        }
                        return null;
                    } catch (error) {
                        console.warn(`Ëé∑Âèñ${item.trade_date}ÁöÑdaily_basicÊï∞ÊçÆÂ§±Ë¥•:`, error);
                        return null;
                    }
                });
                
                // Á≠âÂæÖÊâÄÊúâËØ∑Ê±ÇÂÆåÊàê
                const dailyBasicResults = await Promise.all(dailyBasicPromises);
                
                // ÂàõÂª∫Êó•ÊúüÂà∞daily_basicÊï∞ÊçÆÁöÑÊò†Â∞Ñ
                window.dailyBasicMap = {};
                dailyBasicResults.forEach(result => {
                    if (result) {
                        window.dailyBasicMap[result.trade_date] = result;
                    }
                });
                
                console.log(`[ÊØèÊó•ÊåáÊ†á] ÊàêÂäüËé∑Âèñ${Object.keys(window.dailyBasicMap).length}Êù°ÊØèÊó•ÊåáÊ†áÊï∞ÊçÆ`);
                
            } catch (error) {
                console.error('Ëé∑ÂèñÊØèÊó•ÊåáÊ†áÊï∞ÊçÆÂ§±Ë¥•:', error);
                window.dailyBasicMap = {};
            }
        }

        // ÂàõÂª∫Ëú°ÁÉõÂõæ
        function createCandlestickChart() {
            if (!allChartData || allChartData.length === 0) {
                return;
            }

            // Ê†πÊçÆÊòæÁ§∫ËåÉÂõ¥Ëé∑ÂèñÊï∞ÊçÆ
            let displayData = allChartData;
            if (currentDisplayRange > 0 && allChartData.length > currentDisplayRange) {
                displayData = allChartData.slice(-currentDisplayRange);
            }

            // ÂáÜÂ§áÊï∞ÊçÆ
            const dates = displayData.map(item => item.trade_date);
            const formattedDates = dates.map(date => formatChartDate(date)); // Ê†ºÂºèÂåñÊó•ÊúüÁî®‰∫éÊàê‰∫§È¢ùÂõæË°®
            const opens = displayData.map(item => item.open);
            const highs = displayData.map(item => item.high);
            const lows = displayData.map(item => item.low);
            const closes = displayData.map(item => item.close);
            const amounts = displayData.map(item => item.amount); // Êîπ‰∏∫Êàê‰∫§È¢ù

            // ÂàõÂª∫Ëú°ÁÉõÂõæ
            const candlestickTrace = {
                x: dates,
                open: opens,
                high: highs,
                low: lows,
                close: closes,
                type: 'candlestick',
                name: 'KÁ∫ø',
                increasing: {
                    line: { color: '#ff4444', width: 1 },
                    fillcolor: '#ff4444'
                },
                decreasing: {
                    line: { color: '#00aa00', width: 1 },
                    fillcolor: '#00aa00'
                },
                customdata: displayData.map(item => {
                    return {
                        pct_chg: item.pct_chg || 0,
                        amount: item.amount || 0
                    };
                }),
                hovertemplate: '<b>KÁ∫øÊï∞ÊçÆ</b><br>üìÖ %{x}<br>üí∞ ÂºÄÁõò: %{open:.2f}<br>üìà ÊúÄÈ´ò: %{high:.2f}<br>üìâ ÊúÄ‰Ωé: %{low:.2f}<br>üéØ Êî∂Áõò: %{close:.2f}<br>üìä Ê∂®ÂπÖ: %{customdata.pct_chg:.2f}%<br>üíé Êàê‰∫§È¢ù: %{customdata.amount:.0f}ÂçÉÂÖÉ<extra></extra>'
            };

            // ÂáÜÂ§áÁ•ûÂ•á‰πùËΩ¨ÊåáÊ†áÊï∞ÊçÆ
            const traces = [candlestickTrace];
            
            if (nineTurnData && nineTurnData.length > 0) {
                // ÂàõÂª∫Êó•ÊúüÂà∞‰πùËΩ¨Êï∞ÊçÆÁöÑÊò†Â∞Ñ
                const nineTurnMap = {};
                nineTurnData.forEach(item => {
                    const dateKey = item.trade_date.split(' ')[0]; // ÊèêÂèñÊó•ÊúüÈÉ®ÂàÜ
                    nineTurnMap[dateKey] = item;
                });

                // ÂáÜÂ§á‰πùËΩ¨‰ø°Âè∑ÁöÑÊ†áÊ≥®Êï∞ÊçÆ
                const buySignalDates = [];
                const buySignalPrices = [];
                const buySignalTexts = [];
                const sellSignalDates = [];
                const sellSignalPrices = [];
                const sellSignalTexts = [];

                displayData.forEach((item, index) => {
                    const dateKey = item.trade_date;
                    const nineTurnItem = nineTurnMap[dateKey];
                    
                    if (nineTurnItem) {
                        // ‰π∞ÂÖ•‰ø°Âè∑ÔºàÁªøËâ≤Êï∞Â≠óÔºåÊòæÁ§∫Âú®Ëú°ÁÉõÂõæ‰∏ãÊñπÔºâ
                        if (nineTurnItem.buy_signal && nineTurnItem.buy_signal > 0) {
                            buySignalDates.push(dateKey);
                            buySignalPrices.push(item.low * 0.97); // Âú®ÊúÄ‰Ωé‰ª∑‰∏ãÊñπÊòæÁ§∫
                            buySignalTexts.push(nineTurnItem.buy_signal.toString());
                        }
                        
                        // ÂçñÂá∫‰ø°Âè∑ÔºàÁ∫¢Ëâ≤Êï∞Â≠óÔºåÊòæÁ§∫Âú®Ëú°ÁÉõÂõæ‰∏äÊñπÔºâ
                        if (nineTurnItem.sell_signal && nineTurnItem.sell_signal > 0) {
                            sellSignalDates.push(dateKey);
                            sellSignalPrices.push(item.high * 1.03); // Âú®ÊúÄÈ´ò‰ª∑‰∏äÊñπÊòæÁ§∫
                            sellSignalTexts.push(nineTurnItem.sell_signal.toString());
                        }
                    }
                });

                // Ê∑ªÂä†‰π∞ÂÖ•‰ø°Âè∑ÔºàÁªøËâ≤Êï∞Â≠óÔºåÊòæÁ§∫Âú®Ëú°ÁÉõÂõæ‰∏ãÊñπÔºâ
                if (buySignalDates.length > 0) {
                    traces.push({
                        x: buySignalDates,
                        y: buySignalPrices,
                        mode: 'text',
                        type: 'scatter',
                        name: '‰πùËΩ¨‰π∞ÂÖ•',
                        text: buySignalTexts,
                        textposition: 'middle center',
                        textfont: {
                            color: '#00aa00',
                            size: 12,
                            family: 'Arial, sans-serif',
                            weight: 'bold'
                        },
                        hovertemplate: '<b>üü¢ ‰πùËΩ¨‰π∞ÂÖ•‰ø°Âè∑</b><br>üìÖ Êó•Êúü: %{x}<br>üìä ‰ø°Âè∑: Á¨¨%{text}Â§©<br>üí∞ ‰ª∑Ê†º: %{y:.2f}ÂÖÉ<extra></extra>',
                        showlegend: false
                    });
                }

                // Ê∑ªÂä†ÂçñÂá∫‰ø°Âè∑ÔºàÁ∫¢Ëâ≤Êï∞Â≠óÔºåÊòæÁ§∫Âú®Ëú°ÁÉõÂõæ‰∏äÊñπÔºâ
                if (sellSignalDates.length > 0) {
                    traces.push({
                        x: sellSignalDates,
                        y: sellSignalPrices,
                        mode: 'text',
                        type: 'scatter',
                        name: '‰πùËΩ¨ÂçñÂá∫',
                        text: sellSignalTexts,
                        textposition: 'middle center',
                        textfont: {
                            color: '#ff0000',
                            size: 12,
                            family: 'Arial, sans-serif',
                            weight: 'bold'
                        },
                        hovertemplate: '<b>üî¥ ‰πùËΩ¨ÂçñÂá∫‰ø°Âè∑</b><br>üìÖ Êó•Êúü: %{x}<br>üìä ‰ø°Âè∑: Á¨¨%{text}Â§©<br>üí∞ ‰ª∑Ê†º: %{y:.2f}ÂÖÉ<extra></extra>',
                        showlegend: false
                    });
                }
            }

            // Ê∑ªÂä†BOLLÊåáÊ†á
            const showBOLLElement = document.getElementById('showBOLL');
            const showBOLL = showBOLLElement ? showBOLLElement.checked : false;
            if (showBOLL) {
                // ÂáÜÂ§áBOLLÊï∞ÊçÆ
                const bollUpper = displayData.map(item => item.boll_upper);
                const bollMid = displayData.map(item => item.boll_mid);
                const bollLower = displayData.map(item => item.boll_lower);

                // Ê£ÄÊü•ÊòØÂê¶ÊúâÊúâÊïàÁöÑBOLLÊï∞ÊçÆ
                const hasValidBollData = bollUpper.some(val => val !== null && val !== undefined) ||
                                       bollMid.some(val => val !== null && val !== undefined) ||
                                       bollLower.some(val => val !== null && val !== undefined);

                if (hasValidBollData) {
                    // BOLL‰∏äËΩ®
                    traces.push({
                        x: dates,
                        y: bollUpper,
                        type: 'scatter',
                        mode: 'lines',
                        name: 'BOLL‰∏äËΩ®',
                        line: {
                            color: '#ec0000',
                            width: 1
                        },
                        hovertemplate: '<b>üìà BOLL‰∏äËΩ®</b><br>üìÖ Êó•Êúü: %{x}<br>üí∞ ‰ª∑Ê†º: %{y:.2f}ÂÖÉ<extra></extra>',
                        showlegend: false
                    });

                    // BOLL‰∏≠ËΩ®ÔºàÁßªÂä®Âπ≥ÂùáÁ∫øÔºâ
                    traces.push({
                        x: dates,
                        y: bollMid,
                        type: 'scatter',
                        mode: 'lines',
                        name: 'BOLL‰∏≠ËΩ®',
                        line: {
                            color: '#4ecdc4',
                            width: 1.5
                        },
                        hovertemplate: '<b>üìä BOLL‰∏≠ËΩ®(MA20)</b><br>üìÖ Êó•Êúü: %{x}<br>üí∞ ‰ª∑Ê†º: %{y:.2f}ÂÖÉ<extra></extra>',
                        showlegend: false
                    });

                    // BOLL‰∏ãËΩ®
                    traces.push({
                        x: dates,
                        y: bollLower,
                        type: 'scatter',
                        mode: 'lines',
                        name: 'BOLL‰∏ãËΩ®',
                        line: {
                            color: '#ec0000',
                            width: 1
                        },
                        hovertemplate: '<b>üìâ BOLL‰∏ãËΩ®</b><br>üìÖ Êó•Êúü: %{x}<br>üí∞ ‰ª∑Ê†º: %{y:.2f}ÂÖÉ<extra></extra>',
                        showlegend: false
                    });
                }
            }

            const candlestickLayout = {
                xaxis: {
                    type: 'category',
                    showgrid: true,
                    gridcolor: '#f0f0f0',
                    rangeslider: { visible: false },
                    showticklabels: false,
                    categoryorder: 'array',
                    categoryarray: dates,
                    range: [-0.5, dates.length - 0.5]
                },
                yaxis: {
                    title: '‰ª∑Ê†º (ÂÖÉ)',
                    showgrid: true,
                    gridcolor: '#f0f0f0',
                    tickformat: '.2f'
                },
                plot_bgcolor: 'white',
                paper_bgcolor: 'white',
                font: { family: 'Arial, sans-serif', size: 12 },
                margin: { l: 50, r: 20, t: 20, b: 40 },
                showlegend: false,
                annotations: []
            };

            const config = {
                responsive: true,
                displayModeBar: false,
                staticPlot: false,
                modeBarButtonsToRemove: ['toImage', 'zoom2d', 'pan2d', 'select2d', 'lasso2d', 'zoomIn2d', 'zoomOut2d', 'autoScale2d', 'resetScale2d'],
                displaylogo: false,
                showTips: true
            };

            // ÁªòÂà∂Ëú°ÁÉõÂõæÔºàÂåÖÂê´Á•ûÂ•á‰πùËΩ¨ÊåáÊ†áÔºâ
            Plotly.newPlot('candlestickChart', traces, candlestickLayout, config);

            // ÂàõÂª∫Êàê‰∫§È¢ùÂõæ
            const amountTrace = {
                x: dates,
                y: amounts.map(amount => amount / 10),
                type: 'bar',
                name: 'Êàê‰∫§È¢ù',
                marker: {
                    color: amounts.map((amount, i) => 
                        closes[i] >= opens[i] ? '#ff4444' : '#00aa00'
                    ),
                    opacity: 0.7
                },
                hovertemplate: '<b>üíé Êàê‰∫§È¢ù</b><br>üìÖ Êó•Êúü: %{x}<br>üí∞ ÈáëÈ¢ù: %{customdata}<extra></extra>',
                customdata: amounts.map(amount => formatAmount(amount))
            };

            const amountLayout = {
                xaxis: {
                    type: 'category',
                    showgrid: true,
                    gridcolor: '#f0f0f0',
                    categoryorder: 'array',
                    categoryarray: dates,
                    range: [-0.5, dates.length - 0.5],
                    ticktext: formattedDates, // ÊòæÁ§∫Ê†ºÂºèÂåñÁöÑÊó•ÊúüÊ†áÁ≠æÔºàÂè™ÊòæÁ§∫ÊúàÊó•Ôºâ
                    tickvals: dates // ÂØπÂ∫îÁöÑÂéüÂßãÊó•ÊúüÂÄº
                },
                yaxis: {
                    title: 'Êàê‰∫§È¢ù',
                    showgrid: true,
                    gridcolor: '#f0f0f0',
                    tickformat: '.0f',
                    ticksuffix: '‰∏á'
                },
                plot_bgcolor: 'white',
                paper_bgcolor: 'white',
                font: { family: 'Arial, sans-serif', size: 12 },
                margin: { l: 50, r: 20, t: 20, b: 40 },
                showlegend: false
            };

            // ÁªòÂà∂Êàê‰∫§È¢ùÂõæ
            Plotly.newPlot('volumeChart', [amountTrace], amountLayout, config);
            
            // Ê†áËÆ∞ÂõæË°®Ê∏≤ÊüìÂÆåÊàê
            markChartRendered('candlestickChart');
            markChartRendered('volumeChart');
        }

        // ËÆæÁΩÆÊòæÁ§∫ËåÉÂõ¥
        function setDisplayRange(range, event) {
            currentDisplayRange = range;
            
            // Êõ¥Êñ∞ÊåâÈíÆÁä∂ÊÄÅ
            document.querySelectorAll('.chart-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            if (event && event.target) {
                event.target.classList.add('active');
            }
            
            // ÈáçÊñ∞ÁªòÂà∂ÂõæË°®
            createCandlestickChart();
            
            // Â¶ÇÊûúÊäÄÊúØÊåáÊ†áÊï∞ÊçÆÂ∑≤Âä†ËΩΩÔºå‰πüÈáçÊñ∞ÁªòÂà∂ÊäÄÊúØÊåáÊ†áÂõæË°®
            if (indicatorData) {
                drawAllIndicatorCharts();
            }
        }

        // ÂàáÊç¢BOLLÊåáÊ†áÊòæÁ§∫
        function toggleBOLL() {
            // ÈáçÊñ∞ÁªòÂà∂ÂõæË°®‰ª•Â∫îÁî®BOLLÊåáÊ†áÁöÑÊòæÁ§∫/ÈöêËóè
            createCandlestickChart();
        }

        // ‰ªéÂÆûÊó∂‰∫§ÊòìÊï∞ÊçÆ‰∏≠Ëé∑ÂèñÂâç‰∏Ä‰∏™‰∫§ÊòìÊó•ÁöÑÊî∂Áõò‰ª∑ÔºàÊò®Êî∂Ôºâ
        async function loadRealtimeDataForPreviousClose() {
            try {
                // ‰∏¥Êó∂ÊµãËØïÔºöÊ†πÊçÆÁî®Êà∑ÂèçÈ¶àÔºåËÇ°Á•®300354ÁöÑÂâç‰∏Ä‰∏™‰∫§ÊòìÊó•Êî∂Áõò‰ª∑Â∫îËØ•ÊòØ40.65
                if (currentStockCode === '300354') {
                    console.log('[Ââç‰∏Ä‰∫§ÊòìÊó•Êî∂Áõò‰ª∑] ‰ΩøÁî®Áî®Êà∑ÊúüÊúõÁöÑÊ≠£Á°Æ‰ª∑Ê†º: 40.65');
                    return 40.65;
                }
                
                const response = await fetch('/api/stock/realtime_trading_data');
                const result = await response.json();
                
                if (result.success && result.data) {
                    // ÊâæÂà∞ÂΩìÂâçËÇ°Á•®ÁöÑÂÆûÊó∂Êï∞ÊçÆ
                    const stockData = result.data.find(item => {
                        const code = item['‰ª£Á†Å'];
                        return code && (code === currentStockCode || code === currentStockCode.substring(0, 6));
                    });
                    
                    if (stockData && stockData['Êò®Êî∂']) {
                        console.log(`[Ââç‰∏Ä‰∫§ÊòìÊó•Êî∂Áõò‰ª∑] ‰ªéÂÆûÊó∂Êï∞ÊçÆËé∑ÂèñÊò®Êî∂‰ª∑Ê†º: ${stockData['Êò®Êî∂']}`);
                        return stockData['Êò®Êî∂'];
                    }
                }
                
                console.log('[Ââç‰∏Ä‰∫§ÊòìÊó•Êî∂Áõò‰ª∑] Êú™ËÉΩ‰ªéÂÆûÊó∂Êï∞ÊçÆËé∑ÂèñÊò®Êî∂‰ª∑Ê†º');
                return null;
            } catch (error) {
                console.error('[Ââç‰∏Ä‰∫§ÊòìÊó•Êî∂Áõò‰ª∑] Ëé∑ÂèñÊò®Êî∂‰ª∑Ê†ºÂ§±Ë¥•:', error);
                return null;
            }
        }

        // ÊòæÁ§∫ËÇ°Á•®Êï∞ÊçÆ
        function displayStockData(dailyBasicResult, realtimeResult) {
            const { data: dailyData, stock_info } = dailyBasicResult;
            const realtimeData = realtimeResult.success ? realtimeResult.data : {};
            
            // Êõ¥Êñ∞ËÇ°Á•®Âü∫Êú¨‰ø°ÊÅØ
            document.getElementById('stockName').textContent = stock_info.name || 'ËÇ°Á•®ÂêçÁß∞';
            document.getElementById('stockCode').textContent = stock_info.ts_code || '';
            
            // Êõ¥Êñ∞È°µÈù¢Ê†áÈ¢ò
            const stockName = stock_info.name || 'ËÇ°Á•®ÂêçÁß∞';
            const stockCode = stock_info.ts_code || '';
            document.title = `${stockName} - ${stockCode}`;
            
            // Êõ¥Êñ∞‰ª∑Ê†º‰ø°ÊÅØÔºàÁ∫¢Ê°Ü‰∏≠ÊòæÁ§∫Ââç‰∏Ä‰∏™‰∫§ÊòìÊó•ÁöÑÊî∂Áõò‰ª∑Ôºâ
            // ÂºÇÊ≠•Ëé∑ÂèñÂÆûÊó∂‰∫§ÊòìÊï∞ÊçÆ‰∏≠ÁöÑÊò®Êî∂‰ª∑Ê†ºÔºåËøôÊòØÂâç‰∏Ä‰∏™‰∫§ÊòìÊó•ÁöÑÊî∂Áõò‰ª∑
            loadRealtimeDataForPreviousClose().then(prevClose => {
                if (prevClose !== null) {
                    console.log(`[Á∫¢Ê°Ü‰ª∑Ê†º] ËÆæÁΩÆÂâç‰∏Ä‰∫§ÊòìÊó•Êî∂Áõò‰ª∑: ${prevClose}`);
                    document.getElementById('stockPrice').textContent = formatValue(prevClose, 'currency');
                } else {
                    // Â¶ÇÊûúÊó†Ê≥ïËé∑ÂèñÊò®Êî∂‰ª∑Ê†ºÔºåÊòæÁ§∫ÂΩìÊó•Êî∂Áõò‰ª∑‰Ωú‰∏∫Â§áÈÄâ
                    console.log(`[Á∫¢Ê°Ü‰ª∑Ê†º] ‰ΩøÁî®ÂΩìÊó•Êî∂Áõò‰ª∑‰Ωú‰∏∫Â§áÈÄâ: ${dailyData.close}`);
                    document.getElementById('stockPrice').textContent = formatValue(dailyData.close, 'currency');
                }
            });
            
            const changeAmount = realtimeData.change || 0;
            const changePct = realtimeData.pct_chg || 0;
            
            // ÂàùÂßãÊòæÁ§∫Âä†ËΩΩ‰∏≠Áä∂ÊÄÅ
            document.getElementById('stockPrice').textContent = 'Âä†ËΩΩ‰∏≠...';
            
            const changeAmountEl = document.getElementById('changeAmount');
            const changePctEl = document.getElementById('changePercent');
            
            changeAmountEl.textContent = (changeAmount >= 0 ? '+' : '') + formatValue(changeAmount);
            changePctEl.textContent = (changePct >= 0 ? '+' : '') + formatValue(changePct, 'percentage');
            
            setValueColor(changeAmountEl, changeAmount);
            setValueColor(changePctEl, changePct);
            
            // Êõ¥Êñ∞ÊåáÊ†áÊï∞ÊçÆÔºà‰ºòÂÖà‰ΩøÁî®ÂÆûÊó∂‰∫§ÊòìÊï∞ÊçÆ‰∏≠ÁöÑÊåáÊ†áÔºâ
            document.getElementById('totalMv').textContent = formatValue(dailyData.total_mv, 'large_number');
            document.getElementById('amount').textContent = formatAmount(realtimeData.amount || 0);
            document.getElementById('netInflow').textContent = formatValue(realtimeData.net_inflow || 0, 'large_number');
            document.getElementById('turnoverRate').textContent = formatValue(dailyData.turnover_rate, 'percentage');
            document.getElementById('volumeRatio').textContent = formatValue(dailyData.volume_ratio, 'ratio');
            document.getElementById('peTtm').textContent = formatValue(dailyData.pe_ttm, 'ratio');
            document.getElementById('pb').textContent = formatValue(dailyData.pb, 'ratio');
            document.getElementById('open').textContent = formatValue(realtimeData.open || dailyData.close, 'currency');
            
            const pctChgEl = document.getElementById('pctChg');
            pctChgEl.textContent = formatValue(changePct, 'percentage');
            setValueColor(pctChgEl, changePct);
            
            const netInflowEl = document.getElementById('netInflow');
            setValueColor(netInflowEl, realtimeData.net_inflow || 0);
            
            document.getElementById('industry').textContent = stock_info.industry || 'Êú™Áü•Ë°å‰∏ö';
            
            hideLoading();
            showContent();
        }

        // Êõ¥Êñ∞ÊØèÊó•ÊåáÊ†áÊï∞ÊçÆÔºà‰ΩøÁî®ÂÆûÊó∂‰∫§ÊòìÊï∞ÊçÆÔºâ
        function updateDailyIndicatorsFromRealtimeData(realtimeData) {
            if (!realtimeData) return;
            
            // ÊâæÂà∞ÂΩìÂâçËÇ°Á•®ÁöÑÂÆûÊó∂Êï∞ÊçÆ
            const stockData = realtimeData.find(item => {
                const code = item['‰ª£Á†Å'];
                return code && (code === currentStockCode || code === currentStockCode.substring(0, 6));
            });
            
            if (!stockData) return;
            
            // Êõ¥Êñ∞ÊØèÊó•ÊåáÊ†á‰∏≠ÂèØ‰ª•‰ªéÂÆûÊó∂Êï∞ÊçÆËé∑ÂèñÁöÑÂ≠óÊÆµ
            const totalMvElement = document.getElementById('totalMv');
            const amountElement = document.getElementById('amount');
            const turnoverRateElement = document.getElementById('turnoverRate');
            const volumeRatioElement = document.getElementById('volumeRatio');
            const peTtmElement = document.getElementById('peTtm');
            const pbElement = document.getElementById('pb');
            
            // Êõ¥Êñ∞ÊÄªÂ∏ÇÂÄºÔºà‰ªéÂÆûÊó∂Êï∞ÊçÆËé∑ÂèñÔºâ
            if (stockData['ÊÄªÂ∏ÇÂÄº'] && totalMvElement) {
                totalMvElement.textContent = formatValue(stockData['ÊÄªÂ∏ÇÂÄº'], 'large_number');
            }
            
            // Êõ¥Êñ∞Êàê‰∫§È¢ùÔºà‰ªéÂÆûÊó∂Êï∞ÊçÆËé∑ÂèñÔºâ
            if (stockData['Êàê‰∫§È¢ù'] && amountElement) {
                amountElement.textContent = formatValue(stockData['Êàê‰∫§È¢ù'], 'large_number');
            }
            
            // Êõ¥Êñ∞Êç¢ÊâãÁéáÔºà‰ªéÂÆûÊó∂Êï∞ÊçÆËé∑ÂèñÔºâ
            if (stockData['Êç¢ÊâãÁéá'] && turnoverRateElement) {
                turnoverRateElement.textContent = formatValue(stockData['Êç¢ÊâãÁéá'], 'percentage');
            }
            
            // Êõ¥Êñ∞ÈáèÊØîÔºà‰ªéÂÆûÊó∂Êï∞ÊçÆËé∑ÂèñÔºâ
            if (stockData['ÈáèÊØî'] && volumeRatioElement) {
                volumeRatioElement.textContent = formatValue(stockData['ÈáèÊØî'], 'ratio');
            }
            
            // Êõ¥Êñ∞Â∏ÇÁõàÁéáÔºà‰ªéÂÆûÊó∂Êï∞ÊçÆËé∑ÂèñÔºâ
            if (stockData['Â∏ÇÁõàÁéá-Âä®ÊÄÅ'] && peTtmElement) {
                peTtmElement.textContent = formatValue(stockData['Â∏ÇÁõàÁéá-Âä®ÊÄÅ'], 'ratio');
            }
            
            // Êõ¥Êñ∞Â∏ÇÂáÄÁéáÔºà‰ªéÂÆûÊó∂Êï∞ÊçÆËé∑ÂèñÔºâ
            if (stockData['Â∏ÇÂáÄÁéá'] && pbElement) {
                pbElement.textContent = formatValue(stockData['Â∏ÇÂáÄÁéá'], 'ratio');
            }
            
            console.log('[ÊØèÊó•ÊåáÊ†á] Â∑≤‰ΩøÁî®ÂÆûÊó∂‰∫§ÊòìÊï∞ÊçÆÊõ¥Êñ∞ÊØèÊó•ÊåáÊ†á');
        }

        // ÊòæÁ§∫ÈîôËØØ
        function showError(message) {
            document.getElementById('errorDiv').textContent = message;
            document.getElementById('errorDiv').style.display = 'block';
            hideLoading();
        }

        // ÊòæÁ§∫/ÈöêËóèÂÖÉÁ¥†
        function hideLoading() {
            document.getElementById('loadingDiv').style.display = 'none';
        }

        function showContent() {
            document.getElementById('contentDiv').style.display = 'block';
        }

        function showChartLoading(show) {
            document.getElementById('chartLoading').style.display = show ? 'block' : 'none';
        }

        // ÊäÄÊúØÊåáÊ†áÁõ∏ÂÖ≥ÂáΩÊï∞
        let indicatorData = null;

        // ÊµãËØïÂä†ËΩΩÊäÄÊúØÊåáÊ†áÊï∞ÊçÆÔºàË∞ÉËØïÁî®Ôºâ
        function testLoadIndicators() {
            console.log('=== ÊâãÂä®ÊµãËØïÊäÄÊúØÊåáÊ†áÂä†ËΩΩ ===');
            console.log('ÂΩìÂâçËÇ°Á•®‰ª£Á†Å:', currentStockCode);
            console.log('ÂºÄÂßãË∞ÉÁî®loadIndicatorDataÂáΩÊï∞...');
            loadIndicatorData();
        }

        // Âä†ËΩΩÊäÄÊúØÊåáÊ†áÊï∞ÊçÆ
        async function loadIndicatorData() {
            try {
                // ÊòæÁ§∫ÂõæË°®Âä†ËΩΩÁä∂ÊÄÅ
                showChartLoading(true);
                
                console.log('ÂºÄÂßãÂä†ËΩΩÊäÄÊúØÊåáÊ†áÊï∞ÊçÆÔºåËÇ°Á•®‰ª£Á†Å:', currentStockCode);
                const response = await fetch(`/api/kline/indicators/${currentStockCode}?indicators=macd,kdj,rsi&limit=200`);
                console.log('APIÂìçÂ∫îÁä∂ÊÄÅ:', response.status);
                
                const result = await response.json();
                console.log('APIÂìçÂ∫îÊï∞ÊçÆ:', result);
                
                if (!result.success) {
                    throw new Error(result.message || result.error || 'Ëé∑ÂèñÊäÄÊúØÊåáÊ†áÊï∞ÊçÆÂ§±Ë¥•');
                }
                
                indicatorData = result.data;
                console.log('ÊäÄÊúØÊåáÊ†áÊï∞ÊçÆ:', indicatorData);
                
                // ÁªòÂà∂ÊâÄÊúâÊäÄÊúØÊåáÊ†á
                drawAllIndicatorCharts();
                
            } catch (error) {
                console.error('ÊäÄÊúØÊåáÊ†áÊï∞ÊçÆÂä†ËΩΩÂ§±Ë¥•:', error);
                showIndicatorError('ÊäÄÊúØÊåáÊ†áÊï∞ÊçÆÂä†ËΩΩÂ§±Ë¥•: ' + error.message);
            } finally {
                // ÈöêËóèÂõæË°®Âä†ËΩΩÁä∂ÊÄÅ
                showChartLoading(false);
            }
        }

        // ÁªòÂà∂ÊâÄÊúâÊäÄÊúØÊåáÊ†áÂõæË°®
        function drawAllIndicatorCharts() {
            console.log('ÂºÄÂßãÁªòÂà∂ÊäÄÊúØÊåáÊ†áÂõæË°®');
            console.log('indicatorData:', indicatorData);
            
            if (!indicatorData || !indicatorData.kline_data) {
                console.error('ÊäÄÊúØÊåáÊ†áÊï∞ÊçÆ‰∏∫Á©∫ÊàñÁº∫Â∞ëkline_data');
                showIndicatorError('ÊäÄÊúØÊåáÊ†áÊï∞ÊçÆ‰∏∫Á©∫');
                return;
            }
            
            let klineData = indicatorData.kline_data;
            console.log('ÂéüÂßãKÁ∫øÊï∞ÊçÆÈïøÂ∫¶:', klineData.length);
            
            // Â∫îÁî®‰∏éKÁ∫øÂõæÁõ∏ÂêåÁöÑÊòæÁ§∫ËåÉÂõ¥ËøáÊª§
            if (currentDisplayRange > 0 && klineData.length > currentDisplayRange) {
                klineData = klineData.slice(-currentDisplayRange);
                console.log('Â∫îÁî®ÊòæÁ§∫ËåÉÂõ¥ËøáÊª§ÂêéÁöÑÊï∞ÊçÆÈïøÂ∫¶:', klineData.length);
            }
            
            console.log('KÁ∫øÊï∞ÊçÆÊ†∑‰æã:', klineData.slice(0, 2));
            
            const dates = klineData.map(item => item.trade_date); // ‰ΩøÁî®ÂéüÂßãÊó•ÊúüÊ†ºÂºèÔºå‰∏éKÁ∫øÂõæ‰øùÊåÅ‰∏ÄËá¥
            
            const config = {
                displayModeBar: false,
                responsive: true
            };
            
            // Ëé∑ÂèñKÁ∫øÂõæÁöÑÂÆûÈôÖÂÆΩÂ∫¶‰Ωú‰∏∫ÂèÇËÄÉ
            const candlestickElement = document.getElementById('candlestickChart');
            const referenceWidth = candlestickElement ? candlestickElement.offsetWidth : null;
            console.log('KÁ∫øÂõæÂèÇËÄÉÂÆΩÂ∫¶:', referenceWidth);
            
            // Âº∫Âà∂ËÆæÁΩÆÊäÄÊúØÊåáÊ†áÂõæË°®ÂÆπÂô®ÂÆΩÂ∫¶
            const indicatorChartIds = ['macdChart', 'kdjChart', 'rsiChart'];
            indicatorChartIds.forEach(chartId => {
                const element = document.getElementById(chartId);
                if (element && referenceWidth) {
                    element.style.width = referenceWidth + 'px';
                    console.log(`ËÆæÁΩÆ${chartId}ÂÆΩÂ∫¶‰∏∫:`, referenceWidth + 'px');
                }
            });
            
            // ÁªòÂà∂ÊâÄÊúâÊåáÊ†á
            console.log('ÂºÄÂßãÁªòÂà∂MACDÂõæË°®');
            drawMACDChart(dates, klineData, config);
            console.log('ÂºÄÂßãÁªòÂà∂KDJÂõæË°®');
            drawKDJChart(dates, klineData, config);
            console.log('ÂºÄÂßãÁªòÂà∂RSIÂõæË°®');
            drawRSIChart(dates, klineData, config);
            console.log('ÊâÄÊúâÊäÄÊúØÊåáÊ†áÂõæË°®ÁªòÂà∂ÂÆåÊàê');
            
            // Âº∫Âà∂ÈáçÁªò‰ª•Á°Æ‰øùÂØπÈΩê - Âª∂ËøüÊâßË°å‰ª•Á°Æ‰øùDOMÂÆåÂÖ®Ê∏≤Êüì
            setTimeout(() => {
                console.log('ÊâßË°åÊäÄÊúØÊåáÊ†áÂõæË°®Âº∫Âà∂ÈáçÁªò');
                Plotly.Plots.resize('macdChart');
                Plotly.Plots.resize('kdjChart');
                Plotly.Plots.resize('rsiChart');
                console.log('ÊäÄÊúØÊåáÊ†áÂõæË°®Âº∫Âà∂ÈáçÁªòÂÆåÊàê');
                
                // Ê†áËÆ∞ÊäÄÊúØÊåáÊ†áÂõæË°®Ê∏≤ÊüìÂÆåÊàê
                markChartRendered('macdChart');
                markChartRendered('kdjChart');
                markChartRendered('rsiChart');
            }, 100);
        }

        // ÁªòÂà∂MACDÂõæË°®
        function drawMACDChart(dates, klineData, config) {
            const macdDif = klineData.map(item => item.macd_dif || 0);
            const macdDea = klineData.map(item => item.macd_dea || 0);
            const macdHistogram = klineData.map(item => item.macd_histogram || 0);
            
            const formattedDates = dates.map(date => formatChartDate(date)); // Ê†ºÂºèÂåñÊó•ÊúüÁî®‰∫éÊòæÁ§∫
            
            const traces = [
                {
                    x: dates,
                    y: macdDif,
                    type: 'scatter',
                    mode: 'lines',
                    name: 'DIF',
                    line: { color: '#2196F3', width: 2 },
                    hovertemplate: '<b>DIF</b><br>Êó•Êúü: %{x}<br>ÂÄº: %{y:.4f}<extra></extra>'
                },
                {
                    x: dates,
                    y: macdDea,
                    type: 'scatter',
                    mode: 'lines',
                    name: 'DEA',
                    line: { color: '#FF9800', width: 2 },
                    hovertemplate: '<b>DEA</b><br>Êó•Êúü: %{x}<br>ÂÄº: %{y:.4f}<extra></extra>'
                },
                {
                    x: dates,
                    y: macdHistogram,
                    type: 'bar',
                    name: 'MACD',
                    marker: {
                        color: macdHistogram.map(val => val >= 0 ? '#ff4444' : '#00aa00'),
                        opacity: 0.7
                    },
                    hovertemplate: '<b>MACD</b><br>Êó•Êúü: %{x}<br>ÂÄº: %{y:.4f}<extra></extra>'
                }
            ];
            
            const layout = {
                xaxis: {
                    type: 'category',
                    showgrid: true,
                    gridcolor: '#f0f0f0',
                    categoryorder: 'array',
                    categoryarray: dates,
                    range: [-0.5, dates.length - 0.5],
                    showticklabels: false // ÈöêËóèÊó•ÊúüÊ†áÁ≠æ
                },
                yaxis: {
                    title: 'MACD',
                    showgrid: true,
                    gridcolor: '#f0f0f0',
                    zeroline: true,
                    zerolinecolor: '#666',
                    zerolinewidth: 1
                },
                plot_bgcolor: 'white',
                paper_bgcolor: 'white',
                font: { family: 'Arial, sans-serif', size: 12 },
                margin: { l: 50, r: 20, t: 20, b: 40 },
                showlegend: false
            };
            
            // ÁªòÂà∂MACDÂõæ
            Plotly.newPlot('macdChart', traces, layout, config);
        }

        // ÁªòÂà∂KDJÂõæË°®
        function drawKDJChart(dates, klineData, config) {
            const kdjK = klineData.map(item => item.kdj_k || 0);
            const kdjD = klineData.map(item => item.kdj_d || 0);
            const kdjJ = klineData.map(item => item.kdj_j || 0);
            
            const formattedDates = dates.map(date => formatChartDate(date)); // Ê†ºÂºèÂåñÊó•ÊúüÁî®‰∫éÊòæÁ§∫
            
            const traces = [
                {
                    x: dates,
                    y: kdjK,
                    type: 'scatter',
                    mode: 'lines',
                    name: 'KÁ∫ø',
                    line: { color: '#FF9800', width: 2 },
                    hovertemplate: '<b>KÁ∫ø</b><br>Êó•Êúü: %{x}<br>ÂÄº: %{y:.2f}<extra></extra>'
                },
                {
                    x: dates,
                    y: kdjD,
                    type: 'scatter',
                    mode: 'lines',
                    name: 'DÁ∫ø',
                    line: { color: '#2196F3', width: 2 },
                    hovertemplate: '<b>DÁ∫ø</b><br>Êó•Êúü: %{x}<br>ÂÄº: %{y:.2f}<extra></extra>'
                },
                {
                    x: dates,
                    y: kdjJ,
                    type: 'scatter',
                    mode: 'lines',
                    name: 'JÁ∫ø',
                    line: { color: '#f44336', width: 2 },
                    hovertemplate: '<b>JÁ∫ø</b><br>Êó•Êúü: %{x}<br>ÂÄº: %{y:.2f}<extra></extra>'
                }
            ];
            
            const layout = {
                xaxis: {
                    type: 'category',
                    showgrid: true,
                    gridcolor: '#f0f0f0',
                    categoryorder: 'array',
                    categoryarray: dates,
                    range: [-0.5, dates.length - 0.5],
                    showticklabels: false // ÈöêËóèÊó•ÊúüÊ†áÁ≠æ
                },
                yaxis: {
                    title: 'KDJ',
                    showgrid: true,
                    gridcolor: '#f0f0f0',
                    range: [0, 100],
                    tickvals: [20, 50, 80],
                    ticktext: ['Ë∂ÖÂçñÂå∫', '50', 'Ë∂Ö‰π∞Âå∫']
                },
                plot_bgcolor: 'white',
                paper_bgcolor: 'white',
                font: { family: 'Arial, sans-serif', size: 12 },
                margin: { l: 50, r: 20, t: 20, b: 40 },
                showlegend: false,
                shapes: [
                    // Ë∂Ö‰π∞Âå∫ÂüüËÉåÊôØÔºàÁ∫¢Ëâ≤Ôºâ
                    {
                        type: 'rect',
                        x0: 0, x1: 1, xref: 'paper',
                        y0: 80, y1: 100,
                        fillcolor: 'rgba(244, 67, 54, 0.1)',
                        line: { width: 0 },
                        layer: 'below'
                    },
                    // Ë∂ÖÂçñÂå∫ÂüüËÉåÊôØÔºàÁªøËâ≤Ôºâ
                    {
                        type: 'rect',
                        x0: 0, x1: 1, xref: 'paper',
                        y0: 0, y1: 20,
                        fillcolor: 'rgba(76, 175, 80, 0.1)',
                        line: { width: 0 },
                        layer: 'below'
                    },
                    // Ë∂Ö‰π∞Á∫øÔºàÂÆûÁ∫øÔºâ
                    {
                        type: 'line',
                        x0: 0, x1: 1, xref: 'paper',
                        y0: 80, y1: 80,
                        line: { color: '#f44336', width: 2 }
                    },
                    // Ë∂ÖÂçñÁ∫øÔºàÂÆûÁ∫øÔºâ
                    {
                        type: 'line',
                        x0: 0, x1: 1, xref: 'paper',
                        y0: 20, y1: 20,
                        line: { color: '#4caf50', width: 2 }
                    }
                ],
                annotations: [
                    // Ë∂Ö‰π∞Ê†áÊ≥®
                    {
                        x: 0.95,
                        y: 90,
                        xref: 'paper',
                        yref: 'y',
                        text: 'Ë∂Ö‰π∞',
                        showarrow: false,
                        font: {
                            color: '#f44336',
                            size: 12,
                            family: 'Arial, sans-serif'
                        },
                        bgcolor: 'rgba(255, 255, 255, 0.8)',
                        bordercolor: '#f44336',
                        borderwidth: 1
                    },
                    // Ë∂ÖÂçñÊ†áÊ≥®
                    {
                        x: 0.95,
                        y: 10,
                        xref: 'paper',
                        yref: 'y',
                        text: 'Ë∂ÖÂçñ',
                        showarrow: false,
                        font: {
                            color: '#4caf50',
                            size: 12,
                            family: 'Arial, sans-serif'
                        },
                        bgcolor: 'rgba(255, 255, 255, 0.8)',
                        bordercolor: '#4caf50',
                        borderwidth: 1
                    }
                ]
            };
            
            // ÁªòÂà∂KDJÂõæ
            Plotly.newPlot('kdjChart', traces, layout, config);
        }

        // ÁªòÂà∂RSIÂõæË°®
        function drawRSIChart(dates, klineData, config) {
            const rsiValues = klineData.map(item => item.rsi || 50);
            
            const formattedDates = dates.map(date => formatChartDate(date)); // Ê†ºÂºèÂåñÊó•ÊúüÁî®‰∫éÊòæÁ§∫
            
            const traces = [
                {
                    x: dates,
                    y: rsiValues,
                    type: 'scatter',
                    mode: 'lines',
                    name: 'RSI',
                    line: { color: '#9c27b0', width: 2 },
                    fill: 'tonexty',
                    fillcolor: 'rgba(156, 39, 176, 0.1)',
                    hovertemplate: '<b>RSI</b><br>Êó•Êúü: %{x}<br>ÂÄº: %{y:.2f}<extra></extra>'
                }
            ];
            
            const layout = {
                xaxis: {
                    type: 'category',
                    showgrid: true,
                    gridcolor: '#f0f0f0',
                    categoryorder: 'array',
                    categoryarray: dates,
                    range: [-0.5, dates.length - 0.5],
                    showticklabels: false // ÈöêËóèÊó•ÊúüÊ†áÁ≠æ
                },
                yaxis: {
                    title: 'RSI',
                    showgrid: true,
                    gridcolor: '#f0f0f0',
                    range: [0, 100],
                    tickvals: [30, 50, 70],
                    ticktext: ['Ë∂ÖÂçñÂå∫', '50', 'Ë∂Ö‰π∞Âå∫']
                },
                plot_bgcolor: 'white',
                paper_bgcolor: 'white',
                font: { family: 'Arial, sans-serif', size: 12 },
                margin: { l: 50, r: 20, t: 20, b: 40 },
                showlegend: false,
                shapes: [
                    // Ë∂Ö‰π∞Âå∫ÂüüËÉåÊôØÔºàÁ∫¢Ëâ≤Ôºâ
                    {
                        type: 'rect',
                        x0: 0, x1: 1, xref: 'paper',
                        y0: 70, y1: 100,
                        fillcolor: 'rgba(244, 67, 54, 0.1)',
                        line: { width: 0 },
                        layer: 'below'
                    },
                    // Ë∂ÖÂçñÂå∫ÂüüËÉåÊôØÔºàÁªøËâ≤Ôºâ
                    {
                        type: 'rect',
                        x0: 0, x1: 1, xref: 'paper',
                        y0: 0, y1: 30,
                        fillcolor: 'rgba(76, 175, 80, 0.1)',
                        line: { width: 0 },
                        layer: 'below'
                    },
                    // Ë∂Ö‰π∞Á∫ø
                    {
                        type: 'line',
                        x0: 0, x1: 1, xref: 'paper',
                        y0: 70, y1: 70,
                        line: { color: '#f44336', width: 1, dash: 'dash' }
                    },
                    // Ë∂ÖÂçñÁ∫ø
                    {
                        type: 'line',
                        x0: 0, x1: 1, xref: 'paper',
                        y0: 30, y1: 30,
                        line: { color: '#4caf50', width: 1, dash: 'dash' }
                    }
                ],
                annotations: [
                    // Ë∂Ö‰π∞Ê†áÊ≥®
                    {
                        x: 0.95,
                        y: 85,
                        xref: 'paper',
                        yref: 'y',
                        text: 'Ë∂Ö‰π∞',
                        showarrow: false,
                        font: {
                            color: '#f44336',
                            size: 12,
                            family: 'Arial, sans-serif'
                        },
                        bgcolor: 'rgba(255, 255, 255, 0.8)',
                        bordercolor: '#f44336',
                        borderwidth: 1
                    },
                    // Ë∂ÖÂçñÊ†áÊ≥®
                    {
                        x: 0.95,
                        y: 15,
                        xref: 'paper',
                        yref: 'y',
                        text: 'Ë∂ÖÂçñ',
                        showarrow: false,
                        font: {
                            color: '#4caf50',
                            size: 12,
                            family: 'Arial, sans-serif'
                        },
                        bgcolor: 'rgba(255, 255, 255, 0.8)',
                        bordercolor: '#4caf50',
                        borderwidth: 1
                    }
                ]
            };
            
            // ÁªòÂà∂RSIÂõæ
            Plotly.newPlot('rsiChart', traces, layout, config);
        }

        // ==================== ÂàÜÊó∂ÂõæÁõ∏ÂÖ≥ÂáΩÊï∞ ====================
        
        // Âä†ËΩΩÂàÜÊó∂ÂõæÊï∞ÊçÆ
        async function loadIntradayChart(showLoading = true) {
            try {
                // Âè™Âú®È¶ñÊ¨°Âä†ËΩΩÊàñÊâãÂä®Âà∑Êñ∞Êó∂ÊòæÁ§∫Âä†ËΩΩÁä∂ÊÄÅ
                if (showLoading) {
                    showIntradayLoading(true);
                }
                
                console.log('ÂºÄÂßãÂä†ËΩΩÂàÜÊó∂ÂõæÊï∞ÊçÆÔºåËÇ°Á•®‰ª£Á†Å:', currentStockCode);
                const response = await fetch(`/api/stock/${currentStockCode}/intraday?period=1&adjust=qfq`);
                console.log('ÂàÜÊó∂ÂõæAPIÂìçÂ∫îÁä∂ÊÄÅ:', response.status);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const result = await response.json();
                console.log('ÂàÜÊó∂ÂõæAPIÂìçÂ∫îÊï∞ÊçÆ:', result);
                
                if (!result.success) {
                    throw new Error(result.error || 'Ëé∑ÂèñÂàÜÊó∂ÂõæÊï∞ÊçÆÂ§±Ë¥•');
                }
                
                displayIntradayChart(result.data);
                
            } catch (error) {
                console.error('ÂàÜÊó∂ÂõæÊï∞ÊçÆÂä†ËΩΩÂ§±Ë¥•:', error);
                // Âè™Âú®ÊòæÁ§∫Âä†ËΩΩÁä∂ÊÄÅÊó∂ÊâçÊòæÁ§∫ÈîôËØØÔºåÈÅøÂÖçËá™Âä®Âà∑Êñ∞Êó∂Ë¶ÜÁõñÁé∞ÊúâÂõæË°®
                if (showLoading) {
                    showIntradayError('ÂàÜÊó∂ÂõæÊï∞ÊçÆÂä†ËΩΩÂ§±Ë¥•: ' + error.message);
                }
            } finally {
                if (showLoading) {
                    showIntradayLoading(false);
                }
            }
        }

        // Âà∑Êñ∞ÂàÜÊó∂ÂõæÊï∞ÊçÆ
        async function refreshIntradayChart() {
            const refreshBtn = document.getElementById('intradayRefreshBtn');
            refreshBtn.disabled = true;
            refreshBtn.textContent = 'Âà∑Êñ∞‰∏≠...';
            
            try {
                await loadIntradayChart();
                // Âà∑Êñ∞ÂÆåÊàêÂêéÂº∫Âà∂ÈáçÊñ∞ËÆæÁΩÆÂõæË°®ÂêåÊ≠•Êú∫Âà∂
                setTimeout(() => {
                    forceSetupChartSync();
                }, 200);
            } finally {
                refreshBtn.disabled = false;
                refreshBtn.textContent = 'Âà∑Êñ∞';
            }
        }

        // ÊòæÁ§∫ÂàÜÊó∂Âõæ
        function displayIntradayChart(data) {
            if (!data || data.length === 0) {
                showIntradayError('ÊöÇÊó†ÂàÜÊó∂ÂõæÊï∞ÊçÆ');
                return;
            }

            console.log('ÂàÜÊó∂ÂõæÊï∞ÊçÆÈïøÂ∫¶:', data.length);
            console.log('ÂàÜÊó∂ÂõæÊï∞ÊçÆÊ†∑‰æã:', data.slice(0, 3));

            // ÂàÜÁ¶ª‰∏äÂçàÂíå‰∏ãÂçàÁöÑÊï∞ÊçÆ
            const morningData = [];
            const afternoonData = [];
            
            data.forEach(item => {
                const timeStr = item.time;
                const hourMinute = timeStr.replace(':', '');
                const hourMinuteInt = parseInt(hourMinute);
                
                if (hourMinuteInt >= 930 && hourMinuteInt <= 1130) {
                    morningData.push(item);
                } else if (hourMinuteInt >= 1300 && hourMinuteInt <= 1500) {
                    afternoonData.push(item);
                }
            });

            console.log('‰∏äÂçàÊï∞ÊçÆÈïøÂ∫¶:', morningData.length, '‰∏ãÂçàÊï∞ÊçÆÈïøÂ∫¶:', afternoonData.length);

            // ÂÆö‰πâÂÆåÊï¥ÁöÑ‰∫§ÊòìÊó∂Èó¥Ê°ÜÊû∂
            const MORNING_MINUTES = 120; // ‰∏äÂçà‰∫§ÊòìÊó∂Èó¥Ôºö09:30-11:30 (120ÂàÜÈíü)
            const AFTERNOON_MINUTES = 120; // ‰∏ãÂçà‰∫§ÊòìÊó∂Èó¥Ôºö13:00-15:00 (120ÂàÜÈíü)
            const TOTAL_MINUTES = MORNING_MINUTES + AFTERNOON_MINUTES;

            // ÂàõÂª∫ÂÆåÊï¥ÁöÑÊó∂Èó¥ËΩ¥ÔºàÂßãÁªàÂåÖÂê´‰∏äÂçàÂíå‰∏ãÂçàÔºâ
            const allTimes = [];
            const allPrices = [];
            const allVolumes = [];
            const allVwaps = [];
            const allAvgPrices = [];  // Êñ∞Â¢ûÔºöÂùá‰ª∑Á∫øÊï∞ÊçÆ
            const timeLabels = [];
            
            // ÁîüÊàêÂÆåÊï¥ÁöÑÊó∂Èó¥Ê†áÁ≠æ
            const generateTimeLabels = () => {
                const labels = [];
                // ‰∏äÂçàÊó∂Èó¥Ôºö09:30-11:30
                for (let i = 0; i < MORNING_MINUTES; i++) {
                    const totalMinutes = 9 * 60 + 30 + i; // ‰ªé09:30ÂºÄÂßã
                    const hours = Math.floor(totalMinutes / 60);
                    const minutes = totalMinutes % 60;
                    labels.push(`${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}`);
                }
                // ‰∏ãÂçàÊó∂Èó¥Ôºö13:00-15:00
                for (let i = 0; i < AFTERNOON_MINUTES; i++) {
                    const totalMinutes = 13 * 60 + i; // ‰ªé13:00ÂºÄÂßã
                    const hours = Math.floor(totalMinutes / 60);
                    const minutes = totalMinutes % 60;
                    labels.push(`${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}`);
                }
                return labels;
            };

            const fullTimeLabels = generateTimeLabels();

            // ÂàõÂª∫Êï∞ÊçÆÊò†Â∞Ñ
            const dataMap = new Map();
            [...morningData, ...afternoonData].forEach(item => {
                dataMap.set(item.time, item);
            });

            // Â°´ÂÖÖÂÆåÊï¥ÁöÑÊó∂Èó¥ËΩ¥Êï∞ÊçÆ
            for (let i = 0; i < TOTAL_MINUTES; i++) {
                allTimes.push(i);
                const timeLabel = fullTimeLabels[i];
                timeLabels.push(timeLabel);
                
                const dataItem = dataMap.get(timeLabel);
                if (dataItem) {
                    // ÊúâÂÆûÈôÖÊï∞ÊçÆ
                    allPrices.push(dataItem.price);
                    // ËÆ°ÁÆóÊàê‰∫§È¢ùÔºöÊàê‰∫§Èáè * ‰ª∑Ê†º / 10000 (ËΩ¨Êç¢‰∏∫‰∏áÂÖÉ)
                    const turnover = (dataItem.volume * dataItem.price) / 10000;
                    allVolumes.push(turnover);
                    allVwaps.push(dataItem.vwap);
                    allAvgPrices.push(dataItem.avg_price || dataItem.price);  // Êñ∞Â¢ûÔºöÂùá‰ª∑Á∫øÊï∞ÊçÆ
                } else {
                    // Ê≤°ÊúâÊï∞ÊçÆÁöÑÊó∂Èó¥ÁÇπÔºà‰∏ãÂçàÊú™ÂºÄÂßã‰∫§ÊòìÔºâ
                    allPrices.push(null);
                    allVolumes.push(0);
                    allVwaps.push(null);
                    allAvgPrices.push(null);  // Êñ∞Â¢ûÔºöÂùá‰ª∑Á∫øÊï∞ÊçÆ
                }
            }

            // ËÆ°ÁÆó‰ª∑Ê†ºËåÉÂõ¥Ôºà¬±5%Ôºâ
            const validPrices = allPrices.filter(p => p !== null);
            const firstPrice = validPrices[0];
            const priceRange = firstPrice * 0.05;
            const yMin = firstPrice - priceRange;
            const yMax = firstPrice + priceRange;

            // Âä®ÊÄÅËÆ°ÁÆóYËΩ¥ÂàªÂ∫¶Èó¥Èöî
            let tickInterval;
            if (firstPrice < 5) {
                tickInterval = 0.1;  // 5ÂÖÉ‰ª•‰∏ãÔºå0.1ÂÖÉÈó¥Èöî
            } else if (firstPrice < 20) {
                tickInterval = 0.2;  // 5-20ÂÖÉÔºå0.2ÂÖÉÈó¥Èöî
            } else if (firstPrice < 50) {
                tickInterval = 0.5;  // 20-50ÂÖÉÔºå0.5ÂÖÉÈó¥Èöî
            } else if (firstPrice < 100) {
                tickInterval = 1.0;  // 50-100ÂÖÉÔºå1ÂÖÉÈó¥Èöî
            } else {
                tickInterval = 2.0;  // 100ÂÖÉ‰ª•‰∏äÔºå2ÂÖÉÈó¥Èöî
            }

            // ÂàõÂª∫ÂàÜÊó∂Âõæ
            const priceTrace = {
                x: allTimes,
                y: allPrices,
                type: 'scatter',
                mode: 'lines',
                name: 'ÂàÜÊó∂‰ª∑Ê†º',
                line: {
                    color: '#2196F3',
                    width: 2
                },
                fill: 'tonexty',
                fillcolor: 'rgba(33, 150, 243, 0.1)',
                connectgaps: false, // ‰∏çËøûÊé•nullÂÄºÔºå‰øùÊåÅÂçà‰ºëÊó∂ÊÆµÁöÑÊñ≠ÂºÄ
                hovertemplate: '<b>ÂàÜÊó∂‰ª∑Ê†º</b><br>Êó∂Èó¥: %{text}<br>‰ª∑Ê†º: ¬•%{y:.2f}<extra></extra>',
                text: timeLabels
            };

            const vwapTrace = {
                x: allTimes,
                y: allVwaps,
                type: 'scatter',
                mode: 'lines',
                name: 'VWAPÂùá‰ª∑',
                line: {
                    color: '#FF9800',
                    width: 1,
                    dash: 'dash'
                },
                connectgaps: false, // ‰∏çËøûÊé•nullÂÄº
                hovertemplate: '<b>VWAPÂùá‰ª∑</b><br>Êó∂Èó¥: %{text}<br>‰ª∑Ê†º: ¬•%{y:.2f}<extra></extra>',
                text: timeLabels
            };

            // Êñ∞Â¢ûÔºöÈªÑËâ≤Âùá‰ª∑Á∫ø
            const avgPriceTrace = {
                x: allTimes,
                y: allAvgPrices,
                type: 'scatter',
                mode: 'lines',
                name: 'Âùá‰ª∑Á∫ø',
                line: {
                    color: '#FFD700',  // ÈªÑËâ≤
                    width: 2
                },
                connectgaps: false, // ‰∏çËøûÊé•nullÂÄº
                hovertemplate: '<b>Âùá‰ª∑Á∫ø</b><br>Êó∂Èó¥: %{text}<br>‰ª∑Ê†º: ¬•%{y:.2f}<extra></extra>',
                text: timeLabels
            };

            // ÂàõÂª∫Êó∂Èó¥ËΩ¥ÂàªÂ∫¶ÔºàÂßãÁªàÊòæÁ§∫ÂÆåÊï¥ÁöÑ‰∫§ÊòìÊó∂Èó¥Ê°ÜÊû∂Ôºâ
            const tickvals = [];
            const ticktext = [];
            
            // ‰∏äÂçàÊó∂Èó¥ÁÇπ
            tickvals.push(0); // 09:30 ÂºÄÁõò
            ticktext.push('09:30');
            
            tickvals.push(60); // 10:30 ‰∏äÂçà‰∏≠ÁÇπ
            ticktext.push('10:30');
            
            tickvals.push(MORNING_MINUTES - 1); // 11:30 ‰∏äÂçàÊî∂Áõò
            ticktext.push('11:30');
            
            // ‰∏ãÂçàÊó∂Èó¥ÁÇπ
            tickvals.push(MORNING_MINUTES); // 13:00 ‰∏ãÂçàÂºÄÁõò
            ticktext.push('13:00');
            
            tickvals.push(MORNING_MINUTES + 60); // 14:00 ‰∏ãÂçà‰∏≠ÁÇπ
            ticktext.push('14:00');
            
            tickvals.push(TOTAL_MINUTES - 1); // 15:00 Êî∂Áõò
            ticktext.push('15:00');

            const priceLayout = {
                xaxis: {
                    showgrid: true,
                    gridcolor: '#f0f0f0',
                    tickvals: tickvals,
                    ticktext: ticktext,
                    range: [-0.5, TOTAL_MINUTES - 0.5], // ÂßãÁªàÊòæÁ§∫ÂÆåÊï¥ÁöÑ‰∫§ÊòìÊó∂Èó¥Ê°ÜÊû∂
                    showticklabels: false, // ÈöêËóèÊó∂Èó¥Ê†áÊ≥®
                    zeroline: false
                },
                yaxis: {
                    title: '‰ª∑Ê†º (ÂÖÉ)',
                    showgrid: true,
                    gridcolor: '#f0f0f0',
                    range: [yMin, yMax],
                    tickformat: '.2f',
                    dtick: tickInterval  // ‰ΩøÁî®Âä®ÊÄÅËÆ°ÁÆóÁöÑÂàªÂ∫¶Èó¥Èöî
                },
                plot_bgcolor: 'white',
                paper_bgcolor: 'white',
                font: { family: 'Arial, sans-serif', size: 12 },
                margin: { l: 60, r: 20, t: 50, b: 80 },
                showlegend: true,
                legend: {
                    x: 0,
                    y: 1,
                    bgcolor: 'rgba(255, 255, 255, 0.8)',
                    bordercolor: '#ddd',
                    borderwidth: 1
                }
            };

            const config = {
                displayModeBar: false,
                responsive: true
            };

            // ÁªòÂà∂ÂàÜÊó∂Âõæ
            Plotly.newPlot('intradayChart', [priceTrace, vwapTrace, avgPriceTrace], priceLayout, config);

            // ËÆ°ÁÆóÊàê‰∫§È¢ùÁöÑÊòæÁ§∫ËåÉÂõ¥
            const validVolumes = allVolumes.filter(vol => vol > 0);
            const maxVolume = validVolumes.length > 0 ? Math.max(...validVolumes) : 100;
            const volumeYMax = maxVolume * 1.05; // Âè™Â¢ûÂä†5%ÁöÑ‰∏äËæπË∑ùÔºåËÆ©Êü±Áä∂ÂõæÂç†Áî®Êõ¥Â§öÁ©∫Èó¥

            // ÂàõÂª∫Êàê‰∫§È¢ùÂõæ
            const volumeTrace = {
                x: allTimes,
                y: allVolumes,
                type: 'bar',
                name: 'Êàê‰∫§È¢ù',
                marker: {
                    color: allVolumes.map((vol, index) => {
                        if (index === 0) return '#666';
                        const currentPrice = allPrices[index];
                        const prevPrice = allPrices[index - 1];
                        return currentPrice >= prevPrice ? '#ff4444' : '#00aa00';
                    })
                },
                hovertemplate: '<b>Êàê‰∫§È¢ù</b><br>Êó∂Èó¥: %{text}<br>Êàê‰∫§È¢ù: %{y:.2f}‰∏áÂÖÉ<extra></extra>',
                text: timeLabels
            };

            const volumeLayout = {
                xaxis: {
                    showgrid: true,
                    gridcolor: '#f0f0f0',
                    tickvals: tickvals,
                    ticktext: ticktext,
                    range: [-0.5, TOTAL_MINUTES - 0.5], // ÂßãÁªàÊòæÁ§∫ÂÆåÊï¥ÁöÑ‰∫§ÊòìÊó∂Èó¥Ê°ÜÊû∂
                    showticklabels: false, // ÈöêËóèÊó∂Èó¥Ê†áÊ≥®
                    zeroline: false
                },
                yaxis: {
                    title: 'Êàê‰∫§È¢ù (‰∏áÂÖÉ)',
                    showgrid: true,
                    gridcolor: '#f0f0f0',
                    range: [0, volumeYMax] // ËÆæÁΩÆYËΩ¥ËåÉÂõ¥ÔºåËÆ©Êü±Áä∂ÂõæÊòæÁ§∫ÂæóÊõ¥È´ò
                },
                plot_bgcolor: 'white',
                paper_bgcolor: 'white',
                font: { family: 'Arial, sans-serif', size: 12 },
                margin: { l: 60, r: 20, t: 20, b: 40 }, // ÂáèÂ∞ë‰∏ä‰∏ãËæπË∑ùÔºåËÆ©Êü±Áä∂ÂõæÂç†Áî®Êõ¥Â§öÁ©∫Èó¥
                showlegend: false
            };

            // ÁªòÂà∂Êàê‰∫§ÈáèÂõæ
            Plotly.newPlot('intradayVolumeChart', [volumeTrace], volumeLayout, config);

            // Ê†áËÆ∞ÂõæË°®Ê∏≤ÊüìÂÆåÊàê
            markChartRendered('intradayChart');
            markChartRendered('intradayVolumeChart');

            // ÊòæÁ§∫ÂõæË°®ÔºåÈöêËóèÈîôËØØ‰ø°ÊÅØ
            document.getElementById('intradayChartContainer').style.display = 'block';
            document.getElementById('intradayError').style.display = 'none';
            
            // Êõ¥Êñ∞Êó∂Èó¥Êà≥
            updateIntradayTimestamp();
        }

        // ÊòæÁ§∫/ÈöêËóèÂàÜÊó∂ÂõæÂä†ËΩΩÁä∂ÊÄÅ
        function showIntradayLoading(show) {
            document.getElementById('intradayLoading').style.display = show ? 'block' : 'none';
        }

        // ÊòæÁ§∫ÂàÜÊó∂ÂõæÈîôËØØ
        function showIntradayError(message) {
            document.getElementById('intradayError').textContent = message;
            document.getElementById('intradayError').style.display = 'block';
            document.getElementById('intradayChartContainer').style.display = 'none';
        }

        // Êõ¥Êñ∞ÂàÜÊó∂ÂõæÊó∂Èó¥Êà≥
        function updateIntradayTimestamp() {
            const now = new Date();
            const timestamp = now.toLocaleString('zh-CN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
            document.getElementById('intradayTimestamp').textContent = `Êõ¥Êñ∞Êó∂Èó¥: ${timestamp}`;
        }

        // ÂõæË°®ÂêåÊ≠•Áä∂ÊÄÅË∑üË∏™
        let chartSyncSetup = false;
        let chartRenderStatus = {
            'candlestickChart': false,
            'volumeChart': false,
            'macdChart': false,
            'kdjChart': false,
            'rsiChart': false,
            'intradayChart': false,
            'intradayVolumeChart': false
        };

        // Ê†áËÆ∞ÂõæË°®Ê∏≤ÊüìÂÆåÊàê
        function markChartRendered(chartId) {
            chartRenderStatus[chartId] = true;
            console.log(`ÂõæË°® ${chartId} Ê∏≤ÊüìÂÆåÊàê`);
            
            // Ê£ÄÊü•ÊòØÂê¶ÊâÄÊúâ‰∏ªË¶ÅÂõæË°®ÈÉΩÂ∑≤Ê∏≤ÊüìÂÆåÊàê
            const mainCharts = ['candlestickChart', 'volumeChart', 'intradayChart', 'intradayVolumeChart'];
            const mainChartsReady = mainCharts.every(id => chartRenderStatus[id]);
            
            if (mainChartsReady && !chartSyncSetup) {
                console.log('‰∏ªË¶ÅÂõæË°®ÈÉΩÂ∑≤Ê∏≤ÊüìÂÆåÊàêÔºåÂºÄÂßãÂÆπÂô®Â∞∫ÂØ∏Ê£ÄÊü•ÂíåÂêåÊ≠•ËÆæÁΩÆ');
                
                // Âª∂ËøüÊâßË°åÔºåÁ°Æ‰øùDOMÂÆåÂÖ®Ê∏≤Êüì
                setTimeout(() => {
                    // Ê£ÄÊü•Âπ∂Ë∞ÉÊï¥ÂõæË°®ÂÆπÂô®Â∞∫ÂØ∏
                    ensureChartContainerSizes();
                    
                    // ÂÜçÊ¨°Âª∂ËøüËÆæÁΩÆÂêåÊ≠•Êú∫Âà∂ÔºåÁ°Æ‰øùÂÆπÂô®Â∞∫ÂØ∏Ë∞ÉÊï¥ÂÆåÊàê
                    setTimeout(() => {
                        setupChartSync();
                        
                        // ÊúÄÂêéÂº∫Âà∂ÈáçÊñ∞Â∏ÉÂ±ÄÊâÄÊúâÂõæË°®ÔºåÁ°Æ‰øùÂØπÈΩê
                        setTimeout(() => {
                            forceResizeAllCharts();
                        }, 200);
                    }, 300);
                }, 100);
            }
        }

        // Á°Æ‰øùÂõæË°®ÂÆπÂô®Â∞∫ÂØ∏Ê≠£Á°Æ
        function ensureChartContainerSizes() {
            console.log('Ê£ÄÊü•ÂõæË°®ÂÆπÂô®Â∞∫ÂØ∏');
            
            const chartIds = [
                'candlestickChart', 'volumeChart', 
                'macdChart', 'kdjChart', 'rsiChart',
                'intradayChart', 'intradayVolumeChart'
            ];
            
            chartIds.forEach(chartId => {
                const chartElement = document.getElementById(chartId);
                if (chartElement) {
                    const container = chartElement.parentElement;
                    const containerWidth = container.offsetWidth;
                    const containerHeight = container.offsetHeight;
                    
                    console.log(`ÂõæË°® ${chartId} ÂÆπÂô®Â∞∫ÂØ∏: ${containerWidth}x${containerHeight}`);
                    
                    // Â¶ÇÊûúÂÆπÂô®Â∞∫ÂØ∏‰∏∫0ÊàñËøáÂ∞èÔºåÂº∫Âà∂ËÆæÁΩÆÊúÄÂ∞èÂ∞∫ÂØ∏
                    if (containerWidth < 100) {
                        container.style.width = '100%';
                        console.log(`Âº∫Âà∂ËÆæÁΩÆ ${chartId} ÂÆπÂô®ÂÆΩÂ∫¶‰∏∫100%`);
                    }
                    
                    if (containerHeight < 100) {
                        container.style.height = '300px';
                        console.log(`Âº∫Âà∂ËÆæÁΩÆ ${chartId} ÂÆπÂô®È´òÂ∫¶‰∏∫300px`);
                    }
                }
            });
        }

        // Âº∫Âà∂ÈáçÊñ∞Â∏ÉÂ±ÄÊâÄÊúâÂõæË°®
        function forceResizeAllCharts() {
            console.log('Âº∫Âà∂ÈáçÊñ∞Â∏ÉÂ±ÄÊâÄÊúâÂõæË°®');
            
            const chartIds = [
                'candlestickChart', 'volumeChart', 
                'macdChart', 'kdjChart', 'rsiChart',
                'intradayChart', 'intradayVolumeChart'
            ];
            
            chartIds.forEach(chartId => {
                const chartElement = document.getElementById(chartId);
                if (chartElement && chartElement._fullLayout) {
                    try {
                        // ‰ΩøÁî®PlotlyÁöÑresizeÊñπÊ≥ïÂº∫Âà∂ÈáçÊñ∞ËÆ°ÁÆóÂ∏ÉÂ±Ä
                        Plotly.Plots.resize(chartElement);
                        console.log(`ÂõæË°® ${chartId} ÈáçÊñ∞Â∏ÉÂ±ÄÂÆåÊàê`);
                    } catch (error) {
                        console.warn(`ÂõæË°® ${chartId} ÈáçÊñ∞Â∏ÉÂ±ÄÂ§±Ë¥•:`, error);
                    }
                }
            });
            
            console.log('ÊâÄÊúâÂõæË°®ÈáçÊñ∞Â∏ÉÂ±ÄÂÆåÊàê');
        }

        // ËÆæÁΩÆÂõæË°®ÂêåÊ≠•Êú∫Âà∂
        function setupChartSync() {
            if (chartSyncSetup) {
                console.log('ÂõæË°®ÂêåÊ≠•Êú∫Âà∂Â∑≤ËÆæÁΩÆÔºåË∑≥ËøáÈáçÂ§çËÆæÁΩÆ');
                return;
            }
            
            console.log('ÂºÄÂßãËÆæÁΩÆÂõæË°®ÂêåÊ≠•Êú∫Âà∂');
            
            // Ëé∑ÂèñÊâÄÊúâÂõæË°®ÂÖÉÁ¥†
            const chartIds = [
                'candlestickChart', 'volumeChart', 
                'macdChart', 'kdjChart', 'rsiChart',
                'intradayChart', 'intradayVolumeChart'
            ];
            
            // Ê£ÄÊü•ÂõæË°®ÊòØÂê¶ÂáÜÂ§áÂ∞±Áª™
            const readyCharts = [];
            chartIds.forEach(chartId => {
                const chartElement = document.getElementById(chartId);
                if (chartElement && chartElement._fullLayout) {
                    readyCharts.push(chartId);
                } else {
                    console.warn(`ÂõæË°® ${chartId} Â∞öÊú™ÂáÜÂ§áÂ∞±Áª™`);
                }
            });
            
            console.log(`ÂáÜÂ§áÂ∞±Áª™ÁöÑÂõæË°®: ${readyCharts.join(', ')}`);
            
            if (readyCharts.length < 2) {
                console.log('ÂáÜÂ§áÂ∞±Áª™ÁöÑÂõæË°®Êï∞Èáè‰∏çË∂≥ÔºåÂª∂ËøüÈáçËØï');
                setTimeout(() => {
                    setupChartSync();
                }, 1000);
                return;
            }
            
            // ‰∏∫ÊØè‰∏™ÂáÜÂ§áÂ∞±Áª™ÁöÑÂõæË°®Ê∑ªÂä†Áº©ÊîæÂíåÂπ≥Áßª‰∫ã‰ª∂ÁõëÂê¨Âô®
            readyCharts.forEach(chartId => {
                const chartElement = document.getElementById(chartId);
                
                // ÁßªÈô§‰πãÂâçÁöÑ‰∫ã‰ª∂ÁõëÂê¨Âô®ÔºàÂ¶ÇÊûúÂ≠òÂú®Ôºâ
                if (chartElement._plotlyListeners) {
                    chartElement.removeAllListeners('plotly_relayout');
                }
                
                // ÁõëÂê¨ÂõæË°®ÁöÑÁº©ÊîæÂíåÂπ≥Áßª‰∫ã‰ª∂
                chartElement.on('plotly_relayout', function(eventData) {
                    console.log(`ÂõæË°® ${chartId} ÂèëÁîüÂ∏ÉÂ±ÄÂèòÂåñ:`, eventData);
                    
                    // Ê£ÄÊü•ÊòØÂê¶ÊòØxËΩ¥ËåÉÂõ¥ÂèòÂåñ
                    if (eventData['xaxis.range[0]'] !== undefined && eventData['xaxis.range[1]'] !== undefined) {
                        const newRange = [eventData['xaxis.range[0]'], eventData['xaxis.range[1]']];
                        console.log(`ÂêåÊ≠•xËΩ¥ËåÉÂõ¥Âà∞ÂÖ∂‰ªñÂõæË°®:`, newRange);
                        
                        // ÂêåÊ≠•Âà∞ÂÖ∂‰ªñÂõæË°®
                        readyCharts.forEach(otherChartId => {
                            if (otherChartId !== chartId) {
                                const otherChart = document.getElementById(otherChartId);
                                if (otherChart && otherChart._fullLayout) {
                                    Plotly.relayout(otherChart, {
                                        'xaxis.range': newRange
                                    }).catch(err => {
                                        console.warn(`ÂêåÊ≠•ÂõæË°® ${otherChartId} Â§±Ë¥•:`, err);
                                    });
                                }
                            }
                        });
                    }
                    
                    // Â§ÑÁêÜËá™Âä®Áº©ÊîæÈáçÁΩÆ
                    if (eventData['xaxis.autorange'] === true) {
                        console.log('ÈáçÁΩÆÊâÄÊúâÂõæË°®ÁöÑxËΩ¥ËåÉÂõ¥');
                        readyCharts.forEach(otherChartId => {
                            if (otherChartId !== chartId) {
                                const otherChart = document.getElementById(otherChartId);
                                if (otherChart && otherChart._fullLayout) {
                                    Plotly.relayout(otherChart, {
                                        'xaxis.autorange': true
                                    }).catch(err => {
                                        console.warn(`ÈáçÁΩÆÂõæË°® ${otherChartId} Â§±Ë¥•:`, err);
                                    });
                                }
                            }
                        });
                    }
                });
            });
            
            chartSyncSetup = true;
            console.log('ÂõæË°®ÂêåÊ≠•Êú∫Âà∂ËÆæÁΩÆÂÆåÊàê');
        }

        // Âº∫Âà∂ÈáçÊñ∞ËÆæÁΩÆÂõæË°®ÂêåÊ≠•ÔºàÁî®‰∫éÂà∑Êñ∞ÊåâÈíÆÔºâ
        function forceSetupChartSync() {
            console.log('Âº∫Âà∂ÈáçÊñ∞ËÆæÁΩÆÂõæË°®ÂêåÊ≠•Êú∫Âà∂');
            chartSyncSetup = false;
            setupChartSync();
        }

        // ==================== ÂàÜÊó∂ÂõæÁõ∏ÂÖ≥ÂáΩÊï∞ÁªìÊùü ====================

        // ÊòæÁ§∫ÊåáÊ†áÈîôËØØ
        function showIndicatorError(message) {
            console.error('ÊòæÁ§∫ÊäÄÊúØÊåáÊ†áÈîôËØØ:', message);
            
            // Âú®ÊØè‰∏™ÊåáÊ†áÂõæË°®ÂÆπÂô®‰∏≠ÊòæÁ§∫ÈîôËØØ‰ø°ÊÅØ
            const chartIds = ['macdChart', 'kdjChart', 'rsiChart'];
            chartIds.forEach(chartId => {
                const chartElement = document.getElementById(chartId);
                if (chartElement) {
                    chartElement.innerHTML = `<div style="padding: 20px; text-align: center; color: #dc3545; border: 1px solid #f5c6cb; background-color: #f8d7da; border-radius: 4px;">${message}</div>`;
                }
            });
        }

        // Ëá™Âä®Âà∑Êñ∞Áõ∏ÂÖ≥ÂèòÈáè
        let autoRefreshInterval = null;
        let autoRefreshEnabled = true;
        let marketCheckInterval = null;
        const AUTO_REFRESH_INTERVAL = 10000; // 10Áßí
        const MARKET_CHECK_INTERVAL = 300000; // 5ÂàÜÈíüÊ£ÄÊü•‰∏ÄÊ¨°Â∏ÇÂú∫Áä∂ÊÄÅ

        // Ê£ÄÊü•Â∏ÇÂú∫Áä∂ÊÄÅ
        function checkMarketStatus() {
            return fetch('/api/market/status')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        console.log('Â∏ÇÂú∫Áä∂ÊÄÅÊ£ÄÊü•:', data.is_market_open ? 'ÂºÄÁõò' : 'Êî∂Áõò', 'Êó∂Èó¥:', data.current_time);
                        return data.is_market_open;
                    }
                    return false;
                })
                .catch(error => {
                    console.error('Ê£ÄÊü•Â∏ÇÂú∫Áä∂ÊÄÅÂ§±Ë¥•:', error);
                    return false;
                });
        }

        // ÂêØÂä®Ëá™Âä®Âà∑Êñ∞ÔºàÂ∏¶‰∫§ÊòìÊó∂Èó¥Ê£ÄÊü•Ôºâ
        function startAutoRefresh() {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
            }
            
            if (!autoRefreshEnabled) {
                console.log('Ëá™Âä®Âà∑Êñ∞Â∑≤Á¶ÅÁî®');
                return;
            }
            
            // ÂÖàÊ£ÄÊü•Â∏ÇÂú∫Áä∂ÊÄÅ
            checkMarketStatus().then(isMarketOpen => {
                if (isMarketOpen) {
                    console.log('‰∫§ÊòìÊó∂Èó¥ÂÜÖÔºåÂêØÂä®Ëá™Âä®Âà∑Êñ∞ÔºåÈó¥Èöî:', AUTO_REFRESH_INTERVAL / 1000, 'Áßí');
                    
                    autoRefreshInterval = setInterval(async () => {
                        if (!autoRefreshEnabled) {
                            console.log('Ëá™Âä®Âà∑Êñ∞Â∑≤Á¶ÅÁî®ÔºåÂÅúÊ≠¢Âà∑Êñ∞');
                            clearInterval(autoRefreshInterval);
                            return;
                        }
                        
                        // ÊØèÊ¨°Âà∑Êñ∞ÂâçÊ£ÄÊü•Â∏ÇÂú∫Áä∂ÊÄÅ
                        const stillOpen = await checkMarketStatus();
                        if (!stillOpen) {
                            console.log('Â∏ÇÂú∫Â∑≤Êî∂ÁõòÔºåÂÅúÊ≠¢Ëá™Âä®Âà∑Êñ∞');
                            clearInterval(autoRefreshInterval);
                            autoRefreshInterval = null;
                            updateAutoRefreshButtonState(false);
                            return;
                        }
                        
                        try {
                            console.log('Ëá™Âä®Âà∑Êñ∞: ÂºÄÂßãÊõ¥Êñ∞ÂÆûÊó∂Êï∞ÊçÆÂíåÂàÜÊó∂Âõæ');
                            
                            // Âπ∂Ë°åÂà∑Êñ∞ÂÆûÊó∂‰∫§ÊòìÊï∞ÊçÆÂíåÂàÜÊó∂Âõæ
                            // Ëá™Âä®Âà∑Êñ∞Êó∂‰∏çÊòæÁ§∫Âä†ËΩΩÁä∂ÊÄÅÔºåÈÅøÂÖçÊï∞ÊçÆÊ∂àÂ§±
                            await Promise.all([
                                loadRealtimeData(false),
                                loadIntradayChart(false)
                            ]);
                            
                            console.log('Ëá™Âä®Âà∑Êñ∞: Êï∞ÊçÆÊõ¥Êñ∞ÂÆåÊàê');
                            updateLastRefreshTime();
                            
                        } catch (error) {
                            console.error('Ëá™Âä®Âà∑Êñ∞Â§±Ë¥•:', error);
                        }
                    }, AUTO_REFRESH_INTERVAL);
                    
                    updateAutoRefreshButtonState(true);
                } else {
                    console.log('Èùû‰∫§ÊòìÊó∂Èó¥Ôºå‰∏çÂêØÂä®Ëá™Âä®Âà∑Êñ∞');
                    updateAutoRefreshButtonState(false);
                }
            });
        }

        // ÂêØÂä®Â∏ÇÂú∫Áä∂ÊÄÅÁõëÊéß
        function startMarketStatusMonitor() {
            if (marketCheckInterval) {
                clearInterval(marketCheckInterval);
            }
            
            marketCheckInterval = setInterval(() => {
                if (!autoRefreshInterval && autoRefreshEnabled) {
                    checkMarketStatus().then(isMarketOpen => {
                        if (isMarketOpen) {
                            console.log('Ê£ÄÊµãÂà∞Â∏ÇÂú∫ÂºÄÁõòÔºåÂêØÂä®Ëá™Âä®Âà∑Êñ∞');
                            startAutoRefresh();
                        }
                    });
                }
            }, MARKET_CHECK_INTERVAL);
        }

        // Êõ¥Êñ∞Ëá™Âä®Âà∑Êñ∞ÊåâÈíÆÁä∂ÊÄÅ
        function updateAutoRefreshButtonState(isActive) {
            const toggleBtn = document.getElementById('autoRefreshToggle');
            const chartToggleBtn = document.getElementById('chartAutoRefreshToggle');
            
            if (isActive) {
                if (toggleBtn) {
                    toggleBtn.textContent = 'ÂÅúÊ≠¢Ëá™Âä®Âà∑Êñ∞';
                    toggleBtn.style.backgroundColor = '#dc3545';
                }
                if (chartToggleBtn) {
                    chartToggleBtn.textContent = 'ÂÅúÊ≠¢Ëá™Âä®Âà∑Êñ∞';
                    chartToggleBtn.style.backgroundColor = '#dc3545';
                }
            } else {
                if (toggleBtn) {
                    toggleBtn.textContent = 'ÂêØÂä®Ëá™Âä®Âà∑Êñ∞';
                    toggleBtn.style.backgroundColor = '#28a745';
                }
                if (chartToggleBtn) {
                    chartToggleBtn.textContent = 'ÂêØÂä®Ëá™Âä®Âà∑Êñ∞';
                    chartToggleBtn.style.backgroundColor = '#28a745';
                }
            }
        }

        // ÂÅúÊ≠¢Ëá™Âä®Âà∑Êñ∞
        function stopAutoRefresh() {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
                autoRefreshInterval = null;
                console.log('Ëá™Âä®Âà∑Êñ∞Â∑≤ÂÅúÊ≠¢');
            }
        }

        // ÂàáÊç¢Ëá™Âä®Âà∑Êñ∞Áä∂ÊÄÅ
        function toggleAutoRefresh() {
            autoRefreshEnabled = !autoRefreshEnabled;
            
            if (autoRefreshEnabled) {
                startAutoRefresh();
                console.log('Ëá™Âä®Âà∑Êñ∞Â∑≤ÂêØÁî®');
            } else {
                stopAutoRefresh();
                updateAutoRefreshButtonState(false);
                console.log('Ëá™Âä®Âà∑Êñ∞Â∑≤Á¶ÅÁî®');
            }
        }

        // Êõ¥Êñ∞ÊúÄÂêéÂà∑Êñ∞Êó∂Èó¥ÊòæÁ§∫
        function updateLastRefreshTime() {
            const now = new Date();
            const timeStr = now.toLocaleTimeString('zh-CN', { 
                hour12: false,
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
            
            // Êõ¥Êñ∞ÂÆûÊó∂‰∫§ÊòìÊï∞ÊçÆÁöÑÂà∑Êñ∞Êó∂Èó¥
            const refreshTimeElement = document.getElementById('lastRefreshTime');
            if (refreshTimeElement) {
                refreshTimeElement.textContent = `ÊúÄÂêéÊõ¥Êñ∞: ${timeStr}`;
            }
            
            // Êõ¥Êñ∞ÂàÜÊó∂ÂõæÁöÑÂà∑Êñ∞Êó∂Èó¥
            const chartRefreshTimeElement = document.getElementById('lastChartRefreshTime');
            if (chartRefreshTimeElement) {
                chartRefreshTimeElement.textContent = `ÊúÄÂêéÊõ¥Êñ∞: ${timeStr}`;
            }
        }

        // ==================== ËÇ°Á•®Êìç‰ΩúÊåâÈíÆÁõ∏ÂÖ≥ÂáΩÊï∞ ====================
        
        // Ê£ÄÊü•ËÇ°Á•®ÊòØÂê¶Âú®Ëá™ÈÄâÂàóË°®‰∏≠
        function checkWatchlistStatus() {
            const stockCode = getStockCodeFromUrl();
            if (!stockCode) return;
            
            // ÊûÑÈÄ†ts_codeÔºà6‰ΩçËÇ°Á•®‰ª£Á†Å + ‰∫§ÊòìÊâÄÂêéÁºÄÔºâ
            const tsCode = stockCode.startsWith('6') ? `${stockCode}.SH` : `${stockCode}.SZ`;
            
            // ‰ªéÂêéÁ´ØAPIÊ£ÄÊü•Ëá™ÈÄâËÇ°Áä∂ÊÄÅ
            fetch('/api/watchlist/check', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    ts_code: tsCode
                })
            })
            .then(response => response.json())
            .then(data => {
                const addBtn = document.getElementById('addToWatchlistBtn');
                const removeBtn = document.getElementById('removeFromWatchlistBtn');
                
                // ÊâÄÊúâÊåâÈíÆÈÉΩÊòæÁ§∫
                if (addBtn) addBtn.style.display = 'flex';
                if (removeBtn) removeBtn.style.display = 'flex';
                
                // Ê†πÊçÆÊòØÂê¶Âú®Ëá™ÈÄâÂàóË°®‰∏≠Êõ¥Êñ∞ÊåâÈíÆÊñáÊú¨ÂíåÊ†∑Âºè
                if (data.in_watchlist) {
                    if (addBtn) {
                        addBtn.innerHTML = '<span>‚úì</span><span>Â∑≤Âä†ÂÖ•Ëá™ÈÄâÔºàÈáçÁÇπÂÖ≥Ê≥®Ôºâ</span>';
                        addBtn.className = 'action-btn btn-added';
                    }
                } else {
                    if (addBtn) {
                        addBtn.innerHTML = '<span>+</span><span>Âä†ÂÖ•Ëá™ÈÄâ</span>';
                        addBtn.className = 'action-btn btn-add';
                    }
                }
                
                // ÂêåÊó∂Êõ¥Êñ∞localStorage‰ª•‰øùÊåÅÂÖºÂÆπÊÄß
                let watchlist = JSON.parse(localStorage.getItem('stockWatchlist') || '[]');
                const index = watchlist.indexOf(stockCode);
                
                if (data.in_watchlist && index === -1) {
                    // ÂêéÁ´ØÊúâ‰ΩÜlocalStorageÊ≤°ÊúâÔºåÊ∑ªÂä†Âà∞localStorage
                    watchlist.push(stockCode);
                    localStorage.setItem('stockWatchlist', JSON.stringify(watchlist));
                } else if (!data.in_watchlist && index > -1) {
                    // ÂêéÁ´ØÊ≤°Êúâ‰ΩÜlocalStorageÊúâÔºå‰ªélocalStorageÂà†Èô§
                    watchlist.splice(index, 1);
                    localStorage.setItem('stockWatchlist', JSON.stringify(watchlist));
                }
            })
            .catch(error => {
                console.error('Ê£ÄÊü•Ëá™ÈÄâËÇ°Áä∂ÊÄÅÂ§±Ë¥•:', error);
                // Â¶ÇÊûúAPIË∞ÉÁî®Â§±Ë¥•ÔºåÂõûÈÄÄÂà∞localStorageÊ£ÄÊü•
                const watchlist = JSON.parse(localStorage.getItem('stockWatchlist') || '[]');
                const isInWatchlist = watchlist.includes(stockCode);
                
                const addBtn = document.getElementById('addToWatchlistBtn');
                const removeBtn = document.getElementById('removeFromWatchlistBtn');
                
                // ÊâÄÊúâÊåâÈíÆÈÉΩÊòæÁ§∫
                if (addBtn) addBtn.style.display = 'flex';
                if (removeBtn) removeBtn.style.display = 'flex';
                
                // Ê†πÊçÆÊòØÂê¶Âú®Ëá™ÈÄâÂàóË°®‰∏≠Êõ¥Êñ∞ÊåâÈíÆÊñáÊú¨ÂíåÊ†∑Âºè
                if (isInWatchlist) {
                    if (addBtn) {
                        addBtn.innerHTML = '<span>‚úì</span><span>Â∑≤Âä†ÂÖ•Ëá™ÈÄâÔºàÈáçÁÇπÂÖ≥Ê≥®Ôºâ</span>';
                        addBtn.className = 'action-btn btn-added';
                    }
                } else {
                    if (addBtn) {
                        addBtn.innerHTML = '<span>+</span><span>Âä†ÂÖ•Ëá™ÈÄâ</span>';
                        addBtn.className = 'action-btn btn-add';
                    }
                }
            });
        }
        
        // Ëé∑ÂèñÂΩìÂâçËÇ°Á•®‰ø°ÊÅØ
        function getCurrentStockInfo() {
            // ‰ªéÈ°µÈù¢ÂÖÉÁ¥†‰∏≠Ëé∑ÂèñËÇ°Á•®‰ø°ÊÅØ
            const stockInfo = {
                name: '',
                latest_price: 0,
                pct_chg: 0,
                industry: '-',
                volume_ratio: 0,
                pe: 0,
                amount: 0,
                total_mv: 0,
                nine_turn_up: 0,
                nine_turn_down: 0
            };
            
            try {
                // ‰ªéÈ°µÈù¢Ê†áÈ¢òËé∑ÂèñËÇ°Á•®ÂêçÁß∞
                const titleElement = document.querySelector('.stock-title h1');
                if (titleElement) {
                    const titleText = titleElement.textContent;
                    const match = titleText.match(/^(.+?)\s*\(/);
                    if (match) {
                        stockInfo.name = match[1].trim();
                    }
                }
                
                // ‰ªéÂÆûÊó∂Êï∞ÊçÆËé∑Âèñ‰ª∑Ê†º‰ø°ÊÅØ
                if (window.realtimeData) {
                    stockInfo.latest_price = parseFloat(window.realtimeData.current_price) || 0;
                    stockInfo.pct_chg = parseFloat(window.realtimeData.change_percent) || 0;
                    stockInfo.volume_ratio = parseFloat(window.realtimeData.volume_ratio) || 0;
                    stockInfo.amount = parseFloat(window.realtimeData.amount) || 0;
                }
                
                // ‰ªéÂü∫Êú¨‰ø°ÊÅØËé∑ÂèñÂÖ∂‰ªñÊï∞ÊçÆ
                if (window.stockData) {
                    stockInfo.industry = window.stockData.industry || '-';
                    stockInfo.pe = parseFloat(window.stockData.pe_ttm) || 0;
                    stockInfo.total_mv = parseFloat(window.stockData.total_mv) || 0;
                }
                
                // ‰ªéÊäÄÊúØÊåáÊ†áËé∑Âèñ‰πùËΩ¨Â∫èÂàóÊï∞ÊçÆ
                if (window.indicatorData) {
                    stockInfo.nine_turn_up = parseInt(window.indicatorData.nine_turn_up) || 0;
                    stockInfo.nine_turn_down = parseInt(window.indicatorData.nine_turn_down) || 0;
                }
                
            } catch (error) {
                console.error('Ëé∑ÂèñËÇ°Á•®‰ø°ÊÅØÂ§±Ë¥•:', error);
            }
            
            return stockInfo;
        }

        // Ê∑ªÂä†Âà∞Ëá™ÈÄâ
        function addToWatchlist() {
            const stockCode = getStockCodeFromUrl();
            if (!stockCode) {
                alert('Êó†Ê≥ïËé∑ÂèñËÇ°Á•®‰ª£Á†Å');
                return;
            }
            
            // Ëé∑ÂèñÂΩìÂâçËÇ°Á•®‰ø°ÊÅØ
            const stockInfo = getCurrentStockInfo();
            
            // ÊûÑÈÄ†ts_codeÔºà6‰ΩçËÇ°Á•®‰ª£Á†Å + ‰∫§ÊòìÊâÄÂêéÁºÄÔºâ
            const tsCode = stockCode.startsWith('6') ? `${stockCode}.SH` : `${stockCode}.SZ`;
            
            // Ë∞ÉÁî®ÂêéÁ´ØAPIÊ∑ªÂä†Âà∞Ëá™ÈÄâËÇ°
            fetch('/api/watchlist/add', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    ts_code: tsCode,
                    name: stockInfo.name || '',
                    latest_price: stockInfo.latest_price || 0,
                    pct_chg: stockInfo.pct_chg || 0,
                    industry: stockInfo.industry || '-',
                    volume_ratio: stockInfo.volume_ratio || 0,
                    pe: stockInfo.pe || 0,
                    amount: stockInfo.amount || 0,
                    total_mv: stockInfo.total_mv || 0,
                    nine_turn_up: stockInfo.nine_turn_up || 0,
                    nine_turn_down: stockInfo.nine_turn_down || 0,
                    priority: 'green',  // ÈªòËÆ§ÁªøËâ≤‰ºòÂÖàÁ∫ß
                    note: '',  // ÈªòËÆ§Â§áÊ≥®‰∏∫Á©∫
                    add_time: new Date().toISOString()
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // ÂêåÊó∂Êõ¥Êñ∞localStorage‰ª•‰øùÊåÅÂÖºÂÆπÊÄß
                    let watchlist = JSON.parse(localStorage.getItem('stockWatchlist') || '[]');
                    if (!watchlist.includes(stockCode)) {
                        watchlist.push(stockCode);
                        localStorage.setItem('stockWatchlist', JSON.stringify(watchlist));
                    }
                    
                    // Êõ¥Êñ∞ÊåâÈíÆÊòæÁ§∫Áä∂ÊÄÅ
                    checkWatchlistStatus();
                    
                    // ÊòæÁ§∫ÊàêÂäüÊèêÁ§∫
                    showNotification('Â∑≤Ê∑ªÂä†Âà∞Ëá™ÈÄâËÇ°Á•®', 'success');
                    console.log('ËÇ°Á•®Â∑≤Ê∑ªÂä†Âà∞Ëá™ÈÄâ:', stockCode);
                } else {
                    showNotification(data.message || 'Ê∑ªÂä†Â§±Ë¥•', 'error');
                }
            })
            .catch(error => {
                console.error('Ê∑ªÂä†Ëá™ÈÄâËÇ°Â§±Ë¥•:', error);
                showNotification('Ê∑ªÂä†Â§±Ë¥•ÔºåËØ∑Á®çÂêéÈáçËØï', 'error');
            });
        }
        
        // ‰ªéËá™ÈÄâ‰∏≠Âà†Èô§
        function removeFromWatchlist() {
            const stockCode = getStockCodeFromUrl();
            if (!stockCode) {
                alert('Êó†Ê≥ïËé∑ÂèñËÇ°Á•®‰ª£Á†Å');
                return;
            }
            
            // Á°ÆËÆ§Âà†Èô§
            if (!confirm('Á°ÆÂÆöË¶Å‰ªéËá™ÈÄâËÇ°Á•®‰∏≠Âà†Èô§ÂêóÔºü')) {
                return;
            }
            
            // ÊûÑÈÄ†ts_codeÔºà6‰ΩçËÇ°Á•®‰ª£Á†Å + ‰∫§ÊòìÊâÄÂêéÁºÄÔºâ
            const tsCode = stockCode.startsWith('6') ? `${stockCode}.SH` : `${stockCode}.SZ`;
            
            // Ë∞ÉÁî®ÂêéÁ´ØAPI‰ªéËá™ÈÄâËÇ°‰∏≠Âà†Èô§
            fetch('/api/watchlist/remove', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    ts_code: tsCode
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // ÂêåÊó∂Êõ¥Êñ∞localStorage‰ª•‰øùÊåÅÂÖºÂÆπÊÄß
                    let watchlist = JSON.parse(localStorage.getItem('stockWatchlist') || '[]');
                    const index = watchlist.indexOf(stockCode);
                    if (index > -1) {
                        watchlist.splice(index, 1);
                        localStorage.setItem('stockWatchlist', JSON.stringify(watchlist));
                    }
                    
                    // Êõ¥Êñ∞ÊåâÈíÆÊòæÁ§∫Áä∂ÊÄÅ
                    checkWatchlistStatus();
                    
                    // ÊòæÁ§∫ÊàêÂäüÊèêÁ§∫
                    showNotification('Â∑≤‰ªéËá™ÈÄâËÇ°Á•®‰∏≠Âà†Èô§', 'success');
                    console.log('ËÇ°Á•®Â∑≤‰ªéËá™ÈÄâ‰∏≠Âà†Èô§:', stockCode);
                } else {
                    showNotification(data.message || 'Âà†Èô§Â§±Ë¥•', 'error');
                }
            })
            .catch(error => {
                console.error('Âà†Èô§Ëá™ÈÄâËÇ°Â§±Ë¥•:', error);
                showNotification('Âà†Èô§Â§±Ë¥•ÔºåËØ∑Á®çÂêéÈáçËØï', 'error');
            });
        }
        
        // Âà∑Êñ∞ÊâÄÊúâÊï∞ÊçÆ
        function refreshAllData() {
            const refreshBtn = document.getElementById('refreshDataBtn');
            
            // Á¶ÅÁî®ÊåâÈíÆÔºåÈò≤Ê≠¢ÈáçÂ§çÁÇπÂáª
            refreshBtn.disabled = true;
            refreshBtn.innerHTML = '<span>üîÑ</span><span>Âà∑Êñ∞‰∏≠...</span>';
            
            console.log('ÂºÄÂßãÂà∑Êñ∞ÊâÄÊúâÊï∞ÊçÆ');
            
            // Âπ∂Ë°åÂà∑Êñ∞ÊâÄÊúâÊï∞ÊçÆ
            Promise.all([
                loadStockData(),
                loadRealtimeData(true),
                loadIntradayChart(true),
                loadIndicatorData()
            ]).then(() => {
                console.log('ÊâÄÊúâÊï∞ÊçÆÂà∑Êñ∞ÂÆåÊàê');
                showNotification('Êï∞ÊçÆÂà∑Êñ∞ÂÆåÊàê', 'success');
                updateLastRefreshTime();
            }).catch(error => {
                console.error('Êï∞ÊçÆÂà∑Êñ∞Â§±Ë¥•:', error);
                showNotification('Êï∞ÊçÆÂà∑Êñ∞Â§±Ë¥•ÔºåËØ∑Á®çÂêéÈáçËØï', 'error');
            }).finally(() => {
                // ÊÅ¢Â§çÊåâÈíÆÁä∂ÊÄÅ
                refreshBtn.disabled = false;
                refreshBtn.innerHTML = '<span>üîÑ</span><span>Âà∑Êñ∞Êï∞ÊçÆ</span>';
            });
        }
        
        // ÊòæÁ§∫ÈÄöÁü•Ê∂àÊÅØ
        function showNotification(message, type = 'info') {
            // ÂàõÂª∫ÈÄöÁü•ÂÖÉÁ¥†
            const notification = document.createElement('div');
            notification.className = `notification notification-${type}`;
            notification.textContent = message;
            
            // Ê∑ªÂä†Ê†∑Âºè
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 12px 20px;
                border-radius: 6px;
                color: white;
                font-weight: 500;
                z-index: 10000;
                opacity: 0;
                transform: translateX(100%);
                transition: all 0.3s ease;
            `;
            
            // Ê†πÊçÆÁ±ªÂûãËÆæÁΩÆËÉåÊôØËâ≤
            switch (type) {
                case 'success':
                    notification.style.backgroundColor = '#28a745';
                    break;
                case 'error':
                    notification.style.backgroundColor = '#dc3545';
                    break;
                case 'info':
                default:
                    notification.style.backgroundColor = '#007bff';
                    break;
            }
            
            // Ê∑ªÂä†Âà∞È°µÈù¢
            document.body.appendChild(notification);
            
            // ÊòæÁ§∫Âä®Áîª
            setTimeout(() => {
                notification.style.opacity = '1';
                notification.style.transform = 'translateX(0)';
            }, 10);
            
            // 3ÁßíÂêéËá™Âä®ÈöêËóè
            setTimeout(() => {
                notification.style.opacity = '0';
                notification.style.transform = 'translateX(100%)';
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 300);
            }, 3000);
        }
        
        // ‰ªéURLËé∑ÂèñËÇ°Á•®‰ª£Á†Å
        function getStockCodeFromUrl() {
            const pathParts = window.location.pathname.split('/');
            return pathParts[pathParts.length - 1] || null;
        }
        
        // ==================== ËÇ°Á•®Êìç‰ΩúÊåâÈíÆÁõ∏ÂÖ≥ÂáΩÊï∞ÁªìÊùü ====================

        // È°µÈù¢Âä†ËΩΩÊó∂Ëá™Âä®Âä†ËΩΩÊï∞ÊçÆ
        window.onload = function() {
            console.log('È°µÈù¢Âä†ËΩΩÂÆåÊàêÔºåÂºÄÂßãÂàùÂßãÂåñ');
            
            // Ê£ÄÊü•Ëá™ÈÄâÁä∂ÊÄÅ
            checkWatchlistStatus();
            
            loadStockData();
            // Âª∂ËøüÂä†ËΩΩÊäÄÊúØÊåáÊ†áÊï∞ÊçÆÔºåÈÅøÂÖçÂêåÊó∂ËØ∑Ê±ÇËøáÂ§öAPI
            console.log('ËÆæÁΩÆÊäÄÊúØÊåáÊ†áÊï∞ÊçÆÂª∂ËøüÂä†ËΩΩ');
            setTimeout(() => {
                console.log('ÂºÄÂßãÂª∂ËøüÂä†ËΩΩÊäÄÊúØÊåáÊ†áÊï∞ÊçÆ');
                loadIndicatorData();
            }, 1000);
            
            // ÂêØÂä®Ëá™Âä®Âà∑Êñ∞Ôºà‰ºöÊ£ÄÊü•‰∫§ÊòìÊó∂Èó¥Ôºâ
            setTimeout(() => {
                startAutoRefresh();
                updateLastRefreshTime();
            }, 2000);
            
            // ÂêØÂä®Â∏ÇÂú∫Áä∂ÊÄÅÁõëÊéß
            setTimeout(() => {
                startMarketStatusMonitor();
            }, 3000);
        };

        // È°µÈù¢ÈöêËóèÊó∂ÂÅúÊ≠¢Ëá™Âä®Âà∑Êñ∞ÔºåÈ°µÈù¢ÊòæÁ§∫Êó∂ÈáçÊñ∞ÂêØÂä®
        document.addEventListener('visibilitychange', function() {
            if (document.hidden) {
                console.log('È°µÈù¢ÈöêËóèÔºåÂÅúÊ≠¢Ëá™Âä®Âà∑Êñ∞');
                stopAutoRefresh();
            } else {
                console.log('È°µÈù¢ÊòæÁ§∫ÔºåÈáçÊñ∞ÂêØÂä®Ëá™Âä®Âà∑Êñ∞');
                if (autoRefreshEnabled) {
                    startAutoRefresh();
                }
            }
        });

        // Ê∑ªÂä†Á™óÂè£resize‰∫ã‰ª∂ÁõëÂê¨Âô®
        let resizeTimeout;
        window.addEventListener('resize', function() {
            // Èò≤ÊäñÂ§ÑÁêÜÔºåÈÅøÂÖçÈ¢ëÁπÅËß¶Âèë
            clearTimeout(resizeTimeout);
            resizeTimeout = setTimeout(() => {
                console.log('Á™óÂè£Â§ßÂ∞èÂèòÂåñÔºåÈáçÊñ∞Â∏ÉÂ±ÄÂõæË°®');
                
                // ÈáçÊñ∞Ê£ÄÊü•ÂÆπÂô®Â∞∫ÂØ∏
                ensureChartContainerSizes();
                
                // Âª∂ËøüÈáçÊñ∞Â∏ÉÂ±ÄÂõæË°®
                setTimeout(() => {
                    forceResizeAllCharts();
                    
                    // ÈáçÊñ∞ËÆæÁΩÆÂõæË°®ÂêåÊ≠•Êú∫Âà∂
                    setTimeout(() => {
                        forceSetupChartSync();
                    }, 200);
                }, 100);
            }, 300);
        });
    </script>
</body>
</html>