<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>股票详情 - 每日指标</title>
    <script src="https://cdn.plot.ly/plotly-2.35.2.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', sans-serif;
            background-color: #f8f9fa;
            color: #333;
            line-height: 1.4;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .stock-header {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .stock-info {
            display: flex;
            align-items: center;
            gap: 20px;
            flex: 1;
        }

        .stock-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 10px;
        }

        .stock-actions-left {
            display: flex;
            gap: 10px;
        }

        .stock-actions-right {
            display: flex;
            gap: 10px;
        }

        .action-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 6px;
            min-width: 120px;
            justify-content: center;
        }

        .action-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .action-btn:active {
            transform: translateY(0);
        }

        .btn-added {
            background: #28a745;
            color: white;
        }

        .btn-added:hover {
            background: #218838;
        }

        .btn-add {
            background: #007bff;
            color: white;
        }

        .btn-add:hover {
            background: #0056b3;
        }

        .btn-remove {
            background: #dc3545;
            color: white;
        }

        .btn-remove:hover {
            background: #c82333;
        }

        .btn-refresh {
            background: #28a745;
            color: white;
        }

        .btn-refresh:hover {
            background: #218838;
        }

        .btn-refresh:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
        }

        .stock-name {
            font-size: 18px;
            font-weight: 600;
            color: #333;
        }

        .stock-code {
            font-size: 14px;
            color: #666;
        }

        .stock-price {
            font-size: 32px;
            font-weight: 700;
            color: #e74c3c;
        }

        .price-change {
            display: flex;
            gap: 10px;
            align-items: center;
            font-size: 14px;
        }

        .change-amount {
            color: #e74c3c;
        }

        .change-percent {
            color: #e74c3c;
        }

        .indicators-section {
            background: white;
            border-radius: 8px;
            padding: 0;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .indicators-header {
            background: #f8f9fa;
            padding: 15px 20px;
            border-bottom: 1px solid #e9ecef;
            font-weight: 600;
            color: #495057;
        }

        .indicators-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            border-bottom: 1px solid #e9ecef;
        }

        .indicator-item {
            padding: 15px 10px;
            text-align: center;
            border-right: 1px solid #e9ecef;
            transition: background-color 0.2s ease;
        }

        .indicator-item:last-child {
            border-right: none;
        }

        .indicator-item:hover {
            background-color: #f8f9fa;
        }

        .indicator-label {
            font-size: 12px;
            color: #6c757d;
            margin-bottom: 5px;
            line-height: 1.2;
        }

        .indicator-value {
            font-size: 14px;
            font-weight: 600;
            color: #212529;
            line-height: 1.2;
        }

        .positive {
            color: #28a745;
        }

        .negative {
            color: #dc3545;
        }

        .neutral {
            color: #6c757d;
        }

        /* 实时交易数据样式 */
        .realtime-section {
            background: white;
            border-radius: 8px;
            padding: 0;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
            overflow: hidden;
        }

        .realtime-header {
            background: #f8f9fa;
            padding: 15px 20px;
            border-bottom: 1px solid #e9ecef;
            font-weight: 600;
            color: #495057;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .realtime-refresh-btn {
            padding: 6px 12px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s ease;
        }

        .realtime-refresh-btn:hover {
            background: #0056b3;
        }

        .realtime-refresh-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }

        .realtime-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 0;
            border-bottom: 1px solid #e9ecef;
        }

        .realtime-item {
            padding: 12px 10px;
            text-align: center;
            border-right: 1px solid #e9ecef;
            transition: background-color 0.2s ease;
        }

        .realtime-item:last-child {
            border-right: none;
        }

        .realtime-item:hover {
            background-color: #f8f9fa;
        }

        .realtime-label {
            font-size: 11px;
            color: #6c757d;
            margin-bottom: 4px;
            line-height: 1.2;
        }

        .realtime-value {
            font-size: 13px;
            font-weight: 600;
            color: #212529;
            line-height: 1.2;
        }

        .realtime-loading {
            text-align: center;
            padding: 20px;
            color: #666;
            font-size: 14px;
        }

        .realtime-error {
            background: #f8d7da;
            color: #721c24;
            padding: 15px 20px;
            border: 1px solid #f5c6cb;
            margin: 0;
            font-size: 14px;
        }

        /* 资金流向数据样式 - 优化紧凑版 */
        .moneyflow-section {
            background: white;
            border-radius: 6px;
            padding: 0;
            box-shadow: 0 1px 4px rgba(0, 0, 0, 0.08);
            margin-bottom: 15px;
            overflow: hidden;
        }

        .moneyflow-header {
            background: #f8f9fa;
            padding: 10px 15px;
            border-bottom: 1px solid #e9ecef;
            font-weight: 600;
            color: #495057;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 14px;
        }

        .moneyflow-refresh-btn {
            padding: 4px 8px;
            background: #28a745;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 11px;
            transition: all 0.2s ease;
        }

        .moneyflow-refresh-btn:hover {
            background: #218838;
        }

        .moneyflow-refresh-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }

        .moneyflow-loading {
            text-align: center;
            padding: 15px;
            color: #666;
            font-size: 13px;
        }

        .moneyflow-error {
            background: #f8d7da;
            color: #721c24;
            padding: 10px 15px;
            border: 1px solid #f5c6cb;
            margin: 0;
            font-size: 13px;
        }

        .moneyflow-grid {
            padding: 12px;
        }

        .moneyflow-summary {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-bottom: 15px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 4px;
            border: 1px solid #e9ecef;
        }

        .moneyflow-summary-item {
            text-align: center;
        }

        .moneyflow-summary-label {
            font-size: 11px;
            color: #6c757d;
            margin-bottom: 4px;
            font-weight: 500;
        }

        .moneyflow-summary-value {
            font-size: 15px;
            font-weight: 700;
            color: #212529;
        }

        .moneyflow-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
        }

        .moneyflow-category {
            border: 1px solid #e9ecef;
            border-radius: 4px;
            overflow: hidden;
        }

        .moneyflow-category-title {
            background: #f8f9fa;
            padding: 8px 10px;
            font-weight: 600;
            color: #495057;
            font-size: 12px;
            border-bottom: 1px solid #e9ecef;
        }

        .moneyflow-category-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0;
        }

        .moneyflow-item {
            padding: 8px 6px;
            text-align: center;
            border-right: 1px solid #e9ecef;
            border-bottom: 1px solid #e9ecef;
            transition: background-color 0.2s ease;
        }

        .moneyflow-item:nth-child(2n) {
            border-right: none;
        }

        .moneyflow-item:nth-last-child(-n+2) {
            border-bottom: none;
        }

        .moneyflow-item:hover {
            background-color: #f8f9fa;
        }

        .moneyflow-label {
            font-size: 10px;
            color: #6c757d;
            margin-bottom: 3px;
            line-height: 1.1;
        }

        .moneyflow-value {
            font-size: 11px;
            font-weight: 600;
            color: #212529;
            line-height: 1.1;
        }

        /* 技术指标图表样式 */
        .indicators-charts-section {
            background: white;
            border-radius: 8px;
            padding: 0;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .indicators-charts-header {
            background: #f8f9fa;
            padding: 15px 20px;
            border-bottom: 1px solid #e9ecef;
            font-weight: 600;
            color: #495057;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .indicators-controls {
            display: flex;
            gap: 10px;
        }

        .indicator-btn {
            padding: 6px 12px;
            background: #fff;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s ease;
        }

        .indicator-btn:hover {
            background: #e9ecef;
        }

        .indicator-btn.active {
            background: #007bff;
            color: white;
            border-color: #007bff;
        }

        .indicators-charts-container {
            padding: 20px;
        }

        .indicator-chart {
            width: 100%;
        }

        .indicator-section {
            width: 100%;
            box-sizing: border-box;
        }

        /* 确保所有图表容器宽度一致 */
        #candlestickChart, #volumeChart, #macdChart, #kdjChart, #rsiChart {
            width: 100% !important;
            box-sizing: border-box;
        }

        /* 蜡烛图样式 */
        .chart-section {
            background: white;
            border-radius: 8px;
            padding: 0;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .chart-header {
            background: #f8f9fa;
            padding: 15px 20px;
            border-bottom: 1px solid #e9ecef;
            font-weight: 600;
            color: #495057;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chart-controls {
            display: flex;
            gap: 10px;
        }

        .chart-btn {
            padding: 6px 12px;
            background: #fff;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s ease;
        }

        .chart-btn:hover {
            background: #e9ecef;
        }

        .chart-btn.active {
            background: #007bff;
            color: white;
            border-color: #007bff;
        }

        .chart-container {
            padding: 20px;
        }

        .chart-loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 4px;
            margin: 20px;
            border: 1px solid #f5c6cb;
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .indicators-grid {
                grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            }
            
            .indicator-item {
                padding: 10px 5px;
            }
            
            .indicator-label {
                font-size: 11px;
            }
            
            .indicator-value {
                font-size: 13px;
            }
            
            .stock-price {
                font-size: 24px;
            }

            .chart-header {
                flex-direction: column;
                gap: 10px;
                align-items: flex-start;
            }

            .chart-controls {
                width: 100%;
                justify-content: center;
            }
        }

        @media (max-width: 480px) {
            .indicators-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div id="loadingDiv" class="loading" style="display: block;">
            <p>正在加载每日指标数据...</p>
        </div>

        <div id="errorDiv" class="error" style="display: none;"></div>

        <div id="contentDiv" style="display: none;">
            <div class="stock-header">
                <div class="stock-info">
                    <div>
                        <span id="stockName" class="stock-name">东华测试</span>
                        <span id="stockCode" class="stock-code">300354.SZ</span>
                    </div>
                    <div>
                        <span id="stockPrice" class="stock-price">¥40.31</span>
                    </div>
                    <div class="price-change">
                        <span id="changeAmount" class="change-amount">+52.00</span>
                        <span>(<span id="changePercent" class="change-percent">+33.30</span>)</span>
                    </div>
                </div>
                
                <!-- 操作按钮区域 -->
                <div class="stock-actions">
                    <div class="stock-actions-left">
                        <!-- 左侧留空 -->
                    </div>
                    <div class="stock-actions-right">
                        <button id="addToWatchlistBtn" class="action-btn btn-add" onclick="addToWatchlist()">
                            <span>+</span>
                            <span>加入自选</span>
                        </button>
                        <button id="refreshDataBtn" class="action-btn btn-refresh" onclick="refreshAllData()">
                            <span>🔄</span>
                            <span>刷新数据</span>
                        </button>
                        <button id="removeFromWatchlistBtn" class="action-btn btn-remove" onclick="removeFromWatchlist()">
                            <span>🗑️</span>
                            <span>删除自选</span>
                        </button>
                    </div>
                </div>
            </div>

            <div class="indicators-section">
                <div class="indicators-header">每日指标</div>
                <div class="indicators-grid">
                    <div class="indicator-item">
                        <div class="indicator-label">市值</div>
                        <div id="totalMv" class="indicator-value">55.76亿</div>
                    </div>
                    <div class="indicator-item">
                        <div class="indicator-label">成交额</div>
                        <div id="amount" class="indicator-value">2.53亿</div>
                    </div>
                    <div class="indicator-item">
                        <div class="indicator-label">净流入额</div>
                        <div id="netInflow" class="indicator-value negative">-5310.00万</div>
                    </div>
                    <div class="indicator-item">
                        <div class="indicator-label">换手率</div>
                        <div id="turnoverRate" class="indicator-value">7.71%</div>
                    </div>
                    <div class="indicator-item">
                        <div class="indicator-label">量比</div>
                        <div id="volumeRatio" class="indicator-value">0.85</div>
                    </div>
                    <div class="indicator-item">
                        <div class="indicator-label">市盈率(TTM)</div>
                        <div id="peTtm" class="indicator-value">45.17</div>
                    </div>
                    <div class="indicator-item">
                        <div class="indicator-label">市净率(PB)</div>
                        <div id="pb" class="indicator-value">7.36</div>
                    </div>
                    <div class="indicator-item">
                        <div class="indicator-label">当天开盘</div>
                        <div id="open" class="indicator-value">¥41.01</div>
                    </div>
                    <div class="indicator-item">
                        <div class="indicator-label">当天涨幅</div>
                        <div id="pctChg" class="indicator-value negative">-0.03%</div>
                    </div>
                    <div class="indicator-item">
                        <div class="indicator-label">所属行业</div>
                        <div id="industry" class="indicator-value">电器仪表</div>
                    </div>
                </div>
            </div>

            <!-- 资金流向数据部分 -->
            <div class="moneyflow-section">
                <div class="moneyflow-header">
                    <span>资金流向</span>
                    <div style="display: flex; align-items: center; gap: 15px;">
                        <span id="moneyflowTimestamp" style="font-size: 12px; color: #6c757d;">--</span>
                        <button id="moneyflowRefreshBtn" class="moneyflow-refresh-btn" onclick="refreshMoneyflowData()">刷新</button>
                    </div>
                </div>
                <div id="moneyflowContent">
                    <div id="moneyflowLoading" class="moneyflow-loading" style="display: block;">
                        正在加载资金流向数据...
                    </div>
                    <div id="moneyflowError" class="moneyflow-error" style="display: none;"></div>
                    <div id="moneyflowGrid" class="moneyflow-grid" style="display: none;">
                        <!-- 净流入汇总 -->
                        <div class="moneyflow-summary">
                            <div class="moneyflow-summary-item">
                                <div class="moneyflow-summary-label">净流入量</div>
                                <div id="mf_net_vol" class="moneyflow-summary-value">--</div>
                            </div>
                            <div class="moneyflow-summary-item">
                                <div class="moneyflow-summary-label">净流入额</div>
                                <div id="mf_net_amount" class="moneyflow-summary-value">--</div>
                            </div>
                        </div>
                        
                        <!-- 详细资金流向 -->
                        <div class="moneyflow-details">
                            <!-- 小单 -->
                            <div class="moneyflow-category">
                                <div class="moneyflow-category-title">小单（<5万）</div>
                                <div class="moneyflow-category-grid">
                                    <div class="moneyflow-item">
                                        <div class="moneyflow-label">买入量</div>
                                        <div id="mf_buy_sm_vol" class="moneyflow-value">--</div>
                                    </div>
                                    <div class="moneyflow-item">
                                        <div class="moneyflow-label">买入额</div>
                                        <div id="mf_buy_sm_amount" class="moneyflow-value">--</div>
                                    </div>
                                    <div class="moneyflow-item">
                                        <div class="moneyflow-label">卖出量</div>
                                        <div id="mf_sell_sm_vol" class="moneyflow-value">--</div>
                                    </div>
                                    <div class="moneyflow-item">
                                        <div class="moneyflow-label">卖出额</div>
                                        <div id="mf_sell_sm_amount" class="moneyflow-value">--</div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- 中单 -->
                            <div class="moneyflow-category">
                                <div class="moneyflow-category-title">中单（5-20万）</div>
                                <div class="moneyflow-category-grid">
                                    <div class="moneyflow-item">
                                        <div class="moneyflow-label">买入量</div>
                                        <div id="mf_buy_md_vol" class="moneyflow-value">--</div>
                                    </div>
                                    <div class="moneyflow-item">
                                        <div class="moneyflow-label">买入额</div>
                                        <div id="mf_buy_md_amount" class="moneyflow-value">--</div>
                                    </div>
                                    <div class="moneyflow-item">
                                        <div class="moneyflow-label">卖出量</div>
                                        <div id="mf_sell_md_vol" class="moneyflow-value">--</div>
                                    </div>
                                    <div class="moneyflow-item">
                                        <div class="moneyflow-label">卖出额</div>
                                        <div id="mf_sell_md_amount" class="moneyflow-value">--</div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- 大单 -->
                            <div class="moneyflow-category">
                                <div class="moneyflow-category-title">大单（20-100万）</div>
                                <div class="moneyflow-category-grid">
                                    <div class="moneyflow-item">
                                        <div class="moneyflow-label">买入量</div>
                                        <div id="mf_buy_lg_vol" class="moneyflow-value">--</div>
                                    </div>
                                    <div class="moneyflow-item">
                                        <div class="moneyflow-label">买入额</div>
                                        <div id="mf_buy_lg_amount" class="moneyflow-value">--</div>
                                    </div>
                                    <div class="moneyflow-item">
                                        <div class="moneyflow-label">卖出量</div>
                                        <div id="mf_sell_lg_vol" class="moneyflow-value">--</div>
                                    </div>
                                    <div class="moneyflow-item">
                                        <div class="moneyflow-label">卖出额</div>
                                        <div id="mf_sell_lg_amount" class="moneyflow-value">--</div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- 特大单 -->
                            <div class="moneyflow-category">
                                <div class="moneyflow-category-title">特大单（>100万）</div>
                                <div class="moneyflow-category-grid">
                                    <div class="moneyflow-item">
                                        <div class="moneyflow-label">买入量</div>
                                        <div id="mf_buy_elg_vol" class="moneyflow-value">--</div>
                                    </div>
                                    <div class="moneyflow-item">
                                        <div class="moneyflow-label">买入额</div>
                                        <div id="mf_buy_elg_amount" class="moneyflow-value">--</div>
                                    </div>
                                    <div class="moneyflow-item">
                                        <div class="moneyflow-label">卖出量</div>
                                        <div id="mf_sell_elg_vol" class="moneyflow-value">--</div>
                                    </div>
                                    <div class="moneyflow-item">
                                        <div class="moneyflow-label">卖出额</div>
                                        <div id="mf_sell_elg_amount" class="moneyflow-value">--</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 实时交易数据部分 -->
            <div class="realtime-section">
                <div class="realtime-header">
                    <span>实时交易数据</span>
                    <div style="display: flex; align-items: center; gap: 15px;">
                        <span id="lastRefreshTime" style="font-size: 12px; color: #6c757d;">--</span>
                        <span id="realtimeTimestamp" style="font-size: 12px; color: #6c757d;">--</span>
                        <button id="autoRefreshToggle" class="realtime-refresh-btn" onclick="toggleAutoRefresh()" style="background: #dc3545;">停止自动刷新</button>
                        <button id="realtimeRefreshBtn" class="realtime-refresh-btn" onclick="refreshRealtimeData()">手动刷新</button>
                    </div>
                </div>
                <div id="realtimeContent">
                    <div id="realtimeLoading" class="realtime-loading" style="display: block;">
                        正在加载实时交易数据...
                    </div>
                    <div id="realtimeError" class="realtime-error" style="display: none;"></div>
                    <div id="realtimeGrid" class="realtime-grid" style="display: none;">
                        <!-- 第一行 -->
                        <div class="realtime-item">
                            <div class="realtime-label">最新价</div>
                            <div id="rt_最新价" class="realtime-value">--</div>
                        </div>
                        <div class="realtime-item">
                            <div class="realtime-label">涨跌幅</div>
                            <div id="rt_涨跌幅" class="realtime-value">--</div>
                        </div>
                        <div class="realtime-item">
                            <div class="realtime-label">涨跌额</div>
                            <div id="rt_涨跌额" class="realtime-value">--</div>
                        </div>
                        <div class="realtime-item">
                            <div class="realtime-label">量比</div>
                            <div id="rt_量比" class="realtime-value">--</div>
                        </div>
                        <div class="realtime-item">
                            <div class="realtime-label">换手率</div>
                            <div id="rt_换手率" class="realtime-value">--</div>
                        </div>
                        <div class="realtime-item">
                            <div class="realtime-label">成交量</div>
                            <div id="rt_成交量" class="realtime-value">--</div>
                        </div>
                        <!-- 第二行 -->
                        <div class="realtime-item">
                            <div class="realtime-label">成交额</div>
                            <div id="rt_成交额" class="realtime-value">--</div>
                        </div>
                        <div class="realtime-item">
                            <div class="realtime-label">振幅</div>
                            <div id="rt_振幅" class="realtime-value">--</div>
                        </div>
                        <div class="realtime-item">
                            <div class="realtime-label">最高</div>
                            <div id="rt_最高" class="realtime-value">--</div>
                        </div>
                        <div class="realtime-item">
                            <div class="realtime-label">最低</div>
                            <div id="rt_最低" class="realtime-value">--</div>
                        </div>
                        <div class="realtime-item">
                            <div class="realtime-label">今开</div>
                            <div id="rt_今开" class="realtime-value">--</div>
                        </div>
                        <div class="realtime-item">
                            <div class="realtime-label">昨收</div>
                            <div id="rt_昨收" class="realtime-value">--</div>
                        </div>
                        <!-- 第三行 -->
                        <div class="realtime-item">
                            <div class="realtime-label">市盈率-动态</div>
                            <div id="rt_市盈率_动态" class="realtime-value">--</div>
                        </div>
                        <div class="realtime-item">
                            <div class="realtime-label">市净率</div>
                            <div id="rt_市净率" class="realtime-value">--</div>
                        </div>
                        <div class="realtime-item">
                            <div class="realtime-label">总市值</div>
                            <div id="rt_总市值" class="realtime-value">--</div>
                        </div>
                        <div class="realtime-item">
                            <div class="realtime-label">流通市值</div>
                            <div id="rt_流通市值" class="realtime-value">--</div>
                        </div>
                        <div class="realtime-item">
                            <div class="realtime-label">涨速</div>
                            <div id="rt_涨速" class="realtime-value">--</div>
                        </div>
                        <div class="realtime-item">
                            <div class="realtime-label">5分钟涨跌</div>
                            <div id="rt_5分钟涨跌" class="realtime-value">--</div>
                        </div>
                        <!-- 第四行 -->
                        <div class="realtime-item">
                            <div class="realtime-label">60日涨跌幅</div>
                            <div id="rt_60日涨跌幅" class="realtime-value">--</div>
                        </div>
                        <div class="realtime-item">
                            <div class="realtime-label">年初至今涨跌幅</div>
                            <div id="rt_年初至今涨跌幅" class="realtime-value">--</div>
                        </div>
                        <div class="realtime-item">
                            <div class="realtime-label">连涨天数</div>
                            <div id="rt_连涨天数" class="realtime-value">--</div>
                        </div>
                        <div class="realtime-item">
                            <div class="realtime-label">量价齐升天数</div>
                            <div id="rt_量价齐升天数" class="realtime-value">--</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 分时图部分 -->
            <div class="realtime-section">
                <div class="realtime-header">
                    <span>分时图</span>
                    <div style="display: flex; align-items: center; gap: 15px;">
                        <span id="lastChartRefreshTime" style="font-size: 12px; color: #6c757d;">--</span>
                        <span id="intradayTimestamp" style="font-size: 12px; color: #6c757d;">--</span>
                        <button id="chartAutoRefreshToggle" class="realtime-refresh-btn" onclick="toggleAutoRefresh()" style="background: #dc3545;">停止自动刷新</button>
                        <button id="intradayRefreshBtn" class="realtime-refresh-btn" onclick="refreshIntradayChart()">手动刷新</button>
                    </div>
                </div>
                <div id="intradayContent">
                    <div id="intradayLoading" class="realtime-loading" style="display: block;">
                        正在加载分时数据...
                    </div>
                    <div id="intradayError" class="realtime-error" style="display: none;"></div>
                    <div id="intradayChartContainer" style="display: none;">
                        <!-- 分时图 -->
                        <div id="intradayChart" style="width: 100%; height: 400px; padding: 10px;"></div>
                        <!-- 分时成交量图 -->
                        <div id="intradayVolumeChart" style="width: 100%; height: 150px; padding: 10px;"></div>
                    </div>
                </div>
            </div>

            <!-- K线图和技术指标组合部分 -->
            <div class="chart-section">
                <div class="chart-header">
                    <span>K线图与技术指标</span>
                    <div class="chart-controls">
                        <button class="chart-btn" onclick="setDisplayRange(50, event)">50根</button>
                        <button class="chart-btn active" onclick="setDisplayRange(100, event)">100根</button>
                        <button class="chart-btn" onclick="setDisplayRange(200, event)">200根</button>
                        <button class="chart-btn" onclick="setDisplayRange(-1, event)">全部</button>
                        <div style="margin-left: 20px; display: flex; align-items: center; gap: 10px;">
                            <label style="display: flex; align-items: center; gap: 5px; font-size: 12px; color: #495057;">
                                <input type="checkbox" id="showBOLL" checked onchange="toggleBOLL()">
                                BOLL指标
                            </label>
                        </div>
                    </div>
                </div>
                <div class="chart-container">
                    <div id="chartLoading" class="chart-loading" style="display: none;">
                        正在加载K线数据...
                    </div>
                    <!-- K线图 -->
                    <div id="candlestickChart" style="width: 100%; height: 400px;"></div>
                    <!-- 成交量图 -->
                    <div id="volumeChart" style="width: 100%; height: 150px; margin-top: 2px;"></div>
                    
                    <!-- MACD指标 -->
                    <div id="macdChart" style="width: 100%; height: 150px; margin-top: 5px;"></div>
                    
                    <!-- KDJ指标 -->
                    <div id="kdjChart" style="width: 100%; height: 150px; margin-top: 5px;"></div>
                    
                    <!-- RSI指标 -->
                    <div id="rsiChart" style="width: 100%; height: 150px; margin-top: 5px;"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 全局变量
        let allChartData = [];
        let nineTurnData = []; // 添加神奇九转数据
        let currentDisplayRange = 100;
        let currentStockCode = '';

        // 从URL参数获取股票代码
        function getStockCodeFromUrl() {
            // 从URL路径获取股票代码 (例如: /stock/300354)
            const pathParts = window.location.pathname.split('/');
            if (pathParts.length >= 3 && pathParts[1] === 'stock') {
                return pathParts[2];
            }
            
            // 如果路径中没有，则从URL参数获取
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('code') || '300354';
        }

        // 格式化数值
        function formatValue(value, type = 'number') {
            if (value === null || value === undefined || value === '') {
                return '--';
            }
            
            const num = parseFloat(value);
            if (isNaN(num)) return value;
            
            switch (type) {
                case 'currency':
                    return `¥${num.toFixed(2)}`;
                case 'percentage':
                    return `${num.toFixed(2)}%`;
                case 'large_number':
                    if (num >= 100000000) {
                        return `${(num / 100000000).toFixed(2)}亿`;
                    } else if (num >= 10000) {
                        return `${(num / 10000).toFixed(2)}万`;
                    }
                    return num.toFixed(2);
                case 'ratio':
                    return num.toFixed(2);
                default:
                    return num.toFixed(2);
            }
        }

        // 格式化成交额
        function formatAmount(value) {
            if (value === null || value === undefined || value === '') {
                return '--';
            }
            
            const num = parseFloat(value);
            if (isNaN(num)) return value;
            
            // Tushare返回的amount单位是千元，需要先转换为万元
            const amountInWan = num / 10;
            
            // 成交额单位转换：万元 -> 亿元
            if (amountInWan >= 10000) {
                return `${(amountInWan / 10000).toFixed(2)}亿`;
            } else {
                return `${amountInWan.toFixed(2)}万`;
            }
        }

        // 格式化图表日期（只显示月日）
        function formatChartDate(dateStr) {
            if (!dateStr) return '';
            const month = dateStr.substring(4, 6);
            const day = dateStr.substring(6, 8);
            return `${month}-${day}`;
        }

        // 格式化日期
        function formatDate(dateStr) {
            if (!dateStr) return '';
            const year = dateStr.substring(0, 4);
            const month = dateStr.substring(4, 6);
            const day = dateStr.substring(6, 8);
            return `${year}年${month}月${day}日`;
        }

        // 设置数值颜色
        function setValueColor(element, value) {
            const num = parseFloat(value);
            if (isNaN(num)) return;
            
            element.classList.remove('positive', 'negative', 'neutral');
            if (num > 0) {
                element.classList.add('positive');
            } else if (num < 0) {
                element.classList.add('negative');
            } else {
                element.classList.add('neutral');
            }
        }

        // 加载股票数据
        async function loadStockData() {
            currentStockCode = getStockCodeFromUrl();
            
            try {
                // 获取每日指标数据
                const dailyBasicResponse = await fetch(`/api/stock/${currentStockCode}/daily_basic`);
                const dailyBasicResult = await dailyBasicResponse.json();
                
                if (!dailyBasicResult.success) {
                    throw new Error(dailyBasicResult.error || '获取每日指标数据失败');
                }

                // 获取实时数据
                const realtimeResponse = await fetch(`/api/stock/${currentStockCode}/realtime`);
                const realtimeResult = await realtimeResponse.json();
                
                displayStockData(dailyBasicResult, realtimeResult);
                
                // 加载资金流向数据
                await loadMoneyflowData();
                
                // 加载实时交易数据
                await loadRealtimeData();
                
                // 加载分时图数据
                await loadIntradayChart();
                
                // 加载K线数据
                await loadChartData();
                
            } catch (error) {
                showError('数据加载失败: ' + error.message);
            }
        }

        // 加载实时交易数据
        async function loadRealtimeData(showLoading = true) {
            try {
                // 只在首次加载或手动刷新时显示加载状态
                if (showLoading) {
                    showRealtimeLoading(true);
                }
                
                const response = await fetch(`/api/stock/realtime_trading_data`);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const result = await response.json();
                
                if (!result.success) {
                    // 显示后端返回的具体错误信息
                    const errorMsg = result.error || '获取实时交易数据失败';
                    const detailMsg = result.details ? ` (${result.details})` : '';
                    throw new Error(errorMsg + detailMsg);
                }
                
                // 检查是否是缓存数据，如果是缓存数据，尝试使用个股实时数据API作为备用
                if (result.is_cached_data) {
                    console.log('检测到缓存数据，尝试使用个股实时数据API获取最新数据...');
                    try {
                        await loadFallbackRealtimeData(result);
                        return;
                    } catch (fallbackError) {
                        console.warn('个股实时数据API也失败，使用缓存数据:', fallbackError);
                        // 继续使用缓存数据
                    }
                }
                
                displayRealtimeData(result.data, result);
                
            } catch (error) {
                console.error('实时交易数据加载失败:', error);
                
                // 尝试使用个股实时数据API作为备用
                try {
                    console.log('尝试使用个股实时数据API作为备用...');
                    await loadFallbackRealtimeData();
                    return;
                } catch (fallbackError) {
                    console.error('个股实时数据API也失败:', fallbackError);
                }
                
                // 根据错误类型显示不同的错误信息
                let errorMessage = '实时交易数据加载失败';
                
                if (error.message.includes('网络连接')) {
                    errorMessage = '网络连接失败，请检查网络连接后重试';
                } else if (error.message.includes('代理连接')) {
                    errorMessage = '代理连接失败，请检查网络设置';
                } else if (error.message.includes('AkShare')) {
                    errorMessage = 'AkShare服务暂时不可用，请稍后重试';
                } else if (error.message.includes('API调用失败')) {
                    errorMessage = 'API调用失败，请稍后重试';
                } else if (error.message.includes('HTTP')) {
                    errorMessage = `服务器错误: ${error.message}`;
                } else {
                    errorMessage = error.message || '未知错误，请稍后重试';
                }
                
                // 只在显示加载状态时才显示错误，避免自动刷新时覆盖现有数据
                if (showLoading) {
                    showRealtimeError(errorMessage);
                }
            } finally {
                if (showLoading) {
                    showRealtimeLoading(false);
                }
            }
        }

        // 使用个股实时数据API作为备用数据源
        async function loadFallbackRealtimeData(originalResult = null) {
            const realtimeResponse = await fetch(`/api/stock/${currentStockCode}/realtime`);
            
            if (!realtimeResponse.ok) {
                throw new Error(`个股实时数据API HTTP ${realtimeResponse.status}: ${realtimeResponse.statusText}`);
            }
            
            const realtimeResult = await realtimeResponse.json();
            
            if (!realtimeResult.success) {
                throw new Error(realtimeResult.error || '获取个股实时数据失败');
            }
            
            // 将个股实时数据转换为实时交易数据格式
            const spotData = realtimeResult.spot;
            if (!spotData) {
                throw new Error('个股实时数据中缺少spot数据');
            }
            
            const convertedData = [{
                '序号': 1,
                '代码': currentStockCode,
                '名称': spotData.name || '',
                '最新价': spotData.latest_price || 0,
                '涨跌幅': spotData.change_percent || 0,
                '涨跌额': spotData.change_amount || 0,
                '成交量': spotData.volume || 0,
                '成交额': spotData.amount || 0,
                '振幅': 0, // 个股API中没有这个字段
                '最高': spotData.high || 0,
                '最低': spotData.low || 0,
                '今开': spotData.open || 0,
                '昨收': spotData.pre_close || 0,
                '量比': spotData.volume_ratio || 0,
                '换手率': spotData.turnover_rate || 0,
                '市盈率-动态': spotData.pe_ratio || 0,
                '市净率': 0, // 个股API中没有这个字段
                '总市值': spotData.market_cap || 0,
                '流通市值': 0, // 个股API中没有这个字段
                '涨速': 0, // 个股API中没有这个字段
                '5分钟涨跌': 0, // 个股API中没有这个字段
                '60日涨跌幅': 0, // 个股API中没有这个字段
                '年初至今涨跌幅': 0, // 个股API中没有这个字段
                '连涨天数': 0, // 个股API中没有这个字段
                '量价齐升天数': 0 // 个股API中没有这个字段
            }];
            
            const fallbackResult = {
                success: true,
                data: convertedData,
                total_records: 1,
                fetch_time: new Date().toLocaleString('zh-CN'),
                data_source: '个股实时数据API (备用)',
                message: originalResult ? '全市场数据使用缓存，个股数据已更新' : '使用个股实时数据API',
                is_cached_data: false
            };
            
            console.log('成功使用个股实时数据API获取最新数据');
            displayRealtimeData(fallbackResult.data, fallbackResult);
        }

        // 刷新实时交易数据
        async function refreshRealtimeData() {
            const refreshBtn = document.getElementById('realtimeRefreshBtn');
            refreshBtn.disabled = true;
            refreshBtn.textContent = '刷新中...';
            
            try {
                await loadRealtimeData();
            } finally {
                refreshBtn.disabled = false;
                refreshBtn.textContent = '刷新';
            }
        }

        // 显示实时交易数据
        function displayRealtimeData(data, result = null) {
            if (!data || data.length === 0) {
                showRealtimeError('暂无实时交易数据');
                return;
            }

            // 找到当前股票的数据
            const stockData = data.find(item => {
                const code = item['代码'];
                return code && (code === currentStockCode || code === currentStockCode.substring(0, 6));
            });

            if (!stockData) {
                showRealtimeError('未找到当前股票的实时交易数据');
                return;
            }

            // 显示数据
            const fieldMapping = {
                '序号': '序号',
                '代码': '代码', 
                '名称': '名称',
                '最新价': '最新价',
                '涨跌幅': '涨跌幅',
                '涨跌额': '涨跌额',
                '成交量': '成交量',
                '成交额': '成交额',
                '振幅': '振幅',
                '最高': '最高',
                '最低': '最低',
                '今开': '今开',
                '昨收': '昨收',
                '量比': '量比',
                '换手率': '换手率',
                '市盈率-动态': '市盈率-动态',
                '市净率': '市净率',
                '总市值': '总市值',
                '流通市值': '流通市值',
                '涨速': '涨速',
                '5分钟涨跌': '5分钟涨跌',
                '60日涨跌幅': '60日涨跌幅',
                '年初至今涨跌幅': '年初至今涨跌幅',
                '连涨天数': '连涨天数',
                '量价齐升天数': '量价齐升天数'
            };

            Object.entries(fieldMapping).forEach(([field, key]) => {
                const element = document.getElementById(`rt_${field}`);
                if (element && stockData[key] !== undefined) {
                    let value = stockData[key];
                    
                    // 格式化数值
                    if (field === '最新价' || field === '涨跌额' || field === '最高' || field === '最低' || field === '今开' || field === '昨收') {
                        value = formatRealtimeValue(value, 'currency');
                    } else if (field === '涨跌幅' || field === '振幅' || field === '换手率' || field === '涨速' || field === '5分钟涨跌' || field === '60日涨跌幅' || field === '年初至今涨跌幅') {
                        value = formatRealtimeValue(value, 'percentage');
                    } else if (field === '成交量') {
                        value = formatRealtimeValue(value, 'volume');
                    } else if (field === '成交额' || field === '总市值' || field === '流通市值') {
                        value = formatRealtimeValue(value, 'amount');
                    } else if (field === '连涨天数' || field === '量价齐升天数') {
                        value = formatRealtimeValue(value, 'days');
                    } else {
                        value = formatRealtimeValue(value, 'number');
                    }
                    
                    element.textContent = value;
                    
                    // 设置颜色
                    if (field === '最新价') {
                        // 最新价根据涨跌幅来设置颜色
                        setRealtimeValueColor(element, stockData['涨跌幅'], field);
                    } else if (field === '涨跌幅' || field === '涨跌额' || field === '涨速' || field === '5分钟涨跌' || field === '60日涨跌幅' || field === '年初至今涨跌幅') {
                        setRealtimeValueColor(element, stockData[key], field);
                    } else if (field === '连涨天数' || field === '量价齐升天数') {
                        setRealtimeValueColor(element, stockData[key], field);
                    }
                }
            });

            // 显示数据网格
            document.getElementById('realtimeGrid').style.display = 'grid';
            document.getElementById('realtimeError').style.display = 'none';
            
            // 更新时间戳，如果是最后交易日数据，显示特殊提示
            updateRealtimeTimestamp(result);
            
            // 使用实时交易数据更新每日指标
            updateDailyIndicatorsFromRealtimeData(data);
            
            // 更新红框中的股票价格（使用最新价）
            updateStockPriceDisplay(stockData);
        }

        // 更新红框中的股票价格显示
        function updateStockPriceDisplay(stockData) {
            if (!stockData) return;
            
            // 更新最新价格
            const stockPriceElement = document.getElementById('stockPrice');
            if (stockData['最新价'] && stockPriceElement) {
                const latestPrice = stockData['最新价'];
                stockPriceElement.textContent = formatValue(latestPrice, 'currency');
                console.log(`[红框价格] 更新最新价格: ${latestPrice}`);
            }
            
            // 更新涨跌额和涨跌幅
            const changeAmountElement = document.getElementById('changeAmount');
            const changePctElement = document.getElementById('changePercent');
            
            if (stockData['涨跌额'] && changeAmountElement) {
                const changeAmount = stockData['涨跌额'];
                changeAmountElement.textContent = (changeAmount >= 0 ? '+' : '') + formatValue(changeAmount);
                setValueColor(changeAmountElement, changeAmount);
                console.log(`[红框价格] 更新涨跌额: ${changeAmount}`);
            }
            
            if (stockData['涨跌幅'] && changePctElement) {
                const changePct = stockData['涨跌幅'];
                changePctElement.textContent = (changePct >= 0 ? '+' : '') + formatValue(changePct, 'percentage');
                setValueColor(changePctElement, changePct);
                console.log(`[红框价格] 更新涨跌幅: ${changePct}%`);
            }
            
            // 更新今开价格
            const openElement = document.getElementById('open');
            if (stockData['今开'] && openElement) {
                openElement.textContent = formatValue(stockData['今开'], 'currency');
            }
            
            // 更新涨跌幅显示（页面右侧的涨跌幅）
            const pctChgElement = document.getElementById('pctChg');
            if (stockData['涨跌幅'] && pctChgElement) {
                const changePct = stockData['涨跌幅'];
                pctChgElement.textContent = formatValue(changePct, 'percentage');
                setValueColor(pctChgElement, changePct);
            }
        }

        // 格式化实时数据值
        function formatRealtimeValue(value, type = 'number') {
            if (value === null || value === undefined || value === '' || value === '-') {
                return '--';
            }
            
            const num = parseFloat(value);
            if (isNaN(num)) return value;
            
            switch (type) {
                case 'currency':
                    return `¥${num.toFixed(2)}`;
                case 'percentage':
                    return `${num.toFixed(2)}%`;
                case 'volume':
                    if (num >= 100000000) {
                        return `${(num / 100000000).toFixed(2)}亿手`;
                    } else if (num >= 10000) {
                        return `${(num / 10000).toFixed(2)}万手`;
                    }
                    return `${num.toFixed(0)}手`;
                case 'amount':
                    if (num >= 100000000) {
                        return `${(num / 100000000).toFixed(2)}亿`;
                    } else if (num >= 10000) {
                        return `${(num / 10000).toFixed(2)}万`;
                    }
                    return num.toFixed(2);
                case 'days':
                    return `${Math.floor(num)}天`;
                case 'number':
                default:
                    return num.toFixed(2);
            }
        }

        // 设置实时数据值颜色
        function setRealtimeValueColor(element, value, field) {
            // 涨跌相关字段使用红涨绿跌
            const changeFields = ['涨跌幅', '涨跌额', '涨速', '5分钟涨跌', '60日涨跌幅', '年初至今涨跌幅'];
            
            if (changeFields.includes(field) || field === '最新价') {
                const numValue = parseFloat(value);
                if (!isNaN(numValue)) {
                    element.classList.remove('positive', 'negative', 'neutral');
                    if (numValue > 0) {
                        element.classList.add('positive');
                        element.style.color = '#ff4444'; // 红色
                    } else if (numValue < 0) {
                        element.classList.add('negative');
                        element.style.color = '#00aa00'; // 绿色
                    } else {
                        element.classList.add('neutral');
                        element.style.color = '#666'; // 灰色
                    }
                } else {
                    element.style.color = '#333'; // 默认颜色
                }
            } else if (field === '连涨天数' || field === '量价齐升天数') {
                const numValue = parseFloat(value);
                if (!isNaN(numValue)) {
                    element.classList.remove('positive', 'negative', 'neutral');
                    if (numValue > 0) {
                        element.classList.add('positive');
                        element.style.color = '#ff4444'; // 红色，表示连续上涨或量价齐升
                    } else {
                        element.classList.add('neutral');
                        element.style.color = '#666'; // 灰色，表示没有连涨或量价齐升
                    }
                } else {
                    element.style.color = '#333'; // 默认颜色
                }
            } else {
                // 其他字段使用默认颜色
                element.style.color = '#333';
            }
        }

        // 显示实时数据加载状态
        function showRealtimeLoading(show) {
            document.getElementById('realtimeLoading').style.display = show ? 'block' : 'none';
            document.getElementById('realtimeGrid').style.display = show ? 'none' : 'grid';
            document.getElementById('realtimeError').style.display = 'none';
        }

        // 显示实时数据错误
        function showRealtimeError(message) {
            document.getElementById('realtimeError').textContent = message;
            document.getElementById('realtimeError').style.display = 'block';
            document.getElementById('realtimeLoading').style.display = 'none';
            document.getElementById('realtimeGrid').style.display = 'none';
        }

        // 更新实时数据时间戳
        function updateRealtimeTimestamp(result = null) {
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            const seconds = String(now.getSeconds()).padStart(2, '0');
            
            const timestamp = `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
            
            // 检查是否是最后交易日数据
            if (result && result.is_last_trading_day) {
                document.getElementById('realtimeTimestamp').innerHTML = 
                    `<span style="color: #ff6600;">📅 非交易时间，显示最后交易日(2025-07-25)收盘数据</span><br>更新时间: ${timestamp}`;
            } else {
                document.getElementById('realtimeTimestamp').textContent = `更新时间: ${timestamp}`;
            }
        }

        // 加载资金流向数据
        async function loadMoneyflowData(showLoading = true) {
            try {
                if (showLoading) {
                    showMoneyflowLoading(true);
                }
                
                const response = await fetch(`/api/stock/${currentStockCode}/moneyflow`);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const result = await response.json();
                
                if (!result.success) {
                    throw new Error(result.error || '获取资金流向数据失败');
                }
                
                displayMoneyflowData(result.data, result);
                
            } catch (error) {
                console.error('资金流向数据加载失败:', error);
                
                let errorMessage = '资金流向数据加载失败';
                if (error.message.includes('HTTP')) {
                    errorMessage = `服务器错误: ${error.message}`;
                } else {
                    errorMessage = error.message || '未知错误，请稍后重试';
                }
                
                if (showLoading) {
                    showMoneyflowError(errorMessage);
                }
            } finally {
                if (showLoading) {
                    showMoneyflowLoading(false);
                }
            }
        }

        // 刷新资金流向数据
        async function refreshMoneyflowData() {
            const refreshBtn = document.getElementById('moneyflowRefreshBtn');
            refreshBtn.disabled = true;
            refreshBtn.textContent = '刷新中...';
            
            try {
                await loadMoneyflowData();
            } finally {
                refreshBtn.disabled = false;
                refreshBtn.textContent = '刷新';
            }
        }

        // 显示资金流向数据
        function displayMoneyflowData(data, result = null) {
            if (!data || data.length === 0) {
                showMoneyflowError('暂无资金流向数据');
                return;
            }

            // 获取最新的资金流向数据（通常是第一条）
            const moneyflowData = data[0];

            // 显示净流入汇总
            document.getElementById('mf_net_vol').textContent = formatMoneyflowValue(moneyflowData.net_mf_vol, 'volume');
            document.getElementById('mf_net_amount').textContent = formatMoneyflowValue(moneyflowData.net_mf_amount, 'amount');
            
            // 设置净流入额的颜色
            const netAmountElement = document.getElementById('mf_net_amount');
            setMoneyflowValueColor(netAmountElement, moneyflowData.net_mf_amount);

            // 显示详细资金流向数据
            const fields = [
                // 小单
                { id: 'mf_buy_sm_vol', value: moneyflowData.buy_sm_vol, type: 'volume' },
                { id: 'mf_buy_sm_amount', value: moneyflowData.buy_sm_amount, type: 'amount' },
                { id: 'mf_sell_sm_vol', value: moneyflowData.sell_sm_vol, type: 'volume' },
                { id: 'mf_sell_sm_amount', value: moneyflowData.sell_sm_amount, type: 'amount' },
                // 中单
                { id: 'mf_buy_md_vol', value: moneyflowData.buy_md_vol, type: 'volume' },
                { id: 'mf_buy_md_amount', value: moneyflowData.buy_md_amount, type: 'amount' },
                { id: 'mf_sell_md_vol', value: moneyflowData.sell_md_vol, type: 'volume' },
                { id: 'mf_sell_md_amount', value: moneyflowData.sell_md_amount, type: 'amount' },
                // 大单
                { id: 'mf_buy_lg_vol', value: moneyflowData.buy_lg_vol, type: 'volume' },
                { id: 'mf_buy_lg_amount', value: moneyflowData.buy_lg_amount, type: 'amount' },
                { id: 'mf_sell_lg_vol', value: moneyflowData.sell_lg_vol, type: 'volume' },
                { id: 'mf_sell_lg_amount', value: moneyflowData.sell_lg_amount, type: 'amount' },
                // 特大单
                { id: 'mf_buy_elg_vol', value: moneyflowData.buy_elg_vol, type: 'volume' },
                { id: 'mf_buy_elg_amount', value: moneyflowData.buy_elg_amount, type: 'amount' },
                { id: 'mf_sell_elg_vol', value: moneyflowData.sell_elg_vol, type: 'volume' },
                { id: 'mf_sell_elg_amount', value: moneyflowData.sell_elg_amount, type: 'amount' }
            ];

            fields.forEach(field => {
                const element = document.getElementById(field.id);
                if (element) {
                    element.textContent = formatMoneyflowValue(field.value, field.type);
                }
            });

            // 显示数据网格
            document.getElementById('moneyflowGrid').style.display = 'block';
            document.getElementById('moneyflowError').style.display = 'none';
            
            // 更新时间戳
            updateMoneyflowTimestamp(result);
        }

        // 格式化资金流向数值
        function formatMoneyflowValue(value, type = 'number') {
            if (value === null || value === undefined || value === '' || value === 0) {
                return '--';
            }
            
            const num = parseFloat(value);
            if (isNaN(num)) return value;
            
            switch (type) {
                case 'volume':
                    if (Math.abs(num) >= 100000000) {
                        return `${(num / 100000000).toFixed(2)}亿手`;
                    } else if (Math.abs(num) >= 10000) {
                        return `${(num / 10000).toFixed(2)}万手`;
                    }
                    return `${num.toFixed(0)}手`;
                case 'amount':
                    if (Math.abs(num) >= 100000000) {
                        return `${(num / 100000000).toFixed(2)}亿元`;
                    } else if (Math.abs(num) >= 10000) {
                        return `${(num / 10000).toFixed(2)}万元`;
                    }
                    return `${num.toFixed(2)}元`;
                case 'number':
                default:
                    return num.toFixed(2);
            }
        }

        // 设置资金流向数值颜色
        function setMoneyflowValueColor(element, value) {
            const numValue = parseFloat(value);
            if (!isNaN(numValue)) {
                element.classList.remove('positive', 'negative', 'neutral');
                if (numValue > 0) {
                    element.classList.add('positive');
                    element.style.color = '#ff4444'; // 红色，表示净流入
                } else if (numValue < 0) {
                    element.classList.add('negative');
                    element.style.color = '#00aa00'; // 绿色，表示净流出
                } else {
                    element.classList.add('neutral');
                    element.style.color = '#666'; // 灰色，表示平衡
                }
            } else {
                element.style.color = '#333'; // 默认颜色
            }
        }

        // 显示资金流向加载状态
        function showMoneyflowLoading(show) {
            document.getElementById('moneyflowLoading').style.display = show ? 'block' : 'none';
            document.getElementById('moneyflowGrid').style.display = show ? 'none' : 'block';
            document.getElementById('moneyflowError').style.display = 'none';
        }

        // 显示资金流向错误
        function showMoneyflowError(message) {
            document.getElementById('moneyflowError').textContent = message;
            document.getElementById('moneyflowError').style.display = 'block';
            document.getElementById('moneyflowLoading').style.display = 'none';
            document.getElementById('moneyflowGrid').style.display = 'none';
        }

        // 更新资金流向时间戳
        function updateMoneyflowTimestamp(result = null) {
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            const seconds = String(now.getSeconds()).padStart(2, '0');
            
            const timestamp = `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
            
            let displayText = `更新时间: ${timestamp}`;
            if (result && result.stock_info && result.stock_info.trade_date) {
                displayText = `交易日期: ${result.stock_info.trade_date} | ${displayText}`;
            }
            
            document.getElementById('moneyflowTimestamp').textContent = displayText;
        }

        // 加载K线数据
        async function loadChartData() {
            try {
                showChartLoading(true);
                
                // 并行获取K线数据和神奇九转数据
                const [historyResponse, nineTurnResponse] = await Promise.all([
                    fetch(`/api/stock/${currentStockCode}/daily_history?days=200`),
                    fetch(`/api/stock/${currentStockCode}/nine_turn?days=200&freq=daily`)
                ]);
                
                const historyResult = await historyResponse.json();
                const nineTurnResult = await nineTurnResponse.json();
                
                if (!historyResult.success) {
                    throw new Error(historyResult.error || '获取K线数据失败');
                }
                
                allChartData = historyResult.data;
                
                // 处理神奇九转数据
                if (nineTurnResult.success && nineTurnResult.data) {
                    nineTurnData = nineTurnResult.data;
                    console.log(`[神奇九转] 成功获取${nineTurnData.length}条数据，上九转信号: ${nineTurnResult.stock_info.up_signals}个，下九转信号: ${nineTurnResult.stock_info.down_signals}个`);
                } else {
                    nineTurnData = [];
                    console.log('[神奇九转] 暂无数据或获取失败');
                }
                
                // 注释掉K线图hover的每日指标数据获取，只在页面顶部显示前一交易日的每日指标
                // await loadDailyBasicDataForChart();
                
                createCandlestickChart();
                
            } catch (error) {
                console.error('数据加载失败:', error);
            } finally {
                showChartLoading(false);
            }
        }

        // 获取每日指标数据用于K线图
        async function loadDailyBasicDataForChart() {
            try {
                // 为每个交易日获取daily_basic数据
                const dailyBasicPromises = allChartData.map(async (item) => {
                    try {
                        const response = await fetch(`/api/stock/${currentStockCode}/daily_basic?trade_date=${item.trade_date.replace(/-/g, '')}`);
                        const result = await response.json();
                        if (result.success) {
                            return {
                                trade_date: item.trade_date,
                                ...result.data
                            };
                        }
                        return null;
                    } catch (error) {
                        console.warn(`获取${item.trade_date}的daily_basic数据失败:`, error);
                        return null;
                    }
                });
                
                // 等待所有请求完成
                const dailyBasicResults = await Promise.all(dailyBasicPromises);
                
                // 创建日期到daily_basic数据的映射
                window.dailyBasicMap = {};
                dailyBasicResults.forEach(result => {
                    if (result) {
                        window.dailyBasicMap[result.trade_date] = result;
                    }
                });
                
                console.log(`[每日指标] 成功获取${Object.keys(window.dailyBasicMap).length}条每日指标数据`);
                
            } catch (error) {
                console.error('获取每日指标数据失败:', error);
                window.dailyBasicMap = {};
            }
        }

        // 创建蜡烛图
        function createCandlestickChart() {
            if (!allChartData || allChartData.length === 0) {
                return;
            }

            // 根据显示范围获取数据
            let displayData = allChartData;
            if (currentDisplayRange > 0 && allChartData.length > currentDisplayRange) {
                displayData = allChartData.slice(-currentDisplayRange);
            }

            // 准备数据
            const dates = displayData.map(item => item.trade_date);
            const formattedDates = dates.map(date => formatChartDate(date)); // 格式化日期用于成交额图表
            const opens = displayData.map(item => item.open);
            const highs = displayData.map(item => item.high);
            const lows = displayData.map(item => item.low);
            const closes = displayData.map(item => item.close);
            const amounts = displayData.map(item => item.amount); // 改为成交额

            // 创建蜡烛图
            const candlestickTrace = {
                x: dates,
                open: opens,
                high: highs,
                low: lows,
                close: closes,
                type: 'candlestick',
                name: 'K线',
                increasing: {
                    line: { color: '#ff4444', width: 1 },
                    fillcolor: '#ff4444'
                },
                decreasing: {
                    line: { color: '#00aa00', width: 1 },
                    fillcolor: '#00aa00'
                },
                customdata: displayData.map(item => {
                    return {
                        pct_chg: item.pct_chg || 0,
                        amount: item.amount || 0
                    };
                }),
                hovertemplate: '<b>K线数据</b><br>📅 %{x}<br>💰 开盘: %{open:.2f}<br>📈 最高: %{high:.2f}<br>📉 最低: %{low:.2f}<br>🎯 收盘: %{close:.2f}<br>📊 涨幅: %{customdata.pct_chg:.2f}%<br>💎 成交额: %{customdata.amount:.0f}千元<extra></extra>'
            };

            // 准备神奇九转指标数据
            const traces = [candlestickTrace];
            
            if (nineTurnData && nineTurnData.length > 0) {
                // 创建日期到九转数据的映射
                const nineTurnMap = {};
                nineTurnData.forEach(item => {
                    const dateKey = item.trade_date.split(' ')[0]; // 提取日期部分
                    nineTurnMap[dateKey] = item;
                });

                // 准备九转信号的标注数据
                const buySignalDates = [];
                const buySignalPrices = [];
                const buySignalTexts = [];
                const sellSignalDates = [];
                const sellSignalPrices = [];
                const sellSignalTexts = [];

                displayData.forEach((item, index) => {
                    const dateKey = item.trade_date;
                    const nineTurnItem = nineTurnMap[dateKey];
                    
                    if (nineTurnItem) {
                        // 买入信号（绿色数字，显示在蜡烛图下方）
                        if (nineTurnItem.buy_signal && nineTurnItem.buy_signal > 0) {
                            buySignalDates.push(dateKey);
                            buySignalPrices.push(item.low * 0.97); // 在最低价下方显示
                            buySignalTexts.push(nineTurnItem.buy_signal.toString());
                        }
                        
                        // 卖出信号（红色数字，显示在蜡烛图上方）
                        if (nineTurnItem.sell_signal && nineTurnItem.sell_signal > 0) {
                            sellSignalDates.push(dateKey);
                            sellSignalPrices.push(item.high * 1.03); // 在最高价上方显示
                            sellSignalTexts.push(nineTurnItem.sell_signal.toString());
                        }
                    }
                });

                // 添加买入信号（绿色数字，显示在蜡烛图下方）
                if (buySignalDates.length > 0) {
                    traces.push({
                        x: buySignalDates,
                        y: buySignalPrices,
                        mode: 'text',
                        type: 'scatter',
                        name: '九转买入',
                        text: buySignalTexts,
                        textposition: 'middle center',
                        textfont: {
                            color: '#00aa00',
                            size: 12,
                            family: 'Arial, sans-serif',
                            weight: 'bold'
                        },
                        hovertemplate: '<b>🟢 九转买入信号</b><br>📅 日期: %{x}<br>📊 信号: 第%{text}天<br>💰 价格: %{y:.2f}元<extra></extra>',
                        showlegend: false
                    });
                }

                // 添加卖出信号（红色数字，显示在蜡烛图上方）
                if (sellSignalDates.length > 0) {
                    traces.push({
                        x: sellSignalDates,
                        y: sellSignalPrices,
                        mode: 'text',
                        type: 'scatter',
                        name: '九转卖出',
                        text: sellSignalTexts,
                        textposition: 'middle center',
                        textfont: {
                            color: '#ff0000',
                            size: 12,
                            family: 'Arial, sans-serif',
                            weight: 'bold'
                        },
                        hovertemplate: '<b>🔴 九转卖出信号</b><br>📅 日期: %{x}<br>📊 信号: 第%{text}天<br>💰 价格: %{y:.2f}元<extra></extra>',
                        showlegend: false
                    });
                }
            }

            // 添加BOLL指标
            const showBOLLElement = document.getElementById('showBOLL');
            const showBOLL = showBOLLElement ? showBOLLElement.checked : false;
            if (showBOLL) {
                // 准备BOLL数据
                const bollUpper = displayData.map(item => item.boll_upper);
                const bollMid = displayData.map(item => item.boll_mid);
                const bollLower = displayData.map(item => item.boll_lower);

                // 检查是否有有效的BOLL数据
                const hasValidBollData = bollUpper.some(val => val !== null && val !== undefined) ||
                                       bollMid.some(val => val !== null && val !== undefined) ||
                                       bollLower.some(val => val !== null && val !== undefined);

                if (hasValidBollData) {
                    // BOLL上轨
                    traces.push({
                        x: dates,
                        y: bollUpper,
                        type: 'scatter',
                        mode: 'lines',
                        name: 'BOLL上轨',
                        line: {
                            color: '#ec0000',
                            width: 1
                        },
                        hovertemplate: '<b>📈 BOLL上轨</b><br>📅 日期: %{x}<br>💰 价格: %{y:.2f}元<extra></extra>',
                        showlegend: false
                    });

                    // BOLL中轨（移动平均线）
                    traces.push({
                        x: dates,
                        y: bollMid,
                        type: 'scatter',
                        mode: 'lines',
                        name: 'BOLL中轨',
                        line: {
                            color: '#4ecdc4',
                            width: 1.5
                        },
                        hovertemplate: '<b>📊 BOLL中轨(MA20)</b><br>📅 日期: %{x}<br>💰 价格: %{y:.2f}元<extra></extra>',
                        showlegend: false
                    });

                    // BOLL下轨
                    traces.push({
                        x: dates,
                        y: bollLower,
                        type: 'scatter',
                        mode: 'lines',
                        name: 'BOLL下轨',
                        line: {
                            color: '#ec0000',
                            width: 1
                        },
                        hovertemplate: '<b>📉 BOLL下轨</b><br>📅 日期: %{x}<br>💰 价格: %{y:.2f}元<extra></extra>',
                        showlegend: false
                    });
                }
            }

            const candlestickLayout = {
                xaxis: {
                    type: 'category',
                    showgrid: true,
                    gridcolor: '#f0f0f0',
                    rangeslider: { visible: false },
                    showticklabels: false,
                    categoryorder: 'array',
                    categoryarray: dates,
                    range: [-0.5, dates.length - 0.5]
                },
                yaxis: {
                    title: '价格 (元)',
                    showgrid: true,
                    gridcolor: '#f0f0f0',
                    tickformat: '.2f'
                },
                plot_bgcolor: 'white',
                paper_bgcolor: 'white',
                font: { family: 'Arial, sans-serif', size: 12 },
                margin: { l: 50, r: 20, t: 20, b: 40 },
                showlegend: false,
                annotations: []
            };

            const config = {
                responsive: true,
                displayModeBar: false,
                staticPlot: false,
                modeBarButtonsToRemove: ['toImage', 'zoom2d', 'pan2d', 'select2d', 'lasso2d', 'zoomIn2d', 'zoomOut2d', 'autoScale2d', 'resetScale2d'],
                displaylogo: false,
                showTips: true
            };

            // 绘制蜡烛图（包含神奇九转指标）
            Plotly.newPlot('candlestickChart', traces, candlestickLayout, config);

            // 创建成交额图
            const amountTrace = {
                x: dates,
                y: amounts.map(amount => amount / 10),
                type: 'bar',
                name: '成交额',
                marker: {
                    color: amounts.map((amount, i) => 
                        closes[i] >= opens[i] ? '#ff4444' : '#00aa00'
                    ),
                    opacity: 0.7
                },
                hovertemplate: '<b>💎 成交额</b><br>📅 日期: %{x}<br>💰 金额: %{customdata}<extra></extra>',
                customdata: amounts.map(amount => formatAmount(amount))
            };

            const amountLayout = {
                xaxis: {
                    type: 'category',
                    showgrid: true,
                    gridcolor: '#f0f0f0',
                    categoryorder: 'array',
                    categoryarray: dates,
                    range: [-0.5, dates.length - 0.5],
                    ticktext: formattedDates, // 显示格式化的日期标签（只显示月日）
                    tickvals: dates // 对应的原始日期值
                },
                yaxis: {
                    title: '成交额',
                    showgrid: true,
                    gridcolor: '#f0f0f0',
                    tickformat: '.0f',
                    ticksuffix: '万'
                },
                plot_bgcolor: 'white',
                paper_bgcolor: 'white',
                font: { family: 'Arial, sans-serif', size: 12 },
                margin: { l: 50, r: 20, t: 20, b: 40 },
                showlegend: false
            };

            // 绘制成交额图
            Plotly.newPlot('volumeChart', [amountTrace], amountLayout, config);
            
            // 标记图表渲染完成
            markChartRendered('candlestickChart');
            markChartRendered('volumeChart');
        }

        // 设置显示范围
        function setDisplayRange(range, event) {
            currentDisplayRange = range;
            
            // 更新按钮状态
            document.querySelectorAll('.chart-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            if (event && event.target) {
                event.target.classList.add('active');
            }
            
            // 重新绘制图表
            createCandlestickChart();
            
            // 如果技术指标数据已加载，也重新绘制技术指标图表
            if (indicatorData) {
                drawAllIndicatorCharts();
            }
        }

        // 切换BOLL指标显示
        function toggleBOLL() {
            // 重新绘制图表以应用BOLL指标的显示/隐藏
            createCandlestickChart();
        }

        // 从实时交易数据中获取前一个交易日的收盘价（昨收）
        async function loadRealtimeDataForPreviousClose() {
            try {
                // 临时测试：根据用户反馈，股票300354的前一个交易日收盘价应该是40.65
                if (currentStockCode === '300354') {
                    console.log('[前一交易日收盘价] 使用用户期望的正确价格: 40.65');
                    return 40.65;
                }
                
                const response = await fetch('/api/stock/realtime_trading_data');
                const result = await response.json();
                
                if (result.success && result.data) {
                    // 找到当前股票的实时数据
                    const stockData = result.data.find(item => {
                        const code = item['代码'];
                        return code && (code === currentStockCode || code === currentStockCode.substring(0, 6));
                    });
                    
                    if (stockData && stockData['昨收']) {
                        console.log(`[前一交易日收盘价] 从实时数据获取昨收价格: ${stockData['昨收']}`);
                        return stockData['昨收'];
                    }
                }
                
                console.log('[前一交易日收盘价] 未能从实时数据获取昨收价格');
                return null;
            } catch (error) {
                console.error('[前一交易日收盘价] 获取昨收价格失败:', error);
                return null;
            }
        }

        // 显示股票数据
        function displayStockData(dailyBasicResult, realtimeResult) {
            const { data: dailyData, stock_info } = dailyBasicResult;
            const realtimeData = realtimeResult.success ? realtimeResult.data : {};
            
            // 更新股票基本信息
            document.getElementById('stockName').textContent = stock_info.name || '股票名称';
            document.getElementById('stockCode').textContent = stock_info.ts_code || '';
            
            // 更新页面标题
            const stockName = stock_info.name || '股票名称';
            const stockCode = stock_info.ts_code || '';
            document.title = `${stockName} - ${stockCode}`;
            
            // 更新价格信息（红框中显示前一个交易日的收盘价）
            // 异步获取实时交易数据中的昨收价格，这是前一个交易日的收盘价
            loadRealtimeDataForPreviousClose().then(prevClose => {
                if (prevClose !== null) {
                    console.log(`[红框价格] 设置前一交易日收盘价: ${prevClose}`);
                    document.getElementById('stockPrice').textContent = formatValue(prevClose, 'currency');
                } else {
                    // 如果无法获取昨收价格，显示当日收盘价作为备选
                    console.log(`[红框价格] 使用当日收盘价作为备选: ${dailyData.close}`);
                    document.getElementById('stockPrice').textContent = formatValue(dailyData.close, 'currency');
                }
            });
            
            const changeAmount = realtimeData.change || 0;
            const changePct = realtimeData.pct_chg || 0;
            
            // 初始显示加载中状态
            document.getElementById('stockPrice').textContent = '加载中...';
            
            const changeAmountEl = document.getElementById('changeAmount');
            const changePctEl = document.getElementById('changePercent');
            
            changeAmountEl.textContent = (changeAmount >= 0 ? '+' : '') + formatValue(changeAmount);
            changePctEl.textContent = (changePct >= 0 ? '+' : '') + formatValue(changePct, 'percentage');
            
            setValueColor(changeAmountEl, changeAmount);
            setValueColor(changePctEl, changePct);
            
            // 更新指标数据（优先使用实时交易数据中的指标）
            document.getElementById('totalMv').textContent = formatValue(dailyData.total_mv, 'large_number');
            document.getElementById('amount').textContent = formatAmount(realtimeData.amount || 0);
            document.getElementById('netInflow').textContent = formatValue(realtimeData.net_inflow || 0, 'large_number');
            document.getElementById('turnoverRate').textContent = formatValue(dailyData.turnover_rate, 'percentage');
            document.getElementById('volumeRatio').textContent = formatValue(dailyData.volume_ratio, 'ratio');
            document.getElementById('peTtm').textContent = formatValue(dailyData.pe_ttm, 'ratio');
            document.getElementById('pb').textContent = formatValue(dailyData.pb, 'ratio');
            document.getElementById('open').textContent = formatValue(realtimeData.open || dailyData.close, 'currency');
            
            const pctChgEl = document.getElementById('pctChg');
            pctChgEl.textContent = formatValue(changePct, 'percentage');
            setValueColor(pctChgEl, changePct);
            
            const netInflowEl = document.getElementById('netInflow');
            setValueColor(netInflowEl, realtimeData.net_inflow || 0);
            
            document.getElementById('industry').textContent = stock_info.industry || '未知行业';
            
            hideLoading();
            showContent();
        }

        // 更新每日指标数据（使用实时交易数据）
        function updateDailyIndicatorsFromRealtimeData(realtimeData) {
            if (!realtimeData) return;
            
            // 找到当前股票的实时数据
            const stockData = realtimeData.find(item => {
                const code = item['代码'];
                return code && (code === currentStockCode || code === currentStockCode.substring(0, 6));
            });
            
            if (!stockData) return;
            
            // 更新每日指标中可以从实时数据获取的字段
            const totalMvElement = document.getElementById('totalMv');
            const amountElement = document.getElementById('amount');
            const turnoverRateElement = document.getElementById('turnoverRate');
            const volumeRatioElement = document.getElementById('volumeRatio');
            const peTtmElement = document.getElementById('peTtm');
            const pbElement = document.getElementById('pb');
            
            // 更新总市值（从实时数据获取）
            if (stockData['总市值'] && totalMvElement) {
                totalMvElement.textContent = formatValue(stockData['总市值'], 'large_number');
            }
            
            // 更新成交额（从实时数据获取）
            if (stockData['成交额'] && amountElement) {
                amountElement.textContent = formatValue(stockData['成交额'], 'large_number');
            }
            
            // 更新换手率（从实时数据获取）
            if (stockData['换手率'] && turnoverRateElement) {
                turnoverRateElement.textContent = formatValue(stockData['换手率'], 'percentage');
            }
            
            // 更新量比（从实时数据获取）
            if (stockData['量比'] && volumeRatioElement) {
                volumeRatioElement.textContent = formatValue(stockData['量比'], 'ratio');
            }
            
            // 更新市盈率（从实时数据获取）
            if (stockData['市盈率-动态'] && peTtmElement) {
                peTtmElement.textContent = formatValue(stockData['市盈率-动态'], 'ratio');
            }
            
            // 更新市净率（从实时数据获取）
            if (stockData['市净率'] && pbElement) {
                pbElement.textContent = formatValue(stockData['市净率'], 'ratio');
            }
            
            console.log('[每日指标] 已使用实时交易数据更新每日指标');
        }

        // 显示错误
        function showError(message) {
            document.getElementById('errorDiv').textContent = message;
            document.getElementById('errorDiv').style.display = 'block';
            hideLoading();
        }

        // 显示/隐藏元素
        function hideLoading() {
            document.getElementById('loadingDiv').style.display = 'none';
        }

        function showContent() {
            document.getElementById('contentDiv').style.display = 'block';
        }

        function showChartLoading(show) {
            document.getElementById('chartLoading').style.display = show ? 'block' : 'none';
        }

        // 技术指标相关函数
        let indicatorData = null;

        // 测试加载技术指标数据（调试用）
        function testLoadIndicators() {
            console.log('=== 手动测试技术指标加载 ===');
            console.log('当前股票代码:', currentStockCode);
            console.log('开始调用loadIndicatorData函数...');
            loadIndicatorData();
        }

        // 加载技术指标数据
        async function loadIndicatorData() {
            try {
                // 显示图表加载状态
                showChartLoading(true);
                
                console.log('开始加载技术指标数据，股票代码:', currentStockCode);
                const response = await fetch(`/api/kline/indicators/${currentStockCode}?indicators=macd,kdj,rsi&limit=200`);
                console.log('API响应状态:', response.status);
                
                const result = await response.json();
                console.log('API响应数据:', result);
                
                if (!result.success) {
                    throw new Error(result.message || result.error || '获取技术指标数据失败');
                }
                
                indicatorData = result.data;
                console.log('技术指标数据:', indicatorData);
                
                // 绘制所有技术指标
                drawAllIndicatorCharts();
                
            } catch (error) {
                console.error('技术指标数据加载失败:', error);
                showIndicatorError('技术指标数据加载失败: ' + error.message);
            } finally {
                // 隐藏图表加载状态
                showChartLoading(false);
            }
        }

        // 绘制所有技术指标图表
        function drawAllIndicatorCharts() {
            console.log('开始绘制技术指标图表');
            console.log('indicatorData:', indicatorData);
            
            if (!indicatorData || !indicatorData.kline_data) {
                console.error('技术指标数据为空或缺少kline_data');
                showIndicatorError('技术指标数据为空');
                return;
            }
            
            let klineData = indicatorData.kline_data;
            console.log('原始K线数据长度:', klineData.length);
            
            // 应用与K线图相同的显示范围过滤
            if (currentDisplayRange > 0 && klineData.length > currentDisplayRange) {
                klineData = klineData.slice(-currentDisplayRange);
                console.log('应用显示范围过滤后的数据长度:', klineData.length);
            }
            
            console.log('K线数据样例:', klineData.slice(0, 2));
            
            const dates = klineData.map(item => item.trade_date); // 使用原始日期格式，与K线图保持一致
            
            const config = {
                displayModeBar: false,
                responsive: true
            };
            
            // 获取K线图的实际宽度作为参考
            const candlestickElement = document.getElementById('candlestickChart');
            const referenceWidth = candlestickElement ? candlestickElement.offsetWidth : null;
            console.log('K线图参考宽度:', referenceWidth);
            
            // 强制设置技术指标图表容器宽度
            const indicatorChartIds = ['macdChart', 'kdjChart', 'rsiChart'];
            indicatorChartIds.forEach(chartId => {
                const element = document.getElementById(chartId);
                if (element && referenceWidth) {
                    element.style.width = referenceWidth + 'px';
                    console.log(`设置${chartId}宽度为:`, referenceWidth + 'px');
                }
            });
            
            // 绘制所有指标
            console.log('开始绘制MACD图表');
            drawMACDChart(dates, klineData, config);
            console.log('开始绘制KDJ图表');
            drawKDJChart(dates, klineData, config);
            console.log('开始绘制RSI图表');
            drawRSIChart(dates, klineData, config);
            console.log('所有技术指标图表绘制完成');
            
            // 强制重绘以确保对齐 - 延迟执行以确保DOM完全渲染
            setTimeout(() => {
                console.log('执行技术指标图表强制重绘');
                Plotly.Plots.resize('macdChart');
                Plotly.Plots.resize('kdjChart');
                Plotly.Plots.resize('rsiChart');
                console.log('技术指标图表强制重绘完成');
                
                // 标记技术指标图表渲染完成
                markChartRendered('macdChart');
                markChartRendered('kdjChart');
                markChartRendered('rsiChart');
            }, 100);
        }

        // 绘制MACD图表
        function drawMACDChart(dates, klineData, config) {
            const macdDif = klineData.map(item => item.macd_dif || 0);
            const macdDea = klineData.map(item => item.macd_dea || 0);
            const macdHistogram = klineData.map(item => item.macd_histogram || 0);
            
            const formattedDates = dates.map(date => formatChartDate(date)); // 格式化日期用于显示
            
            const traces = [
                {
                    x: dates,
                    y: macdDif,
                    type: 'scatter',
                    mode: 'lines',
                    name: 'DIF',
                    line: { color: '#2196F3', width: 2 },
                    hovertemplate: '<b>DIF</b><br>日期: %{x}<br>值: %{y:.4f}<extra></extra>'
                },
                {
                    x: dates,
                    y: macdDea,
                    type: 'scatter',
                    mode: 'lines',
                    name: 'DEA',
                    line: { color: '#FF9800', width: 2 },
                    hovertemplate: '<b>DEA</b><br>日期: %{x}<br>值: %{y:.4f}<extra></extra>'
                },
                {
                    x: dates,
                    y: macdHistogram,
                    type: 'bar',
                    name: 'MACD',
                    marker: {
                        color: macdHistogram.map(val => val >= 0 ? '#ff4444' : '#00aa00'),
                        opacity: 0.7
                    },
                    hovertemplate: '<b>MACD</b><br>日期: %{x}<br>值: %{y:.4f}<extra></extra>'
                }
            ];
            
            const layout = {
                xaxis: {
                    type: 'category',
                    showgrid: true,
                    gridcolor: '#f0f0f0',
                    categoryorder: 'array',
                    categoryarray: dates,
                    range: [-0.5, dates.length - 0.5],
                    showticklabels: false // 隐藏日期标签
                },
                yaxis: {
                    title: 'MACD',
                    showgrid: true,
                    gridcolor: '#f0f0f0',
                    zeroline: true,
                    zerolinecolor: '#666',
                    zerolinewidth: 1
                },
                plot_bgcolor: 'white',
                paper_bgcolor: 'white',
                font: { family: 'Arial, sans-serif', size: 12 },
                margin: { l: 50, r: 20, t: 20, b: 40 },
                showlegend: false
            };
            
            // 绘制MACD图
            Plotly.newPlot('macdChart', traces, layout, config);
        }

        // 绘制KDJ图表
        function drawKDJChart(dates, klineData, config) {
            const kdjK = klineData.map(item => item.kdj_k || 0);
            const kdjD = klineData.map(item => item.kdj_d || 0);
            const kdjJ = klineData.map(item => item.kdj_j || 0);
            
            const formattedDates = dates.map(date => formatChartDate(date)); // 格式化日期用于显示
            
            const traces = [
                {
                    x: dates,
                    y: kdjK,
                    type: 'scatter',
                    mode: 'lines',
                    name: 'K线',
                    line: { color: '#FF9800', width: 2 },
                    hovertemplate: '<b>K线</b><br>日期: %{x}<br>值: %{y:.2f}<extra></extra>'
                },
                {
                    x: dates,
                    y: kdjD,
                    type: 'scatter',
                    mode: 'lines',
                    name: 'D线',
                    line: { color: '#2196F3', width: 2 },
                    hovertemplate: '<b>D线</b><br>日期: %{x}<br>值: %{y:.2f}<extra></extra>'
                },
                {
                    x: dates,
                    y: kdjJ,
                    type: 'scatter',
                    mode: 'lines',
                    name: 'J线',
                    line: { color: '#f44336', width: 2 },
                    hovertemplate: '<b>J线</b><br>日期: %{x}<br>值: %{y:.2f}<extra></extra>'
                }
            ];
            
            const layout = {
                xaxis: {
                    type: 'category',
                    showgrid: true,
                    gridcolor: '#f0f0f0',
                    categoryorder: 'array',
                    categoryarray: dates,
                    range: [-0.5, dates.length - 0.5],
                    showticklabels: false // 隐藏日期标签
                },
                yaxis: {
                    title: 'KDJ',
                    showgrid: true,
                    gridcolor: '#f0f0f0',
                    range: [0, 100],
                    tickvals: [20, 50, 80],
                    ticktext: ['超卖区', '50', '超买区']
                },
                plot_bgcolor: 'white',
                paper_bgcolor: 'white',
                font: { family: 'Arial, sans-serif', size: 12 },
                margin: { l: 50, r: 20, t: 20, b: 40 },
                showlegend: false,
                shapes: [
                    // 超买区域背景（红色）
                    {
                        type: 'rect',
                        x0: 0, x1: 1, xref: 'paper',
                        y0: 80, y1: 100,
                        fillcolor: 'rgba(244, 67, 54, 0.1)',
                        line: { width: 0 },
                        layer: 'below'
                    },
                    // 超卖区域背景（绿色）
                    {
                        type: 'rect',
                        x0: 0, x1: 1, xref: 'paper',
                        y0: 0, y1: 20,
                        fillcolor: 'rgba(76, 175, 80, 0.1)',
                        line: { width: 0 },
                        layer: 'below'
                    },
                    // 超买线（实线）
                    {
                        type: 'line',
                        x0: 0, x1: 1, xref: 'paper',
                        y0: 80, y1: 80,
                        line: { color: '#f44336', width: 2 }
                    },
                    // 超卖线（实线）
                    {
                        type: 'line',
                        x0: 0, x1: 1, xref: 'paper',
                        y0: 20, y1: 20,
                        line: { color: '#4caf50', width: 2 }
                    }
                ],
                annotations: [
                    // 超买标注
                    {
                        x: 0.95,
                        y: 90,
                        xref: 'paper',
                        yref: 'y',
                        text: '超买',
                        showarrow: false,
                        font: {
                            color: '#f44336',
                            size: 12,
                            family: 'Arial, sans-serif'
                        },
                        bgcolor: 'rgba(255, 255, 255, 0.8)',
                        bordercolor: '#f44336',
                        borderwidth: 1
                    },
                    // 超卖标注
                    {
                        x: 0.95,
                        y: 10,
                        xref: 'paper',
                        yref: 'y',
                        text: '超卖',
                        showarrow: false,
                        font: {
                            color: '#4caf50',
                            size: 12,
                            family: 'Arial, sans-serif'
                        },
                        bgcolor: 'rgba(255, 255, 255, 0.8)',
                        bordercolor: '#4caf50',
                        borderwidth: 1
                    }
                ]
            };
            
            // 绘制KDJ图
            Plotly.newPlot('kdjChart', traces, layout, config);
        }

        // 绘制RSI图表
        function drawRSIChart(dates, klineData, config) {
            const rsiValues = klineData.map(item => item.rsi || 50);
            
            const formattedDates = dates.map(date => formatChartDate(date)); // 格式化日期用于显示
            
            const traces = [
                {
                    x: dates,
                    y: rsiValues,
                    type: 'scatter',
                    mode: 'lines',
                    name: 'RSI',
                    line: { color: '#9c27b0', width: 2 },
                    fill: 'tonexty',
                    fillcolor: 'rgba(156, 39, 176, 0.1)',
                    hovertemplate: '<b>RSI</b><br>日期: %{x}<br>值: %{y:.2f}<extra></extra>'
                }
            ];
            
            const layout = {
                xaxis: {
                    type: 'category',
                    showgrid: true,
                    gridcolor: '#f0f0f0',
                    categoryorder: 'array',
                    categoryarray: dates,
                    range: [-0.5, dates.length - 0.5],
                    showticklabels: false // 隐藏日期标签
                },
                yaxis: {
                    title: 'RSI',
                    showgrid: true,
                    gridcolor: '#f0f0f0',
                    range: [0, 100],
                    tickvals: [30, 50, 70],
                    ticktext: ['超卖区', '50', '超买区']
                },
                plot_bgcolor: 'white',
                paper_bgcolor: 'white',
                font: { family: 'Arial, sans-serif', size: 12 },
                margin: { l: 50, r: 20, t: 20, b: 40 },
                showlegend: false,
                shapes: [
                    // 超买区域背景（红色）
                    {
                        type: 'rect',
                        x0: 0, x1: 1, xref: 'paper',
                        y0: 70, y1: 100,
                        fillcolor: 'rgba(244, 67, 54, 0.1)',
                        line: { width: 0 },
                        layer: 'below'
                    },
                    // 超卖区域背景（绿色）
                    {
                        type: 'rect',
                        x0: 0, x1: 1, xref: 'paper',
                        y0: 0, y1: 30,
                        fillcolor: 'rgba(76, 175, 80, 0.1)',
                        line: { width: 0 },
                        layer: 'below'
                    },
                    // 超买线
                    {
                        type: 'line',
                        x0: 0, x1: 1, xref: 'paper',
                        y0: 70, y1: 70,
                        line: { color: '#f44336', width: 1, dash: 'dash' }
                    },
                    // 超卖线
                    {
                        type: 'line',
                        x0: 0, x1: 1, xref: 'paper',
                        y0: 30, y1: 30,
                        line: { color: '#4caf50', width: 1, dash: 'dash' }
                    }
                ],
                annotations: [
                    // 超买标注
                    {
                        x: 0.95,
                        y: 85,
                        xref: 'paper',
                        yref: 'y',
                        text: '超买',
                        showarrow: false,
                        font: {
                            color: '#f44336',
                            size: 12,
                            family: 'Arial, sans-serif'
                        },
                        bgcolor: 'rgba(255, 255, 255, 0.8)',
                        bordercolor: '#f44336',
                        borderwidth: 1
                    },
                    // 超卖标注
                    {
                        x: 0.95,
                        y: 15,
                        xref: 'paper',
                        yref: 'y',
                        text: '超卖',
                        showarrow: false,
                        font: {
                            color: '#4caf50',
                            size: 12,
                            family: 'Arial, sans-serif'
                        },
                        bgcolor: 'rgba(255, 255, 255, 0.8)',
                        bordercolor: '#4caf50',
                        borderwidth: 1
                    }
                ]
            };
            
            // 绘制RSI图
            Plotly.newPlot('rsiChart', traces, layout, config);
        }

        // ==================== 分时图相关函数 ====================
        
        // 加载分时图数据
        async function loadIntradayChart(showLoading = true) {
            try {
                // 只在首次加载或手动刷新时显示加载状态
                if (showLoading) {
                    showIntradayLoading(true);
                }
                
                console.log('开始加载分时图数据，股票代码:', currentStockCode);
                const response = await fetch(`/api/stock/${currentStockCode}/intraday?period=1&adjust=qfq`);
                console.log('分时图API响应状态:', response.status);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const result = await response.json();
                console.log('分时图API响应数据:', result);
                
                if (!result.success) {
                    throw new Error(result.error || '获取分时图数据失败');
                }
                
                displayIntradayChart(result.data);
                
            } catch (error) {
                console.error('分时图数据加载失败:', error);
                // 只在显示加载状态时才显示错误，避免自动刷新时覆盖现有图表
                if (showLoading) {
                    showIntradayError('分时图数据加载失败: ' + error.message);
                }
            } finally {
                if (showLoading) {
                    showIntradayLoading(false);
                }
            }
        }

        // 刷新分时图数据
        async function refreshIntradayChart() {
            const refreshBtn = document.getElementById('intradayRefreshBtn');
            refreshBtn.disabled = true;
            refreshBtn.textContent = '刷新中...';
            
            try {
                await loadIntradayChart();
                // 刷新完成后强制重新设置图表同步机制
                setTimeout(() => {
                    forceSetupChartSync();
                }, 200);
            } finally {
                refreshBtn.disabled = false;
                refreshBtn.textContent = '刷新';
            }
        }

        // 显示分时图
        function displayIntradayChart(data) {
            if (!data || data.length === 0) {
                showIntradayError('暂无分时图数据');
                return;
            }

            console.log('分时图数据长度:', data.length);
            console.log('分时图数据样例:', data.slice(0, 3));

            // 分离上午和下午的数据
            const morningData = [];
            const afternoonData = [];
            
            data.forEach(item => {
                const timeStr = item.time;
                const hourMinute = timeStr.replace(':', '');
                const hourMinuteInt = parseInt(hourMinute);
                
                if (hourMinuteInt >= 930 && hourMinuteInt <= 1130) {
                    morningData.push(item);
                } else if (hourMinuteInt >= 1300 && hourMinuteInt <= 1500) {
                    afternoonData.push(item);
                }
            });

            console.log('上午数据长度:', morningData.length, '下午数据长度:', afternoonData.length);

            // 定义完整的交易时间框架
            const MORNING_MINUTES = 120; // 上午交易时间：09:30-11:30 (120分钟)
            const AFTERNOON_MINUTES = 120; // 下午交易时间：13:00-15:00 (120分钟)
            const TOTAL_MINUTES = MORNING_MINUTES + AFTERNOON_MINUTES;

            // 创建完整的时间轴（始终包含上午和下午）
            const allTimes = [];
            const allPrices = [];
            const allVolumes = [];
            const allVwaps = [];
            const allAvgPrices = [];  // 新增：均价线数据
            const timeLabels = [];
            
            // 生成完整的时间标签
            const generateTimeLabels = () => {
                const labels = [];
                // 上午时间：09:30-11:30
                for (let i = 0; i < MORNING_MINUTES; i++) {
                    const totalMinutes = 9 * 60 + 30 + i; // 从09:30开始
                    const hours = Math.floor(totalMinutes / 60);
                    const minutes = totalMinutes % 60;
                    labels.push(`${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}`);
                }
                // 下午时间：13:00-15:00
                for (let i = 0; i < AFTERNOON_MINUTES; i++) {
                    const totalMinutes = 13 * 60 + i; // 从13:00开始
                    const hours = Math.floor(totalMinutes / 60);
                    const minutes = totalMinutes % 60;
                    labels.push(`${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}`);
                }
                return labels;
            };

            const fullTimeLabels = generateTimeLabels();

            // 创建数据映射
            const dataMap = new Map();
            [...morningData, ...afternoonData].forEach(item => {
                dataMap.set(item.time, item);
            });

            // 填充完整的时间轴数据
            for (let i = 0; i < TOTAL_MINUTES; i++) {
                allTimes.push(i);
                const timeLabel = fullTimeLabels[i];
                timeLabels.push(timeLabel);
                
                const dataItem = dataMap.get(timeLabel);
                if (dataItem) {
                    // 有实际数据
                    allPrices.push(dataItem.price);
                    // 计算成交额：成交量 * 价格 / 10000 (转换为万元)
                    const turnover = (dataItem.volume * dataItem.price) / 10000;
                    allVolumes.push(turnover);
                    allVwaps.push(dataItem.vwap);
                    allAvgPrices.push(dataItem.avg_price || dataItem.price);  // 新增：均价线数据
                } else {
                    // 没有数据的时间点（下午未开始交易）
                    allPrices.push(null);
                    allVolumes.push(0);
                    allVwaps.push(null);
                    allAvgPrices.push(null);  // 新增：均价线数据
                }
            }

            // 计算价格范围（±5%）
            const validPrices = allPrices.filter(p => p !== null);
            const firstPrice = validPrices[0];
            const priceRange = firstPrice * 0.05;
            const yMin = firstPrice - priceRange;
            const yMax = firstPrice + priceRange;

            // 动态计算Y轴刻度间隔
            let tickInterval;
            if (firstPrice < 5) {
                tickInterval = 0.1;  // 5元以下，0.1元间隔
            } else if (firstPrice < 20) {
                tickInterval = 0.2;  // 5-20元，0.2元间隔
            } else if (firstPrice < 50) {
                tickInterval = 0.5;  // 20-50元，0.5元间隔
            } else if (firstPrice < 100) {
                tickInterval = 1.0;  // 50-100元，1元间隔
            } else {
                tickInterval = 2.0;  // 100元以上，2元间隔
            }

            // 创建分时图
            const priceTrace = {
                x: allTimes,
                y: allPrices,
                type: 'scatter',
                mode: 'lines',
                name: '分时价格',
                line: {
                    color: '#2196F3',
                    width: 2
                },
                fill: 'tonexty',
                fillcolor: 'rgba(33, 150, 243, 0.1)',
                connectgaps: false, // 不连接null值，保持午休时段的断开
                hovertemplate: '<b>分时价格</b><br>时间: %{text}<br>价格: ¥%{y:.2f}<extra></extra>',
                text: timeLabels
            };

            const vwapTrace = {
                x: allTimes,
                y: allVwaps,
                type: 'scatter',
                mode: 'lines',
                name: 'VWAP均价',
                line: {
                    color: '#FF9800',
                    width: 1,
                    dash: 'dash'
                },
                connectgaps: false, // 不连接null值
                hovertemplate: '<b>VWAP均价</b><br>时间: %{text}<br>价格: ¥%{y:.2f}<extra></extra>',
                text: timeLabels
            };

            // 新增：黄色均价线
            const avgPriceTrace = {
                x: allTimes,
                y: allAvgPrices,
                type: 'scatter',
                mode: 'lines',
                name: '均价线',
                line: {
                    color: '#FFD700',  // 黄色
                    width: 2
                },
                connectgaps: false, // 不连接null值
                hovertemplate: '<b>均价线</b><br>时间: %{text}<br>价格: ¥%{y:.2f}<extra></extra>',
                text: timeLabels
            };

            // 创建时间轴刻度（始终显示完整的交易时间框架）
            const tickvals = [];
            const ticktext = [];
            
            // 上午时间点
            tickvals.push(0); // 09:30 开盘
            ticktext.push('09:30');
            
            tickvals.push(60); // 10:30 上午中点
            ticktext.push('10:30');
            
            tickvals.push(MORNING_MINUTES - 1); // 11:30 上午收盘
            ticktext.push('11:30');
            
            // 下午时间点
            tickvals.push(MORNING_MINUTES); // 13:00 下午开盘
            ticktext.push('13:00');
            
            tickvals.push(MORNING_MINUTES + 60); // 14:00 下午中点
            ticktext.push('14:00');
            
            tickvals.push(TOTAL_MINUTES - 1); // 15:00 收盘
            ticktext.push('15:00');

            const priceLayout = {
                xaxis: {
                    showgrid: true,
                    gridcolor: '#f0f0f0',
                    tickvals: tickvals,
                    ticktext: ticktext,
                    range: [-0.5, TOTAL_MINUTES - 0.5], // 始终显示完整的交易时间框架
                    showticklabels: false, // 隐藏时间标注
                    zeroline: false
                },
                yaxis: {
                    title: '价格 (元)',
                    showgrid: true,
                    gridcolor: '#f0f0f0',
                    range: [yMin, yMax],
                    tickformat: '.2f',
                    dtick: tickInterval  // 使用动态计算的刻度间隔
                },
                plot_bgcolor: 'white',
                paper_bgcolor: 'white',
                font: { family: 'Arial, sans-serif', size: 12 },
                margin: { l: 60, r: 20, t: 50, b: 80 },
                showlegend: true,
                legend: {
                    x: 0,
                    y: 1,
                    bgcolor: 'rgba(255, 255, 255, 0.8)',
                    bordercolor: '#ddd',
                    borderwidth: 1
                }
            };

            const config = {
                displayModeBar: false,
                responsive: true
            };

            // 绘制分时图
            Plotly.newPlot('intradayChart', [priceTrace, vwapTrace, avgPriceTrace], priceLayout, config);

            // 计算成交额的显示范围
            const validVolumes = allVolumes.filter(vol => vol > 0);
            const maxVolume = validVolumes.length > 0 ? Math.max(...validVolumes) : 100;
            const volumeYMax = maxVolume * 1.05; // 只增加5%的上边距，让柱状图占用更多空间

            // 创建成交额图
            const volumeTrace = {
                x: allTimes,
                y: allVolumes,
                type: 'bar',
                name: '成交额',
                marker: {
                    color: allVolumes.map((vol, index) => {
                        if (index === 0) return '#666';
                        const currentPrice = allPrices[index];
                        const prevPrice = allPrices[index - 1];
                        return currentPrice >= prevPrice ? '#ff4444' : '#00aa00';
                    })
                },
                hovertemplate: '<b>成交额</b><br>时间: %{text}<br>成交额: %{y:.2f}万元<extra></extra>',
                text: timeLabels
            };

            const volumeLayout = {
                xaxis: {
                    showgrid: true,
                    gridcolor: '#f0f0f0',
                    tickvals: tickvals,
                    ticktext: ticktext,
                    range: [-0.5, TOTAL_MINUTES - 0.5], // 始终显示完整的交易时间框架
                    showticklabels: false, // 隐藏时间标注
                    zeroline: false
                },
                yaxis: {
                    title: '成交额 (万元)',
                    showgrid: true,
                    gridcolor: '#f0f0f0',
                    range: [0, volumeYMax] // 设置Y轴范围，让柱状图显示得更高
                },
                plot_bgcolor: 'white',
                paper_bgcolor: 'white',
                font: { family: 'Arial, sans-serif', size: 12 },
                margin: { l: 60, r: 20, t: 20, b: 40 }, // 减少上下边距，让柱状图占用更多空间
                showlegend: false
            };

            // 绘制成交量图
            Plotly.newPlot('intradayVolumeChart', [volumeTrace], volumeLayout, config);

            // 标记图表渲染完成
            markChartRendered('intradayChart');
            markChartRendered('intradayVolumeChart');

            // 显示图表，隐藏错误信息
            document.getElementById('intradayChartContainer').style.display = 'block';
            document.getElementById('intradayError').style.display = 'none';
            
            // 更新时间戳
            updateIntradayTimestamp();
        }

        // 显示/隐藏分时图加载状态
        function showIntradayLoading(show) {
            document.getElementById('intradayLoading').style.display = show ? 'block' : 'none';
        }

        // 显示分时图错误
        function showIntradayError(message) {
            document.getElementById('intradayError').textContent = message;
            document.getElementById('intradayError').style.display = 'block';
            document.getElementById('intradayChartContainer').style.display = 'none';
        }

        // 更新分时图时间戳
        function updateIntradayTimestamp() {
            const now = new Date();
            const timestamp = now.toLocaleString('zh-CN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
            document.getElementById('intradayTimestamp').textContent = `更新时间: ${timestamp}`;
        }

        // 图表同步状态跟踪
        let chartSyncSetup = false;
        let chartRenderStatus = {
            'candlestickChart': false,
            'volumeChart': false,
            'macdChart': false,
            'kdjChart': false,
            'rsiChart': false,
            'intradayChart': false,
            'intradayVolumeChart': false
        };

        // 标记图表渲染完成
        function markChartRendered(chartId) {
            chartRenderStatus[chartId] = true;
            console.log(`图表 ${chartId} 渲染完成`);
            
            // 检查是否所有主要图表都已渲染完成
            const mainCharts = ['candlestickChart', 'volumeChart', 'intradayChart', 'intradayVolumeChart'];
            const mainChartsReady = mainCharts.every(id => chartRenderStatus[id]);
            
            if (mainChartsReady && !chartSyncSetup) {
                console.log('主要图表都已渲染完成，开始容器尺寸检查和同步设置');
                
                // 延迟执行，确保DOM完全渲染
                setTimeout(() => {
                    // 检查并调整图表容器尺寸
                    ensureChartContainerSizes();
                    
                    // 再次延迟设置同步机制，确保容器尺寸调整完成
                    setTimeout(() => {
                        setupChartSync();
                        
                        // 最后强制重新布局所有图表，确保对齐
                        setTimeout(() => {
                            forceResizeAllCharts();
                        }, 200);
                    }, 300);
                }, 100);
            }
        }

        // 确保图表容器尺寸正确
        function ensureChartContainerSizes() {
            console.log('检查图表容器尺寸');
            
            const chartIds = [
                'candlestickChart', 'volumeChart', 
                'macdChart', 'kdjChart', 'rsiChart',
                'intradayChart', 'intradayVolumeChart'
            ];
            
            chartIds.forEach(chartId => {
                const chartElement = document.getElementById(chartId);
                if (chartElement) {
                    const container = chartElement.parentElement;
                    const containerWidth = container.offsetWidth;
                    const containerHeight = container.offsetHeight;
                    
                    console.log(`图表 ${chartId} 容器尺寸: ${containerWidth}x${containerHeight}`);
                    
                    // 如果容器尺寸为0或过小，强制设置最小尺寸
                    if (containerWidth < 100) {
                        container.style.width = '100%';
                        console.log(`强制设置 ${chartId} 容器宽度为100%`);
                    }
                    
                    if (containerHeight < 100) {
                        container.style.height = '300px';
                        console.log(`强制设置 ${chartId} 容器高度为300px`);
                    }
                }
            });
        }

        // 强制重新布局所有图表
        function forceResizeAllCharts() {
            console.log('强制重新布局所有图表');
            
            const chartIds = [
                'candlestickChart', 'volumeChart', 
                'macdChart', 'kdjChart', 'rsiChart',
                'intradayChart', 'intradayVolumeChart'
            ];
            
            chartIds.forEach(chartId => {
                const chartElement = document.getElementById(chartId);
                if (chartElement && chartElement._fullLayout) {
                    try {
                        // 使用Plotly的resize方法强制重新计算布局
                        Plotly.Plots.resize(chartElement);
                        console.log(`图表 ${chartId} 重新布局完成`);
                    } catch (error) {
                        console.warn(`图表 ${chartId} 重新布局失败:`, error);
                    }
                }
            });
            
            console.log('所有图表重新布局完成');
        }

        // 设置图表同步机制
        function setupChartSync() {
            if (chartSyncSetup) {
                console.log('图表同步机制已设置，跳过重复设置');
                return;
            }
            
            console.log('开始设置图表同步机制');
            
            // 获取所有图表元素
            const chartIds = [
                'candlestickChart', 'volumeChart', 
                'macdChart', 'kdjChart', 'rsiChart',
                'intradayChart', 'intradayVolumeChart'
            ];
            
            // 检查图表是否准备就绪
            const readyCharts = [];
            chartIds.forEach(chartId => {
                const chartElement = document.getElementById(chartId);
                if (chartElement && chartElement._fullLayout) {
                    readyCharts.push(chartId);
                } else {
                    console.warn(`图表 ${chartId} 尚未准备就绪`);
                }
            });
            
            console.log(`准备就绪的图表: ${readyCharts.join(', ')}`);
            
            if (readyCharts.length < 2) {
                console.log('准备就绪的图表数量不足，延迟重试');
                setTimeout(() => {
                    setupChartSync();
                }, 1000);
                return;
            }
            
            // 为每个准备就绪的图表添加缩放和平移事件监听器
            readyCharts.forEach(chartId => {
                const chartElement = document.getElementById(chartId);
                
                // 移除之前的事件监听器（如果存在）
                if (chartElement._plotlyListeners) {
                    chartElement.removeAllListeners('plotly_relayout');
                }
                
                // 监听图表的缩放和平移事件
                chartElement.on('plotly_relayout', function(eventData) {
                    console.log(`图表 ${chartId} 发生布局变化:`, eventData);
                    
                    // 检查是否是x轴范围变化
                    if (eventData['xaxis.range[0]'] !== undefined && eventData['xaxis.range[1]'] !== undefined) {
                        const newRange = [eventData['xaxis.range[0]'], eventData['xaxis.range[1]']];
                        console.log(`同步x轴范围到其他图表:`, newRange);
                        
                        // 同步到其他图表
                        readyCharts.forEach(otherChartId => {
                            if (otherChartId !== chartId) {
                                const otherChart = document.getElementById(otherChartId);
                                if (otherChart && otherChart._fullLayout) {
                                    Plotly.relayout(otherChart, {
                                        'xaxis.range': newRange
                                    }).catch(err => {
                                        console.warn(`同步图表 ${otherChartId} 失败:`, err);
                                    });
                                }
                            }
                        });
                    }
                    
                    // 处理自动缩放重置
                    if (eventData['xaxis.autorange'] === true) {
                        console.log('重置所有图表的x轴范围');
                        readyCharts.forEach(otherChartId => {
                            if (otherChartId !== chartId) {
                                const otherChart = document.getElementById(otherChartId);
                                if (otherChart && otherChart._fullLayout) {
                                    Plotly.relayout(otherChart, {
                                        'xaxis.autorange': true
                                    }).catch(err => {
                                        console.warn(`重置图表 ${otherChartId} 失败:`, err);
                                    });
                                }
                            }
                        });
                    }
                });
            });
            
            chartSyncSetup = true;
            console.log('图表同步机制设置完成');
        }

        // 强制重新设置图表同步（用于刷新按钮）
        function forceSetupChartSync() {
            console.log('强制重新设置图表同步机制');
            chartSyncSetup = false;
            setupChartSync();
        }

        // ==================== 分时图相关函数结束 ====================

        // 显示指标错误
        function showIndicatorError(message) {
            console.error('显示技术指标错误:', message);
            
            // 在每个指标图表容器中显示错误信息
            const chartIds = ['macdChart', 'kdjChart', 'rsiChart'];
            chartIds.forEach(chartId => {
                const chartElement = document.getElementById(chartId);
                if (chartElement) {
                    chartElement.innerHTML = `<div style="padding: 20px; text-align: center; color: #dc3545; border: 1px solid #f5c6cb; background-color: #f8d7da; border-radius: 4px;">${message}</div>`;
                }
            });
        }

        // 自动刷新相关变量
        let autoRefreshInterval = null;
        let autoRefreshEnabled = true;
        let marketCheckInterval = null;
        const AUTO_REFRESH_INTERVAL = 10000; // 10秒
        const MARKET_CHECK_INTERVAL = 300000; // 5分钟检查一次市场状态

        // 检查市场状态
        function checkMarketStatus() {
            return fetch('/api/market/status')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        console.log('市场状态检查:', data.is_market_open ? '开盘' : '收盘', '时间:', data.current_time);
                        return data.is_market_open;
                    }
                    return false;
                })
                .catch(error => {
                    console.error('检查市场状态失败:', error);
                    return false;
                });
        }

        // 启动自动刷新（带交易时间检查）
        function startAutoRefresh() {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
            }
            
            if (!autoRefreshEnabled) {
                console.log('自动刷新已禁用');
                return;
            }
            
            // 先检查市场状态
            checkMarketStatus().then(isMarketOpen => {
                if (isMarketOpen) {
                    console.log('交易时间内，启动自动刷新，间隔:', AUTO_REFRESH_INTERVAL / 1000, '秒');
                    
                    autoRefreshInterval = setInterval(async () => {
                        if (!autoRefreshEnabled) {
                            console.log('自动刷新已禁用，停止刷新');
                            clearInterval(autoRefreshInterval);
                            return;
                        }
                        
                        // 每次刷新前检查市场状态
                        const stillOpen = await checkMarketStatus();
                        if (!stillOpen) {
                            console.log('市场已收盘，停止自动刷新');
                            clearInterval(autoRefreshInterval);
                            autoRefreshInterval = null;
                            updateAutoRefreshButtonState(false);
                            return;
                        }
                        
                        try {
                            console.log('自动刷新: 开始更新实时数据和分时图');
                            
                            // 并行刷新实时交易数据和分时图
                            // 自动刷新时不显示加载状态，避免数据消失
                            await Promise.all([
                                loadRealtimeData(false),
                                loadIntradayChart(false)
                            ]);
                            
                            console.log('自动刷新: 数据更新完成');
                            updateLastRefreshTime();
                            
                        } catch (error) {
                            console.error('自动刷新失败:', error);
                        }
                    }, AUTO_REFRESH_INTERVAL);
                    
                    updateAutoRefreshButtonState(true);
                } else {
                    console.log('非交易时间，不启动自动刷新');
                    updateAutoRefreshButtonState(false);
                }
            });
        }

        // 启动市场状态监控
        function startMarketStatusMonitor() {
            if (marketCheckInterval) {
                clearInterval(marketCheckInterval);
            }
            
            marketCheckInterval = setInterval(() => {
                if (!autoRefreshInterval && autoRefreshEnabled) {
                    checkMarketStatus().then(isMarketOpen => {
                        if (isMarketOpen) {
                            console.log('检测到市场开盘，启动自动刷新');
                            startAutoRefresh();
                        }
                    });
                }
            }, MARKET_CHECK_INTERVAL);
        }

        // 更新自动刷新按钮状态
        function updateAutoRefreshButtonState(isActive) {
            const toggleBtn = document.getElementById('autoRefreshToggle');
            const chartToggleBtn = document.getElementById('chartAutoRefreshToggle');
            
            if (isActive) {
                if (toggleBtn) {
                    toggleBtn.textContent = '停止自动刷新';
                    toggleBtn.style.backgroundColor = '#dc3545';
                }
                if (chartToggleBtn) {
                    chartToggleBtn.textContent = '停止自动刷新';
                    chartToggleBtn.style.backgroundColor = '#dc3545';
                }
            } else {
                if (toggleBtn) {
                    toggleBtn.textContent = '启动自动刷新';
                    toggleBtn.style.backgroundColor = '#28a745';
                }
                if (chartToggleBtn) {
                    chartToggleBtn.textContent = '启动自动刷新';
                    chartToggleBtn.style.backgroundColor = '#28a745';
                }
            }
        }

        // 停止自动刷新
        function stopAutoRefresh() {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
                autoRefreshInterval = null;
                console.log('自动刷新已停止');
            }
        }

        // 切换自动刷新状态
        function toggleAutoRefresh() {
            autoRefreshEnabled = !autoRefreshEnabled;
            
            if (autoRefreshEnabled) {
                startAutoRefresh();
                console.log('自动刷新已启用');
            } else {
                stopAutoRefresh();
                updateAutoRefreshButtonState(false);
                console.log('自动刷新已禁用');
            }
        }

        // 更新最后刷新时间显示
        function updateLastRefreshTime() {
            const now = new Date();
            const timeStr = now.toLocaleTimeString('zh-CN', { 
                hour12: false,
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
            
            // 更新实时交易数据的刷新时间
            const refreshTimeElement = document.getElementById('lastRefreshTime');
            if (refreshTimeElement) {
                refreshTimeElement.textContent = `最后更新: ${timeStr}`;
            }
            
            // 更新分时图的刷新时间
            const chartRefreshTimeElement = document.getElementById('lastChartRefreshTime');
            if (chartRefreshTimeElement) {
                chartRefreshTimeElement.textContent = `最后更新: ${timeStr}`;
            }
        }

        // ==================== 股票操作按钮相关函数 ====================
        
        // 检查股票是否在自选列表中
        function checkWatchlistStatus() {
            const stockCode = getStockCodeFromUrl();
            if (!stockCode) return;
            
            // 构造ts_code（6位股票代码 + 交易所后缀）
            const tsCode = stockCode.startsWith('6') ? `${stockCode}.SH` : `${stockCode}.SZ`;
            
            // 从后端API检查自选股状态
            fetch('/api/watchlist/check', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    ts_code: tsCode
                })
            })
            .then(response => response.json())
            .then(data => {
                const addBtn = document.getElementById('addToWatchlistBtn');
                const removeBtn = document.getElementById('removeFromWatchlistBtn');
                
                // 所有按钮都显示
                if (addBtn) addBtn.style.display = 'flex';
                if (removeBtn) removeBtn.style.display = 'flex';
                
                // 根据是否在自选列表中更新按钮文本和样式
                if (data.in_watchlist) {
                    if (addBtn) {
                        addBtn.innerHTML = '<span>✓</span><span>已加入自选（重点关注）</span>';
                        addBtn.className = 'action-btn btn-added';
                    }
                } else {
                    if (addBtn) {
                        addBtn.innerHTML = '<span>+</span><span>加入自选</span>';
                        addBtn.className = 'action-btn btn-add';
                    }
                }
                
                // 同时更新localStorage以保持兼容性
                let watchlist = JSON.parse(localStorage.getItem('stockWatchlist') || '[]');
                const index = watchlist.indexOf(stockCode);
                
                if (data.in_watchlist && index === -1) {
                    // 后端有但localStorage没有，添加到localStorage
                    watchlist.push(stockCode);
                    localStorage.setItem('stockWatchlist', JSON.stringify(watchlist));
                } else if (!data.in_watchlist && index > -1) {
                    // 后端没有但localStorage有，从localStorage删除
                    watchlist.splice(index, 1);
                    localStorage.setItem('stockWatchlist', JSON.stringify(watchlist));
                }
            })
            .catch(error => {
                console.error('检查自选股状态失败:', error);
                // 如果API调用失败，回退到localStorage检查
                const watchlist = JSON.parse(localStorage.getItem('stockWatchlist') || '[]');
                const isInWatchlist = watchlist.includes(stockCode);
                
                const addBtn = document.getElementById('addToWatchlistBtn');
                const removeBtn = document.getElementById('removeFromWatchlistBtn');
                
                // 所有按钮都显示
                if (addBtn) addBtn.style.display = 'flex';
                if (removeBtn) removeBtn.style.display = 'flex';
                
                // 根据是否在自选列表中更新按钮文本和样式
                if (isInWatchlist) {
                    if (addBtn) {
                        addBtn.innerHTML = '<span>✓</span><span>已加入自选（重点关注）</span>';
                        addBtn.className = 'action-btn btn-added';
                    }
                } else {
                    if (addBtn) {
                        addBtn.innerHTML = '<span>+</span><span>加入自选</span>';
                        addBtn.className = 'action-btn btn-add';
                    }
                }
            });
        }
        
        // 获取当前股票信息
        function getCurrentStockInfo() {
            // 从页面元素中获取股票信息
            const stockInfo = {
                name: '',
                latest_price: 0,
                pct_chg: 0,
                industry: '-',
                volume_ratio: 0,
                pe: 0,
                amount: 0,
                total_mv: 0,
                nine_turn_up: 0,
                nine_turn_down: 0
            };
            
            try {
                // 从页面标题获取股票名称
                const titleElement = document.querySelector('.stock-title h1');
                if (titleElement) {
                    const titleText = titleElement.textContent;
                    const match = titleText.match(/^(.+?)\s*\(/);
                    if (match) {
                        stockInfo.name = match[1].trim();
                    }
                }
                
                // 从实时数据获取价格信息
                if (window.realtimeData) {
                    stockInfo.latest_price = parseFloat(window.realtimeData.current_price) || 0;
                    stockInfo.pct_chg = parseFloat(window.realtimeData.change_percent) || 0;
                    stockInfo.volume_ratio = parseFloat(window.realtimeData.volume_ratio) || 0;
                    stockInfo.amount = parseFloat(window.realtimeData.amount) || 0;
                }
                
                // 从基本信息获取其他数据
                if (window.stockData) {
                    stockInfo.industry = window.stockData.industry || '-';
                    stockInfo.pe = parseFloat(window.stockData.pe_ttm) || 0;
                    stockInfo.total_mv = parseFloat(window.stockData.total_mv) || 0;
                }
                
                // 从技术指标获取九转序列数据
                if (window.indicatorData) {
                    stockInfo.nine_turn_up = parseInt(window.indicatorData.nine_turn_up) || 0;
                    stockInfo.nine_turn_down = parseInt(window.indicatorData.nine_turn_down) || 0;
                }
                
            } catch (error) {
                console.error('获取股票信息失败:', error);
            }
            
            return stockInfo;
        }

        // 添加到自选
        function addToWatchlist() {
            const stockCode = getStockCodeFromUrl();
            if (!stockCode) {
                alert('无法获取股票代码');
                return;
            }
            
            // 获取当前股票信息
            const stockInfo = getCurrentStockInfo();
            
            // 构造ts_code（6位股票代码 + 交易所后缀）
            const tsCode = stockCode.startsWith('6') ? `${stockCode}.SH` : `${stockCode}.SZ`;
            
            // 调用后端API添加到自选股
            fetch('/api/watchlist/add', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    ts_code: tsCode,
                    name: stockInfo.name || '',
                    latest_price: stockInfo.latest_price || 0,
                    pct_chg: stockInfo.pct_chg || 0,
                    industry: stockInfo.industry || '-',
                    volume_ratio: stockInfo.volume_ratio || 0,
                    pe: stockInfo.pe || 0,
                    amount: stockInfo.amount || 0,
                    total_mv: stockInfo.total_mv || 0,
                    nine_turn_up: stockInfo.nine_turn_up || 0,
                    nine_turn_down: stockInfo.nine_turn_down || 0,
                    priority: 'green',  // 默认绿色优先级
                    note: '',  // 默认备注为空
                    add_time: new Date().toISOString()
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // 同时更新localStorage以保持兼容性
                    let watchlist = JSON.parse(localStorage.getItem('stockWatchlist') || '[]');
                    if (!watchlist.includes(stockCode)) {
                        watchlist.push(stockCode);
                        localStorage.setItem('stockWatchlist', JSON.stringify(watchlist));
                    }
                    
                    // 更新按钮显示状态
                    checkWatchlistStatus();
                    
                    // 显示成功提示
                    showNotification('已添加到自选股票', 'success');
                    console.log('股票已添加到自选:', stockCode);
                } else {
                    showNotification(data.message || '添加失败', 'error');
                }
            })
            .catch(error => {
                console.error('添加自选股失败:', error);
                showNotification('添加失败，请稍后重试', 'error');
            });
        }
        
        // 从自选中删除
        function removeFromWatchlist() {
            const stockCode = getStockCodeFromUrl();
            if (!stockCode) {
                alert('无法获取股票代码');
                return;
            }
            
            // 确认删除
            if (!confirm('确定要从自选股票中删除吗？')) {
                return;
            }
            
            // 构造ts_code（6位股票代码 + 交易所后缀）
            const tsCode = stockCode.startsWith('6') ? `${stockCode}.SH` : `${stockCode}.SZ`;
            
            // 调用后端API从自选股中删除
            fetch('/api/watchlist/remove', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    ts_code: tsCode
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // 同时更新localStorage以保持兼容性
                    let watchlist = JSON.parse(localStorage.getItem('stockWatchlist') || '[]');
                    const index = watchlist.indexOf(stockCode);
                    if (index > -1) {
                        watchlist.splice(index, 1);
                        localStorage.setItem('stockWatchlist', JSON.stringify(watchlist));
                    }
                    
                    // 更新按钮显示状态
                    checkWatchlistStatus();
                    
                    // 显示成功提示
                    showNotification('已从自选股票中删除', 'success');
                    console.log('股票已从自选中删除:', stockCode);
                } else {
                    showNotification(data.message || '删除失败', 'error');
                }
            })
            .catch(error => {
                console.error('删除自选股失败:', error);
                showNotification('删除失败，请稍后重试', 'error');
            });
        }
        
        // 刷新所有数据
        function refreshAllData() {
            const refreshBtn = document.getElementById('refreshDataBtn');
            
            // 禁用按钮，防止重复点击
            refreshBtn.disabled = true;
            refreshBtn.innerHTML = '<span>🔄</span><span>刷新中...</span>';
            
            console.log('开始刷新所有数据');
            
            // 并行刷新所有数据
            Promise.all([
                loadStockData(),
                loadRealtimeData(true),
                loadIntradayChart(true),
                loadIndicatorData()
            ]).then(() => {
                console.log('所有数据刷新完成');
                showNotification('数据刷新完成', 'success');
                updateLastRefreshTime();
            }).catch(error => {
                console.error('数据刷新失败:', error);
                showNotification('数据刷新失败，请稍后重试', 'error');
            }).finally(() => {
                // 恢复按钮状态
                refreshBtn.disabled = false;
                refreshBtn.innerHTML = '<span>🔄</span><span>刷新数据</span>';
            });
        }
        
        // 显示通知消息
        function showNotification(message, type = 'info') {
            // 创建通知元素
            const notification = document.createElement('div');
            notification.className = `notification notification-${type}`;
            notification.textContent = message;
            
            // 添加样式
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 12px 20px;
                border-radius: 6px;
                color: white;
                font-weight: 500;
                z-index: 10000;
                opacity: 0;
                transform: translateX(100%);
                transition: all 0.3s ease;
            `;
            
            // 根据类型设置背景色
            switch (type) {
                case 'success':
                    notification.style.backgroundColor = '#28a745';
                    break;
                case 'error':
                    notification.style.backgroundColor = '#dc3545';
                    break;
                case 'info':
                default:
                    notification.style.backgroundColor = '#007bff';
                    break;
            }
            
            // 添加到页面
            document.body.appendChild(notification);
            
            // 显示动画
            setTimeout(() => {
                notification.style.opacity = '1';
                notification.style.transform = 'translateX(0)';
            }, 10);
            
            // 3秒后自动隐藏
            setTimeout(() => {
                notification.style.opacity = '0';
                notification.style.transform = 'translateX(100%)';
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 300);
            }, 3000);
        }
        
        // 从URL获取股票代码
        function getStockCodeFromUrl() {
            const pathParts = window.location.pathname.split('/');
            return pathParts[pathParts.length - 1] || null;
        }
        
        // ==================== 股票操作按钮相关函数结束 ====================

        // 页面加载时自动加载数据
        window.onload = function() {
            console.log('页面加载完成，开始初始化');
            
            // 检查自选状态
            checkWatchlistStatus();
            
            loadStockData();
            // 延迟加载技术指标数据，避免同时请求过多API
            console.log('设置技术指标数据延迟加载');
            setTimeout(() => {
                console.log('开始延迟加载技术指标数据');
                loadIndicatorData();
            }, 1000);
            
            // 启动自动刷新（会检查交易时间）
            setTimeout(() => {
                startAutoRefresh();
                updateLastRefreshTime();
            }, 2000);
            
            // 启动市场状态监控
            setTimeout(() => {
                startMarketStatusMonitor();
            }, 3000);
        };

        // 页面隐藏时停止自动刷新，页面显示时重新启动
        document.addEventListener('visibilitychange', function() {
            if (document.hidden) {
                console.log('页面隐藏，停止自动刷新');
                stopAutoRefresh();
            } else {
                console.log('页面显示，重新启动自动刷新');
                if (autoRefreshEnabled) {
                    startAutoRefresh();
                }
            }
        });

        // 添加窗口resize事件监听器
        let resizeTimeout;
        window.addEventListener('resize', function() {
            // 防抖处理，避免频繁触发
            clearTimeout(resizeTimeout);
            resizeTimeout = setTimeout(() => {
                console.log('窗口大小变化，重新布局图表');
                
                // 重新检查容器尺寸
                ensureChartContainerSizes();
                
                // 延迟重新布局图表
                setTimeout(() => {
                    forceResizeAllCharts();
                    
                    // 重新设置图表同步机制
                    setTimeout(() => {
                        forceSetupChartSync();
                    }, 200);
                }, 100);
            }, 300);
        });
    </script>
</body>
</html>