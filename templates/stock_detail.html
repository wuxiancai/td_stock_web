<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è‚¡ç¥¨è¯¦æƒ… - æ¯æ—¥æŒ‡æ ‡</title>
    <script src="https://cdn.plot.ly/plotly-2.35.2.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', sans-serif;
            background-color: #f8f9fa;
            color: #333;
            line-height: 1.4;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .stock-header {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .stock-info {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 15px;
        }

        .stock-name {
            font-size: 18px;
            font-weight: 600;
            color: #333;
        }

        .stock-code {
            font-size: 14px;
            color: #666;
        }

        .stock-price {
            font-size: 32px;
            font-weight: 700;
            color: #e74c3c;
        }

        .price-change {
            display: flex;
            gap: 10px;
            align-items: center;
            font-size: 14px;
        }

        .change-amount {
            color: #e74c3c;
        }

        .change-percent {
            color: #e74c3c;
        }

        .trade-date {
            color: #666;
            font-size: 12px;
        }

        .indicators-section {
            background: white;
            border-radius: 8px;
            padding: 0;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .indicators-header {
            background: #f8f9fa;
            padding: 15px 20px;
            border-bottom: 1px solid #e9ecef;
            font-weight: 600;
            color: #495057;
        }

        .indicators-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            border-bottom: 1px solid #e9ecef;
        }

        .indicator-item {
            padding: 15px 10px;
            text-align: center;
            border-right: 1px solid #e9ecef;
            transition: background-color 0.2s ease;
        }

        .indicator-item:last-child {
            border-right: none;
        }

        .indicator-item:hover {
            background-color: #f8f9fa;
        }

        .indicator-label {
            font-size: 12px;
            color: #6c757d;
            margin-bottom: 5px;
            line-height: 1.2;
        }

        .indicator-value {
            font-size: 14px;
            font-weight: 600;
            color: #212529;
            line-height: 1.2;
        }

        .positive {
            color: #28a745;
        }

        .negative {
            color: #dc3545;
        }

        .neutral {
            color: #6c757d;
        }

        /* å®æ—¶äº¤æ˜“æ•°æ®æ ·å¼ */
        .realtime-section {
            background: white;
            border-radius: 8px;
            padding: 0;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
            overflow: hidden;
        }

        .realtime-header {
            background: #f8f9fa;
            padding: 15px 20px;
            border-bottom: 1px solid #e9ecef;
            font-weight: 600;
            color: #495057;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .realtime-refresh-btn {
            padding: 6px 12px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s ease;
        }

        .realtime-refresh-btn:hover {
            background: #0056b3;
        }

        .realtime-refresh-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }

        .realtime-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 0;
            border-bottom: 1px solid #e9ecef;
        }

        .realtime-item {
            padding: 12px 10px;
            text-align: center;
            border-right: 1px solid #e9ecef;
            transition: background-color 0.2s ease;
        }

        .realtime-item:last-child {
            border-right: none;
        }

        .realtime-item:hover {
            background-color: #f8f9fa;
        }

        .realtime-label {
            font-size: 11px;
            color: #6c757d;
            margin-bottom: 4px;
            line-height: 1.2;
        }

        .realtime-value {
            font-size: 13px;
            font-weight: 600;
            color: #212529;
            line-height: 1.2;
        }

        .realtime-loading {
            text-align: center;
            padding: 20px;
            color: #666;
            font-size: 14px;
        }

        .realtime-error {
            background: #f8d7da;
            color: #721c24;
            padding: 15px 20px;
            border: 1px solid #f5c6cb;
            margin: 0;
            font-size: 14px;
        }

        /* æŠ€æœ¯æŒ‡æ ‡å›¾è¡¨æ ·å¼ */
        .indicators-charts-section {
            background: white;
            border-radius: 8px;
            padding: 0;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .indicators-charts-header {
            background: #f8f9fa;
            padding: 15px 20px;
            border-bottom: 1px solid #e9ecef;
            font-weight: 600;
            color: #495057;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .indicators-controls {
            display: flex;
            gap: 10px;
        }

        .indicator-btn {
            padding: 6px 12px;
            background: #fff;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s ease;
        }

        .indicator-btn:hover {
            background: #e9ecef;
        }

        .indicator-btn.active {
            background: #007bff;
            color: white;
            border-color: #007bff;
        }

        .indicators-charts-container {
            padding: 20px;
        }

        .indicator-chart {
            width: 100%;
        }

        .indicator-section {
            width: 100%;
            box-sizing: border-box;
        }

        /* ç¡®ä¿æ‰€æœ‰å›¾è¡¨å®¹å™¨å®½åº¦ä¸€è‡´ */
        #candlestickChart, #volumeChart, #macdChart, #kdjChart, #rsiChart {
            width: 100% !important;
            box-sizing: border-box;
        }

        /* èœ¡çƒ›å›¾æ ·å¼ */
        .chart-section {
            background: white;
            border-radius: 8px;
            padding: 0;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .chart-header {
            background: #f8f9fa;
            padding: 15px 20px;
            border-bottom: 1px solid #e9ecef;
            font-weight: 600;
            color: #495057;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chart-controls {
            display: flex;
            gap: 10px;
        }

        .chart-btn {
            padding: 6px 12px;
            background: #fff;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s ease;
        }

        .chart-btn:hover {
            background: #e9ecef;
        }

        .chart-btn.active {
            background: #007bff;
            color: white;
            border-color: #007bff;
        }

        .chart-container {
            padding: 20px;
        }

        .chart-loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 4px;
            margin: 20px;
            border: 1px solid #f5c6cb;
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .indicators-grid {
                grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            }
            
            .indicator-item {
                padding: 10px 5px;
            }
            
            .indicator-label {
                font-size: 11px;
            }
            
            .indicator-value {
                font-size: 13px;
            }
            
            .stock-price {
                font-size: 24px;
            }

            .chart-header {
                flex-direction: column;
                gap: 10px;
                align-items: flex-start;
            }

            .chart-controls {
                width: 100%;
                justify-content: center;
            }
        }

        @media (max-width: 480px) {
            .indicators-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div id="loadingDiv" class="loading" style="display: block;">
            <p>æ­£åœ¨åŠ è½½æ¯æ—¥æŒ‡æ ‡æ•°æ®...</p>
        </div>

        <div id="errorDiv" class="error" style="display: none;"></div>

        <div id="contentDiv" style="display: none;">
            <div class="stock-header">
                <div class="stock-info">
                    <div>
                        <span id="stockName" class="stock-name">ä¸œåæµ‹è¯•</span>
                        <span id="stockCode" class="stock-code">300354.SZ</span>
                    </div>
                    <div>
                        <span id="stockPrice" class="stock-price">Â¥40.31</span>
                    </div>
                    <div class="price-change">
                        <span id="changeAmount" class="change-amount">+52.00</span>
                        <span>(<span id="changePercent" class="change-percent">+33.30</span>)</span>
                        <span id="tradeDate" class="trade-date">2025å¹´7æœˆ25æ—¥</span>
                    </div>
                </div>
            </div>

            <div class="indicators-section">
                <div class="indicators-header">æ¯æ—¥æŒ‡æ ‡</div>
                <div class="indicators-grid">
                    <div class="indicator-item">
                        <div class="indicator-label">å¸‚å€¼</div>
                        <div id="totalMv" class="indicator-value">55.76äº¿</div>
                    </div>
                    <div class="indicator-item">
                        <div class="indicator-label">æˆäº¤é¢</div>
                        <div id="amount" class="indicator-value">2.53äº¿</div>
                    </div>
                    <div class="indicator-item">
                        <div class="indicator-label">å‡€æµå…¥é¢</div>
                        <div id="netInflow" class="indicator-value negative">-5310.00ä¸‡</div>
                    </div>
                    <div class="indicator-item">
                        <div class="indicator-label">æ¢æ‰‹ç‡</div>
                        <div id="turnoverRate" class="indicator-value">7.71%</div>
                    </div>
                    <div class="indicator-item">
                        <div class="indicator-label">é‡æ¯”</div>
                        <div id="volumeRatio" class="indicator-value">0.85</div>
                    </div>
                    <div class="indicator-item">
                        <div class="indicator-label">å¸‚ç›ˆç‡(TTM)</div>
                        <div id="peTtm" class="indicator-value">45.17</div>
                    </div>
                    <div class="indicator-item">
                        <div class="indicator-label">å¸‚å‡€ç‡(PB)</div>
                        <div id="pb" class="indicator-value">7.36</div>
                    </div>
                    <div class="indicator-item">
                        <div class="indicator-label">å½“å¤©å¼€ç›˜</div>
                        <div id="open" class="indicator-value">Â¥41.01</div>
                    </div>
                    <div class="indicator-item">
                        <div class="indicator-label">å½“å¤©æ¶¨å¹…</div>
                        <div id="pctChg" class="indicator-value negative">-0.03%</div>
                    </div>
                    <div class="indicator-item">
                        <div class="indicator-label">æ‰€å±è¡Œä¸š</div>
                        <div id="industry" class="indicator-value">ç”µå™¨ä»ªè¡¨</div>
                    </div>
                </div>
            </div>

            <!-- å®æ—¶äº¤æ˜“æ•°æ®éƒ¨åˆ† -->
            <div class="realtime-section">
                <div class="realtime-header">
                    <span>å®æ—¶äº¤æ˜“æ•°æ®</span>
                    <div style="display: flex; align-items: center; gap: 15px;">
                        <span id="realtimeTimestamp" style="font-size: 12px; color: #6c757d;">--</span>
                        <button id="realtimeRefreshBtn" class="realtime-refresh-btn" onclick="refreshRealtimeData()">åˆ·æ–°</button>
                    </div>
                </div>
                <div id="realtimeContent">
                    <div id="realtimeLoading" class="realtime-loading" style="display: block;">
                        æ­£åœ¨åŠ è½½å®æ—¶äº¤æ˜“æ•°æ®...
                    </div>
                    <div id="realtimeError" class="realtime-error" style="display: none;"></div>
                    <div id="realtimeGrid" class="realtime-grid" style="display: none;">
                        <!-- ç¬¬ä¸€è¡Œ -->
                        <div class="realtime-item">
                            <div class="realtime-label">æœ€æ–°ä»·</div>
                            <div id="rt_æœ€æ–°ä»·" class="realtime-value">--</div>
                        </div>
                        <div class="realtime-item">
                            <div class="realtime-label">æ¶¨è·Œå¹…</div>
                            <div id="rt_æ¶¨è·Œå¹…" class="realtime-value">--</div>
                        </div>
                        <div class="realtime-item">
                            <div class="realtime-label">æ¶¨è·Œé¢</div>
                            <div id="rt_æ¶¨è·Œé¢" class="realtime-value">--</div>
                        </div>
                        <div class="realtime-item">
                            <div class="realtime-label">é‡æ¯”</div>
                            <div id="rt_é‡æ¯”" class="realtime-value">--</div>
                        </div>
                        <div class="realtime-item">
                            <div class="realtime-label">æ¢æ‰‹ç‡</div>
                            <div id="rt_æ¢æ‰‹ç‡" class="realtime-value">--</div>
                        </div>
                        <div class="realtime-item">
                            <div class="realtime-label">æˆäº¤é‡</div>
                            <div id="rt_æˆäº¤é‡" class="realtime-value">--</div>
                        </div>
                        <!-- ç¬¬äºŒè¡Œ -->
                        <div class="realtime-item">
                            <div class="realtime-label">æˆäº¤é¢</div>
                            <div id="rt_æˆäº¤é¢" class="realtime-value">--</div>
                        </div>
                        <div class="realtime-item">
                            <div class="realtime-label">æŒ¯å¹…</div>
                            <div id="rt_æŒ¯å¹…" class="realtime-value">--</div>
                        </div>
                        <div class="realtime-item">
                            <div class="realtime-label">æœ€é«˜</div>
                            <div id="rt_æœ€é«˜" class="realtime-value">--</div>
                        </div>
                        <div class="realtime-item">
                            <div class="realtime-label">æœ€ä½</div>
                            <div id="rt_æœ€ä½" class="realtime-value">--</div>
                        </div>
                        <div class="realtime-item">
                            <div class="realtime-label">ä»Šå¼€</div>
                            <div id="rt_ä»Šå¼€" class="realtime-value">--</div>
                        </div>
                        <div class="realtime-item">
                            <div class="realtime-label">æ˜¨æ”¶</div>
                            <div id="rt_æ˜¨æ”¶" class="realtime-value">--</div>
                        </div>
                        <!-- ç¬¬ä¸‰è¡Œ -->
                        <div class="realtime-item">
                            <div class="realtime-label">å¸‚ç›ˆç‡-åŠ¨æ€</div>
                            <div id="rt_å¸‚ç›ˆç‡_åŠ¨æ€" class="realtime-value">--</div>
                        </div>
                        <div class="realtime-item">
                            <div class="realtime-label">å¸‚å‡€ç‡</div>
                            <div id="rt_å¸‚å‡€ç‡" class="realtime-value">--</div>
                        </div>
                        <div class="realtime-item">
                            <div class="realtime-label">æ€»å¸‚å€¼</div>
                            <div id="rt_æ€»å¸‚å€¼" class="realtime-value">--</div>
                        </div>
                        <div class="realtime-item">
                            <div class="realtime-label">æµé€šå¸‚å€¼</div>
                            <div id="rt_æµé€šå¸‚å€¼" class="realtime-value">--</div>
                        </div>
                        <div class="realtime-item">
                            <div class="realtime-label">æ¶¨é€Ÿ</div>
                            <div id="rt_æ¶¨é€Ÿ" class="realtime-value">--</div>
                        </div>
                        <div class="realtime-item">
                            <div class="realtime-label">5åˆ†é’Ÿæ¶¨è·Œ</div>
                            <div id="rt_5åˆ†é’Ÿæ¶¨è·Œ" class="realtime-value">--</div>
                        </div>
                        <!-- ç¬¬å››è¡Œ -->
                        <div class="realtime-item">
                            <div class="realtime-label">60æ—¥æ¶¨è·Œå¹…</div>
                            <div id="rt_60æ—¥æ¶¨è·Œå¹…" class="realtime-value">--</div>
                        </div>
                        <div class="realtime-item">
                            <div class="realtime-label">å¹´åˆè‡³ä»Šæ¶¨è·Œå¹…</div>
                            <div id="rt_å¹´åˆè‡³ä»Šæ¶¨è·Œå¹…" class="realtime-value">--</div>
                        </div>
                        <div class="realtime-item">
                            <div class="realtime-label">è¿æ¶¨å¤©æ•°</div>
                            <div id="rt_è¿æ¶¨å¤©æ•°" class="realtime-value">--</div>
                        </div>
                        <div class="realtime-item">
                            <div class="realtime-label">é‡ä»·é½å‡å¤©æ•°</div>
                            <div id="rt_é‡ä»·é½å‡å¤©æ•°" class="realtime-value">--</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- åˆ†æ—¶å›¾éƒ¨åˆ† -->
            <div class="realtime-section">
                <div class="realtime-header">
                    <span>åˆ†æ—¶å›¾</span>
                    <div style="display: flex; align-items: center; gap: 15px;">
                        <span id="intradayTimestamp" style="font-size: 12px; color: #6c757d;">--</span>
                        <button id="intradayRefreshBtn" class="realtime-refresh-btn" onclick="refreshIntradayChart()">åˆ·æ–°</button>
                    </div>
                </div>
                <div id="intradayContent">
                    <div id="intradayLoading" class="realtime-loading" style="display: block;">
                        æ­£åœ¨åŠ è½½åˆ†æ—¶æ•°æ®...
                    </div>
                    <div id="intradayError" class="realtime-error" style="display: none;"></div>
                    <div id="intradayChartContainer" style="display: none;">
                        <!-- åˆ†æ—¶å›¾ -->
                        <div id="intradayChart" style="width: 100%; height: 400px; padding: 10px;"></div>
                        <!-- åˆ†æ—¶æˆäº¤é‡å›¾ -->
                        <div id="intradayVolumeChart" style="width: 100%; height: 150px; padding: 10px;"></div>
                    </div>
                </div>
            </div>

            <!-- Kçº¿å›¾å’ŒæŠ€æœ¯æŒ‡æ ‡ç»„åˆéƒ¨åˆ† -->
            <div class="chart-section">
                <div class="chart-header">
                    <span>Kçº¿å›¾ä¸æŠ€æœ¯æŒ‡æ ‡</span>
                    <div class="chart-controls">
                        <button class="chart-btn" onclick="setDisplayRange(50, event)">50æ ¹</button>
                        <button class="chart-btn active" onclick="setDisplayRange(100, event)">100æ ¹</button>
                        <button class="chart-btn" onclick="setDisplayRange(200, event)">200æ ¹</button>
                        <button class="chart-btn" onclick="setDisplayRange(-1, event)">å…¨éƒ¨</button>
                        <div style="margin-left: 20px; display: flex; align-items: center; gap: 10px;">
                            <label style="display: flex; align-items: center; gap: 5px; font-size: 12px; color: #495057;">
                                <input type="checkbox" id="showBOLL" checked onchange="toggleBOLL()">
                                BOLLæŒ‡æ ‡
                            </label>
                        </div>
                    </div>
                </div>
                <div class="chart-container">
                    <div id="chartLoading" class="chart-loading" style="display: none;">
                        æ­£åœ¨åŠ è½½Kçº¿æ•°æ®...
                    </div>
                    <!-- Kçº¿å›¾ -->
                    <div id="candlestickChart" style="width: 100%; height: 400px;"></div>
                    <!-- æˆäº¤é‡å›¾ -->
                    <div id="volumeChart" style="width: 100%; height: 150px; margin-top: 2px;"></div>
                    
                    <!-- MACDæŒ‡æ ‡ -->
                    <div id="macdChart" style="width: 100%; height: 150px; margin-top: 5px;"></div>
                    
                    <!-- KDJæŒ‡æ ‡ -->
                    <div id="kdjChart" style="width: 100%; height: 150px; margin-top: 5px;"></div>
                    
                    <!-- RSIæŒ‡æ ‡ -->
                    <div id="rsiChart" style="width: 100%; height: 150px; margin-top: 5px;"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // å…¨å±€å˜é‡
        let allChartData = [];
        let nineTurnData = []; // æ·»åŠ ç¥å¥‡ä¹è½¬æ•°æ®
        let currentDisplayRange = 100;
        let currentStockCode = '';

        // ä»URLå‚æ•°è·å–è‚¡ç¥¨ä»£ç 
        function getStockCodeFromUrl() {
            // ä»URLè·¯å¾„è·å–è‚¡ç¥¨ä»£ç  (ä¾‹å¦‚: /stock/300354)
            const pathParts = window.location.pathname.split('/');
            if (pathParts.length >= 3 && pathParts[1] === 'stock') {
                return pathParts[2];
            }
            
            // å¦‚æœè·¯å¾„ä¸­æ²¡æœ‰ï¼Œåˆ™ä»URLå‚æ•°è·å–
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('code') || '300354';
        }

        // æ ¼å¼åŒ–æ•°å€¼
        function formatValue(value, type = 'number') {
            if (value === null || value === undefined || value === '') {
                return '--';
            }
            
            const num = parseFloat(value);
            if (isNaN(num)) return value;
            
            switch (type) {
                case 'currency':
                    return `Â¥${num.toFixed(2)}`;
                case 'percentage':
                    return `${num.toFixed(2)}%`;
                case 'large_number':
                    if (num >= 100000000) {
                        return `${(num / 100000000).toFixed(2)}äº¿`;
                    } else if (num >= 10000) {
                        return `${(num / 10000).toFixed(2)}ä¸‡`;
                    }
                    return num.toFixed(2);
                case 'ratio':
                    return num.toFixed(2);
                default:
                    return num.toFixed(2);
            }
        }

        // æ ¼å¼åŒ–æˆäº¤é¢
        function formatAmount(value) {
            if (value === null || value === undefined || value === '') {
                return '--';
            }
            
            const num = parseFloat(value);
            if (isNaN(num)) return value;
            
            // Tushareè¿”å›çš„amountå•ä½æ˜¯åƒå…ƒï¼Œéœ€è¦å…ˆè½¬æ¢ä¸ºä¸‡å…ƒ
            const amountInWan = num / 10;
            
            // æˆäº¤é¢å•ä½è½¬æ¢ï¼šä¸‡å…ƒ -> äº¿å…ƒ
            if (amountInWan >= 10000) {
                return `${(amountInWan / 10000).toFixed(2)}äº¿`;
            } else {
                return `${amountInWan.toFixed(2)}ä¸‡`;
            }
        }

        // æ ¼å¼åŒ–å›¾è¡¨æ—¥æœŸï¼ˆåªæ˜¾ç¤ºæœˆæ—¥ï¼‰
        function formatChartDate(dateStr) {
            if (!dateStr) return '';
            const month = dateStr.substring(4, 6);
            const day = dateStr.substring(6, 8);
            return `${month}-${day}`;
        }

        // æ ¼å¼åŒ–æ—¥æœŸ
        function formatDate(dateStr) {
            if (!dateStr) return '';
            const year = dateStr.substring(0, 4);
            const month = dateStr.substring(4, 6);
            const day = dateStr.substring(6, 8);
            return `${year}å¹´${month}æœˆ${day}æ—¥`;
        }

        // è®¾ç½®æ•°å€¼é¢œè‰²
        function setValueColor(element, value) {
            const num = parseFloat(value);
            if (isNaN(num)) return;
            
            element.classList.remove('positive', 'negative', 'neutral');
            if (num > 0) {
                element.classList.add('positive');
            } else if (num < 0) {
                element.classList.add('negative');
            } else {
                element.classList.add('neutral');
            }
        }

        // åŠ è½½è‚¡ç¥¨æ•°æ®
        async function loadStockData() {
            currentStockCode = getStockCodeFromUrl();
            
            try {
                // è·å–æ¯æ—¥æŒ‡æ ‡æ•°æ®
                const dailyBasicResponse = await fetch(`/api/stock/${currentStockCode}/daily_basic`);
                const dailyBasicResult = await dailyBasicResponse.json();
                
                if (!dailyBasicResult.success) {
                    throw new Error(dailyBasicResult.error || 'è·å–æ¯æ—¥æŒ‡æ ‡æ•°æ®å¤±è´¥');
                }

                // è·å–å®æ—¶æ•°æ®
                const realtimeResponse = await fetch(`/api/stock/${currentStockCode}/realtime`);
                const realtimeResult = await realtimeResponse.json();
                
                displayStockData(dailyBasicResult, realtimeResult);
                
                // åŠ è½½å®æ—¶äº¤æ˜“æ•°æ®
                await loadRealtimeData();
                
                // åŠ è½½åˆ†æ—¶å›¾æ•°æ®
                await loadIntradayChart();
                
                // åŠ è½½Kçº¿æ•°æ®
                await loadChartData();
                
            } catch (error) {
                showError('æ•°æ®åŠ è½½å¤±è´¥: ' + error.message);
            }
        }

        // åŠ è½½å®æ—¶äº¤æ˜“æ•°æ®
        async function loadRealtimeData() {
            try {
                showRealtimeLoading(true);
                
                const response = await fetch(`/api/stock/realtime_trading_data`);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const result = await response.json();
                
                if (!result.success) {
                    // æ˜¾ç¤ºåç«¯è¿”å›çš„å…·ä½“é”™è¯¯ä¿¡æ¯
                    const errorMsg = result.error || 'è·å–å®æ—¶äº¤æ˜“æ•°æ®å¤±è´¥';
                    const detailMsg = result.details ? ` (${result.details})` : '';
                    throw new Error(errorMsg + detailMsg);
                }
                
                displayRealtimeData(result.data, result);
                
            } catch (error) {
                console.error('å®æ—¶äº¤æ˜“æ•°æ®åŠ è½½å¤±è´¥:', error);
                
                // æ ¹æ®é”™è¯¯ç±»å‹æ˜¾ç¤ºä¸åŒçš„é”™è¯¯ä¿¡æ¯
                let errorMessage = 'å®æ—¶äº¤æ˜“æ•°æ®åŠ è½½å¤±è´¥';
                
                if (error.message.includes('ç½‘ç»œè¿æ¥')) {
                    errorMessage = 'ç½‘ç»œè¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥åé‡è¯•';
                } else if (error.message.includes('ä»£ç†è¿æ¥')) {
                    errorMessage = 'ä»£ç†è¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè®¾ç½®';
                } else if (error.message.includes('AkShare')) {
                    errorMessage = 'AkShareæœåŠ¡æš‚æ—¶ä¸å¯ç”¨ï¼Œè¯·ç¨åé‡è¯•';
                } else if (error.message.includes('APIè°ƒç”¨å¤±è´¥')) {
                    errorMessage = 'APIè°ƒç”¨å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•';
                } else if (error.message.includes('HTTP')) {
                    errorMessage = `æœåŠ¡å™¨é”™è¯¯: ${error.message}`;
                } else {
                    errorMessage = error.message || 'æœªçŸ¥é”™è¯¯ï¼Œè¯·ç¨åé‡è¯•';
                }
                
                showRealtimeError(errorMessage);
            } finally {
                showRealtimeLoading(false);
            }
        }

        // åˆ·æ–°å®æ—¶äº¤æ˜“æ•°æ®
        async function refreshRealtimeData() {
            const refreshBtn = document.getElementById('realtimeRefreshBtn');
            refreshBtn.disabled = true;
            refreshBtn.textContent = 'åˆ·æ–°ä¸­...';
            
            try {
                await loadRealtimeData();
            } finally {
                refreshBtn.disabled = false;
                refreshBtn.textContent = 'åˆ·æ–°';
            }
        }

        // æ˜¾ç¤ºå®æ—¶äº¤æ˜“æ•°æ®
        function displayRealtimeData(data, result = null) {
            if (!data || data.length === 0) {
                showRealtimeError('æš‚æ— å®æ—¶äº¤æ˜“æ•°æ®');
                return;
            }

            // æ‰¾åˆ°å½“å‰è‚¡ç¥¨çš„æ•°æ®
            const stockData = data.find(item => {
                const code = item['ä»£ç '];
                return code && (code === currentStockCode || code === currentStockCode.substring(0, 6));
            });

            if (!stockData) {
                showRealtimeError('æœªæ‰¾åˆ°å½“å‰è‚¡ç¥¨çš„å®æ—¶äº¤æ˜“æ•°æ®');
                return;
            }

            // æ˜¾ç¤ºæ•°æ®
            const fieldMapping = {
                'åºå·': 'åºå·',
                'ä»£ç ': 'ä»£ç ', 
                'åç§°': 'åç§°',
                'æœ€æ–°ä»·': 'æœ€æ–°ä»·',
                'æ¶¨è·Œå¹…': 'æ¶¨è·Œå¹…',
                'æ¶¨è·Œé¢': 'æ¶¨è·Œé¢',
                'æˆäº¤é‡': 'æˆäº¤é‡',
                'æˆäº¤é¢': 'æˆäº¤é¢',
                'æŒ¯å¹…': 'æŒ¯å¹…',
                'æœ€é«˜': 'æœ€é«˜',
                'æœ€ä½': 'æœ€ä½',
                'ä»Šå¼€': 'ä»Šå¼€',
                'æ˜¨æ”¶': 'æ˜¨æ”¶',
                'é‡æ¯”': 'é‡æ¯”',
                'æ¢æ‰‹ç‡': 'æ¢æ‰‹ç‡',
                'å¸‚ç›ˆç‡-åŠ¨æ€': 'å¸‚ç›ˆç‡-åŠ¨æ€',
                'å¸‚å‡€ç‡': 'å¸‚å‡€ç‡',
                'æ€»å¸‚å€¼': 'æ€»å¸‚å€¼',
                'æµé€šå¸‚å€¼': 'æµé€šå¸‚å€¼',
                'æ¶¨é€Ÿ': 'æ¶¨é€Ÿ',
                '5åˆ†é’Ÿæ¶¨è·Œ': '5åˆ†é’Ÿæ¶¨è·Œ',
                '60æ—¥æ¶¨è·Œå¹…': '60æ—¥æ¶¨è·Œå¹…',
                'å¹´åˆè‡³ä»Šæ¶¨è·Œå¹…': 'å¹´åˆè‡³ä»Šæ¶¨è·Œå¹…',
                'è¿æ¶¨å¤©æ•°': 'è¿æ¶¨å¤©æ•°',
                'é‡ä»·é½å‡å¤©æ•°': 'é‡ä»·é½å‡å¤©æ•°'
            };

            Object.entries(fieldMapping).forEach(([field, key]) => {
                const element = document.getElementById(`rt_${field}`);
                if (element && stockData[key] !== undefined) {
                    let value = stockData[key];
                    
                    // æ ¼å¼åŒ–æ•°å€¼
                    if (field === 'æœ€æ–°ä»·' || field === 'æ¶¨è·Œé¢' || field === 'æœ€é«˜' || field === 'æœ€ä½' || field === 'ä»Šå¼€' || field === 'æ˜¨æ”¶') {
                        value = formatRealtimeValue(value, 'currency');
                    } else if (field === 'æ¶¨è·Œå¹…' || field === 'æŒ¯å¹…' || field === 'æ¢æ‰‹ç‡' || field === 'æ¶¨é€Ÿ' || field === '5åˆ†é’Ÿæ¶¨è·Œ' || field === '60æ—¥æ¶¨è·Œå¹…' || field === 'å¹´åˆè‡³ä»Šæ¶¨è·Œå¹…') {
                        value = formatRealtimeValue(value, 'percentage');
                    } else if (field === 'æˆäº¤é‡') {
                        value = formatRealtimeValue(value, 'volume');
                    } else if (field === 'æˆäº¤é¢' || field === 'æ€»å¸‚å€¼' || field === 'æµé€šå¸‚å€¼') {
                        value = formatRealtimeValue(value, 'amount');
                    } else if (field === 'è¿æ¶¨å¤©æ•°' || field === 'é‡ä»·é½å‡å¤©æ•°') {
                        value = formatRealtimeValue(value, 'days');
                    } else {
                        value = formatRealtimeValue(value, 'number');
                    }
                    
                    element.textContent = value;
                    
                    // è®¾ç½®é¢œè‰²
                    if (field === 'æ¶¨è·Œå¹…' || field === 'æ¶¨è·Œé¢' || field === 'æ¶¨é€Ÿ' || field === '5åˆ†é’Ÿæ¶¨è·Œ' || field === '60æ—¥æ¶¨è·Œå¹…' || field === 'å¹´åˆè‡³ä»Šæ¶¨è·Œå¹…') {
                        setRealtimeValueColor(element, stockData[key], field);
                    } else if (field === 'è¿æ¶¨å¤©æ•°' || field === 'é‡ä»·é½å‡å¤©æ•°') {
                        setRealtimeValueColor(element, stockData[key], field);
                    }
                }
            });

            // æ˜¾ç¤ºæ•°æ®ç½‘æ ¼
            document.getElementById('realtimeGrid').style.display = 'grid';
            document.getElementById('realtimeError').style.display = 'none';
            
            // æ›´æ–°æ—¶é—´æˆ³ï¼Œå¦‚æœæ˜¯æœ€åäº¤æ˜“æ—¥æ•°æ®ï¼Œæ˜¾ç¤ºç‰¹æ®Šæç¤º
            updateRealtimeTimestamp(result);
            
            // ä½¿ç”¨å®æ—¶äº¤æ˜“æ•°æ®æ›´æ–°æ¯æ—¥æŒ‡æ ‡
            updateDailyIndicatorsFromRealtimeData(data);
        }

        // æ ¼å¼åŒ–å®æ—¶æ•°æ®å€¼
        function formatRealtimeValue(value, type = 'number') {
            if (value === null || value === undefined || value === '' || value === '-') {
                return '--';
            }
            
            const num = parseFloat(value);
            if (isNaN(num)) return value;
            
            switch (type) {
                case 'currency':
                    return `Â¥${num.toFixed(2)}`;
                case 'percentage':
                    return `${num.toFixed(2)}%`;
                case 'volume':
                    if (num >= 100000000) {
                        return `${(num / 100000000).toFixed(2)}äº¿æ‰‹`;
                    } else if (num >= 10000) {
                        return `${(num / 10000).toFixed(2)}ä¸‡æ‰‹`;
                    }
                    return `${num.toFixed(0)}æ‰‹`;
                case 'amount':
                    if (num >= 100000000) {
                        return `${(num / 100000000).toFixed(2)}äº¿`;
                    } else if (num >= 10000) {
                        return `${(num / 10000).toFixed(2)}ä¸‡`;
                    }
                    return num.toFixed(2);
                case 'days':
                    return `${Math.floor(num)}å¤©`;
                case 'number':
                default:
                    return num.toFixed(2);
            }
        }

        // è®¾ç½®å®æ—¶æ•°æ®å€¼é¢œè‰²
        function setRealtimeValueColor(element, value, field) {
            // æ¶¨è·Œç›¸å…³å­—æ®µä½¿ç”¨çº¢æ¶¨ç»¿è·Œ
            const changeFields = ['æ¶¨è·Œå¹…', 'æ¶¨è·Œé¢', 'æ¶¨é€Ÿ', '5åˆ†é’Ÿæ¶¨è·Œ', '60æ—¥æ¶¨è·Œå¹…', 'å¹´åˆè‡³ä»Šæ¶¨è·Œå¹…'];
            
            if (changeFields.includes(field)) {
                const numValue = parseFloat(value);
                if (!isNaN(numValue)) {
                    element.classList.remove('positive', 'negative', 'neutral');
                    if (numValue > 0) {
                        element.classList.add('positive');
                        element.style.color = '#ff4444'; // çº¢è‰²
                    } else if (numValue < 0) {
                        element.classList.add('negative');
                        element.style.color = '#00aa00'; // ç»¿è‰²
                    } else {
                        element.classList.add('neutral');
                        element.style.color = '#666'; // ç°è‰²
                    }
                } else {
                    element.style.color = '#333'; // é»˜è®¤é¢œè‰²
                }
            } else if (field === 'è¿æ¶¨å¤©æ•°' || field === 'é‡ä»·é½å‡å¤©æ•°') {
                const numValue = parseFloat(value);
                if (!isNaN(numValue)) {
                    element.classList.remove('positive', 'negative', 'neutral');
                    if (numValue > 0) {
                        element.classList.add('positive');
                        element.style.color = '#ff4444'; // çº¢è‰²ï¼Œè¡¨ç¤ºè¿ç»­ä¸Šæ¶¨æˆ–é‡ä»·é½å‡
                    } else {
                        element.classList.add('neutral');
                        element.style.color = '#666'; // ç°è‰²ï¼Œè¡¨ç¤ºæ²¡æœ‰è¿æ¶¨æˆ–é‡ä»·é½å‡
                    }
                } else {
                    element.style.color = '#333'; // é»˜è®¤é¢œè‰²
                }
            } else {
                // å…¶ä»–å­—æ®µä½¿ç”¨é»˜è®¤é¢œè‰²
                element.style.color = '#333';
            }
        }

        // æ˜¾ç¤ºå®æ—¶æ•°æ®åŠ è½½çŠ¶æ€
        function showRealtimeLoading(show) {
            document.getElementById('realtimeLoading').style.display = show ? 'block' : 'none';
            document.getElementById('realtimeGrid').style.display = show ? 'none' : 'grid';
            document.getElementById('realtimeError').style.display = 'none';
        }

        // æ˜¾ç¤ºå®æ—¶æ•°æ®é”™è¯¯
        function showRealtimeError(message) {
            document.getElementById('realtimeError').textContent = message;
            document.getElementById('realtimeError').style.display = 'block';
            document.getElementById('realtimeLoading').style.display = 'none';
            document.getElementById('realtimeGrid').style.display = 'none';
        }

        // æ›´æ–°å®æ—¶æ•°æ®æ—¶é—´æˆ³
        function updateRealtimeTimestamp(result = null) {
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            const seconds = String(now.getSeconds()).padStart(2, '0');
            
            const timestamp = `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
            
            // æ£€æŸ¥æ˜¯å¦æ˜¯æœ€åäº¤æ˜“æ—¥æ•°æ®
            if (result && result.is_last_trading_day) {
                document.getElementById('realtimeTimestamp').innerHTML = 
                    `<span style="color: #ff6600;">ğŸ“… éäº¤æ˜“æ—¶é—´ï¼Œæ˜¾ç¤ºæœ€åäº¤æ˜“æ—¥(2025-07-25)æ”¶ç›˜æ•°æ®</span><br>æ›´æ–°æ—¶é—´: ${timestamp}`;
            } else {
                document.getElementById('realtimeTimestamp').textContent = `æ›´æ–°æ—¶é—´: ${timestamp}`;
            }
        }

        // åŠ è½½Kçº¿æ•°æ®
        async function loadChartData() {
            try {
                showChartLoading(true);
                
                // å¹¶è¡Œè·å–Kçº¿æ•°æ®å’Œç¥å¥‡ä¹è½¬æ•°æ®
                const [historyResponse, nineTurnResponse] = await Promise.all([
                    fetch(`/api/stock/${currentStockCode}/daily_history?days=200`),
                    fetch(`/api/stock/${currentStockCode}/nine_turn?days=200&freq=daily`)
                ]);
                
                const historyResult = await historyResponse.json();
                const nineTurnResult = await nineTurnResponse.json();
                
                if (!historyResult.success) {
                    throw new Error(historyResult.error || 'è·å–Kçº¿æ•°æ®å¤±è´¥');
                }
                
                allChartData = historyResult.data;
                
                // å¤„ç†ç¥å¥‡ä¹è½¬æ•°æ®
                if (nineTurnResult.success && nineTurnResult.data) {
                    nineTurnData = nineTurnResult.data;
                    console.log(`[ç¥å¥‡ä¹è½¬] æˆåŠŸè·å–${nineTurnData.length}æ¡æ•°æ®ï¼Œä¸Šä¹è½¬ä¿¡å·: ${nineTurnResult.stock_info.up_signals}ä¸ªï¼Œä¸‹ä¹è½¬ä¿¡å·: ${nineTurnResult.stock_info.down_signals}ä¸ª`);
                } else {
                    nineTurnData = [];
                    console.log('[ç¥å¥‡ä¹è½¬] æš‚æ— æ•°æ®æˆ–è·å–å¤±è´¥');
                }
                
                // æ³¨é‡Šæ‰Kçº¿å›¾hoverçš„æ¯æ—¥æŒ‡æ ‡æ•°æ®è·å–ï¼Œåªåœ¨é¡µé¢é¡¶éƒ¨æ˜¾ç¤ºå‰ä¸€äº¤æ˜“æ—¥çš„æ¯æ—¥æŒ‡æ ‡
                // await loadDailyBasicDataForChart();
                
                createCandlestickChart();
                
            } catch (error) {
                console.error('æ•°æ®åŠ è½½å¤±è´¥:', error);
            } finally {
                showChartLoading(false);
            }
        }

        // è·å–æ¯æ—¥æŒ‡æ ‡æ•°æ®ç”¨äºKçº¿å›¾
        async function loadDailyBasicDataForChart() {
            try {
                // ä¸ºæ¯ä¸ªäº¤æ˜“æ—¥è·å–daily_basicæ•°æ®
                const dailyBasicPromises = allChartData.map(async (item) => {
                    try {
                        const response = await fetch(`/api/stock/${currentStockCode}/daily_basic?trade_date=${item.trade_date.replace(/-/g, '')}`);
                        const result = await response.json();
                        if (result.success) {
                            return {
                                trade_date: item.trade_date,
                                ...result.data
                            };
                        }
                        return null;
                    } catch (error) {
                        console.warn(`è·å–${item.trade_date}çš„daily_basicæ•°æ®å¤±è´¥:`, error);
                        return null;
                    }
                });
                
                // ç­‰å¾…æ‰€æœ‰è¯·æ±‚å®Œæˆ
                const dailyBasicResults = await Promise.all(dailyBasicPromises);
                
                // åˆ›å»ºæ—¥æœŸåˆ°daily_basicæ•°æ®çš„æ˜ å°„
                window.dailyBasicMap = {};
                dailyBasicResults.forEach(result => {
                    if (result) {
                        window.dailyBasicMap[result.trade_date] = result;
                    }
                });
                
                console.log(`[æ¯æ—¥æŒ‡æ ‡] æˆåŠŸè·å–${Object.keys(window.dailyBasicMap).length}æ¡æ¯æ—¥æŒ‡æ ‡æ•°æ®`);
                
            } catch (error) {
                console.error('è·å–æ¯æ—¥æŒ‡æ ‡æ•°æ®å¤±è´¥:', error);
                window.dailyBasicMap = {};
            }
        }

        // åˆ›å»ºèœ¡çƒ›å›¾
        function createCandlestickChart() {
            if (!allChartData || allChartData.length === 0) {
                return;
            }

            // æ ¹æ®æ˜¾ç¤ºèŒƒå›´è·å–æ•°æ®
            let displayData = allChartData;
            if (currentDisplayRange > 0 && allChartData.length > currentDisplayRange) {
                displayData = allChartData.slice(-currentDisplayRange);
            }

            // å‡†å¤‡æ•°æ®
            const dates = displayData.map(item => item.trade_date);
            const formattedDates = dates.map(date => formatChartDate(date)); // æ ¼å¼åŒ–æ—¥æœŸç”¨äºæˆäº¤é¢å›¾è¡¨
            const opens = displayData.map(item => item.open);
            const highs = displayData.map(item => item.high);
            const lows = displayData.map(item => item.low);
            const closes = displayData.map(item => item.close);
            const amounts = displayData.map(item => item.amount); // æ”¹ä¸ºæˆäº¤é¢

            // åˆ›å»ºèœ¡çƒ›å›¾
            const candlestickTrace = {
                x: dates,
                open: opens,
                high: highs,
                low: lows,
                close: closes,
                type: 'candlestick',
                name: 'Kçº¿',
                increasing: {
                    line: { color: '#ff4444', width: 1 },
                    fillcolor: '#ff4444'
                },
                decreasing: {
                    line: { color: '#00aa00', width: 1 },
                    fillcolor: '#00aa00'
                },
                customdata: displayData.map(item => {
                    return {
                        pct_chg: item.pct_chg || 0,
                        amount: item.amount || 0
                    };
                }),
                hovertemplate: '<b>Kçº¿æ•°æ®</b><br>ğŸ“… %{x}<br>ğŸ’° å¼€ç›˜: %{open:.2f}<br>ğŸ“ˆ æœ€é«˜: %{high:.2f}<br>ğŸ“‰ æœ€ä½: %{low:.2f}<br>ğŸ¯ æ”¶ç›˜: %{close:.2f}<br>ğŸ“Š æ¶¨å¹…: %{customdata.pct_chg:.2f}%<br>ğŸ’ æˆäº¤é¢: %{customdata.amount:.0f}åƒå…ƒ<extra></extra>'
            };

            // å‡†å¤‡ç¥å¥‡ä¹è½¬æŒ‡æ ‡æ•°æ®
            const traces = [candlestickTrace];
            
            if (nineTurnData && nineTurnData.length > 0) {
                // åˆ›å»ºæ—¥æœŸåˆ°ä¹è½¬æ•°æ®çš„æ˜ å°„
                const nineTurnMap = {};
                nineTurnData.forEach(item => {
                    const dateKey = item.trade_date.split(' ')[0]; // æå–æ—¥æœŸéƒ¨åˆ†
                    nineTurnMap[dateKey] = item;
                });

                // å‡†å¤‡ä¹è½¬ä¿¡å·çš„æ ‡æ³¨æ•°æ®
                const buySignalDates = [];
                const buySignalPrices = [];
                const buySignalTexts = [];
                const sellSignalDates = [];
                const sellSignalPrices = [];
                const sellSignalTexts = [];

                displayData.forEach((item, index) => {
                    const dateKey = item.trade_date;
                    const nineTurnItem = nineTurnMap[dateKey];
                    
                    if (nineTurnItem) {
                        // ä¹°å…¥ä¿¡å·ï¼ˆç»¿è‰²æ•°å­—ï¼Œæ˜¾ç¤ºåœ¨èœ¡çƒ›å›¾ä¸‹æ–¹ï¼‰
                        if (nineTurnItem.buy_signal && nineTurnItem.buy_signal > 0) {
                            buySignalDates.push(dateKey);
                            buySignalPrices.push(item.low * 0.97); // åœ¨æœ€ä½ä»·ä¸‹æ–¹æ˜¾ç¤º
                            buySignalTexts.push(nineTurnItem.buy_signal.toString());
                        }
                        
                        // å–å‡ºä¿¡å·ï¼ˆçº¢è‰²æ•°å­—ï¼Œæ˜¾ç¤ºåœ¨èœ¡çƒ›å›¾ä¸Šæ–¹ï¼‰
                        if (nineTurnItem.sell_signal && nineTurnItem.sell_signal > 0) {
                            sellSignalDates.push(dateKey);
                            sellSignalPrices.push(item.high * 1.03); // åœ¨æœ€é«˜ä»·ä¸Šæ–¹æ˜¾ç¤º
                            sellSignalTexts.push(nineTurnItem.sell_signal.toString());
                        }
                    }
                });

                // æ·»åŠ ä¹°å…¥ä¿¡å·ï¼ˆç»¿è‰²æ•°å­—ï¼Œæ˜¾ç¤ºåœ¨èœ¡çƒ›å›¾ä¸‹æ–¹ï¼‰
                if (buySignalDates.length > 0) {
                    traces.push({
                        x: buySignalDates,
                        y: buySignalPrices,
                        mode: 'text',
                        type: 'scatter',
                        name: 'ä¹è½¬ä¹°å…¥',
                        text: buySignalTexts,
                        textposition: 'middle center',
                        textfont: {
                            color: '#00aa00',
                            size: 12,
                            family: 'Arial, sans-serif',
                            weight: 'bold'
                        },
                        hovertemplate: '<b>ğŸŸ¢ ä¹è½¬ä¹°å…¥ä¿¡å·</b><br>ğŸ“… æ—¥æœŸ: %{x}<br>ğŸ“Š ä¿¡å·: ç¬¬%{text}å¤©<br>ğŸ’° ä»·æ ¼: %{y:.2f}å…ƒ<extra></extra>',
                        showlegend: false
                    });
                }

                // æ·»åŠ å–å‡ºä¿¡å·ï¼ˆçº¢è‰²æ•°å­—ï¼Œæ˜¾ç¤ºåœ¨èœ¡çƒ›å›¾ä¸Šæ–¹ï¼‰
                if (sellSignalDates.length > 0) {
                    traces.push({
                        x: sellSignalDates,
                        y: sellSignalPrices,
                        mode: 'text',
                        type: 'scatter',
                        name: 'ä¹è½¬å–å‡º',
                        text: sellSignalTexts,
                        textposition: 'middle center',
                        textfont: {
                            color: '#ff0000',
                            size: 12,
                            family: 'Arial, sans-serif',
                            weight: 'bold'
                        },
                        hovertemplate: '<b>ğŸ”´ ä¹è½¬å–å‡ºä¿¡å·</b><br>ğŸ“… æ—¥æœŸ: %{x}<br>ğŸ“Š ä¿¡å·: ç¬¬%{text}å¤©<br>ğŸ’° ä»·æ ¼: %{y:.2f}å…ƒ<extra></extra>',
                        showlegend: false
                    });
                }
            }

            // æ·»åŠ BOLLæŒ‡æ ‡
            const showBOLLElement = document.getElementById('showBOLL');
            const showBOLL = showBOLLElement ? showBOLLElement.checked : false;
            if (showBOLL) {
                // å‡†å¤‡BOLLæ•°æ®
                const bollUpper = displayData.map(item => item.boll_upper);
                const bollMid = displayData.map(item => item.boll_mid);
                const bollLower = displayData.map(item => item.boll_lower);

                // æ£€æŸ¥æ˜¯å¦æœ‰æœ‰æ•ˆçš„BOLLæ•°æ®
                const hasValidBollData = bollUpper.some(val => val !== null && val !== undefined) ||
                                       bollMid.some(val => val !== null && val !== undefined) ||
                                       bollLower.some(val => val !== null && val !== undefined);

                if (hasValidBollData) {
                    // BOLLä¸Šè½¨
                    traces.push({
                        x: dates,
                        y: bollUpper,
                        type: 'scatter',
                        mode: 'lines',
                        name: 'BOLLä¸Šè½¨',
                        line: {
                            color: '#ec0000',
                            width: 1
                        },
                        hovertemplate: '<b>ğŸ“ˆ BOLLä¸Šè½¨</b><br>ğŸ“… æ—¥æœŸ: %{x}<br>ğŸ’° ä»·æ ¼: %{y:.2f}å…ƒ<extra></extra>',
                        showlegend: false
                    });

                    // BOLLä¸­è½¨ï¼ˆç§»åŠ¨å¹³å‡çº¿ï¼‰
                    traces.push({
                        x: dates,
                        y: bollMid,
                        type: 'scatter',
                        mode: 'lines',
                        name: 'BOLLä¸­è½¨',
                        line: {
                            color: '#4ecdc4',
                            width: 1.5
                        },
                        hovertemplate: '<b>ğŸ“Š BOLLä¸­è½¨(MA20)</b><br>ğŸ“… æ—¥æœŸ: %{x}<br>ğŸ’° ä»·æ ¼: %{y:.2f}å…ƒ<extra></extra>',
                        showlegend: false
                    });

                    // BOLLä¸‹è½¨
                    traces.push({
                        x: dates,
                        y: bollLower,
                        type: 'scatter',
                        mode: 'lines',
                        name: 'BOLLä¸‹è½¨',
                        line: {
                            color: '#ec0000',
                            width: 1
                        },
                        hovertemplate: '<b>ğŸ“‰ BOLLä¸‹è½¨</b><br>ğŸ“… æ—¥æœŸ: %{x}<br>ğŸ’° ä»·æ ¼: %{y:.2f}å…ƒ<extra></extra>',
                        showlegend: false
                    });
                }
            }

            const candlestickLayout = {
                xaxis: {
                    type: 'category',
                    showgrid: true,
                    gridcolor: '#f0f0f0',
                    rangeslider: { visible: false },
                    showticklabels: false,
                    categoryorder: 'array',
                    categoryarray: dates,
                    range: [-0.5, dates.length - 0.5]
                },
                yaxis: {
                    title: 'ä»·æ ¼ (å…ƒ)',
                    showgrid: true,
                    gridcolor: '#f0f0f0',
                    tickformat: '.2f'
                },
                plot_bgcolor: 'white',
                paper_bgcolor: 'white',
                font: { family: 'Arial, sans-serif', size: 12 },
                margin: { l: 50, r: 20, t: 20, b: 40 },
                showlegend: false,
                annotations: []
            };

            const config = {
                responsive: true,
                displayModeBar: false,
                staticPlot: false,
                modeBarButtonsToRemove: ['toImage', 'zoom2d', 'pan2d', 'select2d', 'lasso2d', 'zoomIn2d', 'zoomOut2d', 'autoScale2d', 'resetScale2d'],
                displaylogo: false,
                showTips: true
            };

            // ç»˜åˆ¶èœ¡çƒ›å›¾ï¼ˆåŒ…å«ç¥å¥‡ä¹è½¬æŒ‡æ ‡ï¼‰
            Plotly.newPlot('candlestickChart', traces, candlestickLayout, config);

            // åˆ›å»ºæˆäº¤é¢å›¾
            const amountTrace = {
                x: dates,
                y: amounts.map(amount => amount / 10),
                type: 'bar',
                name: 'æˆäº¤é¢',
                marker: {
                    color: amounts.map((amount, i) => 
                        closes[i] >= opens[i] ? '#ff4444' : '#00aa00'
                    ),
                    opacity: 0.7
                },
                hovertemplate: '<b>ğŸ’ æˆäº¤é¢</b><br>ğŸ“… æ—¥æœŸ: %{x}<br>ğŸ’° é‡‘é¢: %{customdata}<extra></extra>',
                customdata: amounts.map(amount => formatAmount(amount))
            };

            const amountLayout = {
                xaxis: {
                    type: 'category',
                    showgrid: true,
                    gridcolor: '#f0f0f0',
                    categoryorder: 'array',
                    categoryarray: dates,
                    range: [-0.5, dates.length - 0.5],
                    ticktext: formattedDates, // æ˜¾ç¤ºæ ¼å¼åŒ–çš„æ—¥æœŸæ ‡ç­¾ï¼ˆåªæ˜¾ç¤ºæœˆæ—¥ï¼‰
                    tickvals: dates // å¯¹åº”çš„åŸå§‹æ—¥æœŸå€¼
                },
                yaxis: {
                    title: 'æˆäº¤é¢',
                    showgrid: true,
                    gridcolor: '#f0f0f0',
                    tickformat: '.0f',
                    ticksuffix: 'ä¸‡'
                },
                plot_bgcolor: 'white',
                paper_bgcolor: 'white',
                font: { family: 'Arial, sans-serif', size: 12 },
                margin: { l: 50, r: 20, t: 20, b: 40 },
                showlegend: false
            };

            // ç»˜åˆ¶æˆäº¤é¢å›¾
            Plotly.newPlot('volumeChart', [amountTrace], amountLayout, config);
            
            // æ·»åŠ å›¾è¡¨åŒæ­¥æœºåˆ¶
            setupChartSync();
        }

        // è®¾ç½®æ˜¾ç¤ºèŒƒå›´
        function setDisplayRange(range, event) {
            currentDisplayRange = range;
            
            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            document.querySelectorAll('.chart-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            if (event && event.target) {
                event.target.classList.add('active');
            }
            
            // é‡æ–°ç»˜åˆ¶å›¾è¡¨
            createCandlestickChart();
            
            // å¦‚æœæŠ€æœ¯æŒ‡æ ‡æ•°æ®å·²åŠ è½½ï¼Œä¹Ÿé‡æ–°ç»˜åˆ¶æŠ€æœ¯æŒ‡æ ‡å›¾è¡¨
            if (indicatorData) {
                drawAllIndicatorCharts();
            }
        }

        // åˆ‡æ¢BOLLæŒ‡æ ‡æ˜¾ç¤º
        function toggleBOLL() {
            // é‡æ–°ç»˜åˆ¶å›¾è¡¨ä»¥åº”ç”¨BOLLæŒ‡æ ‡çš„æ˜¾ç¤º/éšè—
            createCandlestickChart();
        }

        // æ˜¾ç¤ºè‚¡ç¥¨æ•°æ®
        function displayStockData(dailyBasicResult, realtimeResult) {
            const { data: dailyData, stock_info } = dailyBasicResult;
            const realtimeData = realtimeResult.success ? realtimeResult.data : {};
            
            // æ›´æ–°è‚¡ç¥¨åŸºæœ¬ä¿¡æ¯
            document.getElementById('stockName').textContent = stock_info.name || 'è‚¡ç¥¨åç§°';
            document.getElementById('stockCode').textContent = stock_info.ts_code || '';
            document.getElementById('tradeDate').textContent = formatDate(stock_info.trade_date);
            
            // æ›´æ–°é¡µé¢æ ‡é¢˜
            const stockName = stock_info.name || 'è‚¡ç¥¨åç§°';
            const stockCode = stock_info.ts_code || '';
            document.title = `${stockName} - ${stockCode}`;
            
            // æ›´æ–°ä»·æ ¼ä¿¡æ¯ï¼ˆä¼˜å…ˆä½¿ç”¨å®æ—¶æ•°æ®ï¼‰
            const currentPrice = realtimeData.price || dailyData.close;
            const changeAmount = realtimeData.change || 0;
            const changePct = realtimeData.pct_chg || 0;
            
            document.getElementById('stockPrice').textContent = formatValue(currentPrice, 'currency');
            
            const changeAmountEl = document.getElementById('changeAmount');
            const changePctEl = document.getElementById('changePercent');
            
            changeAmountEl.textContent = (changeAmount >= 0 ? '+' : '') + formatValue(changeAmount);
            changePctEl.textContent = (changePct >= 0 ? '+' : '') + formatValue(changePct, 'percentage');
            
            setValueColor(changeAmountEl, changeAmount);
            setValueColor(changePctEl, changePct);
            
            // æ›´æ–°æŒ‡æ ‡æ•°æ®ï¼ˆä¼˜å…ˆä½¿ç”¨å®æ—¶äº¤æ˜“æ•°æ®ä¸­çš„æŒ‡æ ‡ï¼‰
            document.getElementById('totalMv').textContent = formatValue(dailyData.total_mv, 'large_number');
            document.getElementById('amount').textContent = formatAmount(realtimeData.amount || 0);
            document.getElementById('netInflow').textContent = formatValue(realtimeData.net_inflow || 0, 'large_number');
            document.getElementById('turnoverRate').textContent = formatValue(dailyData.turnover_rate, 'percentage');
            document.getElementById('volumeRatio').textContent = formatValue(dailyData.volume_ratio, 'ratio');
            document.getElementById('peTtm').textContent = formatValue(dailyData.pe_ttm, 'ratio');
            document.getElementById('pb').textContent = formatValue(dailyData.pb, 'ratio');
            document.getElementById('open').textContent = formatValue(realtimeData.open || dailyData.close, 'currency');
            
            const pctChgEl = document.getElementById('pctChg');
            pctChgEl.textContent = formatValue(changePct, 'percentage');
            setValueColor(pctChgEl, changePct);
            
            const netInflowEl = document.getElementById('netInflow');
            setValueColor(netInflowEl, realtimeData.net_inflow || 0);
            
            document.getElementById('industry').textContent = stock_info.industry || 'æœªçŸ¥è¡Œä¸š';
            
            hideLoading();
            showContent();
        }

        // æ›´æ–°æ¯æ—¥æŒ‡æ ‡æ•°æ®ï¼ˆä½¿ç”¨å®æ—¶äº¤æ˜“æ•°æ®ï¼‰
        function updateDailyIndicatorsFromRealtimeData(realtimeData) {
            if (!realtimeData) return;
            
            // æ‰¾åˆ°å½“å‰è‚¡ç¥¨çš„å®æ—¶æ•°æ®
            const stockData = realtimeData.find(item => {
                const code = item['ä»£ç '];
                return code && (code === currentStockCode || code === currentStockCode.substring(0, 6));
            });
            
            if (!stockData) return;
            
            // æ›´æ–°æ¯æ—¥æŒ‡æ ‡ä¸­å¯ä»¥ä»å®æ—¶æ•°æ®è·å–çš„å­—æ®µ
            const totalMvElement = document.getElementById('totalMv');
            const amountElement = document.getElementById('amount');
            const turnoverRateElement = document.getElementById('turnoverRate');
            const volumeRatioElement = document.getElementById('volumeRatio');
            const peTtmElement = document.getElementById('peTtm');
            const pbElement = document.getElementById('pb');
            
            // æ›´æ–°æ€»å¸‚å€¼ï¼ˆä»å®æ—¶æ•°æ®è·å–ï¼‰
            if (stockData['æ€»å¸‚å€¼'] && totalMvElement) {
                totalMvElement.textContent = formatValue(stockData['æ€»å¸‚å€¼'], 'large_number');
            }
            
            // æ›´æ–°æˆäº¤é¢ï¼ˆä»å®æ—¶æ•°æ®è·å–ï¼‰
            if (stockData['æˆäº¤é¢'] && amountElement) {
                amountElement.textContent = formatValue(stockData['æˆäº¤é¢'], 'large_number');
            }
            
            // æ›´æ–°æ¢æ‰‹ç‡ï¼ˆä»å®æ—¶æ•°æ®è·å–ï¼‰
            if (stockData['æ¢æ‰‹ç‡'] && turnoverRateElement) {
                turnoverRateElement.textContent = formatValue(stockData['æ¢æ‰‹ç‡'], 'percentage');
            }
            
            // æ›´æ–°é‡æ¯”ï¼ˆä»å®æ—¶æ•°æ®è·å–ï¼‰
            if (stockData['é‡æ¯”'] && volumeRatioElement) {
                volumeRatioElement.textContent = formatValue(stockData['é‡æ¯”'], 'ratio');
            }
            
            // æ›´æ–°å¸‚ç›ˆç‡ï¼ˆä»å®æ—¶æ•°æ®è·å–ï¼‰
            if (stockData['å¸‚ç›ˆç‡-åŠ¨æ€'] && peTtmElement) {
                peTtmElement.textContent = formatValue(stockData['å¸‚ç›ˆç‡-åŠ¨æ€'], 'ratio');
            }
            
            // æ›´æ–°å¸‚å‡€ç‡ï¼ˆä»å®æ—¶æ•°æ®è·å–ï¼‰
            if (stockData['å¸‚å‡€ç‡'] && pbElement) {
                pbElement.textContent = formatValue(stockData['å¸‚å‡€ç‡'], 'ratio');
            }
            
            console.log('[æ¯æ—¥æŒ‡æ ‡] å·²ä½¿ç”¨å®æ—¶äº¤æ˜“æ•°æ®æ›´æ–°æ¯æ—¥æŒ‡æ ‡');
        }

        // æ˜¾ç¤ºé”™è¯¯
        function showError(message) {
            document.getElementById('errorDiv').textContent = message;
            document.getElementById('errorDiv').style.display = 'block';
            hideLoading();
        }

        // æ˜¾ç¤º/éšè—å…ƒç´ 
        function hideLoading() {
            document.getElementById('loadingDiv').style.display = 'none';
        }

        function showContent() {
            document.getElementById('contentDiv').style.display = 'block';
        }

        function showChartLoading(show) {
            document.getElementById('chartLoading').style.display = show ? 'block' : 'none';
        }

        // æŠ€æœ¯æŒ‡æ ‡ç›¸å…³å‡½æ•°
        let indicatorData = null;

        // æµ‹è¯•åŠ è½½æŠ€æœ¯æŒ‡æ ‡æ•°æ®ï¼ˆè°ƒè¯•ç”¨ï¼‰
        function testLoadIndicators() {
            console.log('=== æ‰‹åŠ¨æµ‹è¯•æŠ€æœ¯æŒ‡æ ‡åŠ è½½ ===');
            console.log('å½“å‰è‚¡ç¥¨ä»£ç :', currentStockCode);
            console.log('å¼€å§‹è°ƒç”¨loadIndicatorDataå‡½æ•°...');
            loadIndicatorData();
        }

        // åŠ è½½æŠ€æœ¯æŒ‡æ ‡æ•°æ®
        async function loadIndicatorData() {
            try {
                // æ˜¾ç¤ºå›¾è¡¨åŠ è½½çŠ¶æ€
                showChartLoading(true);
                
                console.log('å¼€å§‹åŠ è½½æŠ€æœ¯æŒ‡æ ‡æ•°æ®ï¼Œè‚¡ç¥¨ä»£ç :', currentStockCode);
                const response = await fetch(`/api/kline/indicators/${currentStockCode}?indicators=macd,kdj,rsi&limit=200`);
                console.log('APIå“åº”çŠ¶æ€:', response.status);
                
                const result = await response.json();
                console.log('APIå“åº”æ•°æ®:', result);
                
                if (!result.success) {
                    throw new Error(result.message || result.error || 'è·å–æŠ€æœ¯æŒ‡æ ‡æ•°æ®å¤±è´¥');
                }
                
                indicatorData = result.data;
                console.log('æŠ€æœ¯æŒ‡æ ‡æ•°æ®:', indicatorData);
                
                // ç»˜åˆ¶æ‰€æœ‰æŠ€æœ¯æŒ‡æ ‡
                drawAllIndicatorCharts();
                
            } catch (error) {
                console.error('æŠ€æœ¯æŒ‡æ ‡æ•°æ®åŠ è½½å¤±è´¥:', error);
                showIndicatorError('æŠ€æœ¯æŒ‡æ ‡æ•°æ®åŠ è½½å¤±è´¥: ' + error.message);
            } finally {
                // éšè—å›¾è¡¨åŠ è½½çŠ¶æ€
                showChartLoading(false);
            }
        }

        // ç»˜åˆ¶æ‰€æœ‰æŠ€æœ¯æŒ‡æ ‡å›¾è¡¨
        function drawAllIndicatorCharts() {
            console.log('å¼€å§‹ç»˜åˆ¶æŠ€æœ¯æŒ‡æ ‡å›¾è¡¨');
            console.log('indicatorData:', indicatorData);
            
            if (!indicatorData || !indicatorData.kline_data) {
                console.error('æŠ€æœ¯æŒ‡æ ‡æ•°æ®ä¸ºç©ºæˆ–ç¼ºå°‘kline_data');
                showIndicatorError('æŠ€æœ¯æŒ‡æ ‡æ•°æ®ä¸ºç©º');
                return;
            }
            
            let klineData = indicatorData.kline_data;
            console.log('åŸå§‹Kçº¿æ•°æ®é•¿åº¦:', klineData.length);
            
            // åº”ç”¨ä¸Kçº¿å›¾ç›¸åŒçš„æ˜¾ç¤ºèŒƒå›´è¿‡æ»¤
            if (currentDisplayRange > 0 && klineData.length > currentDisplayRange) {
                klineData = klineData.slice(-currentDisplayRange);
                console.log('åº”ç”¨æ˜¾ç¤ºèŒƒå›´è¿‡æ»¤åçš„æ•°æ®é•¿åº¦:', klineData.length);
            }
            
            console.log('Kçº¿æ•°æ®æ ·ä¾‹:', klineData.slice(0, 2));
            
            const dates = klineData.map(item => item.trade_date); // ä½¿ç”¨åŸå§‹æ—¥æœŸæ ¼å¼ï¼Œä¸Kçº¿å›¾ä¿æŒä¸€è‡´
            
            const config = {
                displayModeBar: false,
                responsive: true
            };
            
            // è·å–Kçº¿å›¾çš„å®é™…å®½åº¦ä½œä¸ºå‚è€ƒ
            const candlestickElement = document.getElementById('candlestickChart');
            const referenceWidth = candlestickElement ? candlestickElement.offsetWidth : null;
            console.log('Kçº¿å›¾å‚è€ƒå®½åº¦:', referenceWidth);
            
            // å¼ºåˆ¶è®¾ç½®æŠ€æœ¯æŒ‡æ ‡å›¾è¡¨å®¹å™¨å®½åº¦
            const indicatorChartIds = ['macdChart', 'kdjChart', 'rsiChart'];
            indicatorChartIds.forEach(chartId => {
                const element = document.getElementById(chartId);
                if (element && referenceWidth) {
                    element.style.width = referenceWidth + 'px';
                    console.log(`è®¾ç½®${chartId}å®½åº¦ä¸º:`, referenceWidth + 'px');
                }
            });
            
            // ç»˜åˆ¶æ‰€æœ‰æŒ‡æ ‡
            console.log('å¼€å§‹ç»˜åˆ¶MACDå›¾è¡¨');
            drawMACDChart(dates, klineData, config);
            console.log('å¼€å§‹ç»˜åˆ¶KDJå›¾è¡¨');
            drawKDJChart(dates, klineData, config);
            console.log('å¼€å§‹ç»˜åˆ¶RSIå›¾è¡¨');
            drawRSIChart(dates, klineData, config);
            console.log('æ‰€æœ‰æŠ€æœ¯æŒ‡æ ‡å›¾è¡¨ç»˜åˆ¶å®Œæˆ');
            
            // å¼ºåˆ¶é‡ç»˜ä»¥ç¡®ä¿å¯¹é½ - å»¶è¿Ÿæ‰§è¡Œä»¥ç¡®ä¿DOMå®Œå…¨æ¸²æŸ“
            setTimeout(() => {
                console.log('æ‰§è¡ŒæŠ€æœ¯æŒ‡æ ‡å›¾è¡¨å¼ºåˆ¶é‡ç»˜');
                Plotly.Plots.resize('macdChart');
                Plotly.Plots.resize('kdjChart');
                Plotly.Plots.resize('rsiChart');
                console.log('æŠ€æœ¯æŒ‡æ ‡å›¾è¡¨å¼ºåˆ¶é‡ç»˜å®Œæˆ');
                
                // æ·»åŠ å›¾è¡¨åŒæ­¥æœºåˆ¶
                setupChartSync();
            }, 100);
        }

        // ç»˜åˆ¶MACDå›¾è¡¨
        function drawMACDChart(dates, klineData, config) {
            const macdDif = klineData.map(item => item.macd_dif || 0);
            const macdDea = klineData.map(item => item.macd_dea || 0);
            const macdHistogram = klineData.map(item => item.macd_histogram || 0);
            
            const formattedDates = dates.map(date => formatChartDate(date)); // æ ¼å¼åŒ–æ—¥æœŸç”¨äºæ˜¾ç¤º
            
            const traces = [
                {
                    x: dates,
                    y: macdDif,
                    type: 'scatter',
                    mode: 'lines',
                    name: 'DIF',
                    line: { color: '#2196F3', width: 2 },
                    hovertemplate: '<b>DIF</b><br>æ—¥æœŸ: %{x}<br>å€¼: %{y:.4f}<extra></extra>'
                },
                {
                    x: dates,
                    y: macdDea,
                    type: 'scatter',
                    mode: 'lines',
                    name: 'DEA',
                    line: { color: '#FF9800', width: 2 },
                    hovertemplate: '<b>DEA</b><br>æ—¥æœŸ: %{x}<br>å€¼: %{y:.4f}<extra></extra>'
                },
                {
                    x: dates,
                    y: macdHistogram,
                    type: 'bar',
                    name: 'MACD',
                    marker: {
                        color: macdHistogram.map(val => val >= 0 ? '#ff4444' : '#00aa00'),
                        opacity: 0.7
                    },
                    hovertemplate: '<b>MACD</b><br>æ—¥æœŸ: %{x}<br>å€¼: %{y:.4f}<extra></extra>'
                }
            ];
            
            const layout = {
                xaxis: {
                    type: 'category',
                    showgrid: true,
                    gridcolor: '#f0f0f0',
                    categoryorder: 'array',
                    categoryarray: dates,
                    range: [-0.5, dates.length - 0.5],
                    showticklabels: false // éšè—æ—¥æœŸæ ‡ç­¾
                },
                yaxis: {
                    title: 'MACD',
                    showgrid: true,
                    gridcolor: '#f0f0f0',
                    zeroline: true,
                    zerolinecolor: '#666',
                    zerolinewidth: 1
                },
                plot_bgcolor: 'white',
                paper_bgcolor: 'white',
                font: { family: 'Arial, sans-serif', size: 12 },
                margin: { l: 50, r: 20, t: 20, b: 40 },
                showlegend: false
            };
            
            // ç»˜åˆ¶MACDå›¾
            Plotly.newPlot('macdChart', traces, layout, config);
        }

        // ç»˜åˆ¶KDJå›¾è¡¨
        function drawKDJChart(dates, klineData, config) {
            const kdjK = klineData.map(item => item.kdj_k || 0);
            const kdjD = klineData.map(item => item.kdj_d || 0);
            const kdjJ = klineData.map(item => item.kdj_j || 0);
            
            const formattedDates = dates.map(date => formatChartDate(date)); // æ ¼å¼åŒ–æ—¥æœŸç”¨äºæ˜¾ç¤º
            
            const traces = [
                {
                    x: dates,
                    y: kdjK,
                    type: 'scatter',
                    mode: 'lines',
                    name: 'Kçº¿',
                    line: { color: '#FF9800', width: 2 },
                    hovertemplate: '<b>Kçº¿</b><br>æ—¥æœŸ: %{x}<br>å€¼: %{y:.2f}<extra></extra>'
                },
                {
                    x: dates,
                    y: kdjD,
                    type: 'scatter',
                    mode: 'lines',
                    name: 'Dçº¿',
                    line: { color: '#2196F3', width: 2 },
                    hovertemplate: '<b>Dçº¿</b><br>æ—¥æœŸ: %{x}<br>å€¼: %{y:.2f}<extra></extra>'
                },
                {
                    x: dates,
                    y: kdjJ,
                    type: 'scatter',
                    mode: 'lines',
                    name: 'Jçº¿',
                    line: { color: '#f44336', width: 2 },
                    hovertemplate: '<b>Jçº¿</b><br>æ—¥æœŸ: %{x}<br>å€¼: %{y:.2f}<extra></extra>'
                }
            ];
            
            const layout = {
                xaxis: {
                    type: 'category',
                    showgrid: true,
                    gridcolor: '#f0f0f0',
                    categoryorder: 'array',
                    categoryarray: dates,
                    range: [-0.5, dates.length - 0.5],
                    showticklabels: false // éšè—æ—¥æœŸæ ‡ç­¾
                },
                yaxis: {
                    title: 'KDJ',
                    showgrid: true,
                    gridcolor: '#f0f0f0',
                    range: [0, 100],
                    tickvals: [20, 50, 80],
                    ticktext: ['è¶…å–åŒº', '50', 'è¶…ä¹°åŒº']
                },
                plot_bgcolor: 'white',
                paper_bgcolor: 'white',
                font: { family: 'Arial, sans-serif', size: 12 },
                margin: { l: 50, r: 20, t: 20, b: 40 },
                showlegend: false,
                shapes: [
                    // è¶…ä¹°åŒºåŸŸèƒŒæ™¯ï¼ˆçº¢è‰²ï¼‰
                    {
                        type: 'rect',
                        x0: 0, x1: 1, xref: 'paper',
                        y0: 80, y1: 100,
                        fillcolor: 'rgba(244, 67, 54, 0.1)',
                        line: { width: 0 },
                        layer: 'below'
                    },
                    // è¶…å–åŒºåŸŸèƒŒæ™¯ï¼ˆç»¿è‰²ï¼‰
                    {
                        type: 'rect',
                        x0: 0, x1: 1, xref: 'paper',
                        y0: 0, y1: 20,
                        fillcolor: 'rgba(76, 175, 80, 0.1)',
                        line: { width: 0 },
                        layer: 'below'
                    },
                    // è¶…ä¹°çº¿ï¼ˆå®çº¿ï¼‰
                    {
                        type: 'line',
                        x0: 0, x1: 1, xref: 'paper',
                        y0: 80, y1: 80,
                        line: { color: '#f44336', width: 2 }
                    },
                    // è¶…å–çº¿ï¼ˆå®çº¿ï¼‰
                    {
                        type: 'line',
                        x0: 0, x1: 1, xref: 'paper',
                        y0: 20, y1: 20,
                        line: { color: '#4caf50', width: 2 }
                    }
                ],
                annotations: [
                    // è¶…ä¹°æ ‡æ³¨
                    {
                        x: 0.95,
                        y: 90,
                        xref: 'paper',
                        yref: 'y',
                        text: 'è¶…ä¹°',
                        showarrow: false,
                        font: {
                            color: '#f44336',
                            size: 12,
                            family: 'Arial, sans-serif'
                        },
                        bgcolor: 'rgba(255, 255, 255, 0.8)',
                        bordercolor: '#f44336',
                        borderwidth: 1
                    },
                    // è¶…å–æ ‡æ³¨
                    {
                        x: 0.95,
                        y: 10,
                        xref: 'paper',
                        yref: 'y',
                        text: 'è¶…å–',
                        showarrow: false,
                        font: {
                            color: '#4caf50',
                            size: 12,
                            family: 'Arial, sans-serif'
                        },
                        bgcolor: 'rgba(255, 255, 255, 0.8)',
                        bordercolor: '#4caf50',
                        borderwidth: 1
                    }
                ]
            };
            
            // ç»˜åˆ¶KDJå›¾
            Plotly.newPlot('kdjChart', traces, layout, config);
        }

        // ç»˜åˆ¶RSIå›¾è¡¨
        function drawRSIChart(dates, klineData, config) {
            const rsiValues = klineData.map(item => item.rsi || 50);
            
            const formattedDates = dates.map(date => formatChartDate(date)); // æ ¼å¼åŒ–æ—¥æœŸç”¨äºæ˜¾ç¤º
            
            const traces = [
                {
                    x: dates,
                    y: rsiValues,
                    type: 'scatter',
                    mode: 'lines',
                    name: 'RSI',
                    line: { color: '#9c27b0', width: 2 },
                    fill: 'tonexty',
                    fillcolor: 'rgba(156, 39, 176, 0.1)',
                    hovertemplate: '<b>RSI</b><br>æ—¥æœŸ: %{x}<br>å€¼: %{y:.2f}<extra></extra>'
                }
            ];
            
            const layout = {
                xaxis: {
                    type: 'category',
                    showgrid: true,
                    gridcolor: '#f0f0f0',
                    categoryorder: 'array',
                    categoryarray: dates,
                    range: [-0.5, dates.length - 0.5],
                    showticklabels: false // éšè—æ—¥æœŸæ ‡ç­¾
                },
                yaxis: {
                    title: 'RSI',
                    showgrid: true,
                    gridcolor: '#f0f0f0',
                    range: [0, 100],
                    tickvals: [30, 50, 70],
                    ticktext: ['è¶…å–åŒº', '50', 'è¶…ä¹°åŒº']
                },
                plot_bgcolor: 'white',
                paper_bgcolor: 'white',
                font: { family: 'Arial, sans-serif', size: 12 },
                margin: { l: 50, r: 20, t: 20, b: 40 },
                showlegend: false,
                shapes: [
                    // è¶…ä¹°åŒºåŸŸèƒŒæ™¯ï¼ˆçº¢è‰²ï¼‰
                    {
                        type: 'rect',
                        x0: 0, x1: 1, xref: 'paper',
                        y0: 70, y1: 100,
                        fillcolor: 'rgba(244, 67, 54, 0.1)',
                        line: { width: 0 },
                        layer: 'below'
                    },
                    // è¶…å–åŒºåŸŸèƒŒæ™¯ï¼ˆç»¿è‰²ï¼‰
                    {
                        type: 'rect',
                        x0: 0, x1: 1, xref: 'paper',
                        y0: 0, y1: 30,
                        fillcolor: 'rgba(76, 175, 80, 0.1)',
                        line: { width: 0 },
                        layer: 'below'
                    },
                    // è¶…ä¹°çº¿
                    {
                        type: 'line',
                        x0: 0, x1: 1, xref: 'paper',
                        y0: 70, y1: 70,
                        line: { color: '#f44336', width: 1, dash: 'dash' }
                    },
                    // è¶…å–çº¿
                    {
                        type: 'line',
                        x0: 0, x1: 1, xref: 'paper',
                        y0: 30, y1: 30,
                        line: { color: '#4caf50', width: 1, dash: 'dash' }
                    }
                ],
                annotations: [
                    // è¶…ä¹°æ ‡æ³¨
                    {
                        x: 0.95,
                        y: 85,
                        xref: 'paper',
                        yref: 'y',
                        text: 'è¶…ä¹°',
                        showarrow: false,
                        font: {
                            color: '#f44336',
                            size: 12,
                            family: 'Arial, sans-serif'
                        },
                        bgcolor: 'rgba(255, 255, 255, 0.8)',
                        bordercolor: '#f44336',
                        borderwidth: 1
                    },
                    // è¶…å–æ ‡æ³¨
                    {
                        x: 0.95,
                        y: 15,
                        xref: 'paper',
                        yref: 'y',
                        text: 'è¶…å–',
                        showarrow: false,
                        font: {
                            color: '#4caf50',
                            size: 12,
                            family: 'Arial, sans-serif'
                        },
                        bgcolor: 'rgba(255, 255, 255, 0.8)',
                        bordercolor: '#4caf50',
                        borderwidth: 1
                    }
                ]
            };
            
            // ç»˜åˆ¶RSIå›¾
            Plotly.newPlot('rsiChart', traces, layout, config);
        }

        // ==================== åˆ†æ—¶å›¾ç›¸å…³å‡½æ•° ====================
        
        // åŠ è½½åˆ†æ—¶å›¾æ•°æ®
        async function loadIntradayChart() {
            try {
                showIntradayLoading(true);
                
                console.log('å¼€å§‹åŠ è½½åˆ†æ—¶å›¾æ•°æ®ï¼Œè‚¡ç¥¨ä»£ç :', currentStockCode);
                const response = await fetch(`/api/stock/${currentStockCode}/intraday?period=1&adjust=qfq`);
                console.log('åˆ†æ—¶å›¾APIå“åº”çŠ¶æ€:', response.status);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const result = await response.json();
                console.log('åˆ†æ—¶å›¾APIå“åº”æ•°æ®:', result);
                
                if (!result.success) {
                    throw new Error(result.error || 'è·å–åˆ†æ—¶å›¾æ•°æ®å¤±è´¥');
                }
                
                displayIntradayChart(result.data);
                
            } catch (error) {
                console.error('åˆ†æ—¶å›¾æ•°æ®åŠ è½½å¤±è´¥:', error);
                showIntradayError('åˆ†æ—¶å›¾æ•°æ®åŠ è½½å¤±è´¥: ' + error.message);
            } finally {
                showIntradayLoading(false);
            }
        }

        // åˆ·æ–°åˆ†æ—¶å›¾æ•°æ®
        async function refreshIntradayChart() {
            const refreshBtn = document.getElementById('intradayRefreshBtn');
            refreshBtn.disabled = true;
            refreshBtn.textContent = 'åˆ·æ–°ä¸­...';
            
            try {
                await loadIntradayChart();
            } finally {
                refreshBtn.disabled = false;
                refreshBtn.textContent = 'åˆ·æ–°';
            }
        }

        // æ˜¾ç¤ºåˆ†æ—¶å›¾
        function displayIntradayChart(data) {
            if (!data || data.length === 0) {
                showIntradayError('æš‚æ— åˆ†æ—¶å›¾æ•°æ®');
                return;
            }

            console.log('åˆ†æ—¶å›¾æ•°æ®é•¿åº¦:', data.length);
            console.log('åˆ†æ—¶å›¾æ•°æ®æ ·ä¾‹:', data.slice(0, 3));

            // å‡†å¤‡æ•°æ®
            const times = data.map(item => item.time);
            const prices = data.map(item => item.price);
            const volumes = data.map(item => item.volume);
            const vwaps = data.map(item => item.vwap);

            // è®¡ç®—ä»·æ ¼èŒƒå›´ï¼ˆÂ±5%ï¼‰
            const firstPrice = prices[0];
            const priceRange = firstPrice * 0.05;
            const yMin = firstPrice - priceRange;
            const yMax = firstPrice + priceRange;

            // åˆ›å»ºåˆ†æ—¶å›¾
            const priceTrace = {
                x: times,
                y: prices,
                type: 'scatter',
                mode: 'lines',
                name: 'åˆ†æ—¶ä»·æ ¼',
                line: {
                    color: '#2196F3',
                    width: 2
                },
                fill: 'tonexty',
                fillcolor: 'rgba(33, 150, 243, 0.1)',
                hovertemplate: '<b>åˆ†æ—¶ä»·æ ¼</b><br>æ—¶é—´: %{x}<br>ä»·æ ¼: Â¥%{y:.2f}<extra></extra>'
            };

            const vwapTrace = {
                x: times,
                y: vwaps,
                type: 'scatter',
                mode: 'lines',
                name: 'VWAPå‡ä»·',
                line: {
                    color: '#FF9800',
                    width: 1,
                    dash: 'dash'
                },
                hovertemplate: '<b>VWAPå‡ä»·</b><br>æ—¶é—´: %{x}<br>ä»·æ ¼: Â¥%{y:.2f}<extra></extra>'
            };

            const priceLayout = {
                title: {
                    text: 'åˆ†æ—¶èµ°åŠ¿',
                    font: { size: 16, family: 'Arial, sans-serif' }
                },
                xaxis: {
                    type: 'category',
                    title: 'æ—¶é—´',
                    showgrid: true,
                    gridcolor: '#f0f0f0',
                    tickangle: -45,
                    categoryorder: 'array',
                    categoryarray: times,
                    range: [-0.5, times.length - 0.5],
                    showticklabels: true
                },
                yaxis: {
                    title: 'ä»·æ ¼ (å…ƒ)',
                    showgrid: true,
                    gridcolor: '#f0f0f0',
                    range: [yMin, yMax],
                    tickformat: '.2f'
                },
                plot_bgcolor: 'white',
                paper_bgcolor: 'white',
                font: { family: 'Arial, sans-serif', size: 12 },
                margin: { l: 60, r: 20, t: 50, b: 80 },
                showlegend: true,
                legend: {
                    x: 0,
                    y: 1,
                    bgcolor: 'rgba(255, 255, 255, 0.8)',
                    bordercolor: '#ddd',
                    borderwidth: 1
                }
            };

            const config = {
                displayModeBar: false,
                responsive: true
            };

            // ç»˜åˆ¶åˆ†æ—¶å›¾
            Plotly.newPlot('intradayChart', [priceTrace, vwapTrace], priceLayout, config);

            // åˆ›å»ºæˆäº¤é‡å›¾
            const volumeTrace = {
                x: times,
                y: volumes,
                type: 'bar',
                name: 'æˆäº¤é‡',
                marker: {
                    color: volumes.map((vol, index) => {
                        if (index === 0) return '#666';
                        return prices[index] >= prices[index - 1] ? '#ff4444' : '#00aa00';
                    })
                },
                hovertemplate: '<b>æˆäº¤é‡</b><br>æ—¶é—´: %{x}<br>æˆäº¤é‡: %{y}<extra></extra>'
            };

            const volumeLayout = {
                title: {
                    text: 'æˆäº¤é‡',
                    font: { size: 14, family: 'Arial, sans-serif' }
                },
                xaxis: {
                    type: 'category',
                    title: 'æ—¶é—´',
                    showgrid: true,
                    gridcolor: '#f0f0f0',
                    tickangle: -45,
                    categoryorder: 'array',
                    categoryarray: times,
                    range: [-0.5, times.length - 0.5],
                    showticklabels: true
                },
                yaxis: {
                    title: 'æˆäº¤é‡',
                    showgrid: true,
                    gridcolor: '#f0f0f0'
                },
                plot_bgcolor: 'white',
                paper_bgcolor: 'white',
                font: { family: 'Arial, sans-serif', size: 12 },
                margin: { l: 60, r: 20, t: 50, b: 80 },
                showlegend: false
            };

            // ç»˜åˆ¶æˆäº¤é‡å›¾
            Plotly.newPlot('intradayVolumeChart', [volumeTrace], volumeLayout, config);

            // æ·»åŠ å›¾è¡¨åŒæ­¥æœºåˆ¶
            setupChartSync();

            // æ˜¾ç¤ºå›¾è¡¨ï¼Œéšè—é”™è¯¯ä¿¡æ¯
            document.getElementById('intradayChartContainer').style.display = 'block';
            document.getElementById('intradayError').style.display = 'none';
            
            // æ›´æ–°æ—¶é—´æˆ³
            updateIntradayTimestamp();
        }

        // æ˜¾ç¤º/éšè—åˆ†æ—¶å›¾åŠ è½½çŠ¶æ€
        function showIntradayLoading(show) {
            document.getElementById('intradayLoading').style.display = show ? 'block' : 'none';
        }

        // æ˜¾ç¤ºåˆ†æ—¶å›¾é”™è¯¯
        function showIntradayError(message) {
            document.getElementById('intradayError').textContent = message;
            document.getElementById('intradayError').style.display = 'block';
            document.getElementById('intradayChartContainer').style.display = 'none';
        }

        // æ›´æ–°åˆ†æ—¶å›¾æ—¶é—´æˆ³
        function updateIntradayTimestamp() {
            const now = new Date();
            const timestamp = now.toLocaleString('zh-CN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
            document.getElementById('intradayTimestamp').textContent = `æ›´æ–°æ—¶é—´: ${timestamp}`;
        }

        // è®¾ç½®å›¾è¡¨åŒæ­¥æœºåˆ¶
        function setupChartSync() {
            console.log('è®¾ç½®å›¾è¡¨åŒæ­¥æœºåˆ¶');
            
            // è·å–æ‰€æœ‰å›¾è¡¨å…ƒç´ 
            const chartIds = [
                'candlestickChart', 'volumeChart', 
                'macdChart', 'kdjChart', 'rsiChart',
                'intradayChart', 'intradayVolumeChart'
            ];
            
            // ä¸ºæ¯ä¸ªå›¾è¡¨æ·»åŠ ç¼©æ”¾å’Œå¹³ç§»äº‹ä»¶ç›‘å¬å™¨
            chartIds.forEach(chartId => {
                const chartElement = document.getElementById(chartId);
                if (chartElement && chartElement._fullLayout) {
                    // ç›‘å¬å›¾è¡¨çš„ç¼©æ”¾å’Œå¹³ç§»äº‹ä»¶
                    chartElement.on('plotly_relayout', function(eventData) {
                        console.log(`å›¾è¡¨ ${chartId} å‘ç”Ÿå¸ƒå±€å˜åŒ–:`, eventData);
                        
                        // æ£€æŸ¥æ˜¯å¦æ˜¯xè½´èŒƒå›´å˜åŒ–
                        if (eventData['xaxis.range[0]'] !== undefined && eventData['xaxis.range[1]'] !== undefined) {
                            const newRange = [eventData['xaxis.range[0]'], eventData['xaxis.range[1]']];
                            console.log(`åŒæ­¥xè½´èŒƒå›´åˆ°å…¶ä»–å›¾è¡¨:`, newRange);
                            
                            // åŒæ­¥åˆ°å…¶ä»–å›¾è¡¨
                            chartIds.forEach(otherChartId => {
                                if (otherChartId !== chartId) {
                                    const otherChart = document.getElementById(otherChartId);
                                    if (otherChart && otherChart._fullLayout) {
                                        Plotly.relayout(otherChart, {
                                            'xaxis.range': newRange
                                        }).catch(err => {
                                            console.warn(`åŒæ­¥å›¾è¡¨ ${otherChartId} å¤±è´¥:`, err);
                                        });
                                    }
                                }
                            });
                        }
                        
                        // å¤„ç†è‡ªåŠ¨ç¼©æ”¾é‡ç½®
                        if (eventData['xaxis.autorange'] === true) {
                            console.log('é‡ç½®æ‰€æœ‰å›¾è¡¨çš„xè½´èŒƒå›´');
                            chartIds.forEach(otherChartId => {
                                if (otherChartId !== chartId) {
                                    const otherChart = document.getElementById(otherChartId);
                                    if (otherChart && otherChart._fullLayout) {
                                        Plotly.relayout(otherChart, {
                                            'xaxis.autorange': true
                                        }).catch(err => {
                                            console.warn(`é‡ç½®å›¾è¡¨ ${otherChartId} å¤±è´¥:`, err);
                                        });
                                    }
                                }
                            });
                        }
                    });
                }
            });
            
            console.log('å›¾è¡¨åŒæ­¥æœºåˆ¶è®¾ç½®å®Œæˆ');
        }

        // ==================== åˆ†æ—¶å›¾ç›¸å…³å‡½æ•°ç»“æŸ ====================

        // æ˜¾ç¤ºæŒ‡æ ‡é”™è¯¯
        function showIndicatorError(message) {
            console.error('æ˜¾ç¤ºæŠ€æœ¯æŒ‡æ ‡é”™è¯¯:', message);
            
            // åœ¨æ¯ä¸ªæŒ‡æ ‡å›¾è¡¨å®¹å™¨ä¸­æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
            const chartIds = ['macdChart', 'kdjChart', 'rsiChart'];
            chartIds.forEach(chartId => {
                const chartElement = document.getElementById(chartId);
                if (chartElement) {
                    chartElement.innerHTML = `<div style="padding: 20px; text-align: center; color: #dc3545; border: 1px solid #f5c6cb; background-color: #f8d7da; border-radius: 4px;">${message}</div>`;
                }
            });
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨åŠ è½½æ•°æ®
        window.onload = function() {
            console.log('é¡µé¢åŠ è½½å®Œæˆï¼Œå¼€å§‹åˆå§‹åŒ–');
            loadStockData();
            // å»¶è¿ŸåŠ è½½æŠ€æœ¯æŒ‡æ ‡æ•°æ®ï¼Œé¿å…åŒæ—¶è¯·æ±‚è¿‡å¤šAPI
            console.log('è®¾ç½®æŠ€æœ¯æŒ‡æ ‡æ•°æ®å»¶è¿ŸåŠ è½½');
            setTimeout(() => {
                console.log('å¼€å§‹å»¶è¿ŸåŠ è½½æŠ€æœ¯æŒ‡æ ‡æ•°æ®');
                loadIndicatorData();
            }, 1000);
        };
    </script>
</body>
</html>