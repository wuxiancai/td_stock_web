<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>分时图非交易时间显示测试</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 6px;
        }
        .section h2 {
            color: #333;
            margin-top: 0;
        }
        .notice {
            background-color: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
            padding: 12px 16px;
            margin-bottom: 15px;
            border-radius: 4px;
            font-size: 14px;
            display: flex;
            align-items: center;
        }
        .notice i {
            margin-right: 8px;
            color: #f39c12;
        }
        .code-block {
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            padding: 15px;
            margin: 10px 0;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            overflow-x: auto;
        }
        .highlight {
            background-color: #fff3cd;
            padding: 2px 4px;
            border-radius: 3px;
        }
        .success {
            color: #28a745;
            font-weight: bold;
        }
        .error {
            color: #dc3545;
            font-weight: bold;
        }
        .info {
            color: #17a2b8;
            font-weight: bold;
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <div class="container">
        <h1>分时图非交易时间显示功能修复</h1>
        
        <div class="section">
            <h2>问题描述</h2>
            <p>用户反馈：当在非交易时间，分时图显示加载失败，导致不显示。其实，非交易时间应该显示分时图，只是显示的是收盘时候的数据。</p>
            
            <div class="notice">
                <i class="fas fa-exclamation-triangle"></i>
                <span>原问题：非交易时间分时图显示"HTTP 404: NOT FOUND"错误</span>
            </div>
        </div>

        <div class="section">
            <h2>解决方案</h2>
            <p>修改后端API和前端显示逻辑，在非交易时间提供基于最新收盘价的模拟分时数据。</p>
            
            <h3>1. 后端API修改 (app.py)</h3>
            <div class="code-block">
<span class="highlight">修改 get_stock_intraday_data 函数：</span>

当无法获取当日分时数据时：
1. 获取最新的日线数据（收盘价）
2. 生成基于收盘价的模拟分时数据
3. 返回带有 is_simulated: true 标记的响应
4. 包含提示信息："非交易时间，显示基于收盘价 X.XX 的模拟分时数据"
            </div>

            <h3>2. 前端显示修改 (stock_detail.html)</h3>
            <div class="code-block">
<span class="highlight">新增功能：</span>

1. showIntradaySimulatedNotice() - 显示模拟数据提示
2. hideIntradaySimulatedNotice() - 隐藏模拟数据提示
3. 修改 loadIntradayChart() - 检测模拟数据并显示提示
4. 修改 displayIntradayChart() - 接受模拟数据参数
            </div>
        </div>

        <div class="section">
            <h2>修改详情</h2>
            
            <h3>后端修改要点</h3>
            <ul>
                <li><span class="success">✓</span> 在获取不到当日分时数据时，不直接返回404错误</li>
                <li><span class="success">✓</span> 尝试获取最新收盘价（优先Tushare，备用AkShare）</li>
                <li><span class="success">✓</span> 生成完整的交易时间段模拟数据（09:30-11:30, 13:00-15:00）</li>
                <li><span class="success">✓</span> 在收盘价基础上添加微小随机波动（±0.1%）</li>
                <li><span class="success">✓</span> 成交量和成交额设为0（非交易时间特征）</li>
                <li><span class="success">✓</span> 返回 is_simulated: true 标记</li>
            </ul>

            <h3>前端修改要点</h3>
            <ul>
                <li><span class="success">✓</span> 检测API响应中的 is_simulated 标记</li>
                <li><span class="success">✓</span> 显示黄色提示框，说明当前显示的是模拟数据</li>
                <li><span class="success">✓</span> 实时数据时自动隐藏模拟数据提示</li>
                <li><span class="success">✓</span> 保持原有的图表显示逻辑不变</li>
            </ul>
        </div>

        <div class="section">
            <h2>用户体验改进</h2>
            
            <div class="notice">
                <i class="fas fa-info-circle"></i>
                <span>非交易时间，显示基于收盘价 XX.XX 的模拟分时数据</span>
            </div>
            
            <h3>改进效果</h3>
            <ul>
                <li><span class="info">Before:</span> 非交易时间显示"分时图数据加载失败: HTTP 404: NOT FOUND"</li>
                <li><span class="success">After:</span> 非交易时间显示基于收盘价的模拟分时图，并有明确提示</li>
            </ul>

            <h3>技术特点</h3>
            <ul>
                <li>保持分时图的完整时间轴（上午+下午）</li>
                <li>价格基于真实收盘价，添加微小波动模拟真实感</li>
                <li>成交量为0，符合非交易时间特征</li>
                <li>明确的视觉提示，用户知道这是模拟数据</li>
                <li>交易时间恢复时自动切换回实时数据</li>
            </ul>
        </div>

        <div class="section">
            <h2>测试建议</h2>
            <ol>
                <li>在交易时间访问股票详情页，确认分时图正常显示实时数据</li>
                <li>在非交易时间访问股票详情页，确认显示模拟分时图和提示信息</li>
                <li>检查模拟数据的价格是否基于真实收盘价</li>
                <li>确认成交量显示为0（非交易时间特征）</li>
                <li>验证提示信息的显示和隐藏逻辑</li>
            </ol>
        </div>

        <div class="section">
            <h2>修改文件清单</h2>
            <ul>
                <li><span class="highlight">app.py</span> - 修改 get_stock_intraday_data 函数</li>
                <li><span class="highlight">templates/stock_detail.html</span> - 新增模拟数据提示功能</li>
            </ul>
        </div>
    </div>
</body>
</html>