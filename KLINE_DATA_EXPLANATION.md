# K线图数据说明

## 除权除息对价格数据的影响

### 问题描述
在股票交易系统中，您可能会发现K线图上显示的价格与当前最新价格不匹配的情况。这是由于**除权除息**机制造成的正常现象。

### 原因分析

1. **最新价格（除权后）**
   - 显示在页面顶部的当前价格是经过除权除息调整后的价格
   - 这个价格反映了股票分红、送股、配股等因素的影响
   - 是投资者实际可以交易的价格

2. **K线数据（未除权）**
   - K线图中的历史价格数据通常是未经除权调整的原始价格
   - 保持了历史交易时的真实价格水平
   - 便于分析股票的历史走势和技术形态

### 数据格式说明

#### K线数据结构
```javascript
// ECharts candlestick 数据格式: [open, close, low, high]
const candlestickData = [
    [开盘价, 收盘价, 最低价, 最高价], // 未除权价格
    // ...更多数据
];
```

#### Tooltip显示格式
```
开盘: ¥XX.XX (未除权)
收盘: ¥XX.XX (未除权)  
最低: ¥XX.XX (未除权)
最高: ¥XX.XX (未除权)
```

### 技术实现

#### 数据处理工具函数
- `safeParseFloat()`: 安全的数值解析，包含错误处理
- `validateKlineItem()`: K线数据项验证
- `formatPrice()`: 价格格式化，支持除权标识
- `generateTooltipHTML()`: 生成tooltip内容

#### 配置常量
```javascript
const KLINE_CONFIG = {
    DATA_FORMAT: 'OCLH', // Open, Close, Low, High
    PRECISION: 2,        // 价格精度
    CURRENCY_SYMBOL: '¥' // 货币符号
};
```

### 最佳实践

1. **数据标识**: 在tooltip中明确标注"未除权"，避免用户混淆
2. **错误处理**: 使用`safeParseFloat`确保数据解析的健壮性
3. **数据验证**: 在处理K线数据前进行格式验证
4. **用户说明**: 在界面上提供除权除息的说明文档

### 相关文件

- `/templates/stock_detail.html`: 主要的K线图实现
- `/static/js/stock-utils.js`: 数据处理工具函数
- `/README.md`: 项目总体说明

### 注意事项

- 除权除息是股票市场的正常机制，不是系统错误
- 不同的数据源可能采用不同的除权处理方式
- 建议在用户界面上提供除权/复权切换选项（未来功能）

### 未来改进方向

1. **复权数据支持**: 提供前复权、后复权数据选项
2. **数据源统一**: 确保所有价格数据使用相同的除权标准
3. **用户教育**: 添加更多关于除权除息的说明和帮助文档
4. **数据对比**: 提供除权前后价格对比功能