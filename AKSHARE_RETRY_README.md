# AkShare å®šæ—¶é‡è¯•æœºåˆ¶

## åŠŸèƒ½æ¦‚è¿°

æœ¬ç³»ç»Ÿå®ç°äº†é’ˆå¯¹ AkShare æ•°æ®æ¥å£çš„æ™ºèƒ½é‡è¯•æœºåˆ¶ï¼Œå½“ç½‘ç»œå¼‚å¸¸æˆ–æ•°æ®æºä¸å¯ç”¨æ—¶ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨è®°å½•å¤±è´¥è¯·æ±‚å¹¶åœ¨æŒ‡å®šæ—¶é—´åé‡è¯•ï¼Œç¡®ä¿æ•°æ®è·å–çš„ç¨³å®šæ€§å’Œå¯é æ€§ã€‚

## æ ¸å¿ƒç‰¹æ€§

### ğŸ”„ è‡ªåŠ¨é‡è¯•æœºåˆ¶
- **æ™ºèƒ½å¤±è´¥æ£€æµ‹**: è‡ªåŠ¨è¯†åˆ«ç½‘ç»œé”™è¯¯ã€è¶…æ—¶ã€æ•°æ®æºå¼‚å¸¸ç­‰é—®é¢˜
- **å®šæ—¶é‡è¯•**: å¤±è´¥åç­‰å¾… 5 åˆ†é’Ÿè‡ªåŠ¨é‡è¯•ï¼Œé¿å…é¢‘ç¹è¯·æ±‚
- **å¤šæ¬¡é‡è¯•**: æ”¯æŒå¤šæ¬¡é‡è¯•ï¼Œç›´åˆ°æˆåŠŸæˆ–è¾¾åˆ°æœ€å¤§é‡è¯•æ¬¡æ•°
- **é”™è¯¯åˆ†ç±»**: åŒºåˆ†ç½‘ç»œé”™è¯¯å’Œå…¶ä»–å¼‚å¸¸ï¼Œé‡‡ç”¨ä¸åŒçš„å¤„ç†ç­–ç•¥

### ğŸ“Š çŠ¶æ€ç›‘æ§
- **å®æ—¶çŠ¶æ€æŸ¥è¯¢**: é€šè¿‡ API æ¥å£æŸ¥çœ‹å½“å‰é‡è¯•çŠ¶æ€
- **è¯¦ç»†é”™è¯¯ä¿¡æ¯**: è®°å½•å¤±è´¥åŸå› ã€æ—¶é—´ã€é‡è¯•æ¬¡æ•°ç­‰è¯¦ç»†ä¿¡æ¯
- **å€’è®¡æ—¶æ˜¾ç¤º**: æ˜¾ç¤ºè·ç¦»ä¸‹æ¬¡é‡è¯•çš„å‰©ä½™æ—¶é—´

### ğŸ§¹ è‡ªåŠ¨æ¸…ç†
- **å®šæ—¶æ¸…ç†**: æ¯å¤©å‡Œæ™¨ 2 ç‚¹è‡ªåŠ¨æ¸…ç†è¶…è¿‡ 24 å°æ—¶çš„å¤±è´¥è®°å½•
- **å†…å­˜ä¼˜åŒ–**: é˜²æ­¢é•¿æœŸè¿è¡Œå¯¼è‡´çš„å†…å­˜æ³„æ¼

## æŠ€æœ¯å®ç°

### AkShareRetryManager ç±»

```python
class AkShareRetryManager:
    def __init__(self, retry_interval_minutes=5):
        self.retry_interval_minutes = retry_interval_minutes
        self.failed_requests = {}  # å­˜å‚¨å¤±è´¥çš„è¯·æ±‚ä¿¡æ¯
        self.lock = threading.Lock()  # çº¿ç¨‹å®‰å…¨
```

**ä¸»è¦æ–¹æ³•:**
- `should_retry(request_key)`: åˆ¤æ–­æ˜¯å¦åº”è¯¥é‡è¯•
- `record_failure(request_key, error_message)`: è®°å½•å¤±è´¥ä¿¡æ¯
- `record_success(request_key)`: è®°å½•æˆåŠŸï¼Œæ¸…é™¤å¤±è´¥è®°å½•
- `get_retry_status()`: è·å–å½“å‰é‡è¯•çŠ¶æ€
- `cleanup_old_failures()`: æ¸…ç†è¿‡æœŸè®°å½•

### safe_akshare_call å‡½æ•°

```python
def safe_akshare_call(func, request_key, *args, **kwargs):
    """å®‰å…¨çš„ AkShare API è°ƒç”¨ï¼ŒåŒ…å«é‡è¯•æœºåˆ¶"""
```

**åŠŸèƒ½ç‰¹ç‚¹:**
- æ£€æŸ¥ AkShare åº“å¯ç”¨æ€§
- åˆ¤æ–­æ˜¯å¦éœ€è¦è·³è¿‡é‡è¯•
- å¤„ç†ç©ºæ•°æ®è¿”å›
- åŒºåˆ†é”™è¯¯ç±»å‹å¹¶è®°å½•
- è¿”å›ç»Ÿä¸€çš„é”™è¯¯å“åº”

## API æ¥å£

### æŸ¥çœ‹é‡è¯•çŠ¶æ€

```http
GET /api/akshare/retry_status
```

**å“åº”ç¤ºä¾‹:**
```json
{
  "success": true,
  "data": {
    "total_failed_requests": 3,
    "retry_interval_minutes": 5,
    "failed_requests": [
      {
        "request_key": "spot_data_000001",
        "failure_count": 2,
        "first_failure_time": "2025-07-14 11:18:53",
        "last_attempt_time": "2025-07-14 11:23:53",
        "last_error": "HTTPSConnectionPool timeout",
        "next_retry_in_seconds": 180,
        "can_retry_now": false
      }
    ]
  }
}
```

## ä½¿ç”¨æ–¹æ³•

### 1. å¯åŠ¨åº”ç”¨

```bash
python3 app.py
```

å¯åŠ¨æ—¶ä¼šæ˜¾ç¤ºé‡è¯•æœºåˆ¶çŠ¶æ€:
```
AkShareé‡è¯•æœºåˆ¶å·²å¯ç”¨: å¤±è´¥å300ç§’é‡è¯•é—´éš”
å¯é€šè¿‡ /api/akshare/retry_status æŸ¥çœ‹é‡è¯•çŠ¶æ€
```

### 2. æµ‹è¯•é‡è¯•æœºåˆ¶

```bash
# è¿è¡Œæµ‹è¯•è„šæœ¬
python3 test_retry_mechanism.py

# è¿è¡Œç›‘æ§å·¥å…·
python3 monitor_retry.py
```

### 3. ç›‘æ§é‡è¯•çŠ¶æ€

**æ–¹æ³•ä¸€: ä½¿ç”¨ç›‘æ§è„šæœ¬**
```bash
python3 monitor_retry.py
# é€‰æ‹© "1. ç›‘æ§é‡è¯•çŠ¶æ€"
```

**æ–¹æ³•äºŒ: ç›´æ¥è°ƒç”¨ API**
```bash
curl http://localhost:8080/api/akshare/retry_status
```

**æ–¹æ³•ä¸‰: åœ¨æµè§ˆå™¨ä¸­æŸ¥çœ‹**
```
http://localhost:8080/api/akshare/retry_status
```

## é›†æˆçš„æ•°æ®æ¥å£

é‡è¯•æœºåˆ¶å·²é›†æˆåˆ°ä»¥ä¸‹ AkShare æ•°æ®æ¥å£:

1. **å®æ—¶è¡Œæƒ…æ•°æ®** (`ak.stock_zh_a_spot_em`)
   - è‚¡ç¥¨ä»·æ ¼ã€æ¶¨è·Œå¹…ã€æ¢æ‰‹ç‡ã€é‡æ¯”ç­‰
   - è¯·æ±‚æ ‡è¯†: `spot_data_{stock_code}`

2. **åˆ†æ—¶å›¾æ•°æ®** (`ak.stock_zh_a_minute`)
   - 1åˆ†é’Ÿçº§åˆ«çš„ä»·æ ¼å’Œæˆäº¤é‡æ•°æ®
   - è¯·æ±‚æ ‡è¯†: `minute_data_{stock_code}`

3. **Kçº¿æ•°æ®** (`ak.stock_zh_a_hist`)
   - æ—¥Kçº¿å†å²æ•°æ®
   - è¯·æ±‚æ ‡è¯†: `kline_data_{stock_code}_{period}_{adjust}`

4. **èµ„é‡‘æµå‘æ•°æ®** (`ak.stock_individual_fund_flow`)
   - ä¸ªè‚¡èµ„é‡‘æµå…¥æµå‡ºæ•°æ®
   - è¯·æ±‚æ ‡è¯†: `fund_flow_{stock_code}`

## é…ç½®å‚æ•°

### é‡è¯•é—´éš”
```python
# é»˜è®¤ 5 åˆ†é’Ÿï¼Œå¯åœ¨åˆå§‹åŒ–æ—¶ä¿®æ”¹
akshare_retry_manager = AkShareRetryManager(retry_interval_minutes=5)
```

### æ¸…ç†å‘¨æœŸ
```python
# æ¯å¤©å‡Œæ™¨ 2 ç‚¹æ¸…ç†è¿‡æœŸè®°å½•
scheduler.add_job(
    cleanup_akshare_failures,
    'cron',
    hour=2,
    minute=0,
    id='cleanup_akshare_failures'
)
```

## é”™è¯¯å¤„ç†

### ç½‘ç»œé”™è¯¯
- `requests.exceptions.RequestException`
- `urllib3.exceptions.*`
- `socket.timeout`
- `ConnectionError`

### æ•°æ®å¼‚å¸¸
- ç©ºæ•°æ®è¿”å›
- JSON è§£æé”™è¯¯
- æ•°æ®æ ¼å¼å¼‚å¸¸

### ç³»ç»Ÿå¼‚å¸¸
- AkShare åº“å¯¼å…¥å¤±è´¥
- å†…å­˜ä¸è¶³
- å…¶ä»–æœªçŸ¥é”™è¯¯

## æ—¥å¿—è®°å½•

ç³»ç»Ÿä¼šè®°å½•è¯¦ç»†çš„é‡è¯•æ—¥å¿—:

```
2025-07-14 11:18:53 - AkShareé‡è¯• - WARNING - spot_data_000001 è¯·æ±‚å¤±è´¥: HTTPSConnectionPool timeout
2025-07-14 11:23:53 - AkShareé‡è¯• - INFO - spot_data_000001 å¼€å§‹ç¬¬2æ¬¡é‡è¯•
2025-07-14 11:23:55 - AkShareé‡è¯• - INFO - spot_data_000001 é‡è¯•æˆåŠŸ
```

## æ€§èƒ½ä¼˜åŒ–

### å†…å­˜ç®¡ç†
- ä½¿ç”¨çº¿ç¨‹é”ç¡®ä¿å¹¶å‘å®‰å…¨
- å®šæ—¶æ¸…ç†è¿‡æœŸè®°å½•
- é™åˆ¶å¤±è´¥è®°å½•æ•°é‡

### ç½‘ç»œä¼˜åŒ–
- é¿å…é¢‘ç¹é‡è¯•
- æ™ºèƒ½é€€é¿ç­–ç•¥
- è¿æ¥æ± å¤ç”¨

## æ•…éšœæ’æŸ¥

### å¸¸è§é—®é¢˜

1. **é‡è¯•ä¸ç”Ÿæ•ˆ**
   - æ£€æŸ¥ AkShare åº“æ˜¯å¦æ­£ç¡®å®‰è£…
   - ç¡®è®¤ç½‘ç»œè¿æ¥çŠ¶æ€
   - æŸ¥çœ‹é”™è¯¯æ—¥å¿—

2. **é‡è¯•è¿‡äºé¢‘ç¹**
   - è°ƒæ•´é‡è¯•é—´éš”å‚æ•°
   - æ£€æŸ¥é”™è¯¯åˆ†ç±»é€»è¾‘

3. **å†…å­˜å ç”¨è¿‡é«˜**
   - æ£€æŸ¥æ¸…ç†ä»»åŠ¡æ˜¯å¦æ­£å¸¸è¿è¡Œ
   - è°ƒæ•´æ¸…ç†å‘¨æœŸ

### è°ƒè¯•å‘½ä»¤

```bash
# æŸ¥çœ‹å½“å‰é‡è¯•çŠ¶æ€
curl http://localhost:8080/api/akshare/retry_status

# æµ‹è¯•å•ä¸ªæ¥å£
curl http://localhost:8080/api/stock/000001/realtime

# æŸ¥çœ‹åº”ç”¨æ—¥å¿—
tail -f app.log
```

## æ‰©å±•å¼€å‘

### æ·»åŠ æ–°çš„é‡è¯•æ¥å£

```python
# åœ¨éœ€è¦é‡è¯•çš„åœ°æ–¹ä½¿ç”¨ safe_akshare_call
result = safe_akshare_call(
    ak.your_new_function,
    f"your_request_key_{param}",
    param1=value1,
    param2=value2
)
```

### è‡ªå®šä¹‰é‡è¯•ç­–ç•¥

```python
# ç»§æ‰¿ AkShareRetryManager ç±»
class CustomRetryManager(AkShareRetryManager):
    def should_retry(self, request_key):
        # è‡ªå®šä¹‰é‡è¯•é€»è¾‘
        return super().should_retry(request_key)
```

## æ€»ç»“

AkShare å®šæ—¶é‡è¯•æœºåˆ¶ä¸ºè‚¡ç¥¨æ•°æ®è·å–æä¾›äº†å¼ºå¤§çš„å®¹é”™èƒ½åŠ›ï¼Œé€šè¿‡æ™ºèƒ½é‡è¯•ã€çŠ¶æ€ç›‘æ§å’Œè‡ªåŠ¨æ¸…ç†ç­‰åŠŸèƒ½ï¼Œç¡®ä¿äº†ç³»ç»Ÿåœ¨ç½‘ç»œä¸ç¨³å®šç¯å¢ƒä¸‹çš„å¯é è¿è¡Œã€‚è¯¥æœºåˆ¶å·²æ— ç¼é›†æˆåˆ°ç°æœ‰çš„æ•°æ®æ¥å£ä¸­ï¼Œæ— éœ€é¢å¤–é…ç½®å³å¯ä½¿ç”¨ã€‚